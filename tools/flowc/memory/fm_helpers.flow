import ds/array;
import tools/flowc/memory/fmexp;

export {
	fmFreeVars(fm: FmExp) -> [FmVar];
	fmExpType(e: FmExp) -> FiType;
	fmExpStart(e: FmExp) -> int;

	fmWrapExp(es: [FmExp]) -> FmExp;
	fmUnwrapExp(e: FmExp) -> [FmExp];
}

fmFreeVars(fm: FmExp) -> [FmVar] {
	switch(fm) {
		FmLambda(__,__,info):    info.free;
		FmCall(__,__,info):      info.free;
		FmLet(__,__,__,info):    info.free;
		FmIf(__,__,__,info):     info.free;
		FmSwitch(__,__,__,info): info.free;
		FmSeq(__,info):          info.free;
		FmCallPrim(__,__,info):  info.free;
		FmMemory(__,__,x):       fmFreeVars(x);
		FmVar(__,local,__):      if (local) [fm] else [];
		default: [];
	}
}

fmExpType(e: FmExp) -> FiType {
	switch(e) {
		FmLambda(__,__,info):    info.type;
		FmCall(__,__,info):      info.type;
		FmLet(__,__,__,info):    info.type;
		FmIf(__,__,__,info):     info.type;
		FmSwitch(__,__,__,info): info.type;
		FmSeq(__,info):          info.type;
		FmCallPrim(__,__,info):  info.type;
		FmAssign(__,__,info):    info.type;
		FmMemory(__,__,x):       fmExpType(x);
		FmVar(__,__,info):       info.type;
		FiVoid(__):      FiTypeVoid();
		FiDouble(__,__): FiTypeDouble();
		FiInt(__,__):    FiTypeInt();
		FiString(__,__): FiTypeString();
		FiBool(__,__):   FiTypeBool();
	}
}

fmExpStart(e: FmExp) -> int {
	switch(e) {
		FmLambda(__,__,info):    info.start;
		FmCall(__,__,info):      info.start;
		FmLet(__,__,__,info):    info.start;
		FmIf(__,__,__,info):     info.start;
		FmSwitch(__,__,__,info): info.start;
		FmSeq(__,info):          info.start;
		FmCallPrim(__,__,info):  info.start;
		FmAssign(__,__,info):    info.start;
		FmMemory(__,__,x):       fmExpStart(x);
		FmVar(__,__,info):       info.start;
		FiVoid(start):      start;
		FiDouble(__,start): start;
		FiInt(__,start):    start;
		FiString(__,start): start;
		FiBool(__,start):   start;
	}
}

fmWrapExp(es: [FmExp]) -> FmExp {
	if (length(es) == 0) FmSeq([], FmInfo([], FiTypeVoid(), 0)) else
	if (length(es) == 0) es[0] else {
		last = es[length(es) - 1];
		free = fold(es, [], \acc, fm -> concat(acc, fmFreeVars(fm)));
		FmSeq(es, FmInfo(free, fmExpType(last), fmExpStart(last)));
	}
}

fmUnwrapExp(e: FmExp) -> [FmExp] {
	switch (e) {
		FmSeq(es,__): es;
		default: [e];
	}
}
