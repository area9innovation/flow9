import tools/flowc/incremental/fiexp;
import ds/tree;

export {
	// Supertype for all statements/expressions
	FsAll ::= FsStat, FsExp, FsLambda;

	// General control-flow statements
	FsStat ::= FsIf, FsSwitch, FsSeq, FsLet, FsAtomic;

		FsIf(cond: FsExp, rc: FsMem, s1: FsStat, s2: FsStat, id: int);
		FsSwitch(x: FsVarUse, rc: FsMem, switchType: FiType, cases: [FsCase], id: int);
			FsCase(struct: string, args: [FsVar], body: FsStat, id: int);
		FsSeq(ss: [FsStat], id: int);
		FsLet(var: FsVar, e: FsExp, rc: FsMem, s: FsStat, id: int);

	// Statements, which doesn't contain other statements
	FsAtomic ::= FsWrapExp, FsRet, FsTailCall, FsAssign, FsIncRc, FsDecRc;

		FsWrapExp(e: FsExp, rc: FsMem, id: int);
		FsRet(e: FsExp, rc: FsMem, id: int);
		FsTailCall(id: int);
		FsAssign(to: FsExp, what: FsExp, rc: FsMem, id: int);

		FsIncRc(delta: int, e: FsExp, id: int);
		FsDecRc(e: FsExp, reuse: string, id: int);

	// Expression equipped with reference-counting operations
	FsMem(inc: Tree<FsVar, int>, dec: Tree<FsVar, int>);

	// Expressions (returns value)
	FsExp ::= FsClosure, FsCall, FsCallPrim, FsCast, FsVarUse, FsConst;

		FsClosure(vars: [FsVarUse], lambda: FsLambda, id: int);
			FsLambda(closure: [FsVar], args: [FsVar], body: FsStat, type: FiTypeFunction, id: int);
		FsCall(f: FsExp, args: [FsExp], type: FiType, id: int);
		FsCallPrim(op: FsPrim, es: [FsExp], type: FiType, id: int);
		FsCast(e: FsExp, from: FiType, type: FiType, id: int);
		FsVarUse(var: FsVar, kind: FsVarKind, mutable last: bool, id: int);
			FsVarKind ::= FsVarLocal, FsVarGlobalVar, FsVarGlobalFunc, FsVarUninit;
			FsVarLocal(); FsVarGlobalVar(); FsVarGlobalFunc(); FsVarUninit();
		FsConst(const: FiConst, id: int);

	FsVar(name: string, type: FiType);

	FsPrim ::= 
		FsOrPrim,    FsAndPrim,   FsNotPrim,   FsEqPrim,  FsNePrim,
		FsLePrim,    FsGePrim,    FsLtPrim,    FsGtPrim,  FsPlusPrim,
		FsMinusPrim, FsMulPrim,   FsDivPrim,   FsModPrim, FsNegPrim,
		FsArrayPrim, FsIndexPrim, FsDerefPrim, FsRefPrim, FsStructPrim,
		FsFieldPrim;
		
		FsOrPrim();    FsAndPrim();   FsNotPrim();   FsEqPrim();  FsNePrim();
		FsLePrim();    FsGePrim();    FsLtPrim();    FsGtPrim();  FsPlusPrim();
		FsMinusPrim(); FsMulPrim();   FsDivPrim();   FsModPrim(); FsNegPrim();
		FsArrayPrim(); FsIndexPrim(); FsDerefPrim(); FsRefPrim();

		FsStructPrim(struct: string, reuse: string);
		FsFieldPrim(field: string, ind: int);
}
