import string;
import expect;

native wasm_dump_free_blocks : (label : int) -> void = host_w.wasm_dump_free_blocks;
native wasm_available_memory : () -> int = host_w.wasm_available_memory;
native wasm_free_memory : () -> int = host_w.wasm_free_memory;

Aaa(
	name : string,
	data : int
);

Bbb(data: int);

printFree(i) {
	printi(i);
	printi(wasm_free_memory());
}

test_print(a : Aaa) {
	prints(a.name + ": " + i2s(a.data));
}

test00(a : Aaa) {
}

test0() {
	aaa = Aaa("test", 0);
}

test1() {
	aaa = Aaa("test", 0);
	test_print(aaa);
}

test() {
	for(0, \i -> i < 10, \i -> {
		aaa = Aaa("st_" + i2s(i), i);
		test_print(aaa);
		i + 1;
	});
}

get_data() { Bbb(0) }

test_data() {
	printFree(30);
	bb = Bbb(0);
	tttt = \c : Bbb -> {};
	printFree(31);

	s = get_data();
	printFree(32);
	tttt(s);
}

Func(f : () -> void);

test_func() {
	f = Func(\ -> {});
}

main() {
	printi(0);
	printi(wasm_available_memory());
	printFree(1);
/*	test0();
	printFree(2);
	test1();*/
	printFree(3);
	test_data();
	printFree(6);
	test_func();
	printFree(7);
}

