import expect;

native length : ([?]) -> int = Native.length;

native iter : ([?], (?)->void) -> void = Native.iter;
native iteri : ([?], (int, ?)->void) -> void = Native.iteri;
native map : ([?], (?)->??) -> [??] = Native.map;
native enumFromTo : (int, int) -> [int] = Native.enumFromTo;

native s2a : (string) -> [int] = Native.s2a;
native string2utf8 : (string) -> [int] = Native.string2utf8;

native bitShl : (a : int, n : int) -> int = Native.bitShl;
native bitUshr : (a : int, n : int) -> int = Native.bitUshr;


iter2(a : [?], f : (?) -> void) -> void {
	do_iter2(a, f, 0);
}

do_iter2(a: [?], f : (?) -> void, idx : int) -> void {
	if (idx < length(a)) {
		f(a[idx]);
		do_iter2(a, f, idx+1);
	}
}

test1() {
	s = ref 0;
	fff = \x : int -> {
		// printi(x);	// can't be compiled by some reason
		s := ^s + x;
	}
	a = [111, 222, 333, 444];
	iter(a, fff);
	expect2(101, ^s == 1110);
	iter(a, fff);
	expect2(102, ^s == 2220);
	// iter(a, fff);				// does not work for iter2()! - some issue with refcounts!
	// expect2(103, ^s == 3330);
}

test2() {
	s = ref "";
	f = \x : string -> {
		// prints("!!!");
		// printi(111);	// not working: function signature mismatch
		s := ^s + x;
	}
	a = ["111", "222"];
	iter(a, f);
	expect2(201, ^s == "111222");
	// iter(a, f);
	// expect2(202, ^s == "111222111222");
}

test3() {
	s : ref double = ref 0.0;
	f = \x : double -> {
		s := ^s + x;
	}
	a = [111.0, 222.0];
	iter(a, f);
	expect2(301, ^s == 333.0);
	iter(a, f);
	expect2(302, ^s == 666.0);
}

test4() {
	f = \x : int -> x * 2;
	
	a0 : [int] = [];
	b0 = map(a0, f);
	expect2(400, b0 == []);
	
	a = [111, 222, 333];
	b = map(a, f);
	expect2(401, b == [222, 444, 666]);
	
	ff = \x : int -> [x];
	bb = map(a, ff);
	expect2(402, bb == [[111],[222],[333]]);
}

test5() {
	a1 = enumFromTo(0, -1);
	expect2(501, a1 == []);
	a2 = enumFromTo(1, 5);
	expect2(502, a2 == [1,2,3,4,5]);
}

test6() {
	a = [1,2,3,4,5];
	ok = ref true;
	id = ref 0;
	f = \i : int, x : int -> {
		if (i != ^id) ok := false
		else {
			if (x != a[i]) ok := false;
		}
		id := i + 1;
	}
	iteri(a, f);
	expect2(601, ^ok);
}

test7() {
	a = s2a("abc123");
	expect2(701, a == [97,98,99,49,50,51]);
	a2 = string2utf8("abc123");
	expect2(702, a2 == [97,98,99,49,50,51]);
}

test8() {
	expect2(801, bitShl(1,20) == 1048576);
	expect2(802, bitShl(1,30) == 1073741824);
	expect2(803, bitShl(1,31) == -2147483648);
	expect2(804, bitShl(1,32) == 1);
	expect2(805, bitUshr(1048576,20) == 1);
	expect2(806, bitUshr(1073741824,30) == 1);
	expect2(807, bitUshr(-2147483648,31) == 1);
}

g_test9_ref = ref 0;

test9() {
	expect2(901, ^g_test9_ref == 0);
	g_test9_ref := 111;
	expect2(902, ^g_test9_ref == 111);
}

// testing fallback issue
// s2a(s : string) -> [int] { [1,2,3]; }		// if to comment this our all tests work!

main() {
	test1();
	test2();
	test3();
	test4();
	test5();
	test6();
	test7();
	test8();
	test9();
	expectFinish();
}
