//import runtime;
//import string;
//import ds/array;
import ds/tree;
import math/math;

Str(a: string, b: [int]);

native refCounter: (x: ?) -> int = Native.refCounter;

//native println2 : io (flow) -> void = Native.println;
//native fold : (xs : [?], init : ??, fn : (??, ?)->??) -> ?? = Native.fold;
//native quit : io (code : int) -> void = Native.quit;

//native fold_xxx : (xs : [?], init : ??, fn : (??, ?)->??) -> ?? = Native.fold_xxx;

test_fold() {
	x = "a";
	s1 = fold([1, 2, 3], Str("", []), \acc, i -> Str(acc.a + x, arrayPush(acc.b, i)));
	println2(s1);
	s2 = fold(["a", "b", "c"], "", \acc, s -> acc + " " + s1.a + " " + s);
	println2(s2);

	arr2 = ["1", "2", "3"];
	println(fold([1, 2, 3], 0, \acc, i -> acc + i));
	println(fold(arr2, "0", \acc, i -> acc + i));
	println(arr2);


	println(fold([1, 2, 3], 0, \acc, i -> acc + i));
	println(fold(arr2, "0", \acc, i -> acc + i));
	arr3 = ["1", "2", "3"];
	println(fold(arr3, "0", \acc, i -> acc + i));
	println(arr2);

	y = [1, 2, 3, 4];
	println(fold([0, 1, 2], 0, \acc, i -> acc + y[i] + y[i + 1]));


	t = pairs2tree([
		Pair(0, 1),
		Pair(1, 2)
	]);
	println(lookupTreeDef(t, 0, 1));
	println(fold([0, 1, 2], 0, \acc, i -> acc + lookupTreeDef(t, i, 1) + lookupTreeDef(t, i + 1, -1)));


	arr31 = [1, 2, 3];
	println(fold([0, 1, 2], 0, \acc, i -> acc + arr31[i]));

	arr4 = ["1", "2", "3"];
	println(fold(["0", "1", "2"], "0", \acc, i -> acc + arr4[s2i(i)]));
	println(arr4);

	arr5 = [1, 2, 3];
	println(fold([], 0, \acc, i -> acc + arr5[i]));

	arr6 = ["a_1", "a_2", "a_3"];
	println(fold(arr6, "", \acc, x1 ->
		fold(arr6, acc, \ac, x2 ->
			ac + "(" + x1 + ", " + x2 + "), " 
		) + "\n"
	));

	arr7 = ["1", "2", "3", "4", "5"];
	println(fold(arr7, "0", \acc, x1 ->
		fold(arr7, acc, \ac, x2 ->
			ac + x1 + x2
		)
	));

	arr8 = ["1", "2", "3", "4", "5"];
	println(fold(arr8, "0", \acc, x1 ->
		fold(arr8, acc, \ac, x2 ->
			ac + x1 + x2 + i2s(length(arr8))
		)
	));

	arr9 = ["13", "25", "3", "4", "5"];
	println(fold(["1", "2", "3"], "0", \acc, x1 ->
		fold(["3", "4", "5"], acc, \ac, x2 ->
			if (contains(arr9, x1 + x2)) ac + "!" else ac
		)
	));
	println(arr9);

	arr10 = ["13", "25", "3", "4", "5"];
	println(fold(["1", "2", "3"], "0", \acc, x1 ->
		fold([], acc, \ac, x2 ->
			if (contains(arr10, x1 + x2)) ac + "!" else ac
		)
	));
	println(arr10);
/*
	arr11 = ["13", "25", "3", "4", "5"];
	println(fold(["3", "4", "5"], "0", \acc, x1 ->
		if (contains(arr11, x1)) acc + "!" else acc
	));
	println(refCounter(arr11));
*/
}

test_foldi() {
	x = "a";
	s1 = foldi([1, 2, 3], Str("", []), \ind, acc, i -> Str(acc.a + x + i2s(ind), arrayPush(acc.b, i)));
	println2(s1);
	s2 = foldi(["a", "b", "c"], "", \i, acc, s -> acc + " " + s1.a + " " + s + i2s(i));
	println2(s2);

	arr2 = ["1", "2", "3"];
	println(foldi([1, 2, 3], 0, \j, acc, i -> acc + i * (j + 1)));
	println(foldi(arr2, "0", \j, acc, i -> acc + i + i2s(j)));
	println(arr2);


	println(foldi([1, 2, 3], 0, \j, acc, i -> acc + i + j));
	println(foldi(arr2, "0", \j, acc, i -> acc + i + i2s(j)));
	arr3 = ["1", "2", "3"];
	println(foldi(arr3, "0", \j, acc, i -> acc + i + i2s(j)));
	println(arr2);

	y = [1, 2, 3, 4];
	println(foldi([0, 1, 2], 0, \j, acc, i -> acc + y[i] + (j + 1) * y[i + 1]));


	t = pairs2tree([
		Pair(0, 1),
		Pair(1, 2)
	]);
	println(lookupTreeDef(t, 0, 1));
	println(foldi([0, 1, 2], 0, \j, acc, i -> acc + lookupTreeDef(t, i, 1) + lookupTreeDef(t, i + 1, -1) * (j + 1)));


	arr31 = [1, 2, 3];
	println(foldi([0, 1, 2], 0, \j, acc, i -> acc + arr31[i] * (j + 1)));

	arr4 = ["1", "2", "3"];
	println(foldi(["0", "1", "2"], "0", \j, acc, i -> acc + arr4[s2i(i)] + i2s(j)));
	println(arr4);

	arr5 = [1, 2, 3];
	println(foldi([], 0, \j, acc, i -> acc + arr5[i] * (j + 1)));

	arr6 = ["a_1", "a_2", "a_3"];
	println(foldi(arr6, "", \i, acc, x1 ->
		foldi(arr6, acc, \j, ac, x2 ->
			ac + "(" + x1 + ":" + i2s(i) + ", " + x2 + ":" + i2s(j) + "), " 
		) + "\n"
	));

	arr7 = ["1", "2", "3", "4", "5"];
	println(foldi(arr7, "0", \i, acc, x1 ->
		foldi(arr7, acc, \j, ac, x2 ->
			ac + x1 + x2 + i2s(i) + i2s(j)
		)
	));

	arr8 = ["1", "2", "3", "4", "5"];
	println(foldi(arr8, "0", \i, acc, x1 ->
		foldi(arr8, acc, \j, ac, x2 ->
			ac + x1 + x2 + i2s(length(arr8)) + i2s(i) + i2s(j)
		)
	));

	arr9 = ["13", "25", "3", "4", "5"];
	println(foldi(["1", "2", "3"], "0", \i, acc, x1 ->
		foldi(["3", "4", "5"], acc, \j, ac, x2 ->
			(if (contains(arr9, x1 + x2)) ac + "!" else ac) + i2s(i) + i2s(j)
		)
	));
	println(arr9);

	arr10 = ["13", "25", "3", "4", "5"];
	println(foldi(["1", "2", "3"], "0", \i, acc, x1 ->
		foldi([], acc, \j, ac, x2 ->
			(if (contains(arr10, x1 + x2)) ac + "!" else ac) + i2s(i) + i2s(j)
		)
	));
	println(arr10);
/*
	arr11 = ["13", "25", "3", "4", "5"];
	println(foldi(["3", "4", "5"], "0", \i, acc, x1 ->
		(if (contains(arr11, x1)) acc + "!" else acc) + i2s(i)
	));
	println(refCounter(arr11));
*/
}

test_map() {
	println(map([1, 2, 3], \i -> i * (i + 1)));
	println(mapi([1, 2, 3], \k, i -> i * (i + 1) * k));
	a = [1, 2, 3];
	println(map(a, \i -> i * (i + 1)));
	println(mapi(a, \k, i -> i * (i + 1) * k));
}

main() {
	test_fold();
	test_foldi();
	arr = [1, 2];
	println(foldi(arr, 0, \i, acc, x1 ->
		foldi(arr, acc, \j, ac, x2 ->
			ac + x1 + x2 + i + j * 3
		)
	));
	test_map();
	quit(0);
}
