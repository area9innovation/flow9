import tools/flowc/backends/inca/lift_exp;
import text/blueprint;

export {
	// Lift our code to lifted, mutable versions
	liftIncaGlobals(env : IncaEnv) -> string;
}


liftIncaGlobals(env : IncaEnv) -> string {
	blueprint("
		import out/types;

		export {
			globalIncaValues : Tree<string, IncaValue>;

			%dec%
		}

		%def%

		%globals%
	", [
		"dec", foldTree(env.globals, "", \name, gl, acc -> acc + (if (acc != "") "\n" else "") + name + "_lifted : IncaValue;"),
		"def", foldTree(env.globals, "", \name, gl, acc -> acc + liftIncaGlobal(env, name, gl) + "\n"),
		"globals", buildIncaGlobals(env.globals),
	]);
}

liftIncaGlobal(env : IncaEnv, name : string, global : FiGlobalVar) -> string {
	name + "_lifted = " + liftIncaExp(global.value, 0) + ";";
}

buildIncaGlobals(globals : Tree<string, FiGlobalVar>) -> string {
	"globalIncaValues = pairs2tree([" + foldTree(globals, "", \name, gl, acc -> "Pair(\"" + name + "\", " + name + "_lifted),") + "]);"
}
