import tools/flowc/backends/common;
import string_utils;

export {
	fi2javaBuildWithGradle(cfg : FiJavaConfig, callback : (int) -> void) -> void;
}

fi2javaBuildWithGradle(cfg : FiJavaConfig, callback : (int) -> void) -> void {
	flow_dir = findFlowDir();
	if (flow_dir == "") {
		fcPrintln("flow directory is not found - can't copy java runtime files", cfg.threadId);
		callback(5);
	} else {
		jar_name = changeFileExt(cfg.jarfile, "");
		fcVerbose(cfg, 1, "Copying java runtime files");
		java_dir = pathCombineMany([flow_dir, "platforms", "java"]);
		copyDirectory(
			java_dir, 
			pathCombineMany([java_dir, "com", "area9innovation", "flow"]), 
			pathCombineMany([cfg.generatedir, jar_name, "src", "main", "java"]), 
			\file -> endsWith(file, ".java")
		);
		fcVerbose(cfg, 1, "Copying java external natives from:\n" + strIndent(strGlue(cfg.externNatives, "\n")));
		iter(cfg.externNatives, \native_host -> {
			copyDirectory(
				native_host,
				pathCombineMany([native_host, "com", "area9innovation", "flow"]),
				pathCombineMany([cfg.generatedir, jar_name, "src", "main", "java"]),
				\file -> endsWith(file, ".java")
			)
		});
		setFileContent(
			pathCombine(cfg.generatedir, "settings.gradle"),
			fiSettingsGradle(cfg, jar_name)
		);
		setFileContent(
			pathCombine(cfg.generatedir, "gradle.properties"),
			fiGradleProperties(cfg)
		);
		setFileContent(
			pathCombineMany([cfg.generatedir, jar_name, "build.gradle"]), 
			fiGradleBuild(cfg)
		);
		fcVerbose(cfg, 0, "Building a program with gradle");
		runSystemProcess("gradle", ["jar", "--build-cache", "--parallel", "--warning-mode", "all"], cfg.generatedir, 
			\out -> fcVerbose(cfg, 0, out),
			\err -> fcVerbose(cfg, 0, err),
			\code -> if (code != 0) callback(5 + code) else {
				jar_file_from = pathCombineMany([cfg.generatedir, jar_name, "build", "libs", jar_name + ".jar"]);
				jar_file_to = pathCombineMany([cfg.outputdir, jar_name + ".jar"]);
				if (!copyFile(jar_file_from, jar_file_to)) {
					fcPrintln("failed to copy *.jar file '"+ jar_file_from + "' to '" + jar_file_to + "'", cfg.threadId);
					callback(5);
				} else {
					callback(0);
				}
			}
		);
		{}
	}
}

fiGradleProperties(cfg : FiJavaConfig) -> string {
"org.gradle.jvmargs=-Xmx" + cfg.builderXmX + "
org.gradle.parallel=true
org.gradle.daemon=true"
}

fiSettingsGradle(cfg : FiJavaConfig, jar_name : string) -> string {
"rootProject.name = '" + jar_name + "'
include('" + jar_name + "')"
}

fiGradleBuild(cfg : FiJavaConfig) -> string {
	main_class = if (cfg.packageName == "") cfg.mainClassName else cfg.packageName + "." + cfg.mainClassName;
	dependencies = concatStrings(filtermap(cfg.dependencies, \dep -> 
		if (!startsWith(dep, "gradle")) None() else Some("\timplementation \"" + substring(dep, 7, strlen(dep) - 8) + "\"\n")
	));
"plugins {
    id 'application' 
}
repositories {
    mavenCentral() 
}
dependencies {\n" + dependencies + "}
application {
    mainClass.set(\"" + main_class + "\")
}
jar {
	duplicatesStrategy = DuplicatesStrategy.INCLUDE
	manifest {
		attributes \"Main-Class\": \"" + main_class + "\"
	}
	from {
		configurations.runtimeClasspath.collect { it.isDirectory() ? it : zipTree(it) }
	}
}"
}
