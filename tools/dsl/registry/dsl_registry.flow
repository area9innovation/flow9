import tools/dsl/registry/dsl_transformation;

export {
	// Facility to register transformations for the language facility
	registerDslTransformation(d : DslTransformation) -> void;

	getDslTransformations(phase : string) -> [DslTransformation];

	registerDslLanguageRuntime(lang : string, runtime : Tree<string, DslAst>) -> void;
	getDslLanguageRuntime(lang : string) -> Tree<string, DslAst>;
}

// Lookup from phase to transformations
dslTransformationsPhases : ref Tree<string, [DslTransformation]> = ref makeTree();

registerDslTransformation(d : DslTransformation) -> void {
	println("Registering '" + d.phase + "' for " + d.specification);
	dslTransformationsPhases := treePushToArrayValue(^dslTransformationsPhases, d.phase, d);
}

getDslTransformations(phase : string) -> [DslTransformation] {
	getTreeArrayValue(^dslTransformationsPhases, phase)
}

registerDslLanguageRuntime(lang : string, runtime : Tree<string, DslAst>) -> void {
	dslLanguageRuntime := setTree(^dslLanguageRuntime, lang, runtime);
}

dslLanguageRuntime : ref Tree<string, Tree<string, DslAst>> = ref makeTree();

getDslLanguageRuntime(lang : string) -> Tree<string, DslAst> {
	lookupTreeDef(^dslLanguageRuntime, lang, makeTree())
}
