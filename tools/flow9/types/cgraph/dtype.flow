import tools/flow9/dexp/dexp;
import tools/flow9/types/ugraph/tmap;
import tools/flow9/types/ugraph/class;
import tools/flow9/types/type;

export {
	// When we have a DType, we use this one. Instantiates polymorphism
	// TODO: Since we do NOT instantiate polymorphism here, we could
	// simplify this a lot
	dtype2CType2(tmap : TMap, typars : ref Tree<string, TType>, d : DType) -> TType;
}

dtype2CType2(tmap : TMap, typars : ref Tree<string, TType>, d : DType) -> TType {
	switch (d) {
		DTypePar(id, pos): {
			mc = lookupTree(^typars, id);
			mc ?? {
				mc
			} : {
				if (false) {
					class = TTypeEClass(makeTNodeClass(tmap));
					typars := setTree(^typars, id, class);
					class;
				} else {
					TTypeName(id, [])
				}
			}
		}
		DTypeName(id, ntypars, pos): {
			if (id == "auto") {
				TTypeEClass(makeTNodeClass(tmap));
			} else {
				TTypeName(id, map(ntypars, \tp -> {
					dtype2CType2(tmap, typars, tp)
				}));
			}
		}
		DTypeFunction(args, returnType, pos): {
			TTypeFunction(
				map(args, \arg -> {
					dtype2CType2(tmap, typars, arg)
				}),
				dtype2CType2(tmap, typars, returnType)
			)
		}
	}
}
