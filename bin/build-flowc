#!/bin/bash

set -e

SCRIPT_DIR=$( cd "$( dirname "$0" )" && pwd -P )

BASE_DIR=$( cd "$( dirname "$SCRIPT_DIR" )" && pwd -P )

echo ""
echo "Compiling 'Flowc'"
echo "================="
echo ""

if [ -f "$BASE_DIR/tools/flowc/flowc.jar" ]; then
    echo "* Stop running flowc server"
    java -jar "$BASE_DIR/tools/flowc/flowc.jar" server-shutdown=1
fi

echo "* Preparing version information"
echo "  -----------------------------"
echo ""

cat <<EOF > "$BASE_DIR/tools/flowc/flowc_version.flow"
// This file is autogenerated.
// Edit 'build-flowc' instead.
export {
	flowc_version = "$(cat "$BASE_DIR/tools/flowc/flowc.version")";
	flowc_git_revision = "$(git rev-parse --short HEAD)";
}
EOF

echo "* Compiling runtime"
echo "  -----------------"
echo ""

pushd "$BASE_DIR/platforms/java"
javac -g com/area9innovation/flow/*.java
popd

echo ""
echo "* Generating the Java modules for flowc"
echo "  -------------------------------------"
echo ""
flow --java javagen tools/flowc/flowc.flow

echo ""
echo "* Compiling the generated code"
echo "  ----------------------------"
echo ""

javac -Xlint:unchecked -encoding UTF-8 -cp platforms/java javagen/*.java

echo ""
echo "* Building the 'flowc.jar'"
echo "  ------------------------"
echo ""

echo Main-Class: javagen.Main > Manifest.txt

jar cfm tools/flowc/flowc.jar Manifest.txt javagen/*.class -C platforms/java com/area9innovation/flow

echo ""
echo "Done."
