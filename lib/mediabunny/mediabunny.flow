import flowstructs;
// TODO: Remove after release.
import net/url_parameter;

export {

	native mbGetMediaDuration : (file : native, cb : (duration : int) -> void) -> void = Mediabunny.getMediaDuration;
	native mbGetMediaDurationFromBase64 : (base64str : string, cb : (duration : int) -> void) -> void = Mediabunny.getMediaDurationFromBase64;
	native mbGetMediaDurationFromUrl : (mediaUrl : string, cb : (duration : int) -> void) -> void = Mediabunny.getMediaDurationFromUrl;
	mbConversion : (file : native, format : MBFormat, params : [MBStyle], cb : (outputFile : native) -> void, onError : (error : string) -> void) -> void;
	native mbGetVideoInfo : (file : native, cb : (width : int, height : int, bitrate : int) -> void) -> void = Mediabunny.getVideoInfo;
	native mbGetVideoInfoFromBase64 : (base64str : string, cb : (width : int, height : int, bitrate : int) -> void) -> void = Mediabunny.getVideoInfoFromBase64;
	native mbGetVideoInfoFromUrl : (mediaUrl : string, cb : (width : int, height : int, bitrate : int) -> void) -> void = Mediabunny.getVideoInfoFromUrl;
	native mbConcatMedia : (files : [native], outputName: string, cb : (outputFile : native) -> void, onError : (error : string) -> void) -> void = Mediabunny.concatMedia;

	// Java-specific natives for server-side processing with file paths instead of native blobs
	// These are more suitable for Java backend where we work with file paths
	native mbGetMediaDurationJava : (filePath : string, cb : (duration : double) -> void) -> void = Mediabunny.getMediaDuration;
	native mbGetMediaDurationFromBase64Java : (base64str : string, cb : (duration : double) -> void) -> void = Mediabunny.getMediaDurationFromBase64;
	native mbGetMediaDurationFromUrlJava : (mediaUrl : string, cb : (duration : double) -> void) -> void = Mediabunny.getMediaDurationFromUrl;
	native mbGetVideoInfoJava : (filePath : string, cb : (width : int, height : int, bitrate : int) -> void) -> void = Mediabunny.getVideoInfo;
	native mbGetVideoInfoFromBase64Java : (base64str : string, cb : (width : int, height : int, bitrate : int) -> void) -> void = Mediabunny.getVideoInfoFromBase64;
	native mbGetVideoInfoFromUrlJava : (mediaUrl : string, cb : (width : int, height : int, bitrate : int) -> void) -> void = Mediabunny.getVideoInfoFromUrl;
	native mbConversionJava : (inputPath : string, format : string, params : [MBStyle], cb : (outputPath : string) -> void, onError : (error : string) -> void) -> void = Mediabunny.conversion;
	native mbConcatMediaJava : (inputPaths : [string], outputName : string, cb : (outputPath : string) -> void, onError : (error : string) -> void) -> void = Mediabunny.concatMedia;
	native mbGetFileInfoJava : (filePath : string, cb : (size : int, mimeType : string, lastModified : double) -> void) -> void = Mediabunny.getFileInfo;

	MBStyle ::= MBSampleRate, MBCrop, MBTrim, MBAudioNumberOfChannels;
		// Audio. Def 16 kHz
		MBSampleRate(sampleRate : int);
		// Video. It is actually enabled if width and height != 0
		MBCrop(left: int, top: int, width: int, height: int);
		MBTrim(start : int, end : int);
		// Perform up/downmixing if this value differs from the number of channels in the input track. 1 for nono, 2 for stereo.
		MBAudioNumberOfChannels(n : int);
	// Output format for conversion
	MBFormat ::= MBAudioMP3, MBAudioWAV, MBVideoMP4, MBVideoWEBM;
		// For encoding: MP3 Slower but smaller, WAV faster but bigger.
		MBAudioMP3();
		MBAudioWAV();
		MBVideoMP4();
		MBVideoWEBM();

	isUrlParameterMediabunny() -> bool;

	// Helper to convert MBFormat to extension string for Java backend
	mbFormatToExt(format : MBFormat) -> string;

	// High-level conversion function that works on both JS and Java
	// On JS: uses native blob handling
	// On Java: uses file paths
	mbConversionJavaPath : (inputPath : string, format : MBFormat, params : [MBStyle], cb : (outputPath : string) -> void, onError : (error : string) -> void) -> void;
}

mbGetMediaDuration(file : native, cb : (duration : int) -> void) -> void {
	println("mbGetMediaDuration not supported");
	cb(0);
}

mbGetMediaDurationFromBase64(base64str : string, cb : (duration : int) -> void) -> void {
	println("mbGetMediaDurationFromBase64 not supported");
	cb(0);
}

mbGetVideoInfo(file : native, cb : (width : int, height : int, bitrate : int) -> void) -> void {
	println("mbGetVideoInfo not supported");
	cb(0, 0, 0);
}

mbGetVideoInfoFromBase64(base64str : string, cb : (width : int, height : int, bitrate : int) -> void) -> void {
	println("mbGetVideoInfoFromBase64 not supported");
	cb(0, 0, 0);
}

mbGetMediaDurationFromUrl(mediaUrl : string, cb : (duration : int) -> void) -> void {
	println("mbGetMediaDurationFromUrl not supported");
	cb(0);
}

mbGetVideoInfoFromUrl(mediaUrl : string, cb : (width : int, height : int, bitrate : int) -> void) -> void {
	println("mbGetVideoInfoFromUrl not supported");
	cb(0, 0, 0);
}

mbFormatToExt(format : MBFormat) -> string {
	switch (format : MBFormat) {
		MBAudioMP3(): "mp3";
		MBAudioWAV(): "wav";
		MBVideoMP4(): "mp4";
		MBVideoWEBM(): "webm";
	}
}

mbConversion(file : native, format : MBFormat, params : [MBStyle], cb : (audioData : native) -> void, onError : (error : string) -> void) -> void {
	sampleRate = extractStruct(params, MBSampleRate(16000));
	crop = extractStruct(params, MBCrop(0, 0, 0, 0));
	trim = extractStruct(params, MBTrim(0, 0));
	numberOfChannels = extractStruct(params, MBAudioNumberOfChannels(0));

	mbConversionNative(
		file,
		mbFormatToExt(format),
		[
			sampleRate,
			crop,
			trim,
			numberOfChannels,
		],
		cb,
		onError
	)
}

native mbConversionNative : (
	file : native,
	format : string,
	params : [MBStyle],
	cb : (outputFile : native) -> void,
	onError : (error : string) -> void
) -> void = Mediabunny.conversion;

mbConversionNative(
	file : native,
	format : string,
	params : [MBStyle],
	cb : (outputFile : native) -> void,
	onError : (error : string) -> void
) -> void {
	onError("not supported");
}

mbConcatMedia(
	files : [native],
	outputName : string,
	cb : (outputFile : native) -> void,
	onError : (error : string) -> void
) -> void {
	onError("not supported");
}

// Java-specific fallback implementations
mbGetMediaDurationJava(filePath : string, cb : (duration : double) -> void) -> void {
	println("mbGetMediaDurationJava not supported on this platform");
	cb(0.0);
}

mbGetMediaDurationFromBase64Java(base64str : string, cb : (duration : double) -> void) -> void {
	println("mbGetMediaDurationFromBase64Java not supported on this platform");
	cb(0.0);
}

mbGetMediaDurationFromUrlJava(mediaUrl : string, cb : (duration : double) -> void) -> void {
	println("mbGetMediaDurationFromUrlJava not supported on this platform");
	cb(0.0);
}

mbGetVideoInfoJava(filePath : string, cb : (width : int, height : int, bitrate : int) -> void) -> void {
	println("mbGetVideoInfoJava not supported on this platform");
	cb(0, 0, 0);
}

mbGetVideoInfoFromBase64Java(base64str : string, cb : (width : int, height : int, bitrate : int) -> void) -> void {
	println("mbGetVideoInfoFromBase64Java not supported on this platform");
	cb(0, 0, 0);
}

mbGetVideoInfoFromUrlJava(mediaUrl : string, cb : (width : int, height : int, bitrate : int) -> void) -> void {
	println("mbGetVideoInfoFromUrlJava not supported on this platform");
	cb(0, 0, 0);
}

mbConversionJava(inputPath : string, format : string, params : [MBStyle], cb : (outputPath : string) -> void, onError : (error : string) -> void) -> void {
	onError("mbConversionJava not supported on this platform");
}

mbConcatMediaJava(inputPaths : [string], outputName : string, cb : (outputPath : string) -> void, onError : (error : string) -> void) -> void {
	onError("mbConcatMediaJava not supported on this platform");
}

mbGetFileInfoJava(filePath : string, cb : (size : int, mimeType : string, lastModified : double) -> void) -> void {
	println("mbGetFileInfoJava not supported on this platform");
	cb(0, "", 0.0);
}

// High-level Java conversion function
mbConversionJavaPath(inputPath : string, format : MBFormat, params : [MBStyle], cb : (outputPath : string) -> void, onError : (error : string) -> void) -> void {
	sampleRate = extractStruct(params, MBSampleRate(16000));
	crop = extractStruct(params, MBCrop(0, 0, 0, 0));
	trim = extractStruct(params, MBTrim(0, 0));
	numberOfChannels = extractStruct(params, MBAudioNumberOfChannels(0));

	mbConversionJava(
		inputPath,
		mbFormatToExt(format),
		[
			sampleRate,
			crop,
			trim,
			numberOfChannels,
		],
		cb,
		onError
	)
}

isUrlParameterMediabunny() -> bool {
	!isUrlParameterFalse("mediabunny")
}
