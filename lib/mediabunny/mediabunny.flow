import flowstructs;
// TODO: Remove after release.
import net/url_parameter;

export {
	// ==================== Cross-platform API (JS uses native blobs, Java uses file paths) ====================
	// These natives work on JS with browser File/Blob objects.
	// On Java, these are NOT implemented - use the file-path-based API below instead.

	native mbGetMediaDuration : (file : native, cb : (duration : int) -> void) -> void = Mediabunny.getMediaDuration;
	native mbGetMediaDurationFromBase64 : (base64str : string, cb : (duration : int) -> void) -> void = Mediabunny.getMediaDurationFromBase64;
	native mbGetMediaDurationFromUrl : (mediaUrl : string, cb : (duration : int) -> void) -> void = Mediabunny.getMediaDurationFromUrl;
	mbConversion : (file : native, format : MBFormat, params : [MBStyle], cb : (outputFile : native) -> void, onError : (error : string) -> void) -> void;
	native mbGetVideoInfo : (file : native, cb : (width : int, height : int, bitrate : int) -> void) -> void = Mediabunny.getVideoInfo;
	native mbGetVideoInfoFromBase64 : (base64str : string, cb : (width : int, height : int, bitrate : int) -> void) -> void = Mediabunny.getVideoInfoFromBase64;
	native mbGetVideoInfoFromUrl : (mediaUrl : string, cb : (width : int, height : int, bitrate : int) -> void) -> void = Mediabunny.getVideoInfoFromUrl;
	native mbConcatMedia : (files : [native], outputName: string, cb : (outputFile : native) -> void, onError : (error : string) -> void) -> void = Mediabunny.concatMedia;

	// ==================== Java file-path-based API ====================
	// These natives work on Java backend with file paths instead of browser blobs.
	// On JS, these fallback to "not supported" messages.

	native mbGetMediaDurationPath : (filePath : string, cb : (duration : double) -> void) -> void = Mediabunny.getMediaDurationPath;
	native mbGetMediaDurationFromBase64Path : (base64str : string, cb : (duration : double) -> void) -> void = Mediabunny.getMediaDurationFromBase64Path;
	native mbGetMediaDurationFromUrlPath : (mediaUrl : string, cb : (duration : double) -> void) -> void = Mediabunny.getMediaDurationFromUrlPath;
	native mbGetVideoInfoPath : (filePath : string, cb : (width : int, height : int, bitrate : int) -> void) -> void = Mediabunny.getVideoInfoPath;
	native mbGetVideoInfoFromBase64Path : (base64str : string, cb : (width : int, height : int, bitrate : int) -> void) -> void = Mediabunny.getVideoInfoFromBase64Path;
	native mbGetVideoInfoFromUrlPath : (mediaUrl : string, cb : (width : int, height : int, bitrate : int) -> void) -> void = Mediabunny.getVideoInfoFromUrlPath;
	native mbConversionPath : (inputPath : string, format : string, params : [MBStyle], cb : (outputPath : string) -> void, onError : (error : string) -> void) -> void = Mediabunny.conversionPath;
	native mbConcatMediaPath : (inputPaths : [string], outputName : string, cb : (outputPath : string) -> void, onError : (error : string) -> void) -> void = Mediabunny.concatMediaPath;
	native mbGetFileInfoPath : (filePath : string, cb : (size : int, mimeType : string, lastModified : double) -> void) -> void = Mediabunny.getFileInfoPath;

	MBStyle ::= MBSampleRate, MBCrop, MBTrim, MBAudioNumberOfChannels;
		// Audio. Def 16 kHz
		MBSampleRate(sampleRate : int);
		// Video. It is actually enabled if width and height != 0
		MBCrop(left: int, top: int, width: int, height: int);
		MBTrim(start : int, end : int);
		// Perform up/downmixing if this value differs from the number of channels in the input track. 1 for nono, 2 for stereo.
		MBAudioNumberOfChannels(n : int);
	// Output format for conversion
	MBFormat ::= MBAudioMP3, MBAudioWAV, MBVideoMP4, MBVideoWEBM;
		// For encoding: MP3 Slower but smaller, WAV faster but bigger.
		MBAudioMP3();
		MBAudioWAV();
		MBVideoMP4();
		MBVideoWEBM();

	isUrlParameterMediabunny() -> bool;

	// Helper to convert MBFormat to extension string
	mbFormatToExt(format : MBFormat) -> string;

	// High-level conversion function for Java file-path-based API
	mbConversionFormatPath : (inputPath : string, format : MBFormat, params : [MBStyle], cb : (outputPath : string) -> void, onError : (error : string) -> void) -> void;
}

// ==================== JS API fallback implementations ====================

mbGetMediaDuration(file : native, cb : (duration : int) -> void) -> void {
	println("mbGetMediaDuration not supported");
	cb(0);
}

mbGetMediaDurationFromBase64(base64str : string, cb : (duration : int) -> void) -> void {
	println("mbGetMediaDurationFromBase64 not supported");
	cb(0);
}

mbGetVideoInfo(file : native, cb : (width : int, height : int, bitrate : int) -> void) -> void {
	println("mbGetVideoInfo not supported");
	cb(0, 0, 0);
}

mbGetVideoInfoFromBase64(base64str : string, cb : (width : int, height : int, bitrate : int) -> void) -> void {
	println("mbGetVideoInfoFromBase64 not supported");
	cb(0, 0, 0);
}

mbGetMediaDurationFromUrl(mediaUrl : string, cb : (duration : int) -> void) -> void {
	println("mbGetMediaDurationFromUrl not supported");
	cb(0);
}

mbGetVideoInfoFromUrl(mediaUrl : string, cb : (width : int, height : int, bitrate : int) -> void) -> void {
	println("mbGetVideoInfoFromUrl not supported");
	cb(0, 0, 0);
}

mbFormatToExt(format : MBFormat) -> string {
	switch (format : MBFormat) {
		MBAudioMP3(): "mp3";
		MBAudioWAV(): "wav";
		MBVideoMP4(): "mp4";
		MBVideoWEBM(): "webm";
	}
}

mbConversion(file : native, format : MBFormat, params : [MBStyle], cb : (audioData : native) -> void, onError : (error : string) -> void) -> void {
	sampleRate = extractStruct(params, MBSampleRate(16000));
	crop = extractStruct(params, MBCrop(0, 0, 0, 0));
	trim = extractStruct(params, MBTrim(0, 0));
	numberOfChannels = extractStruct(params, MBAudioNumberOfChannels(0));

	mbConversionNative(
		file,
		mbFormatToExt(format),
		[
			sampleRate,
			crop,
			trim,
			numberOfChannels,
		],
		cb,
		onError
	)
}

native mbConversionNative : (
	file : native,
	format : string,
	params : [MBStyle],
	cb : (outputFile : native) -> void,
	onError : (error : string) -> void
) -> void = Mediabunny.conversion;

mbConversionNative(
	file : native,
	format : string,
	params : [MBStyle],
	cb : (outputFile : native) -> void,
	onError : (error : string) -> void
) -> void {
	onError("not supported");
}

mbConcatMedia(
	files : [native],
	outputName : string,
	cb : (outputFile : native) -> void,
	onError : (error : string) -> void
) -> void {
	onError("not supported");
}

// ==================== Java file-path API fallback implementations ====================

mbGetMediaDurationPath(filePath : string, cb : (duration : double) -> void) -> void {
	println("mbGetMediaDurationPath not supported on this platform");
	cb(0.0);
}

mbGetMediaDurationFromBase64Path(base64str : string, cb : (duration : double) -> void) -> void {
	println("mbGetMediaDurationFromBase64Path not supported on this platform");
	cb(0.0);
}

mbGetMediaDurationFromUrlPath(mediaUrl : string, cb : (duration : double) -> void) -> void {
	println("mbGetMediaDurationFromUrlPath not supported on this platform");
	cb(0.0);
}

mbGetVideoInfoPath(filePath : string, cb : (width : int, height : int, bitrate : int) -> void) -> void {
	println("mbGetVideoInfoPath not supported on this platform");
	cb(0, 0, 0);
}

mbGetVideoInfoFromBase64Path(base64str : string, cb : (width : int, height : int, bitrate : int) -> void) -> void {
	println("mbGetVideoInfoFromBase64Path not supported on this platform");
	cb(0, 0, 0);
}

mbGetVideoInfoFromUrlPath(mediaUrl : string, cb : (width : int, height : int, bitrate : int) -> void) -> void {
	println("mbGetVideoInfoFromUrlPath not supported on this platform");
	cb(0, 0, 0);
}

mbConversionPath(inputPath : string, format : string, params : [MBStyle], cb : (outputPath : string) -> void, onError : (error : string) -> void) -> void {
	onError("mbConversionPath not supported on this platform");
}

mbConcatMediaPath(inputPaths : [string], outputName : string, cb : (outputPath : string) -> void, onError : (error : string) -> void) -> void {
	onError("mbConcatMediaPath not supported on this platform");
}

mbGetFileInfoPath(filePath : string, cb : (size : int, mimeType : string, lastModified : double) -> void) -> void {
	println("mbGetFileInfoPath not supported on this platform");
	cb(0, "", 0.0);
}

// High-level Java conversion function with MBFormat
mbConversionFormatPath(inputPath : string, format : MBFormat, params : [MBStyle], cb : (outputPath : string) -> void, onError : (error : string) -> void) -> void {
	sampleRate = extractStruct(params, MBSampleRate(16000));
	crop = extractStruct(params, MBCrop(0, 0, 0, 0));
	trim = extractStruct(params, MBTrim(0, 0));
	numberOfChannels = extractStruct(params, MBAudioNumberOfChannels(0));

	mbConversionPath(
		inputPath,
		mbFormatToExt(format),
		[
			sampleRate,
			crop,
			trim,
			numberOfChannels,
		],
		cb,
		onError
	)
}

isUrlParameterMediabunny() -> bool {
	!isUrlParameterFalse("mediabunny")
}
