import material/extra/docking_ui/internal/material_docking_ui;

export {	

	// Helpers for a docking editor

	makeMDEditor(
		// A label for the editor
		keyGroupName : string,
		// The docking state
		state : MDockingState,
		// Draw a layout for the docking editor
		layout : Material,
		// Panels in the editor
		panels : [MDPanelType],
		// Some docking styles
		style : [MDockingStyle]
	) -> Material;

	// Panels docked in each docking area
	MDAreaPanels(title : string, panels : [MDPanelType]);
		MDPanelType ::= MDPanel, MDToolbar;

			MDPanel(
				// Panel's title
				title : string,
				// Where is the panbel docked 
				position : MDAreaDock,
				// Panel's content
				content : Material,
				// Starting panel size
				minSize : WidthHeight,
				// panel's style
				style : [MDockingPanelStyle]
			);

			MDToolbar(
				// Where is the panbel docked 
				position : MDAreaDock,
				// Toolbar's content
				buttons : [MDPanelToolbarItem],
				// panel's style
				style : [MDockingPanelStyle]
			);


			// If the panel is docked to MDCols, position is the col ID, if MDLines is the row ID 
			MDAreaDock(areaTitle : string, position : int);


	// Helpers for docking areas

	// Docking cols
	makeMDCols(state : MDockingState, area : MDArea) -> Material;
	// Docking cols reversed version - Right to left
	makeMDColsR(state : MDockingState, area : MDArea) -> Material;
	// Docking lines
	makeMDLines(state : MDockingState, area : MDArea) -> Material;
	// Docking lines reversed version - Bottom to top
	makeMDLinesB(state : MDockingState, area : MDArea) -> Material;

	// Hook for docking areas in layout and styles for customizations
	MDArea(title : string, style : [MDockingAreaStyle]);


	// Helpers for layout functions

	// Left, Right - docking layout
	makeMDockingLayoutFnLR(state : MDockingState, editorContent : Material, left : MDArea, right : MDArea) -> Material;
	// Top, Left, Right - docking layout
	makeMDockingLayoutFnTLR(state : MDockingState, editorContent : Material, top : MDArea, left : MDArea, right : MDArea) -> Material;
	// Top, Left, Right, Bottom - docking layout
	makeMDockingLayoutFnTLRB(state : MDockingState, editorContent : Material, top : MDArea, left : MDArea, right : MDArea, bottom : MDArea) -> Material;
}



makeMDEditor(
	keyGroupName : string,
	state : MDockingState,
	layout : Material, 
	panels : [MDPanelType],
	style : [MDockingStyle]
) -> Material {

	// areas = getValue(state.dockingAreas);
	// areaTitles = uniq(map(panels, \p -> p.position.areaTitle));

	// Populate area Ids
	// next(state.dockingAreas, 
	// 	foldi(areaTitles, makeTree(), \i, acc, t -> setTree(acc, t, i))
	// );

	panelsA = mapi(panels, \j, p -> {
		panelStyle = p.style;
		areaId = if (contains(panelStyle, MDPanelMobile())) -1 else lookupTreeDef(getValue(state.dockingAreas), p.position.areaTitle, -1);
		panelType2DockingPanel(areaId, j, p)
	});

	filteredStyle = removeAllStructs(style, MDockingEnableLoadAndStoreCache("", false));

	MDockingUI(state, panelsA, layout, concat(filteredStyle, [
		MDockingEnableLoadAndStoreCache(keyGroupName, true)
	]))
}


panelType2DockingPanel(areaId : int, rowId : int, pt : MDPanelType) -> MDockingPanel {
	switch(pt) {
		MDPanel(t, ad, cnt, sz, st) : {
			MDockingPanel(
				t,
				MDPanelContent(cnt),
				MDock(areaId, ad.position, rowId),
				sz,
				st
			);

		}
		MDToolbar(ad, btns, st) : {
			MDockingPanel(
				"Toolbar",
				MDPanelToolbar(btns),
				MDock(areaId, ad.position, rowId),
				zeroWH,
				st
			);
		}
	}
}





makeMDCols(state : MDockingState, area : MDArea) -> Material {
	initializeDockingAreas(state, area.title);
	areaId = lookupTreeDef(getValue(state.dockingAreas), area.title, 0);
	MDockingArea(true, state, areaId, area.style);
}
makeMDColsR(state : MDockingState, area : MDArea) -> Material {
	initializeDockingAreas(state, area.title);
	areaId = lookupTreeDef(getValue(state.dockingAreas), area.title, 0);
	MDockingArea(true, state, areaId, concat([MDockingRightCols()], area.style))
}
makeMDLines(state : MDockingState, area : MDArea) -> Material {
	initializeDockingAreas(state, area.title);
	areaId = lookupTreeDef(getValue(state.dockingAreas), area.title, 0);
	MDockingArea(false, state, areaId, area.style);
}
makeMDLinesB(state : MDockingState, area : MDArea) -> Material {
	initializeDockingAreas(state, area.title);
	areaId = lookupTreeDef(getValue(state.dockingAreas), area.title, 0);
	MDockingArea(false, state, areaId, concat([MDockingBottomLines()], area.style));
}

makeMDockingLayoutFnLR(state : MDockingState, editorContent : Material, left : MDArea, right : MDArea) -> Material {
	MColsA([
		makeMDCols(state, left),
		MDContent(state, editorContent),
		makeMDColsR(state, right)
	]);
}

makeMDockingLayoutFnTLR(state : MDockingState, editorContent : Material, top : MDArea, left : MDArea, right : MDArea) -> Material {
	MLinesA([
		makeMDLines(state, top),
		MColsA([
			makeMDCols(state, left),
			MDContent(state, editorContent),
			makeMDColsR(state, right)
		]),
	]);
}

makeMDockingLayoutFnTLRB(state : MDockingState, editorContent : Material, top : MDArea, left : MDArea, right : MDArea, bottom : MDArea) -> Material {
	MLinesA([
		makeMDLines(state, top),
		MColsA([
			makeMDCols(state, left),
			MDContent(state, editorContent),
			makeMDColsR(state, right)
		]),
		makeMDLinesB(state, bottom)
	]);
}