import fusion;

export {
	RMObject ::= RMScene, RMLights;
	RMScene ::= RMCompositeObject, RMPrimitive, RMUnaryOperator, RMBinaryOperator, RMMaterial, RMInteractive, RMEmpty;
		RMPrimitive ::= RMSphere, RMPlane, RMBox, RMRoundBox, RMBoxFrame, RMTorus, RMCappedTorus, RMCylinder, RMRoundedCylinder;
			RMSphere(radius : Behaviour<double>);
			RMPlane(normal : Behaviour<RMXYZ>);
			RMBox(box : Behaviour<RMXYZ>);
			RMRoundBox(box : Behaviour<RMXYZ>, radius : Behaviour<double>);
			RMBoxFrame(box : Behaviour<RMXYZ>, thickness : Behaviour<double>);
			RMTorus(revolutionRadius : Behaviour<double>, tubeRadius : Behaviour<double>);
			RMCappedTorus(revolutionRadius : Behaviour<double>, tubeRadius : Behaviour<double>, percent : Behaviour<double>);
			RMCylinder(height : Behaviour<double>, radius : Behaviour<double>);
			RMRoundedCylinder(height : Behaviour<double>, radius : Behaviour<double>, radiusRounded : Behaviour<double>);
		RMCompositeObject(
			object : RMPrimitive,
			name : string,
			color : RMBaseMaterial,
			materialProperties : [RMMaterialProperties],
			position : Behaviour<RMCoordinate>,
			rotation : Behaviour<RMCoordinate>,
			scale : Behaviour<RMCoordinate>,
			trigger : Behaviour<RMTrigger>
		);
		RMUnaryOperator ::= RMTranslate, RMRotate, RMScale;
			RMTranslate(object : RMScene, position : Behaviour<RMCoordinate>);
			RMRotate(object : RMScene, rotation : Behaviour<RMCoordinate>);
			RMScale(object : RMScene, scale : Behaviour<RMCoordinate>);
		RMBinaryOperator ::= RMUnion2, RMUnion, RMIntersection2, RMIntersection, RMSubtraction2, RMSubtraction, RMSmoothOperators;
		RMSmoothOperators ::= RMSmoothUnion2, RMSmoothUnion, RMSmoothIntersection2, RMSmoothIntersection, RMSmoothSubtraction2, RMSmoothSubtraction;
			RMUnion2(object1 : RMScene, object2 : RMScene);
			RMUnion(objects : [RMScene]);
			RMIntersection2(object1 : RMScene, object2 : RMScene);
			RMIntersection(objects : [RMScene]);
			RMSubtraction2(object1 : RMScene, object2 : RMScene); //order matters
			RMSubtraction(objects : [RMScene]); //order matters
			RMSmoothUnion2(object1 : RMScene, object2 : RMScene, k : Behaviour<double>);
			RMSmoothUnion(objects : [RMScene], k : Behaviour<double>); //order matters
			RMSmoothIntersection2(object1 : RMScene, object2 : RMScene, k : Behaviour<double>);
			RMSmoothIntersection(objects : [RMScene], k : Behaviour<double>); //order matters
			RMSmoothSubtraction2(object1 : RMScene, object2 : RMScene, k : Behaviour<double>); //order matters
			RMSmoothSubtraction(objects : [RMScene], k : Behaviour<double>); //order matters
		RMMaterial(object : RMScene, color : RMBaseMaterial, materialProperties : [RMMaterialProperties]);
		RMBaseMaterial ::= RMColor, RMTexture;
		RMMaterialProperties ::= RMReflect;
			RMTexture(
				texture : Behaviour<string>, //URL or base64
				parameters : Behaviour<RMTextureParameters>
			);
				RMTextureParameters (
					scale : RMTextureTilingParameter,
					translate : RMTextureTilingParameter,
					rotate : RMTextureTilingParameter,
					step : RMTextureTilingParameter
				);
				RMTextureTilingParameter(
					zx_z : double,
					zx_x : double,
					xy_x : double,
					xy_y : double,
					zy_z : double,
					zy_y : double
				);
			RMColor(color : Behaviour<int>);
			RMReflect(mixCoef : Behaviour<double>);
	RMLights ::= RMCompositeLight, RMLightTranslate, RMLightMaterial, RMLight, RMPlus, RMEmpty;
		RMCompositeLight(size : double, name : string, color : RMBaseLight, position : RMCoordinate);
		RMLightTranslate(object : RMLights, position : RMCoordinate);
		RMLightMaterial(object : RMLights, color : RMBaseLight);
		RMBaseLight ::= RMLightColor;
			RMLightColor(color : int);
		RMLight(size : double);
		RMPlus(object1 : RMLights, object2 : RMLights);
		RMEmpty();

		RMInteractive(object : RMInteractiveObject, trigger : Behaviour<RMTrigger>); //only recieve triggers
		RMInteractiveObject ::= RMPrimitive, RMSmoothOperators;
		RMTrigger ::= RMMouseHover, RMMouseHoverIn, RMMouseHoverOut, RMMouseDownleft;
			RMMouseHover();
			RMMouseHoverIn();
			RMMouseHoverOut();
			RMMouseDownleft();

	RMSettings(
		camera : Behaviour<RMCamera>, //transfers data in both directions
		showFps : Behaviour<bool>,
		firstPersonCamera : Behaviour<bool>,
		thirdPersonCameraLimits : Behaviour<Pair<double, double>>,
		firstPersonCameraLimits : Behaviour<Pair<double, double>>,
		firstPersonCameraSpeed : Behaviour<double>,
		firstPersonCameraLeftMouseButtonUnlock : Behaviour<bool>,
		backgroundColor : Behaviour<int>,
		backgroundTransparency : Behaviour<double>,
	);
	RMCamera(position : RMXYZ, lookAt : RMXYZ);

	RMCoordinate ::= RMXYZ, RMX, RMY, RMZ, RMXY, RMXZ, RMYZ;
		RMXYZ(x : double, y : double, z : double);
		RMXY(x : double, y : double);
		RMXZ(x : double, z : double);
		RMYZ(y : double, z : double);
		RMX(x : double);
		RMY(y : double);
		RMZ(z : double);

	RMIExp ::= RMICall, RMIP, RMIDouble, RMIInt, RMIBool, RMIXYZ, RMIVar, RMIConcat, RMIProperty, RMIJSObject, RMIEmpty;
		RMICall(fn : RMC, args : [RMIExp]);
		// A function, either an operator or function call
		RMC ::= RMIOp, RMIFn;
			// Operators are unary (prefix notation), binary operators, or the ? operator for ternary in GLSL syntax
			RMIOp(opName : string);
			// Function call syntax for these functions
			RMIFn(fnName : string);
		// The point to which we have to measure the distance
		RMIP();
		RMIDouble(num : double);
		RMIInt(num : int);
		RMIBool(num : bool);
		RMIXYZ(x : double, y : double, z : double);
		RMIVar(name : string);
		RMIConcat(exp1 : RMIExp, exp2 : RMIExp);
		RMIProperty(exp : RMIExp, id : int, property : RMIExp);
		RMIJSObject(properties : Tree<string, RMIExp>);
		RMIEmpty();

	makeDefaultRMTexture() -> RMTexture;
	makeDefaultRMSettings() -> RMSettings;
	makeDefaultRMCamera() -> RMCamera;

	makeDefaultRMCompositeObject() -> RMCompositeObject;
	constructRMCompositeObject(object : RMPrimitive, name : string, color : RMBaseMaterial, position : Behaviour<RMCoordinate>) -> RMCompositeObject;
}

makeDefaultRMTexture() -> RMTexture {
	RMTexture(
		make(""),
		make(RMTextureParameters(
			RMTextureTilingParameter(1., 1., 1., 1., 1., 1.),
			RMTextureTilingParameter(0., 0., 0., 0., 0., 0.),
			RMTextureTilingParameter(0., 0., 0., 0., 0., 0.),
			RMTextureTilingParameter(1., 1., 1., 1., 1., 1.)
		))
	)
}

makeDefaultRMSettings() -> RMSettings {
	RMSettings(
		make(makeDefaultRMCamera()),
		make(false),
		make(false),
		make(Pair(-PI/2., PI/2.)), 
		make(Pair(-PI/2., PI/2.)),
		make(1.0),
		make(false),
		make(0x7f7fb3),
		make(1.0),
	)
}

makeDefaultRMCamera() -> RMCamera {
	RMCamera(RMXYZ(-10., 10., 0.), RMXYZ(0., 0., 0.))
}

makeDefaultRMCompositeObject() -> RMCompositeObject {
	RMCompositeObject(
		RMSphere(const(1.0)),
		"",
		RMColor(const(0xFFFFFF)),
		[],
		const(RMXYZ(0., 0., 0.)),
		const(RMXYZ(0., 0., 0.)),
		const(RMXYZ(1., 1., 1.)),
		const(RMMouseDownleft()),
	)
}

constructRMCompositeObject(object : RMPrimitive, name : string, color : RMBaseMaterial, position : Behaviour<RMCoordinate>) -> RMCompositeObject {
	RMCompositeObject(
		object,
		name,
		color,
		[],
		position,
		const(RMXYZ(0., 0., 0.)),
		const(RMXYZ(1., 1., 1.)),
		const(RMMouseDownleft()),
	)
}