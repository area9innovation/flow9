import flowutils;
import material/material_ui;
import tropic/tflexiblegrid;

main() {
	setRendererType("html");

	iter(
		enumFromTo(0, 1000000),
		\i -> {
			println("Iteration " + i2s(i));
			testBFBlocksInfiniteLoop() |> ignore;
		}
	)
}

testBFBlocksInfiniteLoop() {
	println("Running testBFBlocksInfiniteLoop...");
	getRandom = \ -> if (random() > 0.5) random() * 10.0 - 10.0 / 2.0 else random() * doubleMax - doubleMax / 2.0;
	getRandomBool = \ -> random() > 0.5;

	// Parameters that could potentially cause an infinite loop
	blocks = [
		BFBlock(getRandom(), getRandom()),
		BFBlock(getRandom(), getRandom()),
		BFBlock(getRandom(), getRandom()),
		BFBlock(getRandom(), getRandom()),
		BFBlock(getRandom(), getRandom()),
		BFBlock(getRandom(), getRandom()),
		BFBlock(getRandom(), getRandom()),
	];
	vertical = getRandomBool();
	par = BFParameters(
		getRandomBool(),
		getRandomBool(),
		getRandomBool(),
		vertical,
		None(),
		getRandomBool(),
		getRandomBool()
	);
	size = WidthHeight(getRandom(), getRandom());

	println("Blocks: ");
	println(blocks);
	println("Parameters: ");
	println(par);
	println("Size: ");
	println(size);

	// This should not cause an infinite loop
	state = bfFitBlocks([Point(0.0, 0.0)], size, blocks, par);
	lastPoint = ref Point(0.0, 0.0);

	result = fold(tree2pairs(state.p), [], \acc : [[Point]], p : Pair<int, Pair<BFBlock, Point>> -> {
		if (length(acc) == 0) {
			[[p.second.second]];
		} else {
			lastLine = lastElement(acc, []);
			if (length(lastLine) == 0 || (if (vertical) ^lastPoint.x == p.second.second.x else ^lastPoint.y == p.second.second.y)) {
				lastPoint := p.second.second;
				replace(acc, length(acc) - 1, arrayPush(lastLine, p.second.second));
			} else {
				lastPoint := p.second.second;
				arrayPush(acc, [p.second.second]);
			}
		}
	});

	println(result);
	println("testBFBlocksInfiniteLoop passed.");
	result;
}