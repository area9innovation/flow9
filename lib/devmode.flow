import runtime;
import net/url_parameter;
import formats/json/json;

export {
	setDevModeCheckFn(checkFn : () -> bool) -> void;
	isDevMode() -> bool;
	isSetDevtrace() -> bool;

	// Print something to the console if "devtrace" parameter is true.
	// WARNING: can be used when you already have the value in memory. 
	// But if you need to build it, use lazy version below!
	devtrace : (?) -> void;

	// The same as above but build the value only if "devtrace" parameter is true
	devtraceLazy(fn : () -> ?) -> void;
}

devModeCheckFn : ref () -> bool = ref \ -> {
	debugStorage = parseJson(getKeyValue("local-parameters", ""));
	isUrlParameterTrue("dev") || getJsonBoolField(debugStorage, "dev", false);
}

setDevModeCheckFn(checkFn : () -> bool) -> void {
	devModeCheckFn := checkFn
}

isDevMode() -> bool {
	^devModeCheckFn()
}

isSetDevtrace() -> bool {
	debugStorage = parseJson(getKeyValue("local-parameters", ""));
	isUrlParameterTrue("devtrace") || getJsonBoolField(debugStorage, "devtrace", false);
}

devtrace(str : ?) -> void {
	if (isSetDevtrace()) println(str)
}

devtraceLazy(fn : () -> ?) -> void {
	if (isUrlParameterTrue("devtrace")) println(fn())
}
