import formats/wiki/wikilexer;
import formats/wiki/wikistyle_types;
import wigi/wigi_engine_types;
import textstyles;

export {
	getWikiFonts(style : [WikiStyle]) -> WikiFonts;
	getDragDropBuffer : (style : [WikiStyle]) -> Maybe<DragDropBuffer>;
	clearDragDropBuffer : (buffer : DragDropBuffer) -> void;

	RightNumberingText : [CharacterStyle];
	NormalWikiFonts : WikiFonts;
	SmallWikiFonts : WikiFonts;
	TooltipWikiFonts : WikiFonts;
	makeProximaWikiFonts : (size : double) -> WikiFonts;
	makeWikiFonts : (size : double) -> WikiFonts;
	makeColoredWikiFonts : (size : double, color : int) -> WikiFonts;
	makeSmallWikiFonts : (style : [CharacterStyle]) -> WikiFonts;
	characterStyle2WikiFonts : (style : [CharacterStyle]) -> WikiFonts;
	updateInterlineSpacing(wf : WikiFonts, spacing : double) -> WikiFonts;
	updateBullet(wf : WikiFonts, bullet : Form) -> WikiFonts;
	withWikiColor(wf : WikiFonts, color : int) -> WikiFonts;

	getInteractivenessSwitch(wikiStyle : [WikiStyle]) -> Behaviour<bool>;

	isAlreadyTranslated(wikiStyle : [WikiStyle]) -> bool;

	isWikiParsingStyle(style : WikiStyle) -> bool;
}

/* Base styles and related functions */

RightNumberingText = [FontFamily("Book"), FontSize(16.0), Fill(0x797979)];

// Default wiki fonts
NormalWikiFonts = WikiFonts(
	16.0,
	3.0,
	NormalText,
	HeadingText,
	Heading2Text,
	NumberingText,
	RightNumberingText,
	makeWikiBullet(BulletText, idfn)
);

SmallWikiFonts = WikiFonts(
	14.0,
	2.0,
	NormalText |> mutiplyFontSizeBy(14.0/16.0),
	HeadingText |> mutiplyFontSizeBy(14.0/16.0),
	Heading2Text |> mutiplyFontSizeBy(14.0/16.0),
	NumberingText |> mutiplyFontSizeBy(14.0/16.0),
	RightNumberingText |> mutiplyFontSizeBy(14.0/16.0),
	makeWikiBullet(BulletText, mutiplyFontSizeBy(14.0/16.0)),
);

TooltipWikiFonts = WikiFonts(
	14.0,
	2.0,
	NormalText |> mutiplyFontSizeBy(14.0/16.0),
	HeadingText |> mutiplyFontSizeBy(14.0/16.0),
	Heading2Text |> mutiplyFontSizeBy(14.0/16.0),
	NumberingText |> mutiplyFontSizeBy(14.0/16.0),
	RightNumberingText |> mutiplyFontSizeBy(14.0/16.0),
	makeWikiBullet(BulletText, mutiplyFontSizeBy(14.0/16.0)),
);

makeProximaWikiFonts(size : double) WikiFonts(
	size,
	dfloor(size/16.0 * 3.0),
	ProximaTextSized(size),
	ProximaTextSized(size * 20.0 / 16.0),
	ProximaTextSized(size * 18.0 / 16.0),
	ProximaTextSized(size) |> withFillColor(orange),
	ProximaTextSized(size),
	makeWikiBullet(BulletText, idfn)
);

makeWikiFonts(size : double) WikiFonts(
	size,
	dfloor(size/16.0 * 3.0),
	NormalText |> mutiplyFontSizeBy(size/16.0),
	HeadingText |> mutiplyFontSizeBy(size/16.0),
	Heading2Text |> mutiplyFontSizeBy(size/16.0),
	NumberingText |> mutiplyFontSizeBy(size/16.0),
	RightNumberingText |> mutiplyFontSizeBy(size/16.0),
	makeWikiBullet(BulletText, mutiplyFontSizeBy(size/16.0)),
);

makeColoredWikiFonts(size : double, color : int) WikiFonts(
	size,
	dfloor(size/16.0 * 3.0),
	NormalText |> mutiplyFontSizeBy(size/16.0) |> withFillColor(color),
	HeadingText |> mutiplyFontSizeBy(size/16.0) |> withFillColor(color),
	Heading2Text |> mutiplyFontSizeBy(size/16.0) |> withFillColor(color),
	NumberingText |> mutiplyFontSizeBy(size/16.0) |> withFillColor(color),
	RightNumberingText |> mutiplyFontSizeBy(size/16.0) |> withFillColor(color),
	makeWikiBullet(BulletText, mutiplyFontSizeBy(size/16.0)),
);

characterStyle2WikiFonts(style) {
	color = colorOfText(style);
	size = sizeOfText(style);
	wf = makeColoredWikiFonts(size, color);
	WikiFonts(
		wf.baseFontSize,
		wf.interlineSpace,
		style,
		wf.headingText,
		wf.heading2Text,
		wf.numberingText,
		wf.rightNumberingText,
		wf.bullet
	)
}

updateBullet(wf : WikiFonts, bullet : Form) {
	WikiFonts(
		wf.baseFontSize,
		wf.interlineSpace,
		wf.normalText,
		wf.headingText,
		wf.heading2Text,
		wf.numberingText,
		wf.rightNumberingText,
		bullet
	)
}

updateInterlineSpacing(wf, spacing) {
	WikiFonts(
		wf.baseFontSize,
		spacing,
		wf.normalText,
		wf.headingText,
		wf.heading2Text,
		wf.numberingText,
		wf.rightNumberingText,
		wf.bullet
	)
}

makeSmallWikiFonts(style) {
	WikiFonts(
		sizeOfText(style),
		SmallWikiFonts.interlineSpace,
		style,
		SmallWikiFonts.headingText,
		SmallWikiFonts.heading2Text,
		SmallWikiFonts.numberingText,
		SmallWikiFonts.rightNumberingText,
		SmallWikiFonts.bullet
	)
}

getWikiFonts(style : [WikiStyle]) -> WikiFonts {
	either(findmap(style, \o -> switch(o : WikiStyle) { WikiFonts(a1,a2,a3,a4,a5,a6,a7,a8) : Some(o); default : None(); }), NormalWikiFonts);
}

isDragDropBuffer(style : WikiStyle) {
	switch (style : WikiStyle) {
		DragDropBuffer(__, __) : true;
		default : false;
	}
}

getDragDropBuffer(style : [WikiStyle]) -> Maybe<DragDropBuffer> {
	cast(find(style, isDragDropBuffer) : Maybe<WikiStyle> -> Maybe<DragDropBuffer>);
}

clearDragDropBuffer(buffer) {
	nextDistinct(buffer.drgForm, []);
	nextDistinct(buffer.drpForm, []);
}

getInteractivenessSwitch(wikiStyle : [WikiStyle]) -> Behaviour<bool> {
	either(
		findmap(wikiStyle, \ws -> switch(ws : WikiStyle) {
			InteractiveSwitch(enable) : Some(enable);
			default : None();
		}),
		const(true)
	)
}

isAlreadyTranslated(wikiStyle) {
	contains(wikiStyle, AlreadyTranslated())
}


isWikiParsingStyle(style : WikiStyle) -> bool {
	switch(style : WikiStyle) {
		AllowSpacesBeetweenBracketedArgs() : true;
		ResourceGenerator(makeForm) : false;
		DragDropBuffer(__, __) : false;
		WikiAlign(__) : false;
		IgnoreUnknowPicsTypes() : true;
		InteractiveSwitch(__) : true;
		WikiMessages(__) : true;
		WigiEngine(__, __, __, __, __, __, __, __, __) : false;
		WriteSource() : true;
		WikiKaleidoscopeTileButtonStyle(__, __) : true;
		MediaCollector(__) : true;
		AlreadyTranslated() : true;
		SmallContentFillersDuringLoad() : true;
		WikiFonts(__, __, __, __, __, __, __, __) : false;
		RestrictAutoLineBreaks() : true;
		WikiNoAutoplay() : true;
		WikiScoringStatsCollector(__) : true;
		NumberedParagraph() : true;
		TZebraTable() : true;
		Wordlist(__) : true;
		WikiOverrideCondition(__, __) : true;
		WikiAltText(__) : true;
		WikiZoomBackgroundColor(__) : true;
		ExternallyGeneratedForms(__) : false;
		WigiAdjustPreviewHeight(__) : false;
		WikiBlanksCollector(__, __) : false;
		WikiSetBlanks(__) : false;
	}
}

withWikiColor(wf : WikiFonts, color : int) -> WikiFonts {
	WikiFonts(
		wf.baseFontSize,
		wf.interlineSpace,
		wf.normalText |> withFillColor(color),
		wf.headingText |> withFillColor(color),
		wf.heading2Text |> withFillColor(color),
		wf.numberingText |> withFillColor(color),
		wf.rightNumberingText |> withFillColor(color),
		wf.bullet
	)
}