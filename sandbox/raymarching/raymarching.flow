import material/extra/raymarching/raymarching;

main() {
	setRendererType("html");

	spheres1 = RMSTranslate(
		RMUnion2(
			RMMaterial(RMSTranslate(RMSphere(1.), RMY(1.)), RMColor(initRMInteractive(0xFFFF00)), []),
			RMSTranslate(
				RMUnion2(
					RMMaterial(RMSTranslate(RMSphere(0.5), RMX(2.)), RMColor(initRMInteractive(0xFF00FF)), []),
					RMMaterial(RMSTranslate(RMSphere(0.5), RMX(-2.)), RMColor(initRMInteractive(0x00FFFF)), [])
				),
				RMYZ(2., 2.)
			)
		),
		RMZ(3.)
	);

	spheres2 = RMUnion2(
		RMMaterial(RMSphere(0.5), RMColor(initRMInteractive(0x00FF00)), []),
		RMUnion2(
			RMMaterial(RMSTranslate(RMSphere(0.5), RMX(2.)), RMColor(initRMInteractive(0x0000FF)), []),
			RMMaterial(RMSTranslate(RMSphere(0.5), RMX(-2.)), RMColor(initRMInteractive(0xFF0000)), [])
		),
	);

	//scene = make(RMSTranslate(RMUnion2(spheres1, spheres2), RMZ(3.)));
	scene = RMUnion2(
		RMSTranslate(RMUnion2(spheres1, spheres2), RMZ(3.)),
		RMMaterial(RMPlane(RMXYZ(0., 1., 0.)), RMColor(initRMInteractive(0xBBBBBB)), [])
	);
	texture1B = initRMInteractive("");
	texture2B = initRMInteractive("");
	textureParametersB = initRMInteractive(getValue(makeDefaultRMTexture().parameters.behaviour));
	twistedTextureParameter = RMTextureParameters(
		RMTextureTilingParameter(1., 2., 1., 1., 2., 1.),
		RMTextureTilingParameter(1., 2.5, 2.6, 2.1, 2., 1.),
		RMTextureTilingParameter(1., 2., 1., 1.5, 2., 1.),
		RMTextureTilingParameter(1., 2., 3., 0.5, 2., 1.)
	);
	//timer(6000, \ -> next(textureParametersB.behaviour, twistedTextureParameter));
	trigger1B = make(RMMouseDownleft());
	cylinderColor1B = make(0xAF4DCE);
	trigger2B = make(RMMouseDownleft());
	cylinderColor2B = make(0xAFCD1E);
	scene2 = RMUnion([
		RMSmoothUnion([
			RMCompositeObject(RMSphere(0.7), "Sphere 2", RMColor(initRMInteractive(0x00FFFF)), [], RMXYZ(-2., 2., 8.)),
			RMCompositeObject(RMSphere(0.7), "Sphere 3", RMColor(initRMInteractive(0x00FF00)), [], RMXYZ(0., 0., 3.)),
			RMCompositeObject(RMSphere(0.7), "Sphere 4", RMColor(initRMInteractive(0x0000FF)), [], RMXYZ(2., 0., 3.)),
			RMCompositeObject(RMSphere(0.5), "Sphere 5", RMColor(initRMInteractive(0xFF0000)), [], RMXYZ(-2., 0., 3.)),
			//RMCompositeObject(RMPlane(RMXYZ(0., 1., 0.)), "Ground Plane", RMColor(initRMInteractive(0xFFFFFF)), [RMReflect(initRMInteractive(0.8))], RMXYZ(0., 0., 0.)),
			RMCompositeObject(RMSphere(1.), "Central sphere", RMColor(initRMInteractive(0xFFFF00)), [RMReflect(initRMInteractive(0.4))], RMXYZ(0., 1., 6.)),
			RMCompositeObject(RMTorus(1., 0.3), "Torus", RMColor(initRMInteractive(0xDA8E1F)), [], RMXYZ(-4., 2., 8.)),
		], 2.5),
		RMCompositeObject(RMBox(RMXYZ(0.3, 0.5, 1.)), "Box", RMTexture(makeDefaultRMTexture() with texture = texture1B), [], RMXYZ(0., 4., 4.)),
		RMCompositeObject(RMRoundBox(RMXYZ(0.3, 0.5, 1.), 0.25), "Round Box", RMTexture(texture2B, textureParametersB), [], RMXYZ(-2., 4., 4.)),
		RMCompositeObject(RMPlane(RMXYZ(0., 1., 0.)), "Ground Plane", RMColor(initRMInteractive(0xFFFFFF)), [RMReflect(initRMInteractive(0.8))], RMXYZ(0., 0., 0.)),
		RMCompositeObject(RMBoxFrame(RMXYZ(0.3, 0.5, 1.), 0.1), "Box Frame", RMTexture(makeDefaultRMTexture() with texture = initRMInteractive("images/splash/splash_innovation_trans.png")), [], RMXYZ(2., 4., 4.)),
		RMSmoothUnion([
			RMCompositeObject(RMSphere(0.5), "Sphere 1", RMColor(initRMInteractive(0xFF00FF)), [], RMXYZ(2., 2., 8.)),
			RMCompositeObject(RMCappedTorus(0.5, 0.3, 0.5), "Capped Torus", RMTexture(initRMInteractive("images/splash/splash_innovation_trans.png"), initRMInteractive(twistedTextureParameter)), [RMReflect(initRMInteractive(0.5))], RMXYZ(2., 2., 8.)),
		], 0.1),
		RMCompositeObject(RMCylinder(2., 0.5), "Cylinder", RMColor(RMInteractive(trigger1B, cylinderColor1B)), [], RMXYZ(-5., 5., 5.)),
		RMCompositeObject(RMRoundedCylinder(2., 0.5, 0.5), "Cylinder", RMColor(RMInteractive(trigger2B, cylinderColor2B)), [], RMXYZ(-5., 5., 3.)),
	]);

	/*light = RMPlus(
		RMPlus(
			RMTranslate(RMLightMaterial(RMLight(0.03), RMColor(initRMInteractive(0x00AAAA))), RMXYZ(-2., 8., 3.)),
			RMTranslate(RMLightMaterial(RMLight(0.05), RMColor(initRMInteractive(0xAA00AA))), RMXYZ(0., 8., 6.))
		),
		RMTranslate(RMLightMaterial(RMLight(0.07), RMColor(initRMInteractive(0xAAAA00))), RMXYZ(2., 8., 3.))
	);*/
	//light = RMTranslate(RMLightMaterial(RMLight(0.05), RMColor(initRMInteractive(0xFFFFFF))), RMXYZ(100., 100., 100.));
	light = RMCompositeLight(0.05, "Main light", RMColor(initRMInteractive(0xFFFFFF)), RMXYZ(100., 100., 100.));
	
	camera = RMCamera(RMXYZ(6., 8., 6.), RMXYZ(0., 0., 6.));

	mrender(
		makeMaterialManager([]), true,
		
		MConstruct(
			[
				\ -> subscribe2(trigger1B, \t -> if (t == RMMouseDownleft()) next(cylinderColor1B, round(i2d(getValue(cylinderColor1B)) * 1.1))),
				\ -> subscribe2(trigger2B, \t -> switch(t) {
					RMMouseHoverIn(): next(cylinderColor2B, getValue(cylinderColor2B) + 0x111111);
					RMMouseHoverOut(): next(cylinderColor2B, getValue(cylinderColor2B) - 0x111111);
					default : {}
				}),
				\ -> subscribe2(textureParametersB.trigger, \t -> if (t == RMMouseHover()) next(textureParametersB.behaviour, twistedTextureParameter)),
			],
			MLines([
				makeRaymarchingMaterialTexture(MTextButton("SOME BUTTON", nop, [MButtonRaised(), MGreen(900)], []), texture1B.behaviour),
				makeRaymarchingMaterialTexture(MTextButton("ANOTHER BUTTON", nop, [MButtonRaised(), MRed(900)], []), texture2B.behaviour),	
				MRaymarching(0, scene2, light, camera)
			])
		)
	)
}