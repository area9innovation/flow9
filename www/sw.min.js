var SERVICE_WORKER_VERSION=4,CACHE_NAME="flow-cache",CACHE_NAME_DYNAMIC="flow-dynamic-cache",rangeResourceCache="flow-range-cache",SHARED_DATA_ENDPOINT="share/pwa/data.php",dynamicResourcesExtensions=[".php",".serverbc"],CacheMode={PreferCachedResources:!1,CacheStaticContent:!0},requestsCacheFilter=[];function initializeCacheStorage(){return caches.open(CACHE_NAME).then(function(e){return console.log("Opened cache"),Promise.resolve()})}function isEmpty(e){return null==e||"string"==typeof e&&""==e||Array.isArray(e)&&0==e.length||"object"==typeof e&&0==Object.keys(e).length}var urlAddBaseLocation=function(e){var t=self.location.href,r=t.lastIndexOf("/");return-1!=r&&(t=t.substr(0,r+1)),e.startsWith("./")&&(e=t+e.substr(1,e.length-1)),e.replace(/(^|[^:])[\/]{2,}/,"$1/",e)},extractUrlParameters=function(e){var t=e.split("?");return t.length>1?{baseUrl:t[0],parameters:t.slice(1).join("?").split("&")}:{baseUrl:e,parameters:[]}},filterUrlParameters=function(e,t){var r=extractUrlParameters(e);return 0==r.parameters.length?e:r.baseUrl+"?"+r.parameters.filter(function(e){var r=e.indexOf("=");return-1!==r&&(e=e.substr(0,r).toLowerCase()),!t.includes(e)}).join("&")},sendMessageToClient=function(e,t){e.clientId&&setTimeout(function(){clients.get(e.clientId).then(function(e){e.postMessage(t)})},5)};self.addEventListener("install",function(e){e.waitUntil(initializeCacheStorage())}),self.addEventListener("fetch",function(e){var t=function(e){if("POST"==e.method&&e.headers.has("Content-Type")){var t=e.headers.get("Content-Type").toLowerCase();return t.includes("multipart/form-data")&&t.includes("boundary=")}return!1},r=function(e){var t,r=(t=new URL(h.url).pathname.split("/").pop().split(".")).length>1?t.pop():"",n=t.length>0?t.pop():"";return CacheMode.CacheStaticContent&&!isEmpty(r)&&(!dynamicResourcesExtensions.includes("."+r)||"stamp.php"==n+"."+r)},n=function(e){var r=urlAddBaseLocation(e.url),n=extractUrlParameters(r),a=n.baseUrl,s="?",c=t(e);return"POST"==e.method?c?Promise.resolve({urlNewFull:r,isFileUploading:c}):(0!=n.parameters.length&&(a+=s+n.parameters.join("&"),s="&"),e.clone().text().then(function(e){return isEmpty(e)||(a+=s+e),{urlNewFull:a,isFileUploading:c}}).catch(function(){return{urlNewFull:r,isFileUploading:c}})):Promise.resolve({urlNewFull:r,isFileUploading:c})},a=function(e,t,r){e=e.toLowerCase(),t=t.toLowerCase();var n=extractUrlParameters(e).parameters,a=requestsCacheFilter.map(function(a){return""==a.url||e.startsWith(a.url)?(methods=a.methods.map(function(e){if(""==e.method||e.method==t){if(0==e.parameters.length||r)return[{method:e.method,parameters:[],ignoreKeys:[]}];return e.parameters.filter(function(e){return 0==e.keyValues.length||function(e){return e.keyValues.every(function(e){var t=e.key+"="+e.value;return-1!=n.findIndex(function(e){return t==e})})}(e)}).map(function(t){return{method:e.method,parameters:t.keyValues,ignoreKeys:t.ignoreKeys}})}}).filter(function(e){return null!=e}).flat(),methods.length>0?methods.map(function(e){return{url:a.url,method:e.method,parameters:e.parameters,ignoreKeys:e.ignoreKeys}}):void 0):void 0}).filter(function(e){return null!=e}).flat();return a.length>0?a[0]:void 0},s=function(e){if(e.isCustomCaching||e.urlNewToCache!=e.originalRequest.url){var t=e.cloneRequest();return new Request(e.urlNewToCache,{method:"GET",headers:t.headers,mode:"same-origin",credentials:t.credentials,cache:t.cache,redirect:t.redirect,referrer:t.referrer,integrity:t.integrity})}return e.cloneRequest()},c=function(e,t){var r=e.cloneRequest(),n=new Headers;return r.headers.forEach(function(e,t){n.set(t,e)}),n.set("If-None-Match",t),new Request(r.url,{method:r.method,headers:n,body:r.body,mode:"same-origin",credentials:r.credentials,cache:r.cache,redirect:r.redirect,referrer:r.referrer,integrity:r.integrity})},i=function(){if(!e.clientId)return Promise.reject();var t=new URL(e.request.url);return clients.get(e.clientId).then(function(e){var r=new URL(e.url);return t.pathname.endsWith("/php/stamp.php")&&t.searchParams.get("file")==r.searchParams.get("name")+".js"?Promise.resolve():Promise.reject()})};function o(t,r){return t.isFileUploading?Promise.reject():caches.match(s(t),{ignoreSearch:r&&!t.isCustomCaching}).then(function(r){return r?(sendMessageToClient(e,{msg:"Responded with cache:",url:t.originalRequest.url,urlCached:t.urlNewToCache}),r.clone()):Promise.reject()})}function u(e){return i().then(function(){return o(e,!0)}).catch(function(){return o(e,!1)})}function l(t,r){var n=function(r){var n=s(t),a=CACHE_NAME;t.isCustomCaching&&(a=CACHE_NAME_DYNAMIC),(t.isCustomCaching||t.isStaticCaching)&&caches.open(a).then(function(a){a.put(n,r.clone()),sendMessageToClient(e,{msg:"Cached resource:",url:t.originalRequest.url,urlCached:n.url})})},a=function(){return fetch(t.cloneRequest()).then(function(e){return 200==e.status&&"basic"==e.type&&n(e),e.clone()})};return t.isFileUploading?fetch(t.cloneRequest()).then(function(e){return e.clone()}):r?u(t).then(function(e){var r=e.headers.get("etag");return isEmpty(r)?a():fetch(c(t,r)).then(function(t){return 200==t.status&&"basic"==t.type?(n(t),t.clone()):304==t.status&&"basic"==t.type?e.clone():t.clone()})}).catch(a):a()}const{request:h,request:{url:d,method:f}}=e;if(d.match(SHARED_DATA_ENDPOINT))e.respondWith(caches.open(SHARED_DATA_ENDPOINT).then(e=>"POST"==f?h.json().then(t=>(e.put(SHARED_DATA_ENDPOINT+"/"+t.key,new Response(t.value)),new Response("OK"))):e.match(SHARED_DATA_ENDPOINT+"/"+new URL(h.url).searchParams.get("key")).then(e=>e||new Response(""))||new Response("")));else{!function(e){var t=new URL(e);i().then(function(){return caches.open(CACHE_NAME).then(function(e){return e.delete(self.registration.scope+"php/stamp.php",{ignoreSearch:!0}).then(function(){return e.delete(self.registration.scope+t.searchParams.get("file"),{ignoreSearch:!0})})})}).catch(function(){return null})}(e.request.url);var m=function(n){var s=urlAddBaseLocation(n.url);extractUrlParameters(s).baseUrl;if("GET"==n.method){var c=a(s,n.method,!1),i=n.url;return isEmpty(c)||(i=filterUrlParameters(s,c.ignoreKeys)),m={urlNewFull:s,urlNewToCache:i,isCustomCaching:!isEmpty(c),isStaticCaching:r(e.request.url),customCacheFilter:c,originalRequest:n,isFileUploading:t(n),cloneRequest:function(){return n.clone()}}}return null}(e.request);if(function(e,n){return t(e)||!isEmpty(e.headers.get("range"))||!r(e.url)&&(isEmpty(n)||!n.isCustomCaching)&&isEmpty(function(e){var t=urlAddBaseLocation(e.url);return a(t,e.method,!0)}(e))}(e.request,m))return;e.respondWith(function(t,c){return(null!=c?Promise.resolve(c):n(t).then(function(n){var s=a(n.urlNewFull,t.method,!1),c=n.urlNewFull;return isEmpty(s)||(c=filterUrlParameters(n.urlNewFull,s.ignoreKeys)),{urlNewFull:n.urlNewFull,urlNewToCache:c,isCustomCaching:!isEmpty(s),isStaticCaching:r(e.request.url),customCacheFilter:s,originalRequest:t,isFileUploading:n.isFileUploading,cloneRequest:function(){return t.clone()}}})).then(function(e){return e.originalRequest.headers.get("range")?(t=e,caches.open(rangeResourceCache).then(function(e){return e.match(t.fixedUrlToCache)}).then(function(e){return e||fetch(t.originalRequest).then(function(e){if(200==e.status){var r=e.clone();return caches.open(rangeResourceCache).then(function(e){return e.put(s(t),r)}).then(function(){return e})}return e})}).then(function(e){return 200==e.status?e.arrayBuffer().then(function(r){var n=/^bytes\=(\d+)\-(\d+)?$/g.exec(t.originalRequest.headers.get("range"));if(n){var a=Number(n[1]),s=Number(n[2])||r.byteLength-1;return new Response(r.slice(a,s+1),{status:206,statusText:"Partial Content",headers:[["Content-Type",e.headers.get("Content-Type")],["Content-Range","bytes "+a+"-"+s+"/"+r.byteLength]]})}return new Response(null,{status:416,statusText:"Range Not Satisfiable",headers:[["Content-Range","*/"+r.byteLength]]})}):e})):function(e){return CacheMode.PreferCachedResources?u(e).catch(function(){return l(e,!1)}):l(e,!0).catch(function(){return u(e)})}(e);var t})}(e.request,m))}});var cleanServiceWorkerCache=function(){return caches.delete(rangeResourceCache),console.log("cache cleared",rangeResourceCache),caches.keys().then(function(e){return Promise.all(e.map(function(e){if(CACHE_NAME!=e&&SHARED_DATA_ENDPOINT!=e)return console.log("cache cleared",e),caches.delete(e)}))})};self.addEventListener("install",e=>{self.skipWaiting(),e.waitUntil(Promise.resolve())}),self.addEventListener("activate",function(e){cleanServiceWorkerCache(),e.waitUntil(clients.claim())}),self.addEventListener("message",function(e){var t,r=function(t){e.ports.length>0?e.ports[0].postMessage(t):console.error("Failed to respond!")},n=function(e){e.then(function(){r({status:"OK"})}).catch(function(){r({status:"Failed"})})};if("get_cache_version"==e.data.action)r({cache_version:SW_CACHE_VERSION});else if(e.data.action.indexOf("_cache_resources")>0)n(caches.open(CACHE_NAME).then(function(t){return Promise.all(e.data.urls.map(function(r){return"add_cache_resources"==e.data.action?t.add(r):"remove_cache_resources"==e.data.action?t.delete(r):void 0}))}));else if("get_cache_storage_names"==e.data.action)caches.keys().then(function(e){r({names:e})});else if("remove_cache_storage"==e.data.action)n(caches.delete(e.data.action.name));else if("clean_cache_storage"==e.data.action)n(cleanServiceWorkerCache());else if("requests_cache_filter"==e.data.action){e.data.data.cacheIfUrlMatch=urlAddBaseLocation(e.data.data.cacheIfUrlMatch).toLowerCase(),e.data.data.method=e.data.data.method.toLowerCase(),e.data.data.ignoreParameterKeysOnCache=e.data.data.ignoreParameterKeysOnCache.map(function(e){return e.toLowerCase()});var a=function(e,t){return isEmpty(e)&&isEmpty(t)||e===t},s=function(e){return isEmpty(e)?"":e},c=requestsCacheFilter.findIndex(function(t){return a(e.data.data.cacheIfUrlMatch,t.url)});-1==c&&(requestsCacheFilter.push({url:s(e.data.data.cacheIfUrlMatch),methods:[]}),c=requestsCacheFilter.length-1);var i=requestsCacheFilter[c].methods.findIndex(function(t){return a(e.data.data.method,t.method)});-1==i&&(requestsCacheFilter[c].methods.push({method:s(e.data.data.method),parameters:[]}),i=requestsCacheFilter[c].methods.length-1);var o=requestsCacheFilter[c].methods[i].parameters.findIndex(function(t){return t.keyValues.length==e.data.data.cacheIfParametersMatch.length&&e.data.data.cacheIfParametersMatch.every(function(e){return 2==e.length&&-1!=t.keyValues.findIndex(function(t){return a(t.key,e[0])&&a(t.value,e[1])})})});-1==o?requestsCacheFilter[c].methods[i].parameters.push({keyValues:e.data.data.cacheIfParametersMatch.map(function(e){return{key:e[0],value:e[1]}}),ignoreKeys:e.data.data.ignoreParameterKeysOnCache}):requestsCacheFilter[c].methods[i].parameters[o]={keyValues:e.data.data.cacheIfParametersMatch.map(function(e){return{key:e[0],value:e[1]}}),ignoreKeys:e.data.data.ignoreParameterKeysOnCache},r({status:"OK"})}else"load_and_cache_urls"==e.data.action?n(Promise.all(e.data.data.urls.map(function(t){return function(t,r){var n=new Request(urlAddBaseLocation(t));return fetch(n).then(function(a){if(200!=a.status||"basic"!=a.type)return!1;var s=new Request(filterUrlParameters(n.url,r));caches.open(CACHE_NAME_DYNAMIC).then(function(r){return r.put(s,a.clone()),sendMessageToClient(e,{msg:"Cached resource:",url:t,urlCached:s.url}),!0}).catch(function(){return!1})}).catch(function(){return!1})}(t,e.data.data.ignoreParameterKeysOnCache)}))):"check_urls_in_cache"==e.data.action?(t=e.data.data.urls,Promise.all(t.map(function(e){return caches.match(urlAddBaseLocation(e),{ignoreSearch:!1}).then(function(t){return t?e:""}).catch(function(){return""})})).then(function(e){return e.filter(function(e){return""!=e})}).then(function(e){return{urls:e,status:"OK"}}).catch(function(){return{urls:[],status:"Failed"}})).then(r):"get_service_worker_version"==e.data.action?r({data:SERVICE_WORKER_VERSION}):r({status:"Failed",error:"Unknown operation: "+e.data.action})});