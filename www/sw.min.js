var SERVICE_WORKER_VERSION=7,CACHE_NAME="flow-cache",CACHE_NAME_DYNAMIC="flow-dynamic-cache",rangeResourceCache="flow-range-cache",SHARED_DATA_ENDPOINT="share/pwa/data.php",dynamicResourcesExtensions=[".php",".serverbc",".html",".js"],CacheMode={PreferCachedResources:!1,CacheStaticResources:!0},requestsSkipOnFetch=[],requestsCacheFilter=[];function initializeCacheStorage(){return caches.open(CACHE_NAME).then((function(cache){return console.log("Opened cache"),Promise.resolve()}))}function isEmpty(v){return null==v||"string"==typeof v&&""==v||Array.isArray(v)&&0==v.length||"object"==typeof v&&0==Object.keys(v).length}var urlAddBaseLocation=function(url){var baseUrl=self.location.href,i=baseUrl.lastIndexOf("/");return-1!=i&&(baseUrl=baseUrl.substr(0,i+1)),url.startsWith("./")&&(url=baseUrl+url.substr(1,url.length-1)),url.replace(/(^|[^:])[/]{2,}/,"$1/",url)},extractUrlParameters=function(url){var urlSplitted=url.split("?");return urlSplitted.length>1?{baseUrl:urlSplitted[0],parameters:urlSplitted.slice(1).join("?").split("&")}:{baseUrl:url,parameters:[]}},filterUrlParameters=function(url,ignoreParameters){var urlParameters=extractUrlParameters(url);return 0==urlParameters.parameters.length?url:urlParameters.baseUrl+"?"+urlParameters.parameters.filter((function(p){var index=p.indexOf("=");return-1!==index&&(p=p.substr(0,index).toLowerCase()),!ignoreParameters.includes(p)})).join("&")},sendMessageToClient=function(event,data){event.clientId&&setTimeout((function(){clients.get(event.clientId).then((function(client){client.postMessage(data)}))}),5)};self.addEventListener("install",(function(event){event.waitUntil(initializeCacheStorage())})),self.addEventListener("fetch",(function(event){var isMatchSkipFilter=function(request){var fixedUrl=urlAddBaseLocation(request.url).toLowerCase(),method=request.method.toLowerCase();return!isEmpty(requestsSkipOnFetch.find((function(elUrl){return!(!isEmpty(elUrl.url)&&!fixedUrl.startsWith(elUrl.url))&&!isEmpty(elUrl.methods.find((function(elMethod){return!(!isEmpty(elMethod.method)&&elMethod.method!=method)&&!isEmpty(elMethod.headers.find((function(elHeader){return isEmpty(elHeader.key)||request.headers.has(elHeader.key)&&request.headers.get(elHeader.key)==elHeader.value})))})))})))},isFileUploadingRequestFn=function(request){if("POST"==request.method&&request.headers.has("Content-Type")){var ctValue=request.headers.get("Content-Type").toLowerCase(),clValue=request.headers.get("Content-Length");return ctValue.includes("multipart/form-data")&&ctValue.includes("boundary=")||clValue>1e4}return!1},isStaticCachingFn=function(url){var requestUrl,parts,ext=(parts=new URL(request.url).pathname.split("/").pop().split(".")).length>1?parts.pop():"",name=parts.length>0?parts.pop():"";return CacheMode.CacheStaticResources&&!isEmpty(ext)&&(!dynamicResourcesExtensions.includes("."+ext)||"stamp.php"==name+"."+ext)},createRequestDataGET=function(request){var fixedUrl=urlAddBaseLocation(request.url),urlSplitted,requestUrl=extractUrlParameters(fixedUrl).baseUrl,glueSymb="?";if("GET"==request.method){var cacheFilter=findCacheFilter(fixedUrl,request.method,!1),fixedUrlToCache=request.url;return isEmpty(cacheFilter)||(fixedUrlToCache=filterUrlParameters(fixedUrl,cacheFilter.ignoreKeys)),requestData={urlNewFull:fixedUrl,urlNewToCache:fixedUrlToCache,isCustomCaching:!isEmpty(cacheFilter),isStaticCaching:isStaticCachingFn(event.request.url),customCacheFilter:cacheFilter,originalRequest:request,isFileUploading:isFileUploadingRequestFn(request),cloneRequest:function(){return request.clone()}}}return null},getFixedRequestUrl=function(request){var fixedUrl=urlAddBaseLocation(request.url),urlSplitted=extractUrlParameters(fixedUrl),requestUrl=urlSplitted.baseUrl,glueSymb="?",isFileUploadingRequest=isFileUploadingRequestFn(request);return"POST"==request.method?isFileUploadingRequest?Promise.resolve({urlNewFull:fixedUrl,isFileUploading:isFileUploadingRequest}):(0!=urlSplitted.parameters.length&&(requestUrl+=glueSymb+urlSplitted.parameters.join("&"),glueSymb="&"),request.clone().text().then((function(reqParamsText){return isEmpty(reqParamsText)||(requestUrl+=glueSymb+reqParamsText),{urlNewFull:requestUrl,isFileUploading:isFileUploadingRequest}})).catch((function(){return{urlNewFull:fixedUrl,isFileUploading:isFileUploadingRequest}}))):Promise.resolve({urlNewFull:fixedUrl,isFileUploading:isFileUploadingRequest})},findCacheFilter=function(fixedUrl,method,checkWithoutParameters){fixedUrl=fixedUrl.toLowerCase(),method=method.toLowerCase();var urlParams=extractUrlParameters(fixedUrl).parameters,cFilters=requestsCacheFilter.map((function(elUrl){return""==elUrl.url||fixedUrl.startsWith(elUrl.url)?(methods=elUrl.methods.map((function(elMethod){if(""==elMethod.method||elMethod.method==method){if(0==elMethod.parameters.length||checkWithoutParameters)return[{method:elMethod.method,parameters:[],ignoreKeys:[]}];var checkRequestParameters=function(parameter){return parameter.keyValues.every((function(keyValue){var pair=keyValue.key+"="+keyValue.value;return-1!=urlParams.findIndex((function(up){return pair==up}))}))};return elMethod.parameters.filter((function(parameter){return 0==parameter.keyValues.length||checkRequestParameters(parameter)})).map((function(parameter){return{method:elMethod.method,parameters:parameter.keyValues,ignoreKeys:parameter.ignoreKeys}}))}})).filter((function(elMethod){return null!=elMethod})).flat(),methods.length>0?methods.map((function(elMethod){return{url:elUrl.url,method:elMethod.method,parameters:elMethod.parameters,ignoreKeys:elMethod.ignoreKeys}})):void 0):void 0})).filter((function(el1){return null!=el1})).flat();return cFilters.length>0?cFilters[0]:void 0},findCacheFilterSimple=function(request){var fixedUrl=urlAddBaseLocation(request.url);return findCacheFilter(fixedUrl,request.method,!0)},prepareRequestToCache=function(requestData){if(requestData.isCustomCaching||requestData.urlNewToCache!=requestData.originalRequest.url){var requestCloned=requestData.cloneRequest();return new Request(requestData.urlNewToCache,{method:"GET",headers:requestCloned.headers,mode:"same-origin",credentials:requestCloned.credentials,cache:requestCloned.cache,redirect:requestCloned.redirect,referrer:requestCloned.referrer,integrity:requestCloned.integrity})}return requestData.cloneRequest()},createIfNoneMatchRequest=function(requestData,etag){var requestCloned=requestData.cloneRequest(),headers=new Headers;return requestCloned.headers.forEach((function(val,key){headers.set(key,val)})),headers.set("If-None-Match",etag),"POST"==requestCloned.method?requestCloned.blob().then((function(reqBlob){return new Request(requestCloned.url,{method:requestCloned.method,headers:headers,body:reqBlob,mode:"same-origin",credentials:requestCloned.credentials,cache:requestCloned.cache,redirect:requestCloned.redirect,referrer:requestCloned.referrer,integrity:requestCloned.integrity})})).catch((function(){return new Request(requestCloned.url,{method:requestCloned.method,headers:headers,mode:"same-origin",credentials:requestCloned.credentials,cache:requestCloned.cache,redirect:requestCloned.redirect,referrer:requestCloned.referrer,integrity:requestCloned.integrity})})):Promise.resolve(new Request(requestCloned.url,{method:requestCloned.method,headers:headers,mode:"same-origin",credentials:requestCloned.credentials,cache:requestCloned.cache,redirect:requestCloned.redirect,referrer:requestCloned.referrer,integrity:requestCloned.integrity}))},cleanTimestampSensitiveRequests=function(originalUrl){var url=new URL(originalUrl);return isStampForApplicationJsRequest().then((function(){return caches.open(CACHE_NAME).then((function(cache){return cache.delete(self.registration.scope+"php/stamp.php",{ignoreSearch:!0}).then((function(){return cache.delete(self.registration.scope+url.searchParams.get("file"),{ignoreSearch:!0})}))}))})).catch((function(){return null}))},isStampForApplicationJsRequest=function(){if(!event.clientId)return Promise.reject();var url=new URL(event.request.url);return clients.get(event.clientId).then((function(client){var clientUrl=new URL(client.url);return url.pathname.endsWith("/php/stamp.php")&&url.searchParams.get("file")==clientUrl.searchParams.get("name")+".js"?Promise.resolve():Promise.reject()}))},checkRequestForSkipping=function(request,requestData){return isMatchSkipFilter(request)||isFileUploadingRequestFn(request)||!isEmpty(request.headers.get("range"))||!isStaticCachingFn(request.url)&&(isEmpty(requestData)||!requestData.isCustomCaching)&&isEmpty(findCacheFilterSimple(request))};function getResourceFromCache(requestData,ignoreSearch){return requestData.isFileUploading?Promise.reject():caches.match(prepareRequestToCache(requestData),{ignoreSearch:ignoreSearch&&!requestData.isCustomCaching}).then((function(response){return response?(sendMessageToClient(event,{msg:"Responded with cache:",url:requestData.originalRequest.url,urlCached:requestData.urlNewToCache}),response.clone()):Promise.reject()}))}function getCachedResource(requestData){return isStampForApplicationJsRequest().then((function(){return getResourceFromCache(requestData,!0)})).catch((function(){return getResourceFromCache(requestData,!1)}))}function fetchResource(requestData,checkIfNotModified){var doCacheFn=function(response){var fixedRequest=prepareRequestToCache(requestData),usedCacheName=CACHE_NAME;requestData.isCustomCaching&&(usedCacheName=CACHE_NAME_DYNAMIC),(requestData.isCustomCaching||requestData.isStaticCaching)&&caches.open(usedCacheName).then((function(cache){cache.put(fixedRequest,response.clone()),sendMessageToClient(event,{msg:"Cached resource:",url:requestData.originalRequest.url,urlCached:fixedRequest.url})}))},doFetchFn=function(){return fetch(requestData.cloneRequest()).then((function(response){return 200==response.status&&"basic"==response.type&&doCacheFn(response),response.clone()}))};return requestData.isFileUploading?fetch(requestData.cloneRequest()).then((function(response){return response.clone()})):checkIfNotModified?getCachedResource(requestData).then((function(responseCache){var etag=responseCache.headers.get("etag");return isEmpty(etag)?doFetchFn():createIfNoneMatchRequest(requestData,etag).then((function(cRequest){return fetch(cRequest).then((function(response){return 200==response.status&&"basic"==response.type?(doCacheFn(response),response.clone()):304==response.status&&"basic"==response.type?responseCache.clone():response.clone()})).catch(doFetchFn)}))})).catch(doFetchFn):doFetchFn()}function buildResponse(requestData){return CacheMode.PreferCachedResources?getCachedResource(requestData).catch((function(){return fetchResource(requestData,!1)})):fetchResource(requestData,!0).catch((function(){return getCachedResource(requestData)}))}function buildRangeResponse(requestData){return caches.open(rangeResourceCache).then((function(cache){return cache.match(requestData.fixedUrlToCache)})).then((function(res){return res||fetch(requestData.originalRequest).then((function(res){if(200==res.status){var resCloned=res.clone();return caches.open(rangeResourceCache).then((function(cache){return cache.put(prepareRequestToCache(requestData),resCloned)})).then((function(){return res}))}return res}))})).then((function(response){return 200==response.status?response.arrayBuffer().then((function(arrayBuffer){var bytes=/^bytes\=(\d+)\-(\d+)?$/g.exec(requestData.originalRequest.headers.get("range"));if(bytes){var start=Number(bytes[1]),end=Number(bytes[2])||arrayBuffer.byteLength-1;return new Response(arrayBuffer.slice(start,end+1),{status:206,statusText:"Partial Content",headers:[["Content-Type",response.headers.get("Content-Type")],["Content-Range","bytes "+start+"-"+end+"/"+arrayBuffer.byteLength]]})}return new Response(null,{status:416,statusText:"Range Not Satisfiable",headers:[["Content-Range","*/"+arrayBuffer.byteLength]]})})):response}))}function makeResponse(request,requestData){var fn;return function(){return null!=requestData?Promise.resolve(requestData):getFixedRequestUrl(request).then((function(urlAndBody){var cacheFilter=findCacheFilter(urlAndBody.urlNewFull,request.method,!1),fixedUrlToCache=urlAndBody.urlNewFull;return isEmpty(cacheFilter)||(fixedUrlToCache=filterUrlParameters(urlAndBody.urlNewFull,cacheFilter.ignoreKeys)),{urlNewFull:urlAndBody.urlNewFull,urlNewToCache:fixedUrlToCache,isCustomCaching:!isEmpty(cacheFilter),isStaticCaching:isStaticCachingFn(event.request.url),customCacheFilter:cacheFilter,originalRequest:request,isFileUploading:urlAndBody.isFileUploading,cloneRequest:function(){return request.clone()}}}))}().then((function(requestData2){return requestData2.originalRequest.headers.get("range")?buildRangeResponse(requestData2):buildResponse(requestData2)}))}const{request:request,request:{url:url,method:method}}=event;if(url.match(SHARED_DATA_ENDPOINT))event.respondWith(caches.open(SHARED_DATA_ENDPOINT).then(cache=>"POST"==method?request.json().then(data=>(cache.put(SHARED_DATA_ENDPOINT+"/"+data.key,new Response(data.value)),new Response("OK"))):cache.match(SHARED_DATA_ENDPOINT+"/"+new URL(request.url).searchParams.get("key")).then(response=>response||new Response(""))||new Response("")));else{cleanTimestampSensitiveRequests(event.request.url);var requestData=createRequestDataGET(event.request);if(checkRequestForSkipping(event.request,requestData))return;event.respondWith(makeResponse(event.request,requestData))}}));var cleanServiceWorkerCache=function(){return caches.delete(rangeResourceCache),console.log("cache cleared",rangeResourceCache),caches.keys().then((function(keyList){return Promise.all(keyList.map((function(key){if(CACHE_NAME!=key&&SHARED_DATA_ENDPOINT!=key)return console.log("cache cleared",key),caches.delete(key)})))}))};self.addEventListener("install",event=>{self.skipWaiting(),event.waitUntil(Promise.resolve())}),self.addEventListener("activate",(function(event){cleanServiceWorkerCache(),event.waitUntil(clients.claim())})),self.addEventListener("message",(function(event){var respond=function(data){event.ports.length>0?event.ports[0].postMessage(data):console.error("Failed to respond!")},respondWithStatus=function(promise){promise.then((function(){respond({status:"OK"})})).catch((function(){respond({status:"Failed"})}))},fetchAndCacheByUrl=function(url,ignoreParameters){var request=new Request(urlAddBaseLocation(url));return fetch(request).then((function(response){if(200!=response.status||"basic"!=response.type)return!1;var requestToCache=new Request(filterUrlParameters(request.url,ignoreParameters));caches.open(CACHE_NAME_DYNAMIC).then((function(cache){return cache.put(requestToCache,response.clone()),sendMessageToClient(event,{msg:"Cached resource:",url:url,urlCached:requestToCache.url}),!0})).catch((function(){return!1}))})).catch((function(){return!1}))},isEqualStrings=function(str1,str2){return isEmpty(str1)&&isEmpty(str2)||str1===str2},getNotEmptyString=function(str){return isEmpty(str)?"":str},checkUrlsInCache=function(urls){return Promise.all(urls.map((function(url){return caches.match(urlAddBaseLocation(url),{ignoreSearch:!1}).then((function(response){return response?url:""})).catch((function(){return""}))}))).then((function(urls2){return urls2.filter((function(url){return""!=url}))})).then((function(urls2){return{urls:urls2,status:"OK"}})).catch((function(){return{urls:[],status:"Failed"}}))};if("set_prefer_cached_resources"==event.data.action)CacheMode.PreferCachedResources=event.data.data.value,respond({status:"OK"});else if("set_cache_static_resources"==event.data.action)CacheMode.CacheStaticResources=event.data.data.value,respond({status:"OK"});else if("get_cache_version"==event.data.action)respond({cache_version:SW_CACHE_VERSION});else if(event.data.action.indexOf("_cache_resources")>0)respondWithStatus(caches.open(CACHE_NAME).then((function(cache){return Promise.all(event.data.urls.map((function(url){return"add_cache_resources"==event.data.action?cache.add(url):"remove_cache_resources"==event.data.action?cache.delete(url):void 0})))})));else if("get_cache_storage_names"==event.data.action)caches.keys().then((function(keyList){respond({names:keyList})}));else if("remove_cache_storage"==event.data.action)respondWithStatus(caches.delete(event.data.action.name));else if("clean_cache_storage"==event.data.action)respondWithStatus(cleanServiceWorkerCache());else if("requests_cache_filter"==event.data.action){var idx1,idx2,idx3;event.data.data.cacheIfUrlMatch=urlAddBaseLocation(event.data.data.cacheIfUrlMatch).toLowerCase(),event.data.data.method=event.data.data.method.toLowerCase(),event.data.data.ignoreParameterKeysOnCache=event.data.data.ignoreParameterKeysOnCache.map((function(el){return el.toLowerCase()})),-1==(idx1=requestsCacheFilter.findIndex((function(el){return isEqualStrings(event.data.data.cacheIfUrlMatch,el.url)})))&&(requestsCacheFilter.push({url:getNotEmptyString(event.data.data.cacheIfUrlMatch),methods:[]}),idx1=requestsCacheFilter.length-1),-1==(idx2=requestsCacheFilter[idx1].methods.findIndex((function(el){return isEqualStrings(event.data.data.method,el.method)})))&&(requestsCacheFilter[idx1].methods.push({method:getNotEmptyString(event.data.data.method),parameters:[]}),idx2=requestsCacheFilter[idx1].methods.length-1),-1==(idx3=requestsCacheFilter[idx1].methods[idx2].parameters.findIndex((function(els){return els.keyValues.length==event.data.data.cacheIfParametersMatch.length&&event.data.data.cacheIfParametersMatch.every((function(pair){return 2==pair.length&&-1!=els.keyValues.findIndex((function(kv){return isEqualStrings(kv.key,pair[0])&&isEqualStrings(kv.value,pair[1])}))}))})))?requestsCacheFilter[idx1].methods[idx2].parameters.push({keyValues:event.data.data.cacheIfParametersMatch.map((function(pair){return{key:pair[0],value:pair[1]}})),ignoreKeys:event.data.data.ignoreParameterKeysOnCache}):requestsCacheFilter[idx1].methods[idx2].parameters[idx3]={keyValues:event.data.data.cacheIfParametersMatch.map((function(pair){return{key:pair[0],value:pair[1]}})),ignoreKeys:event.data.data.ignoreParameterKeysOnCache},respond({status:"OK"})}else if("requests_skip_filter"==event.data.action){var idx1,idx2,idx3;event.data.data.url=urlAddBaseLocation(event.data.data.url).toLowerCase(),event.data.data.method=event.data.data.method.toLowerCase(),event.data.data.header=event.data.data.header.map((function(el){return el.toLowerCase()})),2==event.data.data.header.length?event.data.data.header={key:event.data.data.header[0],value:event.data.data.header[1]}:event.data.data.header={key:"",value:""},-1==(idx1=requestsSkipOnFetch.findIndex((function(el){return isEqualStrings(event.data.data.url,el.url)})))&&(requestsSkipOnFetch.push({url:getNotEmptyString(event.data.data.url),methods:[]}),idx1=requestsSkipOnFetch.length-1),-1==(idx2=requestsSkipOnFetch[idx1].methods.findIndex((function(el){return isEqualStrings(event.data.data.method,el.method)})))&&(requestsSkipOnFetch[idx1].methods.push({method:getNotEmptyString(event.data.data.method),headers:[]}),idx2=requestsSkipOnFetch[idx1].methods.length-1),-1==(idx3=requestsSkipOnFetch[idx1].methods[idx2].headers.findIndex((function(h){return isEqualStrings(h.key,event.data.data.header.key)&&isEqualStrings(h.value,event.data.data.header.value)})))&&requestsSkipOnFetch[idx1].methods[idx2].headers.push(event.data.data.header),respond({status:"OK"})}else"load_and_cache_urls"==event.data.action?respondWithStatus(Promise.all(event.data.data.urls.map((function(url){return fetchAndCacheByUrl(url,event.data.data.ignoreParameterKeysOnCache)})))):"check_urls_in_cache"==event.data.action?checkUrlsInCache(event.data.data.urls).then(respond):"get_service_worker_version"==event.data.action?respond({data:SERVICE_WORKER_VERSION}):respond({status:"Failed",error:"Unknown operation: "+event.data.action})}));