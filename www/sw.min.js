var CACHE_NAME="flow-cache",CACHE_NAME_DYNAMIC="flow-dynamic-cache",rangeResourceCache="flow-range-cache",SHARED_DATA_ENDPOINT="share/pwa/data",dynamicResourcesExtensions=[".php",".serverbc"],CacheMode={PreferCachedResources:!1,CacheStaticContent:!0},requestsCacheFilter=[];function initializeCacheStorage(){return caches.open(CACHE_NAME).then(function(){return console.log("Opened cache"),Promise.resolve()})}var urlAddBaseLocation=function(a){var b=self.location.href,c=b.lastIndexOf("/");return-1!=c&&(b=b.substr(0,c+1)),a.startsWith("./")&&(a=b+a.substr(1,a.length-1)),a.replace(/(^|[^:])[/]{2,}/,"$1/",a)},extractUrlParameters=function(a){var b=a.split("?");return 1<b.length?{baseUrl:b[0],parameters:b.slice(1).join("?").split("&")}:{baseUrl:a,parameters:[]}},filterUrlParameters=function(a,b){var c=extractUrlParameters(a);return 0==c.length?a:c.baseUrl+"?"+c.parameters.filter(function(a){var c=a.indexOf("=");return-1!==c&&(a=a.substr(0,c).toLowerCase()),!b.includes(a)}).join("&")},sendMessageToClient=function(a,b){a.clientId&&setTimeout(function(){clients.get(a.clientId).then(function(a){a.postMessage(b)})},5)};self.addEventListener("install",function(a){a.waitUntil(initializeCacheStorage())}),self.addEventListener("fetch",function(a){function b(a){return CacheMode.PreferCachedResources?i(a).catch(function(){return j(a)}):j(a).catch(function(){return i(a)})}function c(a){return caches.open(rangeResourceCache).then(function(b){return b.match(a.fixedUrlToCache)}).then(function(b){return b?b:fetch(a.originalRequest).then(function(b){if(200==b.status){var c=b.clone();return caches.open(rangeResourceCache).then(function(b){return b.put(f(a),c)}).then(function(){return b})}return b})}).then(function(b){return 200==b.status?b.arrayBuffer().then(function(c){var d=/^bytes\=(\d+)\-(\d+)?$/g.exec(a.originalRequest.headers.get("range"));if(d){var e=+d[1],f=+d[2]||c.byteLength-1;return new Response(c.slice(e,f+1),{status:206,statusText:"Partial Content",headers:[["Content-Type",b.headers.get("Content-Type")],["Content-Range","bytes "+e+"-"+f+"/"+c.byteLength]]})}return new Response(null,{status:416,statusText:"Range Not Satisfiable",headers:[["Content-Range","*/"+c.byteLength]]})}):b})}var d=function(a){var b=extractUrlParameters(urlAddBaseLocation(a.url)),c=b.baseUrl,d="?";return"POST"==a.method?(0!=b.parameters.length&&(c+=d+b.parameters.join("&"),d="&"),a.clone().text().then(function(a){var b;return null!==a&&void 0!==a&&""!=a&&(b=a,c+=d+a),{urlNewFull:c,formDataText:b}}).catch(function(){return{urlNewFull:c,formDataText:void 0}})):Promise.resolve({urlNewFull:c,formDataText:void 0})},e=function(a,b){return requestsCacheFilter.find(function(c){var d=!0,e=!0,f=!0;if(""!=c.cacheIfUrlMatch&&(c.cacheIfUrlMatch=urlAddBaseLocation(c.cacheIfUrlMatch),d=a.startsWith(c.cacheIfUrlMatch)),""!=c.method&&(e=b==c.method),0<c.cacheIfParametersMatch.length){var g=extractUrlParameters(a).parameters.map(function(a){return a.toLowerCase()});f=c.cacheIfParametersMatch.every(function(a){return g.includes(a[0]+"="+a[1])})}return d&&e&&f})},f=function(a){if(a.isCustomCaching){var b=a.cloneRequest();return new Request(a.urlNewToCache,{method:"GET",headers:b.headers,body:b.body,mode:"same-origin",credentials:b.credentials,cache:b.cache,redirect:b.redirect,referrer:b.referrer,integrity:b.integrity})}return a.cloneRequest()},g=function(){if(!a.clientId)return Promise.reject();var b=new URL(a.request.url);return clients.get(a.clientId).then(function(a){var c=new URL(a.url);return b.pathname.endsWith("/php/stamp.php")&&b.searchParams.get("file")==c.searchParams.get("name")+".js"?Promise.resolve():Promise.reject()})},h=function(b,c){return caches.match(f(b),{ignoreSearch:c&&!b.isCustomCaching}).then(function(c){return c?(sendMessageToClient(a,{msg:"Responded with cache:",url:b.originalRequest.url,urlCached:b.urlNewToCache}),c):Promise.reject()})},i=function(a){return g().then(function(){return h(a,!0)}).catch(function(){return h(a,!1)})},j=function(b){return fetch(b.cloneRequest()).then(function(c){if(200==c.status&&"basic"==c.type)if(b.isCustomCaching)caches.open(CACHE_NAME_DYNAMIC).then(function(d){d.put(f(b),c.clone()),sendMessageToClient(a,{msg:"Cached resource:",url:b.originalRequest.url,urlCached:b.urlNewToCache})});else if(CacheMode.CacheStaticContent){var d=new URL(b.originalRequest.url);Promise.all(dynamicResourcesExtensions.map(function(a){return d.pathname.endsWith(a)?g().then(function(){return caches.open(CACHE_NAME).then(function(a){return a.delete(self.registration.scope+"php/stamp.php",{ignoreSearch:!0}).then(function(){return a.delete(self.registration.scope+d.searchParams.get("file"),{ignoreSearch:!0})})})}):Promise.resolve()})).then(function(){caches.open(CACHE_NAME).then(function(d){d.put(b.cloneRequest(),c.clone()),sendMessageToClient(a,{msg:"Cached resource:",url:b.originalRequest.url,urlCached:b.originalRequest.url})})}).catch(function(){return null})}return c.clone()})};const{request:k,request:{url:l,method:m}}=a;l.match(SHARED_DATA_ENDPOINT)?a.respondWith(caches.open(SHARED_DATA_ENDPOINT).then(a=>"POST"==m?k.text().then(b=>(a.put(SHARED_DATA_ENDPOINT,new Response(b)),new Response("OK"))):a.match(SHARED_DATA_ENDPOINT).then(a=>a||new Response(""))||new Response(""))):a.respondWith(function(a){return d(a).then(function(b){var c=e(b.urlNewFull,a.method),d=b.urlNewFull;return void 0!==c&&(d=filterUrlParameters(b.urlNewFull,c.ignoreParameterKeysOnCache)),{urlNewFull:b.urlNewFull,urlNewToCache:d,isCustomCaching:void 0!==c,customCacheFilter:c,formDataText:b.formDataText,originalRequest:a,cloneRequest:function(){return a.clone()}}}).then(function(a){return a.originalRequest.headers.get("range")?c(a):b(a)})}(a.request))});var cleanServiceWorkerCache=function(){return caches.delete(rangeResourceCache),console.log("cache cleared",rangeResourceCache),caches.keys().then(function(a){return Promise.all(a.map(function(a){if(CACHE_NAME!=a)return console.log("cache cleared",a),caches.delete(a)}))})};self.addEventListener("activate",function(a){cleanServiceWorkerCache(),a.waitUntil(clients.claim())}),self.addEventListener("message",function(a){var b=function(b){0<a.ports.length?a.ports[0].postMessage(b):console.error("Failed to respond!")},c=function(a){a.then(function(){b({status:"OK"})}).catch(function(){b({status:"Failed"})})},d=function(b,c){var d=new Request(b);return fetch(d).then(function(d){if(200==d.status&&"basic"==d.type){var e=new Request(filterUrlParameters(b,c));caches.open(CACHE_NAME_DYNAMIC).then(function(c){c.put(e,d.clone()),sendMessageToClient(a,{msg:"Cached resource:",url:b,urlCached:e.url})})}return!0}).catch(function(){return!1})};"get_cache_version"==a.data.action?b({cache_version:SW_CACHE_VERSION}):0<a.data.action.indexOf("_cache_resources")?c(caches.open(CACHE_NAME).then(function(b){return Promise.all(a.data.urls.map(function(c){if("add_cache_resources"==a.data.action)return b.add(c);return"remove_cache_resources"==a.data.action?b.delete(c):void 0}))})):"get_cache_storage_names"==a.data.action?caches.keys().then(function(a){b({names:a})}):"remove_cache_storage"==a.data.action?c(caches.delete(a.data.action.name)):"clean_cache_storage"==a.data.action?c(cleanServiceWorkerCache()):"requests_cache_filter"==a.data.action?(!requestsCacheFilter.includes(a.data.data)&&requestsCacheFilter.push(a.data.data),b({status:"OK"})):"load_and_cache_urls"==a.data.action?c(Promise.all(a.data.data.urls.map(function(b){return d(b,a.data.data.ignoreParameterKeysOnCache)}))):"check_urls_in_cache"==a.data.action&&function(a){return Promise.all(a.map(function(a){return caches.match(urlAddBaseLocation(a),{ignoreSearch:!1}).then(function(b){return b?a:""}).catch(function(){return""})})).then(function(a){return a.filter(function(a){return""!=a})}).then(function(a){return{urls:a,status:"OK"}}).catch(function(){return{urls:[],status:"Failed"}})}(a.data.data.urls).then(b)});