var SERVICE_WORKER_VERSION=27,INDEXED_DB_NAME="serviceWorkerDb",INDEXED_DB_VERSION=1,CACHE_NAME="flow-cache",CACHE_NAME_DYNAMIC="flow-dynamic-cache",rangeResourceCache="flow-range-cache",SHARED_DATA_ENDPOINT="share/pwa/data.php",LAST_FAILED_COUNT_LIMIT=5,LAST_SUCCESS_COUNT_BACK=3,dynamicResourcesExtensions=[".php",".serverbc",".html",".js"],cacheMode={PreferCachedResources:!1,CacheStaticResources:!0,UseOnlyCacheInOffline:!1},requestsSkipOnFetch=[],requestsCacheFilterSimple=[],requestsCacheFilterExternal=[],requestsCount={fromNetwork:0,fromCache:0,skipped:0,failed:0,lastStatus:"",lastFailedCount:0,lastNetworkCount:0},isOnline=!0,swIndexedDb={allStatuses:{None:0,Ready:1,Starting:2,Closed:3},status:0,db:null,showNotifications:!0,isReady:function(){return this.status==this.allStatuses.Ready&&null!=this.db},isNeedInit:function(){return this.status==this.allStatuses.None},isStarting:function(){return this.status==this.allStatuses.Starting},isNone:function(){return this.status==this.allStatuses.None},initDb:function(e){return null!=e?(this.db=e,this.status=this.allStatuses.Ready,this.showNotifications&&console.log("ServiceWorker: IndexedDB started successfully."),!0):(this.db=null,this.status=this.allStatuses.None,this.showNotifications&&console.log("ServiceWorker: Something went wrong. IndexedDB was not started."),!1)},closeDb:function(e){return this.db=null,this.status=this.allStatuses.Closed,alert("A new version of component installed. Please, reload this page."),this.showNotifications&&console.log("ServiceWorker: IndexedDB was closed to apply new version."),!0},startingDb:function(e){return this.db=null,this.status=this.allStatuses.Starting,this.showNotifications&&console.log("ServiceWorker: IndexedDB starting..."),!0},failInitDb:function(e){return this.db=null,this.status=this.allStatuses.None,this.showNotifications&&console.log("ServiceWorker: IndexedDB was not started:",e),!0},showSwNotification:function(e){this.showNotifications&&console.log("ServiceWorker: "+e)}},timerId=null,requestsTimings=[];function swIndexedDbInitialize(){return swIndexedDb.isNeedInit()?swIndexedDbInitPromise():new Promise(swIndexedDb.isStarting()?function(e,t){swIndexedDbWhaitWhileStarting(function(){swIndexedDb.isReady()?e(swIndexedDb.db):t()})}:function(e,t){e(swIndexedDb.db)})}function swIndexedDbWhaitWhileStarting(e){swIndexedDb.isStarting()?setTimeout(function(){swIndexedDbWhaitWhileStarting(e)},100):e()}function swIndexedDbInitPromise(){return new Promise(function(e,t){var r=indexedDB.open(INDEXED_DB_NAME,INDEXED_DB_VERSION),n=!1;swIndexedDb.startingDb(),r.onupgradeneeded=function(r){swIndexedDb.showSwNotification("New version of IndexedDB detected.");var a=r.target.result;if(!a.objectStoreNames.contains("serviceWorkerVars")){swIndexedDb.showSwNotification("Creation of new tables."),a.createObjectStore("serviceWorkerVars",{keyPath:"varName"});let s=r.target.transaction.objectStore("serviceWorkerVars");try{swIndexedDb.showSwNotification("Adding data 1..."),s.add({varName:"dynamicResourcesExtensions",value:[".php",".serverbc",".html",".js"]}),swIndexedDb.showSwNotification("Adding data 2..."),s.add({varName:"cacheMode",value:{PreferCachedResources:!1,CacheStaticResources:!0,UseOnlyCacheInOffline:!1}}),swIndexedDb.showSwNotification("Adding data 3..."),s.add({varName:"requestsSkipOnFetch",value:[]}),swIndexedDb.showSwNotification("Adding data 4..."),s.add({varName:"requestsCacheFilterSimple",value:[]}),swIndexedDb.showSwNotification("Adding data 5..."),swIndexedDb.showSwNotification("IndexedDB has been updated."),n||(n=!0,e(a))}catch(i){swIndexedDb.failInitDb(i.message),n||(n=!0,t(i.message))}}},r.onsuccess=function(a){var s=a.target.result;swIndexedDb.db=s;let i=r.result.transaction(["serviceWorkerVars"]).objectStore("serviceWorkerVars");try{Promise.all([swIndexedDbGetVarPromise(i,"dynamicResourcesExtensions",e=>(dynamicResourcesExtensions=e,1)),swIndexedDbGetVarPromise(i,"cacheMode",e=>(cacheMode=e,1)),swIndexedDbGetVarPromise(i,"requestsSkipOnFetch",e=>(requestsSkipOnFetch=e,1)),swIndexedDbGetVarPromise(i,"requestsCacheFilterSimple",e=>(requestsCacheFilterSimple=e,1))]).then(e=>{swIndexedDb.initDb(s)},e=>{swIndexedDb.failInitDb(e)})}catch(o){swIndexedDb.failInitDb(o.message),n||(n=!0,t(o.message))}s.onversionchange=function(){s.close(),swIndexedDb.closeDb()},n||(n=!0,e(s))},r.onerror=function(e){swIndexedDb.failInitDb(e.target.error),n||(n=!0,t(e.target.error))}})}function swIndexedDbGetVarPromise(e,t,r){return new Promise(function(n,a){let s=!1,i=e.get(t);i.onsuccess=function(e){s||(s=!0,r(e.target.result.value),n(e.target.result.value))},i.onerror=function(e){s||(s=!0,a(e.target.error))}})}function swIndexedDbSetVarPromise(e,t){return swIndexedDbInitialize().then(r=>{let n=r.transaction(["serviceWorkerVars"],"readwrite").objectStore("serviceWorkerVars");return new Promise(function(r,a){let s=!1,i=n.put({varName:e,value:t});i.onsuccess=function(e){s||(s=!0,r())},i.onerror=function(e){s||(s=!0,a(e.target.error))}})})}function checkOnlineStatus(){!1===(cacheMode.UseOnlyCacheInOffline?navigator.onLine&&requestsCount.lastFailedCount<LAST_FAILED_COUNT_LIMIT:navigator.onLine)?(isOnline&&console.info("Application switched to OFFLINE mode."),isOnline=!1,navigator.onLine&&null==timerId&&(timerId=setInterval(ping_inner,3e4))):(isOnline||console.info("Application returned back to ONLINE mode."),isOnline=!0,null!=timerId&&clearInterval(timerId),timerId=null)}function ping_inner(){let e=new Request(urlAddBaseLocation("./images/splash/splash_innovation_trans.png"),{method:"POST",body:'{"t": '+new Date().getTime()+', "r":"ping"}'});fetch(e).then(function(e){200==e.status&&"basic"==e.type?(addRequestStatus("fromNetwork"),requestsCount.lastFailedCount=0,requestsCount.lastNetworkCount=1,null!=timerId&&clearInterval(timerId),timerId=null):addRequestStatus("failed")}).catch(function(){addRequestStatus("failed")})}function addRequestStatus(e){var t=requestsCount.lastFailedCount,r=requestsCount.lastNetworkCount;switch(e){case"fromNetwork":requestsCount.fromNetwork++,t=0,requestsCount.lastStatus==e&&r++,r>=LAST_SUCCESS_COUNT_BACK&&(t=0);break;case"fromCache":requestsCount.fromCache++;break;case"skipped":requestsCount.skipped++;break;case"failed":requestsCount.failed++,(requestsCount.lastStatus==e||"fromCache"==requestsCount.lastStatus&&!cacheMode.PreferCachedResources)&&t++,t>=LAST_FAILED_COUNT_LIMIT&&(r=0)}requestsCount.lastStatus=e,requestsCount.lastFailedCount=t,requestsCount.lastNetworkCount=r}function resetRequestsCount(){requestsCount.fromNetwork=0,requestsCount.fromCache=0,requestsCount.skipped=0,requestsCount.failed=0,requestsCount.lastStatus="",requestsCount.lastFailedCount=0}function initializeCacheStorage(){return caches.open(CACHE_NAME).then(function(e){return console.log("Opened cache"),Promise.resolve()})}function isEmpty(e){return null==e||"string"==typeof e&&""==e||Array.isArray(e)&&0==e.length||"object"==typeof e&&0==Object.keys(e).length}var urlAddBaseLocation=function(e){var t=self.location.href,r=t.lastIndexOf("/");return -1!=r&&(t=t.substr(0,r+1)),e.startsWith("./")&&(e=t+e.substr(1,e.length-1)),e.replace(/(^|[^:])[/]{2,}/,"$1/",e)},extractUrlParameters=function(e){var t=e.split("?");if(!(t.length>1))return{baseUrl:e,parameters:[]};var r=t.slice(1).join("&").split("&");return 1!=r.length||r[0].includes("=")||(r[0]="single_parameter_key="+r[0],r.push("special_case_key=special_case_value")),{baseUrl:t[0],parameters:r}},filterUrlParameters=function(e,t){var r=extractUrlParameters(e);return 0==r.parameters.length?e:r.baseUrl+"?"+r.parameters.filter(function(e){var r=(e=e.toLowerCase()).indexOf("=");return -1!==r&&(e=e.substr(0,r)),!t.includes(e)}).join("&")},sendMessageToClient=function(e,t){e.clientId&&setTimeout(function(){clients.get(e.clientId).then(function(e){isEmpty(e)||e.postMessage(t)})},5)},cleanServiceWorkerCache=function(){return caches.delete(rangeResourceCache),console.log("cache cleared",rangeResourceCache),caches.keys().then(function(e){return Promise.all(e.map(function(e){if(!(SHARED_DATA_ENDPOINT==e||CACHE_NAME==e&&22!=SERVICE_WORKER_VERSION))return console.log("cache cleared",e),caches.delete(e)}))})},moveJwtToHeaders=function(e){if(isEmpty(e.url))return Promise.resolve(e);var t=e.clone(),r=function(e){var t=extractUrlParameters(e),r="";return t.parameters=t.parameters.filter(function(e){var t=e.split("=");return 2!=t.length||"jwt"!=t[0]||(r=t[1],!1)}),{parameters:t.parameters,baseUrl:t.baseUrl,jwt:r}},n=function(e){var r=new Headers;return t.headers.forEach(function(e,t){r.set(t,e)}),r.append("Authorization","Bearer "+e),r};if("POST"==t.method)return t.text().then(function(a){if(isEmpty(a)||!a.includes("jwt="))return Promise.resolve(e);var s=r("anyhost.com?"+a);return""==s.jwt?Promise.resolve(e):Promise.resolve(new Request(t.url,{method:t.method,headers:n(s.jwt),body:s.parameters.join("&"),mode:"same-origin",credentials:t.credentials,cache:t.cache,redirect:t.redirect,referrer:t.referrer,integrity:t.integrity}))}).catch(function(){return Promise.resolve(e)});var a=r(t.url);return""==a.jwt?Promise.resolve(e):Promise.resolve(new Request(a.baseUrl+"?"+a.parameters.join("&"),{method:t.method,headers:n(a.jwt),mode:"same-origin",credentials:t.credentials,cache:t.cache,redirect:t.redirect,referrer:t.referrer,integrity:t.integrity}))},createRequestTimingsVar=function(){var e=Date.now();return{startTimestamp:e,lastTime:e,duration:-1,steps:[]}};self.addEventListener("install",function(e){self.skipWaiting(),e.waitUntil(initializeCacheStorage())}),self.addEventListener("activate",function(e){cleanServiceWorkerCache(),e.waitUntil(Promise.all([clients.claim(),swIndexedDbInitialize()]))}),self.addEventListener("fetch",function(e){swIndexedDbInitialize();var t=createRequestTimingsVar();function r(e){var r=Date.now()-t.lastTime;t.steps.push({name:e,time:r}),t.lastTime=Date.now()}var n=function(e){if(!("POST"==e.method&&e.headers.has("Content-Type")))return!1;var t=e.headers.get("Content-Type").toLowerCase(),r=e.headers.get("Content-Length");return t.includes("multipart/form-data")&&t.includes("boundary=")||r>1e4},a=function(e){var t,r=(t=new URL(e).pathname.split("/").pop().split(".")).length>1?t.pop():"";return cacheMode.CacheStaticResources&&!isEmpty(r)&&!dynamicResourcesExtensions.includes("."+r)},s=function(e){var t,r=(t=new URL(S.url).pathname.split("/").pop().split(".")).length>1?t.pop():"",n=t.length>0?t.pop():"",a=!isEmpty(r)&&!isEmpty(n)&&("stamp.php"==n+"."+r||"flowjs.html"==n+"."+r);return a&&(resetRequestsCount(),requestsTimings=[]),a},i=function(e,r){t.name=e.split("\\").pop().split("/").pop(),t.operation=r.map(function(e){var t=(p2=e.toLowerCase()).indexOf("=");return -1!==t&&"operation"==p2.substr(0,t)?e.substr(t+1):""}).filter(function(e){return""!=e})},o=function(e,t,r){e=e.toLowerCase(),t=t.toLowerCase();var n=extractUrlParameters(e).parameters,a=u(e,t,n,r);return(isEmpty(a)||!(a.length>0)||isEmpty(a[0]))&&(a=c(e,t,n,r),isEmpty(a)||!(a.length>0)||isEmpty(a[0]))?void 0:a[0]},u=function(e,t,r,n){return requestsCacheFilterExternal.map(function(a){return a.filters.map(function(s){return(""==s.url||e.startsWith(s.url.toLowerCase()))&&(methods=s.methods.map(function(e){if(""==e.method||e.method.toLowerCase()==t)return 0==e.parameters.length||n?[{method:e.method,parameters:[],ignoreKeys:[],isSimple:!1,name:a.name,onNewUrlString:e.onNewUrlStringDefault}]:e.parameters.filter(function(e){var t;return 0==e.keyValues.length||(t=e).keyValues.every(function(e){var t=(e.key+"="+e.value).toLowerCase();return -1!=r.findIndex(function(e){return t==e})})}).map(function(t){return{method:e.method,parameters:t.keyValues,ignoreKeys:t.ignoreKeys,isSimple:!1,name:a.name,onNewUrlString:t.onNewUrlString}})}).filter(function(e){return void 0!=e}).flat()).length>0?methods.map(function(e){return{url:s.url,method:e.method,parameters:e.parameters,ignoreKeys:e.ignoreKeys,isSimple:!1,name:e.name,onNewUrlString:e.onNewUrlString}}):void 0}).filter(function(e){return void 0!=e}).flat()}).filter(function(e){return void 0!=e}).flat()},c=function(e,t,r,n){return requestsCacheFilterSimple.map(function(a){return(""==a.url||e.startsWith(a.url))&&(methods=a.methods.map(function(e){if(""==e.method||e.method==t)return 0==e.parameters.length||n?[{method:e.method,parameters:[],ignoreKeys:[],isSimple:!0,name:""}]:e.parameters.filter(function(e){var t;return 0==e.keyValues.length||(t=e).keyValues.every(function(e){var t=e.key+"="+e.value;return -1!=r.findIndex(function(e){return t==e})})}).map(function(t){return{method:e.method,parameters:t.keyValues,ignoreKeys:t.ignoreKeys,isSimple:!0,name:""}})}).filter(function(e){return void 0!=e}).flat()).length>0?methods.map(function(e){return{url:a.url,method:e.method,parameters:e.parameters,ignoreKeys:e.ignoreKeys,isSimple:!0,name:""}}):void 0}).filter(function(e){return void 0!=e}).flat()},d=function(e){if(e.isCustomCaching||e.urlNewToCache!=e.originalRequest.url){var t=e.cloneRequest();return new Request(e.urlNewToCache,{method:"GET",headers:t.headers,mode:"same-origin",credentials:t.credentials,cache:t.cache,redirect:t.redirect,referrer:t.referrer,integrity:t.integrity})}if(!e.isAppMainRequest)return e.cloneRequest();var t=e.cloneRequest();return new Request(extractUrlParameters(e.urlNewToCache).baseUrl,{method:"GET",headers:t.headers,mode:"same-origin",credentials:t.credentials,cache:t.cache,redirect:t.redirect,referrer:t.referrer,integrity:t.integrity})},l=function(e,t){var r=e.cloneRequest(),n=new Headers;return(r.headers.forEach(function(e,t){n.set(t,e)}),n.set("If-None-Match",t),n.set("X-If-None-Match",t),"POST"==r.method)?r.blob().then(function(e){return new Request(r.url,{method:r.method,headers:n,body:e,mode:"same-origin",credentials:r.credentials,cache:r.cache,redirect:r.redirect,referrer:r.referrer,integrity:r.integrity})}).catch(function(){return new Request(r.url,{method:r.method,headers:n,mode:"same-origin",credentials:r.credentials,cache:r.cache,redirect:r.redirect,referrer:r.referrer,integrity:r.integrity})}):Promise.resolve(new Request(r.url,{method:r.method,headers:n,mode:"same-origin",credentials:r.credentials,cache:r.cache,redirect:r.redirect,referrer:r.referrer,integrity:r.integrity}))},h=function(e,t){var r=e.clone();return r.blob().then(e=>{var n=new Headers;return r.headers.forEach(function(e,t){n.set(t,e)}),t.forEach(function(e,t){n.set(t,e)}),new Response(e,{ok:r.ok,redirected:r.redirected,status:r.status,statusText:r.statusText,headers:n,type:r.type,url:r.url})})},m=function(e){var t=new URL(e);return p().then(function(){return caches.open(CACHE_NAME).then(function(e){return e.delete(self.registration.scope+"php/stamp.php",{ignoreSearch:!0}).then(function(){return e.delete(self.registration.scope+t.searchParams.get("file"),{ignoreSearch:!0})})})}).catch(function(){return null})},f=function(t){if(!e.clientId)return!1;var r=new URL(t);return r.pathname.endsWith("/php/stamp.php")&&!isEmpty(r.searchParams.get("file"))},p=function(){return e.clientId?(new URL(e.request.url),clients.get(e.clientId).then(function(e){return(new URL(e.url),f(e.url))?(r("isStampForApplicationJsRequest"),Promise.resolve()):(r("isStampForApplicationJsRequest"),Promise.reject())})):Promise.reject()};function g(t,n){return t.isFileUploading?(r("getResourceFromCache skip"),Promise.reject()):caches.match(d(t),{ignoreSearch:n&&!t.isCustomCaching}).then(function(n){return(r("getResourceFromCache match"),n)?(addRequestStatus("fromCache"),sendMessageToClient(e,{msg:"Responded with cache:",url:t.originalRequest.url,urlCached:t.urlNewToCache}),n.clone()):Promise.reject()})}function w(e){return p().then(function(){return g(e,!0)}).catch(function(){return g(e,!1)})}function C(t,n){var a=function(n){var a=d(t);(t.isCustomCaching||t.isStaticCaching||t.isAppMainRequest)&&caches.open(t.usedCacheName).then(function(s){s.put(a,n.clone()),sendMessageToClient(e,{msg:"Cached resource:",url:t.originalRequest.url,urlCached:a.url}),r("cache put")})},s=function(){return moveJwtToHeaders(t.cloneRequest()).then(function(e){return r("moveJwtToHeaders"),fetch(e)}).then(function(e){return r("fetch"+(e.redirected?"+redirection":"")),200==e.status&&"basic"==e.type&&(f(t.originalRequest.url)&&m(t.originalRequest.url),a(e)),addRequestStatus("fromNetwork"),e.clone()}).catch(function(){return addRequestStatus("failed"),checkOnlineStatus(),Promise.reject()})},i=function(e){var n=e.headers.get("etag");return isEmpty(n)?s():(n.endsWith("-gzip")?n=n.substring(0,n.length-5):n.endsWith('-gzip"')&&(n=n.substring(0,n.length-6)+'"'),r("checked cache-control"),l(t,n).then(function(t){return r("createIfNoneMatchRequest"),moveJwtToHeaders(t).then(function(e){return r("moveJwtToHeaders"),fetch(e)}).then(function(t){return(r("fetch"+(t.redirected?"+redirection":"")),200==t.status&&"basic"==t.type)?(a(t),t.clone()):304==t.status&&"basic"==t.type?h(e,t.headers).then(e=>(r("updateHeadersInResponse"),a(e),e.clone())).catch(function(){return e.clone()}):t.clone()})}).catch(s))};return t.isFileUploading?fetch(t.cloneRequest()).then(function(e){return r("fetch"+(e.redirected?"+redirection":"")),addRequestStatus("fromNetwork"),e.clone()}):n?w(t).then(function(e){var t=e.headers.get("cache-control");if(isEmpty(t))return i(e);var r=t.split(", "),n=r.find(function(e){return"no-cache"==e}),a=r.find(function(e){return"must-revalidate"==e}),o=r.find(function(e){return e.startsWith("max-age=")}),u=e.headers.get("date");return isEmpty(n)?isEmpty(o)?i(e):isEmpty(u)?i(e):2!=(o=o.split("=")).length||isNaN(parseInt(o[1]))?i(e):((u=new Date(u)).setSeconds(u.getSeconds()+parseInt(o[1])),u>=new Date)?e.clone():isEmpty(a)?s():i(e):i(e)}).catch(s):s()}let{request:S,request:{url:v,method:y}}=e;if(checkOnlineStatus(),e.request.url.startsWith("http")){if(v.match(SHARED_DATA_ENDPOINT))e.respondWith(caches.open(SHARED_DATA_ENDPOINT).then(e=>"POST"==y?S.json().then(t=>(e.put(SHARED_DATA_ENDPOINT+"/"+t.key,new Response(t.value)),new Response("OK"))):e.match(SHARED_DATA_ENDPOINT+"/"+new URL(S.url).searchParams.get("key")).then(e=>e||new Response(""))||new Response("")));else{t.lastTime=Date.now();var I,E,b,N,q,$,D,k,R,x,O,A,T,F,_,U=function(e){var t=urlAddBaseLocation(e.url),r=extractUrlParameters(t),u=CACHE_NAME,c=a(e.url);if(i(r.baseUrl,r.parameters),"GET"!=e.method)return null;var d=o(t,e.method,!1),l=r.baseUrl+(r.parameters.length>0?"?"+r.parameters.join("&"):"");return isEmpty(d)?c&&(l=filterUrlParameters(l,["special_case_key","single_parameter_key"])):d.isSimple?(l=filterUrlParameters(t,d.ignoreKeys),u=CACHE_NAME_DYNAMIC):(isEmpty(d.onNewUrlString)||(t=d.onNewUrlString(e,t)),l=filterUrlParameters(t,d.ignoreKeys),u="flow-"+d.name+"-cache"),{urlNewFull:t,urlNewToCache:l,isCustomCaching:!isEmpty(d),isStaticCaching:c,isAppMainRequest:s(e.url),customCacheFilter:d,originalRequest:e,isFileUploading:n(e),usedCacheName:u,cloneRequest:function(){return e.clone()}}}(e.request);if(r("createRequestDataGET"),R=e.request,x=U,O=R,A=urlAddBaseLocation(O.url).toLowerCase(),T=O.method.toLowerCase(),!isEmpty(requestsSkipOnFetch.find(function(e){return!!(isEmpty(e.url)||A.startsWith(e.url))&&!isEmpty(e.methods.find(function(e){return(!!isEmpty(e.method)||e.method==T)&&!isEmpty(e.headers.find(function(e){return isEmpty(e.key)||O.headers.has(e.key)&&O.headers.get(e.key)==e.value}))}))}))||n(R)||!isEmpty(R.headers.get("range"))&&!0===isOnline||!a(R.url)&&!s(R.url)&&(isEmpty(x)||!x.isCustomCaching)&&isEmpty((F=R,_=urlAddBaseLocation(F.url),o(_,F.method,!0)))&&!f(R.url)){r("checkRequestForSkipping"),addRequestStatus("skipped (rule)"),t.duration=Date.now()-t.startTimestamp,requestsTimings.push(t);return}r("checkRequestForSkipping"),e.respondWith((D=e.request,(null!=(k=U)?Promise.resolve(k):(I=D,E=urlAddBaseLocation(I.url),b=extractUrlParameters(E),N=b.baseUrl,q="?",$=n(I),"POST"!=I.method?(i(b.baseUrl,b.parameters),Promise.resolve({urlNewFull:E,isFileUploading:$})):$?Promise.resolve({urlNewFull:E,isFileUploading:$}):(0!=b.parameters.length&&(N+=q+b.parameters.join("&"),q="&"),I.clone().text().then(function(e){return isEmpty(e)||(N+=q+e),i(b.baseUrl,extractUrlParameters(N).parameters),{urlNewFull:N,isFileUploading:$}}).catch(function(){return{urlNewFull:E,isFileUploading:$}}))).then(function(t){var r=o(t.urlNewFull,D.method,!1),n=t.urlNewFull,i=CACHE_NAME;return isEmpty(r)||(r.isSimple?(n=filterUrlParameters(n,r.ignoreKeys),i=CACHE_NAME_DYNAMIC):(isEmpty(r.onNewUrlString)||(n=r.onNewUrlString(D,n)),n=filterUrlParameters(n,r.ignoreKeys),i="flow-"+r.name+"-cache")),{urlNewFull:t.urlNewFull,urlNewToCache:n,isCustomCaching:!isEmpty(r),isStaticCaching:a(e.request.url),isAppMainRequest:s(D.url),customCacheFilter:r,originalRequest:D,isFileUploading:t.isFileUploading,usedCacheName:i,cloneRequest:function(){return D.clone()}}})).then(function(e){var n,a;return(r("makeResponse fn"),e.originalRequest.headers.get("range"))?(n=e,caches.match(n.urlNewToCache).then(function(e){return e||cacheMode.UseOnlyCacheInOffline&&!0!==isOnline?e:moveJwtToHeaders(n.originalRequest).then(function(e){return fetch(e)}).then(function(e){if(200!=e.status)return e;var t=e.clone();return caches.open(rangeResourceCache).then(function(e){return e.put(d(n),t)}).then(function(){return e})})}).then(function(e){return 200==e.status?e.arrayBuffer().then(function(t){var r=/^bytes\=(\d+)\-(\d+)?$/g.exec(n.originalRequest.headers.get("range"));if(!r)return new Response(null,{status:416,statusText:"Range Not Satisfiable",headers:[["Content-Range","*/"+t.byteLength]]});var a=Number(r[1]),s=Number(r[2])||t.byteLength-1;return new Response(t.slice(a,s+1),{status:206,statusText:"Partial Content",headers:[["Content-Type",e.headers.get("Content-Type")],["Content-Range","bytes "+a+"-"+s+"/"+t.byteLength]]})}):e})):(a=e,cacheMode.UseOnlyCacheInOffline&&!isOnline?w(a).catch(function(){return addRequestStatus("failed"),Promise.reject()}):cacheMode.PreferCachedResources?w(a).catch(function(){return C(a,!1)}):C(a,!0).catch(function(){return w(a).catch(function(){return addRequestStatus("failed"),Promise.reject()})})).then(function(e){return r("some last step"),t.duration=Date.now()-t.startTimestamp,requestsTimings.push(t),e})})))}}else{r("skipped (http)"),t.duration=Date.now()-t.startTimestamp,requestsTimings.push(t);return}}),self.addEventListener("message",function(e){swIndexedDbInitialize();var t,r=function(t){e.ports.length>0?e.ports[0].postMessage(t):console.error("ServiceWorker: Failed to respond!")},n=function(e){e.then(function(){r({status:"OK"})}).catch(function(){r({status:"Failed"})})},a=function(t,r){var n=new Request(urlAddBaseLocation(t));return moveJwtToHeaders(n).then(function(e){return fetch(e)}).then(function(a){if(200!=a.status||"basic"!=a.type)return!1;var s=new Request(filterUrlParameters(n.url,r.map(function(e){return e.toLowerCase()})));caches.open(CACHE_NAME_DYNAMIC).then(function(r){return r.put(s,a.clone()),sendMessageToClient(e,{msg:"Cached resource:",url:t,urlCached:s.url}),!0}).catch(function(){return!1})}).catch(function(){return!1})},s=function(e,t){return isEmpty(e)&&isEmpty(t)||e===t},i=function(e){return isEmpty(e)?"":e};if("add_dynamic_resource_extension"==e.data.action)e.data.data.value=(e.data.data.value.startsWith(".")?e.data.data.value.substr(1):e.data.data.value).toLowerCase(),dynamicResourcesExtensions.includes("."+e.data.data.value)||dynamicResourcesExtensions.push("."+e.data.data.value),swIndexedDbSetVarPromise("dynamicResourcesExtensions",dynamicResourcesExtensions),r({status:"OK"});else if("remove_dynamic_resource_extension"==e.data.action)e.data.data.value=(e.data.data.value.startsWith(".")?e.data.data.value.substr(1):e.data.data.value).toLowerCase(),dynamicResourcesExtensions.includes("."+e.data.data.value)&&(dynamicResourcesExtensions=dynamicResourcesExtensions.filter(t=>t!="."+e.data.data.value)),swIndexedDbSetVarPromise("dynamicResourcesExtensions",dynamicResourcesExtensions),r({status:"OK"});else if("set_prefer_cached_resources"==e.data.action)cacheMode.PreferCachedResources=e.data.data.value,swIndexedDbSetVarPromise("cacheMode",cacheMode),r({status:"OK"});else if("set_cache_static_resources"==e.data.action)cacheMode.CacheStaticResources=e.data.data.value,swIndexedDbSetVarPromise("cacheMode",cacheMode),r({status:"OK"});else if("get_cache_version"==e.data.action)r({cache_version:SW_CACHE_VERSION});else if(e.data.action.indexOf("_cache_resources")>0)n(caches.open(CACHE_NAME).then(function(t){return Promise.all(e.data.urls.map(function(r){return"add_cache_resources"==e.data.action?t.add(r):"remove_cache_resources"==e.data.action?t.delete(r):void 0}))}));else if("get_cache_storage_names"==e.data.action)caches.keys().then(function(e){r({names:e})});else if("remove_cache_storage"==e.data.action)n(caches.delete(e.data.action.name));else if("clean_cache_storage"==e.data.action)n(cleanServiceWorkerCache());else if("requests_cache_filter"==e.data.action){e.data.data.cacheIfUrlMatch=urlAddBaseLocation(e.data.data.cacheIfUrlMatch).toLowerCase(),e.data.data.method=e.data.data.method.toLowerCase(),e.data.data.ignoreParameterKeysOnCache=e.data.data.ignoreParameterKeysOnCache.map(function(e){return e.toLowerCase()});var o=requestsCacheFilterSimple.findIndex(function(t){return s(e.data.data.cacheIfUrlMatch,t.url)});-1==o&&(requestsCacheFilterSimple.push({url:i(e.data.data.cacheIfUrlMatch),methods:[]}),o=requestsCacheFilterSimple.length-1);var u=requestsCacheFilterSimple[o].methods.findIndex(function(t){return s(e.data.data.method,t.method)});-1==u&&(requestsCacheFilterSimple[o].methods.push({method:i(e.data.data.method),parameters:[]}),u=requestsCacheFilterSimple[o].methods.length-1);var c=requestsCacheFilterSimple[o].methods[u].parameters.findIndex(function(t){return t.keyValues.length==e.data.data.cacheIfParametersMatch.length&&e.data.data.cacheIfParametersMatch.every(function(e){return 2==e.length&&-1!=t.keyValues.findIndex(function(t){return s(t.key,e[0])&&s(t.value,e[1])})})});-1==c?requestsCacheFilterSimple[o].methods[u].parameters.push({keyValues:e.data.data.cacheIfParametersMatch.map(function(e){return{key:e[0],value:e[1]}}),ignoreKeys:e.data.data.ignoreParameterKeysOnCache}):requestsCacheFilterSimple[o].methods[u].parameters[c]={keyValues:e.data.data.cacheIfParametersMatch.map(function(e){return{key:e[0],value:e[1]}}),ignoreKeys:e.data.data.ignoreParameterKeysOnCache},swIndexedDbSetVarPromise("requestsCacheFilterSimple",requestsCacheFilterSimple),r({status:"OK"})}else if("requests_skip_filter"==e.data.action){e.data.data.url=urlAddBaseLocation(e.data.data.url).toLowerCase(),e.data.data.method=e.data.data.method.toLowerCase(),e.data.data.header=e.data.data.header.map(function(e){return e.toLowerCase()}),2==e.data.data.header.length?e.data.data.header={key:e.data.data.header[0],value:e.data.data.header[1]}:e.data.data.header={key:"",value:""};var o=requestsSkipOnFetch.findIndex(function(t){return s(e.data.data.url,t.url)});-1==o&&(requestsSkipOnFetch.push({url:i(e.data.data.url),methods:[]}),o=requestsSkipOnFetch.length-1);var u=requestsSkipOnFetch[o].methods.findIndex(function(t){return s(e.data.data.method,t.method)});-1==u&&(requestsSkipOnFetch[o].methods.push({method:i(e.data.data.method),headers:[]}),u=requestsSkipOnFetch[o].methods.length-1);var c=requestsSkipOnFetch[o].methods[u].headers.findIndex(function(t){return s(t.key,e.data.data.header.key)&&s(t.value,e.data.data.header.value)});-1==c&&requestsSkipOnFetch[o].methods[u].headers.push(e.data.data.header),swIndexedDbSetVarPromise("requestsSkipOnFetch",requestsSkipOnFetch),r({status:"OK"})}else"load_and_cache_urls"==e.data.action?n(Promise.all(e.data.data.urls.map(function(t){return a(t,e.data.data.ignoreParameterKeysOnCache)}))):"check_urls_in_cache"==e.data.action?Promise.all((t=e.data.data.urls).map(function(e){return caches.match(urlAddBaseLocation(e),{ignoreSearch:!1}).then(function(t){return t?e:""}).catch(function(){return""})})).then(function(e){return e.filter(function(e){return""!=e})}).then(function(e){return{urls:e,status:"OK"}}).catch(function(){return{urls:[],status:"Failed"}}).then(r):"get_service_worker_version"==e.data.action?r({data:SERVICE_WORKER_VERSION}):"set_use_cache_only_in_offline"==e.data.action?(cacheMode.UseOnlyCacheInOffline=e.data.enabled,swIndexedDbSetVarPromise("cacheMode",cacheMode),r({status:"OK"})):"get_requests_stats"==e.data.action?r({data:requestsCount}):"reset_timings"==e.data.action?(requestsTimings=[],r({status:"OK"})):"get_timings"==e.data.action?r({data:requestsTimings}):r({status:"Failed",error:"Unknown operation: "+e.data.action})}),swIndexedDbInitialize();