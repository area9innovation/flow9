var SERVICE_WORKER_VERSION=2,CACHE_NAME="flow-cache",CACHE_NAME_DYNAMIC="flow-dynamic-cache",rangeResourceCache="flow-range-cache",SHARED_DATA_ENDPOINT="share/pwa/data.php",dynamicResourcesExtensions=[".php",".serverbc"],CacheMode={PreferCachedResources:!1,CacheStaticContent:!0},requestsCacheFilter=[];function initializeCacheStorage(){return caches.open(CACHE_NAME).then(function(e){return console.log("Opened cache"),Promise.resolve()})}var urlAddBaseLocation=function(e){var t=self.location.href,n=t.lastIndexOf("/");return-1!=n&&(t=t.substr(0,n+1)),e.startsWith("./")&&(e=t+e.substr(1,e.length-1)),e.replace(/(^|[^:])[\/]{2,}/,"$1/",e)},extractUrlParameters=function(e){var t=e.split("?");return t.length>1?{baseUrl:t[0],parameters:t.slice(1).join("?").split("&")}:{baseUrl:e,parameters:[]}},filterUrlParameters=function(e,t){var n=extractUrlParameters(e);return 0==n.parameters.length?e:n.baseUrl+"?"+n.parameters.filter(function(e){var n=e.indexOf("=");return-1!==n&&(e=e.substr(0,n).toLowerCase()),!t.includes(e)}).join("&")},sendMessageToClient=function(e,t){e.clientId&&setTimeout(function(){clients.get(e.clientId).then(function(e){e.postMessage(t)})},5)};self.addEventListener("install",function(e){e.waitUntil(initializeCacheStorage())}),self.addEventListener("fetch",function(e){var t=function(e){if("POST"==e.method&&e.headers.has("Content-Type")){var t=e.headers.get("Content-Type").toLowerCase();return t.includes("multipart/form-data")&&t.includes("boundary=")}return!1},n=function(e){var n=urlAddBaseLocation(e.url),r=extractUrlParameters(n),a=r.baseUrl,c="?",s=t(e);return"POST"==e.method?s?Promise.resolve({urlNewFull:n,formDataText:void 0,isFileUploading:s}):(0!=r.parameters.length&&(a+=c+r.parameters.join("&"),c="&"),e.clone().text().then(function(e){var t=void 0;return null!=e&&""!=e&&(t=e,a+=c+e),{urlNewFull:a,formDataText:t,isFileUploading:s}}).catch(function(){return{urlNewFull:n,formDataText:void 0,isFileUploading:s}})):Promise.resolve({urlNewFull:n,formDataText:void 0,isFileUploading:s})},r=function(e,t){return requestsCacheFilter.find(function(n){var r=!0,a=!0,c=!0;if(""!=n.cacheIfUrlMatch&&(n.cacheIfUrlMatch=urlAddBaseLocation(n.cacheIfUrlMatch),r=e.startsWith(n.cacheIfUrlMatch)),""!=n.method&&(a=t==n.method),n.cacheIfParametersMatch.length>0){var s=extractUrlParameters(e).parameters.map(function(e){return e.toLowerCase()});c=n.cacheIfParametersMatch.every(function(e){return s.includes(e[0]+"="+e[1])})}return r&&a&&c})},a=function(e){if(e.isCustomCaching||e.urlNewToCache!=e.originalRequest.url){var t=e.cloneRequest();return new Request(e.urlNewToCache,{method:"GET",headers:t.headers,mode:"same-origin",credentials:t.credentials,cache:t.cache,redirect:t.redirect,referrer:t.referrer,integrity:t.integrity})}return e.cloneRequest()},c=function(){if(!e.clientId)return Promise.reject();var t=new URL(e.request.url);return clients.get(e.clientId).then(function(e){var n=new URL(e.url);return t.pathname.endsWith("/php/stamp.php")&&t.searchParams.get("file")==n.searchParams.get("name")+".js"?Promise.resolve():Promise.reject()})},s=function(t,n){return t.isFileUploading?Promise.reject():caches.match(a(t),{ignoreSearch:n&&!t.isCustomCaching}).then(function(n){return n?(sendMessageToClient(e,{msg:"Responded with cache:",url:t.originalRequest.url,urlCached:t.urlNewToCache}),n):Promise.reject()})},i=function(e){return c().then(function(){return s(e,!0)}).catch(function(){return s(e,!1)})},o=function(t){return t.isFileUploading?fetch(t.cloneRequest()).then(function(e){return e.clone()}).catch(function(){return null}):fetch(t.cloneRequest()).then(function(n){if(200==n.status&&"basic"==n.type)if(fixedRequest=a(t),t.isCustomCaching)caches.open(CACHE_NAME_DYNAMIC).then(function(r){r.put(fixedRequest,n.clone()),sendMessageToClient(e,{msg:"Cached resource:",url:t.originalRequest.url,urlCached:fixedRequest.url})});else if(CacheMode.CacheStaticContent){var r=new URL(t.originalRequest.url);Promise.all(dynamicResourcesExtensions.map(function(e){return r.pathname.endsWith(e)?c().then(function(){return caches.open(CACHE_NAME).then(function(e){return e.delete(self.registration.scope+"php/stamp.php",{ignoreSearch:!0}).then(function(){return e.delete(self.registration.scope+r.searchParams.get("file"),{ignoreSearch:!0})})})}):Promise.resolve()})).then(function(){caches.open(CACHE_NAME).then(function(r){r.put(fixedRequest,n.clone()),sendMessageToClient(e,{msg:"Cached resource:",url:t.originalRequest.url,urlCached:fixedRequest.url})})}).catch(function(){return null})}return n.clone()})};const{request:u,request:{url:l,method:h}}=e;if(l.match(SHARED_DATA_ENDPOINT))e.respondWith(caches.open(SHARED_DATA_ENDPOINT).then(e=>"POST"==h?u.json().then(t=>(e.put(SHARED_DATA_ENDPOINT+"/"+t.key,new Response(t.value)),new Response("OK"))):e.match(SHARED_DATA_ENDPOINT+"/"+new URL(u.url).searchParams.get("key")).then(e=>e||new Response(""))||new Response("")));else{if(t(u))return;e.respondWith(function(e){return n(e).then(function(t){var n=r(t.urlNewFull,e.method),a=t.urlNewFull;return void 0!==n&&(a=filterUrlParameters(t.urlNewFull,n.ignoreParameterKeysOnCache)),{urlNewFull:t.urlNewFull,urlNewToCache:a,isCustomCaching:void 0!==n,customCacheFilter:n,formDataText:t.formDataText,originalRequest:e,isFileUploading:t.isFileUploading,cloneRequest:function(){return e.clone()}}}).then(function(e){return e.originalRequest.headers.get("range")?function(e){return caches.open(rangeResourceCache).then(function(t){return t.match(e.fixedUrlToCache)}).then(function(t){return t||fetch(e.originalRequest).then(function(t){if(200==t.status){var n=t.clone();return caches.open(rangeResourceCache).then(function(t){return t.put(a(e),n)}).then(function(){return t})}return t})}).then(function(t){return 200==t.status?t.arrayBuffer().then(function(n){var r=/^bytes\=(\d+)\-(\d+)?$/g.exec(e.originalRequest.headers.get("range"));if(r){var a=Number(r[1]),c=Number(r[2])||n.byteLength-1;return new Response(n.slice(a,c+1),{status:206,statusText:"Partial Content",headers:[["Content-Type",t.headers.get("Content-Type")],["Content-Range","bytes "+a+"-"+c+"/"+n.byteLength]]})}return new Response(null,{status:416,statusText:"Range Not Satisfiable",headers:[["Content-Range","*/"+n.byteLength]]})}):t})}(e):function(e){return CacheMode.PreferCachedResources?i(e).catch(function(){return o(e)}):o(e).catch(function(){return i(e)})}(e)})}(e.request))}});var cleanServiceWorkerCache=function(){return caches.delete(rangeResourceCache),console.log("cache cleared",rangeResourceCache),caches.keys().then(function(e){return Promise.all(e.map(function(e){if(CACHE_NAME!=e&&SHARED_DATA_ENDPOINT!=e)return console.log("cache cleared",e),caches.delete(e)}))})};self.addEventListener("install",e=>{self.skipWaiting(),e.waitUntil(Promise.resolve())}),self.addEventListener("activate",function(e){cleanServiceWorkerCache(),e.waitUntil(clients.claim())}),self.addEventListener("message",function(e){var t,n=function(t){e.ports.length>0?e.ports[0].postMessage(t):console.error("Failed to respond!")},r=function(e){e.then(function(){n({status:"OK"})}).catch(function(){n({status:"Failed"})})};"get_cache_version"==e.data.action?n({cache_version:SW_CACHE_VERSION}):e.data.action.indexOf("_cache_resources")>0?r(caches.open(CACHE_NAME).then(function(t){return Promise.all(e.data.urls.map(function(n){return"add_cache_resources"==e.data.action?t.add(n):"remove_cache_resources"==e.data.action?t.delete(n):void 0}))})):"get_cache_storage_names"==e.data.action?caches.keys().then(function(e){n({names:e})}):"remove_cache_storage"==e.data.action?r(caches.delete(e.data.action.name)):"clean_cache_storage"==e.data.action?r(cleanServiceWorkerCache()):"requests_cache_filter"==e.data.action?(requestsCacheFilter.includes(e.data.data)||requestsCacheFilter.push(e.data.data),n({status:"OK"})):"load_and_cache_urls"==e.data.action?r(Promise.all(e.data.data.urls.map(function(t){return function(t,n){var r=new Request(urlAddBaseLocation(t));return fetch(r).then(function(a){if(200!=a.status||"basic"!=a.type)return!1;var c=new Request(filterUrlParameters(r.url,n));caches.open(CACHE_NAME_DYNAMIC).then(function(n){return n.put(c,a.clone()),sendMessageToClient(e,{msg:"Cached resource:",url:t,urlCached:c.url}),!0}).catch(function(){return!1})}).catch(function(){return!1})}(t,e.data.data.ignoreParameterKeysOnCache)}))):"check_urls_in_cache"==e.data.action?(t=e.data.data.urls,Promise.all(t.map(function(e){return caches.match(urlAddBaseLocation(e),{ignoreSearch:!1}).then(function(t){return t?e:""}).catch(function(){return""})})).then(function(e){return e.filter(function(e){return""!=e})}).then(function(e){return{urls:e,status:"OK"}}).catch(function(){return{urls:[],status:"Failed"}})).then(n):"get_service_worker_version"==e.data.action?n({data:SERVICE_WORKER_VERSION}):n({status:"Failed",error:"Unknown operation: "+e.data.action})});