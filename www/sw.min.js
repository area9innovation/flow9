var SERVICE_WORKER_VERSION=2,CACHE_NAME="flow-cache",CACHE_NAME_DYNAMIC="flow-dynamic-cache",rangeResourceCache="flow-range-cache",SHARED_DATA_ENDPOINT="share/pwa/data",dynamicResourcesExtensions=[".php",".serverbc"],CacheMode={PreferCachedResources:!1,CacheStaticContent:!0},requestsCacheFilter=[];function initializeCacheStorage(){return caches.open(CACHE_NAME).then(function(){return console.log("Opened cache"),Promise.resolve()})}var urlAddBaseLocation=function(a){var b=self.location.href,c=b.lastIndexOf("/");return-1!=c&&(b=b.substr(0,c+1)),a.startsWith("./")&&(a=b+a.substr(1,a.length-1)),a.replace(/(^|[^:])[/]{2,}/,"$1/",a)},extractUrlParameters=function(a){var b=a.split("?");return 1<b.length?{baseUrl:b[0],parameters:b.slice(1).join("?").split("&")}:{baseUrl:a,parameters:[]}},filterUrlParameters=function(a,b){var c=extractUrlParameters(a);return 0==c.parameters.length?a:c.baseUrl+"?"+c.parameters.filter(function(a){var c=a.indexOf("=");return-1!==c&&(a=a.substr(0,c).toLowerCase()),!b.includes(a)}).join("&")},sendMessageToClient=function(a,b){a.clientId&&setTimeout(function(){clients.get(a.clientId).then(function(a){a.postMessage(b)})},5)};self.addEventListener("install",function(a){a.waitUntil(initializeCacheStorage())}),self.addEventListener("fetch",function(a){function b(a){return CacheMode.PreferCachedResources?k(a).catch(function(){return l(a)}):l(a).catch(function(){return k(a)})}function c(a){return caches.open(rangeResourceCache).then(function(b){return b.match(a.fixedUrlToCache)}).then(function(b){return b?b:fetch(a.originalRequest).then(function(b){if(200==b.status){var c=b.clone();return caches.open(rangeResourceCache).then(function(b){return b.put(h(a),c)}).then(function(){return b})}return b})}).then(function(b){return 200==b.status?b.arrayBuffer().then(function(c){var d=/^bytes\=(\d+)\-(\d+)?$/g.exec(a.originalRequest.headers.get("range"));if(d){var e=+d[1],f=+d[2]||c.byteLength-1;return new Response(c.slice(e,f+1),{status:206,statusText:"Partial Content",headers:[["Content-Type",b.headers.get("Content-Type")],["Content-Range","bytes "+e+"-"+f+"/"+c.byteLength]]})}return new Response(null,{status:416,statusText:"Range Not Satisfiable",headers:[["Content-Range","*/"+c.byteLength]]})}):b})}function d(a){return f(a).then(function(b){var c=g(b.urlNewFull,a.method),d=b.urlNewFull;return void 0!==c&&(d=filterUrlParameters(b.urlNewFull,c.ignoreParameterKeysOnCache)),{urlNewFull:b.urlNewFull,urlNewToCache:d,isCustomCaching:void 0!==c,customCacheFilter:c,formDataText:b.formDataText,originalRequest:a,isFileUploading:b.isFileUploading,cloneRequest:function(){return a.clone()}}}).then(function(a){return a.originalRequest.headers.get("range")?c(a):b(a)})}var e=function(a){if("POST"==a.method&&a.headers.has("Content-Type")){var b=a.headers.get("Content-Type").toLowerCase();return b.includes("multipart/form-data")&&b.includes("boundary=")}return!1},f=function(a){var b=urlAddBaseLocation(a.url),c=extractUrlParameters(b),d=c.baseUrl,f="?",g=e(a);return"POST"==a.method?g?Promise.resolve({urlNewFull:b,formDataText:void 0,isFileUploading:g}):(0!=c.parameters.length&&(d+=f+c.parameters.join("&"),f="&"),a.clone().text().then(function(a){var b;return null!==a&&void 0!==a&&""!=a&&(b=a,d+=f+a),{urlNewFull:d,formDataText:b,isFileUploading:g}}).catch(function(){return{urlNewFull:b,formDataText:void 0,isFileUploading:g}})):Promise.resolve({urlNewFull:b,formDataText:void 0,isFileUploading:g})},g=function(a,b){return requestsCacheFilter.find(function(c){var d=!0,e=!0,f=!0;if(""!=c.cacheIfUrlMatch&&(c.cacheIfUrlMatch=urlAddBaseLocation(c.cacheIfUrlMatch),d=a.startsWith(c.cacheIfUrlMatch)),""!=c.method&&(e=b==c.method),0<c.cacheIfParametersMatch.length){var g=extractUrlParameters(a).parameters.map(function(a){return a.toLowerCase()});f=c.cacheIfParametersMatch.every(function(a){return g.includes(a[0]+"="+a[1])})}return d&&e&&f})},h=function(a){if(a.isCustomCaching||a.urlNewToCache!=a.originalRequest.url){var b=a.cloneRequest();return new Request(a.urlNewToCache,{method:"GET",headers:b.headers,mode:"same-origin",credentials:b.credentials,cache:b.cache,redirect:b.redirect,referrer:b.referrer,integrity:b.integrity})}return a.cloneRequest()},i=function(){if(!a.clientId)return Promise.reject();var b=new URL(a.request.url);return clients.get(a.clientId).then(function(a){var c=new URL(a.url);return b.pathname.endsWith("/php/stamp.php")&&b.searchParams.get("file")==c.searchParams.get("name")+".js"?Promise.resolve():Promise.reject()})},j=function(b,c){return b.isFileUploading?Promise.reject():caches.match(h(b),{ignoreSearch:c&&!b.isCustomCaching}).then(function(c){return c?(sendMessageToClient(a,{msg:"Responded with cache:",url:b.originalRequest.url,urlCached:b.urlNewToCache}),c):Promise.reject()})},k=function(a){return i().then(function(){return j(a,!0)}).catch(function(){return j(a,!1)})},l=function(b){return b.isFileUploading?fetch(b.cloneRequest()).then(function(a){return a.clone()}).catch(function(){return null}):fetch(b.cloneRequest()).then(function(c){if(200==c.status&&"basic"==c.type)if(fixedRequest=h(b),b.isCustomCaching)caches.open(CACHE_NAME_DYNAMIC).then(function(d){d.put(fixedRequest,c.clone()),sendMessageToClient(a,{msg:"Cached resource:",url:b.originalRequest.url,urlCached:fixedRequest.url})});else if(CacheMode.CacheStaticContent){var d=new URL(b.originalRequest.url);Promise.all(dynamicResourcesExtensions.map(function(a){return d.pathname.endsWith(a)?i().then(function(){return caches.open(CACHE_NAME).then(function(a){return a.delete(self.registration.scope+"php/stamp.php",{ignoreSearch:!0}).then(function(){return a.delete(self.registration.scope+d.searchParams.get("file"),{ignoreSearch:!0})})})}):Promise.resolve()})).then(function(){caches.open(CACHE_NAME).then(function(d){d.put(fixedRequest,c.clone()),sendMessageToClient(a,{msg:"Cached resource:",url:b.originalRequest.url,urlCached:fixedRequest.url})})}).catch(function(){return null})}return c.clone()})};const{request:m,request:{url:n,method:o}}=a;if(n.match(SHARED_DATA_ENDPOINT))a.respondWith(caches.open(SHARED_DATA_ENDPOINT).then(a=>"POST"==o?m.json().then(b=>(a.put(SHARED_DATA_ENDPOINT+"/"+b.key,new Response(b.value)),new Response("OK"))):a.match(SHARED_DATA_ENDPOINT+"/"+new URL(m.url).searchParams.get("key")).then(a=>a||new Response(""))||new Response("")));else{if(e(m))return;a.respondWith(d(a.request))}});var cleanServiceWorkerCache=function(){return caches.delete(rangeResourceCache),console.log("cache cleared",rangeResourceCache),caches.keys().then(function(a){return Promise.all(a.map(function(a){if(CACHE_NAME!=a&&SHARED_DATA_ENDPOINT!=a)return console.log("cache cleared",a),caches.delete(a)}))})};self.addEventListener("install",a=>{self.skipWaiting(),a.waitUntil(Promise.resolve())}),self.addEventListener("activate",function(a){cleanServiceWorkerCache(),a.waitUntil(clients.claim())}),self.addEventListener("message",function(a){var b=function(b){0<a.ports.length?a.ports[0].postMessage(b):console.error("Failed to respond!")},c=function(a){a.then(function(){b({status:"OK"})}).catch(function(){b({status:"Failed"})})},d=function(b,c){var d=new Request(urlAddBaseLocation(b));return fetch(d).then(function(e){if(200==e.status&&"basic"==e.type){var f=new Request(filterUrlParameters(d.url,c));caches.open(CACHE_NAME_DYNAMIC).then(function(c){return c.put(f,e.clone()),sendMessageToClient(a,{msg:"Cached resource:",url:b,urlCached:f.url}),!0}).catch(function(){return!1})}else return!1}).catch(function(){return!1})};"get_cache_version"==a.data.action?b({cache_version:SW_CACHE_VERSION}):0<a.data.action.indexOf("_cache_resources")?c(caches.open(CACHE_NAME).then(function(b){return Promise.all(a.data.urls.map(function(c){if("add_cache_resources"==a.data.action)return b.add(c);return"remove_cache_resources"==a.data.action?b.delete(c):void 0}))})):"get_cache_storage_names"==a.data.action?caches.keys().then(function(a){b({names:a})}):"remove_cache_storage"==a.data.action?c(caches.delete(a.data.action.name)):"clean_cache_storage"==a.data.action?c(cleanServiceWorkerCache()):"requests_cache_filter"==a.data.action?(!requestsCacheFilter.includes(a.data.data)&&requestsCacheFilter.push(a.data.data),b({status:"OK"})):"load_and_cache_urls"==a.data.action?c(Promise.all(a.data.data.urls.map(function(b){return d(b,a.data.data.ignoreParameterKeysOnCache)}))):"check_urls_in_cache"==a.data.action?function(a){return Promise.all(a.map(function(a){return caches.match(urlAddBaseLocation(a),{ignoreSearch:!1}).then(function(b){return b?a:""}).catch(function(){return""})})).then(function(a){return a.filter(function(a){return""!=a})}).then(function(a){return{urls:a,status:"OK"}}).catch(function(){return{urls:[],status:"Failed"}})}(a.data.data.urls).then(b):"get_service_worker_version"==a.data.action?b({data:SERVICE_WORKER_VERSION}):b({status:"Failed",error:"Unknown operation: "+a.data.action})});