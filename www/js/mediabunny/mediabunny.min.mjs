/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */
function p(n){if(!n)throw new Error("Assertion failed.")}var ut=n=>{let t=(n%360+360)%360;if(t===0||t===90||t===180||t===270)return t;throw new Error(`Invalid rotation ${n}.`)},H=n=>n&&n[n.length-1],Tt=n=>n>=0&&n<2**32,$=class n{constructor(t){this.bytes=t;this.pos=0}seekToByte(t){this.pos=8*t}readBit(){let t=Math.floor(this.pos/8),e=this.bytes[t]??0,r=7-(this.pos&7),i=(e&1<<r)>>r;return this.pos++,i}readBits(t){if(t===1)return this.readBit();let e=0;for(let r=0;r<t;r++)e<<=1,e|=this.readBit();return e}writeBits(t,e){let r=this.pos+t;for(let i=this.pos;i<r;i++){let a=Math.floor(i/8),o=this.bytes[a],s=7-(i&7);o&=~(1<<s),o|=(e&1<<r-i-1)>>r-i-1<<s,this.bytes[a]=o}this.pos=r}readAlignedByte(){if(this.pos%8!==0)throw new Error("Bitstream is not byte-aligned.");let t=this.pos/8,e=this.bytes[t]??0;return this.pos+=8,e}skipBits(t){this.pos+=t}getBitsLeft(){return this.bytes.length*8-this.pos}clone(){let t=new n(this.bytes);return t.pos=this.pos,t}},A=n=>{let t=0;for(;n.readBits(1)===0&&t<32;)t++;if(t>=32)throw new Error("Invalid exponential-Golomb code.");return(1<<t)-1+n.readBits(t)},Ft=n=>{let t=A(n);return(t&1)===0?-(t>>1):t+1>>1},Na=(n,t,e,r)=>{for(let i=t;i<e;i++){let a=Math.floor(i/8),o=n[a],s=7-(i&7);o&=~(1<<s),o|=(r&1<<e-i-1)>>e-i-1<<s,n[a]=o}},Q=n=>n instanceof Uint8Array?n:n instanceof ArrayBuffer?new Uint8Array(n):new Uint8Array(n.buffer,n.byteOffset,n.byteLength),V=n=>n instanceof DataView?n:n instanceof ArrayBuffer?new DataView(n):new DataView(n.buffer,n.byteOffset,n.byteLength),fe=new TextDecoder,K=new TextEncoder,dt=n=>{for(let t=0;t<n.length;t++)if(n.charCodeAt(t)>255)return!1;return!0},Pi=n=>Object.fromEntries(Object.entries(n).map(([t,e])=>[e,t])),$e={bt709:1,bt470bg:5,smpte170m:6,bt2020:9,smpte432:12},$r=Pi($e),Qe={bt709:1,smpte170m:6,linear:8,"iec61966-2-1":13,pg:16,hlg:18},Qr=Pi(Qe),Ge={rgb:0,bt709:1,bt470bg:5,smpte170m:6,"bt2020-ncl":9},Gr=Pi(Ge),Xr=n=>!!n&&!!n.primaries&&!!n.transfer&&!!n.matrix&&n.fullRange!==void 0,Mt=n=>n instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&n instanceof SharedArrayBuffer||ArrayBuffer.isView(n),ce=class{constructor(){this.currentPromise=Promise.resolve()}async acquire(){let t,e=new Promise(i=>{t=i}),r=this.currentPromise;return this.currentPromise=e,await r,t}},vi=n=>[...n].map(t=>t.toString(16).padStart(2,"0")).join(""),Ii=n=>(n=n>>1&1431655765|(n&1431655765)<<1,n=n>>2&858993459|(n&858993459)<<2,n=n>>4&252645135|(n&252645135)<<4,n=n>>8&16711935|(n&16711935)<<8,n=n>>16&65535|(n&65535)<<16,n>>>0),X=(n,t,e)=>{let r=0,i=n.length-1,a=-1;for(;r<=i;){let o=r+i>>1,s=e(n[o]);s===t?(a=o,i=o-1):s<t?r=o+1:i=o-1}return a},U=(n,t,e)=>{let r=0,i=n.length-1,a=-1;for(;r<=i;){let o=r+(i-r+1)/2|0;e(n[o])<=t?(a=o,r=o+1):i=o-1}return a},Ee=(n,t,e)=>{let r=U(n,e(t),e);n.splice(r+1,0,t)},q=()=>{let n,t;return{promise:new Promise((r,i)=>{n=r,t=i}),resolve:n,reject:t}};var Ei=(n,t)=>{for(let e=n.length-1;e>=0;e--)if(t(n[e]))return n[e]},Yr=(n,t)=>{for(let e=n.length-1;e>=0;e--)if(t(n[e]))return e;return-1},Wa=async function*(n){Symbol.iterator in n?yield*n[Symbol.iterator]():yield*n[Symbol.asyncIterator]()},La=n=>{if(!(Symbol.iterator in n)&&!(Symbol.asyncIterator in n))throw new TypeError("Argument must be an iterable or async iterable.")},Y=n=>{throw new Error(`Unexpected value: ${n}`)},_i=(n,t,e)=>{let r=n.getUint8(t),i=n.getUint8(t+1),a=n.getUint8(t+2);return e?r|i<<8|a<<16:r<<16|i<<8|a},Ha=(n,t,e)=>_i(n,t,e)<<8>>8,Ai=(n,t,e,r)=>{e=e>>>0,e=e&16777215,r?(n.setUint8(t,e&255),n.setUint8(t+1,e>>>8&255),n.setUint8(t+2,e>>>16&255)):(n.setUint8(t,e>>>16&255),n.setUint8(t+1,e>>>8&255),n.setUint8(t+2,e&255))},qa=(n,t,e,r)=>{e=ee(e,-8388608,8388607),e<0&&(e=e+16777216&16777215),Ai(n,t,e,r)},Ka=(n,t,e,r)=>{r?(n.setUint32(t+0,e,!0),n.setInt32(t+4,Math.floor(e/2**32),!0)):(n.setInt32(t+0,Math.floor(e/2**32),!0),n.setUint32(t+4,e,!0))},ur=(n,t)=>({async next(){let e=await n.next();return e.done?{value:void 0,done:!0}:{value:t(e.value),done:!1}},return(){return n.return()},throw(e){return n.throw(e)},[Symbol.asyncIterator](){return this}}),ee=(n,t,e)=>Math.max(t,Math.min(e,n)),te="und",wt=(n,t)=>{let e=10**t;return Math.round(n*e)/e},dr=(n,t)=>Math.round(n/t)*t,ja=n=>{let t=0;for(;n;)t++,n>>=1;return t},vo=/^[a-z]{3}$/,Xe=n=>vo.test(n),ze=1e6*(1+Number.EPSILON),Zr=(n,t)=>{let e={...n};for(let r in t)typeof n[r]=="object"&&n[r]!==null&&typeof t[r]=="object"&&t[r]!==null?e[r]=Zr(n[r],t[r]):e[r]=t[r];return e},Fi=async(n,t,e)=>{let r=0;for(;;)try{return await fetch(n,t)}catch(i){r++;let a=e(r);if(a===null)throw i;if(console.error("Retrying failed fetch. Error:",i),!Number.isFinite(a)||a<0)throw new TypeError("Retry delay must be a non-negative finite number.");a>0&&await new Promise(o=>setTimeout(o,1e3*a))}},$a=(n,t)=>{let e=n<0?-1:1;n=Math.abs(n);let r=0,i=1,a=1,o=0,s=n;for(;;){let c=Math.floor(s),u=c*a+r,d=c*o+i;if(d>t)return{numerator:e*a,denominator:o};if(r=a,i=o,a=u,o=d,s=1/(s-c),!isFinite(s))break}return{numerator:e*a,denominator:o}},ct=class{constructor(){this.currentPromise=Promise.resolve()}call(t){return this.currentPromise=this.currentPromise.then(t)}},Ci=null,Jr=()=>{if(Ci!==null)return Ci;let n=!!(typeof navigator<"u"&&navigator.vendor?.match(/apple/i)&&!navigator.userAgent?.match(/crios/i)&&!navigator.userAgent?.match(/fxios/i)&&!navigator.userAgent?.match(/Opera|OPT\//));return Ci=n,n},yt=(n,t)=>n!==-1?n:t,en=(n,t,e,r)=>n<=r&&e<=t,_e=function*(n){for(let t in n){let e=n[t];e!==void 0&&(yield{key:t,value:e})}},Qa=n=>{switch(n.toLowerCase()){case"image/jpeg":case"image/jpg":return".jpg";case"image/png":return".png";case"image/gif":return".gif";case"image/webp":return".webp";case"image/bmp":return".bmp";case"image/svg+xml":return".svg";case"image/tiff":return".tiff";case"image/avif":return".avif";case"image/x-icon":case"image/vnd.microsoft.icon":return".ico";default:return null}},Ga=n=>{let t=atob(n),e=new Uint8Array(t.length);for(let r=0;r<t.length;r++)e[r]=t.charCodeAt(r);return e},Xa=n=>{let t="";for(let e=0;e<n.length;e++)t+=String.fromCharCode(n[e]);return btoa(t)};var Pe=class{constructor(t,e){this.data=t;this.mimeType=e}},tn=n=>{if(!n||typeof n!="object")throw new TypeError("tags must be an object.");if(n.title!==void 0&&typeof n.title!="string")throw new TypeError("tags.title, when provided, must be a string.");if(n.description!==void 0&&typeof n.description!="string")throw new TypeError("tags.description, when provided, must be a string.");if(n.artist!==void 0&&typeof n.artist!="string")throw new TypeError("tags.artist, when provided, must be a string.");if(n.album!==void 0&&typeof n.album!="string")throw new TypeError("tags.album, when provided, must be a string.");if(n.albumArtist!==void 0&&typeof n.albumArtist!="string")throw new TypeError("tags.albumArtist, when provided, must be a string.");if(n.trackNumber!==void 0&&(!Number.isInteger(n.trackNumber)||n.trackNumber<=0))throw new TypeError("tags.trackNumber, when provided, must be a positive integer.");if(n.tracksTotal!==void 0&&(!Number.isInteger(n.tracksTotal)||n.tracksTotal<=0))throw new TypeError("tags.tracksTotal, when provided, must be a positive integer.");if(n.discNumber!==void 0&&(!Number.isInteger(n.discNumber)||n.discNumber<=0))throw new TypeError("tags.discNumber, when provided, must be a positive integer.");if(n.discsTotal!==void 0&&(!Number.isInteger(n.discsTotal)||n.discsTotal<=0))throw new TypeError("tags.discsTotal, when provided, must be a positive integer.");if(n.genre!==void 0&&typeof n.genre!="string")throw new TypeError("tags.genre, when provided, must be a string.");if(n.date!==void 0&&(!(n.date instanceof Date)||Number.isNaN(n.date.getTime())))throw new TypeError("tags.date, when provided, must be a valid Date.");if(n.lyrics!==void 0&&typeof n.lyrics!="string")throw new TypeError("tags.lyrics, when provided, must be a string.");if(n.images!==void 0){if(!Array.isArray(n.images))throw new TypeError("tags.images, when provided, must be an array.");for(let t of n.images){if(!t||typeof t!="object")throw new TypeError("Each image in tags.images must be an object.");if(!(t.data instanceof Uint8Array))throw new TypeError("Each image.data must be a Uint8Array.");if(typeof t.mimeType!="string")throw new TypeError("Each image.mimeType must be a string.");if(!["coverFront","coverBack","unknown"].includes(t.kind))throw new TypeError("Each image.kind must be 'coverFront', 'coverBack', or 'unknown'.")}}if(n.comment!==void 0&&typeof n.comment!="string")throw new TypeError("tags.comment, when provided, must be a string.");if(n.raw!==void 0){if(!n.raw||typeof n.raw!="object")throw new TypeError("tags.raw, when provided, must be an object.");for(let t of Object.values(n.raw))if(t!==null&&typeof t!="string"&&!(t instanceof Uint8Array)&&!(t instanceof Pe))throw new TypeError("Each value in tags.raw must be a string, Uint8Array, RichImageData, or null.")}},rn=n=>n.title===void 0&&n.description===void 0&&n.artist===void 0&&n.album===void 0&&n.albumArtist===void 0&&n.trackNumber===void 0&&n.tracksTotal===void 0&&n.discNumber===void 0&&n.discsTotal===void 0&&n.genre===void 0&&n.date===void 0&&n.lyrics===void 0&&(!n.images||n.images.length===0)&&n.comment===void 0&&(n.raw===void 0||Object.keys(n.raw).length===0);var re=["avc","hevc","vp9","av1","vp8"],j=["pcm-s16","pcm-s16be","pcm-s24","pcm-s24be","pcm-s32","pcm-s32be","pcm-f32","pcm-f32be","pcm-f64","pcm-f64be","pcm-u8","pcm-s8","ulaw","alaw"],Ze=["aac","opus","mp3","vorbis","flac"],ae=[...Ze,...j],ye=["webvtt"],Ya=[{maxMacroblocks:99,maxBitrate:64e3,level:10},{maxMacroblocks:396,maxBitrate:192e3,level:11},{maxMacroblocks:396,maxBitrate:384e3,level:12},{maxMacroblocks:396,maxBitrate:768e3,level:13},{maxMacroblocks:396,maxBitrate:2e6,level:20},{maxMacroblocks:792,maxBitrate:4e6,level:21},{maxMacroblocks:1620,maxBitrate:4e6,level:22},{maxMacroblocks:1620,maxBitrate:1e7,level:30},{maxMacroblocks:3600,maxBitrate:14e6,level:31},{maxMacroblocks:5120,maxBitrate:2e7,level:32},{maxMacroblocks:8192,maxBitrate:2e7,level:40},{maxMacroblocks:8192,maxBitrate:5e7,level:41},{maxMacroblocks:8704,maxBitrate:5e7,level:42},{maxMacroblocks:22080,maxBitrate:135e6,level:50},{maxMacroblocks:36864,maxBitrate:24e7,level:51},{maxMacroblocks:36864,maxBitrate:24e7,level:52},{maxMacroblocks:139264,maxBitrate:24e7,level:60},{maxMacroblocks:139264,maxBitrate:48e7,level:61},{maxMacroblocks:139264,maxBitrate:8e8,level:62}],Za=[{maxPictureSize:36864,maxBitrate:128e3,tier:"L",level:30},{maxPictureSize:122880,maxBitrate:15e5,tier:"L",level:60},{maxPictureSize:245760,maxBitrate:3e6,tier:"L",level:63},{maxPictureSize:552960,maxBitrate:6e6,tier:"L",level:90},{maxPictureSize:983040,maxBitrate:1e7,tier:"L",level:93},{maxPictureSize:2228224,maxBitrate:12e6,tier:"L",level:120},{maxPictureSize:2228224,maxBitrate:3e7,tier:"H",level:120},{maxPictureSize:2228224,maxBitrate:2e7,tier:"L",level:123},{maxPictureSize:2228224,maxBitrate:5e7,tier:"H",level:123},{maxPictureSize:8912896,maxBitrate:25e6,tier:"L",level:150},{maxPictureSize:8912896,maxBitrate:1e8,tier:"H",level:150},{maxPictureSize:8912896,maxBitrate:4e7,tier:"L",level:153},{maxPictureSize:8912896,maxBitrate:16e7,tier:"H",level:153},{maxPictureSize:8912896,maxBitrate:6e7,tier:"L",level:156},{maxPictureSize:8912896,maxBitrate:24e7,tier:"H",level:156},{maxPictureSize:35651584,maxBitrate:6e7,tier:"L",level:180},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:180},{maxPictureSize:35651584,maxBitrate:12e7,tier:"L",level:183},{maxPictureSize:35651584,maxBitrate:48e7,tier:"H",level:183},{maxPictureSize:35651584,maxBitrate:24e7,tier:"L",level:186},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:186}],Ye=[{maxPictureSize:36864,maxBitrate:2e5,level:10},{maxPictureSize:73728,maxBitrate:8e5,level:11},{maxPictureSize:122880,maxBitrate:18e5,level:20},{maxPictureSize:245760,maxBitrate:36e5,level:21},{maxPictureSize:552960,maxBitrate:72e5,level:30},{maxPictureSize:983040,maxBitrate:12e6,level:31},{maxPictureSize:2228224,maxBitrate:18e6,level:40},{maxPictureSize:2228224,maxBitrate:3e7,level:41},{maxPictureSize:8912896,maxBitrate:6e7,level:50},{maxPictureSize:8912896,maxBitrate:12e7,level:51},{maxPictureSize:8912896,maxBitrate:18e7,level:52},{maxPictureSize:35651584,maxBitrate:18e7,level:60},{maxPictureSize:35651584,maxBitrate:24e7,level:61},{maxPictureSize:35651584,maxBitrate:48e7,level:62}],Ja=[{maxPictureSize:147456,maxBitrate:15e5,tier:"M",level:0},{maxPictureSize:278784,maxBitrate:3e6,tier:"M",level:1},{maxPictureSize:665856,maxBitrate:6e6,tier:"M",level:4},{maxPictureSize:1065024,maxBitrate:1e7,tier:"M",level:5},{maxPictureSize:2359296,maxBitrate:12e6,tier:"M",level:8},{maxPictureSize:2359296,maxBitrate:3e7,tier:"H",level:8},{maxPictureSize:2359296,maxBitrate:2e7,tier:"M",level:9},{maxPictureSize:2359296,maxBitrate:5e7,tier:"H",level:9},{maxPictureSize:8912896,maxBitrate:3e7,tier:"M",level:12},{maxPictureSize:8912896,maxBitrate:1e8,tier:"H",level:12},{maxPictureSize:8912896,maxBitrate:4e7,tier:"M",level:13},{maxPictureSize:8912896,maxBitrate:16e7,tier:"H",level:13},{maxPictureSize:8912896,maxBitrate:6e7,tier:"M",level:14},{maxPictureSize:8912896,maxBitrate:24e7,tier:"H",level:14},{maxPictureSize:35651584,maxBitrate:6e7,tier:"M",level:15},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:15},{maxPictureSize:35651584,maxBitrate:6e7,tier:"M",level:16},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:16},{maxPictureSize:35651584,maxBitrate:1e8,tier:"M",level:17},{maxPictureSize:35651584,maxBitrate:48e7,tier:"H",level:17},{maxPictureSize:35651584,maxBitrate:16e7,tier:"M",level:18},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:18},{maxPictureSize:35651584,maxBitrate:16e7,tier:"M",level:19},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:19}],es=".01.01.01.01.00",ts=".0.110.01.01.01.0",rs=(n,t,e,r)=>{if(n==="avc"){let a=Math.ceil(t/16)*Math.ceil(e/16),o=Ya.find(l=>a<=l.maxMacroblocks&&r<=l.maxBitrate)??H(Ya),s=o?o.level:0,c="64".padStart(2,"0"),u="00",d=s.toString(16).padStart(2,"0");return`avc1.${c}${u}${d}`}else if(n==="hevc"){let i="",o="6",s=t*e,c=Za.find(d=>s<=d.maxPictureSize&&r<=d.maxBitrate)??H(Za);return`hev1.${i}1.${o}.${c.tier}${c.level}.B0`}else{if(n==="vp8")return"vp8";if(n==="vp9"){let i="00",a=t*e,o=Ye.find(c=>a<=c.maxPictureSize&&r<=c.maxBitrate)??H(Ye);return`vp09.${i}.${o.level.toString().padStart(2,"0")}.08`}else if(n==="av1"){let a=t*e,o=Ja.find(u=>a<=u.maxPictureSize&&r<=u.maxBitrate)??H(Ja);return`av01.0.${o.level.toString().padStart(2,"0")}${o.tier}.08`}}throw new TypeError(`Unhandled codec '${n}'.`)},ns=n=>{let t=n.split("."),e=Number(t[1]),r=Number(t[2]),i=Number(t[3]),a=t[4]?Number(t[4]):1;return[1,1,e,2,1,r,3,1,i,4,1,a]},nn=n=>{let t=n.split("."),i=(1<<7)+1,a=Number(t[1]),o=t[2],s=Number(o.slice(0,-1)),c=(a<<5)+s,u=o.slice(-1)==="H"?1:0,l=Number(t[3])===8?0:1,m=0,f=t[4]?Number(t[4]):0,h=t[5]?Number(t[5][0]):1,b=t[5]?Number(t[5][1]):1,g=t[5]?Number(t[5][2]):0,w=(u<<7)+(l<<6)+(m<<5)+(f<<4)+(h<<3)+(b<<2)+g;return[i,c,w,0]},an=n=>{let{codec:t,codecDescription:e,colorSpace:r,avcCodecInfo:i,hevcCodecInfo:a,vp9CodecInfo:o,av1CodecInfo:s}=n;if(t==="avc"){if(i){let c=new Uint8Array([i.avcProfileIndication,i.profileCompatibility,i.avcLevelIndication]);return`avc1.${vi(c)}`}if(!e||e.byteLength<4)throw new TypeError("AVC decoder description is not provided or is not at least 4 bytes long.");return`avc1.${vi(e.subarray(1,4))}`}else if(t==="hevc"){let c,u,d,l,m,f;if(a)c=a.generalProfileSpace,u=a.generalProfileIdc,d=Ii(a.generalProfileCompatibilityFlags),l=a.generalTierFlag,m=a.generalLevelIdc,f=[...a.generalConstraintIndicatorFlags];else{if(!e||e.byteLength<23)throw new TypeError("HEVC decoder description is not provided or is not at least 23 bytes long.");let b=V(e),g=b.getUint8(1);c=g>>6&3,u=g&31,d=Ii(b.getUint32(2)),l=g>>5&1,m=b.getUint8(12),f=[];for(let w=0;w<6;w++)f.push(b.getUint8(6+w))}let h="hev1.";for(h+=["","A","B","C"][c]+u,h+=".",h+=d.toString(16).toUpperCase(),h+=".",h+=l===0?"L":"H",h+=m;f.length>0&&f[f.length-1]===0;)f.pop();return f.length>0&&(h+=".",h+=f.map(b=>b.toString(16).toUpperCase()).join(".")),h}else{if(t==="vp8")return"vp8";if(t==="vp9"){if(!o){let w=n.width*n.height,k=H(Ye).level;for(let T of Ye)if(w<=T.maxPictureSize){k=T.level;break}return`vp09.00.${k.toString().padStart(2,"0")}.08`}let c=o.profile.toString().padStart(2,"0"),u=o.level.toString().padStart(2,"0"),d=o.bitDepth.toString().padStart(2,"0"),l=o.chromaSubsampling.toString().padStart(2,"0"),m=o.colourPrimaries.toString().padStart(2,"0"),f=o.transferCharacteristics.toString().padStart(2,"0"),h=o.matrixCoefficients.toString().padStart(2,"0"),b=o.videoFullRangeFlag.toString().padStart(2,"0"),g=`vp09.${c}.${u}.${d}.${l}`;return g+=`.${m}.${f}.${h}.${b}`,g.endsWith(es)&&(g=g.slice(0,-es.length)),g}else if(t==="av1"){if(!s){let T=n.width*n.height,S=H(Ye).level;for(let y of Ye)if(T<=y.maxPictureSize){S=y.level;break}return`av01.0.${S.toString().padStart(2,"0")}M.08`}let c=s.profile,u=s.level.toString().padStart(2,"0"),d=s.tier?"H":"M",l=s.bitDepth.toString().padStart(2,"0"),m=s.monochrome?"1":"0",f=100*s.chromaSubsamplingX+10*s.chromaSubsamplingY+1*(s.chromaSubsamplingX&&s.chromaSubsamplingY?s.chromaSamplePosition:0),h=r?.primaries?$e[r.primaries]:1,b=r?.transfer?Qe[r.transfer]:1,g=r?.matrix?Ge[r.matrix]:1,w=r?.fullRange?1:0,k=`av01.${c}.${u}${d}.${l}`;return k+=`.${m}.${f.toString().padStart(3,"0")}`,k+=`.${h.toString().padStart(2,"0")}`,k+=`.${b.toString().padStart(2,"0")}`,k+=`.${g.toString().padStart(2,"0")}`,k+=`.${w}`,k.endsWith(ts)&&(k=k.slice(0,-ts.length)),k}}throw new TypeError(`Unhandled codec '${t}'.`)},is=(n,t,e)=>{if(n==="aac")return t>=2&&e<=24e3?"mp4a.40.29":e<=24e3?"mp4a.40.5":"mp4a.40.2";if(n==="mp3")return"mp3";if(n==="opus")return"opus";if(n==="vorbis")return"vorbis";if(n==="flac")return"flac";if(j.includes(n))return n;throw new TypeError(`Unhandled codec '${n}'.`)},sn=n=>{let{codec:t,codecDescription:e,aacCodecInfo:r}=n;if(t==="aac"){if(!r)throw new TypeError("AAC codec info must be provided.");return r.isMpeg2?"mp4a.67":`mp4a.40.${mr(e).objectType}`}else{if(t==="mp3")return"mp3";if(t==="opus")return"opus";if(t==="vorbis")return"vorbis";if(t==="flac")return"flac";if(t&&j.includes(t))return t}throw new TypeError(`Unhandled codec '${t}'.`)},lr=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],Mi=[-1,1,2,3,4,5,6,8],mr=n=>{if(!n||n.byteLength<2)throw new TypeError("AAC description must be at least 2 bytes long.");let t=new $(n),e=t.readBits(5);e===31&&(e=32+t.readBits(6));let r=t.readBits(4),i=null;r===15?i=t.readBits(24):r<lr.length&&(i=lr[r]);let a=t.readBits(4),o=null;return a>=1&&a<=7&&(o=Mi[a]),{objectType:e,frequencyIndex:r,sampleRate:i,channelConfiguration:a,numberOfChannels:o}},Ae=48e3,as=/^pcm-([usf])(\d+)+(be)?$/,se=n=>{if(p(j.includes(n)),n==="ulaw")return{dataType:"ulaw",sampleSize:1,littleEndian:!0,silentValue:255};if(n==="alaw")return{dataType:"alaw",sampleSize:1,littleEndian:!0,silentValue:213};let t=as.exec(n);p(t);let e;t[1]==="u"?e="unsigned":t[1]==="s"?e="signed":e="float";let r=Number(t[2])/8,i=t[3]!=="be",a=n==="pcm-u8"?2**7:0;return{dataType:e,sampleSize:r,littleEndian:i,silentValue:a}},Oi=n=>n.startsWith("avc1")||n.startsWith("avc3")?"avc":n.startsWith("hev1")||n.startsWith("hvc1")?"hevc":n==="vp8"?"vp8":n.startsWith("vp09")?"vp9":n.startsWith("av01")?"av1":n.startsWith("mp4a.40")||n==="mp4a.67"?"aac":n==="mp3"||n==="mp4a.69"||n==="mp4a.6B"||n==="mp4a.6b"?"mp3":n==="opus"?"opus":n==="vorbis"?"vorbis":n==="flac"?"flac":n==="ulaw"?"ulaw":n==="alaw"?"alaw":as.test(n)?n:n==="webvtt"?"webvtt":null,ss=n=>n==="avc"?{avc:{format:"avc"}}:n==="hevc"?{hevc:{format:"hevc"}}:{},os=n=>n==="aac"?{aac:{format:"aac"}}:n==="opus"?{opus:{format:"opus"}}:{},Io=["avc1","avc3","hev1","hvc1","vp8","vp09","av01"],Eo=/^(avc1|avc3)\.[0-9a-fA-F]{6}$/,_o=/^(hev1|hvc1)\.(?:[ABC]?\d+)\.[0-9a-fA-F]{1,8}\.[LH]\d+(?:\.[0-9a-fA-F]{1,2}){0,6}$/,Ao=/^vp09(?:\.\d{2}){3}(?:(?:\.\d{2}){5})?$/,Fo=/^av01\.\d\.\d{2}[MH]\.\d{2}(?:\.\d\.\d{3}\.\d{2}\.\d{2}\.\d{2}\.\d)?$/,on=n=>{if(!n)throw new TypeError("Video chunk metadata must be provided.");if(typeof n!="object")throw new TypeError("Video chunk metadata must be an object.");if(!n.decoderConfig)throw new TypeError("Video chunk metadata must include a decoder configuration.");if(typeof n.decoderConfig!="object")throw new TypeError("Video chunk metadata decoder configuration must be an object.");if(typeof n.decoderConfig.codec!="string")throw new TypeError("Video chunk metadata decoder configuration must specify a codec string.");if(!Io.some(t=>n.decoderConfig.codec.startsWith(t)))throw new TypeError("Video chunk metadata decoder configuration codec string must be a valid video codec string as specified in the WebCodecs Codec Registry.");if(!Number.isInteger(n.decoderConfig.codedWidth)||n.decoderConfig.codedWidth<=0)throw new TypeError("Video chunk metadata decoder configuration must specify a valid codedWidth (positive integer).");if(!Number.isInteger(n.decoderConfig.codedHeight)||n.decoderConfig.codedHeight<=0)throw new TypeError("Video chunk metadata decoder configuration must specify a valid codedHeight (positive integer).");if(n.decoderConfig.description!==void 0&&!Mt(n.decoderConfig.description))throw new TypeError("Video chunk metadata decoder configuration description, when defined, must be an ArrayBuffer or an ArrayBuffer view.");if(n.decoderConfig.colorSpace!==void 0){let{colorSpace:t}=n.decoderConfig;if(typeof t!="object")throw new TypeError("Video chunk metadata decoder configuration colorSpace, when provided, must be an object.");let e=Object.keys($e);if(t.primaries!=null&&!e.includes(t.primaries))throw new TypeError(`Video chunk metadata decoder configuration colorSpace primaries, when defined, must be one of ${e.join(", ")}.`);let r=Object.keys(Qe);if(t.transfer!=null&&!r.includes(t.transfer))throw new TypeError(`Video chunk metadata decoder configuration colorSpace transfer, when defined, must be one of ${r.join(", ")}.`);let i=Object.keys(Ge);if(t.matrix!=null&&!i.includes(t.matrix))throw new TypeError(`Video chunk metadata decoder configuration colorSpace matrix, when defined, must be one of ${i.join(", ")}.`);if(t.fullRange!=null&&typeof t.fullRange!="boolean")throw new TypeError("Video chunk metadata decoder configuration colorSpace fullRange, when defined, must be a boolean.")}if(n.decoderConfig.codec.startsWith("avc1")||n.decoderConfig.codec.startsWith("avc3")){if(!Eo.test(n.decoderConfig.codec))throw new TypeError("Video chunk metadata decoder configuration codec string for AVC must be a valid AVC codec string as specified in Section 3.4 of RFC 6381.")}else if(n.decoderConfig.codec.startsWith("hev1")||n.decoderConfig.codec.startsWith("hvc1")){if(!_o.test(n.decoderConfig.codec))throw new TypeError("Video chunk metadata decoder configuration codec string for HEVC must be a valid HEVC codec string as specified in Section E.3 of ISO 14496-15.")}else if(n.decoderConfig.codec.startsWith("vp8")){if(n.decoderConfig.codec!=="vp8")throw new TypeError('Video chunk metadata decoder configuration codec string for VP8 must be "vp8".')}else if(n.decoderConfig.codec.startsWith("vp09")){if(!Ao.test(n.decoderConfig.codec))throw new TypeError('Video chunk metadata decoder configuration codec string for VP9 must be a valid VP9 codec string as specified in Section "Codecs Parameter String" of https://www.webmproject.org/vp9/mp4/.')}else if(n.decoderConfig.codec.startsWith("av01")&&!Fo.test(n.decoderConfig.codec))throw new TypeError('Video chunk metadata decoder configuration codec string for AV1 must be a valid AV1 codec string as specified in Section "Codecs Parameter String" of https://aomediacodec.github.io/av1-isobmff/.')},Mo=["mp4a","mp3","opus","vorbis","flac","ulaw","alaw","pcm"],Ue=n=>{if(!n)throw new TypeError("Audio chunk metadata must be provided.");if(typeof n!="object")throw new TypeError("Audio chunk metadata must be an object.");if(!n.decoderConfig)throw new TypeError("Audio chunk metadata must include a decoder configuration.");if(typeof n.decoderConfig!="object")throw new TypeError("Audio chunk metadata decoder configuration must be an object.");if(typeof n.decoderConfig.codec!="string")throw new TypeError("Audio chunk metadata decoder configuration must specify a codec string.");if(!Mo.some(t=>n.decoderConfig.codec.startsWith(t)))throw new TypeError("Audio chunk metadata decoder configuration codec string must be a valid audio codec string as specified in the WebCodecs Codec Registry.");if(!Number.isInteger(n.decoderConfig.sampleRate)||n.decoderConfig.sampleRate<=0)throw new TypeError("Audio chunk metadata decoder configuration must specify a valid sampleRate (positive integer).");if(!Number.isInteger(n.decoderConfig.numberOfChannels)||n.decoderConfig.numberOfChannels<=0)throw new TypeError("Audio chunk metadata decoder configuration must specify a valid numberOfChannels (positive integer).");if(n.decoderConfig.description!==void 0&&!Mt(n.decoderConfig.description))throw new TypeError("Audio chunk metadata decoder configuration description, when defined, must be an ArrayBuffer or an ArrayBuffer view.");if(n.decoderConfig.codec.startsWith("mp4a")&&n.decoderConfig.codec!=="mp4a.69"&&n.decoderConfig.codec!=="mp4a.6B"&&n.decoderConfig.codec!=="mp4a.6b"){if(!["mp4a.40.2","mp4a.40.02","mp4a.40.5","mp4a.40.05","mp4a.40.29","mp4a.67"].includes(n.decoderConfig.codec))throw new TypeError("Audio chunk metadata decoder configuration codec string for AAC must be a valid AAC codec string as specified in https://www.w3.org/TR/webcodecs-aac-codec-registration/.");if(!n.decoderConfig.description)throw new TypeError("Audio chunk metadata decoder configuration for AAC must include a description, which is expected to be an AudioSpecificConfig as specified in ISO 14496-3.")}else if(n.decoderConfig.codec.startsWith("mp3")||n.decoderConfig.codec.startsWith("mp4a")){if(n.decoderConfig.codec!=="mp3"&&n.decoderConfig.codec!=="mp4a.69"&&n.decoderConfig.codec!=="mp4a.6B"&&n.decoderConfig.codec!=="mp4a.6b")throw new TypeError('Audio chunk metadata decoder configuration codec string for MP3 must be "mp3", "mp4a.69" or "mp4a.6B".')}else if(n.decoderConfig.codec.startsWith("opus")){if(n.decoderConfig.codec!=="opus")throw new TypeError('Audio chunk metadata decoder configuration codec string for Opus must be "opus".');if(n.decoderConfig.description&&n.decoderConfig.description.byteLength<18)throw new TypeError("Audio chunk metadata decoder configuration description, when specified, is expected to be an Identification Header as specified in Section 5.1 of RFC 7845.")}else if(n.decoderConfig.codec.startsWith("vorbis")){if(n.decoderConfig.codec!=="vorbis")throw new TypeError('Audio chunk metadata decoder configuration codec string for Vorbis must be "vorbis".');if(!n.decoderConfig.description)throw new TypeError("Audio chunk metadata decoder configuration for Vorbis must include a description, which is expected to adhere to the format described in https://www.w3.org/TR/webcodecs-vorbis-codec-registration/.")}else if(n.decoderConfig.codec.startsWith("flac")){if(n.decoderConfig.codec!=="flac")throw new TypeError('Audio chunk metadata decoder configuration codec string for FLAC must be "flac".');if(!n.decoderConfig.description||n.decoderConfig.description.byteLength<42)throw new TypeError("Audio chunk metadata decoder configuration for FLAC must include a description, which is expected to adhere to the format described in https://www.w3.org/TR/webcodecs-flac-codec-registration/.")}else if((n.decoderConfig.codec.startsWith("pcm")||n.decoderConfig.codec.startsWith("ulaw")||n.decoderConfig.codec.startsWith("alaw"))&&!j.includes(n.decoderConfig.codec))throw new TypeError(`Audio chunk metadata decoder configuration codec string for PCM must be one of the supported PCM codecs (${j.join(", ")}).`)},cn=n=>{if(!n)throw new TypeError("Subtitle metadata must be provided.");if(typeof n!="object")throw new TypeError("Subtitle metadata must be an object.");if(!n.config)throw new TypeError("Subtitle metadata must include a config object.");if(typeof n.config!="object")throw new TypeError("Subtitle metadata config must be an object.");if(typeof n.config.description!="string")throw new TypeError("Subtitle metadata config description must be a string.")};var he=class{constructor(t){this.mutex=new ce;this.firstMediaStreamTimestamp=null;this.trackTimestampInfo=new WeakMap;this.output=t}onTrackClose(t){}validateAndNormalizeTimestamp(t,e,r){e+=t.source._timestampOffset;let i=this.trackTimestampInfo.get(t);if(!i){if(!r)throw new Error("First frame must be a key frame.");i={maxTimestamp:e,maxTimestampBeforeLastKeyFrame:e},this.trackTimestampInfo.set(t,i)}if(e<0)throw new Error(`Timestamps must be non-negative (got ${e}s).`);if(r&&(i.maxTimestampBeforeLastKeyFrame=i.maxTimestamp),e<i.maxTimestampBeforeLastKeyFrame)throw new Error(`Timestamps cannot be smaller than the highest timestamp of the previous run (a run begins with a key frame and ends right before the next key frame). Got ${e}s, but highest timestamp is ${i.maxTimestampBeforeLastKeyFrame}s.`);return i.maxTimestamp=Math.max(i.maxTimestamp,e),e}};var un=class extends he{constructor(e,r){super(e);this.header=new Uint8Array(7);this.headerBitstream=new $(this.header);this.audioSpecificConfig=null;this.format=r,this.writer=e._writer}async start(){}async getMimeType(){return"audio/aac"}async addEncodedVideoPacket(){throw new Error("ADTS does not support video.")}async addEncodedAudioPacket(e,r,i){let a=await this.mutex.acquire();try{if(this.validateAndNormalizeTimestamp(e,r.timestamp,r.type==="key"),!this.audioSpecificConfig){Ue(i);let c=i?.decoderConfig?.description;p(c),this.audioSpecificConfig=mr(Q(c));let{objectType:u,frequencyIndex:d,channelConfiguration:l}=this.audioSpecificConfig,m=u-1;this.headerBitstream.writeBits(12,4095),this.headerBitstream.writeBits(1,0),this.headerBitstream.writeBits(2,0),this.headerBitstream.writeBits(1,1),this.headerBitstream.writeBits(2,m),this.headerBitstream.writeBits(4,d),this.headerBitstream.writeBits(1,0),this.headerBitstream.writeBits(3,l),this.headerBitstream.writeBits(1,0),this.headerBitstream.writeBits(1,0),this.headerBitstream.writeBits(1,0),this.headerBitstream.writeBits(1,0),this.headerBitstream.skipBits(13),this.headerBitstream.writeBits(11,2047),this.headerBitstream.writeBits(2,0)}let o=r.data.byteLength+this.header.byteLength;this.headerBitstream.pos=30,this.headerBitstream.writeBits(13,o);let s=this.writer.getPos();if(this.writer.write(this.header),this.writer.write(r.data),this.format._options.onFrame){let c=new Uint8Array(o);c.set(this.header,0),c.set(r.data,this.header.byteLength),this.format._options.onFrame(c,s)}await this.writer.flush()}finally{a()}}async addSubtitleCue(){throw new Error("ADTS does not support subtitles.")}async finalize(){}};var fr=/(?:(.+?)\n)?((?:\d{2}:)?\d{2}:\d{2}.\d{3})\s+-->\s+((?:\d{2}:)?\d{2}:\d{2}.\d{3})/g,Oo=/^WEBVTT(.|\n)*?\n{2}/,Ot=/<(?:(\d{2}):)?(\d{2}):(\d{2}).(\d{3})>/g,dn=class{constructor(t){this.preambleText=null;this.preambleEmitted=!1;this.options=t}parse(t){t=t.replaceAll(`\r
`,`
`).replaceAll("\r",`
`),fr.lastIndex=0;let e;if(!this.preambleText){if(!Oo.test(t))throw new Error("WebVTT preamble incorrect.");e=fr.exec(t);let r=t.slice(0,e?.index??t.length).trimEnd();if(!r)throw new Error("No WebVTT preamble provided.");this.preambleText=r,e&&(t=t.slice(e.index),fr.lastIndex=0)}for(;e=fr.exec(t);){let r=t.slice(0,e.index),i=e[1],a=e.index+e[0].length,o=t.indexOf(`
`,a)+1,s=t.slice(a,o).trim(),c=t.indexOf(`

`,a);c===-1&&(c=t.length);let u=ln(e[2]),l=ln(e[3])-u,m=t.slice(o,c).trim();t=t.slice(c).trimStart(),fr.lastIndex=0;let f={timestamp:u/1e3,duration:l/1e3,text:m,identifier:i,settings:s,notes:r},h={};this.preambleEmitted||(h.config={description:this.preambleText},this.preambleEmitted=!0),this.options.output(f,h)}}},Ro=/(?:(\d{2}):)?(\d{2}):(\d{2}).(\d{3})/,ln=n=>{let t=Ro.exec(n);if(!t)throw new Error("Expected match.");return 60*60*1e3*Number(t[1]||"0")+60*1e3*Number(t[2])+1e3*Number(t[3])+Number(t[4])},mn=n=>{let t=Math.floor(n/36e5),e=Math.floor(n%(60*60*1e3)/(60*1e3)),r=Math.floor(n%(60*1e3)/1e3),i=n%1e3;return t.toString().padStart(2,"0")+":"+e.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")+"."+i.toString().padStart(3,"0")};var pr=n=>{let t=[],e=0;for(;e<n.length;){let r=-1,i=0;for(let a=e;a<n.length-3;a++){if(n[a]===0&&n[a+1]===0&&n[a+2]===1){r=a,i=3;break}if(a<n.length-4&&n[a]===0&&n[a+1]===0&&n[a+2]===0&&n[a+3]===1){r=a,i=4;break}}if(r===-1)break;if(e>0&&r>e){let a=n.subarray(e,r);a.length>0&&t.push(a)}e=r+i}if(e<n.length){let r=n.subarray(e);r.length>0&&t.push(r)}return t},us=(n,t)=>{let e=[],r=0,i=new DataView(n.buffer,n.byteOffset,n.byteLength);for(;r+t<=n.length;){let a;t===1?a=i.getUint8(r):t===2?a=i.getUint16(r,!1):t===3?a=(i.getUint16(r,!1)<<8)+i.getUint8(r+2):t===4?a=i.getUint32(r,!1):(Y(t),p(!1)),r+=t;let o=n.subarray(r,r+a);e.push(o),r+=a}return e},Ri=n=>{let t=[],e=n.length;for(let r=0;r<e;r++)r+2<e&&n[r]===0&&n[r+1]===0&&n[r+2]===3?(t.push(0,0),r+=2):t.push(n[r]);return new Uint8Array(t)},ds=n=>{let e=pr(n);if(e.length===0)return null;let r=0;for(let s of e)r+=4+s.byteLength;let i=new Uint8Array(r),a=new DataView(i.buffer),o=0;for(let s of e){let c=s.byteLength;a.setUint32(o,c,!1),o+=4,i.set(s,o),o+=s.byteLength}return i},Do=(n,t)=>{if(t.description){let i=(Q(t.description)[4]&3)+1;return us(n,i)}else return pr(n)},fn=n=>n[0]&31,pn=n=>{try{let t=pr(n),e=t.filter(m=>fn(m)===7),r=t.filter(m=>fn(m)===8),i=t.filter(m=>fn(m)===13);if(e.length===0||r.length===0)return null;let a=e[0],o=new $(Ri(a));if(o.skipBits(1),o.skipBits(2),o.readBits(5)!==7)return console.error("Invalid SPS NAL unit type"),null;let c=o.readAlignedByte(),u=o.readAlignedByte(),d=o.readAlignedByte(),l={configurationVersion:1,avcProfileIndication:c,profileCompatibility:u,avcLevelIndication:d,lengthSizeMinusOne:3,sequenceParameterSets:e,pictureParameterSets:r,chromaFormat:null,bitDepthLumaMinus8:null,bitDepthChromaMinus8:null,sequenceParameterSetExt:null};if(c===100||c===110||c===122||c===144){A(o);let m=A(o);m===3&&o.skipBits(1);let f=A(o),h=A(o);l.chromaFormat=m,l.bitDepthLumaMinus8=f,l.bitDepthChromaMinus8=h,l.sequenceParameterSetExt=i}return l}catch(t){return console.error("Error building AVC Decoder Configuration Record:",t),null}},ls=n=>{let t=[];t.push(n.configurationVersion),t.push(n.avcProfileIndication),t.push(n.profileCompatibility),t.push(n.avcLevelIndication),t.push(252|n.lengthSizeMinusOne&3),t.push(224|n.sequenceParameterSets.length&31);for(let e of n.sequenceParameterSets){let r=e.byteLength;t.push(r>>8),t.push(r&255);for(let i=0;i<r;i++)t.push(e[i])}t.push(n.pictureParameterSets.length);for(let e of n.pictureParameterSets){let r=e.byteLength;t.push(r>>8),t.push(r&255);for(let i=0;i<r;i++)t.push(e[i])}if(n.avcProfileIndication===100||n.avcProfileIndication===110||n.avcProfileIndication===122||n.avcProfileIndication===144){p(n.chromaFormat!==null),p(n.bitDepthLumaMinus8!==null),p(n.bitDepthChromaMinus8!==null),p(n.sequenceParameterSetExt!==null),t.push(252|n.chromaFormat&3),t.push(248|n.bitDepthLumaMinus8&7),t.push(248|n.bitDepthChromaMinus8&7),t.push(n.sequenceParameterSetExt.length);for(let e of n.sequenceParameterSetExt){let r=e.byteLength;t.push(r>>8),t.push(r&255);for(let i=0;i<r;i++)t.push(e[i])}}return new Uint8Array(t)},Di=(n,t)=>{if(t.description){let i=(Q(t.description)[21]&3)+1;return us(n,i)}else return pr(n)},Je=n=>n[0]>>1&63,hn=n=>{try{let t=pr(n),e=t.filter(E=>Je(E)===32),r=t.filter(E=>Je(E)===33),i=t.filter(E=>Je(E)===34),a=t.filter(E=>Je(E)===39||Je(E)===40);if(r.length===0||i.length===0)return null;let o=r[0],s=new $(Ri(o));s.skipBits(16),s.readBits(4);let c=s.readBits(3),u=s.readBits(1),{general_profile_space:d,general_tier_flag:l,general_profile_idc:m,general_profile_compatibility_flags:f,general_constraint_indicator_flags:h,general_level_idc:b}=Bo(s,c);A(s);let g=A(s);g===3&&s.skipBits(1),A(s),A(s),s.readBits(1)&&(A(s),A(s),A(s),A(s));let w=A(s),k=A(s);A(s);let S=s.readBits(1)?0:c;for(let E=S;E<=c;E++)A(s),A(s),A(s);A(s),A(s),A(s),A(s),A(s),A(s),s.readBits(1)&&s.readBits(1)&&Vo(s),s.skipBits(1),s.skipBits(1),s.readBits(1)&&(s.skipBits(4),s.skipBits(4),A(s),A(s),s.skipBits(1));let y=A(s);if(zo(s,y),s.readBits(1)){let E=A(s);for(let I=0;I<E;I++)A(s),s.skipBits(1)}s.skipBits(1),s.skipBits(1);let x=0;s.readBits(1)&&(x=No(s,c));let F=0;if(i.length>0){let E=i[0],I=new $(Ri(E));I.skipBits(16),A(I),A(I),I.skipBits(1),I.skipBits(1),I.skipBits(3),I.skipBits(1),I.skipBits(1),A(I),A(I),Ft(I),I.skipBits(1),I.skipBits(1),I.readBits(1)&&A(I),Ft(I),Ft(I),I.skipBits(1),I.skipBits(1),I.skipBits(1),I.skipBits(1);let B=I.readBits(1),G=I.readBits(1);!B&&!G?F=0:B&&!G?F=2:!B&&G?F=3:F=0}let _=[...e.length?[{arrayCompleteness:1,nalUnitType:32,nalUnits:e}]:[],...r.length?[{arrayCompleteness:1,nalUnitType:33,nalUnits:r}]:[],...i.length?[{arrayCompleteness:1,nalUnitType:34,nalUnits:i}]:[],...a.length?[{arrayCompleteness:1,nalUnitType:Je(a[0]),nalUnits:a}]:[]];return{configurationVersion:1,generalProfileSpace:d,generalTierFlag:l,generalProfileIdc:m,generalProfileCompatibilityFlags:f,generalConstraintIndicatorFlags:h,generalLevelIdc:b,minSpatialSegmentationIdc:x,parallelismType:F,chromaFormatIdc:g,bitDepthLumaMinus8:w,bitDepthChromaMinus8:k,avgFrameRate:0,constantFrameRate:0,numTemporalLayers:c+1,temporalIdNested:u,lengthSizeMinusOne:3,arrays:_}}catch(t){return console.error("Error building HEVC Decoder Configuration Record:",t),null}},Bo=(n,t)=>{let e=n.readBits(2),r=n.readBits(1),i=n.readBits(5),a=0;for(let d=0;d<32;d++)a=a<<1|n.readBits(1);let o=new Uint8Array(6);for(let d=0;d<6;d++)o[d]=n.readBits(8);let s=n.readBits(8),c=[],u=[];for(let d=0;d<t;d++)c.push(n.readBits(1)),u.push(n.readBits(1));if(t>0)for(let d=t;d<8;d++)n.skipBits(2);for(let d=0;d<t;d++)c[d]&&n.skipBits(88),u[d]&&n.skipBits(8);return{general_profile_space:e,general_tier_flag:r,general_profile_idc:i,general_profile_compatibility_flags:a,general_constraint_indicator_flags:o,general_level_idc:s}},Vo=n=>{for(let t=0;t<4;t++)for(let e=0;e<(t===3?2:6);e++)if(!n.readBits(1))A(n);else{let i=Math.min(64,1<<4+(t<<1));t>1&&Ft(n);for(let a=0;a<i;a++)Ft(n)}},zo=(n,t)=>{let e=[];for(let r=0;r<t;r++)e[r]=Uo(n,r,t,e)},Uo=(n,t,e,r)=>{let i=0,a=0,o=0;if(t!==0&&(a=n.readBits(1)),a){if(t===e){let c=A(n);o=t-(c+1)}else o=t-1;n.readBits(1),A(n);let s=r[o]??0;for(let c=0;c<=s;c++)n.readBits(1)||n.readBits(1);i=r[o]}else{let s=A(n),c=A(n);for(let u=0;u<s;u++)A(n),n.readBits(1);for(let u=0;u<c;u++)A(n),n.readBits(1);i=s+c}return i},No=(n,t)=>{if(n.readBits(1)&&n.readBits(8)===255&&(n.readBits(16),n.readBits(16)),n.readBits(1)&&n.readBits(1),n.readBits(1)&&(n.readBits(3),n.readBits(1),n.readBits(1)&&(n.readBits(8),n.readBits(8),n.readBits(8))),n.readBits(1)&&(A(n),A(n)),n.readBits(1),n.readBits(1),n.readBits(1),n.readBits(1)&&(A(n),A(n),A(n),A(n)),n.readBits(1)&&(n.readBits(32),n.readBits(32),n.readBits(1)&&A(n),n.readBits(1)&&Wo(n,!0,t)),n.readBits(1)){n.readBits(1),n.readBits(1),n.readBits(1);let e=A(n);return A(n),A(n),A(n),A(n),e}return 0},Wo=(n,t,e)=>{let r=!1,i=!1,a=!1;t&&(r=n.readBits(1)===1,i=n.readBits(1)===1,(r||i)&&(a=n.readBits(1)===1,a&&(n.readBits(8),n.readBits(5),n.readBits(1),n.readBits(5)),n.readBits(4),n.readBits(4),a&&n.readBits(4),n.readBits(5),n.readBits(5),n.readBits(5)));for(let o=0;o<=e;o++){let s=n.readBits(1)===1,c=!0;s||(c=n.readBits(1)===1);let u=!1;c?A(n):u=n.readBits(1)===1;let d=1;u||(d=A(n)+1),r&&cs(n,d,a),i&&cs(n,d,a)}},cs=(n,t,e)=>{for(let r=0;r<t;r++)A(n),A(n),e&&(A(n),A(n)),n.readBits(1)},ms=n=>{let t=[];t.push(n.configurationVersion),t.push((n.generalProfileSpace&3)<<6|(n.generalTierFlag&1)<<5|n.generalProfileIdc&31),t.push(n.generalProfileCompatibilityFlags>>>24&255),t.push(n.generalProfileCompatibilityFlags>>>16&255),t.push(n.generalProfileCompatibilityFlags>>>8&255),t.push(n.generalProfileCompatibilityFlags&255),t.push(...n.generalConstraintIndicatorFlags),t.push(n.generalLevelIdc&255),t.push(240|n.minSpatialSegmentationIdc>>8&15),t.push(n.minSpatialSegmentationIdc&255),t.push(252|n.parallelismType&3),t.push(252|n.chromaFormatIdc&3),t.push(248|n.bitDepthLumaMinus8&7),t.push(248|n.bitDepthChromaMinus8&7),t.push(n.avgFrameRate>>8&255),t.push(n.avgFrameRate&255),t.push((n.constantFrameRate&3)<<6|(n.numTemporalLayers&7)<<3|(n.temporalIdNested&1)<<2|n.lengthSizeMinusOne&3),t.push(n.arrays.length&255);for(let e of n.arrays){t.push((e.arrayCompleteness&1)<<7|0|e.nalUnitType&63),t.push(e.nalUnits.length>>8&255),t.push(e.nalUnits.length&255);for(let r of e.nalUnits){t.push(r.length>>8&255),t.push(r.length&255);for(let i=0;i<r.length;i++)t.push(r[i])}}return new Uint8Array(t)},gn=n=>{let t=new $(n);if(t.readBits(2)!==2)return null;let r=t.readBits(1),a=(t.readBits(1)<<1)+r;if(a===3&&t.skipBits(1),t.readBits(1)===1||t.readBits(1)!==0||(t.skipBits(2),t.readBits(24)!==4817730))return null;let u=8;a>=2&&(u=t.readBits(1)?12:10);let d=t.readBits(3),l=0,m=0;if(d!==7)if(m=t.readBits(1),a===1||a===3){let F=t.readBits(1),_=t.readBits(1);l=!F&&!_?3:F&&!_?2:1,t.skipBits(1)}else l=1;else l=3,m=1;let f=t.readBits(16),h=t.readBits(16),b=f+1,g=h+1,w=b*g,k=H(Ye).level;for(let x of Ye)if(w<=x.maxPictureSize){k=x.level;break}return{profile:a,level:k,bitDepth:u,chromaSubsampling:l,videoFullRangeFlag:m,colourPrimaries:d===2?1:d===1?6:2,transferCharacteristics:d===2?1:d===1?6:2,matrixCoefficients:d===7?0:d===2?1:d===1?6:2}},fs=function*(n){let t=new $(n),e=()=>{let r=0;for(let i=0;i<8;i++){let a=t.readAlignedByte();if(r|=(a&127)<<i*7,!(a&128))break;if(i===7&&a&128)return null}return r>=2**32-1?null:r};for(;t.getBitsLeft()>=8;){t.skipBits(1);let r=t.readBits(4),i=t.readBits(1),a=t.readBits(1);t.skipBits(1),i&&t.skipBits(8);let o;if(a){let s=e();if(s===null)return;o=s}else o=Math.floor(t.getBitsLeft()/8);p(t.pos%8===0),yield{type:r,data:n.subarray(t.pos/8,t.pos/8+o)},t.skipBits(o*8)}},bn=n=>{for(let{type:t,data:e}of fs(n)){if(t!==1)continue;let r=new $(e),i=r.readBits(3),a=r.readBits(1),o=r.readBits(1),s=0,c=0,u=0;if(o)s=r.readBits(5);else{if(r.readBits(1)&&(r.skipBits(32),r.skipBits(32),r.readBits(1)))return null;let w=r.readBits(1);w&&(u=r.readBits(5),r.skipBits(32),r.skipBits(5),r.skipBits(5));let k=r.readBits(5);for(let T=0;T<=k;T++){r.skipBits(12);let S=r.readBits(5);if(T===0&&(s=S),S>7){let x=r.readBits(1);T===0&&(c=x)}if(w&&r.readBits(1)){let F=u+1;r.skipBits(F),r.skipBits(F),r.skipBits(1)}r.readBits(1)&&r.skipBits(4)}}let d=r.readBits(1),l=8;i===2&&d?l=r.readBits(1)?12:10:i<=2&&(l=d?10:8);let m=0;i!==1&&(m=r.readBits(1));let f=1,h=1,b=0;return m||(i===0?(f=1,h=1):i===1?(f=0,h=0):l===12&&(f=r.readBits(1),f&&(h=r.readBits(1))),f&&h&&(b=r.readBits(2))),{profile:i,level:s,tier:c,bitDepth:l,monochrome:m,chromaSubsamplingX:f,chromaSubsamplingY:h,chromaSamplePosition:b}}return null},lt=n=>{let t=V(n),e=t.getUint8(9),r=t.getUint16(10,!0),i=t.getUint32(12,!0),a=t.getInt16(16,!0),o=t.getUint8(18),s=null;return o&&(s=n.subarray(19,21+e)),{outputChannelCount:e,preSkip:r,inputSampleRate:i,outputGain:a,channelMappingFamily:o,channelMappingTable:s}},Lo=[480,960,1920,2880,480,960,1920,2880,480,960,1920,2880,480,960,480,960,120,240,480,960,120,240,480,960,120,240,480,960,120,240,480,960],ps=n=>{let t=n[0]>>3;return{durationInSamples:Lo[t]}},kn=n=>{if(n.length<7)throw new Error("Setup header is too short.");if(n[0]!==5)throw new Error("Wrong packet type in Setup header.");if(String.fromCharCode(...n.slice(1,7))!=="vorbis")throw new Error("Invalid packet signature in Setup header.");let e=n.length,r=new Uint8Array(e);for(let l=0;l<e;l++)r[l]=n[e-1-l];let i=new $(r),a=0;for(;i.getBitsLeft()>97;)if(i.readBits(1)===1){a=i.pos;break}if(a===0)throw new Error("Invalid Setup header: framing bit not found.");let o=0,s=!1,c=0;for(;i.getBitsLeft()>=97;){let l=i.pos,m=i.readBits(8),f=i.readBits(16),h=i.readBits(16);if(m>63||f!==0||h!==0){i.pos=l;break}if(i.skipBits(1),o++,o>64)break;i.clone().readBits(6)+1===o&&(s=!0,c=o)}if(!s)throw new Error("Invalid Setup header: mode header not found.");if(c>63)throw new Error(`Unsupported mode count: ${c}.`);let u=c;i.pos=0,i.skipBits(a);let d=Array(u).fill(0);for(let l=u-1;l>=0;l--)i.skipBits(40),d[l]=i.readBits(1);return{modeBlockflags:d}},hs=async(n,t)=>{switch(p(n.codec),n.codec){case"avc":{let e=await n.getDecoderConfig();return p(e),Do(t.data,e).some(a=>fn(a)===5)?"key":"delta"}case"hevc":{let e=await n.getDecoderConfig();return p(e),Di(t.data,e).some(a=>{let o=Je(a);return 16<=o&&o<=23})?"key":"delta"}case"vp8":return(t.data[0]&1)===0?"key":"delta";case"vp9":{let e=new $(t.data);if(e.readBits(2)!==2)return null;let r=e.readBits(1);return(e.readBits(1)<<1)+r===3&&e.skipBits(1),e.readBits(1)?null:e.readBits(1)===0?"key":"delta"}case"av1":{let e=!1;for(let{type:r,data:i}of fs(t.data))if(r===1){let a=new $(i);a.skipBits(4),e=!!a.readBits(1)}else if(r===3||r===6||r===7){if(e)return"key";let a=new $(i);return a.readBits(1)?null:a.readBits(2)===0?"key":"delta"}return null}default:Y(n.codec),p(!1)}};var hr=class{constructor(t){this.writer=t;this.helper=new Uint8Array(8);this.helperView=new DataView(this.helper.buffer);this.offsets=new WeakMap}writeU32(t){this.helperView.setUint32(0,t,!1),this.writer.write(this.helper.subarray(0,4))}writeU64(t){this.helperView.setUint32(0,Math.floor(t/2**32),!1),this.helperView.setUint32(4,t,!1),this.writer.write(this.helper.subarray(0,8))}writeAscii(t){for(let e=0;e<t.length;e++)this.helperView.setUint8(e%8,t.charCodeAt(e)),e%8===7&&this.writer.write(this.helper);t.length%8!==0&&this.writer.write(this.helper.subarray(0,t.length%8))}writeBox(t){if(this.offsets.set(t,this.writer.getPos()),t.contents&&!t.children)this.writeBoxHeader(t,t.size??t.contents.byteLength+8),this.writer.write(t.contents);else{let e=this.writer.getPos();if(this.writeBoxHeader(t,0),t.contents&&this.writer.write(t.contents),t.children)for(let a of t.children)a&&this.writeBox(a);let r=this.writer.getPos(),i=t.size??r-e;this.writer.seek(e),this.writeBoxHeader(t,i),this.writer.seek(r)}}writeBoxHeader(t,e){this.writeU32(t.largeSize?1:e),this.writeAscii(t.type),t.largeSize&&this.writeU64(e)}measureBoxHeader(t){return 8+(t.largeSize?8:0)}patchBox(t){let e=this.offsets.get(t);p(e!==void 0);let r=this.writer.getPos();this.writer.seek(e),this.writeBox(t),this.writer.seek(r)}measureBox(t){if(t.contents&&!t.children)return this.measureBoxHeader(t)+t.contents.byteLength;{let e=this.measureBoxHeader(t);if(t.contents&&(e+=t.contents.byteLength),t.children)for(let r of t.children)r&&(e+=this.measureBox(r));return e}}},z=new Uint8Array(8),He=new DataView(z.buffer),Z=n=>[(n%256+256)%256],O=n=>(He.setUint16(0,n,!1),[z[0],z[1]]),ks=n=>(He.setInt16(0,n,!1),[z[0],z[1]]),Ts=n=>(He.setUint32(0,n,!1),[z[1],z[2],z[3]]),C=n=>(He.setUint32(0,n,!1),[z[0],z[1],z[2],z[3]]),ft=n=>(He.setInt32(0,n,!1),[z[0],z[1],z[2],z[3]]),St=n=>(He.setUint32(0,Math.floor(n/2**32),!1),He.setUint32(4,n,!1),[z[0],z[1],z[2],z[3],z[4],z[5],z[6],z[7]]),ws=n=>(He.setInt16(0,2**8*n,!1),[z[0],z[1]]),et=n=>(He.setInt32(0,2**16*n,!1),[z[0],z[1],z[2],z[3]]),Bi=n=>(He.setInt32(0,2**30*n,!1),[z[0],z[1],z[2],z[3]]),Vi=(n,t)=>{let e=[],r=n;do{let i=r&127;r>>=7,e.length>0&&(i|=128),e.push(i),t!==void 0&&t--}while(r>0||t);return e.reverse()},ue=(n,t=!1)=>{let e=Array(n.length).fill(null).map((r,i)=>n.charCodeAt(i));return t&&e.push(0),e},Ui=n=>{let t=null;for(let e of n)(!t||e.timestamp>t.timestamp)&&(t=e);return t},ys=n=>{let t=n*(Math.PI/180),e=Math.round(Math.cos(t)),r=Math.round(Math.sin(t));return[e,r,0,-r,e,0,0,0,1]},Ss=ys(0),xs=n=>[et(n[0]),et(n[1]),Bi(n[2]),et(n[3]),et(n[4]),Bi(n[5]),et(n[6]),et(n[7]),Bi(n[8])],R=(n,t,e)=>({type:n,contents:t&&new Uint8Array(t.flat(10)),children:e}),W=(n,t,e,r,i)=>R(n,[Z(t),Ts(e),r??[]],i),Cs=n=>n.isQuickTime?R("ftyp",[ue("qt  "),C(512),ue("qt  ")]):n.fragmented?R("ftyp",[ue("iso5"),C(512),ue("iso5"),ue("iso6"),ue("mp41")]):R("ftyp",[ue("isom"),C(512),ue("isom"),n.holdsAvc?ue("avc1"):[],ue("mp41")]),wn=n=>({type:"mdat",largeSize:n}),gr=(n,t=!1)=>R("moov",void 0,[Ho(n.creationTime,n.trackDatas),...n.trackDatas.map(e=>qo(e,n.creationTime)),t?Pc(n.trackDatas):null,Rc(n)]),Ho=(n,t)=>{let e=ne(Math.max(0,...t.filter(o=>o.samples.length>0).map(o=>{let s=Ui(o.samples);return s.timestamp+s.duration})),Tn),r=Math.max(0,...t.map(o=>o.track.id))+1,i=!Tt(n)||!Tt(e),a=i?St:C;return W("mvhd",+i,0,[a(n),a(n),C(Tn),a(e),et(1),ws(1),Array(10).fill(0),xs(Ss),Array(24).fill(0),C(r)])},qo=(n,t)=>{let e=Os(n);return R("trak",void 0,[Ko(n,t),jo(n,t),e.name!==void 0?R("udta",void 0,[R("name",[...K.encode(e.name)])]):null])},Ko=(n,t)=>{let e=Ui(n.samples),r=ne(e?e.timestamp+e.duration:0,Tn),i=!Tt(t)||!Tt(r),a=i?St:C,o;if(n.type==="video"){let s=n.track.metadata.rotation;o=ys(s??0)}else o=Ss;return W("tkhd",+i,3,[a(t),a(t),C(n.track.id),C(0),a(r),Array(8).fill(0),O(0),O(n.track.id),ws(n.type==="audio"?1:0),O(0),xs(o),et(n.type==="video"?n.info.width:0),et(n.type==="video"?n.info.height:0)])},jo=(n,t)=>R("mdia",void 0,[$o(n,t),Ps(!0,Qo[n.type],Go[n.type]),Xo(n)]),$o=(n,t)=>{let e=Ui(n.samples),r=ne(e?e.timestamp+e.duration:0,n.timescale),i=!Tt(t)||!Tt(r),a=i?St:C;return W("mdhd",+i,0,[a(t),a(t),C(n.timescale),a(r),O(Ms(n.track.metadata.languageCode??te)),O(0)])},Qo={video:"vide",audio:"soun",subtitle:"text"},Go={video:"MediabunnyVideoHandler",audio:"MediabunnySoundHandler",subtitle:"MediabunnyTextHandler"},Ps=(n,t,e,r="\0\0\0\0")=>W("hdlr",0,0,[n?ue("mhlr"):C(0),ue(t),ue(r),C(0),C(0),ue(e,!0)]),Xo=n=>R("minf",void 0,[ec[n.type](),tc(),ic(n)]),Yo=()=>W("vmhd",0,1,[O(0),O(0),O(0),O(0)]),Zo=()=>W("smhd",0,0,[O(0),O(0)]),Jo=()=>W("nmhd",0,0),ec={video:Yo,audio:Zo,subtitle:Jo},tc=()=>R("dinf",void 0,[rc()]),rc=()=>W("dref",0,0,[C(1)],[nc()]),nc=()=>W("url ",0,1),ic=n=>{let t=n.compositionTimeOffsetTable.length>1||n.compositionTimeOffsetTable.some(e=>e.sampleCompositionTimeOffset!==0);return R("stbl",void 0,[ac(n),kc(n),t?xc(n):null,t?Cc(n):null,wc(n),yc(n),Sc(n),Tc(n)])},ac=n=>{let t;if(n.type==="video")t=sc(Vc[n.track.source._codec],n);else if(n.type==="audio"){let e=Fs(n.track.source._codec,n.muxer.isQuickTime);p(e),t=lc(e,n)}else n.type==="subtitle"&&(t=gc(Nc[n.track.source._codec],n));return p(t),W("stsd",0,0,[C(1)],[t])},sc=(n,t)=>R(n,[Array(6).fill(0),O(1),O(0),O(0),Array(12).fill(0),O(t.info.width),O(t.info.height),C(4718592),C(4718592),C(0),O(1),Array(32).fill(0),O(24),ks(65535)],[zc[t.track.source._codec](t),Xr(t.info.decoderConfig.colorSpace)?oc(t):null]),oc=n=>R("colr",[ue("nclx"),O($e[n.info.decoderConfig.colorSpace.primaries]),O(Qe[n.info.decoderConfig.colorSpace.transfer]),O(Ge[n.info.decoderConfig.colorSpace.matrix]),Z((n.info.decoderConfig.colorSpace.fullRange?1:0)<<7)]),cc=n=>n.info.decoderConfig&&R("avcC",[...Q(n.info.decoderConfig.description)]),uc=n=>n.info.decoderConfig&&R("hvcC",[...Q(n.info.decoderConfig.description)]),gs=n=>{if(!n.info.decoderConfig)return null;let t=n.info.decoderConfig,e=t.codec.split("."),r=Number(e[1]),i=Number(e[2]),a=Number(e[3]),o=e[4]?Number(e[4]):1,s=e[8]?Number(e[8]):Number(t.colorSpace?.fullRange??0),c=(a<<4)+(o<<1)+s,u=e[5]?Number(e[5]):t.colorSpace?.primaries?$e[t.colorSpace.primaries]:2,d=e[6]?Number(e[6]):t.colorSpace?.transfer?Qe[t.colorSpace.transfer]:2,l=e[7]?Number(e[7]):t.colorSpace?.matrix?Ge[t.colorSpace.matrix]:2;return W("vpcC",1,0,[Z(r),Z(i),Z(c),Z(u),Z(d),Z(l),O(0)])},dc=n=>R("av1C",nn(n.info.decoderConfig.codec)),lc=(n,t)=>{let e=0,r,i=16;if(j.includes(t.track.source._codec)){let a=t.track.source._codec,{sampleSize:o}=se(a);i=8*o,i>16&&(e=1)}return e===0?r=[Array(6).fill(0),O(1),O(e),O(0),C(0),O(t.info.numberOfChannels),O(i),O(0),O(0),O(t.info.sampleRate<2**16?t.info.sampleRate:0),O(0)]:r=[Array(6).fill(0),O(1),O(e),O(0),C(0),O(t.info.numberOfChannels),O(Math.min(i,16)),O(0),O(0),O(t.info.sampleRate<2**16?t.info.sampleRate:0),O(0),C(1),C(i/8),C(t.info.numberOfChannels*i/8),C(2)],R(n,r,[Uc(t.track.source._codec,t.muxer.isQuickTime)?.(t)??null])},zi=n=>{let t;switch(n.track.source._codec){case"aac":t=64;break;case"mp3":t=107;break;case"vorbis":t=221;break;default:throw new Error(`Unhandled audio codec: ${n.track.source._codec}`)}let e=[...Z(t),...Z(21),...Ts(0),...C(0),...C(0)];if(n.info.decoderConfig.description){let r=Q(n.info.decoderConfig.description);e=[...e,...Z(5),...Vi(r.byteLength),...r]}return e=[...O(1),...Z(0),...Z(4),...Vi(e.length),...e,...Z(6),...Z(1),...Z(2)],e=[...Z(3),...Vi(e.length),...e],W("esds",0,0,e)},mt=n=>R("wave",void 0,[mc(n),fc(n),R("\0\0\0\0")]),mc=n=>R("frma",[ue(Fs(n.track.source._codec,n.muxer.isQuickTime))]),fc=n=>{let{littleEndian:t}=se(n.track.source._codec);return R("enda",[O(+t)])},pc=n=>{let t=n.info.numberOfChannels,e=3840,r=n.info.sampleRate,i=0,a=0,o=new Uint8Array(0),s=n.info.decoderConfig?.description;if(s){p(s.byteLength>=18);let c=Q(s),u=lt(c);t=u.outputChannelCount,e=u.preSkip,r=u.inputSampleRate,i=u.outputGain,a=u.channelMappingFamily,u.channelMappingTable&&(o=u.channelMappingTable)}return R("dOps",[Z(0),Z(t),O(e),C(r),ks(i),Z(a),...o])},hc=n=>{let t=n.info.decoderConfig?.description;p(t);let e=Q(t);return W("dfLa",0,0,[...e.subarray(4)])},Ne=n=>{let{littleEndian:t,sampleSize:e}=se(n.track.source._codec),r=+t;return W("pcmC",0,0,[Z(r),Z(8*e)])},gc=(n,t)=>R(n,[Array(6).fill(0),O(1)],[Wc[t.track.source._codec](t)]),bc=n=>R("vttC",[...K.encode(n.info.config.description)]);var kc=n=>W("stts",0,0,[C(n.timeToSampleTable.length),n.timeToSampleTable.map(t=>[C(t.sampleCount),C(t.sampleDelta)])]),Tc=n=>{if(n.samples.every(e=>e.type==="key"))return null;let t=[...n.samples.entries()].filter(([,e])=>e.type==="key");return W("stss",0,0,[C(t.length),t.map(([e])=>C(e+1))])},wc=n=>W("stsc",0,0,[C(n.compactlyCodedChunkTable.length),n.compactlyCodedChunkTable.map(t=>[C(t.firstChunk),C(t.samplesPerChunk),C(1)])]),yc=n=>{if(n.type==="audio"&&n.info.requiresPcmTransformation){let{sampleSize:t}=se(n.track.source._codec);return W("stsz",0,0,[C(t*n.info.numberOfChannels),C(n.samples.reduce((e,r)=>e+ne(r.duration,n.timescale),0))])}return W("stsz",0,0,[C(0),C(n.samples.length),n.samples.map(t=>C(t.size))])},Sc=n=>n.finalizedChunks.length>0&&H(n.finalizedChunks).offset>=2**32?W("co64",0,0,[C(n.finalizedChunks.length),n.finalizedChunks.map(t=>St(t.offset))]):W("stco",0,0,[C(n.finalizedChunks.length),n.finalizedChunks.map(t=>C(t.offset))]),xc=n=>W("ctts",1,0,[C(n.compositionTimeOffsetTable.length),n.compositionTimeOffsetTable.map(t=>[C(t.sampleCount),ft(t.sampleCompositionTimeOffset)])]),Cc=n=>{let t=1/0,e=-1/0,r=1/0,i=-1/0;p(n.compositionTimeOffsetTable.length>0),p(n.samples.length>0);for(let o=0;o<n.compositionTimeOffsetTable.length;o++){let s=n.compositionTimeOffsetTable[o];t=Math.min(t,s.sampleCompositionTimeOffset),e=Math.max(e,s.sampleCompositionTimeOffset)}for(let o=0;o<n.samples.length;o++){let s=n.samples[o];r=Math.min(r,ne(s.timestamp,n.timescale)),i=Math.max(i,ne(s.timestamp+s.duration,n.timescale))}let a=Math.max(-t,0);return i>=2**31?null:W("cslg",0,0,[ft(a),ft(t),ft(e),ft(r),ft(i)])},Pc=n=>R("mvex",void 0,n.map(vc)),vc=n=>W("trex",0,0,[C(n.track.id),C(1),C(0),C(0),C(0)]),Ni=(n,t)=>R("moof",void 0,[Ic(n),...t.map(Ec)]),Ic=n=>W("mfhd",0,0,[C(n)]),vs=n=>{let t=0,e=0,r=0,i=0,a=n.type==="delta";return e|=+a,a?t|=1:t|=2,t<<24|e<<16|r<<8|i},Ec=n=>R("traf",void 0,[_c(n),Ac(n),Fc(n)]),_c=n=>{p(n.currentChunk);let t=0;t|=8,t|=16,t|=32,t|=131072;let e=n.currentChunk.samples[1]??n.currentChunk.samples[0],r={duration:e.timescaleUnitsToNextSample,size:e.size,flags:vs(e)};return W("tfhd",0,t,[C(n.track.id),C(r.duration),C(r.size),C(r.flags)])},Ac=n=>(p(n.currentChunk),W("tfdt",1,0,[St(ne(n.currentChunk.startTimestamp,n.timescale))])),Fc=n=>{p(n.currentChunk);let t=n.currentChunk.samples.map(b=>b.timescaleUnitsToNextSample),e=n.currentChunk.samples.map(b=>b.size),r=n.currentChunk.samples.map(vs),i=n.currentChunk.samples.map(b=>ne(b.timestamp-b.decodeTimestamp,n.timescale)),a=new Set(t),o=new Set(e),s=new Set(r),c=new Set(i),u=s.size===2&&r[0]!==r[1],d=a.size>1,l=o.size>1,m=!u&&s.size>1,f=c.size>1||[...c].some(b=>b!==0),h=0;return h|=1,h|=4*+u,h|=256*+d,h|=512*+l,h|=1024*+m,h|=2048*+f,W("trun",1,h,[C(n.currentChunk.samples.length),C(n.currentChunk.offset-n.currentChunk.moofOffset||0),u?C(r[0]):[],n.currentChunk.samples.map((b,g)=>[d?C(t[g]):[],l?C(e[g]):[],m?C(r[g]):[],f?ft(i[g]):[]])])},Is=n=>R("mfra",void 0,[...n.map(Mc),Oc()]),Mc=(n,t)=>W("tfra",1,0,[C(n.track.id),C(63),C(n.finalizedChunks.length),n.finalizedChunks.map(r=>[St(ne(r.samples[0].timestamp,n.timescale)),St(r.moofOffset),C(t+1),C(1),C(1)])]),Oc=()=>W("mfro",0,0,[C(0)]),Es=()=>R("vtte"),_s=(n,t,e,r,i)=>R("vttc",void 0,[i!==null?R("vsid",[ft(i)]):null,e!==null?R("iden",[...K.encode(e)]):null,t!==null?R("ctim",[...K.encode(mn(t))]):null,r!==null?R("sttg",[...K.encode(r)]):null,R("payl",[...K.encode(n)])]),As=n=>R("vtta",[...K.encode(n)]),Rc=n=>{let t=[];if(n.isQuickTime)Dc(t,n.output._metadataTags);else{let e=Bc(n.output._metadataTags);e&&t.push(e)}return t.length===0?null:R("udta",void 0,t)},Dc=(n,t)=>{for(let{key:e,value:r}of _e(t))switch(e){case"title":n.push(We("\xA9nam",r));break;case"description":n.push(We("\xA9des",r));break;case"artist":n.push(We("\xA9ART",r));break;case"album":n.push(We("\xA9alb",r));break;case"albumArtist":n.push(We("albr",r));break;case"genre":n.push(We("\xA9gen",r));break;case"date":n.push(We("\xA9day",r.toISOString().slice(0,10)));break;case"comment":n.push(We("\xA9cmt",r));break;case"lyrics":n.push(We("\xA9lyr",r));break;case"raw":break;case"discNumber":case"discsTotal":case"trackNumber":case"tracksTotal":case"images":break;default:Y(e)}if(t.raw)for(let e in t.raw){let r=t.raw[e];r==null||e.length!==4||n.some(i=>i.type===e)||(typeof r=="string"?n.push(We(e,r)):r instanceof Uint8Array&&n.push(R(e,Array.from(r))))}},We=(n,t)=>{let e=K.encode(t);return R(n,[O(e.length),O(Ms("und")),Array.from(e)])},bs={"image/jpeg":13,"image/png":14,"image/bmp":27},Bc=n=>{let t=[];for(let{key:e,value:r}of _e(n))switch(e){case"title":t.push(Le("\xA9nam",r));break;case"description":t.push(Le("\xA9des",r));break;case"artist":t.push(Le("\xA9ART",r));break;case"album":t.push(Le("\xA9alb",r));break;case"albumArtist":t.push(Le("aART",r));break;case"comment":t.push(Le("\xA9cmt",r));break;case"genre":t.push(Le("\xA9gen",r));break;case"lyrics":t.push(Le("\xA9lyr",r));break;case"date":t.push(Le("\xA9day",r.toISOString().slice(0,10)));break;case"images":for(let i of r)i.kind==="coverFront"&&t.push(R("covr",void 0,[R("data",[C(bs[i.mimeType]??0),C(0),Array.from(i.data)])]));break;case"trackNumber":t.push(R("trkn",void 0,[R("data",[C(0),C(0),O(0),O(r),O(n.tracksTotal??0),O(0)])]));break;case"discNumber":t.push(R("disc",void 0,[R("data",[C(0),C(0),O(0),O(r),O(n.discsTotal??0),O(0)])]));break;case"tracksTotal":case"discsTotal":break;case"raw":break;default:Y(e)}if(n.raw)for(let e in n.raw){let r=n.raw[e];r==null||e.length!==4||t.some(i=>i.type===e)||(typeof r=="string"?t.push(Le(e,r)):r instanceof Uint8Array?t.push(R(e,void 0,[R("data",[C(0),C(0),Array.from(r)])])):r instanceof Pe&&t.push(R(e,void 0,[R("data",[C(bs[r.mimeType]??0),C(0),Array.from(r.data)])])))}return t.length===0?null:W("meta",0,0,void 0,[Ps(!1,"mdir","","appl"),R("ilst",void 0,t)])},Le=(n,t)=>R(n,void 0,[R("data",[C(1),C(0),...K.encode(t)])]),Vc={avc:"avc1",hevc:"hvc1",vp8:"vp08",vp9:"vp09",av1:"av01"},zc={avc:cc,hevc:uc,vp8:gs,vp9:gs,av1:dc},Fs=(n,t)=>{switch(n){case"aac":return"mp4a";case"mp3":return"mp4a";case"opus":return"Opus";case"vorbis":return"mp4a";case"flac":return"fLaC";case"ulaw":return"ulaw";case"alaw":return"alaw";case"pcm-u8":return"raw ";case"pcm-s8":return"sowt"}if(t)switch(n){case"pcm-s16":return"sowt";case"pcm-s16be":return"twos";case"pcm-s24":return"in24";case"pcm-s24be":return"in24";case"pcm-s32":return"in32";case"pcm-s32be":return"in32";case"pcm-f32":return"fl32";case"pcm-f32be":return"fl32";case"pcm-f64":return"fl64";case"pcm-f64be":return"fl64"}else switch(n){case"pcm-s16":return"ipcm";case"pcm-s16be":return"ipcm";case"pcm-s24":return"ipcm";case"pcm-s24be":return"ipcm";case"pcm-s32":return"ipcm";case"pcm-s32be":return"ipcm";case"pcm-f32":return"fpcm";case"pcm-f32be":return"fpcm";case"pcm-f64":return"fpcm";case"pcm-f64be":return"fpcm"}},Uc=(n,t)=>{switch(n){case"aac":return zi;case"mp3":return zi;case"opus":return pc;case"vorbis":return zi;case"flac":return hc}if(t)switch(n){case"pcm-s24":return mt;case"pcm-s24be":return mt;case"pcm-s32":return mt;case"pcm-s32be":return mt;case"pcm-f32":return mt;case"pcm-f32be":return mt;case"pcm-f64":return mt;case"pcm-f64be":return mt}else switch(n){case"pcm-s16":return Ne;case"pcm-s16be":return Ne;case"pcm-s24":return Ne;case"pcm-s24be":return Ne;case"pcm-s32":return Ne;case"pcm-s32be":return Ne;case"pcm-f32":return Ne;case"pcm-f32be":return Ne;case"pcm-f64":return Ne;case"pcm-f64be":return Ne}return null},Nc={webvtt:"wvtt"},Wc={webvtt:bc},Ms=n=>{p(n.length===3);let t=0;for(let e=0;e<3;e++)t<<=5,t+=n.charCodeAt(e)-96;return t};var br=class{constructor(){this.ensureMonotonicity=!1;this.trackedWrites=null;this.trackedStart=-1;this.trackedEnd=-1}start(){}maybeTrackWrites(t){if(!this.trackedWrites)return;let e=this.getPos();if(e<this.trackedStart){if(e+t.byteLength<=this.trackedStart)return;t=t.subarray(this.trackedStart-e),e=0}let r=e+t.byteLength-this.trackedStart,i=this.trackedWrites.byteLength;for(;i<r;)i*=2;if(i!==this.trackedWrites.byteLength){let a=new Uint8Array(i);a.set(this.trackedWrites,0),this.trackedWrites=a}this.trackedWrites.set(t,e-this.trackedStart),this.trackedEnd=Math.max(this.trackedEnd,e+t.byteLength)}startTrackingWrites(){this.trackedWrites=new Uint8Array(2**10),this.trackedStart=this.getPos(),this.trackedEnd=this.trackedStart}stopTrackingWrites(){if(!this.trackedWrites)throw new Error("Internal error: Can't get tracked writes since nothing was tracked.");let e={data:this.trackedWrites.subarray(0,this.trackedEnd-this.trackedStart),start:this.trackedStart,end:this.trackedEnd};return this.trackedWrites=null,e}},Wi=2**16,Li=2**32,Rt=class extends br{constructor(e){super();this.pos=0;this.maxPos=0;if(this.target=e,this.supportsResize="resize"in new ArrayBuffer(0),this.supportsResize)try{this.buffer=new ArrayBuffer(Wi,{maxByteLength:Li})}catch{this.buffer=new ArrayBuffer(Wi),this.supportsResize=!1}else this.buffer=new ArrayBuffer(Wi);this.bytes=new Uint8Array(this.buffer)}ensureSize(e){let r=this.buffer.byteLength;for(;r<e;)r*=2;if(r!==this.buffer.byteLength){if(r>Li)throw new Error(`ArrayBuffer exceeded maximum size of ${Li} bytes. Please consider using another target.`);if(this.supportsResize)this.buffer.resize(r);else{let i=new ArrayBuffer(r),a=new Uint8Array(i);a.set(this.bytes,0),this.buffer=i,this.bytes=a}}}write(e){this.maybeTrackWrites(e),this.ensureSize(this.pos+e.byteLength),this.bytes.set(e,this.pos),this.target.onwrite?.(this.pos,this.pos+e.byteLength),this.pos+=e.byteLength,this.maxPos=Math.max(this.maxPos,this.pos)}seek(e){this.pos=e}getPos(){return this.pos}async flush(){}async finalize(){this.ensureSize(this.pos),this.target.buffer=this.buffer.slice(0,Math.max(this.maxPos,this.pos))}async close(){}getSlice(e,r){return this.bytes.slice(e,r)}},Lc=2**24,Hc=2,yn=class extends br{constructor(e){super();this.pos=0;this.sections=[];this.lastWriteEnd=0;this.lastFlushEnd=0;this.writer=null;this.chunks=[];this.target=e,this.chunked=e._options.chunked??!1,this.chunkSize=e._options.chunkSize??Lc}start(){this.writer=this.target._writable.getWriter()}write(e){if(this.pos>this.lastWriteEnd){let r=this.pos-this.lastWriteEnd;this.pos=this.lastWriteEnd,this.write(new Uint8Array(r))}this.maybeTrackWrites(e),this.sections.push({data:e.slice(),start:this.pos}),this.target.onwrite?.(this.pos,this.pos+e.byteLength),this.pos+=e.byteLength,this.lastWriteEnd=Math.max(this.lastWriteEnd,this.pos)}seek(e){this.pos=e}getPos(){return this.pos}async flush(){if(this.pos>this.lastWriteEnd){let i=this.pos-this.lastWriteEnd;this.pos=this.lastWriteEnd,this.write(new Uint8Array(i))}if(p(this.writer),this.sections.length===0)return;let e=[],r=[...this.sections].sort((i,a)=>i.start-a.start);e.push({start:r[0].start,size:r[0].data.byteLength});for(let i=1;i<r.length;i++){let a=e[e.length-1],o=r[i];o.start<=a.start+a.size?a.size=Math.max(a.size,o.start+o.data.byteLength-a.start):e.push({start:o.start,size:o.data.byteLength})}for(let i of e){i.data=new Uint8Array(i.size);for(let a of this.sections)i.start<=a.start&&a.start<i.start+i.size&&i.data.set(a.data,a.start-i.start);if(this.writer.desiredSize!==null&&this.writer.desiredSize<=0&&await this.writer.ready,this.chunked)this.writeDataIntoChunks(i.data,i.start),this.tryToFlushChunks();else{if(this.ensureMonotonicity&&i.start!==this.lastFlushEnd)throw new Error("Internal error: Monotonicity violation.");this.writer.write({type:"write",data:i.data,position:i.start}),this.lastFlushEnd=i.start+i.data.byteLength}}this.sections.length=0}writeDataIntoChunks(e,r){let i=this.chunks.findIndex(u=>u.start<=r&&r<u.start+this.chunkSize);i===-1&&(i=this.createChunk(r));let a=this.chunks[i],o=r-a.start,s=e.subarray(0,Math.min(this.chunkSize-o,e.byteLength));a.data.set(s,o);let c={start:o,end:o+s.byteLength};if(this.insertSectionIntoChunk(a,c),a.written[0].start===0&&a.written[0].end===this.chunkSize&&(a.shouldFlush=!0),this.chunks.length>Hc){for(let u=0;u<this.chunks.length-1;u++)this.chunks[u].shouldFlush=!0;this.tryToFlushChunks()}s.byteLength<e.byteLength&&this.writeDataIntoChunks(e.subarray(s.byteLength),r+s.byteLength)}insertSectionIntoChunk(e,r){let i=0,a=e.written.length-1,o=-1;for(;i<=a;){let s=Math.floor(i+(a-i+1)/2);e.written[s].start<=r.start?(i=s+1,o=s):a=s-1}for(e.written.splice(o+1,0,r),(o===-1||e.written[o].end<r.start)&&o++;o<e.written.length-1&&e.written[o].end>=e.written[o+1].start;)e.written[o].end=Math.max(e.written[o].end,e.written[o+1].end),e.written.splice(o+1,1)}createChunk(e){let i={start:Math.floor(e/this.chunkSize)*this.chunkSize,data:new Uint8Array(this.chunkSize),written:[],shouldFlush:!1};return this.chunks.push(i),this.chunks.sort((a,o)=>a.start-o.start),this.chunks.indexOf(i)}tryToFlushChunks(e=!1){p(this.writer);for(let r=0;r<this.chunks.length;r++){let i=this.chunks[r];if(!(!i.shouldFlush&&!e)){for(let a of i.written){let o=i.start+a.start;if(this.ensureMonotonicity&&o!==this.lastFlushEnd)throw new Error("Internal error: Monotonicity violation.");this.writer.write({type:"write",data:i.data.subarray(a.start,a.end),position:o}),this.lastFlushEnd=i.start+a.end}this.chunks.splice(r--,1)}}}finalize(){return this.chunked&&this.tryToFlushChunks(!0),p(this.writer),this.writer.close()}async close(){return this.writer?.close()}},Sn=class extends br{constructor(e){super();this.target=e;this.pos=0}write(e){this.maybeTrackWrites(e),this.target.onwrite?.(this.pos,this.pos+e.byteLength),this.pos+=e.byteLength}getPos(){return this.pos}seek(e){this.pos=e}async flush(){}async finalize(){}async close(){}};var pt=class{constructor(){this._output=null;this.onwrite=null}},kr=class extends pt{constructor(){super(...arguments);this.buffer=null}_createWriter(){return new Rt(this)}},Hi=class extends pt{constructor(t,e={}){if(super(),!(t instanceof WritableStream))throw new TypeError("StreamTarget requires a WritableStream instance.");if(e!=null&&typeof e!="object")throw new TypeError("StreamTarget options, when provided, must be an object.");if(e.chunked!==void 0&&typeof e.chunked!="boolean")throw new TypeError("options.chunked, when provided, must be a boolean.");if(e.chunkSize!==void 0&&(!Number.isInteger(e.chunkSize)||e.chunkSize<1024))throw new TypeError("options.chunkSize, when provided, must be an integer and not smaller than 1024.");this._writable=t,this._options=e}_createWriter(){return new yn(this)}},Tr=class extends pt{_createWriter(){return new Sn(this)}};var xn=n=>{let e=(n.hasVideo?"video/":n.hasAudio?"audio/":"application/")+(n.isQuickTime?"quicktime":"mp4");if(n.codecStrings.length>0){let r=[...new Set(n.codecStrings)];e+=`; codecs="${r.join(", ")}"`}return e};var Cn=class{constructor(t){this.source=t}requestSlice(t,e){if(this.fileSize!==null&&t+e>this.fileSize)return null;let r=t+e,i=this.source._read(t,r);return i instanceof Promise?i.then(a=>a?new Dt(a.bytes,a.view,a.offset,t,r):null):i?new Dt(i.bytes,i.view,i.offset,t,r):null}requestSliceRange(t,e,r){if(this.fileSize!==null)return this.requestSlice(t,ee(this.fileSize-t,e,r));{let i=this.requestSlice(t,r),a=o=>{if(o)return o;let s=u=>(p(u!==null),this.requestSlice(t,ee(u-t,e,r))),c=this.source._retrieveSize();return c instanceof Promise?c.then(s):s(c)};return i instanceof Promise?i.then(a):a(i)}}},Dt=class n{constructor(t,e,r,i,a){this.bytes=t;this.view=e;this.offset=r;this.start=i;this.end=a;this.bufferPos=i-r}static tempFromBytes(t){return new n(t,V(t),0,0,t.length)}get length(){return this.end-this.start}get filePos(){return this.offset+this.bufferPos}set filePos(t){this.bufferPos=t-this.offset}skip(t){this.bufferPos+=t}slice(t,e=this.end-t){if(t<this.start||t+e>this.end)throw new RangeError("Slicing outside of original slice.");return new n(this.bytes,this.view,this.offset,t,t+e)}},D=(n,t)=>{let e=n.bytes.subarray(n.bufferPos,n.bufferPos+t);return n.bufferPos+=t,e},M=n=>n.view.getUint8(n.bufferPos++),Bt=(n,t)=>{let e=n.view.getUint16(n.bufferPos,t);return n.bufferPos+=2,e},de=n=>{let t=n.view.getUint16(n.bufferPos,!1);return n.bufferPos+=2,t},Vt=n=>{let t=de(n),e=M(n);return t*256+e},wr=n=>{let t=n.view.getInt16(n.bufferPos,!1);return n.bufferPos+=2,t},tt=(n,t)=>{let e=n.view.getUint32(n.bufferPos,t);return n.bufferPos+=4,e},v=n=>{let t=n.view.getUint32(n.bufferPos,!1);return n.bufferPos+=4,t},xt=n=>{let t=n.view.getUint32(n.bufferPos,!0);return n.bufferPos+=4,t},rt=n=>{let t=n.view.getInt32(n.bufferPos,!1);return n.bufferPos+=4,t},qc=n=>{let t=n.view.getInt32(n.bufferPos,!0);return n.bufferPos+=4,t},qi=(n,t)=>{let e,r;return t?(e=tt(n,!0),r=tt(n,!0)):(r=tt(n,!1),e=tt(n,!1)),r*4294967296+e},Se=n=>{let t=v(n),e=v(n);return t*4294967296+e},Rs=n=>{let t=rt(n),e=v(n);return t*4294967296+e},Ds=n=>{let t=xt(n);return qc(n)*4294967296+t},Bs=n=>{let t=n.view.getFloat32(n.bufferPos,!1);return n.bufferPos+=4,t},Pn=n=>{let t=n.view.getFloat64(n.bufferPos,!1);return n.bufferPos+=8,t},J=(n,t)=>{if(n.bufferPos+t>n.bytes.length)throw new RangeError("Reading past end of slice.");let e="";for(let r=0;r<t;r++)e+=String.fromCharCode(n.bytes[n.bufferPos++]);return e};var xe=8,qe=16,Ke=n=>{let t=v(n),e=J(n,4),r=8;t===1&&(t=Se(n),r=16);let a=t-r;return a<0?null:{name:e,totalSize:t,headerSize:r,contentSize:a}},ht=n=>rt(n)/65536,vn=n=>rt(n)/1073741824,In=n=>{let t=0;for(let e=0;e<4;e++){t<<=7;let r=M(n);if(t|=r&127,(r&128)===0)break}return t},Fe=n=>{let t=de(n);return n.skip(2),fe.decode(D(n,t))},Vs=n=>{let t=Ke(n);if(!t||t.name!=="data")return null;let e=v(n);n.skip(4);let r=D(n,t.contentSize-8);switch(e){case 1:return fe.decode(r);case 2:return new TextDecoder("utf-16be").decode(r);case 13:return new Pe(r,"image/jpeg");case 14:return new Pe(r,"image/png");case 27:return new Pe(r,"image/bmp");default:return r}};var Tn=1e3,Kc=2082844800,Os=n=>{let t={},e=n.track;return e.metadata.name!==void 0&&(t.name=e.metadata.name),t},ne=(n,t,e=!0)=>{let r=n*t;return e?Math.round(r):r},En=class extends he{constructor(e,r){super(e);this.auxTarget=new kr;this.auxWriter=this.auxTarget._createWriter();this.auxBoxWriter=new hr(this.auxWriter);this.mdat=null;this.trackDatas=[];this.allTracksKnown=q();this.creationTime=Math.floor(Date.now()/1e3)+Kc;this.finalizedChunks=[];this.nextFragmentNumber=1;this.maxWrittenTimestamp=-1/0;this.format=r,this.writer=e._writer,this.boxWriter=new hr(this.writer),this.isQuickTime=r instanceof zt;let i=this.writer instanceof Rt?"in-memory":!1;this.fastStart=r._options.fastStart??i,this.isFragmented=this.fastStart==="fragmented",(this.fastStart==="in-memory"||this.isFragmented)&&(this.writer.ensureMonotonicity=!0),this.minimumFragmentDuration=r._options.minimumFragmentDuration??1}async start(){let e=await this.mutex.acquire(),r=this.output._tracks.some(i=>i.type==="video"&&i.source._codec==="avc");if(this.format._options.onFtyp&&this.writer.startTrackingWrites(),this.boxWriter.writeBox(Cs({isQuickTime:this.isQuickTime,holdsAvc:r,fragmented:this.isFragmented})),this.format._options.onFtyp){let{data:i,start:a}=this.writer.stopTrackingWrites();this.format._options.onFtyp(i,a)}this.fastStart==="in-memory"?this.mdat=wn(!1):this.isFragmented||(this.format._options.onMdat&&this.writer.startTrackingWrites(),this.mdat=wn(!0),this.boxWriter.writeBox(this.mdat)),await this.writer.flush(),e()}allTracksAreKnown(){for(let e of this.output._tracks)if(!e.source._closed&&!this.trackDatas.some(r=>r.track===e))return!1;return!0}async getMimeType(){await this.allTracksKnown.promise;let e=this.trackDatas.map(r=>r.type==="video"||r.type==="audio"?r.info.decoderConfig.codec:{webvtt:"wvtt"}[r.track.source._codec]);return xn({isQuickTime:this.isQuickTime,hasVideo:this.trackDatas.some(r=>r.type==="video"),hasAudio:this.trackDatas.some(r=>r.type==="audio"),codecStrings:e})}getVideoTrackData(e,r,i){let a=this.trackDatas.find(d=>d.track===e);if(a)return a;on(i),p(i),p(i.decoderConfig);let o={...i.decoderConfig};p(o.codedWidth!==void 0),p(o.codedHeight!==void 0);let s=!1;if(e.source._codec==="avc"&&!o.description){let d=pn(r.data);if(!d)throw new Error("Couldn't extract an AVCDecoderConfigurationRecord from the AVC packet. Make sure the packets are in Annex B format (as specified in ITU-T-REC-H.264) when not providing a description, or provide a description (must be an AVCDecoderConfigurationRecord as specified in ISO 14496-15) and ensure the packets are in AVCC format.");o.description=ls(d),s=!0}else if(e.source._codec==="hevc"&&!o.description){let d=hn(r.data);if(!d)throw new Error("Couldn't extract an HEVCDecoderConfigurationRecord from the HEVC packet. Make sure the packets are in Annex B format (as specified in ITU-T-REC-H.265) when not providing a description, or provide a description (must be an HEVCDecoderConfigurationRecord as specified in ISO 14496-15) and ensure the packets are in HEVC format.");o.description=ms(d),s=!0}let c=$a(1/(e.metadata.frameRate??57600),1e6).denominator,u={muxer:this,track:e,type:"video",info:{width:o.codedWidth,height:o.codedHeight,decoderConfig:o,requiresAnnexBTransformation:s},timescale:c,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[]};return this.trackDatas.push(u),this.trackDatas.sort((d,l)=>d.track.id-l.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),u}getAudioTrackData(e,r){let i=this.trackDatas.find(o=>o.track===e);if(i)return i;Ue(r),p(r),p(r.decoderConfig);let a={muxer:this,track:e,type:"audio",info:{numberOfChannels:r.decoderConfig.numberOfChannels,sampleRate:r.decoderConfig.sampleRate,decoderConfig:r.decoderConfig,requiresPcmTransformation:!this.isFragmented&&j.includes(e.source._codec)},timescale:r.decoderConfig.sampleRate,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[]};return this.trackDatas.push(a),this.trackDatas.sort((o,s)=>o.track.id-s.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),a}getSubtitleTrackData(e,r){let i=this.trackDatas.find(o=>o.track===e);if(i)return i;cn(r),p(r),p(r.config);let a={muxer:this,track:e,type:"subtitle",info:{config:r.config},timescale:1e3,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[],lastCueEndTimestamp:0,cueQueue:[],nextSourceId:0,cueToSourceId:new WeakMap};return this.trackDatas.push(a),this.trackDatas.sort((o,s)=>o.track.id-s.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),a}async addEncodedVideoPacket(e,r,i){let a=await this.mutex.acquire();try{let o=this.getVideoTrackData(e,r,i),s=r.data;if(o.info.requiresAnnexBTransformation){let d=ds(s);if(!d)throw new Error("Failed to transform packet data. Make sure all packets are provided in Annex B format, as specified in ITU-T-REC-H.264 and ITU-T-REC-H.265.");s=d}let c=this.validateAndNormalizeTimestamp(o.track,r.timestamp,r.type==="key"),u=this.createSampleForTrack(o,s,c,r.duration,r.type);await this.registerSample(o,u)}finally{a()}}async addEncodedAudioPacket(e,r,i){let a=await this.mutex.acquire();try{let o=this.getAudioTrackData(e,i),s=this.validateAndNormalizeTimestamp(o.track,r.timestamp,r.type==="key"),c=this.createSampleForTrack(o,r.data,s,r.duration,r.type);o.info.requiresPcmTransformation&&await this.maybePadWithSilence(o,s),await this.registerSample(o,c)}finally{a()}}async maybePadWithSilence(e,r){let i=H(e.samples),a=i?i.timestamp+i.duration:0,o=r-a,s=ne(o,e.timescale);if(s>0){let{sampleSize:c,silentValue:u}=se(e.info.decoderConfig.codec),d=s*e.info.numberOfChannels,l=new Uint8Array(c*d).fill(u),m=this.createSampleForTrack(e,new Uint8Array(l.buffer),a,o,"key");await this.registerSample(e,m)}}async addSubtitleCue(e,r,i){let a=await this.mutex.acquire();try{let o=this.getSubtitleTrackData(e,i);this.validateAndNormalizeTimestamp(o.track,r.timestamp,!0),e.source._codec==="webvtt"&&(o.cueQueue.push(r),await this.processWebVTTCues(o,r.timestamp))}finally{a()}}async processWebVTTCues(e,r){for(;e.cueQueue.length>0;){let i=new Set([]);for(let d of e.cueQueue)p(d.timestamp<=r),p(e.lastCueEndTimestamp<=d.timestamp+d.duration),i.add(Math.max(d.timestamp,e.lastCueEndTimestamp)),i.add(d.timestamp+d.duration);let a=[...i].sort((d,l)=>d-l),o=a[0],s=a[1]??o;if(r<s)break;if(e.lastCueEndTimestamp<o){this.auxWriter.seek(0);let d=Es();this.auxBoxWriter.writeBox(d);let l=this.auxWriter.getSlice(0,this.auxWriter.getPos()),m=this.createSampleForTrack(e,l,e.lastCueEndTimestamp,o-e.lastCueEndTimestamp,"key");await this.registerSample(e,m),e.lastCueEndTimestamp=o}this.auxWriter.seek(0);for(let d=0;d<e.cueQueue.length;d++){let l=e.cueQueue[d];if(l.timestamp>=s)break;Ot.lastIndex=0;let m=Ot.test(l.text),f=l.timestamp+l.duration,h=e.cueToSourceId.get(l);if(h===void 0&&s<f&&(h=e.nextSourceId++,e.cueToSourceId.set(l,h)),l.notes){let g=As(l.notes);this.auxBoxWriter.writeBox(g)}let b=_s(l.text,m?o:null,l.identifier??null,l.settings??null,h??null);this.auxBoxWriter.writeBox(b),f===s&&e.cueQueue.splice(d--,1)}let c=this.auxWriter.getSlice(0,this.auxWriter.getPos()),u=this.createSampleForTrack(e,c,o,s-o,"key");await this.registerSample(e,u),e.lastCueEndTimestamp=s}}createSampleForTrack(e,r,i,a,o){return{timestamp:i,decodeTimestamp:i,duration:a,data:r,size:r.byteLength,type:o,timescaleUnitsToNextSample:ne(a,e.timescale)}}processTimestamps(e,r){if(e.timestampProcessingQueue.length===0)return;if(e.type==="audio"&&e.info.requiresPcmTransformation){let a=0;for(let o=0;o<e.timestampProcessingQueue.length;o++){let s=e.timestampProcessingQueue[o],c=ne(s.duration,e.timescale);a+=c}if(e.timeToSampleTable.length===0)e.timeToSampleTable.push({sampleCount:a,sampleDelta:1});else{let o=H(e.timeToSampleTable);o.sampleCount+=a}e.timestampProcessingQueue.length=0;return}let i=e.timestampProcessingQueue.map(a=>a.timestamp).sort((a,o)=>a-o);for(let a=0;a<e.timestampProcessingQueue.length;a++){let o=e.timestampProcessingQueue[a];o.decodeTimestamp=i[a],!this.isFragmented&&e.lastTimescaleUnits===null&&(o.decodeTimestamp=0);let s=ne(o.timestamp-o.decodeTimestamp,e.timescale),c=ne(o.duration,e.timescale);if(e.lastTimescaleUnits!==null){p(e.lastSample);let u=ne(o.decodeTimestamp,e.timescale,!1),d=Math.round(u-e.lastTimescaleUnits);if(p(d>=0),e.lastTimescaleUnits+=d,e.lastSample.timescaleUnitsToNextSample=d,!this.isFragmented){let l=H(e.timeToSampleTable);if(p(l),l.sampleCount===1){l.sampleDelta=d;let f=e.timeToSampleTable[e.timeToSampleTable.length-2];f&&f.sampleDelta===d&&(f.sampleCount++,e.timeToSampleTable.pop(),l=f)}else l.sampleDelta!==d&&(l.sampleCount--,e.timeToSampleTable.push(l={sampleCount:1,sampleDelta:d}));l.sampleDelta===c?l.sampleCount++:e.timeToSampleTable.push({sampleCount:1,sampleDelta:c});let m=H(e.compositionTimeOffsetTable);p(m),m.sampleCompositionTimeOffset===s?m.sampleCount++:e.compositionTimeOffsetTable.push({sampleCount:1,sampleCompositionTimeOffset:s})}}else e.lastTimescaleUnits=ne(o.decodeTimestamp,e.timescale,!1),this.isFragmented||(e.timeToSampleTable.push({sampleCount:1,sampleDelta:c}),e.compositionTimeOffsetTable.push({sampleCount:1,sampleCompositionTimeOffset:s}));e.lastSample=o}if(e.timestampProcessingQueue.length=0,p(e.lastSample),p(e.lastTimescaleUnits!==null),r!==void 0&&e.lastSample.timescaleUnitsToNextSample===0){p(r.type==="key");let a=ne(r.timestamp,e.timescale,!1),o=Math.round(a-e.lastTimescaleUnits);e.lastSample.timescaleUnitsToNextSample=o}}async registerSample(e,r){r.type==="key"&&this.processTimestamps(e,r),e.timestampProcessingQueue.push(r),this.isFragmented?(e.sampleQueue.push(r),await this.interleaveSamples()):await this.addSampleToTrack(e,r)}async addSampleToTrack(e,r){this.isFragmented||e.samples.push(r);let i=!1;if(!e.currentChunk)i=!0;else{e.currentChunk.startTimestamp=Math.min(e.currentChunk.startTimestamp,r.timestamp);let a=r.timestamp-e.currentChunk.startTimestamp;if(this.isFragmented){let o=this.trackDatas.every(s=>{if(e===s)return r.type==="key";let c=s.sampleQueue[0];return c?c.type==="key":s.track.source._closed});a>=this.minimumFragmentDuration&&o&&r.timestamp>this.maxWrittenTimestamp&&(i=!0,await this.finalizeFragment())}else i=a>=.5}i&&(e.currentChunk&&await this.finalizeCurrentChunk(e),e.currentChunk={startTimestamp:r.timestamp,samples:[],offset:null,moofOffset:null}),p(e.currentChunk),e.currentChunk.samples.push(r),this.isFragmented&&(this.maxWrittenTimestamp=Math.max(this.maxWrittenTimestamp,r.timestamp))}async finalizeCurrentChunk(e){if(p(!this.isFragmented),!e.currentChunk)return;e.finalizedChunks.push(e.currentChunk),this.finalizedChunks.push(e.currentChunk);let r=e.currentChunk.samples.length;if(e.type==="audio"&&e.info.requiresPcmTransformation&&(r=e.currentChunk.samples.reduce((i,a)=>i+ne(a.duration,e.timescale),0)),(e.compactlyCodedChunkTable.length===0||H(e.compactlyCodedChunkTable).samplesPerChunk!==r)&&e.compactlyCodedChunkTable.push({firstChunk:e.finalizedChunks.length,samplesPerChunk:r}),this.fastStart==="in-memory"){e.currentChunk.offset=0;return}e.currentChunk.offset=this.writer.getPos();for(let i of e.currentChunk.samples)p(i.data),this.writer.write(i.data),i.data=null;await this.writer.flush()}async interleaveSamples(e=!1){if(p(this.isFragmented),!(!e&&!this.allTracksAreKnown()))e:for(;;){let r=null,i=1/0;for(let o of this.trackDatas){if(!e&&o.sampleQueue.length===0&&!o.track.source._closed)break e;o.sampleQueue.length>0&&o.sampleQueue[0].timestamp<i&&(r=o,i=o.sampleQueue[0].timestamp)}if(!r)break;let a=r.sampleQueue.shift();await this.addSampleToTrack(r,a)}}async finalizeFragment(e=!0){p(this.isFragmented);let r=this.nextFragmentNumber++;if(r===1){this.format._options.onMoov&&this.writer.startTrackingWrites();let h=gr(this,!0);if(this.boxWriter.writeBox(h),this.format._options.onMoov){let{data:b,start:g}=this.writer.stopTrackingWrites();this.format._options.onMoov(b,g)}}let i=this.trackDatas.filter(h=>h.currentChunk),a=Ni(r,i),o=this.writer.getPos(),s=o+this.boxWriter.measureBox(a),c=s+xe,u=1/0;for(let h of i){h.currentChunk.offset=c,h.currentChunk.moofOffset=o;for(let b of h.currentChunk.samples)c+=b.size;u=Math.min(u,h.currentChunk.startTimestamp)}let d=c-s,l=d>=2**32;if(l)for(let h of i)h.currentChunk.offset+=qe-xe;this.format._options.onMoof&&this.writer.startTrackingWrites();let m=Ni(r,i);if(this.boxWriter.writeBox(m),this.format._options.onMoof){let{data:h,start:b}=this.writer.stopTrackingWrites();this.format._options.onMoof(h,b,u)}p(this.writer.getPos()===s),this.format._options.onMdat&&this.writer.startTrackingWrites();let f=wn(l);f.size=d,this.boxWriter.writeBox(f),this.writer.seek(s+(l?qe:xe));for(let h of i)for(let b of h.currentChunk.samples)this.writer.write(b.data),b.data=null;if(this.format._options.onMdat){let{data:h,start:b}=this.writer.stopTrackingWrites();this.format._options.onMdat(h,b)}for(let h of i)h.finalizedChunks.push(h.currentChunk),this.finalizedChunks.push(h.currentChunk),h.currentChunk=null;e&&await this.writer.flush()}async onTrackClose(e){let r=await this.mutex.acquire();if(e.type==="subtitle"&&e.source._codec==="webvtt"){let i=this.trackDatas.find(a=>a.track===e);i&&await this.processWebVTTCues(i,1/0)}this.allTracksAreKnown()&&this.allTracksKnown.resolve(),this.isFragmented&&await this.interleaveSamples(),r()}async finalize(){let e=await this.mutex.acquire();this.allTracksKnown.resolve();for(let r of this.trackDatas)r.type==="subtitle"&&r.track.source._codec==="webvtt"&&await this.processWebVTTCues(r,1/0);if(this.isFragmented){await this.interleaveSamples(!0);for(let r of this.trackDatas)this.processTimestamps(r);await this.finalizeFragment(!1)}else for(let r of this.trackDatas)this.processTimestamps(r),await this.finalizeCurrentChunk(r);if(this.fastStart==="in-memory"){p(this.mdat);let r;for(let a=0;a<2;a++){let o=gr(this),s=this.boxWriter.measureBox(o);r=this.boxWriter.measureBox(this.mdat);let c=this.writer.getPos()+s+r;for(let u of this.finalizedChunks){u.offset=c;for(let{data:d}of u.samples)p(d),c+=d.byteLength,r+=d.byteLength}if(c<2**32)break;r>=2**32&&(this.mdat.largeSize=!0)}this.format._options.onMoov&&this.writer.startTrackingWrites();let i=gr(this);if(this.boxWriter.writeBox(i),this.format._options.onMoov){let{data:a,start:o}=this.writer.stopTrackingWrites();this.format._options.onMoov(a,o)}this.format._options.onMdat&&this.writer.startTrackingWrites(),this.mdat.size=r,this.boxWriter.writeBox(this.mdat);for(let a of this.finalizedChunks)for(let o of a.samples)p(o.data),this.writer.write(o.data),o.data=null;if(this.format._options.onMdat){let{data:a,start:o}=this.writer.stopTrackingWrites();this.format._options.onMdat(a,o)}}else if(this.isFragmented){let r=this.writer.getPos(),i=Is(this.trackDatas);this.boxWriter.writeBox(i);let a=this.writer.getPos()-r;this.writer.seek(this.writer.getPos()-4),this.boxWriter.writeU32(a)}else{p(this.mdat);let r=this.boxWriter.offsets.get(this.mdat);p(r!==void 0);let i=this.writer.getPos()-r;if(this.mdat.size=i,this.mdat.largeSize=i>=2**32,this.boxWriter.patchBox(this.mdat),this.format._options.onMdat){let{data:o,start:s}=this.writer.stopTrackingWrites();this.format._options.onMdat(o,s)}this.format._options.onMoov&&this.writer.startTrackingWrites();let a=gr(this);if(this.boxWriter.writeBox(a),this.format._options.onMoov){let{data:o,start:s}=this.writer.stopTrackingWrites();this.format._options.onMoov(o,s)}}e()}};var Ut=class{constructor(t){this.value=t}},Nt=class{constructor(t){this.value=t}},yr=class{constructor(t){this.value=t}},nt=class{constructor(t){this.value=t}};var jc=[440786851,408125543],Wt=[290298740,357149030,524531317,374648427,475249515,423732329,272869232,307544935],An=[...jc,...Wt],zs=n=>n<256?1:n<65536?2:n<1<<24?3:n<2**32?4:n<2**40?5:6,Us=n=>n>=-64&&n<64?1:n>=-8192&&n<8192?2:n>=-(1<<20)&&n<1<<20?3:n>=-(1<<27)&&n<1<<27?4:n>=-(2**34)&&n<2**34?5:6,$c=n=>{if(n<127)return 1;if(n<16383)return 2;if(n<(1<<21)-1)return 3;if(n<(1<<28)-1)return 4;if(n<2**35-1)return 5;if(n<2**42-1)return 6;throw new Error("EBML varint size not supported "+n)},_n=class{constructor(t){this.writer=t;this.helper=new Uint8Array(8);this.helperView=new DataView(this.helper.buffer);this.offsets=new WeakMap;this.dataOffsets=new WeakMap}writeByte(t){this.helperView.setUint8(0,t),this.writer.write(this.helper.subarray(0,1))}writeFloat32(t){this.helperView.setFloat32(0,t,!1),this.writer.write(this.helper.subarray(0,4))}writeFloat64(t){this.helperView.setFloat64(0,t,!1),this.writer.write(this.helper)}writeUnsignedInt(t,e=zs(t)){let r=0;switch(e){case 6:this.helperView.setUint8(r++,t/2**40|0);case 5:this.helperView.setUint8(r++,t/2**32|0);case 4:this.helperView.setUint8(r++,t>>24);case 3:this.helperView.setUint8(r++,t>>16);case 2:this.helperView.setUint8(r++,t>>8);case 1:this.helperView.setUint8(r++,t);break;default:throw new Error("Bad unsigned int size "+e)}this.writer.write(this.helper.subarray(0,r))}writeSignedInt(t,e=Us(t)){t<0&&(t+=2**(e*8)),this.writeUnsignedInt(t,e)}writeVarInt(t,e=$c(t)){let r=0;switch(e){case 1:this.helperView.setUint8(r++,128|t);break;case 2:this.helperView.setUint8(r++,64|t>>8),this.helperView.setUint8(r++,t);break;case 3:this.helperView.setUint8(r++,32|t>>16),this.helperView.setUint8(r++,t>>8),this.helperView.setUint8(r++,t);break;case 4:this.helperView.setUint8(r++,16|t>>24),this.helperView.setUint8(r++,t>>16),this.helperView.setUint8(r++,t>>8),this.helperView.setUint8(r++,t);break;case 5:this.helperView.setUint8(r++,8|t/2**32&7),this.helperView.setUint8(r++,t>>24),this.helperView.setUint8(r++,t>>16),this.helperView.setUint8(r++,t>>8),this.helperView.setUint8(r++,t);break;case 6:this.helperView.setUint8(r++,4|t/2**40&3),this.helperView.setUint8(r++,t/2**32|0),this.helperView.setUint8(r++,t>>24),this.helperView.setUint8(r++,t>>16),this.helperView.setUint8(r++,t>>8),this.helperView.setUint8(r++,t);break;default:throw new Error("Bad EBML varint size "+e)}this.writer.write(this.helper.subarray(0,r))}writeAsciiString(t){this.writer.write(new Uint8Array(t.split("").map(e=>e.charCodeAt(0))))}writeEBML(t){if(t!==null)if(t instanceof Uint8Array)this.writer.write(t);else if(Array.isArray(t))for(let e of t)this.writeEBML(e);else if(this.offsets.set(t,this.writer.getPos()),this.writeUnsignedInt(t.id),Array.isArray(t.data)){let e=this.writer.getPos(),r=t.size===-1?1:t.size??4;t.size===-1?this.writeByte(255):this.writer.seek(this.writer.getPos()+r);let i=this.writer.getPos();if(this.dataOffsets.set(t,i),this.writeEBML(t.data),t.size!==-1){let a=this.writer.getPos()-i,o=this.writer.getPos();this.writer.seek(e),this.writeVarInt(a,r),this.writer.seek(o)}}else if(typeof t.data=="number"){let e=t.size??zs(t.data);this.writeVarInt(e),this.writeUnsignedInt(t.data,e)}else if(typeof t.data=="string")this.writeVarInt(t.data.length),this.writeAsciiString(t.data);else if(t.data instanceof Uint8Array)this.writeVarInt(t.data.byteLength,t.size),this.writer.write(t.data);else if(t.data instanceof Ut)this.writeVarInt(4),this.writeFloat32(t.data.value);else if(t.data instanceof Nt)this.writeVarInt(8),this.writeFloat64(t.data.value);else if(t.data instanceof yr){let e=t.size??Us(t.data.value);this.writeVarInt(e),this.writeSignedInt(t.data.value,e)}else if(t.data instanceof nt){let e=K.encode(t.data.value);this.writeVarInt(e.length),this.writer.write(e)}else Y(t.data)}},Ki=8,ge=2,Me=2*Ki,ji=n=>{let t=M(n);if(n.skip(-1),t===0)return null;let e=1,r=128;for(;(t&r)===0;)e++,r>>=1;return e},Lt=n=>{let t=M(n);if(t===0)return null;let e=1,r=128;for(;(t&r)===0;)e++,r>>=1;let i=t&r-1;for(let a=1;a<e;a++)i*=256,i+=M(n);return i},L=(n,t)=>{if(t<1||t>8)throw new Error("Bad unsigned int size "+t);let e=0;for(let r=0;r<t;r++)e*=256,e+=M(n);return e},Ns=(n,t)=>{let e=L(n,t);return e&1<<t*8-1&&(e-=2**(t*8)),e},Fn=n=>{let t=ji(n);return t===null?null:L(n,t)},$i=n=>{let t=M(n);return t===255?t=null:(n.skip(-1),t=Lt(n),t===72057594037927940&&(t=null)),t},Oe=n=>{let t=Fn(n);if(t===null)return null;let e=$i(n);return{id:t,size:e}},gt=(n,t)=>{let e=D(n,t),r=0;for(;r<t&&e[r]!==0;)r+=1;return String.fromCharCode(...e.subarray(0,r))},Ht=(n,t)=>{let e=D(n,t),r=0;for(;r<t&&e[r]!==0;)r+=1;return fe.decode(e.subarray(0,r))},Mn=(n,t)=>{if(t===0)return 0;if(t!==4&&t!==8)throw new Error("Bad float size "+t);return t===4?Bs(n):Pn(n)},On=async(n,t,e,r)=>{let i=new Set(e),a=t;for(;r===null||a<r;){let o=n.requestSliceRange(a,ge,Me);if(o instanceof Promise&&(o=await o),!o)break;let s=Oe(o);if(!s)break;if(i.has(s.id))return{pos:a,found:!0};it(s.size),a=o.filePos+s.size}return{pos:r!==null&&r>a?r:a,found:!1}},Qi=async(n,t,e,r)=>{let a=new Set(e),o=t;for(;o<r;){let s=n.requestSliceRange(o,0,Math.min(65536,r-o));if(s instanceof Promise&&(s=await s),!s||s.length<Ki)break;for(let c=0;c<s.length-Ki;c++){s.filePos=o;let u=Fn(s);if(u!==null&&a.has(u))return o;o++}}return null},Ce={avc:"V_MPEG4/ISO/AVC",hevc:"V_MPEGH/ISO/HEVC",vp8:"V_VP8",vp9:"V_VP9",av1:"V_AV1",aac:"A_AAC",mp3:"A_MPEG/L3",opus:"A_OPUS",vorbis:"A_VORBIS",flac:"A_FLAC","pcm-u8":"A_PCM/INT/LIT","pcm-s16":"A_PCM/INT/LIT","pcm-s16be":"A_PCM/INT/BIG","pcm-s24":"A_PCM/INT/LIT","pcm-s24be":"A_PCM/INT/BIG","pcm-s32":"A_PCM/INT/LIT","pcm-s32be":"A_PCM/INT/BIG","pcm-f32":"A_PCM/FLOAT/IEEE","pcm-f64":"A_PCM/FLOAT/IEEE",webvtt:"S_TEXT/WEBVTT"};function it(n){if(n===null)throw new Error("Undefined element size is used in a place where it is not supported.")}var Rn=n=>{let e=(n.hasVideo?"video/":n.hasAudio?"audio/":"application/")+(n.isWebM?"webm":"x-matroska");if(n.codecStrings.length>0){let r=[...new Set(n.codecStrings.filter(Boolean))];e+=`; codecs="${r.join(", ")}"`}return e};var Qc=-(2**15),Gc=2**15-1,Ws="Mediabunny",Ls=6,Hs=5,Xc={video:1,audio:2,subtitle:17},Dn=class extends he{constructor(e,r){super(e);this.trackDatas=[];this.allTracksKnown=q();this.segment=null;this.segmentInfo=null;this.seekHead=null;this.tracksElement=null;this.tagsElement=null;this.attachmentsElement=null;this.segmentDuration=null;this.cues=null;this.currentCluster=null;this.currentClusterStartMsTimestamp=null;this.currentClusterMaxMsTimestamp=null;this.trackDatasInCurrentCluster=new Map;this.duration=0;this.writer=e._writer,this.format=r,this.ebmlWriter=new _n(this.writer),this.format._options.appendOnly&&(this.writer.ensureMonotonicity=!0)}async start(){let e=await this.mutex.acquire();this.writeEBMLHeader(),this.createSegmentInfo(),this.createCues(),await this.writer.flush(),e()}writeEBMLHeader(){this.format._options.onEbmlHeader&&this.writer.startTrackingWrites();let e={id:440786851,data:[{id:17030,data:1},{id:17143,data:1},{id:17138,data:4},{id:17139,data:8},{id:17026,data:this.format instanceof qt?"webm":"matroska"},{id:17031,data:2},{id:17029,data:2}]};if(this.ebmlWriter.writeEBML(e),this.format._options.onEbmlHeader){let{data:r,start:i}=this.writer.stopTrackingWrites();this.format._options.onEbmlHeader(r,i)}}maybeCreateSeekHead(e){if(this.format._options.appendOnly)return;let r=new Uint8Array([28,83,187,107]),i=new Uint8Array([21,73,169,102]),a=new Uint8Array([22,84,174,107]),o=new Uint8Array([25,65,164,105]),s=new Uint8Array([18,84,195,103]),c={id:290298740,data:[{id:19899,data:[{id:21419,data:r},{id:21420,size:5,data:e?this.ebmlWriter.offsets.get(this.cues)-this.segmentDataOffset:0}]},{id:19899,data:[{id:21419,data:i},{id:21420,size:5,data:e?this.ebmlWriter.offsets.get(this.segmentInfo)-this.segmentDataOffset:0}]},{id:19899,data:[{id:21419,data:a},{id:21420,size:5,data:e?this.ebmlWriter.offsets.get(this.tracksElement)-this.segmentDataOffset:0}]},this.attachmentsElement?{id:19899,data:[{id:21419,data:o},{id:21420,size:5,data:e?this.ebmlWriter.offsets.get(this.attachmentsElement)-this.segmentDataOffset:0}]}:null,this.tagsElement?{id:19899,data:[{id:21419,data:s},{id:21420,size:5,data:e?this.ebmlWriter.offsets.get(this.tagsElement)-this.segmentDataOffset:0}]}:null]};this.seekHead=c}createSegmentInfo(){let e={id:17545,data:new Nt(0)};this.segmentDuration=e;let r={id:357149030,data:[{id:2807729,data:1e6},{id:19840,data:Ws},{id:22337,data:Ws},this.format._options.appendOnly?null:e]};this.segmentInfo=r}createTracks(){let e={id:374648427,data:[]};this.tracksElement=e;for(let r of this.trackDatas){let i=Ce[r.track.source._codec];p(i);let a=0;if(r.type==="audio"&&r.track.source._codec==="opus"){a=1e6*80;let o=r.info.decoderConfig.description;if(o){let s=Q(o),c=lt(s);a=Math.round(1e9*(c.preSkip/Ae))}}e.data.push({id:174,data:[{id:215,data:r.track.id},{id:29637,data:r.track.id},{id:131,data:Xc[r.type]},{id:156,data:0},{id:2274716,data:r.track.metadata.languageCode??te},{id:134,data:i},{id:22186,data:0},{id:22203,data:a},r.track.metadata.name!==void 0?{id:21358,data:new nt(r.track.metadata.name)}:null,r.type==="video"?this.videoSpecificTrackInfo(r):null,r.type==="audio"?this.audioSpecificTrackInfo(r):null,r.type==="subtitle"?this.subtitleSpecificTrackInfo(r):null]})}}videoSpecificTrackInfo(e){let{frameRate:r,rotation:i}=e.track.metadata,a=[e.info.decoderConfig.description?{id:25506,data:Q(e.info.decoderConfig.description)}:null,r?{id:2352003,data:1e9/r}:null],o=i?ut(-i):0,s=e.info.decoderConfig.colorSpace,c={id:224,data:[{id:176,data:e.info.width},{id:186,data:e.info.height},Xr(s)?{id:21936,data:[{id:21937,data:Ge[s.matrix]},{id:21946,data:Qe[s.transfer]},{id:21947,data:$e[s.primaries]},{id:21945,data:s.fullRange?2:1}]}:null,o?{id:30320,data:[{id:30321,data:0},{id:30325,data:new Ut((o+180)%360-180)}]}:null]};return a.push(c),a}audioSpecificTrackInfo(e){let r=j.includes(e.track.source._codec)?se(e.track.source._codec):null;return[e.info.decoderConfig.description?{id:25506,data:Q(e.info.decoderConfig.description)}:null,{id:225,data:[{id:181,data:new Ut(e.info.sampleRate)},{id:159,data:e.info.numberOfChannels},r?{id:25188,data:8*r.sampleSize}:null]}]}subtitleSpecificTrackInfo(e){return[{id:25506,data:K.encode(e.info.config.description)}]}maybeCreateTags(){let e=[],r=(o,s)=>{e.push({id:26568,data:[{id:17827,data:new nt(o)},typeof s=="string"?{id:17543,data:new nt(s)}:{id:17541,data:s}]})},i=this.output._metadataTags,a=new Set;for(let{key:o,value:s}of _e(i))switch(o){case"title":r("TITLE",s),a.add("TITLE");break;case"description":r("DESCRIPTION",s),a.add("DESCRIPTION");break;case"artist":r("ARTIST",s),a.add("ARTIST");break;case"album":r("ALBUM",s),a.add("ALBUM");break;case"albumArtist":r("ALBUM_ARTIST",s),a.add("ALBUM_ARTIST");break;case"genre":r("GENRE",s),a.add("GENRE");break;case"comment":r("COMMENT",s),a.add("COMMENT");break;case"lyrics":r("LYRICS",s),a.add("LYRICS");break;case"date":r("DATE",s.toISOString().slice(0,10)),a.add("DATE");break;case"trackNumber":{let c=i.tracksTotal!==void 0?`${s}/${i.tracksTotal}`:s.toString();r("PART_NUMBER",c),a.add("PART_NUMBER")}break;case"discNumber":{let c=i.discsTotal!==void 0?`${s}/${i.discsTotal}`:s.toString();r("DISC",c),a.add("DISC")}break;case"tracksTotal":case"discsTotal":break;case"images":case"raw":break;default:Y(o)}if(i.raw)for(let o in i.raw){let s=i.raw[o];s==null||a.has(o)||(typeof s=="string"||s instanceof Uint8Array)&&r(o,s)}e.length!==0&&(this.tagsElement={id:307544935,data:[{id:29555,data:[{id:25536,data:[{id:26826,data:50},{id:25546,data:"MOVIE"}]},...e]}]})}maybeCreateAttachments(){let e=this.output._metadataTags;if(!e.images||e.images.length===0)return;let r=new Set;this.attachmentsElement={id:423732329,data:e.images.map(i=>{let a=i.name;a===void 0&&(a=(i.kind==="coverFront"?"cover":i.kind==="coverBack"?"back":"image")+(Qa(i.mimeType)??""));let o;for(;o=Math.floor(Math.random()*Number.MAX_SAFE_INTEGER),!(o!==0&&!r.has(o)););return r.add(o),{id:24999,data:[i.description!==void 0?{id:18046,data:new nt(i.description)}:null,{id:18030,data:new nt(a)},{id:18016,data:i.mimeType},{id:18012,data:i.data},{id:18094,data:o}]}})}}createSegment(){this.createTracks(),this.maybeCreateTags(),this.maybeCreateAttachments(),this.maybeCreateSeekHead(!1);let e={id:408125543,size:this.format._options.appendOnly?-1:Ls,data:[this.seekHead,this.segmentInfo,this.tracksElement,this.attachmentsElement,this.tagsElement]};if(this.segment=e,this.format._options.onSegmentHeader&&this.writer.startTrackingWrites(),this.ebmlWriter.writeEBML(e),this.format._options.onSegmentHeader){let{data:r,start:i}=this.writer.stopTrackingWrites();this.format._options.onSegmentHeader(r,i)}}createCues(){this.cues={id:475249515,data:[]}}get segmentDataOffset(){return p(this.segment),this.ebmlWriter.dataOffsets.get(this.segment)}allTracksAreKnown(){for(let e of this.output._tracks)if(!e.source._closed&&!this.trackDatas.some(r=>r.track===e))return!1;return!0}async getMimeType(){await this.allTracksKnown.promise;let e=this.trackDatas.map(r=>r.type==="video"||r.type==="audio"?r.info.decoderConfig.codec:{webvtt:"wvtt"}[r.track.source._codec]);return Rn({isWebM:this.format instanceof qt,hasVideo:this.trackDatas.some(r=>r.type==="video"),hasAudio:this.trackDatas.some(r=>r.type==="audio"),codecStrings:e})}getVideoTrackData(e,r){let i=this.trackDatas.find(o=>o.track===e);if(i)return i;on(r),p(r),p(r.decoderConfig),p(r.decoderConfig.codedWidth!==void 0),p(r.decoderConfig.codedHeight!==void 0);let a={track:e,type:"video",info:{width:r.decoderConfig.codedWidth,height:r.decoderConfig.codedHeight,decoderConfig:r.decoderConfig},chunkQueue:[],lastWrittenMsTimestamp:null};return e.source._codec==="vp9"?a.info.decoderConfig={...a.info.decoderConfig,description:new Uint8Array(ns(a.info.decoderConfig.codec))}:e.source._codec==="av1"&&(a.info.decoderConfig={...a.info.decoderConfig,description:new Uint8Array(nn(a.info.decoderConfig.codec))}),this.trackDatas.push(a),this.trackDatas.sort((o,s)=>o.track.id-s.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),a}getAudioTrackData(e,r){let i=this.trackDatas.find(o=>o.track===e);if(i)return i;Ue(r),p(r),p(r.decoderConfig);let a={track:e,type:"audio",info:{numberOfChannels:r.decoderConfig.numberOfChannels,sampleRate:r.decoderConfig.sampleRate,decoderConfig:r.decoderConfig},chunkQueue:[],lastWrittenMsTimestamp:null};return this.trackDatas.push(a),this.trackDatas.sort((o,s)=>o.track.id-s.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),a}getSubtitleTrackData(e,r){let i=this.trackDatas.find(o=>o.track===e);if(i)return i;cn(r),p(r),p(r.config);let a={track:e,type:"subtitle",info:{config:r.config},chunkQueue:[],lastWrittenMsTimestamp:null};return this.trackDatas.push(a),this.trackDatas.sort((o,s)=>o.track.id-s.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),a}async addEncodedVideoPacket(e,r,i){let a=await this.mutex.acquire();try{let o=this.getVideoTrackData(e,i),s=r.type==="key",c=this.validateAndNormalizeTimestamp(o.track,r.timestamp,s),u=r.duration;e.metadata.frameRate!==void 0&&(c=dr(c,1/e.metadata.frameRate),u=dr(u,1/e.metadata.frameRate));let d=this.createInternalChunk(r.data,c,u,r.type);e.source._codec==="vp9"&&this.fixVP9ColorSpace(o,d),o.chunkQueue.push(d),await this.interleaveChunks()}finally{a()}}async addEncodedAudioPacket(e,r,i){let a=await this.mutex.acquire();try{let o=this.getAudioTrackData(e,i),s=r.type==="key",c=this.validateAndNormalizeTimestamp(o.track,r.timestamp,s),u=this.createInternalChunk(r.data,c,r.duration,r.type);o.chunkQueue.push(u),await this.interleaveChunks()}finally{a()}}async addSubtitleCue(e,r,i){let a=await this.mutex.acquire();try{let o=this.getSubtitleTrackData(e,i),s=this.validateAndNormalizeTimestamp(o.track,r.timestamp,!0),c=r.text,u=Math.round(s*1e3);Ot.lastIndex=0,c=c.replace(Ot,f=>{let b=ln(f.slice(1,-1))-u;return`<${mn(b)}>`});let d=K.encode(c),l=`${r.settings??""}
${r.identifier??""}
${r.notes??""}`,m=this.createInternalChunk(d,s,r.duration,"key",l.trim()?K.encode(l):null);o.chunkQueue.push(m),await this.interleaveChunks()}finally{a()}}async interleaveChunks(e=!1){if(!(!e&&!this.allTracksAreKnown())){e:for(;;){let r=null,i=1/0;for(let o of this.trackDatas){if(!e&&o.chunkQueue.length===0&&!o.track.source._closed)break e;o.chunkQueue.length>0&&o.chunkQueue[0].timestamp<i&&(r=o,i=o.chunkQueue[0].timestamp)}if(!r)break;let a=r.chunkQueue.shift();this.writeBlock(r,a)}e||await this.writer.flush()}}fixVP9ColorSpace(e,r){if(r.type!=="key"||!e.info.decoderConfig.colorSpace||!e.info.decoderConfig.colorSpace.matrix)return;let i=new $(r.data);i.skipBits(2);let a=i.readBits(1),s=(i.readBits(1)<<1)+a;if(s===3&&i.skipBits(1),i.readBits(1)||i.readBits(1)!==0||(i.skipBits(2),i.readBits(24)!==4817730))return;s>=2&&i.skipBits(1);let l={rgb:7,bt709:2,bt470bg:1,smpte170m:3}[e.info.decoderConfig.colorSpace.matrix];Na(r.data,i.pos,i.pos+3,l)}createInternalChunk(e,r,i,a,o=null){return{data:e,type:a,timestamp:r,duration:i,additions:o}}writeBlock(e,r){this.segment||this.createSegment();let i=Math.round(1e3*r.timestamp),a=this.trackDatas.every(l=>{if(e===l)return r.type==="key";let m=l.chunkQueue[0];return m?m.type==="key":l.track.source._closed}),o=!1;if(!this.currentCluster)o=!0;else{p(this.currentClusterStartMsTimestamp!==null),p(this.currentClusterMaxMsTimestamp!==null);let l=i-this.currentClusterStartMsTimestamp;o=a&&i>this.currentClusterMaxMsTimestamp&&l>=1e3*(this.format._options.minimumClusterDuration??1)||l>Gc}o&&this.createNewCluster(i);let s=i-this.currentClusterStartMsTimestamp;if(s<Qc)return;let c=new Uint8Array(4),u=new DataView(c.buffer);u.setUint8(0,128|e.track.id),u.setInt16(1,s,!1);let d=Math.round(1e3*r.duration);if(r.additions){let l={id:160,data:[{id:161,data:[c,r.data]},r.type==="delta"?{id:251,data:new yr(e.lastWrittenMsTimestamp-i)}:null,r.additions?{id:30113,data:[{id:166,data:[{id:165,data:r.additions},{id:238,data:1}]}]}:null,d>0?{id:155,data:d}:null]};this.ebmlWriter.writeEBML(l)}else{u.setUint8(3,+(r.type==="key")<<7);let l={id:163,data:[c,r.data]};this.ebmlWriter.writeEBML(l)}this.duration=Math.max(this.duration,i+d),e.lastWrittenMsTimestamp=i,this.trackDatasInCurrentCluster.has(e)||this.trackDatasInCurrentCluster.set(e,{firstMsTimestamp:i}),this.currentClusterMaxMsTimestamp=Math.max(this.currentClusterMaxMsTimestamp,i)}createNewCluster(e){this.currentCluster&&this.finalizeCurrentCluster(),this.format._options.onCluster&&this.writer.startTrackingWrites(),this.currentCluster={id:524531317,size:this.format._options.appendOnly?-1:Hs,data:[{id:231,data:e}]},this.ebmlWriter.writeEBML(this.currentCluster),this.currentClusterStartMsTimestamp=e,this.currentClusterMaxMsTimestamp=e,this.trackDatasInCurrentCluster.clear()}finalizeCurrentCluster(){if(p(this.currentCluster),!this.format._options.appendOnly){let a=this.writer.getPos()-this.ebmlWriter.dataOffsets.get(this.currentCluster),o=this.writer.getPos();this.writer.seek(this.ebmlWriter.offsets.get(this.currentCluster)+4),this.ebmlWriter.writeVarInt(a,Hs),this.writer.seek(o)}if(this.format._options.onCluster){p(this.currentClusterStartMsTimestamp!==null);let{data:a,start:o}=this.writer.stopTrackingWrites();this.format._options.onCluster(a,o,this.currentClusterStartMsTimestamp/1e3)}let e=this.ebmlWriter.offsets.get(this.currentCluster)-this.segmentDataOffset,r=new Map;for(let[a,{firstMsTimestamp:o}]of this.trackDatasInCurrentCluster)r.has(o)||r.set(o,[]),r.get(o).push(a);let i=[...r.entries()].sort((a,o)=>a[0]-o[0]);for(let[a,o]of i)p(this.cues),this.cues.data.push({id:187,data:[{id:179,data:a},...o.map(s=>({id:183,data:[{id:247,data:s.track.id},{id:241,data:e}]}))]})}async onTrackClose(){let e=await this.mutex.acquire();this.allTracksAreKnown()&&this.allTracksKnown.resolve(),await this.interleaveChunks(),e()}async finalize(){let e=await this.mutex.acquire();if(this.allTracksKnown.resolve(),this.segment||this.createSegment(),await this.interleaveChunks(!0),this.currentCluster&&this.finalizeCurrentCluster(),p(this.cues),this.ebmlWriter.writeEBML(this.cues),!this.format._options.appendOnly){let r=this.writer.getPos(),i=this.writer.getPos()-this.segmentDataOffset;this.writer.seek(this.ebmlWriter.offsets.get(this.segment)+4),this.ebmlWriter.writeVarInt(i,Ls),this.segmentDuration.data=new Nt(this.duration),this.writer.seek(this.ebmlWriter.offsets.get(this.segmentDuration)),this.ebmlWriter.writeEBML(this.segmentDuration),p(this.seekHead),this.writer.seek(this.ebmlWriter.offsets.get(this.seekHead)),this.maybeCreateSeekHead(!0),this.ebmlWriter.writeEBML(this.seekHead),this.writer.seek(r)}e()}};var Gi={1:[-1,32,40,48,56,64,80,96,112,128,160,192,224,256,320,-1],2:[-1,32,48,56,64,80,96,112,128,160,192,224,256,320,384,-1],3:[-1,32,64,96,128,160,192,224,256,288,320,352,384,416,448,-1]},Xi={1:[-1,32,48,56,64,80,96,112,128,144,160,176,192,224,256,-1],2:[-1,8,16,24,32,40,48,56,64,80,96,112,128,144,160,-1],3:[-1,8,16,24,32,40,48,56,64,80,96,112,128,144,160,-1]},Yi={0:[11025,12e3,8e3,-1],2:[22050,24e3,16e3,-1],3:[44100,48e3,32e3,-1]},Kt=1483304551,Bn=1231971951,Vn=(n,t,e,r)=>Math.floor(n===3?(12*t/e+r)*4:144*t/e+r),jt=(n,t)=>n===3?t===3?21:36:t===3?13:21,zn=(n,t)=>{let e=n>>>24,r=n>>>16&255,i=n>>>8&255,a=n&255;if(e!==255&&r!==255&&i!==255&&a!==255)return{header:null,bytesAdvanced:4};if(e!==255)return{header:null,bytesAdvanced:1};if((r&224)!==224)return{header:null,bytesAdvanced:1};let o=r>>3&3,s=r>>1&3,c=i>>4&15,u=i>>2&3,d=i>>1&1,l=a>>6&3,m=a>>4&3,f=a>>3&1,h=a>>2&1,b=a&3,g=o===3?Gi[s]?.[c]:Xi[s]?.[c];if(!g||g===-1)return{header:null,bytesAdvanced:1};let w=g*1e3,k=Yi[o]?.[u];if(!k||k===-1)return{header:null,bytesAdvanced:1};let T=Vn(s,w,k,d);if(t!==null&&t<T)return{header:null,bytesAdvanced:1};let S;return o===3?S=s===3?384:1152:s===3?S=384:s===2?S=1152:S=576,{header:{totalSize:T,mpegVersionId:o,layer:s,bitrate:w,frequencyIndex:u,sampleRate:k,channel:l,modeExtension:m,copyright:f,original:h,emphasis:b,audioSamplesInFrame:S},bytesAdvanced:1}},Ks=n=>{let t=127,e=0,r=n;for(;(t^2147483647)!==0;)e=r&~t,e<<=1,e|=r&t,t=(t+1<<8)-1,r=e;return e},Un=n=>{let t=2130706432,e=0;for(;t!==0;)e>>=1,e|=n&t,t>>=8;return e};var Sr=128,Gt=10,Qt=["Blues","Classic rock","Country","Dance","Disco","Funk","Grunge","Hip-hop","Jazz","Metal","New age","Oldies","Other","Pop","Rhythm and blues","Rap","Reggae","Rock","Techno","Industrial","Alternative","Ska","Death metal","Pranks","Soundtrack","Euro-techno","Ambient","Trip-hop","Vocal","Jazz & funk","Fusion","Trance","Classical","Instrumental","Acid","House","Game","Sound clip","Gospel","Noise","Alternative rock","Bass","Soul","Punk","Space","Meditative","Instrumental pop","Instrumental rock","Ethnic","Gothic","Darkwave","Techno-industrial","Electronic","Pop-folk","Eurodance","Dream","Southern rock","Comedy","Cult","Gangsta","Top 40","Christian rap","Pop/funk","Jungle music","Native US","Cabaret","New wave","Psychedelic","Rave","Showtunes","Trailer","Lo-fi","Tribal","Acid punk","Acid jazz","Polka","Retro","Musical","Rock 'n' roll","Hard rock","Folk","Folk rock","National folk","Swing","Fast fusion","Bebop","Latin","Revival","Celtic","Bluegrass","Avantgarde","Gothic rock","Progressive rock","Psychedelic rock","Symphonic rock","Slow rock","Big band","Chorus","Easy listening","Acoustic","Humour","Speech","Chanson","Opera","Chamber music","Sonata","Symphony","Booty bass","Primus","Porn groove","Satire","Slow jam","Club","Tango","Samba","Folklore","Ballad","Power ballad","Rhythmic Soul","Freestyle","Duet","Punk rock","Drum solo","A cappella","Euro-house","Dance hall","Goa music","Drum & bass","Club-house","Hardcore techno","Terror","Indie","Britpop","Negerpunk","Polsk punk","Beat","Christian gangsta rap","Heavy metal","Black metal","Crossover","Contemporary Christian","Christian rock","Merengue","Salsa","Thrash metal","Anime","Jpop","Synthpop","Christmas","Art rock","Baroque","Bhangra","Big beat","Breakbeat","Chillout","Downtempo","Dub","EBM","Eclectic","Electro","Electroclash","Emo","Experimental","Garage","Global","IDM","Illbient","Industro-Goth","Jam Band","Krautrock","Leftfield","Lounge","Math rock","New romantic","Nu-breakz","Post-punk","Post-rock","Psytrance","Shoegaze","Space rock","Trop rock","World music","Neoclassical","Audiobook","Audio theatre","Neue Deutsche Welle","Podcast","Indie rock","G-Funk","Dubstep","Garage rock","Psybient"],xr=async(n,t,e)=>{let r=t;for(;e===null||r<e;){let i=n.requestSlice(r,4);if(i instanceof Promise&&(i=await i),!i)break;let a=v(i),o=zn(a,n.fileSize!==null?n.fileSize-r:null);if(o.header)return{header:o.header,startPos:r};r+=o.bytesAdvanced}return null},$s=(n,t)=>{let e=n.filePos;t.raw??={},t.raw.TAG??=D(n,Sr-3),n.filePos=e;let r=$t(n,30);r&&(t.title??=r);let i=$t(n,30);i&&(t.artist??=i);let a=$t(n,30);a&&(t.album??=a);let o=$t(n,4),s=Number.parseInt(o,10);Number.isInteger(s)&&s>0&&(t.date??=new Date(s,0,1));let c=D(n,30),u;if(c[28]===0&&c[29]!==0){let l=c[29];l>0&&(t.trackNumber??=l),n.skip(-30),u=$t(n,28),n.skip(2)}else n.skip(-30),u=$t(n,30);u&&(t.comment??=u);let d=M(n);d<Qt.length&&(t.genre??=Qt[d])},$t=(n,t)=>{let e=D(n,t),r=yt(e.indexOf(0),e.length),i=e.subarray(0,r),a="";for(let o=0;o<i.length;o++)a+=String.fromCharCode(i[o]);return a.trimEnd()},Cr=n=>{let t=n.filePos,e=J(n,3),r=M(n),i=M(n),a=M(n),o=v(n);if(e!=="ID3"||r===255||i===255||(o&2155905152)!==0)return n.filePos=t,null;let s=Un(o);return{majorVersion:r,revision:i,flags:a,size:s}},Qs=(n,t,e)=>{if(![2,3,4].includes(t.majorVersion)){console.warn(`Unsupported ID3v2 major version: ${t.majorVersion}`);return}let r=D(n,t.size),i=new Zi(t,r);if(t.flags&16&&i.removeFooter(),t.flags&128&&t.majorVersion===3&&i.ununsynchronizeAll(),t.flags&64){let a=i.readU32();t.majorVersion===3?i.pos+=a:i.pos+=a-4}for(;i.pos<=i.bytes.length-i.frameHeaderSize();){let a=i.readId3V2Frame();if(!a)break;let o=i.pos,s=i.pos+a.size,c=!1,u=!1,d=!1;if(t.majorVersion===3?(c=!!(a.flags&64),u=!!(a.flags&128)):t.majorVersion===4&&(c=!!(a.flags&4),u=!!(a.flags&8),d=!!(a.flags&2)||!!(t.flags&128)),c){console.warn(`Skipping encrypted ID3v2 frame ${a.id}`),i.pos=s;continue}if(u){console.warn(`Skipping compressed ID3v2 frame ${a.id}`),i.pos=s;continue}switch(d&&i.ununsynchronizeRegion(i.pos,s),e.raw??={},a.id[0]==="T"?e.raw[a.id]??=i.readId3V2EncodingAndText(s):e.raw[a.id]??=i.readBytes(a.size),i.pos=o,a.id){case"TIT2":case"TT2":e.title??=i.readId3V2EncodingAndText(s);break;case"TIT3":case"TT3":e.description??=i.readId3V2EncodingAndText(s);break;case"TPE1":case"TP1":e.artist??=i.readId3V2EncodingAndText(s);break;case"TALB":case"TAL":e.album??=i.readId3V2EncodingAndText(s);break;case"TPE2":case"TP2":e.albumArtist??=i.readId3V2EncodingAndText(s);break;case"TRCK":case"TRK":{let m=i.readId3V2EncodingAndText(s).split("/"),f=Number.parseInt(m[0],10),h=m[1]&&Number.parseInt(m[1],10);Number.isInteger(f)&&f>0&&(e.trackNumber??=f),h&&Number.isInteger(h)&&h>0&&(e.tracksTotal??=h)}break;case"TPOS":case"TPA":{let m=i.readId3V2EncodingAndText(s).split("/"),f=Number.parseInt(m[0],10),h=m[1]&&Number.parseInt(m[1],10);Number.isInteger(f)&&f>0&&(e.discNumber??=f),h&&Number.isInteger(h)&&h>0&&(e.discsTotal??=h)}break;case"TCON":case"TCO":{let l=i.readId3V2EncodingAndText(s),m=/^\((\d+)\)/.exec(l);if(m){let f=Number.parseInt(m[1]);if(Qt[f]!==void 0){e.genre??=Qt[f];break}}if(m=/^\d+$/.exec(l),m){let f=Number.parseInt(m[0]);if(Qt[f]!==void 0){e.genre??=Qt[f];break}}e.genre??=l}break;case"TDRC":case"TDAT":{let l=i.readId3V2EncodingAndText(s),m=new Date(l);Number.isNaN(m.getTime())||(e.date??=m)}break;case"TYER":case"TYE":{let l=i.readId3V2EncodingAndText(s),m=Number.parseInt(l,10);Number.isInteger(m)&&(e.date??=new Date(m,0,1))}break;case"USLT":case"ULT":{let l=i.readU8();i.pos+=3,i.readId3V2Text(l,s),e.lyrics??=i.readId3V2Text(l,s)}break;case"COMM":case"COM":{let l=i.readU8();i.pos+=3,i.readId3V2Text(l,s),e.comment??=i.readId3V2Text(l,s)}break;case"APIC":case"PIC":{let l=i.readId3V2TextEncoding(),m;if(t.majorVersion===2){let g=i.readAscii(3);m=g==="PNG"?"image/png":g==="JPG"?"image/jpeg":"image/*"}else m=i.readId3V2Text(l,s);let f=i.readU8(),h=i.readId3V2Text(l,s).trimEnd(),b=s-i.pos;if(b>=0){let g=i.readBytes(b);e.images||(e.images=[]),e.images.push({data:g,mimeType:m,kind:f===3?"coverFront":f===4?"coverBack":"unknown",description:h})}}break;default:i.pos+=a.size;break}i.pos=s}},Zi=class{constructor(t,e){this.header=t;this.bytes=e;this.pos=0;this.view=new DataView(e.buffer,e.byteOffset,e.byteLength)}frameHeaderSize(){return this.header.majorVersion===2?6:10}ununsynchronizeAll(){let t=[];for(let e=0;e<this.bytes.length;e++){let r=this.bytes[e];t.push(r),r===255&&e!==this.bytes.length-1&&this.bytes[e]===0&&e++}this.bytes=new Uint8Array(t),this.view=new DataView(this.bytes.buffer)}ununsynchronizeRegion(t,e){let r=[];for(let o=t;o<e;o++){let s=this.bytes[o];r.push(s),s===255&&o!==e-1&&this.bytes[o+1]===0&&o++}let i=this.bytes.subarray(0,t),a=this.bytes.subarray(e);this.bytes=new Uint8Array(i.length+r.length+a.length),this.bytes.set(i,0),this.bytes.set(r,i.length),this.bytes.set(a,i.length+r.length),this.view=new DataView(this.bytes.buffer)}removeFooter(){this.bytes=this.bytes.subarray(0,this.bytes.length-Gt),this.view=new DataView(this.bytes.buffer)}readBytes(t){let e=this.bytes.subarray(this.pos,this.pos+t);return this.pos+=t,e}readU8(){let t=this.view.getUint8(this.pos);return this.pos+=1,t}readU16(){let t=this.view.getUint16(this.pos,!1);return this.pos+=2,t}readU24(){let t=this.view.getUint16(this.pos,!1),e=this.view.getUint8(this.pos+1);return this.pos+=3,t*256+e}readU32(){let t=this.view.getUint32(this.pos,!1);return this.pos+=4,t}readAscii(t){let e="";for(let r=0;r<t;r++)e+=String.fromCharCode(this.view.getUint8(this.pos+r));return this.pos+=t,e}readId3V2Frame(){if(this.header.majorVersion===2){let t=this.readAscii(3);if(t==="\0\0\0")return null;let e=this.readU24();return{id:t,size:e,flags:0}}else{let t=this.readAscii(4);if(t==="\0\0\0\0")return null;let e=this.readU32(),r=this.header.majorVersion===4?Un(e):e,i=this.readU16(),a=this.pos,o=s=>{let c=this.pos+s;if(c>this.bytes.length)return!1;if(c<=this.bytes.length-this.frameHeaderSize()){this.pos+=s;let u=this.readAscii(4);if(u!=="\0\0\0\0"&&!/[0-9A-Z]{4}/.test(u))return!1}return!0};if(!o(r)){let s=this.header.majorVersion===4?e:Un(e);o(s)&&(r=s)}return this.pos=a,{id:t,size:r,flags:i}}}readId3V2TextEncoding(){let t=this.readU8();if(t>3)throw new Error(`Unsupported text encoding: ${t}`);return t}readId3V2Text(t,e){let r=this.pos,i=this.readBytes(e);switch(t){case 0:{let a="";for(let o=0;o<i.length;o++){let s=i[o];if(s===0){this.pos=r+o+1;break}a+=String.fromCharCode(s)}return a}case 1:if(i[0]===255&&i[1]===254){let a=new TextDecoder("utf-16le"),o=yt(i.findIndex((s,c)=>s===0&&i[c+1]===0&&c%2===0),i.length);return this.pos=r+Math.min(o+2,i.length),a.decode(i.subarray(2,o))}else if(i[0]===254&&i[1]===255){let a=new TextDecoder("utf-16be"),o=yt(i.findIndex((s,c)=>s===0&&i[c+1]===0&&c%2===0),i.length);return this.pos=r+Math.min(o+2,i.length),a.decode(i.subarray(2,o))}else{let a=yt(i.findIndex(o=>o===0),i.length);return this.pos=r+Math.min(a+1,i.length),fe.decode(i.subarray(0,a))}case 2:{let a=new TextDecoder("utf-16be"),o=yt(i.findIndex((s,c)=>s===0&&i[c+1]===0&&c%2===0),i.length);return this.pos=r+Math.min(o+2,i.length),a.decode(i.subarray(0,o))}case 3:{let a=yt(i.findIndex(o=>o===0),i.length);return this.pos=r+Math.min(a+1,i.length),fe.decode(i.subarray(0,a))}}}readId3V2EncodingAndText(t){if(this.pos>=t)return"";let e=this.readId3V2TextEncoding();return this.readId3V2Text(e,t)}};var Nn=class{constructor(t){this.writer=t;this.helper=new Uint8Array(8);this.helperView=new DataView(this.helper.buffer)}writeU8(t){this.helper[0]=t,this.writer.write(this.helper.subarray(0,1))}writeU16(t){this.helperView.setUint16(0,t,!1),this.writer.write(this.helper.subarray(0,2))}writeU32(t){this.helperView.setUint32(0,t,!1),this.writer.write(this.helper.subarray(0,4))}writeAscii(t){for(let e=0;e<t.length;e++)this.helper[e]=t.charCodeAt(e);this.writer.write(this.helper.subarray(0,t.length))}writeSynchsafeU32(t){this.writeU32(Ks(t))}writeIsoString(t){let e=new Uint8Array(t.length+1);for(let r=0;r<t.length;r++)e[r]=t.charCodeAt(r);e[t.length]=0,this.writer.write(e)}writeUtf8String(t){let e=K.encode(t);this.writer.write(e),this.writeU8(0)}writeId3V2TextFrame(t,e){let r=dt(e),a=1+(r?e.length:K.encode(e).byteLength)+1;this.writeAscii(t),this.writeSynchsafeU32(a),this.writeU16(0),this.writeU8(r?0:3),r?this.writeIsoString(e):this.writeUtf8String(e)}writeId3V2LyricsFrame(t){let e=dt(t),r="",i=4+r.length+1+t.length+1;this.writeAscii("USLT"),this.writeSynchsafeU32(i),this.writeU16(0),this.writeU8(e?0:3),this.writeAscii("und"),e?(this.writeIsoString(r),this.writeIsoString(t)):(this.writeUtf8String(r),this.writeUtf8String(t))}writeId3V2CommentFrame(t){let e=dt(t),r=e?t.length:K.encode(t).byteLength,i="",a=4+i.length+1+r+1;this.writeAscii("COMM"),this.writeSynchsafeU32(a),this.writeU16(0),this.writeU8(e?0:3),this.writeU8(117),this.writeU8(110),this.writeU8(100),e?(this.writeIsoString(i),this.writeIsoString(t)):(this.writeUtf8String(i),this.writeUtf8String(t))}writeId3V2ApicFrame(t,e,r,i){let a=dt(t)&&dt(r),o=a?r.length:K.encode(r).byteLength,s=1+t.length+1+1+o+1+i.byteLength;this.writeAscii("APIC"),this.writeSynchsafeU32(s),this.writeU16(0),this.writeU8(a?0:3),a?this.writeIsoString(t):this.writeUtf8String(t),this.writeU8(e),a?this.writeIsoString(r):this.writeUtf8String(r),this.writer.write(i)}writeXingFrame(t){let e=this.writer.getPos(),r=255,i=224|t.mpegVersionId<<3|t.layer<<1,o=(t.mpegVersionId===3?Gi:Xi)?.[t.layer];if(!o)throw new Error("Invalid MPEG version and layer combination.");let s=Yi[t.mpegVersionId]?.[t.frequencyIndex];if(!s||s===-1)throw new Error("Invalid MPEG version and frequency index combination.");let c=0,u=155,d=o.findIndex(g=>Vn(t.layer,1e3*g,s,c)>=u);if(d===-1)throw new Error("No suitable bitrate found.");let l=d<<4|t.frequencyIndex<<2|c<<1,m=t.channel<<6|t.modeExtension<<4|t.copyright<<3|t.original<<2|t.emphasis;this.helper[0]=r,this.helper[1]=i,this.helper[2]=l,this.helper[3]=m,this.writer.write(this.helper.subarray(0,4));let f=jt(t.mpegVersionId,t.channel);this.writer.seek(e+f),this.writeU32(Kt);let h=0;t.frameCount!==null&&(h|=1),t.fileSize!==null&&(h|=2),t.toc!==null&&(h|=4),this.writeU32(h),this.writeU32(t.frameCount??0),this.writeU32(t.fileSize??0),this.writer.write(t.toc??new Uint8Array(100));let b=Vn(t.layer,1e3*o[d],s,c);this.writer.seek(e+b)}};var Wn=class extends he{constructor(e,r){super(e);this.xingFrameData=null;this.frameCount=0;this.framePositions=[];this.xingFramePos=null;this.format=r,this.writer=e._writer,this.mp3Writer=new Nn(e._writer)}async start(){rn(this.output._metadataTags)||this.writeId3v2Tag(this.output._metadataTags)}async getMimeType(){return"audio/mpeg"}async addEncodedVideoPacket(){throw new Error("MP3 does not support video.")}async addEncodedAudioPacket(e,r){let i=await this.mutex.acquire();try{let a=this.format._options.xingHeader!==!1;if(!this.xingFrameData&&a){let o=V(r.data);if(o.byteLength<4)throw new Error("Invalid MP3 header in sample.");let s=o.getUint32(0,!1),c=zn(s,null).header;if(!c)throw new Error("Invalid MP3 header in sample.");let u=jt(c.mpegVersionId,c.channel);if(o.byteLength>=u+4){let d=o.getUint32(u,!1);if(d===Kt||d===Bn)return}this.xingFrameData={mpegVersionId:c.mpegVersionId,layer:c.layer,frequencyIndex:c.frequencyIndex,channel:c.channel,modeExtension:c.modeExtension,copyright:c.copyright,original:c.original,emphasis:c.emphasis,frameCount:null,fileSize:null,toc:null},this.xingFramePos=this.writer.getPos(),this.mp3Writer.writeXingFrame(this.xingFrameData),this.frameCount++}this.validateAndNormalizeTimestamp(e,r.timestamp,r.type==="key"),this.writer.write(r.data),this.frameCount++,await this.writer.flush(),a&&this.framePositions.push(this.writer.getPos())}finally{i()}}async addSubtitleCue(){throw new Error("MP3 does not support subtitles.")}writeId3v2Tag(e){this.mp3Writer.writeAscii("ID3"),this.mp3Writer.writeU8(4),this.mp3Writer.writeU8(0),this.mp3Writer.writeU8(0),this.mp3Writer.writeSynchsafeU32(0);let r=this.writer.getPos(),i=new Set;for(let{key:s,value:c}of _e(e))switch(s){case"title":this.mp3Writer.writeId3V2TextFrame("TIT2",c),i.add("TIT2");break;case"description":this.mp3Writer.writeId3V2TextFrame("TIT3",c),i.add("TIT3");break;case"artist":this.mp3Writer.writeId3V2TextFrame("TPE1",c),i.add("TPE1");break;case"album":this.mp3Writer.writeId3V2TextFrame("TALB",c),i.add("TALB");break;case"albumArtist":this.mp3Writer.writeId3V2TextFrame("TPE2",c),i.add("TPE2");break;case"trackNumber":{let u=e.tracksTotal!==void 0?`${c}/${e.tracksTotal}`:c.toString();this.mp3Writer.writeId3V2TextFrame("TRCK",u),i.add("TRCK")}break;case"discNumber":{let u=e.discsTotal!==void 0?`${c}/${e.discsTotal}`:c.toString();this.mp3Writer.writeId3V2TextFrame("TPOS",u),i.add("TPOS")}break;case"genre":this.mp3Writer.writeId3V2TextFrame("TCON",c),i.add("TCON");break;case"date":this.mp3Writer.writeId3V2TextFrame("TDRC",c.toISOString().slice(0,10)),i.add("TDRC");break;case"lyrics":this.mp3Writer.writeId3V2LyricsFrame(c),i.add("USLT");break;case"comment":this.mp3Writer.writeId3V2CommentFrame(c),i.add("COMM");break;case"images":{let u={coverFront:3,coverBack:4,unknown:0};for(let d of c){let l=u[d.kind],m=d.description??"";this.mp3Writer.writeId3V2ApicFrame(d.mimeType,l,m,d.data)}}break;case"tracksTotal":case"discsTotal":break;case"raw":break;default:Y(s)}if(e.raw)for(let s in e.raw){let c=e.raw[s];if(c==null||s.length!==4||i.has(s))continue;let u;if(typeof c=="string"){let d=K.encode(c);u=new Uint8Array(d.byteLength+2),u[0]=3,u.set(d,1)}else if(c instanceof Uint8Array)u=c;else continue;this.mp3Writer.writeAscii(s),this.mp3Writer.writeSynchsafeU32(u.byteLength),this.mp3Writer.writeU16(0),this.writer.write(u)}let a=this.writer.getPos(),o=a-r;this.writer.seek(6),this.mp3Writer.writeSynchsafeU32(o),this.writer.seek(a)}async finalize(){if(!this.xingFrameData||this.xingFramePos===null)return;let e=await this.mutex.acquire(),r=this.writer.getPos();this.writer.seek(this.xingFramePos);let i=new Uint8Array(100);for(let a=0;a<100;a++){let o=Math.floor(this.framePositions.length*(a/100));p(o!==-1&&o<this.framePositions.length);let s=this.framePositions[o];i[a]=256*(s/r)}if(this.xingFrameData.frameCount=this.frameCount,this.xingFrameData.fileSize=r,this.xingFrameData.toc=i,this.format._options.onXingFrame&&this.writer.startTrackingWrites(),this.mp3Writer.writeXingFrame(this.xingFrameData),this.format._options.onXingFrame){let{data:a,start:o}=this.writer.stopTrackingWrites();this.format._options.onXingFrame(a,o)}this.writer.seek(r),e()}};var Pr=1399285583,Yc=79764919,Gs=new Uint32Array(256);for(let n=0;n<256;n++){let t=n<<24;for(let e=0;e<8;e++)t=t&2147483648?t<<1^Yc:t<<1;Gs[n]=t>>>0&4294967295}var Ln=n=>{let t=V(n),e=t.getUint32(22,!0);t.setUint32(22,0,!0);let r=0;for(let i=0;i<n.length;i++){let a=n[i];r=(r<<8^Gs[r>>>24^a])>>>0}return t.setUint32(22,e,!0),r},Hn=(n,t,e)=>{let r=0,i=null;if(n.length>0)if(t.codec==="vorbis"){p(t.vorbisInfo);let a=t.vorbisInfo.modeBlockflags.length,s=(1<<ja(a-1))-1<<1,c=(n[0]&s)>>1;if(c>=t.vorbisInfo.modeBlockflags.length)throw new Error("Invalid mode number.");let u=e,d=t.vorbisInfo.modeBlockflags[c];if(i=t.vorbisInfo.blocksizes[d],d===1){let l=(s|1)+1,m=n[0]&l?1:0;u=t.vorbisInfo.blocksizes[m]}r=u!==null?u+i>>2:0}else t.codec==="opus"&&(r=ps(n).durationInSamples);return{durationInSamples:r,vorbisBlockSize:i}},qn=n=>{let t="audio/ogg";if(n.codecStrings){let e=[...new Set(n.codecStrings)];t+=`; codecs="${e.join(", ")}"`}return t};var bt=27,Ct=282,Kn=Ct+255*255,Xt=n=>{let t=n.filePos;if(xt(n)!==Pr)return null;n.skip(1);let r=M(n),i=Ds(n),a=xt(n),o=xt(n),s=xt(n),c=M(n),u=new Uint8Array(c);for(let f=0;f<c;f++)u[f]=M(n);let d=27+c,l=u.reduce((f,h)=>f+h,0),m=d+l;return{headerStartPos:t,totalSize:m,dataStartPos:t+d,dataSize:l,headerType:r,granulePosition:i,serialNumber:a,sequenceNumber:o,checksum:s,lacingValues:u}},Xs=(n,t)=>{for(;n.filePos<t-3;){let e=xt(n),r=e&255,i=e>>>8&255,a=e>>>16&255,o=e>>>24&255,s=79;if(!(r!==s&&i!==s&&a!==s&&o!==s)){if(n.skip(-4),e===Pr)return!0;n.skip(1)}}return!1};var Zc=8192,jn=class extends he{constructor(e,r){super(e);this.trackDatas=[];this.bosPagesWritten=!1;this.allTracksKnown=q();this.pageBytes=new Uint8Array(Kn);this.pageView=new DataView(this.pageBytes.buffer);this.format=r,this.writer=e._writer,this.writer.ensureMonotonicity=!0}async start(){}async getMimeType(){return await this.allTracksKnown.promise,qn({codecStrings:this.trackDatas.map(e=>e.codecInfo.codec)})}addEncodedVideoPacket(){throw new Error("Video tracks are not supported.")}getTrackData(e,r){let i=this.trackDatas.find(s=>s.track===e);if(i)return i;let a;do a=Math.floor(2**32*Math.random());while(this.trackDatas.some(s=>s.serialNumber===a));p(e.source._codec==="vorbis"||e.source._codec==="opus"),Ue(r),p(r),p(r.decoderConfig);let o={track:e,serialNumber:a,internalSampleRate:e.source._codec==="opus"?Ae:r.decoderConfig.sampleRate,codecInfo:{codec:e.source._codec,vorbisInfo:null,opusInfo:null},vorbisLastBlocksize:null,packetQueue:[],currentTimestampInSamples:0,pagesWritten:0,currentGranulePosition:0,currentLacingValues:[],currentPageData:[],currentPageSize:27,currentPageStartsWithFreshPacket:!0};return this.queueHeaderPackets(o,r),this.trackDatas.push(o),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),o}queueHeaderPackets(e,r){if(p(r.decoderConfig),e.track.source._codec==="vorbis"){p(r.decoderConfig.description);let i=Q(r.decoderConfig.description);if(i[0]!==2)throw new TypeError("First byte of Vorbis decoder description must be 2.");let a=1,o=()=>{let g=0;for(;;){let w=i[a++];if(w===void 0)throw new TypeError("Vorbis decoder description is too short.");if(g+=w,w<255)return g}},s=o(),c=o();if(i.length-a<=0)throw new TypeError("Vorbis decoder description is too short.");let d=i.subarray(a,a+=s);a+=c;let l=i.subarray(a),m=new Uint8Array(7);m[0]=3,m[1]=118,m[2]=111,m[3]=114,m[4]=98,m[5]=105,m[6]=115;let f=this.createVorbisComments(m);e.packetQueue.push({data:d,endGranulePosition:0,timestamp:0,forcePageFlush:!0},{data:f,endGranulePosition:0,timestamp:0,forcePageFlush:!1},{data:l,endGranulePosition:0,timestamp:0,forcePageFlush:!0});let b=V(d).getUint8(28);e.codecInfo.vorbisInfo={blocksizes:[1<<(b&15),1<<(b>>4)],modeBlockflags:kn(l).modeBlockflags}}else if(e.track.source._codec==="opus"){if(!r.decoderConfig.description)throw new TypeError("For Ogg, Opus decoder description is required.");let i=Q(r.decoderConfig.description),a=new Uint8Array(8),o=V(a);o.setUint32(0,1332770163,!1),o.setUint32(4,1415669619,!1);let s=this.createVorbisComments(a);e.packetQueue.push({data:i,endGranulePosition:0,timestamp:0,forcePageFlush:!0},{data:s,endGranulePosition:0,timestamp:0,forcePageFlush:!0}),e.codecInfo.opusInfo={preSkip:lt(i).preSkip}}}createVorbisComments(e){let r=this.output._metadataTags,i=[e],a="";typeof r.raw?.vendor=="string"&&(a=r.raw?.vendor);let o=K.encode(a),s=new Uint8Array(4+o.length),c=new DataView(s.buffer);c.setUint32(0,o.length,!0),s.set(o,4),i.push(s);let u=new Set,d=(b,g)=>{let w=`${b}=${g}`,k=K.encode(w);s=new Uint8Array(4+k.length),c=new DataView(s.buffer),c.setUint32(0,k.length,!0),s.set(k,4),i.push(s),u.add(b)};for(let{key:b,value:g}of _e(r))switch(b){case"title":d("TITLE",g);break;case"description":d("DESCRIPTION",g);break;case"artist":d("ARTIST",g);break;case"album":d("ALBUM",g);break;case"albumArtist":d("ALBUMARTIST",g);break;case"genre":d("GENRE",g);break;case"date":d("DATE",g.toISOString().slice(0,10));break;case"comment":d("COMMENT",g);break;case"lyrics":d("LYRICS",g);break;case"trackNumber":d("TRACKNUMBER",g.toString());break;case"tracksTotal":d("TRACKTOTAL",g.toString());break;case"discNumber":d("DISCNUMBER",g.toString());break;case"discsTotal":d("DISCTOTAL",g.toString());break;case"images":for(let w of g){let k=w.kind==="coverFront"?3:w.kind==="coverBack"?4:0,T=new Uint8Array(w.mimeType.length);for(let _=0;_<w.mimeType.length;_++)T[_]=w.mimeType.charCodeAt(_);let S=K.encode(w.description??""),y=new Uint8Array(8+T.length+4+S.length+16+4+w.data.length),x=V(y);x.setUint32(0,k,!1),x.setUint32(4,T.length,!1),y.set(T,8),x.setUint32(8+T.length,S.length,!1),y.set(S,12+T.length),x.setUint32(28+T.length+S.length,w.data.length,!1),y.set(w.data,32+T.length+S.length);let F=Xa(y);d("METADATA_BLOCK_PICTURE",F)}break;case"raw":break;default:Y(b)}if(r.raw)for(let b in r.raw){let g=r.raw[b];b==="vendor"||g==null||u.has(b)||typeof g=="string"&&d(b,g)}let l=new Uint8Array(4);V(l).setUint32(0,u.size,!0),i.splice(2,0,l);let m=i.reduce((b,g)=>b+g.length,0),f=new Uint8Array(m),h=0;for(let b of i)f.set(b,h),h+=b.length;return f}async addEncodedAudioPacket(e,r,i){let a=await this.mutex.acquire();try{let o=this.getTrackData(e,i);this.validateAndNormalizeTimestamp(o.track,r.timestamp,r.type==="key");let s=o.currentTimestampInSamples,{durationInSamples:c,vorbisBlockSize:u}=Hn(r.data,o.codecInfo,o.vorbisLastBlocksize);o.currentTimestampInSamples+=c,o.vorbisLastBlocksize=u,o.packetQueue.push({data:r.data,endGranulePosition:o.currentTimestampInSamples,timestamp:s/o.internalSampleRate,forcePageFlush:!1}),await this.interleavePages()}finally{a()}}addSubtitleCue(){throw new Error("Subtitle tracks are not supported.")}allTracksAreKnown(){for(let e of this.output._tracks)if(!e.source._closed&&!this.trackDatas.some(r=>r.track===e))return!1;return!0}async interleavePages(e=!1){if(!this.bosPagesWritten){if(!this.allTracksAreKnown())return;for(let r of this.trackDatas)for(;r.packetQueue.length>0;){let i=r.packetQueue.shift();if(this.writePacket(r,i,!1),i.forcePageFlush)break}this.bosPagesWritten=!0}e:for(;;){let r=null,i=1/0;for(let s of this.trackDatas){if(!e&&s.packetQueue.length<=1&&!s.track.source._closed)break e;s.packetQueue.length>0&&s.packetQueue[0].timestamp<i&&(r=s,i=s.packetQueue[0].timestamp)}if(!r)break;let a=r.packetQueue.shift(),o=r.packetQueue.length===0;this.writePacket(r,a,o)}e||await this.writer.flush()}writePacket(e,r,i){let a=r.data.length,o=0,s=0;for(;;){e.currentLacingValues.length===0&&o>0&&(e.currentPageStartsWithFreshPacket=!1);let u=Math.min(255,a);e.currentLacingValues.push(u),e.currentPageSize++,s+=u;let d=a<255;if(e.currentLacingValues.length===255){let l=r.data.subarray(o,s);if(o=s,e.currentPageData.push(l),e.currentPageSize+=l.length,this.writePage(e,i&&d),d)return}if(d)break;a-=255}let c=r.data.subarray(o);e.currentPageData.push(c),e.currentPageSize+=c.length,e.currentGranulePosition=r.endGranulePosition,(e.currentPageSize>=Zc||r.forcePageFlush)&&this.writePage(e,i)}writePage(e,r){this.pageView.setUint32(0,Pr,!0),this.pageView.setUint8(4,0);let i=0;e.currentPageStartsWithFreshPacket||(i|=1),e.pagesWritten===0&&(i|=2),r&&(i|=4),this.pageView.setUint8(5,i);let a=e.currentLacingValues.every(u=>u===255)?-1:e.currentGranulePosition;Ka(this.pageView,6,a,!0),this.pageView.setUint32(14,e.serialNumber,!0),this.pageView.setUint32(18,e.pagesWritten,!0),this.pageView.setUint32(22,0,!0),this.pageView.setUint8(26,e.currentLacingValues.length),this.pageBytes.set(e.currentLacingValues,27);let o=27+e.currentLacingValues.length;for(let u of e.currentPageData)this.pageBytes.set(u,o),o+=u.length;let s=this.pageBytes.subarray(0,o),c=Ln(s);if(this.pageView.setUint32(22,c,!0),e.pagesWritten++,e.currentLacingValues.length=0,e.currentPageData.length=0,e.currentPageSize=27,e.currentPageStartsWithFreshPacket=!0,this.format._options.onPage&&this.writer.startTrackingWrites(),this.writer.write(s),this.format._options.onPage){let{data:u,start:d}=this.writer.stopTrackingWrites();this.format._options.onPage(u,d,e.track.source)}}async onTrackClose(){let e=await this.mutex.acquire();this.allTracksAreKnown()&&this.allTracksKnown.resolve(),await this.interleavePages(),e()}async finalize(){let e=await this.mutex.acquire();this.allTracksKnown.resolve(),await this.interleavePages(!0);for(let r of this.trackDatas)r.currentLacingValues.length>0&&this.writePage(r,!0);e()}};var be=class{constructor(t){this.input=t}};var $n=class{static supports(t,e){return!1}},Qn=class{static supports(t,e){return!1}},Gn=class{static supports(t,e){return!1}},Xn=class{static supports(t,e){return!1}},Yt=[],Zt=[],Pt=[],vt=[],Jc=n=>{if(n.prototype instanceof $n){let t=n;if(Yt.includes(t)){console.warn("Video decoder already registered.");return}Yt.push(t)}else if(n.prototype instanceof Qn){let t=n;if(Zt.includes(t)){console.warn("Audio decoder already registered.");return}Zt.push(t)}else throw new TypeError("Decoder must be a CustomVideoDecoder or CustomAudioDecoder.")},eu=n=>{if(n.prototype instanceof Gn){let t=n;if(Pt.includes(t)){console.warn("Video encoder already registered.");return}Pt.push(t)}else if(n.prototype instanceof Xn){let t=n;if(vt.includes(t)){console.warn("Audio encoder already registered.");return}vt.push(t)}else throw new TypeError("Encoder must be a CustomVideoEncoder or CustomAudioEncoder.")};var le=new Uint8Array(0),N=class n{constructor(t,e,r,i,a=-1,o){this.data=t;this.type=e;this.timestamp=r;this.duration=i;this.sequenceNumber=a;if(t===le&&o===void 0)throw new Error("Internal error: byteLength must be explicitly provided when constructing metadata-only packets.");if(o===void 0&&(o=t.byteLength),!(t instanceof Uint8Array))throw new TypeError("data must be a Uint8Array.");if(e!=="key"&&e!=="delta")throw new TypeError('type must be either "key" or "delta".');if(!Number.isFinite(r))throw new TypeError("timestamp must be a number.");if(!Number.isFinite(i)||i<0)throw new TypeError("duration must be a non-negative number.");if(!Number.isFinite(a))throw new TypeError("sequenceNumber must be a number.");if(!Number.isInteger(o)||o<0)throw new TypeError("byteLength must be a non-negative integer.");this.byteLength=o}get isMetadataOnly(){return this.data===le}get microsecondTimestamp(){return Math.trunc(ze*this.timestamp)}get microsecondDuration(){return Math.trunc(ze*this.duration)}toEncodedVideoChunk(){if(this.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be converted to a video chunk.");if(typeof EncodedVideoChunk>"u")throw new Error("Your browser does not support EncodedVideoChunk.");return new EncodedVideoChunk({data:this.data,type:this.type,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}toEncodedAudioChunk(){if(this.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be converted to an audio chunk.");if(typeof EncodedAudioChunk>"u")throw new Error("Your browser does not support EncodedAudioChunk.");return new EncodedAudioChunk({data:this.data,type:this.type,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}static fromEncodedChunk(t){if(!(t instanceof EncodedVideoChunk||t instanceof EncodedAudioChunk))throw new TypeError("chunk must be an EncodedVideoChunk or EncodedAudioChunk.");let e=new Uint8Array(t.byteLength);return t.copyTo(e),new n(e,t.type,t.timestamp/1e6,(t.duration??0)/1e6)}clone(t){if(t!==void 0&&(typeof t!="object"||t===null))throw new TypeError("options, when provided, must be an object.");if(t?.timestamp!==void 0&&!Number.isFinite(t.timestamp))throw new TypeError("options.timestamp, when provided, must be a number.");if(t?.duration!==void 0&&!Number.isFinite(t.duration))throw new TypeError("options.duration, when provided, must be a number.");return new n(this.data,this.type,t?.timestamp??this.timestamp,t?.duration??this.duration,this.sequenceNumber,this.byteLength)}};var Ys=n=>{let r=n,i=4096,a=0,o=12,s=0;for(r<0&&(r=-r,a=128),r+=33,r>8191&&(r=8191);(r&i)!==i&&o>=5;)i>>=1,o--;return s=r>>o-4&15,~(a|o-5<<4|s)&255},Zs=n=>{let e=0,r=0,i=~n;i&128&&(i&=-129,e=-1),r=((i&240)>>4)+5;let a=(1<<r|(i&15)<<r-4|1<<r-5)-33;return e===0?a:-a},Js=n=>{let e=2048,r=0,i=11,a=0,o=n;for(o<0&&(o=-o,r=128),o>4095&&(o=4095);(o&e)!==e&&i>=5;)e>>=1,i--;return a=o>>(i===4?1:i-4)&15,(r|i-4<<4|a)^85},eo=n=>{let t=0,e=0,r=n^85;r&128&&(r&=-129,t=-1),e=((r&240)>>4)+4;let i=0;return e!==4?i=1<<e|(r&15)<<e-4|1<<e-5:i=r<<1|1,t===0?i:-i};var ke=class n{constructor(t,e){this._closed=!1;if(t instanceof ArrayBuffer||ArrayBuffer.isView(t)){if(!e||typeof e!="object")throw new TypeError("init must be an object.");if(!("format"in e)||typeof e.format!="string")throw new TypeError("init.format must be a string.");if(!Number.isInteger(e.codedWidth)||e.codedWidth<=0)throw new TypeError("init.codedWidth must be a positive integer.");if(!Number.isInteger(e.codedHeight)||e.codedHeight<=0)throw new TypeError("init.codedHeight must be a positive integer.");if(e.rotation!==void 0&&![0,90,180,270].includes(e.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(!Number.isFinite(e.timestamp))throw new TypeError("init.timestamp must be a number.");if(e.duration!==void 0&&(!Number.isFinite(e.duration)||e.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");this._data=Q(t).slice(),this.format=e.format,this.codedWidth=e.codedWidth,this.codedHeight=e.codedHeight,this.rotation=e.rotation??0,this.timestamp=e.timestamp,this.duration=e.duration??0,this.colorSpace=new VideoColorSpace(e.colorSpace)}else if(typeof VideoFrame<"u"&&t instanceof VideoFrame){if(e?.rotation!==void 0&&![0,90,180,270].includes(e.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(e?.timestamp!==void 0&&!Number.isFinite(e?.timestamp))throw new TypeError("init.timestamp, when provided, must be a number.");if(e?.duration!==void 0&&(!Number.isFinite(e.duration)||e.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");this._data=t,this.format=t.format,this.codedWidth=t.displayWidth,this.codedHeight=t.displayHeight,this.rotation=e?.rotation??0,this.timestamp=e?.timestamp??t.timestamp/1e6,this.duration=e?.duration??(t.duration??0)/1e6,this.colorSpace=t.colorSpace}else if(typeof HTMLImageElement<"u"&&t instanceof HTMLImageElement||typeof SVGImageElement<"u"&&t instanceof SVGImageElement||typeof ImageBitmap<"u"&&t instanceof ImageBitmap||typeof HTMLVideoElement<"u"&&t instanceof HTMLVideoElement||typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&t instanceof OffscreenCanvas){if(!e||typeof e!="object")throw new TypeError("init must be an object.");if(e.rotation!==void 0&&![0,90,180,270].includes(e.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(!Number.isFinite(e.timestamp))throw new TypeError("init.timestamp must be a number.");if(e.duration!==void 0&&(!Number.isFinite(e.duration)||e.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");if(typeof VideoFrame<"u")return new n(new VideoFrame(t,{timestamp:Math.trunc(e.timestamp*ze),duration:Math.trunc((e.duration??0)*ze)}),e);let r=0,i=0;if("naturalWidth"in t?(r=t.naturalWidth,i=t.naturalHeight):"videoWidth"in t?(r=t.videoWidth,i=t.videoHeight):"width"in t&&(r=Number(t.width),i=Number(t.height)),!r||!i)throw new TypeError("Could not determine dimensions.");let a=new OffscreenCanvas(r,i),o=a.getContext("2d",{alpha:!1,willReadFrequently:!0});p(o),o.drawImage(t,0,0),this._data=a,this.format="RGBX",this.codedWidth=r,this.codedHeight=i,this.rotation=e.rotation??0,this.timestamp=e.timestamp,this.duration=e.duration??0,this.colorSpace=new VideoColorSpace({matrix:"rgb",primaries:"bt709",transfer:"iec61966-2-1",fullRange:!0})}else throw new TypeError("Invalid data type: Must be a BufferSource or CanvasImageSource.")}get displayWidth(){return this.rotation%180===0?this.codedWidth:this.codedHeight}get displayHeight(){return this.rotation%180===0?this.codedHeight:this.codedWidth}get microsecondTimestamp(){return Math.trunc(ze*this.timestamp)}get microsecondDuration(){return Math.trunc(ze*this.duration)}clone(){if(this._closed)throw new Error("VideoSample is closed.");return p(this._data!==null),vr(this._data)?new n(this._data.clone(),{timestamp:this.timestamp,duration:this.duration,rotation:this.rotation}):this._data instanceof Uint8Array?new n(this._data.slice(),{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.timestamp,duration:this.duration,colorSpace:this.colorSpace,rotation:this.rotation}):new n(this._data,{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.timestamp,duration:this.duration,colorSpace:this.colorSpace,rotation:this.rotation})}close(){this._closed||(vr(this._data)?this._data.close():this._data=null,this._closed=!0)}allocationSize(){if(this._closed)throw new Error("VideoSample is closed.");return p(this._data!==null),vr(this._data)?this._data.allocationSize():this._data instanceof Uint8Array?this._data.byteLength:this.codedWidth*this.codedHeight*4}async copyTo(t){if(!Mt(t))throw new TypeError("destination must be an ArrayBuffer or an ArrayBuffer view.");if(this._closed)throw new Error("VideoSample is closed.");if(p(this._data!==null),vr(this._data))await this._data.copyTo(t);else if(this._data instanceof Uint8Array)Q(t).set(this._data);else{let r=this._data.getContext("2d",{alpha:!1});p(r);let i=r.getImageData(0,0,this.codedWidth,this.codedHeight);Q(t).set(i.data)}}toVideoFrame(){if(this._closed)throw new Error("VideoSample is closed.");return p(this._data!==null),vr(this._data)?new VideoFrame(this._data,{timestamp:this.microsecondTimestamp,duration:this.microsecondDuration||void 0}):this._data instanceof Uint8Array?new VideoFrame(this._data,{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration,colorSpace:this.colorSpace}):new VideoFrame(this._data,{timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}draw(t,e,r,i,a,o,s,c,u){let d=0,l=0,m=this.displayWidth,f=this.displayHeight,h=0,b=0,g=this.displayWidth,w=this.displayHeight;if(o!==void 0?(d=e,l=r,m=i,f=a,h=o,b=s,c!==void 0?(g=c,w=u):(g=m,w=f)):(h=e,b=r,i!==void 0&&(g=i,w=a)),!(typeof CanvasRenderingContext2D<"u"&&t instanceof CanvasRenderingContext2D||typeof OffscreenCanvasRenderingContext2D<"u"&&t instanceof OffscreenCanvasRenderingContext2D))throw new TypeError("context must be a CanvasRenderingContext2D or OffscreenCanvasRenderingContext2D.");if(!Number.isFinite(d))throw new TypeError("sx must be a number.");if(!Number.isFinite(l))throw new TypeError("sy must be a number.");if(!Number.isFinite(m)||m<0)throw new TypeError("sWidth must be a non-negative number.");if(!Number.isFinite(f)||f<0)throw new TypeError("sHeight must be a non-negative number.");if(!Number.isFinite(h))throw new TypeError("dx must be a number.");if(!Number.isFinite(b))throw new TypeError("dy must be a number.");if(!Number.isFinite(g)||g<0)throw new TypeError("dWidth must be a non-negative number.");if(!Number.isFinite(w)||w<0)throw new TypeError("dHeight must be a non-negative number.");if(this._closed)throw new Error("VideoSample is closed.");({sx:d,sy:l,sWidth:m,sHeight:f}=this._rotateSourceRegion(d,l,m,f,this.rotation));let k=this.toCanvasImageSource();t.save();let T=h+g/2,S=b+w/2;t.translate(T,S),t.rotate(this.rotation*Math.PI/180);let y=this.rotation%180===0?1:g/w;t.scale(1/y,y),t.drawImage(k,d,l,m,f,-g/2,-w/2,g,w),t.restore()}drawWithFit(t,e){if(!(typeof CanvasRenderingContext2D<"u"&&t instanceof CanvasRenderingContext2D||typeof OffscreenCanvasRenderingContext2D<"u"&&t instanceof OffscreenCanvasRenderingContext2D))throw new TypeError("context must be a CanvasRenderingContext2D or OffscreenCanvasRenderingContext2D.");if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(!["fill","contain","cover"].includes(e.fit))throw new TypeError("options.fit must be 'fill', 'contain', or 'cover'.");if(e.rotation!==void 0&&![0,90,180,270].includes(e.rotation))throw new TypeError("options.rotation, when provided, must be 0, 90, 180, or 270.");e.crop!==void 0&&Ar(e.crop,"options.");let r=t.canvas.width,i=t.canvas.height,a=e.rotation??this.rotation,[o,s]=a%180===0?[this.codedWidth,this.codedHeight]:[this.codedHeight,this.codedWidth];e.crop&&_r(e.crop,o,s);let c,u,d,l,{sx:m,sy:f,sWidth:h,sHeight:b}=this._rotateSourceRegion(e.crop?.left??0,e.crop?.top??0,e.crop?.width??this.codedWidth,e.crop?.height??this.codedHeight,a);if(e.fit==="fill")c=0,u=0,d=r,l=i;else{let[w,k]=e.crop?[e.crop.width,e.crop.height]:[o,s],T=e.fit==="contain"?Math.min(r/w,i/k):Math.max(r/w,i/k);d=w*T,l=k*T,c=(r-d)/2,u=(i-l)/2}let g=a%180===0?1:d/l;t.translate(r/2,i/2),t.rotate(a*Math.PI/180),t.scale(1/g,g),t.translate(-r/2,-i/2),t.drawImage(this.toCanvasImageSource(),m,f,h,b,c,u,d,l)}_rotateSourceRegion(t,e,r,i,a){return a===90?[t,e,r,i]=[e,this.codedHeight-t-r,i,r]:a===180?[t,e]=[this.codedWidth-t-r,this.codedHeight-e-i]:a===270&&([t,e,r,i]=[this.codedWidth-e-i,t,i,r]),{sx:t,sy:e,sWidth:r,sHeight:i}}toCanvasImageSource(){if(this._closed)throw new Error("VideoSample is closed.");if(p(this._data!==null),this._data instanceof Uint8Array){let t=this.toVideoFrame();return queueMicrotask(()=>t.close()),t}else return this._data}setRotation(t){if(![0,90,180,270].includes(t))throw new TypeError("newRotation must be 0, 90, 180, or 270.");this.rotation=t}setTimestamp(t){if(!Number.isFinite(t))throw new TypeError("newTimestamp must be a number.");this.timestamp=t}setDuration(t){if(!Number.isFinite(t)||t<0)throw new TypeError("newDuration must be a non-negative number.");this.duration=t}},vr=n=>typeof VideoFrame<"u"&&n instanceof VideoFrame,_r=(n,t,e)=>{n.left=Math.min(n.left,t),n.top=Math.min(n.top,e),n.width=Math.min(n.width,t-n.left),n.height=Math.min(n.height,e-n.top),p(n.width>=0),p(n.height>=0)},Ar=(n,t)=>{if(!n||typeof n!="object")throw new TypeError(t+"crop, when provided, must be an object.");if(!Number.isInteger(n.left)||n.left<0)throw new TypeError(t+"crop.left must be a non-negative integer.");if(!Number.isInteger(n.top)||n.top<0)throw new TypeError(t+"crop.top must be a non-negative integer.");if(!Number.isInteger(n.width)||n.width<0)throw new TypeError(t+"crop.width must be a non-negative integer.");if(!Number.isInteger(n.height)||n.height<0)throw new TypeError(t+"crop.height must be a non-negative integer.")},Ji=new Set(["f32","f32-planar","s16","s16-planar","s32","s32-planar","u8","u8-planar"]),Te=class n{constructor(t){this._closed=!1;if(Er(t)){if(t.format===null)throw new TypeError("AudioData with null format is not supported.");this._data=t,this.format=t.format,this.sampleRate=t.sampleRate,this.numberOfFrames=t.numberOfFrames,this.numberOfChannels=t.numberOfChannels,this.timestamp=t.timestamp/1e6,this.duration=t.numberOfFrames/t.sampleRate}else{if(!t||typeof t!="object")throw new TypeError("Invalid AudioDataInit: must be an object.");if(!Ji.has(t.format))throw new TypeError("Invalid AudioDataInit: invalid format.");if(!Number.isFinite(t.sampleRate)||t.sampleRate<=0)throw new TypeError("Invalid AudioDataInit: sampleRate must be > 0.");if(!Number.isInteger(t.numberOfChannels)||t.numberOfChannels===0)throw new TypeError("Invalid AudioDataInit: numberOfChannels must be an integer > 0.");if(!Number.isFinite(t?.timestamp))throw new TypeError("init.timestamp must be a number.");let e=t.data.byteLength/(Ir(t.format)*t.numberOfChannels);if(!Number.isInteger(e))throw new TypeError("Invalid AudioDataInit: data size is not a multiple of frame size.");this.format=t.format,this.sampleRate=t.sampleRate,this.numberOfFrames=e,this.numberOfChannels=t.numberOfChannels,this.timestamp=t.timestamp,this.duration=e/t.sampleRate;let r;if(t.data instanceof ArrayBuffer)r=new Uint8Array(t.data);else if(ArrayBuffer.isView(t.data))r=new Uint8Array(t.data.buffer,t.data.byteOffset,t.data.byteLength);else throw new TypeError("Invalid AudioDataInit: data is not a BufferSource.");let i=this.numberOfFrames*this.numberOfChannels*Ir(this.format);if(r.byteLength<i)throw new TypeError("Invalid AudioDataInit: insufficient data size.");this._data=r}}get microsecondTimestamp(){return Math.trunc(ze*this.timestamp)}get microsecondDuration(){return Math.trunc(ze*this.duration)}allocationSize(t){if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(!Number.isInteger(t.planeIndex)||t.planeIndex<0)throw new TypeError("planeIndex must be a non-negative integer.");if(t.format!==void 0&&!Ji.has(t.format))throw new TypeError("Invalid format.");if(t.frameOffset!==void 0&&(!Number.isInteger(t.frameOffset)||t.frameOffset<0))throw new TypeError("frameOffset must be a non-negative integer.");if(t.frameCount!==void 0&&(!Number.isInteger(t.frameCount)||t.frameCount<0))throw new TypeError("frameCount must be a non-negative integer.");if(this._closed)throw new Error("AudioSample is closed.");let e=t.format??this.format,r=t.frameOffset??0;if(r>=this.numberOfFrames)throw new RangeError("frameOffset out of range");let i=t.frameCount!==void 0?t.frameCount:this.numberOfFrames-r;if(i>this.numberOfFrames-r)throw new RangeError("frameCount out of range");let a=Ir(e),o=Yn(e);if(o&&t.planeIndex>=this.numberOfChannels)throw new RangeError("planeIndex out of range");if(!o&&t.planeIndex!==0)throw new RangeError("planeIndex out of range");return(o?i:i*this.numberOfChannels)*a}copyTo(t,e){if(!Mt(t))throw new TypeError("destination must be an ArrayBuffer or an ArrayBuffer view.");if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(!Number.isInteger(e.planeIndex)||e.planeIndex<0)throw new TypeError("planeIndex must be a non-negative integer.");if(e.format!==void 0&&!Ji.has(e.format))throw new TypeError("Invalid format.");if(e.frameOffset!==void 0&&(!Number.isInteger(e.frameOffset)||e.frameOffset<0))throw new TypeError("frameOffset must be a non-negative integer.");if(e.frameCount!==void 0&&(!Number.isInteger(e.frameCount)||e.frameCount<0))throw new TypeError("frameCount must be a non-negative integer.");if(this._closed)throw new Error("AudioSample is closed.");let{planeIndex:r,format:i,frameCount:a,frameOffset:o}=e,s=i??this.format;if(!s)throw new Error("Destination format not determined");let c=this.numberOfFrames,u=this.numberOfChannels,d=o??0;if(d>=c)throw new RangeError("frameOffset out of range");let l=a!==void 0?a:c-d;if(l>c-d)throw new RangeError("frameCount out of range");let m=Ir(s),f=Yn(s);if(f&&r>=u)throw new RangeError("planeIndex out of range");if(!f&&r!==0)throw new RangeError("planeIndex out of range");let b=(f?l:l*u)*m;if(t.byteLength<b)throw new RangeError("Destination buffer is too small");let g=V(t),w=ru(s);if(Er(this._data))if(f)if(s==="f32-planar")this._data.copyTo(t,{planeIndex:r,frameOffset:d,frameCount:l,format:"f32-planar"});else{let k=new ArrayBuffer(l*4),T=new Float32Array(k);this._data.copyTo(T,{planeIndex:r,frameOffset:d,frameCount:l,format:"f32-planar"});let S=new DataView(k);for(let y=0;y<l;y++){let x=y*m,F=S.getFloat32(y*4,!0);w(g,x,F)}}else{let k=u,T=new Float32Array(l);for(let S=0;S<k;S++){this._data.copyTo(T,{planeIndex:S,frameOffset:d,frameCount:l,format:"f32-planar"});for(let y=0;y<l;y++){let F=(y*k+S)*m;w(g,F,T[y])}}}else{let k=this._data,T=new DataView(k.buffer,k.byteOffset,k.byteLength),S=this.format,y=tu(S),x=Ir(S),F=Yn(S);for(let _=0;_<l;_++)if(f){let P=_*m,E;F?E=(r*c+(_+d))*x:E=((_+d)*u+r)*x;let I=y(T,E);w(g,P,I)}else for(let P=0;P<u;P++){let I=(_*u+P)*m,B;F?B=(P*c+(_+d))*x:B=((_+d)*u+P)*x;let G=y(T,B);w(g,I,G)}}}clone(){if(this._closed)throw new Error("AudioSample is closed.");if(Er(this._data)){let t=new n(this._data.clone());return t.setTimestamp(this.timestamp),t}else return new n({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.timestamp,data:this._data})}close(){this._closed||(Er(this._data)?this._data.close():this._data=new Uint8Array(0),this._closed=!0)}toAudioData(){if(this._closed)throw new Error("AudioSample is closed.");if(Er(this._data)){if(this._data.timestamp===this.microsecondTimestamp)return this._data.clone();if(Yn(this.format)){let t=this.allocationSize({planeIndex:0,format:this.format}),e=new ArrayBuffer(t*this.numberOfChannels);for(let r=0;r<this.numberOfChannels;r++)this.copyTo(new Uint8Array(e,r*t,t),{planeIndex:r,format:this.format});return new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:e})}else{let t=new ArrayBuffer(this.allocationSize({planeIndex:0,format:this.format}));return this.copyTo(t,{planeIndex:0,format:this.format}),new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:t})}}else return new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:this._data})}toAudioBuffer(){if(this._closed)throw new Error("AudioSample is closed.");let t=new AudioBuffer({numberOfChannels:this.numberOfChannels,length:this.numberOfFrames,sampleRate:this.sampleRate}),e=new Float32Array(this.allocationSize({planeIndex:0,format:"f32-planar"})/4);for(let r=0;r<this.numberOfChannels;r++)this.copyTo(e,{planeIndex:r,format:"f32-planar"}),t.copyToChannel(e,r);return t}setTimestamp(t){if(!Number.isFinite(t))throw new TypeError("newTimestamp must be a number.");this.timestamp=t}static*_fromAudioBuffer(t,e){if(!(t instanceof AudioBuffer))throw new TypeError("audioBuffer must be an AudioBuffer.");let r=48e3*5,i=t.numberOfChannels,a=t.sampleRate,o=t.length,s=Math.floor(r/i),c=0,u=o;for(;u>0;){let d=Math.min(s,u),l=new Float32Array(i*d);for(let m=0;m<i;m++)t.copyFromChannel(l.subarray(m*d,(m+1)*d),m,c);yield new n({format:"f32-planar",sampleRate:a,numberOfFrames:d,numberOfChannels:i,timestamp:e+c/a,data:l}),c+=d,u-=d}}static fromAudioBuffer(t,e){if(!(t instanceof AudioBuffer))throw new TypeError("audioBuffer must be an AudioBuffer.");let r=48e3*5,i=t.numberOfChannels,a=t.sampleRate,o=t.length,s=Math.floor(r/i),c=0,u=o,d=[];for(;u>0;){let l=Math.min(s,u),m=new Float32Array(i*l);for(let h=0;h<i;h++)t.copyFromChannel(m.subarray(h*l,(h+1)*l),h,c);let f=new n({format:"f32-planar",sampleRate:a,numberOfFrames:l,numberOfChannels:i,timestamp:e+c/a,data:m});d.push(f),c+=l,u-=l}return d}},Ir=n=>{switch(n){case"u8":case"u8-planar":return 1;case"s16":case"s16-planar":return 2;case"s32":case"s32-planar":return 4;case"f32":case"f32-planar":return 4;default:throw new Error("Unknown AudioSampleFormat")}},Yn=n=>{switch(n){case"u8-planar":case"s16-planar":case"s32-planar":case"f32-planar":return!0;default:return!1}},tu=n=>{switch(n){case"u8":case"u8-planar":return(t,e)=>(t.getUint8(e)-128)/128;case"s16":case"s16-planar":return(t,e)=>t.getInt16(e,!0)/32768;case"s32":case"s32-planar":return(t,e)=>t.getInt32(e,!0)/2147483648;case"f32":case"f32-planar":return(t,e)=>t.getFloat32(e,!0)}},ru=n=>{switch(n){case"u8":case"u8-planar":return(t,e,r)=>t.setUint8(e,ee((r+1)*127.5,0,255));case"s16":case"s16-planar":return(t,e,r)=>t.setInt16(e,ee(Math.round(r*32767),-32768,32767),!0);case"s32":case"s32-planar":return(t,e,r)=>t.setInt32(e,ee(Math.round(r*2147483647),-2147483648,2147483647),!0);case"f32":case"f32-planar":return(t,e,r)=>t.setFloat32(e,r,!0)}},Er=n=>typeof AudioData<"u"&&n instanceof AudioData;var Jt=n=>{if(!n||typeof n!="object")throw new TypeError("options must be an object.");if(n.metadataOnly!==void 0&&typeof n.metadataOnly!="boolean")throw new TypeError("options.metadataOnly, when defined, must be a boolean.");if(n.verifyKeyPackets!==void 0&&typeof n.verifyKeyPackets!="boolean")throw new TypeError("options.verifyKeyPackets, when defined, must be a boolean.");if(n.verifyKeyPackets&&n.metadataOnly)throw new TypeError("options.verifyKeyPackets and options.metadataOnly cannot be enabled together.")},at=n=>{if(typeof n!="number"||Number.isNaN(n))throw new TypeError("timestamp must be a number.")},ea=(n,t,e)=>e.verifyKeyPackets?t.then(async r=>{if(!r||r.type==="delta")return r;let i=await n.determinePacketType(r);return i&&(r.type=i),r}):t,je=class{constructor(t){if(!(t instanceof _t))throw new TypeError("track must be an InputTrack.");this._track=t}getFirstPacket(t={}){return Jt(t),ea(this._track,this._track._backing.getFirstPacket(t),t)}getPacket(t,e={}){return at(t),Jt(e),ea(this._track,this._track._backing.getPacket(t,e),e)}getNextPacket(t,e={}){if(!(t instanceof N))throw new TypeError("packet must be an EncodedPacket.");return Jt(e),ea(this._track,this._track._backing.getNextPacket(t,e),e)}async getKeyPacket(t,e={}){if(at(t),Jt(e),!e.verifyKeyPackets)return this._track._backing.getKeyPacket(t,e);let r=await this._track._backing.getKeyPacket(t,e);return!r||r.type==="delta"?r:await this._track.determinePacketType(r)==="delta"?this.getKeyPacket(r.timestamp-1/this._track.timeResolution,e):r}async getNextKeyPacket(t,e={}){if(!(t instanceof N))throw new TypeError("packet must be an EncodedPacket.");if(Jt(e),!e.verifyKeyPackets)return this._track._backing.getNextKeyPacket(t,e);let r=await this._track._backing.getNextKeyPacket(t,e);return!r||r.type==="delta"?r:await this._track.determinePacketType(r)==="delta"?this.getNextKeyPacket(r,e):r}packets(t,e,r={}){if(t!==void 0&&!(t instanceof N))throw new TypeError("startPacket must be an EncodedPacket.");if(t!==void 0&&t.isMetadataOnly&&!r?.metadataOnly)throw new TypeError("startPacket can only be metadata-only if options.metadataOnly is enabled.");if(e!==void 0&&!(e instanceof N))throw new TypeError("endPacket must be an EncodedPacket.");Jt(r);let i=[],{promise:a,resolve:o}=q(),{promise:s,resolve:c}=q(),u=!1,d=!1,l=null,m=[],f=()=>Math.max(2,m.length);return(async()=>{let h=t??await this.getFirstPacket(r);for(;h&&!d&&!(e&&h.sequenceNumber>=e?.sequenceNumber);){if(i.length>f()){({promise:s,resolve:c}=q()),await s;continue}i.push(h),o(),{promise:a,resolve:o}=q(),h=await this.getNextPacket(h,r)}u=!0,o()})().catch(h=>{l||(l=h,o())}),{async next(){for(;;){if(d)return{value:void 0,done:!0};if(l)throw l;if(i.length>0){let h=i.shift(),b=performance.now();for(m.push(b);m.length>0&&b-m[0]>=1e3;)m.shift();return c(),{value:h,done:!1}}else{if(u)return{value:void 0,done:!0};await a}}},async return(){return d=!0,c(),o(),{value:void 0,done:!0}},async throw(h){throw h},[Symbol.asyncIterator](){return this}}}},Fr=class{constructor(t,e){this.onSample=t;this.onError=e}},Mr=class{mediaSamplesInRange(t=0,e=1/0){at(t),at(e);let r=[],i=!1,a=null,{promise:o,resolve:s}=q(),{promise:c,resolve:u}=q(),d=!1,l=!1,m=!1,f=null;return(async()=>{let h=new Error,b=await this._createDecoder(y=>{if(u(),y.timestamp>=e&&(l=!0),l){y.close();return}a&&(y.timestamp>t?(r.push(a),i=!0):a.close()),y.timestamp>=t&&(r.push(y),i=!0),a=i?null:y,r.length>0&&(s(),{promise:o,resolve:s}=q())},y=>{f||(y.stack=h.stack,f=y,s())}),g=this._createPacketSink(),w=await g.getKeyPacket(t,{verifyKeyPackets:!0})??await g.getFirstPacket();if(!w)return;let k=w,T;if(e<1/0){let y=await g.getPacket(e),x=y?y.type==="key"&&y.timestamp===e?y:await g.getNextKeyPacket(y,{verifyKeyPackets:!0}):null;x&&(T=x)}let S=g.packets(w,T);for(await S.next();k&&!l;){let y=to(r.length);if(r.length+b.getDecodeQueueSize()>y){({promise:c,resolve:u}=q()),await c;continue}b.decode(k);let x=await S.next();if(x.done)break;k=x.value}await S.return(),m||await b.flush(),b.close(),!i&&a&&r.push(a),d=!0,s()})().catch(h=>{f||(f=h,s())}),{async next(){for(;;){if(m)return{value:void 0,done:!0};if(f)throw f;if(r.length>0){let h=r.shift();return u(),{value:h,done:!1}}else if(!d)await o;else return{value:void 0,done:!0}}},async return(){m=!0,l=!0,u(),s(),a?.close();for(let h of r)h.close();return{value:void 0,done:!0}},async throw(h){throw h},[Symbol.asyncIterator](){return this}}}mediaSamplesAtTimestamps(t){La(t);let e=Wa(t),r=[],i=[],{promise:a,resolve:o}=q(),{promise:s,resolve:c}=q(),u=!1,d=!1,l=null,m=f=>{i.push(f),o(),{promise:a,resolve:o}=q()};return(async()=>{let f=new Error,h=await this._createDecoder(y=>{if(c(),d){y.close();return}let x=0;for(;r.length>0&&y.timestamp-r[0]>-1e-10;)x++,r.shift();if(x>0)for(let F=0;F<x;F++)m(F<x-1?y.clone():y);else y.close()},y=>{l||(y.stack=f.stack,l=y,o())}),b=this._createPacketSink(),g=null,w=null,k=-1,T=async()=>{p(w);let y=w;for(h.decode(y);y.sequenceNumber<k;){let x=to(i.length);for(;i.length+h.getDecodeQueueSize()>x&&!d;)({promise:s,resolve:c}=q()),await s;if(d)break;let F=await b.getNextPacket(y);p(F),h.decode(F),y=F}k=-1},S=async()=>{await h.flush();for(let y=0;y<r.length;y++)m(null);r.length=0};for await(let y of e){if(at(y),d)break;let x=await b.getPacket(y),F=x&&await b.getKeyPacket(y,{verifyKeyPackets:!0});if(!F){k!==-1&&(await T(),await S()),m(null),g=null;continue}g&&(F.sequenceNumber!==w.sequenceNumber||x.timestamp<g.timestamp)&&(await T(),await S()),r.push(x.timestamp),k=Math.max(x.sequenceNumber,k),g=x,w=F}d||(k!==-1&&await T(),await S()),h.close(),u=!0,o()})().catch(f=>{l||(l=f,o())}),{async next(){for(;;){if(d)return{value:void 0,done:!0};if(l)throw l;if(i.length>0){let f=i.shift();return p(f!==void 0),c(),{value:f,done:!1}}else if(!u)await a;else return{value:void 0,done:!0}}},async return(){d=!0,c(),o();for(let f of i)f?.close();return{value:void 0,done:!0}},async throw(f){throw f},[Symbol.asyncIterator](){return this}}}},to=n=>n===0?40:8,ta=class extends Fr{constructor(e,r,i,a,o,s){super(e,r);this.codec=i;this.decoderConfig=a;this.rotation=o;this.timeResolution=s;this.decoder=null;this.customDecoder=null;this.customDecoderCallSerializer=new ct;this.customDecoderQueueSize=0;this.inputTimestamps=[];this.sampleQueue=[];this.currentPacketIndex=0;this.raslSkipped=!1;let c=Yt.find(u=>u.supports(i,a));if(c)this.customDecoder=new c,this.customDecoder.codec=i,this.customDecoder.config=a,this.customDecoder.onSample=u=>{if(!(u instanceof ke))throw new TypeError("The argument passed to onSample must be a VideoSample.");this.finalizeAndEmitSample(u)},this.customDecoderCallSerializer.call(()=>this.customDecoder.init());else{let u=d=>{if(Jr()){if(this.sampleQueue.length>0&&d.timestamp>=H(this.sampleQueue).timestamp){for(let l of this.sampleQueue)this.finalizeAndEmitSample(l);this.sampleQueue.length=0}Ee(this.sampleQueue,d,l=>l.timestamp)}else{let l=this.inputTimestamps.shift();p(l!==void 0),d.setTimestamp(l),this.finalizeAndEmitSample(d)}};this.decoder=new VideoDecoder({output:d=>u(new ke(d)),error:r}),this.decoder.configure(a)}}finalizeAndEmitSample(e){e.setTimestamp(Math.round(e.timestamp*this.timeResolution)/this.timeResolution),e.setDuration(Math.round(e.duration*this.timeResolution)/this.timeResolution),e.setRotation(this.rotation),this.onSample(e)}getDecodeQueueSize(){return this.customDecoder?this.customDecoderQueueSize:(p(this.decoder),this.decoder.decodeQueueSize)}decode(e){if(this.codec==="hevc"&&this.currentPacketIndex>0&&!this.raslSkipped){if(Di(e.data,this.decoderConfig).some(a=>{let o=Je(a);return o===8||o===9}))return;this.raslSkipped=!0}this.currentPacketIndex++,this.customDecoder?(this.customDecoderQueueSize++,this.customDecoderCallSerializer.call(()=>this.customDecoder.decode(e)).then(()=>this.customDecoderQueueSize--)):(p(this.decoder),Jr()||Ee(this.inputTimestamps,e.timestamp,r=>r),this.decoder.decode(e.toEncodedVideoChunk()))}async flush(){if(this.customDecoder?await this.customDecoderCallSerializer.call(()=>this.customDecoder.flush()):(p(this.decoder),await this.decoder.flush()),Jr()){for(let e of this.sampleQueue)this.finalizeAndEmitSample(e);this.sampleQueue.length=0}this.currentPacketIndex=0,this.raslSkipped=!1}close(){this.customDecoder?this.customDecoderCallSerializer.call(()=>this.customDecoder.close()):(p(this.decoder),this.decoder.close());for(let e of this.sampleQueue)e.close();this.sampleQueue.length=0}},It=class extends Mr{constructor(t){if(!(t instanceof Re))throw new TypeError("videoTrack must be an InputVideoTrack.");super(),this._videoTrack=t}async _createDecoder(t,e){if(!await this._videoTrack.canDecode())throw new Error("This video track cannot be decoded by this browser. Make sure to check decodability before using a track.");let r=this._videoTrack.codec,i=this._videoTrack.rotation,a=await this._videoTrack.getDecoderConfig(),o=this._videoTrack.timeResolution;return p(r&&a),new ta(t,e,r,a,i,o)}_createPacketSink(){return new je(this._videoTrack)}async getSample(t){at(t);for await(let e of this.mediaSamplesAtTimestamps([t]))return e;throw new Error("Internal error: Iterator returned nothing.")}samples(t=0,e=1/0){return this.mediaSamplesInRange(t,e)}samplesAtTimestamps(t){return this.mediaSamplesAtTimestamps(t)}},Or=class{constructor(t,e={}){this._nextCanvasIndex=0;if(!(t instanceof Re))throw new TypeError("videoTrack must be an InputVideoTrack.");if(e&&typeof e!="object")throw new TypeError("options must be an object.");if(e.width!==void 0&&(!Number.isInteger(e.width)||e.width<=0))throw new TypeError("options.width, when defined, must be a positive integer.");if(e.height!==void 0&&(!Number.isInteger(e.height)||e.height<=0))throw new TypeError("options.height, when defined, must be a positive integer.");if(e.fit!==void 0&&!["fill","contain","cover"].includes(e.fit))throw new TypeError('options.fit, when provided, must be one of "fill", "contain", or "cover".');if(e.width!==void 0&&e.height!==void 0&&e.fit===void 0)throw new TypeError("When both options.width and options.height are provided, options.fit must also be provided.");if(e.rotation!==void 0&&![0,90,180,270].includes(e.rotation))throw new TypeError("options.rotation, when provided, must be 0, 90, 180 or 270.");if(e.crop!==void 0&&Ar(e.crop,"options."),e.poolSize!==void 0&&(typeof e.poolSize!="number"||!Number.isInteger(e.poolSize)||e.poolSize<0))throw new TypeError("poolSize must be a non-negative integer.");let r=e.rotation??t.rotation,[i,a]=r%180===0?[t.codedWidth,t.codedHeight]:[t.codedHeight,t.codedWidth],o=e.crop;o&&_r(o,i,a);let[s,c]=o?[o.width,o.height]:[i,a],u=s/c;e.width!==void 0&&e.height===void 0?(s=e.width,c=Math.round(s/u)):e.width===void 0&&e.height!==void 0?(c=e.height,s=Math.round(c*u)):e.width!==void 0&&e.height!==void 0&&(s=e.width,c=e.height),this._videoTrack=t,this._width=s,this._height=c,this._rotation=r,this._crop=o,this._fit=e.fit??"fill",this._videoSampleSink=new It(t),this._canvasPool=Array.from({length:e.poolSize??0},()=>null)}_videoSampleToWrappedCanvas(t){let e=this._canvasPool[this._nextCanvasIndex],r=!1;e||(typeof document<"u"?(e=document.createElement("canvas"),e.width=this._width,e.height=this._height):e=new OffscreenCanvas(this._width,this._height),this._canvasPool.length>0&&(this._canvasPool[this._nextCanvasIndex]=e),r=!0),this._canvasPool.length>0&&(this._nextCanvasIndex=(this._nextCanvasIndex+1)%this._canvasPool.length);let i=e.getContext("2d",{alpha:!1});p(i),i.resetTransform(),r||i.clearRect(0,0,this._width,this._height),t.drawWithFit(i,{fit:this._fit,rotation:this._rotation,crop:this._crop});let a={canvas:e,timestamp:t.timestamp,duration:t.duration};return t.close(),a}async getCanvas(t){at(t);let e=await this._videoSampleSink.getSample(t);return e&&this._videoSampleToWrappedCanvas(e)}canvases(t=0,e=1/0){return ur(this._videoSampleSink.samples(t,e),r=>this._videoSampleToWrappedCanvas(r))}canvasesAtTimestamps(t){return ur(this._videoSampleSink.samplesAtTimestamps(t),e=>e&&this._videoSampleToWrappedCanvas(e))}},ra=class extends Fr{constructor(e,r,i,a){super(e,r);this.decoder=null;this.customDecoder=null;this.customDecoderCallSerializer=new ct;this.customDecoderQueueSize=0;this.currentTimestamp=null;let o=c=>{(this.currentTimestamp===null||Math.abs(c.timestamp-this.currentTimestamp)>=c.duration)&&(this.currentTimestamp=c.timestamp);let u=this.currentTimestamp;if(this.currentTimestamp+=c.duration,c.numberOfFrames===0){c.close();return}let d=a.sampleRate;c.setTimestamp(Math.round(u*d)/d),e(c)},s=Zt.find(c=>c.supports(i,a));s?(this.customDecoder=new s,this.customDecoder.codec=i,this.customDecoder.config=a,this.customDecoder.onSample=c=>{if(!(c instanceof Te))throw new TypeError("The argument passed to onSample must be an AudioSample.");o(c)},this.customDecoderCallSerializer.call(()=>this.customDecoder.init())):(this.decoder=new AudioDecoder({output:c=>o(new Te(c)),error:r}),this.decoder.configure(a))}getDecodeQueueSize(){return this.customDecoder?this.customDecoderQueueSize:(p(this.decoder),this.decoder.decodeQueueSize)}decode(e){this.customDecoder?(this.customDecoderQueueSize++,this.customDecoderCallSerializer.call(()=>this.customDecoder.decode(e)).then(()=>this.customDecoderQueueSize--)):(p(this.decoder),this.decoder.decode(e.toEncodedAudioChunk()))}flush(){return this.customDecoder?this.customDecoderCallSerializer.call(()=>this.customDecoder.flush()):(p(this.decoder),this.decoder.flush())}close(){this.customDecoder?this.customDecoderCallSerializer.call(()=>this.customDecoder.close()):(p(this.decoder),this.decoder.close())}},na=class extends Fr{constructor(e,r,i){super(e,r);this.decoderConfig=i;this.currentTimestamp=null;p(j.includes(i.codec)),this.codec=i.codec;let{dataType:a,sampleSize:o,littleEndian:s}=se(this.codec);switch(this.inputSampleSize=o,o){case 1:a==="unsigned"?this.readInputValue=(c,u)=>c.getUint8(u)-2**7:a==="signed"?this.readInputValue=(c,u)=>c.getInt8(u):a==="ulaw"?this.readInputValue=(c,u)=>Zs(c.getUint8(u)):a==="alaw"?this.readInputValue=(c,u)=>eo(c.getUint8(u)):p(!1);break;case 2:a==="unsigned"?this.readInputValue=(c,u)=>c.getUint16(u,s)-2**15:a==="signed"?this.readInputValue=(c,u)=>c.getInt16(u,s):p(!1);break;case 3:a==="unsigned"?this.readInputValue=(c,u)=>_i(c,u,s)-2**23:a==="signed"?this.readInputValue=(c,u)=>Ha(c,u,s):p(!1);break;case 4:a==="unsigned"?this.readInputValue=(c,u)=>c.getUint32(u,s)-2**31:a==="signed"?this.readInputValue=(c,u)=>c.getInt32(u,s):a==="float"?this.readInputValue=(c,u)=>c.getFloat32(u,s):p(!1);break;case 8:a==="float"?this.readInputValue=(c,u)=>c.getFloat64(u,s):p(!1);break;default:Y(o),p(!1)}switch(o){case 1:a==="ulaw"||a==="alaw"?(this.outputSampleSize=2,this.outputFormat="s16",this.writeOutputValue=(c,u,d)=>c.setInt16(u,d,!0)):(this.outputSampleSize=1,this.outputFormat="u8",this.writeOutputValue=(c,u,d)=>c.setUint8(u,d+2**7));break;case 2:this.outputSampleSize=2,this.outputFormat="s16",this.writeOutputValue=(c,u,d)=>c.setInt16(u,d,!0);break;case 3:this.outputSampleSize=4,this.outputFormat="s32",this.writeOutputValue=(c,u,d)=>c.setInt32(u,d<<8,!0);break;case 4:this.outputSampleSize=4,a==="float"?(this.outputFormat="f32",this.writeOutputValue=(c,u,d)=>c.setFloat32(u,d,!0)):(this.outputFormat="s32",this.writeOutputValue=(c,u,d)=>c.setInt32(u,d,!0));break;case 8:this.outputSampleSize=4,this.outputFormat="f32",this.writeOutputValue=(c,u,d)=>c.setFloat32(u,d,!0);break;default:Y(o),p(!1)}}getDecodeQueueSize(){return 0}decode(e){let r=V(e.data),i=e.byteLength/this.decoderConfig.numberOfChannels/this.inputSampleSize,a=i*this.decoderConfig.numberOfChannels*this.outputSampleSize,o=new ArrayBuffer(a),s=new DataView(o);for(let l=0;l<i*this.decoderConfig.numberOfChannels;l++){let m=l*this.inputSampleSize,f=l*this.outputSampleSize,h=this.readInputValue(r,m);this.writeOutputValue(s,f,h)}let c=i/this.decoderConfig.sampleRate;(this.currentTimestamp===null||Math.abs(e.timestamp-this.currentTimestamp)>=c)&&(this.currentTimestamp=e.timestamp);let u=this.currentTimestamp;this.currentTimestamp+=c;let d=new Te({format:this.outputFormat,data:o,numberOfChannels:this.decoderConfig.numberOfChannels,sampleRate:this.decoderConfig.sampleRate,numberOfFrames:i,timestamp:u});this.onSample(d)}async flush(){}close(){}},Et=class extends Mr{constructor(t){if(!(t instanceof ie))throw new TypeError("audioTrack must be an InputAudioTrack.");super(),this._audioTrack=t}async _createDecoder(t,e){if(!await this._audioTrack.canDecode())throw new Error("This audio track cannot be decoded by this browser. Make sure to check decodability before using a track.");let r=this._audioTrack.codec,i=await this._audioTrack.getDecoderConfig();return p(r&&i),j.includes(i.codec)?new na(t,e,i):new ra(t,e,r,i)}_createPacketSink(){return new je(this._audioTrack)}async getSample(t){at(t);for await(let e of this.mediaSamplesAtTimestamps([t]))return e;throw new Error("Internal error: Iterator returned nothing.")}samples(t=0,e=1/0){return this.mediaSamplesInRange(t,e)}samplesAtTimestamps(t){return this.mediaSamplesAtTimestamps(t)}},ia=class{constructor(t){if(!(t instanceof ie))throw new TypeError("audioTrack must be an InputAudioTrack.");this._audioSampleSink=new Et(t)}_audioSampleToWrappedArrayBuffer(t){return{buffer:t.toAudioBuffer(),timestamp:t.timestamp,duration:t.duration}}async getBuffer(t){at(t);let e=await this._audioSampleSink.getSample(t);return e&&this._audioSampleToWrappedArrayBuffer(e)}buffers(t=0,e=1/0){return ur(this._audioSampleSink.samples(t,e),r=>this._audioSampleToWrappedArrayBuffer(r))}buffersAtTimestamps(t){return ur(this._audioSampleSink.samplesAtTimestamps(t),e=>e&&this._audioSampleToWrappedArrayBuffer(e))}};var _t=class{constructor(t){this._backing=t}isVideoTrack(){return this instanceof Re}isAudioTrack(){return this instanceof ie}get id(){return this._backing.getId()}get internalCodecId(){return this._backing.getInternalCodecId()}get languageCode(){return this._backing.getLanguageCode()}get name(){return this._backing.getName()}get timeResolution(){return this._backing.getTimeResolution()}getFirstTimestamp(){return this._backing.getFirstTimestamp()}computeDuration(){return this._backing.computeDuration()}async computePacketStats(t=1/0){let e=new je(this),r=1/0,i=-1/0,a=0,o=0;for await(let s of e.packets(void 0,void 0,{metadataOnly:!0})){if(a>=t&&s.timestamp>=i)break;r=Math.min(r,s.timestamp),i=Math.max(i,s.timestamp+s.duration),a++,o+=s.byteLength}return{packetCount:a,averagePacketRate:a?Number((a/(i-r)).toPrecision(16)):0,averageBitrate:a?Number((8*o/(i-r)).toPrecision(16)):0}}},Re=class extends _t{constructor(t){super(t),this._backing=t}get type(){return"video"}get codec(){return this._backing.getCodec()}get codedWidth(){return this._backing.getCodedWidth()}get codedHeight(){return this._backing.getCodedHeight()}get rotation(){return this._backing.getRotation()}get displayWidth(){return this._backing.getRotation()%180===0?this._backing.getCodedWidth():this._backing.getCodedHeight()}get displayHeight(){return this._backing.getRotation()%180===0?this._backing.getCodedHeight():this._backing.getCodedWidth()}getColorSpace(){return this._backing.getColorSpace()}async hasHighDynamicRange(){let t=await this._backing.getColorSpace();return t.primaries==="bt2020"||t.primaries==="smpte432"||t.transfer==="pg"||t.transfer==="hlg"||t.matrix==="bt2020-ncl"}getDecoderConfig(){return this._backing.getDecoderConfig()}async getCodecParameterString(){return(await this._backing.getDecoderConfig())?.codec??null}async canDecode(){try{let t=await this._backing.getDecoderConfig();if(!t)return!1;let e=this._backing.getCodec();return p(e!==null),Yt.some(i=>i.supports(e,t))?!0:typeof VideoDecoder>"u"?!1:(await VideoDecoder.isConfigSupported(t)).supported===!0}catch(t){return console.error("Error during decodability check:",t),!1}}async determinePacketType(t){if(!(t instanceof N))throw new TypeError("packet must be an EncodedPacket.");if(t.isMetadataOnly)throw new TypeError("packet must not be metadata-only to determine its type.");return this.codec===null?null:hs(this,t)}},ie=class extends _t{constructor(t){super(t),this._backing=t}get type(){return"audio"}get codec(){return this._backing.getCodec()}get numberOfChannels(){return this._backing.getNumberOfChannels()}get sampleRate(){return this._backing.getSampleRate()}getDecoderConfig(){return this._backing.getDecoderConfig()}async getCodecParameterString(){return(await this._backing.getDecoderConfig())?.codec??null}async canDecode(){try{let t=await this._backing.getDecoderConfig();if(!t)return!1;let e=this._backing.getCodec();return p(e!==null),Zt.some(r=>r.supports(e,t))||t.codec.startsWith("pcm-")?!0:typeof AudioDecoder>"u"?!1:(await AudioDecoder.isConfigSupported(t)).supported===!0}catch(t){return console.error("Error during decodability check:",t),!1}}async determinePacketType(t){if(!(t instanceof N))throw new TypeError("packet must be an EncodedPacket.");return this.codec===null?null:"key"}};var Zn=class extends be{constructor(e){super(e);this.metadataPromise=null;this.dataStart=-1;this.dataSize=-1;this.audioInfo=null;this.tracks=[];this.lastKnownPacketIndex=0;this.metadataTags={};this.reader=e._reader}async readMetadata(){return this.metadataPromise??=(async()=>{let e=this.reader.requestSlice(0,12);e instanceof Promise&&(e=await e),p(e);let r=J(e,4),i=r!=="RIFX",a=r==="RF64",o=tt(e,i),s=a?this.reader.fileSize:Math.min(o+8,this.reader.fileSize??1/0);if(J(e,4)!=="WAVE")throw new Error("Invalid WAVE file - wrong format");let u=0,d=null,l=e.filePos;for(;s===null||l<s;){let f=this.reader.requestSlice(l,8);if(f instanceof Promise&&(f=await f),!f)break;let h=J(f,4),b=tt(f,i),g=f.filePos;if(a&&u===0&&h!=="ds64")throw new Error('Invalid RF64 file: First chunk must be "ds64".');if(h==="fmt ")await this.parseFmtChunk(g,b,i);else if(h==="data"){if(d??=b,this.dataStart=f.filePos,this.dataSize=Math.min(d,(s??1/0)-this.dataStart),this.reader.fileSize===null)break}else if(h==="ds64"){let w=qi(f,i);d=qi(f,i),s=Math.min(w+8,this.reader.fileSize??1/0)}else h==="LIST"&&await this.parseListChunk(g,b,i);l=g+b+(b&1),u++}if(!this.audioInfo)throw new Error('Invalid WAVE file - missing "fmt " chunk');if(this.dataStart===-1)throw new Error('Invalid WAVE file - missing "data" chunk');let m=this.audioInfo.blockSizeInBytes;this.dataSize=Math.floor(this.dataSize/m)*m,this.tracks.push(new ie(new aa(this)))})()}async parseFmtChunk(e,r,i){let a=this.reader.requestSlice(e,r);if(a instanceof Promise&&(a=await a),!a)return;let o=Bt(a,i),s=Bt(a,i),c=tt(a,i);a.skip(4);let u=Bt(a,i),d;if(r===14?d=8:d=Bt(a,i),r>=18&&o!==357){let l=Bt(a,i),m=r-18;if(Math.min(m,l)>=22&&o===65534){a.skip(6);let h=D(a,16);o=h[0]|h[1]<<8}}(o===7||o===6)&&(d=8),this.audioInfo={format:o,numberOfChannels:s,sampleRate:c,sampleSizeInBytes:Math.ceil(d/8),blockSizeInBytes:u}}async parseListChunk(e,r,i){let a=this.reader.requestSlice(e,r);if(a instanceof Promise&&(a=await a),!a)return;let o=J(a,4);if(o!=="INFO"&&o!=="INF0")return;let s=a.filePos;for(;s<=e+r-8;){a.filePos=s;let c=J(a,4),u=tt(a,i),d=D(a,u),l=0;for(let f=0;f<d.length&&d[f]!==0;f++)l++;let m=String.fromCharCode(...d.subarray(0,l));switch(this.metadataTags.raw??={},this.metadataTags.raw[c]=m,c){case"INAM":case"TITL":this.metadataTags.title??=m;break;case"TIT3":this.metadataTags.description??=m;break;case"IART":this.metadataTags.artist??=m;break;case"IPRD":this.metadataTags.album??=m;break;case"IPRT":case"ITRK":case"TRCK":{let f=m.split("/"),h=Number.parseInt(f[0],10),b=f[1]&&Number.parseInt(f[1],10);Number.isInteger(h)&&h>0&&(this.metadataTags.trackNumber??=h),b&&Number.isInteger(b)&&b>0&&(this.metadataTags.tracksTotal??=b)}break;case"ICRD":case"IDIT":{let f=new Date(m);Number.isNaN(f.getTime())||(this.metadataTags.date??=f)}break;case"YEAR":{let f=Number.parseInt(m,10);Number.isInteger(f)&&f>0&&(this.metadataTags.date??=new Date(f,0,1))}break;case"IGNR":case"GENR":this.metadataTags.genre??=m;break;case"ICMT":case"CMNT":case"COMM":this.metadataTags.comment??=m;break}s+=8+u+(u&1)}}getCodec(){if(p(this.audioInfo),this.audioInfo.format===7)return"ulaw";if(this.audioInfo.format===6)return"alaw";if(this.audioInfo.format===1){if(this.audioInfo.sampleSizeInBytes===1)return"pcm-u8";if(this.audioInfo.sampleSizeInBytes===2)return"pcm-s16";if(this.audioInfo.sampleSizeInBytes===3)return"pcm-s24";if(this.audioInfo.sampleSizeInBytes===4)return"pcm-s32"}return this.audioInfo.format===3&&this.audioInfo.sampleSizeInBytes===4?"pcm-f32":null}async getMimeType(){return"audio/wav"}async computeDuration(){await this.readMetadata();let e=this.tracks[0];return p(e),e.computeDuration()}async getTracks(){return await this.readMetadata(),this.tracks}async getMetadataTags(){return await this.readMetadata(),this.metadataTags}},er=2048,aa=class{constructor(t){this.demuxer=t}getId(){return 1}getCodec(){return this.demuxer.getCodec()}getInternalCodecId(){return p(this.demuxer.audioInfo),this.demuxer.audioInfo.format}async getDecoderConfig(){let t=this.demuxer.getCodec();return t?(p(this.demuxer.audioInfo),{codec:t,numberOfChannels:this.demuxer.audioInfo.numberOfChannels,sampleRate:this.demuxer.audioInfo.sampleRate}):null}async computeDuration(){let t=await this.getPacket(1/0,{metadataOnly:!0});return(t?.timestamp??0)+(t?.duration??0)}getNumberOfChannels(){return p(this.demuxer.audioInfo),this.demuxer.audioInfo.numberOfChannels}getSampleRate(){return p(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getTimeResolution(){return p(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getName(){return null}getLanguageCode(){return te}async getFirstTimestamp(){return 0}async getPacketAtIndex(t,e){p(this.demuxer.audioInfo);let r=t*er*this.demuxer.audioInfo.blockSizeInBytes;if(r>=this.demuxer.dataSize)return null;let i=Math.min(er*this.demuxer.audioInfo.blockSizeInBytes,this.demuxer.dataSize-r);if(this.demuxer.reader.fileSize===null){let c=this.demuxer.reader.requestSlice(this.demuxer.dataStart+r,i);if(c instanceof Promise&&(c=await c),!c)return null}let a;if(e.metadataOnly)a=le;else{let c=this.demuxer.reader.requestSlice(this.demuxer.dataStart+r,i);c instanceof Promise&&(c=await c),p(c),a=D(c,i)}let o=t*er/this.demuxer.audioInfo.sampleRate,s=i/this.demuxer.audioInfo.blockSizeInBytes/this.demuxer.audioInfo.sampleRate;return this.demuxer.lastKnownPacketIndex=Math.max(t,o),new N(a,"key",o,s,t,i)}getFirstPacket(t){return this.getPacketAtIndex(0,t)}async getPacket(t,e){p(this.demuxer.audioInfo);let r=Math.floor(Math.min(t*this.demuxer.audioInfo.sampleRate/er,(this.demuxer.dataSize-1)/(er*this.demuxer.audioInfo.blockSizeInBytes))),i=await this.getPacketAtIndex(r,e);if(i)return i;if(r===0)return null;p(this.demuxer.reader.fileSize===null);let a=await this.getPacketAtIndex(this.demuxer.lastKnownPacketIndex,e);for(;a;){let o=await this.getNextPacket(a,e);if(!o)break;a=o}return a}getNextPacket(t,e){p(this.demuxer.audioInfo);let r=Math.round(t.timestamp*this.demuxer.audioInfo.sampleRate/er);return this.getPacketAtIndex(r+1,e)}getKeyPacket(t,e){return this.getPacket(t,e)}getNextKeyPacket(t,e){return this.getNextPacket(t,e)}};var Jn=class{constructor(t){this.writer=t;this.helper=new Uint8Array(8);this.helperView=new DataView(this.helper.buffer)}writeU16(t){this.helperView.setUint16(0,t,!0),this.writer.write(this.helper.subarray(0,2))}writeU32(t){this.helperView.setUint32(0,t,!0),this.writer.write(this.helper.subarray(0,4))}writeU64(t){this.helperView.setUint32(0,t,!0),this.helperView.setUint32(4,Math.floor(t/2**32),!0),this.writer.write(this.helper)}writeAscii(t){this.writer.write(new TextEncoder().encode(t))}};var ei=class extends he{constructor(e,r){super(e);this.headerWritten=!1;this.dataSize=0;this.sampleRate=null;this.sampleCount=0;this.riffSizePos=null;this.dataSizePos=null;this.ds64RiffSizePos=null;this.ds64DataSizePos=null;this.ds64SampleCountPos=null;this.format=r,this.writer=e._writer,this.riffWriter=new Jn(e._writer),this.isRf64=!!r._options.large}async start(){}async getMimeType(){return"audio/wav"}async addEncodedVideoPacket(){throw new Error("WAVE does not support video.")}async addEncodedAudioPacket(e,r,i){let a=await this.mutex.acquire();try{if(this.headerWritten||(Ue(i),p(i),p(i.decoderConfig),this.writeHeader(e,i.decoderConfig),this.sampleRate=i.decoderConfig.sampleRate,this.headerWritten=!0),this.validateAndNormalizeTimestamp(e,r.timestamp,r.type==="key"),!this.isRf64&&this.writer.getPos()+r.data.byteLength>=2**32)throw new Error("Adding more audio data would exceed the maximum RIFF size of 4 GiB. To write larger files, use RF64 by setting `large: true` in the WavOutputFormatOptions.");this.writer.write(r.data),this.dataSize+=r.data.byteLength,this.sampleCount+=Math.round(r.duration*this.sampleRate),await this.writer.flush()}finally{a()}}async addSubtitleCue(){throw new Error("WAVE does not support subtitles.")}writeHeader(e,r){this.format._options.onHeader&&this.writer.startTrackingWrites();let i,a=e.source._codec,o=se(a);o.dataType==="ulaw"?i=7:o.dataType==="alaw"?i=6:o.dataType==="float"?i=3:i=1;let s=r.numberOfChannels,c=r.sampleRate,u=o.sampleSize*s;if(this.riffWriter.writeAscii(this.isRf64?"RF64":"RIFF"),this.isRf64?this.riffWriter.writeU32(4294967295):(this.riffSizePos=this.writer.getPos(),this.riffWriter.writeU32(0)),this.riffWriter.writeAscii("WAVE"),this.isRf64&&(this.riffWriter.writeAscii("ds64"),this.riffWriter.writeU32(28),this.ds64RiffSizePos=this.writer.getPos(),this.riffWriter.writeU64(0),this.ds64DataSizePos=this.writer.getPos(),this.riffWriter.writeU64(0),this.ds64SampleCountPos=this.writer.getPos(),this.riffWriter.writeU64(0),this.riffWriter.writeU32(0)),this.riffWriter.writeAscii("fmt "),this.riffWriter.writeU32(16),this.riffWriter.writeU16(i),this.riffWriter.writeU16(s),this.riffWriter.writeU32(c),this.riffWriter.writeU32(c*u),this.riffWriter.writeU16(u),this.riffWriter.writeU16(8*o.sampleSize),rn(this.output._metadataTags)||this.writeInfoChunk(this.output._metadataTags),this.riffWriter.writeAscii("data"),this.isRf64?this.riffWriter.writeU32(4294967295):(this.dataSizePos=this.writer.getPos(),this.riffWriter.writeU32(0)),this.format._options.onHeader){let{data:d,start:l}=this.writer.stopTrackingWrites();this.format._options.onHeader(d,l)}}writeInfoChunk(e){let r=this.writer.getPos();this.riffWriter.writeAscii("LIST"),this.riffWriter.writeU32(0),this.riffWriter.writeAscii("INFO");let i=new Set,a=(c,u)=>{if(!dt(u)){console.warn(`Didn't write tag '${c}' because '${u}' is not ISO 8859-1-compatible.`);return}let d=u.length+1,l=new Uint8Array(d);for(let m=0;m<u.length;m++)l[m]=u.charCodeAt(m);this.riffWriter.writeAscii(c),this.riffWriter.writeU32(d),this.writer.write(l),d&1&&this.writer.write(new Uint8Array(1)),i.add(c)};for(let{key:c,value:u}of _e(e))switch(c){case"title":a("INAM",u),i.add("INAM");break;case"artist":a("IART",u),i.add("IART");break;case"album":a("IPRD",u),i.add("IPRD");break;case"trackNumber":{let d=e.tracksTotal!==void 0?`${u}/${e.tracksTotal}`:u.toString();a("ITRK",d),i.add("ITRK")}break;case"genre":a("IGNR",u),i.add("IGNR");break;case"date":a("ICRD",u.toISOString().slice(0,10)),i.add("ICRD");break;case"comment":a("ICMT",u),i.add("ICMT");break;case"albumArtist":case"discNumber":case"tracksTotal":case"discsTotal":case"description":case"lyrics":case"images":break;case"raw":break;default:Y(c)}if(e.raw)for(let c in e.raw){let u=e.raw[c];u==null||c.length!==4||i.has(c)||typeof u=="string"&&a(c,u)}let o=this.writer.getPos(),s=o-r-8;this.writer.seek(r+4),this.riffWriter.writeU32(s),this.writer.seek(o),s&1&&this.writer.write(new Uint8Array(1))}async finalize(){let e=await this.mutex.acquire(),r=this.writer.getPos();this.isRf64?(p(this.ds64RiffSizePos!==null),this.writer.seek(this.ds64RiffSizePos),this.riffWriter.writeU64(r-8),p(this.ds64DataSizePos!==null),this.writer.seek(this.ds64DataSizePos),this.riffWriter.writeU64(this.dataSize),p(this.ds64SampleCountPos!==null),this.writer.seek(this.ds64SampleCountPos),this.riffWriter.writeU64(this.sampleCount)):(p(this.riffSizePos!==null),this.writer.seek(this.riffSizePos),this.riffWriter.writeU32(r-8),p(this.dataSizePos!==null),this.writer.seek(this.dataSizePos),this.riffWriter.writeU32(this.dataSize)),this.writer.seek(r),e()}};var De=class{getSupportedVideoCodecs(){return this.getSupportedCodecs().filter(t=>re.includes(t))}getSupportedAudioCodecs(){return this.getSupportedCodecs().filter(t=>ae.includes(t))}getSupportedSubtitleCodecs(){return this.getSupportedCodecs().filter(t=>ye.includes(t))}_codecUnsupportedHint(t){return""}},Rr=class extends De{constructor(t={}){if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.fastStart!==void 0&&![!1,"in-memory","fragmented"].includes(t.fastStart))throw new TypeError('options.fastStart, when provided, must be false, "in-memory", or "fragmented".');if(t.minimumFragmentDuration!==void 0&&(!Number.isFinite(t.minimumFragmentDuration)||t.minimumFragmentDuration<0))throw new TypeError("options.minimumFragmentDuration, when provided, must be a non-negative number.");if(t.onFtyp!==void 0&&typeof t.onFtyp!="function")throw new TypeError("options.onFtyp, when provided, must be a function.");if(t.onMoov!==void 0&&typeof t.onMoov!="function")throw new TypeError("options.onMoov, when provided, must be a function.");if(t.onMdat!==void 0&&typeof t.onMdat!="function")throw new TypeError("options.onMdat, when provided, must be a function.");if(t.onMoof!==void 0&&typeof t.onMoof!="function")throw new TypeError("options.onMoof, when provided, must be a function.");super(),this._options=t}getSupportedTrackCounts(){return{video:{min:0,max:1/0},audio:{min:0,max:1/0},subtitle:{min:0,max:1/0},total:{min:1,max:2**32-1}}}get supportsVideoRotationMetadata(){return!0}_createMuxer(t){return new En(t,this)}},tr=class extends Rr{constructor(t){super(t)}get _name(){return"MP4"}get fileExtension(){return".mp4"}get mimeType(){return"video/mp4"}getSupportedCodecs(){return[...re,...Ze,"pcm-s16","pcm-s16be","pcm-s24","pcm-s24be","pcm-s32","pcm-s32be","pcm-f32","pcm-f32be","pcm-f64","pcm-f64be",...ye]}_codecUnsupportedHint(t){return new zt().getSupportedCodecs().includes(t)?" Switching to MOV will grant support for this codec.":""}},zt=class extends Rr{constructor(t){super(t)}get _name(){return"MOV"}get fileExtension(){return".mov"}get mimeType(){return"video/quicktime"}getSupportedCodecs(){return[...re,...ae]}_codecUnsupportedHint(t){return new tr().getSupportedCodecs().includes(t)?" Switching to MP4 will grant support for this codec.":""}},Dr=class extends De{constructor(t={}){if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.appendOnly!==void 0&&typeof t.appendOnly!="boolean")throw new TypeError("options.appendOnly, when provided, must be a boolean.");if(t.minimumClusterDuration!==void 0&&(!Number.isFinite(t.minimumClusterDuration)||t.minimumClusterDuration<0))throw new TypeError("options.minimumClusterDuration, when provided, must be a non-negative number.");if(t.onEbmlHeader!==void 0&&typeof t.onEbmlHeader!="function")throw new TypeError("options.onEbmlHeader, when provided, must be a function.");if(t.onSegmentHeader!==void 0&&typeof t.onSegmentHeader!="function")throw new TypeError("options.onHeader, when provided, must be a function.");if(t.onCluster!==void 0&&typeof t.onCluster!="function")throw new TypeError("options.onCluster, when provided, must be a function.");super(),this._options=t}_createMuxer(t){return new Dn(t,this)}get _name(){return"Matroska"}getSupportedTrackCounts(){return{video:{min:0,max:1/0},audio:{min:0,max:1/0},subtitle:{min:0,max:1/0},total:{min:1,max:127}}}get fileExtension(){return".mkv"}get mimeType(){return"video/x-matroska"}getSupportedCodecs(){return[...re,...Ze,...j.filter(t=>!["pcm-s8","pcm-f32be","pcm-f64be","ulaw","alaw"].includes(t)),...ye]}get supportsVideoRotationMetadata(){return!1}},qt=class extends Dr{constructor(t){super(t)}getSupportedCodecs(){return[...re.filter(t=>["vp8","vp9","av1"].includes(t)),...ae.filter(t=>["opus","vorbis"].includes(t)),...ye]}get _name(){return"WebM"}get fileExtension(){return".webm"}get mimeType(){return"video/webm"}_codecUnsupportedHint(t){return new Dr().getSupportedCodecs().includes(t)?" Switching to MKV will grant support for this codec.":""}},sa=class extends De{constructor(t={}){if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.xingHeader!==void 0&&typeof t.xingHeader!="boolean")throw new TypeError("options.xingHeader, when provided, must be a boolean.");if(t.onXingFrame!==void 0&&typeof t.onXingFrame!="function")throw new TypeError("options.onXingFrame, when provided, must be a function.");super(),this._options=t}_createMuxer(t){return new Wn(t,this)}get _name(){return"MP3"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:1,max:1},subtitle:{min:0,max:0},total:{min:1,max:1}}}get fileExtension(){return".mp3"}get mimeType(){return"audio/mpeg"}getSupportedCodecs(){return["mp3"]}get supportsVideoRotationMetadata(){return!1}},oa=class extends De{constructor(t={}){if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.large!==void 0&&typeof t.large!="boolean")throw new TypeError("options.large, when provided, must be a boolean.");if(t.onHeader!==void 0&&typeof t.onHeader!="function")throw new TypeError("options.onHeader, when provided, must be a function.");super(),this._options=t}_createMuxer(t){return new ei(t,this)}get _name(){return"WAVE"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:1,max:1},subtitle:{min:0,max:0},total:{min:1,max:1}}}get fileExtension(){return".wav"}get mimeType(){return"audio/wav"}getSupportedCodecs(){return[...j.filter(t=>["pcm-s16","pcm-s24","pcm-s32","pcm-f32","pcm-u8","ulaw","alaw"].includes(t))]}get supportsVideoRotationMetadata(){return!1}},ca=class extends De{constructor(t={}){if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.onPage!==void 0&&typeof t.onPage!="function")throw new TypeError("options.onPage, when provided, must be a function.");super(),this._options=t}_createMuxer(t){return new jn(t,this)}get _name(){return"Ogg"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:0,max:1/0},subtitle:{min:0,max:0},total:{min:1,max:2**32}}}get fileExtension(){return".ogg"}get mimeType(){return"application/ogg"}getSupportedCodecs(){return[...ae.filter(t=>["vorbis","opus"].includes(t))]}get supportsVideoRotationMetadata(){return!1}},ua=class extends De{constructor(t={}){if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.onFrame!==void 0&&typeof t.onFrame!="function")throw new TypeError("options.onFrame, when provided, must be a function.");super(),this._options=t}_createMuxer(t){return new un(t,this)}get _name(){return"ADTS"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:1,max:1},subtitle:{min:0,max:0},total:{min:1,max:1}}}get fileExtension(){return".aac"}get mimeType(){return"audio/aac"}getSupportedCodecs(){return["aac"]}get supportsVideoRotationMetadata(){return!1}};var ni=n=>{if(!n||typeof n!="object")throw new TypeError("Encoding config must be an object.");if(!re.includes(n.codec))throw new TypeError(`Invalid video codec '${n.codec}'. Must be one of: ${re.join(", ")}.`);if(!(n.bitrate instanceof oe)&&(!Number.isInteger(n.bitrate)||n.bitrate<=0))throw new TypeError("config.bitrate must be a positive integer or a quality.");if(n.keyFrameInterval!==void 0&&(!Number.isFinite(n.keyFrameInterval)||n.keyFrameInterval<0))throw new TypeError("config.keyFrameInterval, when provided, must be a non-negative number.");if(n.sizeChangeBehavior!==void 0&&!["deny","passThrough","fill","contain","cover"].includes(n.sizeChangeBehavior))throw new TypeError("config.sizeChangeBehavior, when provided, must be 'deny', 'passThrough', 'fill', 'contain' or 'cover'.");if(n.onEncodedPacket!==void 0&&typeof n.onEncodedPacket!="function")throw new TypeError("config.onEncodedChunk, when provided, must be a function.");if(n.onEncoderConfig!==void 0&&typeof n.onEncoderConfig!="function")throw new TypeError("config.onEncoderConfig, when provided, must be a function.");ro(n.codec,n)},ro=(n,t)=>{if(!t||typeof t!="object")throw new TypeError("Encoding options must be an object.");if(t.bitrateMode!==void 0&&!["constant","variable"].includes(t.bitrateMode))throw new TypeError("bitrateMode, when provided, must be 'constant' or 'variable'.");if(t.latencyMode!==void 0&&!["quality","realtime"].includes(t.latencyMode))throw new TypeError("latencyMode, when provided, must be 'quality' or 'realtime'.");if(t.fullCodecString!==void 0&&typeof t.fullCodecString!="string")throw new TypeError("fullCodecString, when provided, must be a string.");if(t.fullCodecString!==void 0&&Oi(t.fullCodecString)!==n)throw new TypeError(`fullCodecString, when provided, must be a string that matches the specified codec (${n}).`);if(t.hardwareAcceleration!==void 0&&!["no-preference","prefer-hardware","prefer-software"].includes(t.hardwareAcceleration))throw new TypeError("hardwareAcceleration, when provided, must be 'no-preference', 'prefer-hardware' or 'prefer-software'.");if(t.scalabilityMode!==void 0&&typeof t.scalabilityMode!="string")throw new TypeError("scalabilityMode, when provided, must be a string.");if(t.contentHint!==void 0&&typeof t.contentHint!="string")throw new TypeError("contentHint, when provided, must be a string.")},ti=n=>{let t=n.bitrate instanceof oe?n.bitrate._toVideoBitrate(n.codec,n.width,n.height):n.bitrate;return{codec:n.fullCodecString??rs(n.codec,n.width,n.height,t),width:n.width,height:n.height,bitrate:t,bitrateMode:n.bitrateMode,framerate:n.framerate,latencyMode:n.latencyMode,hardwareAcceleration:n.hardwareAcceleration,scalabilityMode:n.scalabilityMode,contentHint:n.contentHint,...ss(n.codec)}},ii=n=>{if(!n||typeof n!="object")throw new TypeError("Encoding config must be an object.");if(!ae.includes(n.codec))throw new TypeError(`Invalid audio codec '${n.codec}'. Must be one of: ${ae.join(", ")}.`);if(n.bitrate===void 0&&(!j.includes(n.codec)||n.codec==="flac"))throw new TypeError("config.bitrate must be provided for compressed audio codecs.");if(n.bitrate!==void 0&&!(n.bitrate instanceof oe)&&(!Number.isInteger(n.bitrate)||n.bitrate<=0))throw new TypeError("config.bitrate, when provided, must be a positive integer or a quality.");if(n.onEncodedPacket!==void 0&&typeof n.onEncodedPacket!="function")throw new TypeError("config.onEncodedChunk, when provided, must be a function.");if(n.onEncoderConfig!==void 0&&typeof n.onEncoderConfig!="function")throw new TypeError("config.onEncoderConfig, when provided, must be a function.");no(n.codec,n)},no=(n,t)=>{if(!t||typeof t!="object")throw new TypeError("Encoding options must be an object.");if(t.bitrateMode!==void 0&&!["constant","variable"].includes(t.bitrateMode))throw new TypeError("bitrateMode, when provided, must be 'constant' or 'variable'.");if(t.fullCodecString!==void 0&&typeof t.fullCodecString!="string")throw new TypeError("fullCodecString, when provided, must be a string.");if(t.fullCodecString!==void 0&&Oi(t.fullCodecString)!==n)throw new TypeError(`fullCodecString, when provided, must be a string that matches the specified codec (${n}).`)},ri=n=>{let t=n.bitrate instanceof oe?n.bitrate._toAudioBitrate(n.codec):n.bitrate;return{codec:n.fullCodecString??is(n.codec,n.numberOfChannels,n.sampleRate),numberOfChannels:n.numberOfChannels,sampleRate:n.sampleRate,bitrate:t,bitrateMode:n.bitrateMode,...os(n.codec)}},oe=class{constructor(t){this._factor=t}_toVideoBitrate(t,e,r){let i=e*r,a={avc:1,hevc:.6,vp9:.6,av1:.4,vp8:1.2},o=1920*1080,s=3e6,c=Math.pow(i/o,.95),l=s*c*a[t]*this._factor;return Math.ceil(l/1e3)*1e3}_toAudioBitrate(t){if(j.includes(t)||t==="flac")return;let r={aac:128e3,opus:64e3,mp3:16e4,vorbis:64e3}[t];if(!r)throw new Error(`Unhandled codec: ${t}`);let i=r*this._factor;return t==="aac"?i=[96e3,128e3,16e4,192e3].reduce((o,s)=>Math.abs(s-i)<Math.abs(o-i)?s:o):t==="opus"||t==="vorbis"?i=Math.max(6e3,i):t==="mp3"&&(i=[8e3,16e3,24e3,32e3,4e4,48e3,64e3,8e4,96e3,112e3,128e3,16e4,192e3,224e3,256e3,32e4].reduce((o,s)=>Math.abs(s-i)<Math.abs(o-i)?s:o)),Math.round(i/1e3)*1e3}},nu=new oe(.3),iu=new oe(.6),au=new oe(1),ai=new oe(2),su=new oe(4),ou=n=>{if(re.includes(n))return si(n);if(ae.includes(n))return oi(n);if(ye.includes(n))return ci(n);throw new TypeError(`Unknown codec '${n}'.`)},si=async(n,t={})=>{let{width:e=1280,height:r=720,bitrate:i=1e6,...a}=t;if(!re.includes(n))return!1;if(!Number.isInteger(e)||e<=0)throw new TypeError("width must be a positive integer.");if(!Number.isInteger(r)||r<=0)throw new TypeError("height must be a positive integer.");if(!(i instanceof oe)&&(!Number.isInteger(i)||i<=0))throw new TypeError("bitrate must be a positive integer or a quality.");ro(n,a);let o=null;return Pt.length>0&&(o??=ti({codec:n,width:e,height:r,bitrate:i,framerate:void 0,...a}),Pt.some(c=>c.supports(n,o)))?!0:typeof VideoEncoder>"u"?!1:(o??=ti({codec:n,width:e,height:r,bitrate:i,framerate:void 0,...a}),(await VideoEncoder.isConfigSupported(o)).supported===!0)},oi=async(n,t={})=>{let{numberOfChannels:e=2,sampleRate:r=48e3,bitrate:i=128e3,...a}=t;if(!ae.includes(n))return!1;if(!Number.isInteger(e)||e<=0)throw new TypeError("numberOfChannels must be a positive integer.");if(!Number.isInteger(r)||r<=0)throw new TypeError("sampleRate must be a positive integer.");if(!(i instanceof oe)&&(!Number.isInteger(i)||i<=0))throw new TypeError("bitrate must be a positive integer.");no(n,a);let o=null;return vt.length>0&&(o??=ri({codec:n,numberOfChannels:e,sampleRate:r,bitrate:i,...a}),vt.some(c=>c.supports(n,o)))||j.includes(n)?!0:typeof AudioEncoder>"u"?!1:(o??=ri({codec:n,numberOfChannels:e,sampleRate:r,bitrate:i,...a}),(await AudioEncoder.isConfigSupported(o)).supported===!0)},ci=async n=>!!ye.includes(n),cu=async()=>{let[n,t,e]=await Promise.all([io(),Br(),ao()]);return[...n,...t,...e]},io=async(n=re,t)=>{let e=await Promise.all(n.map(r=>si(r,t)));return n.filter((r,i)=>e[i])},Br=async(n=ae,t)=>{let e=await Promise.all(n.map(r=>oi(r,t)));return n.filter((r,i)=>e[i])},ao=async(n=ye)=>{let t=await Promise.all(n.map(ci));return n.filter((e,r)=>t[r])},da=async(n,t)=>{for(let e of n)if(await si(e,t))return e;return null},uu=async(n,t)=>{for(let e of n)if(await oi(e,t))return e;return null},du=async n=>{for(let t of n)if(await ci(t))return t;return null};var rr=class{constructor(){this._connectedTrack=null;this._closingPromise=null;this._closed=!1;this._timestampOffset=0}_ensureValidAdd(){if(!this._connectedTrack)throw new Error("Source is not connected to an output track.");if(this._connectedTrack.output.state==="canceled")throw new Error("Output has been canceled.");if(this._connectedTrack.output.state==="finalizing"||this._connectedTrack.output.state==="finalized")throw new Error("Output has been finalized.");if(this._connectedTrack.output.state==="pending")throw new Error("Output has not started.");if(this._closed)throw new Error("Source is closed.")}async _start(){}async _flushAndClose(t){}close(){if(this._closingPromise)return;let t=this._connectedTrack;if(!t)throw new Error("Cannot call close without connecting the source to an output track.");if(t.output.state==="pending")throw new Error("Cannot call close before output has been started.");this._closingPromise=(async()=>{await this._flushAndClose(!1),this._closed=!0,!(t.output.state==="finalizing"||t.output.state==="finalized")&&t.output._muxer.onTrackClose(t)})()}async _flushOrWaitForOngoingClose(t){return this._closingPromise?this._closingPromise:this._flushAndClose(t)}},st=class extends rr{constructor(e){super();this._connectedTrack=null;if(!re.includes(e))throw new TypeError(`Invalid video codec '${e}'. Must be one of: ${re.join(", ")}.`);this._codec=e}},Vr=class extends st{constructor(t){super(t)}add(t,e){if(!(t instanceof N))throw new TypeError("packet must be an EncodedPacket.");if(t.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be added.");if(e!==void 0&&(!e||typeof e!="object"))throw new TypeError("meta, when provided, must be an object.");return this._ensureValidAdd(),this._connectedTrack.output._muxer.addEncodedVideoPacket(this._connectedTrack,t,e)}},zr=class{constructor(t,e){this.source=t;this.encodingConfig=e;this.ensureEncoderPromise=null;this.encoderInitialized=!1;this.encoder=null;this.muxer=null;this.lastMultipleOfKeyFrameInterval=-1;this.codedWidth=null;this.codedHeight=null;this.resizeCanvas=null;this.customEncoder=null;this.customEncoderCallSerializer=new ct;this.customEncoderQueueSize=0;this.encoderError=null}async add(t,e,r){try{if(this.checkForEncoderError(),this.source._ensureValidAdd(),this.codedWidth!==null&&this.codedHeight!==null){if(t.codedWidth!==this.codedWidth||t.codedHeight!==this.codedHeight){let s=this.encodingConfig.sizeChangeBehavior??"deny";if(s!=="passThrough"){if(s==="deny")throw new Error(`Video sample size must remain constant. Expected ${this.codedWidth}x${this.codedHeight}, got ${t.codedWidth}x${t.codedHeight}. To allow the sample size to change over time, set \`sizeChangeBehavior\` to a value other than 'strict' in the encoding options.`);{let c=!1;this.resizeCanvas||(typeof document<"u"?(this.resizeCanvas=document.createElement("canvas"),this.resizeCanvas.width=this.codedWidth,this.resizeCanvas.height=this.codedHeight):this.resizeCanvas=new OffscreenCanvas(this.codedWidth,this.codedHeight),c=!0);let u=this.resizeCanvas.getContext("2d",{alpha:!1});p(u),c||u.clearRect(0,0,this.codedWidth,this.codedHeight),t.drawWithFit(u,{fit:s}),e&&t.close(),t=new ke(this.resizeCanvas,{timestamp:t.timestamp,duration:t.duration,rotation:t.rotation}),e=!0}}}}else this.codedWidth=t.codedWidth,this.codedHeight=t.codedHeight;this.encoderInitialized||(this.ensureEncoderPromise||this.ensureEncoder(t),this.encoderInitialized||await this.ensureEncoderPromise),p(this.encoderInitialized);let i=this.encodingConfig.keyFrameInterval??5,a=Math.floor(t.timestamp/i),o={...r,keyFrame:r?.keyFrame||i===0||a!==this.lastMultipleOfKeyFrameInterval};if(this.lastMultipleOfKeyFrameInterval=a,this.customEncoder){this.customEncoderQueueSize++;let s=t.clone(),c=this.customEncoderCallSerializer.call(()=>this.customEncoder.encode(s,o)).then(()=>this.customEncoderQueueSize--).catch(u=>this.encoderError??=u).finally(()=>{s.close()});this.customEncoderQueueSize>=4&&await c}else{p(this.encoder);let s=t.toVideoFrame();this.encoder.encode(s,o),s.close(),e&&t.close(),this.encoder.encodeQueueSize>=4&&await new Promise(c=>this.encoder.addEventListener("dequeue",c,{once:!0}))}await this.muxer.mutex.currentPromise}finally{e&&t.close()}}async ensureEncoder(t){if(this.encoder)return;let e=new Error;return this.ensureEncoderPromise=(async()=>{let r=ti({width:t.codedWidth,height:t.codedHeight,...this.encodingConfig,framerate:this.source._connectedTrack?.metadata.frameRate});this.encodingConfig.onEncoderConfig?.(r);let i=Pt.find(a=>a.supports(this.encodingConfig.codec,r));if(i)this.customEncoder=new i,this.customEncoder.codec=this.encodingConfig.codec,this.customEncoder.config=r,this.customEncoder.onPacket=(a,o)=>{if(!(a instanceof N))throw new TypeError("The first argument passed to onPacket must be an EncodedPacket.");if(o!==void 0&&(!o||typeof o!="object"))throw new TypeError("The second argument passed to onPacket must be an object or undefined.");this.encodingConfig.onEncodedPacket?.(a,o),this.muxer.addEncodedVideoPacket(this.source._connectedTrack,a,o)},await this.customEncoder.init();else{if(typeof VideoEncoder>"u")throw new Error("VideoEncoder is not supported by this browser.");if(!(await VideoEncoder.isConfigSupported(r)).supported)throw new Error(`This specific encoder configuration (${r.codec}, ${r.bitrate} bps, ${r.width}x${r.height}, hardware acceleration: ${r.hardwareAcceleration??"no-preference"}) is not supported by this browser. Consider using another codec or changing your video parameters.`);this.encoder=new VideoEncoder({output:(o,s)=>{let c=N.fromEncodedChunk(o);this.encodingConfig.onEncodedPacket?.(c,s),this.muxer.addEncodedVideoPacket(this.source._connectedTrack,c,s)},error:o=>{o.stack=e.stack,this.encoderError??=o}}),this.encoder.configure(r)}p(this.source._connectedTrack),this.muxer=this.source._connectedTrack.output._muxer,this.encoderInitialized=!0})()}async flushAndClose(t){t||this.checkForEncoderError(),this.customEncoder?(t||this.customEncoderCallSerializer.call(()=>this.customEncoder.flush()),await this.customEncoderCallSerializer.call(()=>this.customEncoder.close())):this.encoder&&(t||await this.encoder.flush(),this.encoder.state!=="closed"&&this.encoder.close()),t||this.checkForEncoderError()}getQueueSize(){return this.customEncoder?this.customEncoderQueueSize:this.encoder?.encodeQueueSize??0}checkForEncoderError(){if(this.encoderError)throw this.encoderError.stack=new Error().stack,this.encoderError}},nr=class extends st{constructor(t){ni(t),super(t.codec),this._encoder=new zr(this,t)}add(t,e){if(!(t instanceof ke))throw new TypeError("videoSample must be a VideoSample.");return this._encoder.add(t,!1,e)}_flushAndClose(t){return this._encoder.flushAndClose(t)}},fa=class extends st{constructor(t,e){if(!(typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement)&&!(typeof OffscreenCanvas<"u"&&t instanceof OffscreenCanvas))throw new TypeError("canvas must be an HTMLCanvasElement or OffscreenCanvas.");ni(e),super(e.codec),this._encoder=new zr(this,e),this._canvas=t}add(t,e=0,r){if(!Number.isFinite(t)||t<0)throw new TypeError("timestamp must be a non-negative number.");if(!Number.isFinite(e)||e<0)throw new TypeError("duration must be a non-negative number.");let i=new ke(this._canvas,{timestamp:t,duration:e});return this._encoder.add(i,!0,r)}_flushAndClose(t){return this._encoder.flushAndClose(t)}},pa=class extends st{constructor(e,r){if(!(e instanceof MediaStreamTrack)||e.kind!=="video")throw new TypeError("track must be a video MediaStreamTrack.");ni(r),r={...r,latencyMode:"realtime"};super(r.codec);this._abortController=null;this._workerTrackId=null;this._workerListener=null;this._promiseWithResolvers=q();this._errorPromiseAccessed=!1;this._encoder=new zr(this,r),this._track=e}get errorPromise(){return this._errorPromiseAccessed=!0,this._promiseWithResolvers.promise}async _start(){this._errorPromiseAccessed||console.warn("Make sure not to ignore the `errorPromise` field on MediaStreamVideoTrackSource, so that any internal errors get bubbled up properly."),this._abortController=new AbortController;let e=null,r=!1,i=a=>{if(r){a.close();return}if(e===null){e=a.timestamp/1e6;let o=this._connectedTrack.output._muxer;o.firstMediaStreamTimestamp===null?(o.firstMediaStreamTimestamp=performance.now()/1e3,this._timestampOffset=-e):this._timestampOffset=performance.now()/1e3-o.firstMediaStreamTimestamp-e}if(this._encoder.getQueueSize()>=4){a.close();return}this._encoder.add(new ke(a),!0).catch(o=>{r=!0,this._abortController?.abort(),this._promiseWithResolvers.reject(o),this._workerTrackId!==null&&ma({type:"stopTrack",trackId:this._workerTrackId})})};if(typeof MediaStreamTrackProcessor<"u"){let a=new MediaStreamTrackProcessor({track:this._track}),o=new WritableStream({write:i});a.readable.pipeTo(o,{signal:this._abortController.signal}).catch(s=>{s instanceof DOMException&&s.name==="AbortError"||this._promiseWithResolvers.reject(s)})}else if(await pu())this._workerTrackId=mu++,ma({type:"videoTrack",trackId:this._workerTrackId,track:this._track},[this._track]),this._workerListener=o=>{let s=o.data;s.type==="videoFrame"&&s.trackId===this._workerTrackId?i(s.videoFrame):s.type==="error"&&s.trackId===this._workerTrackId&&this._promiseWithResolvers.reject(s.error)},ve.addEventListener("message",this._workerListener);else throw new Error("MediaStreamTrackProcessor is required but not supported by this browser.")}async _flushAndClose(e){this._abortController&&(this._abortController.abort(),this._abortController=null),this._workerTrackId!==null&&(p(this._workerListener),ma({type:"stopTrack",trackId:this._workerTrackId}),await new Promise(r=>{let i=a=>{let o=a.data;o.type==="trackStopped"&&o.trackId===this._workerTrackId&&(p(this._workerListener),ve.removeEventListener("message",this._workerListener),ve.removeEventListener("message",i),r())};ve.addEventListener("message",i)})),await this._encoder.flushAndClose(e)}},ot=class extends rr{constructor(e){super();this._connectedTrack=null;if(!ae.includes(e))throw new TypeError(`Invalid audio codec '${e}'. Must be one of: ${ae.join(", ")}.`);this._codec=e}},Ur=class extends ot{constructor(t){super(t)}add(t,e){if(!(t instanceof N))throw new TypeError("packet must be an EncodedPacket.");if(t.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be added.");if(e!==void 0&&(!e||typeof e!="object"))throw new TypeError("meta, when provided, must be an object.");return this._ensureValidAdd(),this._connectedTrack.output._muxer.addEncodedAudioPacket(this._connectedTrack,t,e)}},Nr=class{constructor(t,e){this.source=t;this.encodingConfig=e;this.ensureEncoderPromise=null;this.encoderInitialized=!1;this.encoder=null;this.muxer=null;this.lastNumberOfChannels=null;this.lastSampleRate=null;this.isPcmEncoder=!1;this.outputSampleSize=null;this.writeOutputValue=null;this.customEncoder=null;this.customEncoderCallSerializer=new ct;this.customEncoderQueueSize=0;this.encoderError=null}async add(t,e){try{if(this.checkForEncoderError(),this.source._ensureValidAdd(),this.lastNumberOfChannels!==null&&this.lastSampleRate!==null){if(t.numberOfChannels!==this.lastNumberOfChannels||t.sampleRate!==this.lastSampleRate)throw new Error(`Audio parameters must remain constant. Expected ${this.lastNumberOfChannels} channels at ${this.lastSampleRate} Hz, got ${t.numberOfChannels} channels at ${t.sampleRate} Hz.`)}else this.lastNumberOfChannels=t.numberOfChannels,this.lastSampleRate=t.sampleRate;if(this.encoderInitialized||(this.ensureEncoderPromise||this.ensureEncoder(t),this.encoderInitialized||await this.ensureEncoderPromise),p(this.encoderInitialized),this.customEncoder){this.customEncoderQueueSize++;let r=t.clone(),i=this.customEncoderCallSerializer.call(()=>this.customEncoder.encode(r)).then(()=>this.customEncoderQueueSize--).catch(a=>this.encoderError??=a).finally(()=>{r.close()});this.customEncoderQueueSize>=4&&await i,await this.muxer.mutex.currentPromise}else if(this.isPcmEncoder)await this.doPcmEncoding(t,e);else{p(this.encoder);let r=t.toAudioData();this.encoder.encode(r),r.close(),e&&t.close(),this.encoder.encodeQueueSize>=4&&await new Promise(i=>this.encoder.addEventListener("dequeue",i,{once:!0})),await this.muxer.mutex.currentPromise}}finally{e&&t.close()}}async doPcmEncoding(t,e){p(this.outputSampleSize),p(this.writeOutputValue);let{numberOfChannels:r,numberOfFrames:i,sampleRate:a,timestamp:o}=t,s=2048,c=[];for(let m=0;m<i;m+=s){let f=Math.min(s,t.numberOfFrames-m),h=f*r*this.outputSampleSize,b=new ArrayBuffer(h),g=new DataView(b);c.push({frameCount:f,view:g})}let u=t.allocationSize({planeIndex:0,format:"f32-planar"}),d=new Float32Array(u/Float32Array.BYTES_PER_ELEMENT);for(let m=0;m<r;m++){t.copyTo(d,{planeIndex:m,format:"f32-planar"});for(let f=0;f<c.length;f++){let{frameCount:h,view:b}=c[f];for(let g=0;g<h;g++)this.writeOutputValue(b,(g*r+m)*this.outputSampleSize,d[f*s+g])}}e&&t.close();let l={decoderConfig:{codec:this.encodingConfig.codec,numberOfChannels:r,sampleRate:a}};for(let m=0;m<c.length;m++){let{frameCount:f,view:h}=c[m],b=h.buffer,g=m*s,w=new N(new Uint8Array(b),"key",o+g/a,f/a);this.encodingConfig.onEncodedPacket?.(w,l),await this.muxer.addEncodedAudioPacket(this.source._connectedTrack,w,l)}}ensureEncoder(t){if(this.encoderInitialized)return;let e=new Error;return this.ensureEncoderPromise=(async()=>{let{numberOfChannels:r,sampleRate:i}=t,a=ri({numberOfChannels:r,sampleRate:i,...this.encodingConfig});this.encodingConfig.onEncoderConfig?.(a);let o=vt.find(s=>s.supports(this.encodingConfig.codec,a));if(o)this.customEncoder=new o,this.customEncoder.codec=this.encodingConfig.codec,this.customEncoder.config=a,this.customEncoder.onPacket=(s,c)=>{if(!(s instanceof N))throw new TypeError("The first argument passed to onPacket must be an EncodedPacket.");if(c!==void 0&&(!c||typeof c!="object"))throw new TypeError("The second argument passed to onPacket must be an object or undefined.");this.encodingConfig.onEncodedPacket?.(s,c),this.muxer.addEncodedAudioPacket(this.source._connectedTrack,s,c)},await this.customEncoder.init();else if(j.includes(this.encodingConfig.codec))this.initPcmEncoder();else{if(typeof AudioEncoder>"u")throw new Error("AudioEncoder is not supported by this browser.");if(!(await AudioEncoder.isConfigSupported(a)).supported)throw new Error(`This specific encoder configuration (${a.codec}, ${a.bitrate} bps, ${a.numberOfChannels} channels, ${a.sampleRate} Hz) is not supported by this browser. Consider using another codec or changing your audio parameters.`);this.encoder=new AudioEncoder({output:(c,u)=>{let d=N.fromEncodedChunk(c);this.encodingConfig.onEncodedPacket?.(d,u),this.muxer.addEncodedAudioPacket(this.source._connectedTrack,d,u)},error:c=>{c.stack=e.stack,this.encoderError??=c}}),this.encoder.configure(a)}p(this.source._connectedTrack),this.muxer=this.source._connectedTrack.output._muxer,this.encoderInitialized=!0})()}initPcmEncoder(){this.isPcmEncoder=!0;let t=this.encodingConfig.codec,{dataType:e,sampleSize:r,littleEndian:i}=se(t);switch(this.outputSampleSize=r,r){case 1:e==="unsigned"?this.writeOutputValue=(a,o,s)=>a.setUint8(o,ee((s+1)*127.5,0,255)):e==="signed"?this.writeOutputValue=(a,o,s)=>{a.setInt8(o,ee(Math.round(s*128),-128,127))}:e==="ulaw"?this.writeOutputValue=(a,o,s)=>{let c=ee(Math.floor(s*32767),-32768,32767);a.setUint8(o,Ys(c))}:e==="alaw"?this.writeOutputValue=(a,o,s)=>{let c=ee(Math.floor(s*32767),-32768,32767);a.setUint8(o,Js(c))}:p(!1);break;case 2:e==="unsigned"?this.writeOutputValue=(a,o,s)=>a.setUint16(o,ee((s+1)*32767.5,0,65535),i):e==="signed"?this.writeOutputValue=(a,o,s)=>a.setInt16(o,ee(Math.round(s*32767),-32768,32767),i):p(!1);break;case 3:e==="unsigned"?this.writeOutputValue=(a,o,s)=>Ai(a,o,ee((s+1)*83886075e-1,0,16777215),i):e==="signed"?this.writeOutputValue=(a,o,s)=>qa(a,o,ee(Math.round(s*8388607),-8388608,8388607),i):p(!1);break;case 4:e==="unsigned"?this.writeOutputValue=(a,o,s)=>a.setUint32(o,ee((s+1)*21474836475e-1,0,4294967295),i):e==="signed"?this.writeOutputValue=(a,o,s)=>a.setInt32(o,ee(Math.round(s*2147483647),-2147483648,2147483647),i):e==="float"?this.writeOutputValue=(a,o,s)=>a.setFloat32(o,s,i):p(!1);break;case 8:e==="float"?this.writeOutputValue=(a,o,s)=>a.setFloat64(o,s,i):p(!1);break;default:Y(r),p(!1)}}async flushAndClose(t){t||this.checkForEncoderError(),this.customEncoder?(t||this.customEncoderCallSerializer.call(()=>this.customEncoder.flush()),await this.customEncoderCallSerializer.call(()=>this.customEncoder.close())):this.encoder&&(t||await this.encoder.flush(),this.encoder.state!=="closed"&&this.encoder.close()),t||this.checkForEncoderError()}getQueueSize(){return this.customEncoder?this.customEncoderQueueSize:this.isPcmEncoder?0:this.encoder?.encodeQueueSize??0}checkForEncoderError(){if(this.encoderError)throw this.encoderError.stack=new Error().stack,this.encoderError}},ir=class extends ot{constructor(t){ii(t),super(t.codec),this._encoder=new Nr(this,t)}add(t){if(!(t instanceof Te))throw new TypeError("audioSample must be an AudioSample.");return this._encoder.add(t,!1)}_flushAndClose(t){return this._encoder.flushAndClose(t)}},ha=class extends ot{constructor(e){ii(e);super(e.codec);this._accumulatedTime=0;this._encoder=new Nr(this,e)}async add(e){if(!(e instanceof AudioBuffer))throw new TypeError("audioBuffer must be an AudioBuffer.");let r=Te._fromAudioBuffer(e,this._accumulatedTime);this._accumulatedTime+=e.duration;for(let i of r)await this._encoder.add(i,!0)}_flushAndClose(e){return this._encoder.flushAndClose(e)}},ga=class extends ot{constructor(e,r){if(!(e instanceof MediaStreamTrack)||e.kind!=="audio")throw new TypeError("track must be an audio MediaStreamTrack.");ii(r);super(r.codec);this._abortController=null;this._audioContext=null;this._scriptProcessorNode=null;this._promiseWithResolvers=q();this._errorPromiseAccessed=!1;this._encoder=new Nr(this,r),this._track=e}get errorPromise(){return this._errorPromiseAccessed=!0,this._promiseWithResolvers.promise}async _start(){if(this._errorPromiseAccessed||console.warn("Make sure not to ignore the `errorPromise` field on MediaStreamVideoTrackSource, so that any internal errors get bubbled up properly."),this._abortController=new AbortController,typeof MediaStreamTrackProcessor<"u"){let e=null,r=new MediaStreamTrackProcessor({track:this._track}),i=new WritableStream({write:a=>{if(e===null){e=a.timestamp/1e6;let o=this._connectedTrack.output._muxer;o.firstMediaStreamTimestamp===null?(o.firstMediaStreamTimestamp=performance.now()/1e3,this._timestampOffset=-e):this._timestampOffset=performance.now()/1e3-o.firstMediaStreamTimestamp-e}if(this._encoder.getQueueSize()>=4){a.close();return}this._encoder.add(new Te(a),!0).catch(o=>{this._abortController?.abort(),this._promiseWithResolvers.reject(o)})}});r.readable.pipeTo(i,{signal:this._abortController.signal}).catch(a=>{a instanceof DOMException&&a.name==="AbortError"||this._promiseWithResolvers.reject(a)})}else{let e=window.AudioContext||window.webkitAudioContext;this._audioContext=new e({sampleRate:this._track.getSettings().sampleRate});let r=this._audioContext.createMediaStreamSource(new MediaStream([this._track]));this._scriptProcessorNode=this._audioContext.createScriptProcessor(4096),this._audioContext.state==="suspended"&&await this._audioContext.resume(),r.connect(this._scriptProcessorNode),this._scriptProcessorNode.connect(this._audioContext.destination);let i=!1,a=0;this._scriptProcessorNode.onaudioprocess=o=>{let s=Te._fromAudioBuffer(o.inputBuffer,a);a+=o.inputBuffer.duration;for(let c of s){if(!i){i=!0;let u=this._connectedTrack.output._muxer;u.firstMediaStreamTimestamp===null?u.firstMediaStreamTimestamp=performance.now()/1e3:this._timestampOffset=performance.now()/1e3-u.firstMediaStreamTimestamp}if(this._encoder.getQueueSize()>=4){c.close();continue}this._encoder.add(c,!0).catch(u=>{this._audioContext.suspend(),this._promiseWithResolvers.reject(u)})}}}}async _flushAndClose(e){this._abortController&&(this._abortController.abort(),this._abortController=null),this._audioContext&&(p(this._scriptProcessorNode),this._scriptProcessorNode.disconnect(),await this._audioContext.suspend()),await this._encoder.flushAndClose(e)}},lu=()=>{let n=(r,i)=>{i?self.postMessage(r,{transfer:i}):self.postMessage(r)};n({type:"support",supported:typeof MediaStreamTrackProcessor<"u"});let t=new Map,e=new Set;self.addEventListener("message",r=>{let i=r.data;switch(i.type){case"videoTrack":{let a=new MediaStreamTrackProcessor({track:i.track}),o=new WritableStream({write:c=>{if(e.has(i.trackId)){c.close();return}n({type:"videoFrame",trackId:i.trackId,videoFrame:c},[c])}}),s=new AbortController;t.set(i.trackId,s),a.readable.pipeTo(o,{signal:s.signal}).catch(c=>{c instanceof DOMException&&c.name==="AbortError"||n({type:"error",trackId:i.trackId,error:c})})}break;case"stopTrack":{let a=t.get(i.trackId);a&&(a.abort(),t.delete(i.trackId)),e.add(i.trackId),n({type:"trackStopped",trackId:i.trackId})}break;default:Y(i)}})},mu=0,ve=null,fu=()=>{let n=new Blob([`(${lu.toString()})()`],{type:"application/javascript"}),t=URL.createObjectURL(n);ve=new Worker(t)},la=null,pu=async()=>la!==null?la:(ve||fu(),new Promise(n=>{p(ve);let t=e=>{let r=e.data;r.type==="support"&&(la=r.supported,ve.removeEventListener("message",t),n(r.supported))};ve.addEventListener("message",t)})),ma=(n,t)=>{p(ve),t?ve.postMessage(n,t):ve.postMessage(n)},ar=class extends rr{constructor(e){super();this._connectedTrack=null;if(!ye.includes(e))throw new TypeError(`Invalid subtitle codec '${e}'. Must be one of: ${ye.join(", ")}.`);this._codec=e}},ba=class extends ar{constructor(t){super(t),this._parser=new dn({codec:t,output:(e,r)=>this._connectedTrack?.output._muxer.addSubtitleCue(this._connectedTrack,e,r)})}add(t){if(typeof t!="string")throw new TypeError("text must be a string.");return this._ensureValidAdd(),this._parser.parse(t),this._connectedTrack.output._muxer.mutex.currentPromise}};var so=["video","audio","subtitle"],ka=n=>{if(!n||typeof n!="object")throw new TypeError("metadata must be an object.");if(n.languageCode!==void 0&&!Xe(n.languageCode))throw new TypeError("metadata.languageCode, when provided, must be a three-letter, ISO 639-2/T language code.");if(n.name!==void 0&&typeof n.name!="string")throw new TypeError("metadata.name, when provided, must be a string.")},sr=class{constructor(t){this.state="pending";this._tracks=[];this._startPromise=null;this._cancelPromise=null;this._finalizePromise=null;this._mutex=new ce;this._metadataTags={};if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(!(t.format instanceof De))throw new TypeError("options.format must be an OutputFormat.");if(!(t.target instanceof pt))throw new TypeError("options.target must be a Target.");if(t.target._output)throw new Error("Target is already used for another output.");t.target._output=this,this.format=t.format,this.target=t.target,this._writer=t.target._createWriter(),this._muxer=t.format._createMuxer(this)}addVideoTrack(t,e={}){if(!(t instanceof st))throw new TypeError("source must be a VideoSource.");if(ka(e),e.rotation!==void 0&&![0,90,180,270].includes(e.rotation))throw new TypeError(`Invalid video rotation: ${e.rotation}. Has to be 0, 90, 180 or 270.`);if(!this.format.supportsVideoRotationMetadata&&e.rotation)throw new Error(`${this.format._name} does not support video rotation metadata.`);if(e.frameRate!==void 0&&(!Number.isFinite(e.frameRate)||e.frameRate<=0))throw new TypeError(`Invalid video frame rate: ${e.frameRate}. Must be a positive number.`);this._addTrack("video",t,e)}addAudioTrack(t,e={}){if(!(t instanceof ot))throw new TypeError("source must be an AudioSource.");ka(e),this._addTrack("audio",t,e)}addSubtitleTrack(t,e={}){if(!(t instanceof ar))throw new TypeError("source must be a SubtitleSource.");ka(e),this._addTrack("subtitle",t,e)}setMetadataTags(t){if(tn(t),this.state!=="pending")throw new Error("Cannot set metadata tags after output has been started or canceled.");this._metadataTags=t}_addTrack(t,e,r){if(this.state!=="pending")throw new Error("Cannot add track after output has been started or canceled.");if(e._connectedTrack)throw new Error("Source is already used for a track.");let i=this.format.getSupportedTrackCounts(),a=this._tracks.reduce((u,d)=>u+(d.type===t?1:0),0),o=i[t].max;if(a===o)throw new Error(o===0?`${this.format._name} does not support ${t} tracks.`:`${this.format._name} does not support more than ${o} ${t} track${o===1?"":"s"}.`);let s=i.total.max;if(this._tracks.length===s)throw new Error(`${this.format._name} does not support more than ${s} tracks${s===1?"":"s"} in total.`);let c={id:this._tracks.length+1,output:this,type:t,source:e,metadata:r};if(c.type==="video"){let u=this.format.getSupportedVideoCodecs();if(u.length===0)throw new Error(`${this.format._name} does not support video tracks.`+this.format._codecUnsupportedHint(c.source._codec));if(!u.includes(c.source._codec))throw new Error(`Codec '${c.source._codec}' cannot be contained within ${this.format._name}. Supported video codecs are: ${u.map(d=>`'${d}'`).join(", ")}.`+this.format._codecUnsupportedHint(c.source._codec))}else if(c.type==="audio"){let u=this.format.getSupportedAudioCodecs();if(u.length===0)throw new Error(`${this.format._name} does not support audio tracks.`+this.format._codecUnsupportedHint(c.source._codec));if(!u.includes(c.source._codec))throw new Error(`Codec '${c.source._codec}' cannot be contained within ${this.format._name}. Supported audio codecs are: ${u.map(d=>`'${d}'`).join(", ")}.`+this.format._codecUnsupportedHint(c.source._codec))}else if(c.type==="subtitle"){let u=this.format.getSupportedSubtitleCodecs();if(u.length===0)throw new Error(`${this.format._name} does not support subtitle tracks.`+this.format._codecUnsupportedHint(c.source._codec));if(!u.includes(c.source._codec))throw new Error(`Codec '${c.source._codec}' cannot be contained within ${this.format._name}. Supported subtitle codecs are: ${u.map(d=>`'${d}'`).join(", ")}.`+this.format._codecUnsupportedHint(c.source._codec))}this._tracks.push(c),e._connectedTrack=c}async start(){let t=this.format.getSupportedTrackCounts();for(let r of so){let i=this._tracks.reduce((o,s)=>o+(s.type===r?1:0),0),a=t[r].min;if(i<a)throw new Error(a===t[r].max?`${this.format._name} requires exactly ${a} ${r} track${a===1?"":"s"}.`:`${this.format._name} requires at least ${a} ${r} track${a===1?"":"s"}.`)}let e=t.total.min;if(this._tracks.length<e)throw new Error(e===t.total.max?`${this.format._name} requires exactly ${e} track${e===1?"":"s"}.`:`${this.format._name} requires at least ${e} track${e===1?"":"s"}.`);if(this.state==="canceled")throw new Error("Output has been canceled.");return this._startPromise?(console.warn("Output has already been started."),this._startPromise):this._startPromise=(async()=>{this.state="started",this._writer.start();let r=await this._mutex.acquire();await this._muxer.start();let i=this._tracks.map(a=>a.source._start());await Promise.all(i),r()})()}getMimeType(){return this._muxer.getMimeType()}async cancel(){if(this._cancelPromise)return console.warn("Output has already been canceled."),this._cancelPromise;if(this.state==="finalizing"||this.state==="finalized"){console.warn("Output has already been finalized.");return}return this._cancelPromise=(async()=>{this.state="canceled";let t=await this._mutex.acquire(),e=this._tracks.map(r=>r.source._flushOrWaitForOngoingClose(!0));await Promise.all(e),await this._writer.close(),t()})()}async finalize(){if(this.state==="pending")throw new Error("Cannot finalize before starting.");if(this.state==="canceled")throw new Error("Cannot finalize after canceling.");return this._finalizePromise?(console.warn("Output has already been finalized."),this._finalizePromise):this._finalizePromise=(async()=>{this.state="finalizing";let t=await this._mutex.acquire(),e=this._tracks.map(r=>r.source._flushOrWaitForOngoingClose(!1));await Promise.all(e),await this._muxer.finalize(),await this._writer.flush(),await this._writer.finalize(),this.state="finalized",t()})()}};var Be=class{constructor(){this._sizePromise=null;this.onread=null}async getSizeOrNull(){return this._sizePromise??=Promise.resolve(this._retrieveSize())}async getSize(){let t=await this.getSizeOrNull();if(t===null)throw new Error("Cannot determine the size of an unsized source.");return t}},Ta=class extends Be{constructor(e){if(!(e instanceof ArrayBuffer)&&!ArrayBuffer.isView(e))throw new TypeError("buffer must be an ArrayBuffer or ArrayBufferView.");super();this._onreadCalled=!1;this._bytes=Q(e),this._view=V(e)}_retrieveSize(){return this._bytes.byteLength}_read(){return this._onreadCalled||(this.onread?.(0,this._bytes.byteLength),this._onreadCalled=!0),{bytes:this._bytes,view:this._view,offset:0}}get _supportsRandomAccess(){return!0}},wa=class extends Be{constructor(e,r={}){if(!(e instanceof Blob))throw new TypeError("blob must be a Blob.");if(!r||typeof r!="object")throw new TypeError("options must be an object.");if(r.maxCacheSize!==void 0&&(!Number.isInteger(r.maxCacheSize)||r.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative integer.");super();this._readers=new WeakMap;this._blob=e,this._orchestrator=new Wr({maxCacheSize:r.maxCacheSize??8*2**20,maxWorkerCount:4,runWorker:this._runWorker.bind(this),prefetchProfile:Ca.fileSystem})}_retrieveSize(){let e=this._blob.size;return this._orchestrator.fileSize=e,e}_read(e,r){return this._orchestrator.read(e,r)}async _runWorker(e){let r=this._readers.get(e);for(r||(r=this._blob.slice(e.currentPos).stream().getReader(),this._readers.set(e,r));e.currentPos<e.targetPos&&!e.aborted;){let{done:i,value:a}=await r.read();if(i){if(this._orchestrator.forgetWorker(e),e.currentPos<e.targetPos)throw new Error("Blob reader stopped unexpectedly before all requested data was read.");break}this.onread?.(e.currentPos,e.currentPos+a.length),this._orchestrator.supplyWorkerData(e,a)}e.running=!1}get _supportsRandomAccess(){return!0}},oo=.5*2**20,ya=class extends Be{constructor(e,r={}){if(typeof e!="string"&&!(e instanceof URL))throw new TypeError("url must be a string or URL.");if(!r||typeof r!="object")throw new TypeError("options must be an object.");if(r.requestInit!==void 0&&(!r.requestInit||typeof r.requestInit!="object"))throw new TypeError("options.requestInit, when provided, must be an object.");if(r.getRetryDelay!==void 0&&typeof r.getRetryDelay!="function")throw new TypeError("options.getRetryDelay, when provided, must be a function.");if(r.maxCacheSize!==void 0&&(!Number.isInteger(r.maxCacheSize)||r.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative integer.");super();this._existingResponses=new WeakMap;this._url=e instanceof URL?e:new URL(e,typeof location<"u"?location.href:void 0),this._options=r,this._getRetryDelay=r.getRetryDelay??(i=>Math.min(2**(i-2),8)),this._orchestrator=new Wr({maxCacheSize:r.maxCacheSize??64*2**20,maxWorkerCount:2,runWorker:this._runWorker.bind(this),prefetchProfile:Ca.network})}async _retrieveSize(){let e=new AbortController,r=await Fi(this._url,Zr(this._options.requestInit??{},{headers:{Range:"bytes=0-"},signal:e.signal}),this._getRetryDelay);if(!r.ok)throw new Error(`Error fetching ${this._url}: ${r.status} ${r.statusText}`);let i,a;if(r.status===206)a=this._getPartialLengthFromRangeResponse(r),i=this._orchestrator.createWorker(0,Math.min(a,oo));else{let o=r.headers.get("Content-Length");if(o)a=Number(o),i=this._orchestrator.createWorker(0,a),this._orchestrator.options.maxCacheSize=1/0,console.warn("HTTP server did not respond with 206 Partial Content, meaning the entire remote resource now has to be downloaded. For efficient media file streaming across a network, please make sure your server supports range requests.");else throw new Error(`HTTP response (status ${r.status}) must surface Content-Length header.`)}return this._orchestrator.fileSize=a,this._existingResponses.set(i,{response:r,abortController:e}),this._orchestrator.runWorker(i),a}_read(e,r){return this._orchestrator.read(e,r)}async _runWorker(e){for(;!e.aborted;){let r=this._existingResponses.get(e);this._existingResponses.delete(e);let i=r?.abortController,a=r?.response;if(i||(i=new AbortController,a=await Fi(this._url,Zr(this._options.requestInit??{},{headers:{Range:`bytes=${e.currentPos}-`},signal:i.signal}),this._getRetryDelay)),p(a),!a.ok)throw new Error(`Error fetching ${this._url}: ${a.status} ${a.statusText}`);if(e.currentPos>0&&a.status!==206)throw new Error("HTTP server did not respond with 206 Partial Content to a range request. To enable efficient media file streaming across a network, please make sure your server supports range requests.");let o=this._getPartialLengthFromRangeResponse(a),s=e.targetPos-e.currentPos;if(o<s)throw new Error(`HTTP response unexpectedly too short: Needed at least ${s} bytes, got only ${o}.`);if(!a.body)throw new Error("Missing HTTP response body.");let c=a.body.getReader();for(;;){let u;try{u=await c.read()}catch(m){let f=this._getRetryDelay(1);if(f!==null){console.error("Error while reading response stream. Attempting to resume.",m),await new Promise(h=>setTimeout(h,1e3*f));break}else throw m}let{done:d,value:l}=u;if(d){if(this._orchestrator.forgetWorker(e),e.currentPos<e.targetPos)throw new Error("Response stream reader stopped unexpectedly before all requested data was read.");e.running=!1;return}if(this.onread?.(e.currentPos,e.currentPos+l.length),this._orchestrator.supplyWorkerData(e,l),e.currentPos>=e.targetPos||e.aborted){i.abort(),e.running=!1;return}}}e.running=!1}_getPartialLengthFromRangeResponse(e){let r=e.headers.get("Content-Range");if(r){let i=/\/(\d+)/.exec(r);if(i)return Number(i[1]);throw new Error(`Invalid Content-Range header: ${r}`)}else{let i=e.headers.get("Content-Length");if(i)return Number(i);throw new Error("Partial HTTP response (status 206) must surface either Content-Range or Content-Length header.")}}get _supportsRandomAccess(){return!0}},Sa=class extends Be{constructor(t,e={}){if(typeof t!="string")throw new TypeError("filePath must be a string.");if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.maxCacheSize!==void 0&&(!Number.isInteger(e.maxCacheSize)||e.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative integer.");super();let r=null;this._streamSource=new ui({getSize:async()=>(r=await(await import("node:fs/promises")).open(t,"r"),(await r.stat()).size),read:async(i,a)=>{p(r);let o=Buffer.alloc(a-i);return await r.read(o,0,a-i,i),o},maxCacheSize:e.maxCacheSize,prefetchProfile:"fileSystem"})}_read(t,e){return this._streamSource._read(t,e)}_retrieveSize(){return this._streamSource._retrieveSize()}get _supportsRandomAccess(){return!0}},ui=class extends Be{constructor(t){if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(typeof t.read!="function")throw new TypeError("options.read must be a function.");if(typeof t.getSize!="function")throw new TypeError("options.getSize must be a function.");if(t.maxCacheSize!==void 0&&(!Number.isInteger(t.maxCacheSize)||t.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative integer.");if(t.prefetchProfile&&!["none","fileSystem","network"].includes(t.prefetchProfile))throw new TypeError("options.prefetchProfile, when provided, must be one of 'none', 'fileSystem' or 'network'.");super(),this._options=t,this._orchestrator=new Wr({maxCacheSize:t.maxCacheSize??8*2**20,maxWorkerCount:2,prefetchProfile:Ca[t.prefetchProfile??"none"],runWorker:this._runWorker.bind(this)})}_retrieveSize(){let t=this._options.getSize();if(t instanceof Promise)return t.then(e=>{if(!Number.isInteger(e)||e<0)throw new TypeError("options.getSize must return or resolve to a non-negative integer.");return this._orchestrator.fileSize=e,e});if(!Number.isInteger(t)||t<0)throw new TypeError("options.getSize must return or resolve to a non-negative integer.");return this._orchestrator.fileSize=t,t}_read(t,e){return this._orchestrator.read(t,e)}async _runWorker(t){for(;t.currentPos<t.targetPos&&!t.aborted;){let e=t.currentPos,r=t.targetPos,i=this._options.read(t.currentPos,r);if(i instanceof Promise&&(i=await i),i instanceof Uint8Array){if(i.length!==r-t.currentPos)throw new Error(`options.read returned a Uint8Array with unexpected length: Requested ${r-t.currentPos} bytes, but got ${i.length}.`);this.onread?.(t.currentPos,t.currentPos+i.length),this._orchestrator.supplyWorkerData(t,i)}else if(i instanceof ReadableStream){let a=i.getReader();for(;;){let{done:o,value:s}=await a.read();if(o){if(t.currentPos<r)throw new Error(`ReadableStream returned by options.read ended before supplying enough data. Requested ${r-e} bytes, but got ${t.currentPos-e}`);break}if(!(s instanceof Uint8Array))throw new TypeError("ReadableStream returned by options.read must yield Uint8Array chunks.");if(this.onread?.(t.currentPos,t.currentPos+s.length),this._orchestrator.supplyWorkerData(t,s),t.currentPos>=r||t.aborted)break}}else throw new TypeError("options.read must return or resolve to a Uint8Array or a ReadableStream.")}t.running=!1}get _supportsRandomAccess(){return!0}},xa=class extends Be{constructor(e,r={}){if(!(e instanceof ReadableStream))throw new TypeError("stream must be a ReadableStream.");if(!r||typeof r!="object")throw new TypeError("options must be an object.");if(r.maxCacheSize!==void 0&&(!Number.isInteger(r.maxCacheSize)||r.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative integer.");super();this._reader=null;this._cache=[];this._pendingSlices=[];this._currentIndex=0;this._targetIndex=0;this._maxRequestedIndex=0;this._endIndex=null;this._pulling=!1;this._stream=e,this._maxCacheSize=r.maxCacheSize??16*2**20}_retrieveSize(){return this._endIndex}_read(e,r){if(this._endIndex!==null&&r>this._endIndex)return null;this._maxRequestedIndex=Math.max(this._maxRequestedIndex,r);let i=U(this._cache,e,l=>l.start),a=i!==-1?this._cache[i]:null;if(a&&a.start<=e&&r<=a.end)return{bytes:a.bytes,view:a.view,offset:a.start};let o=e,s=new Uint8Array(r-e);if(i!==-1)for(let l=i;l<this._cache.length;l++){let m=this._cache[l];if(m.start>=r)break;let f=Math.max(e,m.start);f>o&&this._throwDueToCacheMiss();let h=Math.min(r,m.end);f<h&&(s.set(m.bytes.subarray(f-m.start,h-m.start),f-e),o=h)}if(o===r)return{bytes:s,view:V(s),offset:e};this._currentIndex>o&&this._throwDueToCacheMiss();let{promise:c,resolve:u,reject:d}=q();return this._pendingSlices.push({start:e,end:r,bytes:s,resolve:u,reject:d}),this._targetIndex=Math.max(this._targetIndex,r),this._pulling||(this._pulling=!0,this._pull().catch(l=>{if(this._pulling=!1,this._pendingSlices.length>0)this._pendingSlices.forEach(m=>m.reject(l)),this._pendingSlices.length=0;else throw l})),c}_throwDueToCacheMiss(){throw new Error("Read is before the cached region. With ReadableStreamSource, you must access the data more sequentially or increase the size of its cache.")}async _pull(){for(this._reader??=this._stream.getReader();this._currentIndex<this._targetIndex;){let{done:e,value:r}=await this._reader.read();if(e){for(let o of this._pendingSlices)o.resolve(null);this._pendingSlices.length=0,this._endIndex=this._currentIndex;break}let i=this._currentIndex,a=this._currentIndex+r.byteLength;for(let o=0;o<this._pendingSlices.length;o++){let s=this._pendingSlices[o],c=Math.max(i,s.start),u=Math.min(a,s.end);c<u&&(s.bytes.set(r.subarray(c-i,u-i),c-s.start),u===s.end&&(s.resolve({bytes:s.bytes,view:V(s.bytes),offset:s.start}),this._pendingSlices.splice(o,1),o--))}for(this._cache.push({start:i,end:a,bytes:r,view:V(r),age:0});this._cache.length>0;){let o=this._cache[0];if(this._maxRequestedIndex-o.end<=this._maxCacheSize)break;this._cache.shift()}this._currentIndex+=r.byteLength}this._pulling=!1}get _supportsRandomAccess(){return!1}},Ca={none:(n,t)=>({start:n,end:t}),fileSystem:(n,t)=>(n=Math.floor((n-65536)/65536)*65536,t=Math.ceil((t+65536)/65536)*65536,{start:n,end:t}),network:(n,t,e)=>{n=Math.max(0,Math.floor((n-65536)/65536)*65536);for(let i of e){let o=Math.max((i.startPos+i.targetPos)/2,i.targetPos-8388608);if(en(n,t,o,i.targetPos)){let s=i.targetPos-i.startPos,c=Math.ceil((s+1)/8388608)*8388608,u=2**Math.ceil(Math.log2(s+1)),d=Math.min(u,c);t=Math.max(t,i.startPos+d)}}return t=Math.max(t,n+oo),{start:n,end:t}}},Wr=class{constructor(t){this.options=t;this.fileSize=null;this.nextAge=0;this.workers=[];this.cache=[];this.currentCacheSize=0}read(t,e){p(this.fileSize!==null);let r=this.options.prefetchProfile(t,e,this.workers),i=Math.max(r.start,0),a=Math.min(r.end,this.fileSize);p(i<=t&&e<=a);let o=null,s=U(this.cache,t,k=>k.start),c=s!==-1?this.cache[s]:null;c&&c.start<=t&&e<=c.end&&(c.age=this.nextAge++,o={bytes:c.bytes,view:c.view,offset:c.start});let u=U(this.cache,i,k=>k.start),d=o?null:new Uint8Array(e-t),l=0,m=i,f=[];if(u!==-1){for(let k=u;k<this.cache.length;k++){let T=this.cache[k];if(T.start>=a)break;if(T.end<=i)continue;let S=Math.max(i,T.start),y=Math.min(a,T.end);if(p(S<=y),m<S&&f.push({start:m,end:S}),m=y,d){let x=Math.max(t,T.start),F=Math.min(e,T.end);if(x<F){let _=x-t;d.set(T.bytes.subarray(x-T.start,F-T.start),_),_===l&&(l=F-t)}}T.age=this.nextAge++}m<a&&f.push({start:m,end:a})}else f.push({start:i,end:a});if(d&&l>=d.length&&(o={bytes:d,view:V(d),offset:t}),f.length===0)return p(o),o;let{promise:h,resolve:b,reject:g}=q(),w=[];for(let k of f){let T=Math.max(t,k.start),S=Math.min(e,k.end);T===k.start&&S===k.end?w.push(k):T<S&&w.push({start:T,end:S})}for(let k of f){let T=d&&{start:t,bytes:d,holes:w,resolve:b,reject:g},S=!1;for(let y of this.workers)if(en(k.start-131072,k.start,y.currentPos,y.targetPos)){y.targetPos=Math.max(y.targetPos,k.end),S=!0,T&&!y.pendingSlices.includes(T)&&y.pendingSlices.push(T),y.running||this.runWorker(y);break}if(!S){let y=this.createWorker(k.start,k.end);T&&(y.pendingSlices=[T]),this.runWorker(y)}}return o||(p(d),o=h.then(k=>({bytes:k,view:V(k),offset:t}))),o}createWorker(t,e){let r={startPos:t,currentPos:t,targetPos:e,running:!1,aborted:!1,pendingSlices:[],age:this.nextAge++};for(this.workers.push(r);this.workers.length>this.options.maxWorkerCount;){let i=0,a=this.workers[0];for(let o=1;o<this.workers.length;o++){let s=this.workers[o];s.age<a.age&&(i=o,a=s)}if(a.running&&a.pendingSlices.length>0)break;a.aborted=!0,this.workers.splice(i,1)}return r}runWorker(t){p(!t.running),p(t.currentPos<t.targetPos),t.running=!0,t.age=this.nextAge++,this.options.runWorker(t).catch(e=>{if(t.running=!1,t.pendingSlices.length>0)t.pendingSlices.forEach(r=>r.reject(e)),t.pendingSlices.length=0;else throw e})}supplyWorkerData(t,e){let r=t.currentPos,i=r+e.length;this.insertIntoCache({start:r,end:i,bytes:e,view:V(e),age:this.nextAge++}),t.currentPos+=e.length,t.targetPos=Math.max(t.targetPos,t.currentPos);for(let a=0;a<t.pendingSlices.length;a++){let o=t.pendingSlices[a],s=Math.max(r,o.start),c=Math.min(i,o.start+o.bytes.length);s<c&&o.bytes.set(e.subarray(s-r,c-r),s-o.start);for(let u=0;u<o.holes.length;u++){let d=o.holes[u];r<=d.start&&i>d.start&&(d.start=i),d.end<=d.start&&(o.holes.splice(u,1),u--)}o.holes.length===0&&(o.resolve(o.bytes),t.pendingSlices.splice(a,1),a--)}for(let a=0;a<this.workers.length;a++){let o=this.workers[a];t===o||o.running||en(r,i,o.currentPos,o.targetPos)&&(this.workers.splice(a,1),a--)}}forgetWorker(t){let e=this.workers.indexOf(t);p(e!==-1),this.workers.splice(e,1)}insertIntoCache(t){if(this.options.maxCacheSize===0)return;let e=U(this.cache,t.start,r=>r.start)+1;if(e>0){let r=this.cache[e-1];if(r.end>=t.end)return;if(r.end>t.start){let i=new Uint8Array(t.end-r.start);i.set(r.bytes,0),i.set(t.bytes,t.start-r.start),this.currentCacheSize+=t.end-r.end,r.bytes=i,r.view=V(i),r.end=t.end,e--,t=r}else this.cache.splice(e,0,t),this.currentCacheSize+=t.bytes.length}else this.cache.splice(e,0,t),this.currentCacheSize+=t.bytes.length;for(let r=e+1;r<this.cache.length;r++){let i=this.cache[r];if(t.end<=i.start)break;if(t.end>=i.end){this.cache.splice(r,1),this.currentCacheSize-=i.bytes.length,r--;continue}let a=new Uint8Array(i.end-t.start);a.set(t.bytes,0),a.set(i.bytes,i.start-t.start),this.currentCacheSize-=t.end-i.start,t.bytes=a,t.view=V(a),t.end=i.end,this.cache.splice(r,1);break}for(;this.currentCacheSize>this.options.maxCacheSize;){let r=0,i=this.cache[0];for(let a=1;a<this.cache.length;a++){let o=this.cache[a];o.age<i.age&&(r=a,i=o)}if(this.currentCacheSize-i.bytes.length<=this.options.maxCacheSize)break;this.cache.splice(r,1),this.currentCacheSize-=i.bytes.length}}};var hu=new Set(["@day","@mak","@mod","@swr","@xyz","CAME","CNCV","CNFV","CNMN","FIRM","FOV\0","GoPr","LENS","PXMN","SIGM","SNum","TAGS","albm","albr","angl","auth","ccid","cdis","clfn","clid","clsf","cmid","cmnm","coll","cprt","cver","cvru","date","dscp","fsid","gnre","hinv","icnu","info","infu","kgtt","loci","lrcu","mcvr","name","perf","pmcc","reel","rtng","scen","shot","slno","thmb","titl","tnam","urat","uuid","vndr","yrrc","\xA9ART","\xA9TIM","\xA9TSC","\xA9TSZ","\xA9alb","\xA9arg","\xA9ark","\xA9cmt","\xA9cok","\xA9com","\xA9cpy","\xA9day","\xA9dir","\xA9ed1","\xA9ed2","\xA9ed3","\xA9ed4","\xA9ed5","\xA9ed6","\xA9ed7","\xA9ed8","\xA9ed9","\xA9enc","\xA9fmt","\xA9fpt","\xA9frl","\xA9fyw","\xA9gen","\xA9gpt","\xA9grl","\xA9grp","\xA9gyw","\xA9inf","\xA9isr","\xA9lab","\xA9lal","\xA9lyr","\xA9mak","\xA9mal","\xA9mdl","\xA9mod","\xA9nam","\xA9pdk","\xA9phg","\xA9prd","\xA9prf","\xA9prk","\xA9prl","\xA9req","\xA9snk","\xA9snm","\xA9src","\xA9swf","\xA9swk","\xA9swr","\xA9too","\xA9trk","\xA9wrt","\xA9xsp","\xA9xyz","\xA9ysp","\xA9zsp"]),di=class extends be{constructor(e){super(e);this.moovSlice=null;this.currentTrack=null;this.tracks=[];this.metadataPromise=null;this.movieTimescale=-1;this.movieDurationInTimescale=-1;this.isQuickTime=!1;this.metadataTags={};this.currentMetadataKeys=null;this.isFragmented=!1;this.fragmentTrackDefaults=[];this.fragments=[];this.currentFragment=null;this.fragmentLookupMutex=new ce;this.reader=e._reader}async computeDuration(){let e=await this.getTracks(),r=await Promise.all(e.map(i=>i.computeDuration()));return Math.max(0,...r)}async getTracks(){return await this.readMetadata(),this.tracks.map(e=>e.inputTrack)}async getMimeType(){await this.readMetadata();let e=await Promise.all(this.tracks.map(r=>r.inputTrack.getCodecParameterString()));return xn({isQuickTime:this.isQuickTime,hasVideo:this.tracks.some(r=>r.info?.type==="video"),hasAudio:this.tracks.some(r=>r.info?.type==="audio"),codecStrings:e.filter(Boolean)})}async getMetadataTags(){return await this.readMetadata(),this.metadataTags}readMetadata(){return this.metadataPromise??=(async()=>{let e=0;for(;;){let r=this.reader.requestSliceRange(e,xe,qe);if(r instanceof Promise&&(r=await r),!r)break;let i=e,a=Ke(r);if(!a)break;if(a.name==="ftyp"){let o=J(r,4);this.isQuickTime=o==="qt  "}else if(a.name==="moov"){let o=this.reader.requestSlice(r.filePos,a.contentSize);if(o instanceof Promise&&(o=await o),!o)break;this.moovSlice=o,this.readContiguousBoxes(this.moovSlice);for(let s of this.tracks){let c=s.editListPreviousSegmentDurations/this.movieTimescale;s.editListOffset-=Math.round(c*s.timescale)}break}e=i+a.totalSize}if(this.isFragmented&&this.reader.fileSize!==null){let r=this.reader.requestSlice(this.reader.fileSize-4,4);r instanceof Promise&&(r=await r),p(r);let i=v(r),a=this.reader.fileSize-i;if(a>=0&&a<=this.reader.fileSize-qe){let o=this.reader.requestSliceRange(a,xe,qe);if(o instanceof Promise&&(o=await o),o){let s=Ke(o);if(s&&s.name==="mfra"){let c=this.reader.requestSlice(o.filePos,s.contentSize);c instanceof Promise&&(c=await c),c&&this.readContiguousBoxes(c)}}}}})()}getSampleTableForTrack(e){if(e.sampleTable)return e.sampleTable;let r={sampleTimingEntries:[],sampleCompositionTimeOffsets:[],sampleSizes:[],keySampleIndices:null,chunkOffsets:[],sampleToChunk:[],presentationTimestamps:null,presentationTimestampIndexMap:null};e.sampleTable=r,p(this.moovSlice);let i=this.moovSlice.slice(e.sampleTableByteOffset);if(this.currentTrack=e,this.traverseBox(i),this.currentTrack=null,e.info?.type==="audio"&&e.info.codec&&j.includes(e.info.codec)&&r.sampleCompositionTimeOffsets.length===0){p(e.info?.type==="audio");let o=se(e.info.codec),s=[],c=[];for(let u=0;u<r.sampleToChunk.length;u++){let d=r.sampleToChunk[u],l=r.sampleToChunk[u+1],m=(l?l.startChunkIndex:r.chunkOffsets.length)-d.startChunkIndex;for(let f=0;f<m;f++){let h=d.startSampleIndex+f*d.samplesPerChunk,b=h+d.samplesPerChunk,g=U(r.sampleTimingEntries,h,P=>P.startIndex),w=r.sampleTimingEntries[g],k=U(r.sampleTimingEntries,b,P=>P.startIndex),T=r.sampleTimingEntries[k],S=w.startDecodeTimestamp+(h-w.startIndex)*w.delta,x=T.startDecodeTimestamp+(b-T.startIndex)*T.delta-S,F=H(s);F&&F.delta===x?F.count++:s.push({startIndex:d.startChunkIndex+f,startDecodeTimestamp:S,count:1,delta:x});let _=d.samplesPerChunk*o.sampleSize*e.info.numberOfChannels;c.push(_)}d.startSampleIndex=d.startChunkIndex,d.samplesPerChunk=1}r.sampleTimingEntries=s,r.sampleSizes=c}if(r.sampleCompositionTimeOffsets.length>0){r.presentationTimestamps=[];for(let o of r.sampleTimingEntries)for(let s=0;s<o.count;s++)r.presentationTimestamps.push({presentationTimestamp:o.startDecodeTimestamp+s*o.delta,sampleIndex:o.startIndex+s});for(let o of r.sampleCompositionTimeOffsets)for(let s=0;s<o.count;s++){let c=o.startIndex+s,u=r.presentationTimestamps[c];u&&(u.presentationTimestamp+=o.offset)}r.presentationTimestamps.sort((o,s)=>o.presentationTimestamp-s.presentationTimestamp),r.presentationTimestampIndexMap=Array(r.presentationTimestamps.length).fill(-1);for(let o=0;o<r.presentationTimestamps.length;o++)r.presentationTimestampIndexMap[r.presentationTimestamps[o].sampleIndex]=o}return r}async readFragment(e){let r=this.reader.requestSliceRange(e,xe,qe);r instanceof Promise&&(r=await r),p(r);let i=Ke(r);p(i?.name==="moof");let a=this.reader.requestSlice(e,i.totalSize);a instanceof Promise&&(a=await a),p(a),this.traverseBox(a);let o=X(this.fragments,e,c=>c.moofOffset);p(o!==-1);let s=this.fragments[o];p(s.moofOffset===e);for(let[c,u]of s.trackData){if(u.startTimestampIsFinal)continue;let d=this.tracks.find(g=>g.id===c),l=0,m=null,f=null,h=U(d.fragments,e-1,g=>g.moofOffset);h!==-1&&(m=d.fragments[h],f=m,l=m.moofOffset+m.moofSize);let b=l===0;for(;l<=e-xe;){if(m?.nextFragment)m=m.nextFragment,l=m.moofOffset+m.moofSize;else{let g=this.reader.requestSliceRange(l,xe,qe);if(g instanceof Promise&&(g=await g),!g)break;let w=l,k=Ke(g);if(!k)break;if(k.name==="moof"){let T=X(this.fragments,w,y=>y.moofOffset),S;T===-1?S=await this.readFragment(w):S=this.fragments[T],m&&(m.nextFragment=S),m=S,b&&(S.isKnownToBeFirstFragment=!0,b=!1)}l=w+k.totalSize}m&&m.trackData.has(c)&&(f=m)}if(f){let g=f.trackData.get(c);p(g.startTimestampIsFinal),uo(u,g.endTimestamp)}u.startTimestampIsFinal=!0}return s}readContiguousBoxes(e){let r=e.filePos;for(;e.filePos-r<=e.length-xe&&this.traverseBox(e););}*iterateContiguousBoxes(e){let r=e.filePos;for(;e.filePos-r<=e.length-xe;){let i=e.filePos,a=Ke(e);if(!a)break;yield{boxInfo:a,slice:e},e.filePos=i+a.totalSize}}traverseBox(e){let r=e.filePos,i=Ke(e);if(!i)return!1;let a=e.filePos,o=r+i.totalSize;switch(i.name){case"mdia":case"minf":case"dinf":case"mfra":case"edts":this.readContiguousBoxes(e.slice(a,i.contentSize));break;case"mvhd":{let s=M(e);e.skip(3),s===1?(e.skip(16),this.movieTimescale=v(e),this.movieDurationInTimescale=Se(e)):(e.skip(8),this.movieTimescale=v(e),this.movieDurationInTimescale=v(e))}break;case"trak":{let s={id:-1,demuxer:this,inputTrack:null,info:null,timescale:-1,durationInMovieTimescale:-1,durationInMediaTimescale:-1,rotation:0,internalCodecId:null,name:null,languageCode:te,sampleTableByteOffset:-1,sampleTable:null,fragmentLookupTable:null,currentFragmentState:null,fragments:[],fragmentsWithKeyFrame:[],editListPreviousSegmentDurations:0,editListOffset:0};if(this.currentTrack=s,this.readContiguousBoxes(e.slice(a,i.contentSize)),s.id!==-1&&s.timescale!==-1&&s.info!==null){if(s.info.type==="video"&&s.info.width!==-1){let c=s;s.inputTrack=new Re(new Pa(c)),this.tracks.push(s)}else if(s.info.type==="audio"&&s.info.numberOfChannels!==-1){let c=s;s.inputTrack=new ie(new va(c)),this.tracks.push(s)}}this.currentTrack=null}break;case"tkhd":{let s=this.currentTrack;if(!s)break;let c=M(e);if(!((Vt(e)&1)!==0))break;if(c===0)e.skip(8),s.id=v(e),e.skip(4),s.durationInMovieTimescale=v(e);else if(c===1)e.skip(16),s.id=v(e),e.skip(4),s.durationInMovieTimescale=Se(e);else throw new Error(`Incorrect track header version ${c}.`);e.skip(2*4+2+2+2+2);let l=[ht(e),ht(e),vn(e),ht(e),ht(e),vn(e),ht(e),ht(e),vn(e)],m=ut(dr(Tu(l),90));p(m===0||m===90||m===180||m===270),s.rotation=m}break;case"elst":{let s=this.currentTrack;if(!s)break;let c=M(e);e.skip(3);let u=!1,d=0,l=v(e);for(let m=0;m<l;m++){let f=c===1?Se(e):v(e),h=c===1?Rs(e):rt(e),b=ht(e);if(f!==0){if(u){console.warn("Unsupported edit list: multiple edits are not currently supported. Only using first edit.");break}if(h===-1){d+=f;continue}if(b!==1){console.warn("Unsupported edit list entry: media rate must be 1.");break}s.editListPreviousSegmentDurations=d,s.editListOffset=h,u=!0}}}break;case"mdhd":{let s=this.currentTrack;if(!s)break;let c=M(e);e.skip(3),c===0?(e.skip(8),s.timescale=v(e),s.durationInMediaTimescale=v(e)):c===1&&(e.skip(16),s.timescale=v(e),s.durationInMediaTimescale=Se(e));let u=de(e);if(u>0){s.languageCode="";for(let d=0;d<3;d++)s.languageCode=String.fromCharCode(96+(u&31))+s.languageCode,u>>=5;Xe(s.languageCode)||(s.languageCode=te)}}break;case"hdlr":{let s=this.currentTrack;if(!s)break;e.skip(8);let c=J(e,4);c==="vide"?s.info={type:"video",width:-1,height:-1,codec:null,codecDescription:null,colorSpace:null,avcCodecInfo:null,hevcCodecInfo:null,vp9CodecInfo:null,av1CodecInfo:null}:c==="soun"&&(s.info={type:"audio",numberOfChannels:-1,sampleRate:-1,codec:null,codecDescription:null,aacCodecInfo:null})}break;case"stbl":{let s=this.currentTrack;if(!s)break;s.sampleTableByteOffset=r,this.readContiguousBoxes(e.slice(a,i.contentSize))}break;case"stsd":{let s=this.currentTrack;if(!s||s.info===null||s.sampleTable)break;let c=M(e);e.skip(3);let u=v(e);for(let d=0;d<u;d++){let l=e.filePos,m=Ke(e);if(!m)break;s.internalCodecId=m.name;let f=m.name.toLowerCase();if(s.info.type==="video")f==="avc1"?s.info.codec="avc":f==="hvc1"||f==="hev1"?s.info.codec="hevc":f==="vp08"?s.info.codec="vp8":f==="vp09"?s.info.codec="vp9":f==="av01"?s.info.codec="av1":console.warn(`Unsupported video codec (sample entry type '${m.name}').`),e.skip(6*1+2+2+2+3*4),s.info.width=de(e),s.info.height=de(e),e.skip(50),this.readContiguousBoxes(e.slice(e.filePos,l+m.totalSize-e.filePos));else{f==="mp4a"||(f==="opus"?s.info.codec="opus":f==="flac"?s.info.codec="flac":f==="twos"||f==="sowt"||f==="raw "||f==="in24"||f==="in32"||f==="fl32"||f==="fl64"||f==="lpcm"||f==="ipcm"||f==="fpcm"||(f==="ulaw"?s.info.codec="ulaw":f==="alaw"?s.info.codec="alaw":console.warn(`Unsupported audio codec (sample entry type '${m.name}').`))),e.skip(6*1+2);let h=de(e);e.skip(3*2);let b=de(e),g=de(e);e.skip(2*2);let w=v(e)/65536;if(c===0&&h>0){if(h===1)e.skip(4),g=8*v(e),e.skip(2*4);else if(h===2){e.skip(4),w=Pn(e),b=v(e),e.skip(4),g=v(e);let k=v(e);if(e.skip(2*4),f==="lpcm"){let T=g+7>>3,S=!!(k&1),y=!!(k&2),x=k&4?-1:0;g>0&&g<=64&&(S?g===32&&(s.info.codec=y?"pcm-f32be":"pcm-f32"):x&1<<T-1?T===1?s.info.codec="pcm-s8":T===2?s.info.codec=y?"pcm-s16be":"pcm-s16":T===3?s.info.codec=y?"pcm-s24be":"pcm-s24":T===4&&(s.info.codec=y?"pcm-s32be":"pcm-s32"):T===1&&(s.info.codec="pcm-u8")),s.info.codec===null&&console.warn("Unsupported PCM format.")}}}s.info.codec==="opus"&&(w=Ae),s.info.numberOfChannels=b,s.info.sampleRate=w,f==="twos"?g===8?s.info.codec="pcm-s8":g===16?s.info.codec="pcm-s16be":(console.warn(`Unsupported sample size ${g} for codec 'twos'.`),s.info.codec=null):f==="sowt"?g===8?s.info.codec="pcm-s8":g===16?s.info.codec="pcm-s16":(console.warn(`Unsupported sample size ${g} for codec 'sowt'.`),s.info.codec=null):f==="raw "?s.info.codec="pcm-u8":f==="in24"?s.info.codec="pcm-s24be":f==="in32"?s.info.codec="pcm-s32be":f==="fl32"?s.info.codec="pcm-f32be":f==="fl64"?s.info.codec="pcm-f64be":f==="ipcm"?s.info.codec="pcm-s16be":f==="fpcm"&&(s.info.codec="pcm-f32be"),this.readContiguousBoxes(e.slice(e.filePos,l+m.totalSize-e.filePos))}}}break;case"avcC":{let s=this.currentTrack;if(!s)break;p(s.info),s.info.codecDescription=D(e,i.contentSize)}break;case"hvcC":{let s=this.currentTrack;if(!s)break;p(s.info),s.info.codecDescription=D(e,i.contentSize)}break;case"vpcC":{let s=this.currentTrack;if(!s)break;p(s.info?.type==="video"),e.skip(4);let c=M(e),u=M(e),d=M(e),l=d>>4,m=d>>1&7,f=d&1,h=M(e),b=M(e),g=M(e);s.info.vp9CodecInfo={profile:c,level:u,bitDepth:l,chromaSubsampling:m,videoFullRangeFlag:f,colourPrimaries:h,transferCharacteristics:b,matrixCoefficients:g}}break;case"av1C":{let s=this.currentTrack;if(!s)break;p(s.info?.type==="video"),e.skip(1);let c=M(e),u=c>>5,d=c&31,l=M(e),m=l>>7,f=l>>6&1,h=l>>5&1,b=l>>4&1,g=l>>3&1,w=l>>2&1,k=l&3,T=u===2&&f?h?12:10:f?10:8;s.info.av1CodecInfo={profile:u,level:d,tier:m,bitDepth:T,monochrome:b,chromaSubsamplingX:g,chromaSubsamplingY:w,chromaSamplePosition:k}}break;case"colr":{let s=this.currentTrack;if(!s||(p(s.info?.type==="video"),J(e,4)!=="nclx"))break;let u=de(e),d=de(e),l=de(e),m=!!(M(e)&128);s.info.colorSpace={primaries:$r[u],transfer:Qr[d],matrix:Gr[l],fullRange:m}}break;case"wave":this.readContiguousBoxes(e.slice(a,i.contentSize));break;case"esds":{let s=this.currentTrack;if(!s)break;p(s.info?.type==="audio"),e.skip(4);let c=M(e);p(c===3),In(e),e.skip(2);let u=M(e),d=(u&128)!==0,l=(u&64)!==0,m=(u&32)!==0;if(d&&e.skip(2),l){let w=M(e);e.skip(w)}m&&e.skip(2);let f=M(e);p(f===4);let h=In(e),b=e.filePos,g=M(e);if(g===64||g===103?(s.info.codec="aac",s.info.aacCodecInfo={isMpeg2:g===103}):g===105||g===107?s.info.codec="mp3":g===221?s.info.codec="vorbis":console.warn(`Unsupported audio codec (objectTypeIndication ${g}) - discarding track.`),e.skip(12),h>e.filePos-b){let w=M(e);p(w===5);let k=In(e);if(s.info.codecDescription=D(e,k),s.info.codec==="aac"){let T=mr(s.info.codecDescription);T.numberOfChannels!==null&&(s.info.numberOfChannels=T.numberOfChannels),T.sampleRate!==null&&(s.info.sampleRate=T.sampleRate)}}}break;case"enda":{let s=this.currentTrack;if(!s)break;p(s.info?.type==="audio"),de(e)&255&&(s.info.codec==="pcm-s16be"?s.info.codec="pcm-s16":s.info.codec==="pcm-s24be"?s.info.codec="pcm-s24":s.info.codec==="pcm-s32be"?s.info.codec="pcm-s32":s.info.codec==="pcm-f32be"?s.info.codec="pcm-f32":s.info.codec==="pcm-f64be"&&(s.info.codec="pcm-f64"))}break;case"pcmC":{let s=this.currentTrack;if(!s)break;p(s.info?.type==="audio"),e.skip(4);let u=!!(M(e)&1),d=M(e);s.info.codec==="pcm-s16be"?u?d===16?s.info.codec="pcm-s16":d===24?s.info.codec="pcm-s24":d===32?s.info.codec="pcm-s32":(console.warn(`Invalid ipcm sample size ${d}.`),s.info.codec=null):d===16?s.info.codec="pcm-s16be":d===24?s.info.codec="pcm-s24be":d===32?s.info.codec="pcm-s32be":(console.warn(`Invalid ipcm sample size ${d}.`),s.info.codec=null):s.info.codec==="pcm-f32be"&&(u?d===32?s.info.codec="pcm-f32":d===64?s.info.codec="pcm-f64":(console.warn(`Invalid fpcm sample size ${d}.`),s.info.codec=null):d===32?s.info.codec="pcm-f32be":d===64?s.info.codec="pcm-f64be":(console.warn(`Invalid fpcm sample size ${d}.`),s.info.codec=null));break}case"dOps":{let s=this.currentTrack;if(!s)break;p(s.info?.type==="audio"),e.skip(1);let c=M(e),u=de(e),d=v(e),l=wr(e),m=M(e),f;m!==0?f=D(e,2+c):f=new Uint8Array(0);let h=new Uint8Array(19+f.byteLength),b=new DataView(h.buffer);b.setUint32(0,1332770163,!1),b.setUint32(4,1214603620,!1),b.setUint8(8,1),b.setUint8(9,c),b.setUint16(10,u,!0),b.setUint32(12,d,!0),b.setInt16(16,l,!0),b.setUint8(18,m),h.set(f,19),s.info.codecDescription=h,s.info.numberOfChannels=c}break;case"dfLa":{let s=this.currentTrack;if(!s)break;p(s.info?.type==="audio"),e.skip(4);let c=127,u=128,d=e.filePos;for(;e.filePos<o;){let b=M(e),g=Vt(e);if((b&c)===0){e.skip(10);let k=v(e),T=k>>>12,S=(k>>9&7)+1;s.info.sampleRate=T,s.info.numberOfChannels=S,e.skip(20)}else e.skip(g);if(b&u)break}let l=e.filePos;e.filePos=d;let m=D(e,l-d),f=new Uint8Array(4+m.byteLength);new DataView(f.buffer).setUint32(0,1716281667,!1),f.set(m,4),s.info.codecDescription=f}break;case"stts":{let s=this.currentTrack;if(!s||!s.sampleTable)break;e.skip(4);let c=v(e),u=0,d=0;for(let l=0;l<c;l++){let m=v(e),f=v(e);s.sampleTable.sampleTimingEntries.push({startIndex:u,startDecodeTimestamp:d,count:m,delta:f}),u+=m,d+=m*f}}break;case"ctts":{let s=this.currentTrack;if(!s||!s.sampleTable)break;e.skip(4);let c=v(e),u=0;for(let d=0;d<c;d++){let l=v(e),m=rt(e);s.sampleTable.sampleCompositionTimeOffsets.push({startIndex:u,count:l,offset:m}),u+=l}}break;case"stsz":{let s=this.currentTrack;if(!s||!s.sampleTable)break;e.skip(4);let c=v(e),u=v(e);if(c===0)for(let d=0;d<u;d++){let l=v(e);s.sampleTable.sampleSizes.push(l)}else s.sampleTable.sampleSizes.push(c)}break;case"stz2":{let s=this.currentTrack;if(!s||!s.sampleTable)break;e.skip(4),e.skip(3);let c=M(e),u=v(e),d=D(e,Math.ceil(u*c/8)),l=new $(d);for(let m=0;m<u;m++){let f=l.readBits(c);s.sampleTable.sampleSizes.push(f)}}break;case"stss":{let s=this.currentTrack;if(!s||!s.sampleTable)break;e.skip(4),s.sampleTable.keySampleIndices=[];let c=v(e);for(let u=0;u<c;u++){let d=v(e)-1;s.sampleTable.keySampleIndices.push(d)}s.sampleTable.keySampleIndices[0]!==0&&s.sampleTable.keySampleIndices.unshift(0)}break;case"stsc":{let s=this.currentTrack;if(!s||!s.sampleTable)break;e.skip(4);let c=v(e);for(let d=0;d<c;d++){let l=v(e)-1,m=v(e),f=v(e);s.sampleTable.sampleToChunk.push({startSampleIndex:-1,startChunkIndex:l,samplesPerChunk:m,sampleDescriptionIndex:f})}let u=0;for(let d=0;d<s.sampleTable.sampleToChunk.length;d++)if(s.sampleTable.sampleToChunk[d].startSampleIndex=u,d<s.sampleTable.sampleToChunk.length-1){let m=s.sampleTable.sampleToChunk[d+1].startChunkIndex-s.sampleTable.sampleToChunk[d].startChunkIndex;u+=m*s.sampleTable.sampleToChunk[d].samplesPerChunk}}break;case"stco":{let s=this.currentTrack;if(!s||!s.sampleTable)break;e.skip(4);let c=v(e);for(let u=0;u<c;u++){let d=v(e);s.sampleTable.chunkOffsets.push(d)}}break;case"co64":{let s=this.currentTrack;if(!s||!s.sampleTable)break;e.skip(4);let c=v(e);for(let u=0;u<c;u++){let d=Se(e);s.sampleTable.chunkOffsets.push(d)}}break;case"mvex":this.isFragmented=!0,this.readContiguousBoxes(e.slice(a,i.contentSize));break;case"mehd":{let s=M(e);e.skip(3);let c=s===1?Se(e):v(e);this.movieDurationInTimescale=c}break;case"trex":{e.skip(4);let s=v(e),c=v(e),u=v(e),d=v(e),l=v(e);this.fragmentTrackDefaults.push({trackId:s,defaultSampleDescriptionIndex:c,defaultSampleDuration:u,defaultSampleSize:d,defaultSampleFlags:l})}break;case"tfra":{let s=M(e);e.skip(3);let c=v(e),u=this.tracks.find(T=>T.id===c);if(!u)break;u.fragmentLookupTable=[];let d=v(e),l=(d&48)>>4,m=(d&12)>>2,f=d&3,h=[M,de,Vt,v],b=h[l],g=h[m],w=h[f],k=v(e);for(let T=0;T<k;T++){let S=s===1?Se(e):v(e),y=s===1?Se(e):v(e);b(e),g(e),w(e),u.fragmentLookupTable.push({timestamp:S,moofOffset:y})}}break;case"moof":{this.currentFragment={moofOffset:r,moofSize:i.totalSize,implicitBaseDataOffset:r,trackData:new Map,dataStart:1/0,dataEnd:0,nextFragment:null,isKnownToBeFirstFragment:!1},this.readContiguousBoxes(e.slice(a,i.contentSize)),Ee(this.fragments,this.currentFragment,s=>s.moofOffset);for(let[,s]of this.currentFragment.trackData){let c=s.samples[0],u=H(s.samples);this.currentFragment.dataStart=Math.min(this.currentFragment.dataStart,c.byteOffset),this.currentFragment.dataEnd=Math.max(this.currentFragment.dataEnd,u.byteOffset+u.byteSize)}this.currentFragment=null}break;case"traf":if(p(this.currentFragment),this.readContiguousBoxes(e.slice(a,i.contentSize)),this.currentTrack){let s=this.currentFragment.trackData.get(this.currentTrack.id);if(s){Ee(this.currentTrack.fragments,this.currentFragment,d=>d.moofOffset),s.firstKeyFrameTimestamp!==null&&Ee(this.currentTrack.fragmentsWithKeyFrame,this.currentFragment,d=>d.moofOffset);let{currentFragmentState:u}=this.currentTrack;p(u),u.startTimestamp!==null&&(uo(s,u.startTimestamp),s.startTimestampIsFinal=!0)}this.currentTrack.currentFragmentState=null,this.currentTrack=null}break;case"tfhd":{p(this.currentFragment),e.skip(1);let s=Vt(e),c=!!(s&1),u=!!(s&2),d=!!(s&8),l=!!(s&16),m=!!(s&32),f=!!(s&65536),h=!!(s&131072),b=v(e),g=this.tracks.find(k=>k.id===b);if(!g)break;let w=this.fragmentTrackDefaults.find(k=>k.trackId===b);this.currentTrack=g,g.currentFragmentState={baseDataOffset:this.currentFragment.implicitBaseDataOffset,sampleDescriptionIndex:w?.defaultSampleDescriptionIndex??null,defaultSampleDuration:w?.defaultSampleDuration??null,defaultSampleSize:w?.defaultSampleSize??null,defaultSampleFlags:w?.defaultSampleFlags??null,startTimestamp:null},c?g.currentFragmentState.baseDataOffset=Se(e):h&&(g.currentFragmentState.baseDataOffset=this.currentFragment.moofOffset),u&&(g.currentFragmentState.sampleDescriptionIndex=v(e)),d&&(g.currentFragmentState.defaultSampleDuration=v(e)),l&&(g.currentFragmentState.defaultSampleSize=v(e)),m&&(g.currentFragmentState.defaultSampleFlags=v(e)),f&&(g.currentFragmentState.defaultSampleDuration=0)}break;case"tfdt":{let s=this.currentTrack;if(!s)break;p(s.currentFragmentState);let c=M(e);e.skip(3);let u=c===0?v(e):Se(e);s.currentFragmentState.startTimestamp=u}break;case"trun":{let s=this.currentTrack;if(!s)break;if(p(this.currentFragment),p(s.currentFragmentState),this.currentFragment.trackData.has(s.id)){console.warn("Can't have two trun boxes for the same track in one fragment. Ignoring...");break}let c=M(e),u=Vt(e),d=!!(u&1),l=!!(u&4),m=!!(u&256),f=!!(u&512),h=!!(u&1024),b=!!(u&2048),g=v(e),w=s.currentFragmentState.baseDataOffset;d&&(w+=rt(e));let k=null;l&&(k=v(e));let T=w;if(g===0){this.currentFragment.implicitBaseDataOffset=T;break}let S=0,y={startTimestamp:0,endTimestamp:0,firstKeyFrameTimestamp:null,samples:[],presentationTimestamps:[],startTimestampIsFinal:!1};this.currentFragment.trackData.set(s.id,y);for(let _=0;_<g;_++){let P;m?P=v(e):(p(s.currentFragmentState.defaultSampleDuration!==null),P=s.currentFragmentState.defaultSampleDuration);let E;f?E=v(e):(p(s.currentFragmentState.defaultSampleSize!==null),E=s.currentFragmentState.defaultSampleSize);let I;h?I=v(e):(p(s.currentFragmentState.defaultSampleFlags!==null),I=s.currentFragmentState.defaultSampleFlags),_===0&&k!==null&&(I=k);let B=0;b&&(c===0?B=v(e):B=rt(e));let G=!(I&65536);y.samples.push({presentationTimestamp:S+B,duration:P,byteOffset:T,byteSize:E,isKeyFrame:G}),T+=E,S+=P}y.presentationTimestamps=y.samples.map((_,P)=>({presentationTimestamp:_.presentationTimestamp,sampleIndex:P})).sort((_,P)=>_.presentationTimestamp-P.presentationTimestamp);for(let _=0;_<y.presentationTimestamps.length;_++){let P=y.presentationTimestamps[_],E=y.samples[P.sampleIndex];if(y.firstKeyFrameTimestamp===null&&E.isKeyFrame&&(y.firstKeyFrameTimestamp=E.presentationTimestamp),_<y.presentationTimestamps.length-1){let I=y.presentationTimestamps[_+1];E.duration=I.presentationTimestamp-P.presentationTimestamp}}let x=y.samples[y.presentationTimestamps[0].sampleIndex],F=y.samples[H(y.presentationTimestamps).sampleIndex];y.startTimestamp=x.presentationTimestamp,y.endTimestamp=F.presentationTimestamp+F.duration,this.currentFragment.implicitBaseDataOffset=T}break;case"udta":{let s=this.iterateContiguousBoxes(e.slice(a,i.contentSize));for(let{boxInfo:c,slice:u}of s){if(c.name!=="meta"&&!this.currentTrack){let d=u.filePos;this.metadataTags.raw??={},hu.has(c.name)?this.metadataTags.raw[c.name]??=Fe(u):this.metadataTags.raw[c.name]??=D(u,c.contentSize),u.filePos=d}switch(c.name){case"meta":u.skip(-c.headerSize),this.traverseBox(u);break;case"\xA9nam":case"name":this.currentTrack?this.currentTrack.name=fe.decode(D(u,c.contentSize)):this.metadataTags.title??=Fe(u);break;case"\xA9des":this.currentTrack||(this.metadataTags.description??=Fe(u));break;case"\xA9ART":this.currentTrack||(this.metadataTags.artist??=Fe(u));break;case"\xA9alb":this.currentTrack||(this.metadataTags.album??=Fe(u));break;case"albr":this.currentTrack||(this.metadataTags.albumArtist??=Fe(u));break;case"\xA9gen":this.currentTrack||(this.metadataTags.genre??=Fe(u));break;case"\xA9day":if(!this.currentTrack){let d=new Date(Fe(u));Number.isNaN(d.getTime())||(this.metadataTags.date??=d)}break;case"\xA9cmt":this.currentTrack||(this.metadataTags.comment??=Fe(u));break;case"\xA9lyr":this.currentTrack||(this.metadataTags.lyrics??=Fe(u));break}}}break;case"meta":{if(this.currentTrack)break;let c=v(e)!==0;this.currentMetadataKeys=new Map,c?this.readContiguousBoxes(e.slice(a,i.contentSize)):this.readContiguousBoxes(e.slice(a+4,i.contentSize-4)),this.currentMetadataKeys=null}break;case"keys":{if(!this.currentMetadataKeys)break;e.skip(4);let s=v(e);for(let c=0;c<s;c++){let u=v(e);e.skip(4);let d=fe.decode(D(e,u-8));this.currentMetadataKeys.set(c+1,d)}}break;case"ilst":{if(!this.currentMetadataKeys)break;let s=this.iterateContiguousBoxes(e.slice(a,i.contentSize));for(let{boxInfo:c,slice:u}of s){let d=c.name,l=(d.charCodeAt(0)<<24)+(d.charCodeAt(1)<<16)+(d.charCodeAt(2)<<8)+d.charCodeAt(3);this.currentMetadataKeys.has(l)&&(d=this.currentMetadataKeys.get(l));let m=Vs(u);switch(this.metadataTags.raw??={},this.metadataTags.raw[d]??=m,d){case"\xA9nam":case"titl":case"com.apple.quicktime.title":case"title":typeof m=="string"&&(this.metadataTags.title??=m);break;case"\xA9des":case"desc":case"dscp":case"com.apple.quicktime.description":case"description":typeof m=="string"&&(this.metadataTags.description??=m);break;case"\xA9ART":case"com.apple.quicktime.artist":case"artist":typeof m=="string"&&(this.metadataTags.artist??=m);break;case"\xA9alb":case"albm":case"com.apple.quicktime.album":case"album":typeof m=="string"&&(this.metadataTags.album??=m);break;case"aART":case"album_artist":typeof m=="string"&&(this.metadataTags.albumArtist??=m);break;case"\xA9cmt":case"com.apple.quicktime.comment":case"comment":typeof m=="string"&&(this.metadataTags.comment??=m);break;case"\xA9gen":case"gnre":case"com.apple.quicktime.genre":case"genre":typeof m=="string"&&(this.metadataTags.genre??=m);break;case"\xA9lyr":case"lyrics":typeof m=="string"&&(this.metadataTags.lyrics??=m);break;case"\xA9day":case"rldt":case"com.apple.quicktime.creationdate":case"date":if(typeof m=="string"){let f=new Date(m);Number.isNaN(f.getTime())||(this.metadataTags.date??=f)}break;case"covr":case"com.apple.quicktime.artwork":m instanceof Pe?(this.metadataTags.images??=[],this.metadataTags.images.push({data:m.data,kind:"coverFront",mimeType:m.mimeType})):m instanceof Uint8Array&&(this.metadataTags.images??=[],this.metadataTags.images.push({data:m,kind:"coverFront",mimeType:"image/*"}));break;case"trkn":if(m instanceof Uint8Array){let f=V(m),h=f.getUint16(2,!1),b=f.getUint16(4,!1);h>0&&(this.metadataTags.trackNumber??=h),b>0&&(this.metadataTags.tracksTotal??=b)}break;case"disc":case"disk":if(m instanceof Uint8Array){let f=V(m),h=f.getUint16(2,!1),b=f.getUint16(4,!1);h>0&&(this.metadataTags.discNumber??=h),b>0&&(this.metadataTags.discsTotal??=b)}break}}}break}return e.filePos=o,!0}},li=class{constructor(t){this.internalTrack=t;this.packetToSampleIndex=new WeakMap;this.packetToFragmentLocation=new WeakMap}getId(){return this.internalTrack.id}getCodec(){throw new Error("Not implemented on base class.")}getInternalCodecId(){return this.internalTrack.internalCodecId}getName(){return this.internalTrack.name}getLanguageCode(){return this.internalTrack.languageCode}getTimeResolution(){return this.internalTrack.timescale}async computeDuration(){let t=await this.getPacket(1/0,{metadataOnly:!0});return(t?.timestamp??0)+(t?.duration??0)}async getFirstTimestamp(){return(await this.getFirstPacket({metadataOnly:!0}))?.timestamp??0}async getFirstPacket(t){let e=await this.fetchPacketForSampleIndex(0,t);return e||!this.internalTrack.demuxer.isFragmented?e:this.performFragmentedLookup(()=>{let r=this.internalTrack.demuxer.fragments[0]??null;if(r?.isKnownToBeFirstFragment){let i=r;for(;i;){if(i.trackData.get(this.internalTrack.id))return{fragmentIndex:X(this.internalTrack.fragments,i.moofOffset,o=>o.moofOffset),sampleIndex:0,correctSampleFound:!0};i=i.nextFragment}}return{fragmentIndex:-1,sampleIndex:-1,correctSampleFound:!1}},-1/0,1/0,t)}mapTimestampIntoTimescale(t){return wt(t*this.internalTrack.timescale,14)+this.internalTrack.editListOffset}async getPacket(t,e){let r=this.mapTimestampIntoTimescale(t),i=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),a=co(i,r),o=await this.fetchPacketForSampleIndex(a,e);return!lo(i)||!this.internalTrack.demuxer.isFragmented?o:this.performFragmentedLookup(()=>this.findSampleInFragmentsForTimestamp(r),r,r,e)}async getNextPacket(t,e){let r=this.packetToSampleIndex.get(t);if(r!==void 0)return this.fetchPacketForSampleIndex(r+1,e);let i=this.packetToFragmentLocation.get(t);if(i===void 0)throw new Error("Packet was not created from this track.");let a=i.fragment.trackData.get(this.internalTrack.id),o=X(this.internalTrack.fragments,i.fragment.moofOffset,s=>s.moofOffset);return p(o!==-1),this.performFragmentedLookup(()=>{if(i.sampleIndex+1<a.samples.length)return{fragmentIndex:o,sampleIndex:i.sampleIndex+1,correctSampleFound:!0};{let s=i.fragment;for(;s.nextFragment;)if(s=s.nextFragment,s.trackData.get(this.internalTrack.id)){let u=X(this.internalTrack.fragments,s.moofOffset,d=>d.moofOffset);return p(u!==-1),{fragmentIndex:u,sampleIndex:0,correctSampleFound:!0}}return{fragmentIndex:o,sampleIndex:-1,correctSampleFound:!1}}},-1/0,1/0,e)}async getKeyPacket(t,e){let r=this.mapTimestampIntoTimescale(t),i=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),a=co(i,r),o=a===-1?-1:bu(i,a),s=await this.fetchPacketForSampleIndex(o,e);return!lo(i)||!this.internalTrack.demuxer.isFragmented?s:this.performFragmentedLookup(()=>this.findKeySampleInFragmentsForTimestamp(r),r,r,e)}async getNextKeyPacket(t,e){let r=this.packetToSampleIndex.get(t);if(r!==void 0){let s=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),c=ku(s,r);return this.fetchPacketForSampleIndex(c,e)}let i=this.packetToFragmentLocation.get(t);if(i===void 0)throw new Error("Packet was not created from this track.");let a=i.fragment.trackData.get(this.internalTrack.id),o=X(this.internalTrack.fragments,i.fragment.moofOffset,s=>s.moofOffset);return p(o!==-1),this.performFragmentedLookup(()=>{let s=a.samples.findIndex((c,u)=>c.isKeyFrame&&u>i.sampleIndex);if(s!==-1)return{fragmentIndex:o,sampleIndex:s,correctSampleFound:!0};{let c=i.fragment;for(;c.nextFragment;){c=c.nextFragment;let u=c.trackData.get(this.internalTrack.id);if(u&&u.firstKeyFrameTimestamp!==null){let d=X(this.internalTrack.fragments,c.moofOffset,m=>m.moofOffset);p(d!==-1);let l=u.samples.findIndex(m=>m.isKeyFrame);return p(l!==-1),{fragmentIndex:d,sampleIndex:l,correctSampleFound:!0}}}return{fragmentIndex:o,sampleIndex:-1,correctSampleFound:!1}}},-1/0,1/0,e)}async fetchPacketForSampleIndex(t,e){if(t===-1)return null;let r=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),i=gu(r,t);if(!i)return null;let a;if(e.metadataOnly)a=le;else{let u=this.internalTrack.demuxer.reader.requestSlice(i.sampleOffset,i.sampleSize);u instanceof Promise&&(u=await u),p(u),a=D(u,i.sampleSize)}let o=(i.presentationTimestamp-this.internalTrack.editListOffset)/this.internalTrack.timescale,s=i.duration/this.internalTrack.timescale,c=new N(a,i.isKeyFrame?"key":"delta",o,s,t,i.sampleSize);return this.packetToSampleIndex.set(c,t),c}async fetchPacketInFragment(t,e,r){if(e===-1)return null;let a=t.trackData.get(this.internalTrack.id).samples[e];p(a);let o;if(r.metadataOnly)o=le;else{let d=this.internalTrack.demuxer.reader.requestSlice(a.byteOffset,a.byteSize);d instanceof Promise&&(d=await d),p(d),o=D(d,a.byteSize)}let s=(a.presentationTimestamp-this.internalTrack.editListOffset)/this.internalTrack.timescale,c=a.duration/this.internalTrack.timescale,u=new N(o,a.isKeyFrame?"key":"delta",s,c,t.moofOffset+e,a.byteSize);return this.packetToFragmentLocation.set(u,{fragment:t,sampleIndex:e}),u}findSampleInFragmentsForTimestamp(t){let e=U(this.internalTrack.fragments,t,a=>a.trackData.get(this.internalTrack.id).startTimestamp),r=-1,i=!1;if(e!==-1){let o=this.internalTrack.fragments[e].trackData.get(this.internalTrack.id),s=U(o.presentationTimestamps,t,c=>c.presentationTimestamp);p(s!==-1),r=o.presentationTimestamps[s].sampleIndex,i=t<o.endTimestamp}return{fragmentIndex:e,sampleIndex:r,correctSampleFound:i}}findKeySampleInFragmentsForTimestamp(t){let e=U(this.internalTrack.fragmentsWithKeyFrame,t,o=>o.trackData.get(this.internalTrack.id).startTimestamp),r=-1,i=-1,a=!1;if(e!==-1){let o=this.internalTrack.fragmentsWithKeyFrame[e];r=X(this.internalTrack.fragments,o.moofOffset,d=>d.moofOffset),p(r!==-1);let s=o.trackData.get(this.internalTrack.id),c=Yr(s.presentationTimestamps,d=>s.samples[d.sampleIndex].isKeyFrame&&d.presentationTimestamp<=t);p(c!==-1),i=s.presentationTimestamps[c].sampleIndex,a=t<s.endTimestamp}return{fragmentIndex:r,sampleIndex:i,correctSampleFound:a}}async performFragmentedLookup(t,e,r,i){let a=this.internalTrack.demuxer,o=await a.fragmentLookupMutex.acquire();try{let{fragmentIndex:s,sampleIndex:c,correctSampleFound:u}=t();if(u){let k=this.internalTrack.fragments[s];return this.fetchPacketInFragment(k,c,i)}let d=null,l=s,m=c,f=this.internalTrack.fragmentLookupTable?U(this.internalTrack.fragmentLookupTable,e,k=>k.timestamp):-1,h=f!==-1?this.internalTrack.fragmentLookupTable[f]:null,b,g=!1;if(s===-1)b=h?.moofOffset??0,g=b===0;else{let k=this.internalTrack.fragments[s];!h||k.moofOffset>=h.moofOffset?(b=k.moofOffset+k.moofSize,d=k):b=h.moofOffset}for(;;){if(d){let y=d.trackData.get(this.internalTrack.id);if(y&&y.startTimestamp>r)break;if(d.nextFragment){b=d.nextFragment.moofOffset+d.nextFragment.moofSize,d=d.nextFragment;continue}}let k=a.reader.requestSliceRange(b,xe,qe);if(k instanceof Promise&&(k=await k),!k)break;let T=b,S=Ke(k);if(!S)break;if(S.name==="moof"){let y=X(a.fragments,T,E=>E.moofOffset),x;y===-1?x=await a.readFragment(T):x=a.fragments[y],d&&(d.nextFragment=x),d=x,g&&(x.isKnownToBeFirstFragment=!0,g=!1);let{fragmentIndex:F,sampleIndex:_,correctSampleFound:P}=t();if(P){let E=this.internalTrack.fragments[F];return this.fetchPacketInFragment(E,_,i)}F!==-1&&(l=F,m=_)}b=T+S.totalSize}let w=l!==-1?this.internalTrack.fragments[l]:null;if(h&&(!w||w.moofOffset<h.moofOffset)){let T=this.internalTrack.fragmentLookupTable[f-1]?.timestamp??-1/0;return this.performFragmentedLookup(t,T,r,i)}return w?this.fetchPacketInFragment(w,m,i):null}finally{o()}}},Pa=class extends li{constructor(e){super(e);this.decoderConfigPromise=null;this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getCodedWidth(){return this.internalTrack.info.width}getCodedHeight(){return this.internalTrack.info.height}getRotation(){return this.internalTrack.rotation}async getColorSpace(){return{primaries:this.internalTrack.info.colorSpace?.primaries,transfer:this.internalTrack.info.colorSpace?.transfer,matrix:this.internalTrack.info.colorSpace?.matrix,fullRange:this.internalTrack.info.colorSpace?.fullRange}}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfigPromise??=(async()=>{if(this.internalTrack.info.codec==="vp9"&&!this.internalTrack.info.vp9CodecInfo){let e=await this.getFirstPacket({});this.internalTrack.info.vp9CodecInfo=e&&gn(e.data)}else if(this.internalTrack.info.codec==="av1"&&!this.internalTrack.info.av1CodecInfo){let e=await this.getFirstPacket({});this.internalTrack.info.av1CodecInfo=e&&bn(e.data)}return{codec:an(this.internalTrack.info),codedWidth:this.internalTrack.info.width,codedHeight:this.internalTrack.info.height,description:this.internalTrack.info.codecDescription??void 0,colorSpace:this.internalTrack.info.colorSpace??void 0}})():null}},va=class extends li{constructor(e){super(e);this.decoderConfig=null;this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getNumberOfChannels(){return this.internalTrack.info.numberOfChannels}getSampleRate(){return this.internalTrack.info.sampleRate}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfig??={codec:sn(this.internalTrack.info),numberOfChannels:this.internalTrack.info.numberOfChannels,sampleRate:this.internalTrack.info.sampleRate,description:this.internalTrack.info.codecDescription??void 0}:null}},co=(n,t)=>{if(n.presentationTimestamps){let e=U(n.presentationTimestamps,t,r=>r.presentationTimestamp);return e===-1?-1:n.presentationTimestamps[e].sampleIndex}else{let e=U(n.sampleTimingEntries,t,i=>i.startDecodeTimestamp);if(e===-1)return-1;let r=n.sampleTimingEntries[e];return r.startIndex+Math.min(Math.floor((t-r.startDecodeTimestamp)/r.delta),r.count-1)}},gu=(n,t)=>{let e=U(n.sampleTimingEntries,t,w=>w.startIndex),r=n.sampleTimingEntries[e];if(!r||r.startIndex+r.count<=t)return null;let a=r.startDecodeTimestamp+(t-r.startIndex)*r.delta,o=U(n.sampleCompositionTimeOffsets,t,w=>w.startIndex),s=n.sampleCompositionTimeOffsets[o];s&&t-s.startIndex<s.count&&(a+=s.offset);let c=n.sampleSizes[Math.min(t,n.sampleSizes.length-1)],u=U(n.sampleToChunk,t,w=>w.startSampleIndex),d=n.sampleToChunk[u];p(d);let l=d.startChunkIndex+Math.floor((t-d.startSampleIndex)/d.samplesPerChunk),m=n.chunkOffsets[l],f=d.startSampleIndex+(l-d.startChunkIndex)*d.samplesPerChunk,h=0,b=m;if(n.sampleSizes.length===1)b+=c*(t-f),h+=c*d.samplesPerChunk;else for(let w=f;w<f+d.samplesPerChunk;w++){let k=n.sampleSizes[w];w<t&&(b+=k),h+=k}let g=r.delta;if(n.presentationTimestamps){let w=n.presentationTimestampIndexMap[t];p(w!==void 0),w<n.presentationTimestamps.length-1&&(g=n.presentationTimestamps[w+1].presentationTimestamp-a)}return{presentationTimestamp:a,duration:g,sampleOffset:b,sampleSize:c,chunkOffset:m,chunkSize:h,isKeyFrame:n.keySampleIndices?X(n.keySampleIndices,t,w=>w)!==-1:!0}},bu=(n,t)=>{if(!n.keySampleIndices)return t;let e=U(n.keySampleIndices,t,r=>r);return n.keySampleIndices[e]??-1},ku=(n,t)=>{if(!n.keySampleIndices)return t+1;let e=U(n.keySampleIndices,t,r=>r);return n.keySampleIndices[e+1]??-1},uo=(n,t)=>{n.startTimestamp+=t,n.endTimestamp+=t;for(let e of n.samples)e.presentationTimestamp+=t;for(let e of n.presentationTimestamps)e.presentationTimestamp+=t},Tu=n=>{let[t,,,e]=n,r=Math.hypot(t,e),i=t/r,a=e/r,o=-Math.atan2(a,i)*(180/Math.PI);return Number.isFinite(o)?o:0},lo=n=>n.sampleSizes.length===0;var Ia=[{id:290298740,flag:"seekHeadSeen"},{id:357149030,flag:"infoSeen"},{id:374648427,flag:"tracksSeen"},{id:475249515,flag:"cuesSeen"}],mo=10*2**20,mi=class extends be{constructor(e){super(e);this.readMetadataPromise=null;this.segments=[];this.currentSegment=null;this.currentTrack=null;this.currentCluster=null;this.currentBlock=null;this.currentCueTime=null;this.currentTagTargetIsMovie=!0;this.currentSimpleTagName=null;this.currentAttachedFile=null;this.isWebM=!1;this.reader=e._reader}async computeDuration(){let e=await this.getTracks(),r=await Promise.all(e.map(i=>i.computeDuration()));return Math.max(0,...r)}async getTracks(){return await this.readMetadata(),this.segments.flatMap(e=>e.tracks.map(r=>r.inputTrack))}async getMimeType(){await this.readMetadata();let e=await this.getTracks(),r=await Promise.all(e.map(i=>i.getCodecParameterString()));return Rn({isWebM:this.isWebM,hasVideo:this.segments.some(i=>i.tracks.some(a=>a.info?.type==="video")),hasAudio:this.segments.some(i=>i.tracks.some(a=>a.info?.type==="audio")),codecStrings:r.filter(Boolean)})}async getMetadataTags(){await this.readMetadata();for(let r of this.segments)r.metadataTagsCollected||(this.reader.fileSize!==null&&await this.loadSegmentMetadata(r),r.metadataTagsCollected=!0);let e={};for(let r of this.segments)e={...e,...r.metadataTags};return e}readMetadata(){return this.readMetadataPromise??=(async()=>{let e=0;for(;;){let r=this.reader.requestSliceRange(e,ge,Me);if(r instanceof Promise&&(r=await r),!r)break;let i=Oe(r);if(!i)break;let a=i.id,o=i.size,s=r.filePos;if(a===440786851){it(o);let c=this.reader.requestSlice(s,o);if(c instanceof Promise&&(c=await c),!c)break;this.readContiguousElements(c)}else if(a===408125543){if(await this.readSegment(s,o),o===null||this.reader.fileSize===null)break}else if(a===524531317){if(this.reader.fileSize===null)break;o===null&&(o=(await On(this.reader,s,An,this.reader.fileSize)).pos-s);let c=H(this.segments);c&&(c.elementEndPos=s+o)}it(o),e=s+o}})()}async readSegment(e,r){this.currentSegment={seekHeadSeen:!1,infoSeen:!1,tracksSeen:!1,cuesSeen:!1,tagsSeen:!1,attachmentsSeen:!1,timestampScale:-1,timestampFactor:-1,duration:-1,seekEntries:[],tracks:[],cuePoints:[],dataStartPos:e,elementEndPos:r===null?null:e+r,clusterSeekStartPos:e,clusters:[],clusterLookupMutex:new ce,metadataTags:{},metadataTagsCollected:!1},this.segments.push(this.currentSegment);let i=e;for(;this.currentSegment.elementEndPos===null||i<this.currentSegment.elementEndPos;){let u=this.reader.requestSliceRange(i,ge,Me);if(u instanceof Promise&&(u=await u),!u)break;let d=i,l=Oe(u);if(!l||!Wt.includes(l.id)&&l.id!==236){let g=await Qi(this.reader,d,Wt,Math.min(this.currentSegment.elementEndPos??1/0,d+mo));if(g){i=g;continue}else break}let{id:m,size:f}=l,h=u.filePos,b=Ia.findIndex(g=>g.id===m);if(b!==-1){let g=Ia[b].flag;this.currentSegment[g]=!0,it(f);let w=this.reader.requestSlice(h,f);w instanceof Promise&&(w=await w),w&&this.readContiguousElements(w)}else if(m===307544935||m===423732329){m===307544935?this.currentSegment.tagsSeen=!0:this.currentSegment.attachmentsSeen=!0,it(f);let g=this.reader.requestSlice(h,f);g instanceof Promise&&(g=await g),g&&this.readContiguousElements(g)}else if(m===524531317){this.currentSegment.clusterSeekStartPos=d;break}if(f===null)break;i=h+f}if(this.currentSegment.seekEntries.sort((u,d)=>u.segmentPosition-d.segmentPosition),this.reader.fileSize!==null)for(let u of this.currentSegment.seekEntries){let d=Ia.find(g=>g.id===u.id);if(!d||this.currentSegment[d.flag])continue;let l=this.reader.requestSliceRange(e+u.segmentPosition,ge,Me);if(l instanceof Promise&&(l=await l),!l)continue;let m=Oe(l);if(!m)continue;let{id:f,size:h}=m;if(f!==d.id)continue;it(h),this.currentSegment[d.flag]=!0;let b=this.reader.requestSlice(l.filePos,h);b instanceof Promise&&(b=await b),b&&this.readContiguousElements(b)}this.currentSegment.timestampScale===-1&&(this.currentSegment.timestampScale=1e6,this.currentSegment.timestampFactor=1e9/1e6),this.currentSegment.tracks.sort((u,d)=>Number(d.isDefault)-Number(u.isDefault)),this.currentSegment.cuePoints.sort((u,d)=>u.clusterPosition-d.clusterPosition);let a=this.currentSegment.tracks.map(u=>u.id),o=new Set,s=null,c=null;for(let u of this.currentSegment.cuePoints){if(u.clusterPosition!==s){for(let l of o)p(c),this.currentSegment.tracks.find(f=>f.id===l).cuePoints.push(c);for(let l of a)o.add(l)}if(c=u,!o.has(u.trackId))continue;this.currentSegment.tracks.find(l=>l.id===u.trackId).cuePoints.push(u),o.delete(u.trackId),s=u.clusterPosition}for(let u of o)p(c),this.currentSegment.tracks.find(l=>l.id===u).cuePoints.push(c);for(let u of this.currentSegment.tracks)u.cuePoints.sort((d,l)=>d.time-l.time);this.currentSegment=null}async readCluster(e,r){let i=this.reader.requestSliceRange(e,ge,Me);i instanceof Promise&&(i=await i),p(i);let a=e,o=Oe(i);p(o);let s=o.id,c=o.size,u=i.filePos;c===null&&(c=(await On(this.reader,u,An,r.elementEndPos)).pos-u),p(s===524531317);let d=this.reader.requestSlice(u,c);d instanceof Promise&&(d=await d);let l={elementStartPos:a,elementEndPos:u+c,dataStartPos:u,timestamp:-1,trackData:new Map,nextCluster:null,isKnownToBeFirstCluster:!1};this.currentCluster=l,d&&this.readContiguousElements(d);for(let[m,f]of l.trackData){let h=r.tracks.find(T=>T.id===m)??null;p(f.blocks.length>0);let b=!1,g=!1;for(let T=0;T<f.blocks.length;T++){let S=f.blocks[T];S.timestamp+=l.timestamp,b||=S.referencedTimestamps.length>0,g||=S.lacing!==0}b&&(f.blocks=wu(f.blocks)),f.presentationTimestamps=f.blocks.map((T,S)=>({timestamp:T.timestamp,blockIndex:S})).sort((T,S)=>T.timestamp-S.timestamp);for(let T=0;T<f.presentationTimestamps.length;T++){let S=f.presentationTimestamps[T],y=f.blocks[S.blockIndex];if(f.firstKeyFrameTimestamp===null&&y.isKeyFrame&&(f.firstKeyFrameTimestamp=y.timestamp),T<f.presentationTimestamps.length-1){let x=f.presentationTimestamps[T+1];y.duration=x.timestamp-y.timestamp}else y.duration===0&&h?.defaultDuration!=null&&y.lacing===0&&(y.duration=h.defaultDuration)}g&&(this.expandLacedBlocks(f.blocks,h),f.presentationTimestamps=f.blocks.map((T,S)=>({timestamp:T.timestamp,blockIndex:S})).sort((T,S)=>T.timestamp-S.timestamp));let w=f.blocks[f.presentationTimestamps[0].blockIndex],k=f.blocks[H(f.presentationTimestamps).blockIndex];f.startTimestamp=w.timestamp,f.endTimestamp=k.timestamp+k.duration,h&&(Ee(h.clusters,l,S=>S.elementStartPos),f.firstKeyFrameTimestamp!==null&&Ee(h.clustersWithKeyFrame,l,S=>S.elementStartPos))}return Ee(r.clusters,l,m=>m.elementStartPos),this.currentCluster=null,l}getTrackDataInCluster(e,r){let i=e.trackData.get(r);return i||(i={startTimestamp:0,endTimestamp:0,firstKeyFrameTimestamp:null,blocks:[],presentationTimestamps:[]},e.trackData.set(r,i)),i}expandLacedBlocks(e,r){for(let i=0;i<e.length;i++){let a=e[i];if(a.lacing===0)continue;let o=Dt.tempFromBytes(a.data),s=[],c=M(o)+1;switch(a.lacing){case 1:{let u=0;for(let d=0;d<c-1;d++){let l=0;for(;o.bufferPos<o.length;){let m=M(o);if(l+=m,m<255){s.push(l),u+=l;break}}}s.push(o.length-(o.bufferPos+u))}break;case 2:{let u=o.length-1,d=Math.floor(u/c);for(let l=0;l<c;l++)s.push(d)}break;case 3:{let u=Lt(o);p(u!==null);let d=u;s.push(d);let l=d;for(let m=1;m<c-1;m++){let f=o.bufferPos,h=Lt(o);p(h!==null);let b=h,w=(1<<(o.bufferPos-f)*7-1)-1,k=b-w;d+=k,s.push(d),l+=d}s.push(o.length-(o.bufferPos+l))}break;default:p(!1)}p(s.length===c),e.splice(i,1);for(let u=0;u<c;u++){let d=s[u],l=D(o,d),m=a.duration||c*(r?.defaultDuration??0),f=a.timestamp+m*u/c,h=m/c;e.splice(i+u,0,{timestamp:f,duration:h,isKeyFrame:a.isKeyFrame,referencedTimestamps:a.referencedTimestamps,data:l,lacing:0})}i+=c,i--}}async loadSegmentMetadata(e){for(let r of e.seekEntries){if(!(r.id===307544935&&!e.tagsSeen)){if(!(r.id===423732329&&!e.attachmentsSeen))continue}let i=this.reader.requestSliceRange(e.dataStartPos+r.segmentPosition,ge,Me);if(i instanceof Promise&&(i=await i),!i)continue;let a=Oe(i);if(!a||a.id!==r.id)continue;let{size:o}=a;it(o),p(!this.currentSegment),this.currentSegment=e;let s=this.reader.requestSlice(i.filePos,o);s instanceof Promise&&(s=await s),s&&this.readContiguousElements(s),this.currentSegment=null,r.id===307544935?e.tagsSeen=!0:r.id===423732329&&(e.attachmentsSeen=!0)}}readContiguousElements(e){let r=e.filePos;for(;e.filePos-r<=e.length-ge&&this.traverseElement(e););}traverseElement(e){let r=Oe(e);if(!r)return!1;let{id:i,size:a}=r,o=e.filePos;switch(it(a),i){case 17026:this.isWebM=gt(e,a)==="webm";break;case 19899:{if(!this.currentSegment)break;let s={id:-1,segmentPosition:-1};this.currentSegment.seekEntries.push(s),this.readContiguousElements(e.slice(o,a)),(s.id===-1||s.segmentPosition===-1)&&this.currentSegment.seekEntries.pop()}break;case 21419:{let s=this.currentSegment?.seekEntries[this.currentSegment.seekEntries.length-1];if(!s)break;s.id=L(e,a)}break;case 21420:{let s=this.currentSegment?.seekEntries[this.currentSegment.seekEntries.length-1];if(!s)break;s.segmentPosition=L(e,a)}break;case 2807729:{if(!this.currentSegment)break;this.currentSegment.timestampScale=L(e,a),this.currentSegment.timestampFactor=1e9/this.currentSegment.timestampScale}break;case 17545:{if(!this.currentSegment)break;this.currentSegment.duration=Mn(e,a)}break;case 174:{if(!this.currentSegment)break;if(this.currentTrack={id:-1,segment:this.currentSegment,demuxer:this,clusters:[],clustersWithKeyFrame:[],cuePoints:[],isDefault:!1,inputTrack:null,codecId:null,codecPrivate:null,defaultDuration:null,name:null,languageCode:te,info:null},this.readContiguousElements(e.slice(o,a)),this.currentTrack&&this.currentTrack.id!==-1&&this.currentTrack.codecId&&this.currentTrack.info){let s=this.currentTrack.codecId.indexOf("/"),c=s===-1?this.currentTrack.codecId:this.currentTrack.codecId.slice(0,s);if(this.currentTrack.info.type==="video"&&this.currentTrack.info.width!==-1&&this.currentTrack.info.height!==-1){this.currentTrack.codecId===Ce.avc?(this.currentTrack.info.codec="avc",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):this.currentTrack.codecId===Ce.hevc?(this.currentTrack.info.codec="hevc",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):c===Ce.vp8?this.currentTrack.info.codec="vp8":c===Ce.vp9?this.currentTrack.info.codec="vp9":c===Ce.av1&&(this.currentTrack.info.codec="av1");let u=this.currentTrack,d=new Re(new Ea(u));this.currentTrack.inputTrack=d,this.currentSegment.tracks.push(this.currentTrack)}else if(this.currentTrack.info.type==="audio"&&this.currentTrack.info.numberOfChannels!==-1&&this.currentTrack.info.sampleRate!==-1){c===Ce.aac?(this.currentTrack.info.codec="aac",this.currentTrack.info.aacCodecInfo={isMpeg2:this.currentTrack.codecId.includes("MPEG2")},this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):this.currentTrack.codecId===Ce.mp3?this.currentTrack.info.codec="mp3":c===Ce.opus?(this.currentTrack.info.codec="opus",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate,this.currentTrack.info.sampleRate=Ae):c===Ce.vorbis?(this.currentTrack.info.codec="vorbis",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):c===Ce.flac?(this.currentTrack.info.codec="flac",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):this.currentTrack.codecId==="A_PCM/INT/LIT"?this.currentTrack.info.bitDepth===8?this.currentTrack.info.codec="pcm-u8":this.currentTrack.info.bitDepth===16?this.currentTrack.info.codec="pcm-s16":this.currentTrack.info.bitDepth===24?this.currentTrack.info.codec="pcm-s24":this.currentTrack.info.bitDepth===32&&(this.currentTrack.info.codec="pcm-s32"):this.currentTrack.codecId==="A_PCM/INT/BIG"?this.currentTrack.info.bitDepth===8?this.currentTrack.info.codec="pcm-u8":this.currentTrack.info.bitDepth===16?this.currentTrack.info.codec="pcm-s16be":this.currentTrack.info.bitDepth===24?this.currentTrack.info.codec="pcm-s24be":this.currentTrack.info.bitDepth===32&&(this.currentTrack.info.codec="pcm-s32be"):this.currentTrack.codecId==="A_PCM/FLOAT/IEEE"&&(this.currentTrack.info.bitDepth===32?this.currentTrack.info.codec="pcm-f32":this.currentTrack.info.bitDepth===64&&(this.currentTrack.info.codec="pcm-f64"));let u=this.currentTrack,d=new ie(new _a(u));this.currentTrack.inputTrack=d,this.currentSegment.tracks.push(this.currentTrack)}}this.currentTrack=null}break;case 215:{if(!this.currentTrack)break;this.currentTrack.id=L(e,a)}break;case 131:{if(!this.currentTrack)break;let s=L(e,a);s===1?this.currentTrack.info={type:"video",width:-1,height:-1,rotation:0,codec:null,codecDescription:null,colorSpace:null}:s===2&&(this.currentTrack.info={type:"audio",numberOfChannels:-1,sampleRate:-1,bitDepth:-1,codec:null,codecDescription:null,aacCodecInfo:null})}break;case 185:{if(!this.currentTrack)break;L(e,a)||(this.currentSegment.tracks.pop(),this.currentTrack=null)}break;case 136:{if(!this.currentTrack)break;this.currentTrack.isDefault=!!L(e,a)}break;case 134:{if(!this.currentTrack)break;this.currentTrack.codecId=gt(e,a)}break;case 25506:{if(!this.currentTrack)break;this.currentTrack.codecPrivate=D(e,a)}break;case 2352003:{if(!this.currentTrack)break;this.currentTrack.defaultDuration=this.currentTrack.segment.timestampFactor*L(e,a)/1e9}break;case 21358:{if(!this.currentTrack)break;this.currentTrack.name=Ht(e,a)}break;case 2274716:{if(!this.currentTrack||this.currentTrack.languageCode!==te)break;this.currentTrack.languageCode=gt(e,a),Xe(this.currentTrack.languageCode)||(this.currentTrack.languageCode=te)}break;case 2274717:{if(!this.currentTrack)break;let c=gt(e,a).split("-")[0];c?this.currentTrack.languageCode=c:this.currentTrack.languageCode=te}break;case 224:{if(this.currentTrack?.info?.type!=="video")break;this.readContiguousElements(e.slice(o,a))}break;case 176:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.width=L(e,a)}break;case 186:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.height=L(e,a)}break;case 21936:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.colorSpace={},this.readContiguousElements(e.slice(o,a))}break;case 21937:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;let s=L(e,a),c=Gr[s]??null;this.currentTrack.info.colorSpace.matrix=c}break;case 21945:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;this.currentTrack.info.colorSpace.fullRange=L(e,a)===2}break;case 21946:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;let s=L(e,a),c=Qr[s]??null;this.currentTrack.info.colorSpace.transfer=c}break;case 21947:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;let s=L(e,a),c=$r[s]??null;this.currentTrack.info.colorSpace.primaries=c}break;case 30320:{if(this.currentTrack?.info?.type!=="video")break;this.readContiguousElements(e.slice(o,a))}break;case 30325:{if(this.currentTrack?.info?.type!=="video")break;let c=-Mn(e,a);try{this.currentTrack.info.rotation=ut(c)}catch{}}break;case 225:{if(this.currentTrack?.info?.type!=="audio")break;this.readContiguousElements(e.slice(o,a))}break;case 181:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.sampleRate=Mn(e,a)}break;case 159:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.numberOfChannels=L(e,a)}break;case 25188:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.bitDepth=L(e,a)}break;case 187:{if(!this.currentSegment)break;this.readContiguousElements(e.slice(o,a)),this.currentCueTime=null}break;case 179:this.currentCueTime=L(e,a);break;case 183:{if(this.currentCueTime===null)break;p(this.currentSegment);let s={time:this.currentCueTime,trackId:-1,clusterPosition:-1};this.currentSegment.cuePoints.push(s),this.readContiguousElements(e.slice(o,a)),(s.trackId===-1||s.clusterPosition===-1)&&this.currentSegment.cuePoints.pop()}break;case 247:{let s=this.currentSegment?.cuePoints[this.currentSegment.cuePoints.length-1];if(!s)break;s.trackId=L(e,a)}break;case 241:{let s=this.currentSegment?.cuePoints[this.currentSegment.cuePoints.length-1];if(!s)break;p(this.currentSegment),s.clusterPosition=this.currentSegment.dataStartPos+L(e,a)}break;case 231:{if(!this.currentCluster)break;this.currentCluster.timestamp=L(e,a)}break;case 163:{if(!this.currentCluster)break;let s=Lt(e);if(s===null)break;let c=wr(e),u=M(e),d=!!(u&128),l=u>>1&3;this.getTrackDataInCluster(this.currentCluster,s).blocks.push({timestamp:c,duration:0,isKeyFrame:d,referencedTimestamps:[],data:D(e,a-(e.filePos-o)),lacing:l})}break;case 160:{if(!this.currentCluster)break;if(this.readContiguousElements(e.slice(o,a)),this.currentBlock){for(let s=0;s<this.currentBlock.referencedTimestamps.length;s++)this.currentBlock.referencedTimestamps[s]+=this.currentBlock.timestamp;this.currentBlock=null}}break;case 161:{if(!this.currentCluster)break;let s=Lt(e);if(s===null)break;let c=wr(e),d=M(e)>>1&3,l=this.getTrackDataInCluster(this.currentCluster,s);this.currentBlock={timestamp:c,duration:0,isKeyFrame:!0,referencedTimestamps:[],data:D(e,a-(e.filePos-o)),lacing:d},l.blocks.push(this.currentBlock)}break;case 155:{if(!this.currentBlock)break;this.currentBlock.duration=L(e,a)}break;case 251:{if(!this.currentBlock)break;this.currentBlock.isKeyFrame=!1;let s=Ns(e,a);this.currentBlock.referencedTimestamps.push(s)}break;case 29555:this.currentTagTargetIsMovie=!0,this.readContiguousElements(e.slice(o,a));break;case 25536:this.readContiguousElements(e.slice(o,a));break;case 26826:L(e,a)!==50&&(this.currentTagTargetIsMovie=!1);break;case 25541:case 25545:case 25540:case 25542:this.currentTagTargetIsMovie=!1;break;case 26568:{if(!this.currentTagTargetIsMovie)break;this.currentSimpleTagName=null,this.readContiguousElements(e.slice(o,a))}break;case 17827:this.currentSimpleTagName=Ht(e,a);break;case 17543:{if(!this.currentSimpleTagName)break;let s=Ht(e,a);this.processTagValue(this.currentSimpleTagName,s)}break;case 17541:{if(!this.currentSimpleTagName)break;let s=D(e,a);this.processTagValue(this.currentSimpleTagName,s)}break;case 24999:{if(!this.currentSegment)break;if(this.currentAttachedFile={fileName:null,fileMediaType:null,fileData:null,fileDescription:null},this.readContiguousElements(e.slice(o,a)),this.currentAttachedFile.fileMediaType?.startsWith("image/")&&this.currentAttachedFile.fileData){let s=this.currentAttachedFile.fileName,c="unknown";if(s){let u=s.toLowerCase();u.startsWith("cover.")?c="coverFront":u.startsWith("back.")&&(c="coverBack")}this.currentSegment.metadataTags.images??=[],this.currentSegment.metadataTags.images.push({data:this.currentAttachedFile.fileData,mimeType:this.currentAttachedFile.fileMediaType,kind:c,name:this.currentAttachedFile.fileName??void 0,description:this.currentAttachedFile.fileDescription??void 0})}this.currentAttachedFile=null}break;case 18030:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileName=Ht(e,a)}break;case 18016:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileMediaType=gt(e,a)}break;case 18012:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileData=D(e,a)}break;case 18046:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileDescription=Ht(e,a)}break}return e.filePos=o+a,!0}processTagValue(e,r){if(!this.currentSegment?.metadataTags)return;let i=this.currentSegment.metadataTags;if(i.raw??={},i.raw[e]??=r,typeof r=="string")switch(e.toLowerCase()){case"title":i.title??=r;break;case"description":i.description??=r;break;case"artist":i.artist??=r;break;case"album":i.album??=r;break;case"album_artist":i.albumArtist??=r;break;case"genre":i.genre??=r;break;case"comment":i.comment??=r;break;case"lyrics":i.lyrics??=r;break;case"date":{let a=new Date(r);Number.isNaN(a.getTime())||(i.date??=a)}break;case"track_number":case"part_number":{let a=r.split("/"),o=Number.parseInt(a[0],10),s=a[1]&&Number.parseInt(a[1],10);Number.isInteger(o)&&o>0&&(i.trackNumber??=o),s&&Number.isInteger(s)&&s>0&&(i.tracksTotal??=s)}break;case"disc_number":case"disc":{let a=r.split("/"),o=Number.parseInt(a[0],10),s=a[1]&&Number.parseInt(a[1],10);Number.isInteger(o)&&o>0&&(i.discNumber??=o),s&&Number.isInteger(s)&&s>0&&(i.discsTotal??=s)}break}}},fi=class{constructor(t){this.internalTrack=t;this.packetToClusterLocation=new WeakMap}getId(){return this.internalTrack.id}getCodec(){throw new Error("Not implemented on base class.")}getInternalCodecId(){return this.internalTrack.codecId}async computeDuration(){let t=await this.getPacket(1/0,{metadataOnly:!0});return(t?.timestamp??0)+(t?.duration??0)}getName(){return this.internalTrack.name}getLanguageCode(){return this.internalTrack.languageCode}async getFirstTimestamp(){return(await this.getFirstPacket({metadataOnly:!0}))?.timestamp??0}getTimeResolution(){return this.internalTrack.segment.timestampFactor}async getFirstPacket(t){return this.performClusterLookup(()=>{let e=this.internalTrack.segment.clusters[0]??null;if(e?.isKnownToBeFirstCluster){let r=e;for(;r;){if(r.trackData.get(this.internalTrack.id))return{clusterIndex:X(this.internalTrack.clusters,r.elementStartPos,a=>a.elementStartPos),blockIndex:0,correctBlockFound:!0};r=r.nextCluster}}return{clusterIndex:-1,blockIndex:-1,correctBlockFound:!1}},-1/0,1/0,t)}intoTimescale(t){return wt(t*this.internalTrack.segment.timestampFactor,14)}async getPacket(t,e){let r=this.intoTimescale(t);return this.performClusterLookup(()=>this.findBlockInClustersForTimestamp(r),r,r,e)}async getNextPacket(t,e){let r=this.packetToClusterLocation.get(t);if(r===void 0)throw new Error("Packet was not created from this track.");let i=r.cluster.trackData.get(this.internalTrack.id),a=X(this.internalTrack.clusters,r.cluster.elementStartPos,o=>o.elementStartPos);return p(a!==-1),this.performClusterLookup(()=>{if(r.blockIndex+1<i.blocks.length)return{clusterIndex:a,blockIndex:r.blockIndex+1,correctBlockFound:!0};{let o=r.cluster;for(;o.nextCluster;)if(o=o.nextCluster,o.trackData.get(this.internalTrack.id)){let c=X(this.internalTrack.clusters,o.elementStartPos,u=>u.elementStartPos);return p(c!==-1),{clusterIndex:c,blockIndex:0,correctBlockFound:!0}}return{clusterIndex:a,blockIndex:-1,correctBlockFound:!1}}},-1/0,1/0,e)}async getKeyPacket(t,e){let r=this.intoTimescale(t);return this.performClusterLookup(()=>this.findKeyBlockInClustersForTimestamp(r),r,r,e)}async getNextKeyPacket(t,e){let r=this.packetToClusterLocation.get(t);if(r===void 0)throw new Error("Packet was not created from this track.");let i=r.cluster.trackData.get(this.internalTrack.id),a=X(this.internalTrack.clusters,r.cluster.elementStartPos,o=>o.elementStartPos);return p(a!==-1),this.performClusterLookup(()=>{let o=i.blocks.findIndex((s,c)=>s.isKeyFrame&&c>r.blockIndex);if(o!==-1)return{clusterIndex:a,blockIndex:o,correctBlockFound:!0};{let s=r.cluster;for(;s.nextCluster;){s=s.nextCluster;let c=s.trackData.get(this.internalTrack.id);if(c&&c.firstKeyFrameTimestamp!==null){let u=X(this.internalTrack.clusters,s.elementStartPos,l=>l.elementStartPos);p(u!==-1);let d=c.blocks.findIndex(l=>l.isKeyFrame);return p(d!==-1),{clusterIndex:u,blockIndex:d,correctBlockFound:!0}}}return{clusterIndex:a,blockIndex:-1,correctBlockFound:!1}}},-1/0,1/0,e)}async fetchPacketInCluster(t,e,r){if(e===-1)return null;let a=t.trackData.get(this.internalTrack.id).blocks[e];p(a);let o=r.metadataOnly?le:a.data,s=a.timestamp/this.internalTrack.segment.timestampFactor,c=a.duration/this.internalTrack.segment.timestampFactor,u=new N(o,a.isKeyFrame?"key":"delta",s,c,t.dataStartPos+e,a.data.byteLength);return this.packetToClusterLocation.set(u,{cluster:t,blockIndex:e}),u}findBlockInClustersForTimestamp(t){let e=U(this.internalTrack.clusters,t,a=>a.trackData.get(this.internalTrack.id).startTimestamp),r=-1,i=!1;if(e!==-1){let o=this.internalTrack.clusters[e].trackData.get(this.internalTrack.id),s=U(o.presentationTimestamps,t,c=>c.timestamp);p(s!==-1),r=o.presentationTimestamps[s].blockIndex,i=t<o.endTimestamp}return{clusterIndex:e,blockIndex:r,correctBlockFound:i}}findKeyBlockInClustersForTimestamp(t){let e=U(this.internalTrack.clustersWithKeyFrame,t,o=>o.trackData.get(this.internalTrack.id).firstKeyFrameTimestamp),r=-1,i=-1,a=!1;if(e!==-1){let o=this.internalTrack.clustersWithKeyFrame[e];r=X(this.internalTrack.clusters,o.elementStartPos,d=>d.elementStartPos),p(r!==-1);let s=o.trackData.get(this.internalTrack.id),c=Yr(s.presentationTimestamps,d=>s.blocks[d.blockIndex].isKeyFrame&&d.timestamp<=t);p(c!==-1),i=s.presentationTimestamps[c].blockIndex,a=t<s.endTimestamp}return{clusterIndex:r,blockIndex:i,correctBlockFound:a}}async performClusterLookup(t,e,r,i){let{demuxer:a,segment:o}=this.internalTrack,s=await o.clusterLookupMutex.acquire();try{let{clusterIndex:c,blockIndex:u,correctBlockFound:d}=t();if(d){let T=this.internalTrack.clusters[c];return this.fetchPacketInCluster(T,u,i)}let l=null,m=c,f=u,h=U(this.internalTrack.cuePoints,e,T=>T.time),b=h!==-1?this.internalTrack.cuePoints[h]:null,g,w=!1;if(c===-1)g=b?.clusterPosition??o.clusterSeekStartPos,w=g===o.clusterSeekStartPos;else{let T=this.internalTrack.clusters[c];!b||T.elementStartPos>=b.clusterPosition?(g=T.elementEndPos,l=T):g=b.clusterPosition}for(;o.elementEndPos===null||g<=o.elementEndPos-ge;){if(l){let P=l.trackData.get(this.internalTrack.id);if(P&&P.startTimestamp>r)break;if(l.nextCluster){g=l.nextCluster.elementEndPos,l=l.nextCluster;continue}}let T=a.reader.requestSliceRange(g,ge,Me);if(T instanceof Promise&&(T=await T),!T)break;let S=g,y=Oe(T);if(!y||!Wt.includes(y.id)&&y.id!==236){let P=await Qi(a.reader,S,Wt,Math.min(o.elementEndPos??1/0,S+mo));if(P){g=P;continue}else break}let x=y.id,F=y.size,_=T.filePos;if(x===524531317){let P=X(o.clusters,S,Ie=>Ie.elementStartPos),E;P===-1?E=await a.readCluster(S,o):E=o.clusters[P],l&&(l.nextCluster=E),l=E,w&&(E.isKnownToBeFirstCluster=!0,w=!1);let{clusterIndex:I,blockIndex:B,correctBlockFound:G}=t();if(G){let Ie=this.internalTrack.clusters[I];return this.fetchPacketInCluster(Ie,B,i)}I!==-1&&(m=I,f=B)}if(F===null){x===524531317?(p(l),F=l.elementEndPos-_):F=(await On(a.reader,_,An,o.elementEndPos)).pos-_;let P=_+F;if(o.elementEndPos!==null&&P>o.elementEndPos-ge)break;{let E=a.reader.requestSliceRange(P,ge,Me);if(E instanceof Promise&&(E=await E),!E)break;if(Fn(E)===408125543){o.elementEndPos=P;break}}}g=_+F}let k=m!==-1?this.internalTrack.clusters[m]:null;if(b&&(!k||k.elementStartPos<b.clusterPosition)){let S=this.internalTrack.cuePoints[h-1]?.time??-1/0;return this.performClusterLookup(t,S,r,i)}return k?this.fetchPacketInCluster(k,f,i):null}finally{s()}}},Ea=class extends fi{constructor(e){super(e);this.decoderConfigPromise=null;this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getCodedWidth(){return this.internalTrack.info.width}getCodedHeight(){return this.internalTrack.info.height}getRotation(){return this.internalTrack.info.rotation}async getColorSpace(){return{primaries:this.internalTrack.info.colorSpace?.primaries,transfer:this.internalTrack.info.colorSpace?.transfer,matrix:this.internalTrack.info.colorSpace?.matrix,fullRange:this.internalTrack.info.colorSpace?.fullRange}}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfigPromise??=(async()=>{let e=null;return(this.internalTrack.info.codec==="vp9"||this.internalTrack.info.codec==="av1"||this.internalTrack.info.codec==="avc"&&!this.internalTrack.info.codecDescription||this.internalTrack.info.codec==="hevc"&&!this.internalTrack.info.codecDescription)&&(e=await this.getFirstPacket({})),{codec:an({width:this.internalTrack.info.width,height:this.internalTrack.info.height,codec:this.internalTrack.info.codec,codecDescription:this.internalTrack.info.codecDescription,colorSpace:this.internalTrack.info.colorSpace,avcCodecInfo:this.internalTrack.info.codec==="avc"&&e?pn(e.data):null,hevcCodecInfo:this.internalTrack.info.codec==="hevc"&&e?hn(e.data):null,vp9CodecInfo:this.internalTrack.info.codec==="vp9"&&e?gn(e.data):null,av1CodecInfo:this.internalTrack.info.codec==="av1"&&e?bn(e.data):null}),codedWidth:this.internalTrack.info.width,codedHeight:this.internalTrack.info.height,description:this.internalTrack.info.codecDescription??void 0,colorSpace:this.internalTrack.info.colorSpace??void 0}})():null}},_a=class extends fi{constructor(e){super(e);this.decoderConfig=null;this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getNumberOfChannels(){return this.internalTrack.info.numberOfChannels}getSampleRate(){return this.internalTrack.info.sampleRate}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfig??={codec:sn({codec:this.internalTrack.info.codec,codecDescription:this.internalTrack.info.codecDescription,aacCodecInfo:this.internalTrack.info.aacCodecInfo}),numberOfChannels:this.internalTrack.info.numberOfChannels,sampleRate:this.internalTrack.info.sampleRate,description:this.internalTrack.info.codecDescription??void 0}:null}},wu=n=>{let t=new Map;for(let a=0;a<n.length;a++){let o=n[a];t.set(o.timestamp,o)}let e=new Set,r=[],i=a=>{if(!e.has(a)){e.add(a);for(let o=0;o<a.referencedTimestamps.length;o++){let s=a.referencedTimestamps[o],c=t.get(s);c&&i(c)}r.push(a)}};for(let a=0;a<n.length;a++)i(n[a]);return r};var pi=class extends be{constructor(e){super(e);this.metadataPromise=null;this.firstFrameHeader=null;this.loadedSamples=[];this.metadataTags=null;this.tracks=[];this.readingMutex=new ce;this.lastSampleLoaded=!1;this.lastLoadedPos=0;this.nextTimestampInSamples=0;this.reader=e._reader}async readMetadata(){return this.metadataPromise??=(async()=>{for(;!this.firstFrameHeader&&!this.lastSampleLoaded;)await this.advanceReader();if(!this.firstFrameHeader)throw new Error("No valid MP3 frame found.");this.tracks=[new ie(new Aa(this))]})()}async advanceReader(){if(this.lastLoadedPos===0)for(;;){let c=this.reader.requestSlice(this.lastLoadedPos,Gt);if(c instanceof Promise&&(c=await c),!c){this.lastSampleLoaded=!0;return}let u=Cr(c);if(!u)break;this.lastLoadedPos=c.filePos+u.size}let e=await xr(this.reader,this.lastLoadedPos,this.reader.fileSize);if(!e){this.lastSampleLoaded=!0;return}let r=e.header;this.lastLoadedPos=e.startPos+r.totalSize-1;let i=jt(r.mpegVersionId,r.channel),a=this.reader.requestSlice(e.startPos+i,4);if(a instanceof Promise&&(a=await a),a){let c=v(a);if(c===Kt||c===Bn)return}this.firstFrameHeader||(this.firstFrameHeader=r);let o=r.audioSamplesInFrame/r.sampleRate,s={timestamp:this.nextTimestampInSamples/r.sampleRate,duration:o,dataStart:e.startPos,dataSize:r.totalSize};this.loadedSamples.push(s),this.nextTimestampInSamples+=r.audioSamplesInFrame}async getMimeType(){return"audio/mpeg"}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){await this.readMetadata();let e=this.tracks[0];return p(e),e.computeDuration()}async getMetadataTags(){let e=await this.readingMutex.acquire();try{if(await this.readMetadata(),this.metadataTags)return this.metadataTags;this.metadataTags={};let r=0,i=!1;for(;;){let a=this.reader.requestSlice(r,Gt);if(a instanceof Promise&&(a=await a),!a)break;let o=Cr(a);if(!o)break;i=!0;let s=this.reader.requestSlice(a.filePos,o.size);if(s instanceof Promise&&(s=await s),!s)break;Qs(s,o,this.metadataTags),r=a.filePos+o.size}if(!i&&this.reader.fileSize!==null&&this.reader.fileSize>=Sr){let a=this.reader.requestSlice(this.reader.fileSize-Sr,Sr);a instanceof Promise&&(a=await a),p(a),J(a,3)==="TAG"&&$s(a,this.metadataTags)}return this.metadataTags}finally{e()}}},Aa=class{constructor(t){this.demuxer=t}getId(){return 1}async getFirstTimestamp(){return 0}getTimeResolution(){return p(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.sampleRate/this.demuxer.firstFrameHeader.audioSamplesInFrame}async computeDuration(){let t=await this.getPacket(1/0,{metadataOnly:!0});return(t?.timestamp??0)+(t?.duration??0)}getName(){return null}getLanguageCode(){return te}getCodec(){return"mp3"}getInternalCodecId(){return null}getNumberOfChannels(){return p(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.channel===3?1:2}getSampleRate(){return p(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.sampleRate}async getDecoderConfig(){return p(this.demuxer.firstFrameHeader),{codec:"mp3",numberOfChannels:this.demuxer.firstFrameHeader.channel===3?1:2,sampleRate:this.demuxer.firstFrameHeader.sampleRate}}async getPacketAtIndex(t,e){if(t===-1)return null;let r=this.demuxer.loadedSamples[t];if(!r)return null;let i;if(e.metadataOnly)i=le;else{let a=this.demuxer.reader.requestSlice(r.dataStart,r.dataSize);if(a instanceof Promise&&(a=await a),!a)return null;i=D(a,r.dataSize)}return new N(i,"key",r.timestamp,r.duration,t,r.dataSize)}getFirstPacket(t){return this.getPacketAtIndex(0,t)}async getNextPacket(t,e){let r=await this.demuxer.readingMutex.acquire();try{let i=X(this.demuxer.loadedSamples,t.timestamp,o=>o.timestamp);if(i===-1)throw new Error("Packet was not created from this track.");let a=i+1;for(;a>=this.demuxer.loadedSamples.length&&!this.demuxer.lastSampleLoaded;)await this.demuxer.advanceReader();return this.getPacketAtIndex(a,e)}finally{r()}}async getPacket(t,e){let r=await this.demuxer.readingMutex.acquire();try{for(;;){let i=U(this.demuxer.loadedSamples,t,a=>a.timestamp);if(i===-1&&this.demuxer.loadedSamples.length>0)return null;if(this.demuxer.lastSampleLoaded)return this.getPacketAtIndex(i,e);if(i>=0&&i+1<this.demuxer.loadedSamples.length)return this.getPacketAtIndex(i,e);await this.demuxer.advanceReader()}}finally{r()}}getKeyPacket(t,e){return this.getPacket(t,e)}getNextKeyPacket(t,e){return this.getNextPacket(t,e)}};var hi=class extends be{constructor(e){super(e);this.metadataPromise=null;this.bitstreams=[];this.tracks=[];this.metadataTags={};this.reader=e._reader}async readMetadata(){return this.metadataPromise??=(async()=>{let e=0;for(;;){let r=this.reader.requestSliceRange(e,bt,Ct);if(r instanceof Promise&&(r=await r),!r)break;let i=Xt(r);if(!i||!!!(i.headerType&2))break;this.bitstreams.push({serialNumber:i.serialNumber,bosPage:i,description:null,numberOfChannels:-1,sampleRate:-1,codecInfo:{codec:null,vorbisInfo:null,opusInfo:null},lastMetadataPacket:null}),e=i.headerStartPos+i.totalSize}for(let r of this.bitstreams){let i=await this.readPacket(r.bosPage,0);i&&(i.data.byteLength>=7&&i.data[0]===1&&i.data[1]===118&&i.data[2]===111&&i.data[3]===114&&i.data[4]===98&&i.data[5]===105&&i.data[6]===115?await this.readVorbisMetadata(i,r):i.data.byteLength>=8&&i.data[0]===79&&i.data[1]===112&&i.data[2]===117&&i.data[3]===115&&i.data[4]===72&&i.data[5]===101&&i.data[6]===97&&i.data[7]===100&&await this.readOpusMetadata(i,r),r.codecInfo.codec!==null&&this.tracks.push(new ie(new Fa(r,this))))}})()}async readVorbisMetadata(e,r){let i=await this.findNextPacketStart(e);if(!i)return;let a=await this.readPacket(i.startPage,i.startSegmentIndex);if(!a||(i=await this.findNextPacketStart(a),!i))return;let o=await this.readPacket(i.startPage,i.startSegmentIndex);if(!o||a.data[0]!==3||o.data[0]!==5)return;let s=[],c=m=>{for(;s.push(Math.min(255,m)),!(m<255);)m-=255};c(e.data.length),c(a.data.length);let u=new Uint8Array(1+s.length+e.data.length+a.data.length+o.data.length);u[0]=s.length,u.set(s,1),u.set(e.data,1+s.length),u.set(a.data,1+s.length+e.data.length),u.set(o.data,1+s.length+e.data.length+a.data.length),r.codecInfo.codec="vorbis",r.description=u,r.lastMetadataPacket=o;let d=V(e.data);r.numberOfChannels=d.getUint8(11),r.sampleRate=d.getUint32(12,!0);let l=d.getUint8(28);r.codecInfo.vorbisInfo={blocksizes:[1<<(l&15),1<<(l>>4)],modeBlockflags:kn(o.data).modeBlockflags},this.readVorbisComments(a.data.subarray(7))}async readOpusMetadata(e,r){let i=await this.findNextPacketStart(e);if(!i)return;let a=await this.readPacket(i.startPage,i.startSegmentIndex);if(!a)return;r.codecInfo.codec="opus",r.description=e.data,r.lastMetadataPacket=a;let o=lt(e.data);r.numberOfChannels=o.outputChannelCount,r.sampleRate=Ae,r.codecInfo.opusInfo={preSkip:o.preSkip},this.readVorbisComments(a.data.subarray(8))}readVorbisComments(e){let r=V(e),i=0,a=r.getUint32(i,!0);i+=4;let o=fe.decode(e.subarray(i,i+a));i+=a,a>0&&(this.metadataTags.raw??={},this.metadataTags.raw.vendor??=o);let s=r.getUint32(i,!0);i+=4;for(let c=0;c<s;c++){let u=r.getUint32(i,!0);i+=4;let d=fe.decode(e.subarray(i,i+u));i+=u;let l=d.indexOf("=");if(l===-1)continue;let m=d.slice(0,l).toUpperCase(),f=d.slice(l+1);switch(this.metadataTags.raw??={},this.metadataTags.raw[m]??=f,m){case"TITLE":this.metadataTags.title??=f;break;case"DESCRIPTION":this.metadataTags.description??=f;break;case"ARTIST":this.metadataTags.artist??=f;break;case"ALBUM":this.metadataTags.album??=f;break;case"ALBUMARTIST":this.metadataTags.albumArtist??=f;break;case"COMMENT":this.metadataTags.comment??=f;break;case"LYRICS":this.metadataTags.lyrics??=f;break;case"TRACKNUMBER":{let h=f.split("/"),b=Number.parseInt(h[0],10),g=h[1]&&Number.parseInt(h[1],10);Number.isInteger(b)&&b>0&&(this.metadataTags.trackNumber??=b),g&&Number.isInteger(g)&&g>0&&(this.metadataTags.tracksTotal??=g)}break;case"TRACKTOTAL":{let h=Number.parseInt(f,10);Number.isInteger(h)&&h>0&&(this.metadataTags.tracksTotal??=h)}break;case"DISCNUMBER":{let h=f.split("/"),b=Number.parseInt(h[0],10),g=h[1]&&Number.parseInt(h[1],10);Number.isInteger(b)&&b>0&&(this.metadataTags.discNumber??=b),g&&Number.isInteger(g)&&g>0&&(this.metadataTags.discsTotal??=g)}break;case"DISCTOTAL":{let h=Number.parseInt(f,10);Number.isInteger(h)&&h>0&&(this.metadataTags.discsTotal??=h)}break;case"DATE":{let h=new Date(f);Number.isNaN(h.getTime())||(this.metadataTags.date??=h)}break;case"GENRE":this.metadataTags.genre??=f;break;case"METADATA_BLOCK_PICTURE":{let h=Ga(f),b=V(h),g=b.getUint32(0,!1),w=b.getUint32(4,!1),k=String.fromCharCode(...h.subarray(8,8+w)),T=b.getUint32(8+w,!1),S=fe.decode(h.subarray(12+w,12+w+T)),y=b.getUint32(w+T+28),x=h.subarray(w+T+32,w+T+32+y);this.metadataTags.images??=[],this.metadataTags.images.push({data:x,mimeType:k,kind:g===3?"coverFront":g===4?"coverBack":"unknown",name:void 0,description:S||void 0})}break}}}async readPacket(e,r){p(r<e.lacingValues.length);let i=0;for(let m=0;m<r;m++)i+=e.lacingValues[m];let a=e,o=i,s=r,c=[];e:for(;;){let m=this.reader.requestSlice(a.dataStartPos,a.dataSize);m instanceof Promise&&(m=await m),p(m);let f=D(m,a.dataSize);for(;;){if(s===a.lacingValues.length){c.push(f.subarray(i,o));break}let b=a.lacingValues[s];if(o+=b,b<255){c.push(f.subarray(i,o));break e}s++}let h=a.headerStartPos+a.totalSize;for(;;){let b=this.reader.requestSliceRange(h,bt,Ct);if(b instanceof Promise&&(b=await b),!b)return null;let g=Xt(b);if(!g)return null;if(a=g,a.serialNumber===e.serialNumber)break;h=a.headerStartPos+a.totalSize}i=0,o=0,s=0}let u=c.reduce((m,f)=>m+f.length,0),d=new Uint8Array(u),l=0;for(let m=0;m<c.length;m++){let f=c[m];d.set(f,l),l+=f.length}return{data:d,endPage:a,endSegmentIndex:s}}async findNextPacketStart(e){if(e.endSegmentIndex<e.endPage.lacingValues.length-1)return{startPage:e.endPage,startSegmentIndex:e.endSegmentIndex+1};if(!!(e.endPage.headerType&4))return null;let i=e.endPage.headerStartPos+e.endPage.totalSize;for(;;){let a=this.reader.requestSliceRange(i,bt,Ct);if(a instanceof Promise&&(a=await a),!a)return null;let o=Xt(a);if(!o)return null;if(o.serialNumber===e.endPage.serialNumber)return{startPage:o,startSegmentIndex:0};i=o.headerStartPos+o.totalSize}}async getMimeType(){await this.readMetadata();let e=await Promise.all(this.tracks.map(r=>r.getCodecParameterString()));return qn({codecStrings:e.filter(Boolean)})}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){let e=await this.getTracks(),r=await Promise.all(e.map(i=>i.computeDuration()));return Math.max(0,...r)}async getMetadataTags(){return await this.readMetadata(),this.metadataTags}},Fa=class{constructor(t,e){this.bitstream=t;this.demuxer=e;this.encodedPacketToMetadata=new WeakMap;this.sequentialScanCache=[];this.sequentialScanMutex=new ce;this.internalSampleRate=t.codecInfo.codec==="opus"?Ae:t.sampleRate}getId(){return this.bitstream.serialNumber}getNumberOfChannels(){return this.bitstream.numberOfChannels}getSampleRate(){return this.bitstream.sampleRate}getTimeResolution(){return this.bitstream.sampleRate}getCodec(){return this.bitstream.codecInfo.codec}getInternalCodecId(){return null}async getDecoderConfig(){return p(this.bitstream.codecInfo.codec),{codec:this.bitstream.codecInfo.codec,numberOfChannels:this.bitstream.numberOfChannels,sampleRate:this.bitstream.sampleRate,description:this.bitstream.description??void 0}}getName(){return null}getLanguageCode(){return te}async getFirstTimestamp(){return 0}async computeDuration(){let t=await this.getPacket(1/0,{metadataOnly:!0});return(t?.timestamp??0)+(t?.duration??0)}granulePositionToTimestampInSamples(t){return this.bitstream.codecInfo.codec==="opus"?(p(this.bitstream.codecInfo.opusInfo),t-this.bitstream.codecInfo.opusInfo.preSkip):t}createEncodedPacketFromOggPacket(t,e,r){if(!t)return null;let{durationInSamples:i,vorbisBlockSize:a}=Hn(t.data,this.bitstream.codecInfo,e.vorbisLastBlocksize),o=new N(r.metadataOnly?le:t.data,"key",Math.max(0,e.timestampInSamples)/this.internalSampleRate,i/this.internalSampleRate,t.endPage.headerStartPos+t.endSegmentIndex,t.data.byteLength);return this.encodedPacketToMetadata.set(o,{packet:t,timestampInSamples:e.timestampInSamples,durationInSamples:i,vorbisLastBlockSize:e.vorbisLastBlocksize,vorbisBlockSize:a}),o}async getFirstPacket(t){p(this.bitstream.lastMetadataPacket);let e=await this.demuxer.findNextPacketStart(this.bitstream.lastMetadataPacket);if(!e)return null;let r=0;this.bitstream.codecInfo.codec==="opus"&&(p(this.bitstream.codecInfo.opusInfo),r-=this.bitstream.codecInfo.opusInfo.preSkip);let i=await this.demuxer.readPacket(e.startPage,e.startSegmentIndex);return this.createEncodedPacketFromOggPacket(i,{timestampInSamples:r,vorbisLastBlocksize:null},t)}async getNextPacket(t,e){let r=this.encodedPacketToMetadata.get(t);if(!r)throw new Error("Packet was not created from this track.");let i=await this.demuxer.findNextPacketStart(r.packet);if(!i)return null;let a=r.timestampInSamples+r.durationInSamples,o=await this.demuxer.readPacket(i.startPage,i.startSegmentIndex);return this.createEncodedPacketFromOggPacket(o,{timestampInSamples:a,vorbisLastBlocksize:r.vorbisBlockSize},e)}async getPacket(t,e){if(this.demuxer.reader.fileSize===null)return this.getPacketSequential(t,e);let r=wt(t*this.internalSampleRate,14);if(r===0)return this.getFirstPacket(e);if(r<0)return null;p(this.bitstream.lastMetadataPacket);let i=await this.demuxer.findNextPacketStart(this.bitstream.lastMetadataPacket);if(!i)return null;let a=i.startPage,o=this.demuxer.reader.fileSize,s=[a];e:for(;a.headerStartPos+a.totalSize<o;){let k=a.headerStartPos,T=Math.floor((k+o)/2),S=T;for(;;){let y=Math.min(S+Kn,o-bt),x=this.demuxer.reader.requestSlice(S,y-S);if(x instanceof Promise&&(x=await x),p(x),!Xs(x,y)){o=T+bt;continue e}let _=this.demuxer.reader.requestSliceRange(x.filePos,bt,Ct);_ instanceof Promise&&(_=await _),p(_);let P=Xt(_);p(P);let E=!1;if(P.serialNumber===this.bitstream.serialNumber)E=!0;else{let B=this.demuxer.reader.requestSlice(P.headerStartPos,P.totalSize);B instanceof Promise&&(B=await B),p(B);let G=D(B,P.totalSize);E=Ln(G)===P.checksum}if(!E){S=P.headerStartPos+4;continue}if(E&&P.serialNumber!==this.bitstream.serialNumber){S=P.headerStartPos+P.totalSize;continue}if(P.granulePosition===-1){S=P.headerStartPos+P.totalSize;continue}this.granulePositionToTimestampInSamples(P.granulePosition)>r?o=P.headerStartPos:(a=P,s.push(P));continue e}}let c=i.startPage;for(let k of s){if(k.granulePosition===a.granulePosition)break;(!c||k.headerStartPos>c.headerStartPos)&&(c=k)}let u=c,d=[u];for(;!(u.serialNumber===this.bitstream.serialNumber&&u.granulePosition===a.granulePosition);){let k=u.headerStartPos+u.totalSize,T=this.demuxer.reader.requestSliceRange(k,bt,Ct);T instanceof Promise&&(T=await T),p(T);let S=Xt(T);p(S),u=S,u.serialNumber===this.bitstream.serialNumber&&d.push(u)}p(u.granulePosition!==-1);let l=null,m,f,h=u,b=0;if(u.headerStartPos===i.startPage.headerStartPos)m=this.granulePositionToTimestampInSamples(0),f=!0,l=0;else{m=0,f=!1;for(let S=u.lacingValues.length-1;S>=0;S--)if(u.lacingValues[S]<255){l=S+1;break}if(l===null)throw new Error("Invalid page with granule position: no packets end on this page.");b=l-1;let k={data:le,endPage:h,endSegmentIndex:b};if(await this.demuxer.findNextPacketStart(k)){let S=po(d,u,l);p(S);let y=fo(d,S.page,S.segmentIndex);y&&(u=y.page,l=y.segmentIndex)}else for(;;){let S=po(d,u,l);if(!S)break;let y=fo(d,S.page,S.segmentIndex);if(!y)break;if(u=y.page,l=y.segmentIndex,S.page.headerStartPos!==h.headerStartPos){h=S.page,b=S.segmentIndex;break}}}let g=null,w=null;for(;u!==null;){p(l!==null);let k=await this.demuxer.readPacket(u,l);if(!k)break;if(!(u.headerStartPos===i.startPage.headerStartPos&&l<i.startSegmentIndex)){let y=this.createEncodedPacketFromOggPacket(k,{timestampInSamples:m,vorbisLastBlocksize:w?.vorbisBlockSize??null},e);p(y);let x=this.encodedPacketToMetadata.get(y);if(p(x),!f&&k.endPage.headerStartPos===h.headerStartPos&&k.endSegmentIndex===b?(m=this.granulePositionToTimestampInSamples(u.granulePosition),f=!0,y=this.createEncodedPacketFromOggPacket(k,{timestampInSamples:m-x.durationInSamples,vorbisLastBlocksize:w?.vorbisBlockSize??null},e),p(y),x=this.encodedPacketToMetadata.get(y),p(x)):m+=x.durationInSamples,g=y,w=x,f&&(Math.max(m,0)>r||Math.max(x.timestampInSamples,0)===r))break}let S=await this.demuxer.findNextPacketStart(k);if(!S)break;u=S.startPage,l=S.startSegmentIndex}return g}async getPacketSequential(t,e){let r=await this.sequentialScanMutex.acquire();try{let i=wt(t*this.internalSampleRate,14);t=i/this.internalSampleRate;let a=U(this.sequentialScanCache,i,c=>c.timestampInSamples),o;if(a!==-1){let c=this.sequentialScanCache[a];o=this.createEncodedPacketFromOggPacket(c.packet,{timestampInSamples:c.timestampInSamples,vorbisLastBlocksize:c.vorbisLastBlockSize},e)}else o=await this.getFirstPacket(e);let s=0;for(;o&&o.timestamp<t;){let c=await this.getNextPacket(o,e);if(!c||c.timestamp>t)break;if(o=c,s++,s===100){s=0;let u=this.encodedPacketToMetadata.get(o);p(u),this.sequentialScanCache.length>0&&p(H(this.sequentialScanCache).timestampInSamples<=u.timestampInSamples),this.sequentialScanCache.push(u)}}return o}finally{r()}}getKeyPacket(t,e){return this.getPacket(t,e)}getNextKeyPacket(t,e){return this.getNextPacket(t,e)}},fo=(n,t,e)=>{let r=t,i=e;e:for(;;){for(i--,i;i>=0;i--)if(r.lacingValues[i]<255){i++;break e}if(p(i===-1),!(r.headerType&1)){i=0;break}let o=Ei(n,s=>s.headerStartPos<r.headerStartPos);if(!o)return null;r=o,i=r.lacingValues.length}if(p(i!==-1),i===r.lacingValues.length){let a=n[n.indexOf(r)+1];p(a),r=a,i=0}return{page:r,segmentIndex:i}},po=(n,t,e)=>{if(e>0)return{page:t,segmentIndex:e-1};let r=Ei(n,i=>i.headerStartPos<t.headerStartPos);return r?{page:r,segmentIndex:r.lacingValues.length-1}:null};var or=7,cr=9,Lr=n=>{let t=n.filePos,e=D(n,9),r=new $(e);if(r.readBits(12)!==4095||(r.skipBits(1),r.readBits(2)!==0))return null;let o=r.readBits(1),s=r.readBits(2)+1,c=r.readBits(4);if(c===15)return null;r.skipBits(1);let u=r.readBits(3);if(u===0)throw new Error("ADTS frames with channel configuration 0 are not supported.");r.skipBits(1),r.skipBits(1),r.skipBits(1),r.skipBits(1);let d=r.readBits(13);r.skipBits(11);let l=r.readBits(2)+1;if(l!==1)throw new Error("ADTS frames with more than one AAC frame are not supported.");let m=null;return o===1?n.filePos-=2:m=r.readBits(16),{objectType:s,samplingFrequencyIndex:c,channelConfiguration:u,frameLength:d,numberOfAacFrames:l,crcCheck:m,startPos:t}};var Ma=1024,gi=class extends be{constructor(e){super(e);this.metadataPromise=null;this.firstFrameHeader=null;this.loadedSamples=[];this.tracks=[];this.readingMutex=new ce;this.lastSampleLoaded=!1;this.lastLoadedPos=0;this.nextTimestampInSamples=0;this.reader=e._reader}async readMetadata(){return this.metadataPromise??=(async()=>{for(;!this.firstFrameHeader&&!this.lastSampleLoaded;)await this.advanceReader();p(this.firstFrameHeader),this.tracks=[new ie(new Oa(this))]})()}async advanceReader(){let e=this.reader.requestSliceRange(this.lastLoadedPos,or,cr);if(e instanceof Promise&&(e=await e),!e){this.lastSampleLoaded=!0;return}let r=Lr(e);if(!r){this.lastSampleLoaded=!0;return}if(this.reader.fileSize!==null&&r.startPos+r.frameLength>this.reader.fileSize){this.lastSampleLoaded=!0;return}this.firstFrameHeader||(this.firstFrameHeader=r);let i=lr[r.samplingFrequencyIndex];p(i!==void 0);let a=Ma/i,o=r.crcCheck?cr:or,s={timestamp:this.nextTimestampInSamples/i,duration:a,dataStart:r.startPos+o,dataSize:r.frameLength-o};this.loadedSamples.push(s),this.nextTimestampInSamples+=Ma,this.lastLoadedPos=r.startPos+r.frameLength}async getMimeType(){return"audio/aac"}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){await this.readMetadata();let e=this.tracks[0];return p(e),e.computeDuration()}async getMetadataTags(){return{}}},Oa=class{constructor(t){this.demuxer=t}getId(){return 1}async getFirstTimestamp(){return 0}getTimeResolution(){return this.getSampleRate()/Ma}async computeDuration(){let t=await this.getPacket(1/0,{metadataOnly:!0});return(t?.timestamp??0)+(t?.duration??0)}getName(){return null}getLanguageCode(){return te}getCodec(){return"aac"}getInternalCodecId(){return p(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.objectType}getNumberOfChannels(){p(this.demuxer.firstFrameHeader);let t=Mi[this.demuxer.firstFrameHeader.channelConfiguration];return p(t!==void 0),t}getSampleRate(){p(this.demuxer.firstFrameHeader);let t=lr[this.demuxer.firstFrameHeader.samplingFrequencyIndex];return p(t!==void 0),t}async getDecoderConfig(){p(this.demuxer.firstFrameHeader);let t=new Uint8Array(3),e=new $(t),{objectType:r,samplingFrequencyIndex:i,channelConfiguration:a}=this.demuxer.firstFrameHeader;return r>31?(e.writeBits(5,31),e.writeBits(6,r-32)):e.writeBits(5,r),e.writeBits(4,i),e.writeBits(4,a),{codec:`mp4a.40.${this.demuxer.firstFrameHeader.objectType}`,numberOfChannels:this.getNumberOfChannels(),sampleRate:this.getSampleRate(),description:t.subarray(0,Math.ceil((e.pos-1)/8))}}async getPacketAtIndex(t,e){if(t===-1)return null;let r=this.demuxer.loadedSamples[t];if(!r)return null;let i;if(e.metadataOnly)i=le;else{let a=this.demuxer.reader.requestSlice(r.dataStart,r.dataSize);if(a instanceof Promise&&(a=await a),!a)return null;i=D(a,r.dataSize)}return new N(i,"key",r.timestamp,r.duration,t,r.dataSize)}getFirstPacket(t){return this.getPacketAtIndex(0,t)}async getNextPacket(t,e){let r=await this.demuxer.readingMutex.acquire();try{let i=X(this.demuxer.loadedSamples,t.timestamp,o=>o.timestamp);if(i===-1)throw new Error("Packet was not created from this track.");let a=i+1;for(;a>=this.demuxer.loadedSamples.length&&!this.demuxer.lastSampleLoaded;)await this.demuxer.advanceReader();return this.getPacketAtIndex(a,e)}finally{r()}}async getPacket(t,e){let r=await this.demuxer.readingMutex.acquire();try{for(;;){let i=U(this.demuxer.loadedSamples,t,a=>a.timestamp);if(i===-1&&this.demuxer.loadedSamples.length>0)return null;if(this.demuxer.lastSampleLoaded)return this.getPacketAtIndex(i,e);if(i>=0&&i+1<this.demuxer.loadedSamples.length)return this.getPacketAtIndex(i,e);await this.demuxer.advanceReader()}}finally{r()}}getKeyPacket(t,e){return this.getPacket(t,e)}getNextKeyPacket(t,e){return this.getNextPacket(t,e)}};var Ve=class{},Hr=class extends Ve{async _getMajorBrand(t){let e=t._reader.requestSlice(0,12);return e instanceof Promise&&(e=await e),!e||(e.skip(4),J(e,4)!=="ftyp")?null:J(e,4)}_createDemuxer(t){return new di(t)}},bi=class extends Hr{async _canReadInput(t){let e=await this._getMajorBrand(t);return!!e&&e!=="qt  "}get name(){return"MP4"}get mimeType(){return"video/mp4"}},ki=class extends Hr{async _canReadInput(t){return await this._getMajorBrand(t)==="qt  "}get name(){return"QuickTime File Format"}get mimeType(){return"video/quicktime"}},qr=class extends Ve{async isSupportedEBMLOfDocType(t,e){let r=t._reader.requestSlice(0,Me);if(r instanceof Promise&&(r=await r),!r)return!1;let i=ji(r);if(i===null||i<1||i>8||L(r,i)!==440786851)return!1;let o=$i(r);if(o===null)return!1;let s=t._reader.requestSlice(r.filePos,o);if(s instanceof Promise&&(s=await s),!s)return!1;let c=r.filePos;for(;s.filePos<=c+o-ge;){let u=Oe(s);if(!u)break;let{id:d,size:l}=u,m=s.filePos;if(l===null)return!1;switch(d){case 17030:if(L(s,l)!==1)return!1;break;case 17143:if(L(s,l)!==1)return!1;break;case 17026:if(gt(s,l)!==e)return!1;break;case 17031:if(L(s,l)>4)return!1;break}s.filePos=m+l}return!0}_canReadInput(t){return this.isSupportedEBMLOfDocType(t,"matroska")}_createDemuxer(t){return new mi(t)}get name(){return"Matroska"}get mimeType(){return"video/x-matroska"}},Ti=class extends qr{_canReadInput(t){return this.isSupportedEBMLOfDocType(t,"webm")}get name(){return"WebM"}get mimeType(){return"video/webm"}},wi=class extends Ve{async _canReadInput(t){let e=t._reader.requestSlice(0,10);if(e instanceof Promise&&(e=await e),!e)return!1;let r=0,i=!1;for(;;){let u=t._reader.requestSlice(r,Gt);if(u instanceof Promise&&(u=await u),!u)break;let d=Cr(u);if(!d)break;i=!0,r=u.filePos+d.size}let a=await xr(t._reader,r,r+4096);if(!a)return!1;if(i)return!0;r=a.startPos+=a.header.totalSize;let o=await xr(t._reader,r,r+4);if(!o)return!1;let s=a.header,c=o.header;return!(s.channel!==c.channel||s.sampleRate!==c.sampleRate)}_createDemuxer(t){return new pi(t)}get name(){return"MP3"}get mimeType(){return"audio/mpeg"}},yi=class extends Ve{async _canReadInput(t){let e=t._reader.requestSlice(0,12);if(e instanceof Promise&&(e=await e),!e)return!1;let r=J(e,4);return r!=="RIFF"&&r!=="RIFX"&&r!=="RF64"?!1:(e.skip(4),J(e,4)==="WAVE")}_createDemuxer(t){return new Zn(t)}get name(){return"WAVE"}get mimeType(){return"audio/wav"}},Si=class extends Ve{async _canReadInput(t){let e=t._reader.requestSlice(0,4);return e instanceof Promise&&(e=await e),e?J(e,4)==="OggS":!1}_createDemuxer(t){return new hi(t)}get name(){return"Ogg"}get mimeType(){return"application/ogg"}},xi=class extends Ve{async _canReadInput(t){let e=t._reader.requestSliceRange(0,or,cr);if(e instanceof Promise&&(e=await e),!e)return!1;let r=Lr(e);if(!r||(e=t._reader.requestSliceRange(r.frameLength,or,cr),e instanceof Promise&&(e=await e),!e))return!1;let i=Lr(e);return i?r.objectType===i.objectType&&r.samplingFrequencyIndex===i.samplingFrequencyIndex&&r.channelConfiguration===i.channelConfiguration:!1}_createDemuxer(t){return new gi(t)}get name(){return"ADTS"}get mimeType(){return"audio/aac"}},ho=new bi,go=new ki,bo=new qr,ko=new Ti,To=new wi,wo=new yi,yo=new Si,So=new xi,yu=[ho,go,bo,ko,wo,yo,To,So];var Kr=class{constructor(t){this._demuxerPromise=null;this._format=null;if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(!Array.isArray(t.formats)||t.formats.some(e=>!(e instanceof Ve)))throw new TypeError("options.formats must be an array of InputFormat.");if(!(t.source instanceof Be))throw new TypeError("options.source must be a Source.");this._formats=t.formats,this._source=t.source,this._reader=new Cn(t.source)}_getDemuxer(){return this._demuxerPromise??=(async()=>{this._reader.fileSize=await this._source.getSizeOrNull();for(let t of this._formats)if(await t._canReadInput(this))return this._format=t,t._createDemuxer(this);throw new Error("Input has an unsupported or unrecognizable format.")})()}get source(){return this._source}async getFormat(){return await this._getDemuxer(),p(this._format),this._format}async computeDuration(){return(await this._getDemuxer()).computeDuration()}async getTracks(){return(await this._getDemuxer()).getTracks()}async getVideoTracks(){return(await this.getTracks()).filter(e=>e.isVideoTrack())}async getAudioTracks(){return(await this.getTracks()).filter(e=>e.isAudioTrack())}async getPrimaryVideoTrack(){return(await this.getTracks()).find(e=>e.isVideoTrack())??null}async getPrimaryAudioTrack(){return(await this.getTracks()).find(e=>e.isAudioTrack())??null}async getMimeType(){return(await this._getDemuxer()).getMimeType()}async getMetadataTags(){return(await this._getDemuxer()).getMetadataTags()}};var xo=n=>{if(n!==void 0&&(!n||typeof n!="object"))throw new TypeError("options.video, when provided, must be an object.");if(n?.discard!==void 0&&typeof n.discard!="boolean")throw new TypeError("options.video.discard, when provided, must be a boolean.");if(n?.forceTranscode!==void 0&&typeof n.forceTranscode!="boolean")throw new TypeError("options.video.forceTranscode, when provided, must be a boolean.");if(n?.codec!==void 0&&!re.includes(n.codec))throw new TypeError(`options.video.codec, when provided, must be one of: ${re.join(", ")}.`);if(n?.bitrate!==void 0&&!(n.bitrate instanceof oe)&&(!Number.isInteger(n.bitrate)||n.bitrate<=0))throw new TypeError("options.video.bitrate, when provided, must be a positive integer or a quality.");if(n?.width!==void 0&&(!Number.isInteger(n.width)||n.width<=0))throw new TypeError("options.video.width, when provided, must be a positive integer.");if(n?.height!==void 0&&(!Number.isInteger(n.height)||n.height<=0))throw new TypeError("options.video.height, when provided, must be a positive integer.");if(n?.fit!==void 0&&!["fill","contain","cover"].includes(n.fit))throw new TypeError('options.video.fit, when provided, must be one of "fill", "contain", or "cover".');if(n?.width!==void 0&&n.height!==void 0&&n.fit===void 0)throw new TypeError("When both options.video.width and options.video.height are provided, options.video.fit must also be provided.");if(n?.rotate!==void 0&&![0,90,180,270].includes(n.rotate))throw new TypeError("options.video.rotate, when provided, must be 0, 90, 180 or 270.");if(n?.crop!==void 0&&Ar(n.crop,"options.video."),n?.frameRate!==void 0&&(!Number.isFinite(n.frameRate)||n.frameRate<=0))throw new TypeError("options.video.frameRate, when provided, must be a finite positive number.")},Co=n=>{if(n!==void 0&&(!n||typeof n!="object"))throw new TypeError("options.audio, when provided, must be an object.");if(n?.discard!==void 0&&typeof n.discard!="boolean")throw new TypeError("options.audio.discard, when provided, must be a boolean.");if(n?.forceTranscode!==void 0&&typeof n.forceTranscode!="boolean")throw new TypeError("options.audio.forceTranscode, when provided, must be a boolean.");if(n?.codec!==void 0&&!ae.includes(n.codec))throw new TypeError(`options.audio.codec, when provided, must be one of: ${ae.join(", ")}.`);if(n?.bitrate!==void 0&&!(n.bitrate instanceof oe)&&(!Number.isInteger(n.bitrate)||n.bitrate<=0))throw new TypeError("options.audio.bitrate, when provided, must be a positive integer or a quality.");if(n?.numberOfChannels!==void 0&&(!Number.isInteger(n.numberOfChannels)||n.numberOfChannels<=0))throw new TypeError("options.audio.numberOfChannels, when provided, must be a positive integer.");if(n?.sampleRate!==void 0&&(!Number.isInteger(n.sampleRate)||n.sampleRate<=0))throw new TypeError("options.audio.sampleRate, when provided, must be a positive integer.")},Ra=2,Da=48e3,Ba=class n{constructor(t){this._addedCounts={video:0,audio:0,subtitle:0};this._totalTrackCount=0;this._trackPromises=[];this._executed=!1;this._synchronizer=new Va;this._totalDuration=null;this._maxTimestamps=new Map;this._canceled=!1;this.onProgress=void 0;this._computeProgress=!1;this._lastProgress=0;this.utilizedTracks=[];this.discardedTracks=[];if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(!(t.input instanceof Kr))throw new TypeError("options.input must be an Input.");if(!(t.output instanceof sr))throw new TypeError("options.output must be an Output.");if(t.output._tracks.length>0||t.output.state!=="pending")throw new TypeError("options.output must be fresh: no tracks added and not started.");if(typeof t.video!="function"&&xo(t.video),typeof t.audio!="function"&&Co(t.audio),t.trim!==void 0&&(!t.trim||typeof t.trim!="object"))throw new TypeError("options.trim, when provided, must be an object.");if(t.trim?.start!==void 0&&(!Number.isFinite(t.trim.start)||t.trim.start<0))throw new TypeError("options.trim.start, when provided, must be a non-negative number.");if(t.trim?.end!==void 0&&(!Number.isFinite(t.trim.end)||t.trim.end<0))throw new TypeError("options.trim.end, when provided, must be a non-negative number.");if(t.trim?.start!==void 0&&t.trim.end!==void 0&&t.trim.start>=t.trim.end)throw new TypeError("options.trim.start must be less than options.trim.end.");if(t.tags!==void 0&&typeof t.tags!="function")throw new TypeError("options.tags, when provided, must be a function.");this._options=t,this.input=t.input,this.output=t.output,this._startTimestamp=t.trim?.start??0,this._endTimestamp=t.trim?.end??1/0;let{promise:e,resolve:r}=q();this._started=e,this._start=r}static async init(t){let e=new n(t);return await e._init(),e}async _init(){let t=await this.input.getTracks(),e=this.output.format.getSupportedTrackCounts(),r=1,i=1;for(let d of t){let l;if(d.isVideoTrack()?this._options.video&&(typeof this._options.video=="function"?(l=await this._options.video(d,r),xo(l),r++):l=this._options.video):d.isAudioTrack()?this._options.audio&&(typeof this._options.audio=="function"?(l=await this._options.audio(d,i),Co(l),i++):l=this._options.audio):p(!1),l?.discard){this.discardedTracks.push({track:d,reason:"discarded_by_user"});continue}if(this._totalTrackCount===e.total.max){this.discardedTracks.push({track:d,reason:"max_track_count_reached"});continue}if(this._addedCounts[d.type]===e[d.type].max){this.discardedTracks.push({track:d,reason:"max_track_count_of_type_reached"});continue}d.isVideoTrack()?await this._processVideoTrack(d,l??{}):d.isAudioTrack()&&await this._processAudioTrack(d,l??{})}let a=this.discardedTracks.filter(d=>d.reason!=="discarded_by_user");a.length>0&&console.warn("Some tracks had to be discarded from the conversion:",a);let o=await this.input.getMetadataTags(),s;if(this._options.tags){let d=await this._options.tags(o);tn(d),s=d}else s=o;let c=(await this.input.getFormat()).mimeType===this.output.format.mimeType,u=o.raw===s.raw;o.raw&&u&&!c&&delete s.raw,this.output.setMetadataTags(s)}async execute(){if(this._executed)throw new Error("Conversion cannot be executed twice.");if(this._executed=!0,this.onProgress){this._computeProgress=!0,this._totalDuration=Math.min(await this.input.computeDuration()-this._startTimestamp,this._endTimestamp-this._startTimestamp);for(let t of this.utilizedTracks)this._maxTimestamps.set(t.id,0);this.onProgress?.(0)}await this.output.start(),this._start();try{await Promise.all(this._trackPromises)}catch(t){throw this._canceled||this.cancel(),t}this._canceled&&await new Promise(()=>{}),await this.output.finalize(),this._computeProgress&&this.onProgress?.(1)}async cancel(){if(!(this.output.state==="finalizing"||this.output.state==="finalized")){if(this._canceled){console.warn("Conversion already canceled.");return}this._canceled=!0,await this.output.cancel()}}async _processVideoTrack(t,e){let r=t.codec;if(!r){this.discardedTracks.push({track:t,reason:"unknown_source_codec"});return}let i,a=ut(t.rotation+(e.rotate??0)),o=this.output.format.supportsVideoRotationMetadata,[s,c]=a%180===0?[t.codedWidth,t.codedHeight]:[t.codedHeight,t.codedWidth],u=e.crop;u&&_r(u,s,c);let[d,l]=u?[u.width,u.height]:[s,c],m=d,f=l,h=m/f,b=S=>Math.ceil(S/2)*2;e.width!==void 0&&e.height===void 0?(m=b(e.width),f=b(Math.round(m/h))):e.width===void 0&&e.height!==void 0?(f=b(e.height),m=b(Math.round(f*h))):e.width!==void 0&&e.height!==void 0&&(m=b(e.width),f=b(e.height));let g=await t.getFirstTimestamp(),w=!!e.forceTranscode||this._startTimestamp>0||g<0||!!e.frameRate,k=m!==d||f!==l||a!==0&&!o||!!u,T=this.output.format.getSupportedVideoCodecs();if(!w&&!e.bitrate&&!k&&T.includes(r)&&(!e.codec||e.codec===r)){let S=new Vr(r);i=S,this._trackPromises.push((async()=>{await this._started;let y=new je(t),F={decoderConfig:await t.getDecoderConfig()??void 0},_=Number.isFinite(this._endTimestamp)?await y.getPacket(this._endTimestamp,{metadataOnly:!0})??void 0:void 0;for await(let P of y.packets(void 0,_,{verifyKeyPackets:!0})){if(this._synchronizer.shouldWait(t.id,P.timestamp)&&await this._synchronizer.wait(P.timestamp),this._canceled)return;await S.add(P,F),this._reportProgress(t.id,P.timestamp+P.duration)}S.close(),this._synchronizer.closeTrack(t.id)})())}else{if(!await t.canDecode()){this.discardedTracks.push({track:t,reason:"undecodable_source_codec"});return}e.codec&&(T=T.filter(P=>P===e.codec));let y=e.bitrate??ai,x=await da(T,{width:m,height:f,bitrate:y});if(!x){this.discardedTracks.push({track:t,reason:"no_encodable_target_codec"});return}let F={codec:x,bitrate:y,sizeChangeBehavior:e.fit??"passThrough",onEncodedPacket:P=>this._reportProgress(t.id,P.timestamp+P.duration)},_=new nr(F);if(i=_,!k){let P=new sr({format:new tr,target:new Tr}),E=new nr(F);P.addVideoTrack(E),await P.start();let B=await new It(t).getSample(g);if(B)try{await E.add(B),B.close(),await P.finalize()}catch(G){console.info("Error when probing encoder support. Falling back to rerender path.",G),k=!0,P.cancel()}else await P.cancel()}k?this._trackPromises.push((async()=>{await this._started;let E=new Or(t,{width:m,height:f,fit:e.fit??"fill",rotation:a,crop:e.crop,poolSize:1}).canvases(this._startTimestamp,this._endTimestamp),I=e.frameRate,B=null,G=null,Ie=null,me=async we=>{p(B),p(I!==void 0);let pe=Math.round((we-G)*I);for(let At=1;At<pe;At++){let kt=new ke(B,{timestamp:G+At/I,duration:1/I});await _.add(kt)}};for await(let{canvas:we,timestamp:pe,duration:At}of E){if(this._synchronizer.shouldWait(t.id,pe)&&await this._synchronizer.wait(pe),this._canceled)return;let kt=Math.max(pe-this._startTimestamp,0);if(Ie=kt+At,I!==void 0){let jr=Math.floor(kt*I)/I;if(B!==null)if(jr<=G){B=we,G=jr;continue}else await me(jr);kt=jr}let Ua=new ke(we,{timestamp:kt,duration:I!==void 0?1/I:At});await _.add(Ua),I!==void 0?(B=we,G=kt):Ua.close()}B&&(p(Ie!==null),p(I!==void 0),await me(Math.floor(Ie*I)/I)),_.close(),this._synchronizer.closeTrack(t.id)})()):this._trackPromises.push((async()=>{await this._started;let P=new It(t),E=e.frameRate,I=null,B=null,G=null,Ie=async me=>{p(I),p(E!==void 0);let we=Math.round((me-B)*E);for(let pe=1;pe<we;pe++)I.setTimestamp(B+pe/E),I.setDuration(1/E),await _.add(I);I.close()};for await(let me of P.samples(this._startTimestamp,this._endTimestamp)){if(this._synchronizer.shouldWait(t.id,me.timestamp)&&await this._synchronizer.wait(me.timestamp),this._canceled){I?.close();return}let we=Math.max(me.timestamp-this._startTimestamp,0);if(G=we+me.duration,E!==void 0){let pe=Math.floor(we*E)/E;if(I!==null)if(pe<=B){I.close(),I=me,B=pe;continue}else await Ie(pe);we=pe,me.setDuration(1/E)}me.setTimestamp(we),await _.add(me),E!==void 0?(I=me,B=we):me.close()}I&&(p(G!==null),p(E!==void 0),await Ie(Math.floor(G*E)/E)),_.close(),this._synchronizer.closeTrack(t.id)})())}this.output.addVideoTrack(i,{frameRate:e.frameRate,languageCode:Xe(t.languageCode)?t.languageCode:void 0,name:t.name??void 0,rotation:k?0:a}),this._addedCounts.video++,this._totalTrackCount++,this.utilizedTracks.push(t)}async _processAudioTrack(t,e){let r=t.codec;if(!r){this.discardedTracks.push({track:t,reason:"unknown_source_codec"});return}let i,a=t.numberOfChannels,o=t.sampleRate,s=await t.getFirstTimestamp(),c=e.numberOfChannels??a,u=e.sampleRate??o,d=c!==a||u!==o||this._startTimestamp>0||s<0,l=this.output.format.getSupportedAudioCodecs();if(!e.forceTranscode&&!e.bitrate&&!d&&l.includes(r)&&(!e.codec||e.codec===r)){let m=new Ur(r);i=m,this._trackPromises.push((async()=>{await this._started;let f=new je(t),b={decoderConfig:await t.getDecoderConfig()??void 0},g=Number.isFinite(this._endTimestamp)?await f.getPacket(this._endTimestamp,{metadataOnly:!0})??void 0:void 0;for await(let w of f.packets(void 0,g)){if(this._synchronizer.shouldWait(t.id,w.timestamp)&&await this._synchronizer.wait(w.timestamp),this._canceled)return;await m.add(w,b),this._reportProgress(t.id,w.timestamp+w.duration)}m.close(),this._synchronizer.closeTrack(t.id)})())}else{if(!await t.canDecode()){this.discardedTracks.push({track:t,reason:"undecodable_source_codec"});return}let f=null;e.codec&&(l=l.filter(g=>g===e.codec));let h=e.bitrate??ai,b=await Br(l,{numberOfChannels:c,sampleRate:u,bitrate:h});if(!b.some(g=>Ze.includes(g))&&l.some(g=>Ze.includes(g))&&(c!==Ra||u!==Da)){let w=(await Br(l,{numberOfChannels:Ra,sampleRate:Da,bitrate:h})).find(k=>Ze.includes(k));w&&(d=!0,f=w,c=Ra,u=Da)}else f=b[0]??null;if(f===null){this.discardedTracks.push({track:t,reason:"no_encodable_target_codec"});return}if(d)i=this._resampleAudio(t,f,c,u,h);else{let g=new ir({codec:f,bitrate:h,onEncodedPacket:w=>this._reportProgress(t.id,w.timestamp+w.duration)});i=g,this._trackPromises.push((async()=>{await this._started;let w=new Et(t);for await(let k of w.samples(void 0,this._endTimestamp)){if(this._synchronizer.shouldWait(t.id,k.timestamp)&&await this._synchronizer.wait(k.timestamp),this._canceled)return;await g.add(k),k.close()}g.close(),this._synchronizer.closeTrack(t.id)})())}}this.output.addAudioTrack(i,{languageCode:Xe(t.languageCode)?t.languageCode:void 0,name:t.name??void 0}),this._addedCounts.audio++,this._totalTrackCount++,this.utilizedTracks.push(t)}_resampleAudio(t,e,r,i,a){let o=new ir({codec:e,bitrate:a,onEncodedPacket:s=>this._reportProgress(t.id,s.timestamp+s.duration)});return this._trackPromises.push((async()=>{await this._started;let s=new za({targetNumberOfChannels:r,targetSampleRate:i,startTime:this._startTimestamp,endTime:this._endTimestamp,onSample:d=>o.add(d)}),u=new Et(t).samples(this._startTimestamp,this._endTimestamp);for await(let d of u){if(this._synchronizer.shouldWait(t.id,d.timestamp)&&await this._synchronizer.wait(d.timestamp),this._canceled)return;await s.add(d)}await s.finalize(),o.close(),this._synchronizer.closeTrack(t.id)})()),o}_reportProgress(t,e){if(!this._computeProgress)return;p(this._totalDuration!==null),this._maxTimestamps.set(t,Math.max(e,this._maxTimestamps.get(t)));let r=Math.min(...this._maxTimestamps.values()),i=ee(r/this._totalDuration,0,1);i!==this._lastProgress&&(this._lastProgress=i,this.onProgress?.(i))}},Po=5,Va=class{constructor(){this.maxTimestamps=new Map;this.resolvers=[]}computeMinAndMaybeResolve(){let t=1/0;for(let[,e]of this.maxTimestamps)t=Math.min(t,e);for(let e=0;e<this.resolvers.length;e++){let r=this.resolvers[e];r.timestamp-t<Po&&(r.resolve(),this.resolvers.splice(e,1),e--)}return t}shouldWait(t,e){this.maxTimestamps.set(t,Math.max(e,this.maxTimestamps.get(t)??-1/0));let r=this.computeMinAndMaybeResolve();return e-r>=Po}wait(t){let{promise:e,resolve:r}=q();return this.resolvers.push({timestamp:t,resolve:r}),e}closeTrack(t){this.maxTimestamps.delete(t),this.computeMinAndMaybeResolve()}},za=class{constructor(t){this.sourceSampleRate=null;this.sourceNumberOfChannels=null;this.targetSampleRate=t.targetSampleRate,this.targetNumberOfChannels=t.targetNumberOfChannels,this.startTime=t.startTime,this.endTime=t.endTime,this.onSample=t.onSample,this.bufferSizeInFrames=Math.floor(this.targetSampleRate*5),this.bufferSizeInSamples=this.bufferSizeInFrames*this.targetNumberOfChannels,this.outputBuffer=new Float32Array(this.bufferSizeInSamples),this.bufferStartFrame=0,this.maxWrittenFrame=-1}doChannelMixerSetup(){p(this.sourceNumberOfChannels!==null);let t=this.sourceNumberOfChannels,e=this.targetNumberOfChannels;t===1&&e===2?this.channelMixer=(r,i)=>r[i*t]:t===1&&e===4?this.channelMixer=(r,i,a)=>r[i*t]*+(a<2):t===1&&e===6?this.channelMixer=(r,i,a)=>r[i*t]*+(a===2):t===2&&e===1?this.channelMixer=(r,i)=>{let a=i*t;return .5*(r[a]+r[a+1])}:t===2&&e===4?this.channelMixer=(r,i,a)=>r[i*t+a]*+(a<2):t===2&&e===6?this.channelMixer=(r,i,a)=>r[i*t+a]*+(a<2):t===4&&e===1?this.channelMixer=(r,i)=>{let a=i*t;return .25*(r[a]+r[a+1]+r[a+2]+r[a+3])}:t===4&&e===2?this.channelMixer=(r,i,a)=>{let o=i*t;return .5*(r[o+a]+r[o+a+2])}:t===4&&e===6?this.channelMixer=(r,i,a)=>{let o=i*t;return a<2?r[o+a]:a===2||a===3?0:r[o+a-2]}:t===6&&e===1?this.channelMixer=(r,i)=>{let a=i*t;return Math.SQRT1_2*(r[a]+r[a+1])+r[a+2]+.5*(r[a+4]+r[a+5])}:t===6&&e===2?this.channelMixer=(r,i,a)=>{let o=i*t;return r[o+a]+Math.SQRT1_2*(r[o+2]+r[o+a+4])}:t===6&&e===4?this.channelMixer=(r,i,a)=>{let o=i*t;return a<2?r[o+a]+Math.SQRT1_2*r[o+2]:r[o+a+2]}:this.channelMixer=(r,i,a)=>a<t?r[i*t+a]:0}ensureTempBufferSize(t){let e=this.tempSourceBuffer.length;for(;e<t;)e*=2;if(e!==this.tempSourceBuffer.length){let r=new Float32Array(e);r.set(this.tempSourceBuffer),this.tempSourceBuffer=r}}async add(t){this.sourceSampleRate===null&&(this.sourceSampleRate=t.sampleRate,this.sourceNumberOfChannels=t.numberOfChannels,this.tempSourceBuffer=new Float32Array(this.sourceSampleRate*this.sourceNumberOfChannels),this.doChannelMixerSetup());let e=t.numberOfFrames*t.numberOfChannels;this.ensureTempBufferSize(e);let r=t.allocationSize({planeIndex:0,format:"f32"}),i=new Float32Array(this.tempSourceBuffer.buffer,0,r/4);t.copyTo(i,{planeIndex:0,format:"f32"});let a=t.timestamp-this.startTime,o=t.numberOfFrames/this.sourceSampleRate,s=Math.min(a+o,this.endTime-this.startTime),c=Math.floor(a*this.targetSampleRate),u=Math.ceil(s*this.targetSampleRate);for(let d=c;d<u;d++){if(d<this.bufferStartFrame)continue;for(;d>=this.bufferStartFrame+this.bufferSizeInFrames;)await this.finalizeCurrentBuffer(),this.bufferStartFrame+=this.bufferSizeInFrames;let l=d-this.bufferStartFrame;p(l<this.bufferSizeInFrames);let h=(d/this.targetSampleRate-a)*this.sourceSampleRate,b=Math.floor(h),g=Math.ceil(h),w=h-b;for(let k=0;k<this.targetNumberOfChannels;k++){let T=0,S=0;b>=0&&b<t.numberOfFrames&&(T=this.channelMixer(i,b,k)),g>=0&&g<t.numberOfFrames&&(S=this.channelMixer(i,g,k));let y=T+w*(S-T),x=l*this.targetNumberOfChannels+k;this.outputBuffer[x]+=y}this.maxWrittenFrame=Math.max(this.maxWrittenFrame,l)}}async finalizeCurrentBuffer(){if(this.maxWrittenFrame<0)return;let t=(this.maxWrittenFrame+1)*this.targetNumberOfChannels,e=new Float32Array(t);e.set(this.outputBuffer.subarray(0,t));let r=this.bufferStartFrame/this.targetSampleRate,i=new Te({format:"f32",sampleRate:this.targetSampleRate,numberOfChannels:this.targetNumberOfChannels,timestamp:r,data:e});await this.onSample(i),this.outputBuffer.fill(0),this.maxWrittenFrame=-1}finalize(){return this.finalizeCurrentBuffer()}};export{So as ADTS,yu as ALL_FORMATS,so as ALL_TRACK_TYPES,ae as AUDIO_CODECS,xi as AdtsInputFormat,ua as AdtsOutputFormat,ia as AudioBufferSink,ha as AudioBufferSource,Te as AudioSample,Et as AudioSampleSink,ir as AudioSampleSource,ot as AudioSource,Mr as BaseMediaSampleSink,wa as BlobSource,Ta as BufferSource,kr as BufferTarget,Or as CanvasSink,fa as CanvasSource,Ba as Conversion,Qn as CustomAudioDecoder,Xn as CustomAudioEncoder,$n as CustomVideoDecoder,Gn as CustomVideoEncoder,Ur as EncodedAudioPacketSource,N as EncodedPacket,je as EncodedPacketSink,Vr as EncodedVideoPacketSource,Sa as FilePathSource,Kr as Input,ie as InputAudioTrack,Ve as InputFormat,_t as InputTrack,Re as InputVideoTrack,Hr as IsobmffInputFormat,Rr as IsobmffOutputFormat,bo as MATROSKA,To as MP3,ho as MP4,qr as MatroskaInputFormat,rr as MediaSource,ga as MediaStreamAudioTrackSource,pa as MediaStreamVideoTrackSource,Dr as MkvOutputFormat,zt as MovOutputFormat,wi as Mp3InputFormat,sa as Mp3OutputFormat,bi as Mp4InputFormat,tr as Mp4OutputFormat,Ze as NON_PCM_AUDIO_CODECS,Tr as NullTarget,yo as OGG,Si as OggInputFormat,ca as OggOutputFormat,sr as Output,De as OutputFormat,j as PCM_AUDIO_CODECS,go as QTFF,ai as QUALITY_HIGH,iu as QUALITY_LOW,au as QUALITY_MEDIUM,su as QUALITY_VERY_HIGH,nu as QUALITY_VERY_LOW,oe as Quality,ki as QuickTimeInputFormat,xa as ReadableStreamSource,Pe as RichImageData,ye as SUBTITLE_CODECS,Be as Source,ui as StreamSource,Hi as StreamTarget,ar as SubtitleSource,pt as Target,ba as TextSubtitleSource,ya as UrlSource,re as VIDEO_CODECS,ke as VideoSample,It as VideoSampleSink,nr as VideoSampleSource,st as VideoSource,wo as WAVE,ko as WEBM,oa as WavOutputFormat,yi as WaveInputFormat,Ti as WebMInputFormat,qt as WebMOutputFormat,ou as canEncode,oi as canEncodeAudio,ci as canEncodeSubtitles,si as canEncodeVideo,Br as getEncodableAudioCodecs,cu as getEncodableCodecs,ao as getEncodableSubtitleCodecs,io as getEncodableVideoCodecs,uu as getFirstEncodableAudioCodec,du as getFirstEncodableSubtitleCodec,da as getFirstEncodableVideoCodec,Jc as registerDecoder,eu as registerEncoder};
