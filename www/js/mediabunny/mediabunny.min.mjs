/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */
function m(n){if(!n)throw new Error("Assertion failed.")}var $e=n=>{let t=(n%360+360)%360;if(t===0||t===90||t===180||t===270)return t;throw new Error(`Invalid rotation ${n}.`)},L=n=>n&&n[n.length-1],it=n=>n>=0&&n<2**32,Q=class n{constructor(t){this.bytes=t;this.pos=0}seekToByte(t){this.pos=8*t}readBit(){let t=Math.floor(this.pos/8),e=this.bytes[t]??0,r=7-(this.pos&7),i=(e&1<<r)>>r;return this.pos++,i}readBits(t){if(t===1)return this.readBit();let e=0;for(let r=0;r<t;r++)e<<=1,e|=this.readBit();return e}writeBits(t,e){let r=this.pos+t;for(let i=this.pos;i<r;i++){let a=Math.floor(i/8),o=this.bytes[a],s=7-(i&7);o&=~(1<<s),o|=(e&1<<r-i-1)>>r-i-1<<s,this.bytes[a]=o}this.pos=r}readAlignedByte(){if(this.pos%8!==0)throw new Error("Bitstream is not byte-aligned.");let t=this.pos/8,e=this.bytes[t]??0;return this.pos+=8,e}skipBits(t){this.pos+=t}getBitsLeft(){return this.bytes.length*8-this.pos}clone(){let t=new n(this.bytes);return t.pos=this.pos,t}},A=n=>{let t=0;for(;n.readBits(1)===0&&t<32;)t++;if(t>=32)throw new Error("Invalid exponential-Golomb code.");return(1<<t)-1+n.readBits(t)},kt=n=>{let t=A(n);return(t&1)===0?-(t>>1):t+1>>1},ka=(n,t,e,r)=>{for(let i=t;i<e;i++){let a=Math.floor(i/8),o=n[a],s=7-(i&7);o&=~(1<<s),o|=(r&1<<e-i-1)>>e-i-1<<s,n[a]=o}},$=n=>n instanceof Uint8Array?n:n instanceof ArrayBuffer?new Uint8Array(n):new Uint8Array(n.buffer,n.byteOffset,n.byteLength),H=n=>n instanceof DataView?n:n instanceof ArrayBuffer?new DataView(n):new DataView(n.buffer,n.byteOffset,n.byteLength),_r=new TextDecoder,de=new TextEncoder,ai=n=>Object.fromEntries(Object.entries(n).map(([t,e])=>[e,t])),De={bt709:1,bt470bg:5,smpte170m:6,bt2020:9,smpte432:12},Ir=ai(De),ze={bt709:1,smpte170m:6,linear:8,"iec61966-2-1":13,pg:16,hlg:18},Ar=ai(ze),Ve={rgb:0,bt709:1,bt470bg:5,smpte170m:6,"bt2020-ncl":9},Fr=ai(Ve),Mr=n=>!!n&&!!n.primaries&&!!n.transfer&&!!n.matrix&&n.fullRange!==void 0,wt=n=>n instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&n instanceof SharedArrayBuffer||ArrayBuffer.isView(n),oe=class{constructor(){this.currentPromise=Promise.resolve()}async acquire(){let t,e=new Promise(i=>{t=i}),r=this.currentPromise;return this.currentPromise=e,await r,t}},si=n=>[...n].map(t=>t.toString(16).padStart(2,"0")).join(""),oi=n=>(n=n>>1&1431655765|(n&1431655765)<<1,n=n>>2&858993459|(n&858993459)<<2,n=n>>4&252645135|(n&252645135)<<4,n=n>>8&16711935|(n&16711935)<<8,n=n>>16&65535|(n&65535)<<16,n>>>0),G=(n,t,e)=>{let r=0,i=n.length-1,a=-1;for(;r<=i;){let o=r+i>>1,s=e(n[o]);s===t?(a=o,i=o-1):s<t?r=o+1:i=o-1}return a},z=(n,t,e)=>{let r=0,i=n.length-1,a=-1;for(;r<=i;){let o=r+(i-r+1)/2|0;e(n[o])<=t?(a=o,r=o+1):i=o-1}return a},Se=(n,t,e)=>{let r=z(n,e(t),e);n.splice(r+1,0,t)},q=()=>{let n,t;return{promise:new Promise((r,i)=>{n=r,t=i}),resolve:n,reject:t}};var ci=(n,t)=>{for(let e=n.length-1;e>=0;e--)if(t(n[e]))return n[e]},Or=(n,t)=>{for(let e=n.length-1;e>=0;e--)if(t(n[e]))return e;return-1},wa=async function*(n){Symbol.iterator in n?yield*n[Symbol.iterator]():yield*n[Symbol.asyncIterator]()},ya=n=>{if(!(Symbol.iterator in n)&&!(Symbol.asyncIterator in n))throw new TypeError("Argument must be an iterable or async iterable.")},xe=n=>{throw new Error(`Unexpected value: ${n}`)},ui=(n,t,e)=>{let r=n.getUint8(t),i=n.getUint8(t+1),a=n.getUint8(t+2);return e?r|i<<8|a<<16:r<<16|i<<8|a},Ta=(n,t,e)=>ui(n,t,e)<<8>>8,di=(n,t,e,r)=>{e=e>>>0,e=e&16777215,r?(n.setUint8(t,e&255),n.setUint8(t+1,e>>>8&255),n.setUint8(t+2,e>>>16&255)):(n.setUint8(t,e>>>16&255),n.setUint8(t+1,e>>>8&255),n.setUint8(t+2,e&255))},Sa=(n,t,e,r)=>{e=Y(e,-8388608,8388607),e<0&&(e=e+16777216&16777215),di(n,t,e,r)},xa=(n,t,e,r)=>{r?(n.setUint32(t+0,e,!0),n.setInt32(t+4,Math.floor(e/2**32),!0)):(n.setInt32(t+0,Math.floor(e/2**32),!0),n.setUint32(t+4,e,!0))},Qt=(n,t)=>({async next(){let e=await n.next();return e.done?{value:void 0,done:!0}:{value:t(e.value),done:!1}},return(){return n.return()},throw(e){return n.throw(e)},[Symbol.asyncIterator](){return this}}),Y=(n,t,e)=>Math.max(t,Math.min(e,n)),Z="und",at=(n,t)=>{let e=10**t;return Math.round(n*e)/e},$t=(n,t)=>Math.round(n/t)*t,Ca=n=>{let t=0;for(;n;)t++,n>>=1;return t},Ys=/^[a-z]{3}$/,Ue=n=>Ys.test(n),_e=1e6*(1+Number.EPSILON),Rr=(n,t)=>{let e={...n};for(let r in t)typeof n[r]=="object"&&n[r]!==null&&typeof t[r]=="object"&&t[r]!==null?e[r]=Rr(n[r],t[r]):e[r]=t[r];return e},li=async(n,t,e)=>{let r=0;for(;;)try{return await fetch(n,t)}catch(i){r++;let a=e(r);if(a===null)throw i;if(console.error("Retrying failed fetch. Error:",i),!Number.isFinite(a)||a<0)throw new TypeError("Retry delay must be a non-negative finite number.");a>0&&await new Promise(o=>setTimeout(o,1e3*a))}},Pa=(n,t)=>{let e=n<0?-1:1;n=Math.abs(n);let r=0,i=1,a=1,o=0,s=n;for(;;){let c=Math.floor(s),u=c*a+r,d=c*o+i;if(d>t)return{numerator:e*a,denominator:o};if(r=a,i=o,a=u,o=d,s=1/(s-c),!isFinite(s))break}return{numerator:e*a,denominator:o}},Qe=class{constructor(){this.currentPromise=Promise.resolve()}call(t){return this.currentPromise=this.currentPromise.then(t)}},ii=null,Br=()=>{if(ii!==null)return ii;let n=!!(typeof navigator<"u"&&navigator.vendor?.match(/apple/i)&&!navigator.userAgent?.match(/crios/i)&&!navigator.userAgent?.match(/fxios/i)&&!navigator.userAgent?.match(/Opera|OPT\//));return ii=n,n},Dr=(n,t,e,r)=>n<=r&&e<=t;var ee=["avc","hevc","vp9","av1","vp8"],K=["pcm-s16","pcm-s16be","pcm-s24","pcm-s24be","pcm-s32","pcm-s32be","pcm-f32","pcm-f32be","pcm-f64","pcm-f64be","pcm-u8","pcm-s8","ulaw","alaw"],Ne=["aac","opus","mp3","vorbis","flac"],ne=[...Ne,...K],ge=["webvtt"],va=[{maxMacroblocks:99,maxBitrate:64e3,level:10},{maxMacroblocks:396,maxBitrate:192e3,level:11},{maxMacroblocks:396,maxBitrate:384e3,level:12},{maxMacroblocks:396,maxBitrate:768e3,level:13},{maxMacroblocks:396,maxBitrate:2e6,level:20},{maxMacroblocks:792,maxBitrate:4e6,level:21},{maxMacroblocks:1620,maxBitrate:4e6,level:22},{maxMacroblocks:1620,maxBitrate:1e7,level:30},{maxMacroblocks:3600,maxBitrate:14e6,level:31},{maxMacroblocks:5120,maxBitrate:2e7,level:32},{maxMacroblocks:8192,maxBitrate:2e7,level:40},{maxMacroblocks:8192,maxBitrate:5e7,level:41},{maxMacroblocks:8704,maxBitrate:5e7,level:42},{maxMacroblocks:22080,maxBitrate:135e6,level:50},{maxMacroblocks:36864,maxBitrate:24e7,level:51},{maxMacroblocks:36864,maxBitrate:24e7,level:52},{maxMacroblocks:139264,maxBitrate:24e7,level:60},{maxMacroblocks:139264,maxBitrate:48e7,level:61},{maxMacroblocks:139264,maxBitrate:8e8,level:62}],Ea=[{maxPictureSize:36864,maxBitrate:128e3,tier:"L",level:30},{maxPictureSize:122880,maxBitrate:15e5,tier:"L",level:60},{maxPictureSize:245760,maxBitrate:3e6,tier:"L",level:63},{maxPictureSize:552960,maxBitrate:6e6,tier:"L",level:90},{maxPictureSize:983040,maxBitrate:1e7,tier:"L",level:93},{maxPictureSize:2228224,maxBitrate:12e6,tier:"L",level:120},{maxPictureSize:2228224,maxBitrate:3e7,tier:"H",level:120},{maxPictureSize:2228224,maxBitrate:2e7,tier:"L",level:123},{maxPictureSize:2228224,maxBitrate:5e7,tier:"H",level:123},{maxPictureSize:8912896,maxBitrate:25e6,tier:"L",level:150},{maxPictureSize:8912896,maxBitrate:1e8,tier:"H",level:150},{maxPictureSize:8912896,maxBitrate:4e7,tier:"L",level:153},{maxPictureSize:8912896,maxBitrate:16e7,tier:"H",level:153},{maxPictureSize:8912896,maxBitrate:6e7,tier:"L",level:156},{maxPictureSize:8912896,maxBitrate:24e7,tier:"H",level:156},{maxPictureSize:35651584,maxBitrate:6e7,tier:"L",level:180},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:180},{maxPictureSize:35651584,maxBitrate:12e7,tier:"L",level:183},{maxPictureSize:35651584,maxBitrate:48e7,tier:"H",level:183},{maxPictureSize:35651584,maxBitrate:24e7,tier:"L",level:186},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:186}],We=[{maxPictureSize:36864,maxBitrate:2e5,level:10},{maxPictureSize:73728,maxBitrate:8e5,level:11},{maxPictureSize:122880,maxBitrate:18e5,level:20},{maxPictureSize:245760,maxBitrate:36e5,level:21},{maxPictureSize:552960,maxBitrate:72e5,level:30},{maxPictureSize:983040,maxBitrate:12e6,level:31},{maxPictureSize:2228224,maxBitrate:18e6,level:40},{maxPictureSize:2228224,maxBitrate:3e7,level:41},{maxPictureSize:8912896,maxBitrate:6e7,level:50},{maxPictureSize:8912896,maxBitrate:12e7,level:51},{maxPictureSize:8912896,maxBitrate:18e7,level:52},{maxPictureSize:35651584,maxBitrate:18e7,level:60},{maxPictureSize:35651584,maxBitrate:24e7,level:61},{maxPictureSize:35651584,maxBitrate:48e7,level:62}],_a=[{maxPictureSize:147456,maxBitrate:15e5,tier:"M",level:0},{maxPictureSize:278784,maxBitrate:3e6,tier:"M",level:1},{maxPictureSize:665856,maxBitrate:6e6,tier:"M",level:4},{maxPictureSize:1065024,maxBitrate:1e7,tier:"M",level:5},{maxPictureSize:2359296,maxBitrate:12e6,tier:"M",level:8},{maxPictureSize:2359296,maxBitrate:3e7,tier:"H",level:8},{maxPictureSize:2359296,maxBitrate:2e7,tier:"M",level:9},{maxPictureSize:2359296,maxBitrate:5e7,tier:"H",level:9},{maxPictureSize:8912896,maxBitrate:3e7,tier:"M",level:12},{maxPictureSize:8912896,maxBitrate:1e8,tier:"H",level:12},{maxPictureSize:8912896,maxBitrate:4e7,tier:"M",level:13},{maxPictureSize:8912896,maxBitrate:16e7,tier:"H",level:13},{maxPictureSize:8912896,maxBitrate:6e7,tier:"M",level:14},{maxPictureSize:8912896,maxBitrate:24e7,tier:"H",level:14},{maxPictureSize:35651584,maxBitrate:6e7,tier:"M",level:15},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:15},{maxPictureSize:35651584,maxBitrate:6e7,tier:"M",level:16},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:16},{maxPictureSize:35651584,maxBitrate:1e8,tier:"M",level:17},{maxPictureSize:35651584,maxBitrate:48e7,tier:"H",level:17},{maxPictureSize:35651584,maxBitrate:16e7,tier:"M",level:18},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:18},{maxPictureSize:35651584,maxBitrate:16e7,tier:"M",level:19},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:19}],Ia=".01.01.01.01.00",Aa=".0.110.01.01.01.0",Fa=(n,t,e,r)=>{if(n==="avc"){let a=Math.ceil(t/16)*Math.ceil(e/16),o=va.find(l=>a<=l.maxMacroblocks&&r<=l.maxBitrate)??L(va),s=o?o.level:0,c="64".padStart(2,"0"),u="00",d=s.toString(16).padStart(2,"0");return`avc1.${c}${u}${d}`}else if(n==="hevc"){let i="",o="6",s=t*e,c=Ea.find(d=>s<=d.maxPictureSize&&r<=d.maxBitrate)??L(Ea);return`hev1.${i}1.${o}.${c.tier}${c.level}.B0`}else{if(n==="vp8")return"vp8";if(n==="vp9"){let i="00",a=t*e,o=We.find(c=>a<=c.maxPictureSize&&r<=c.maxBitrate)??L(We);return`vp09.${i}.${o.level.toString().padStart(2,"0")}.08`}else if(n==="av1"){let a=t*e,o=_a.find(u=>a<=u.maxPictureSize&&r<=u.maxBitrate)??L(_a);return`av01.0.${o.level.toString().padStart(2,"0")}${o.tier}.08`}}throw new TypeError(`Unhandled codec '${n}'.`)},Ma=n=>{let t=n.split("."),e=Number(t[1]),r=Number(t[2]),i=Number(t[3]),a=t[4]?Number(t[4]):1;return[1,1,e,2,1,r,3,1,i,4,1,a]},zr=n=>{let t=n.split("."),i=(1<<7)+1,a=Number(t[1]),o=t[2],s=Number(o.slice(0,-1)),c=(a<<5)+s,u=o.slice(-1)==="H"?1:0,l=Number(t[3])===8?0:1,f=0,p=t[4]?Number(t[4]):0,h=t[5]?Number(t[5][0]):1,b=t[5]?Number(t[5][1]):1,g=t[5]?Number(t[5][2]):0,T=(u<<7)+(l<<6)+(f<<5)+(p<<4)+(h<<3)+(b<<2)+g;return[i,c,T,0]},Vr=n=>{let{codec:t,codecDescription:e,colorSpace:r,avcCodecInfo:i,hevcCodecInfo:a,vp9CodecInfo:o,av1CodecInfo:s}=n;if(t==="avc"){if(i){let c=new Uint8Array([i.avcProfileIndication,i.profileCompatibility,i.avcLevelIndication]);return`avc1.${si(c)}`}if(!e||e.byteLength<4)throw new TypeError("AVC decoder description is not provided or is not at least 4 bytes long.");return`avc1.${si(e.subarray(1,4))}`}else if(t==="hevc"){let c,u,d,l,f,p;if(a)c=a.generalProfileSpace,u=a.generalProfileIdc,d=oi(a.generalProfileCompatibilityFlags),l=a.generalTierFlag,f=a.generalLevelIdc,p=[...a.generalConstraintIndicatorFlags];else{if(!e||e.byteLength<23)throw new TypeError("HEVC decoder description is not provided or is not at least 23 bytes long.");let b=H(e),g=b.getUint8(1);c=g>>6&3,u=g&31,d=oi(b.getUint32(2)),l=g>>5&1,f=b.getUint8(12),p=[];for(let T=0;T<6;T++)p.push(b.getUint8(6+T))}let h="hev1.";for(h+=["","A","B","C"][c]+u,h+=".",h+=d.toString(16).toUpperCase(),h+=".",h+=l===0?"L":"H",h+=f;p.length>0&&p[p.length-1]===0;)p.pop();return p.length>0&&(h+=".",h+=p.map(b=>b.toString(16).toUpperCase()).join(".")),h}else{if(t==="vp8")return"vp8";if(t==="vp9"){if(!o){let T=n.width*n.height,k=L(We).level;for(let y of We)if(T<=y.maxPictureSize){k=y.level;break}return`vp09.00.${k.toString().padStart(2,"0")}.08`}let c=o.profile.toString().padStart(2,"0"),u=o.level.toString().padStart(2,"0"),d=o.bitDepth.toString().padStart(2,"0"),l=o.chromaSubsampling.toString().padStart(2,"0"),f=o.colourPrimaries.toString().padStart(2,"0"),p=o.transferCharacteristics.toString().padStart(2,"0"),h=o.matrixCoefficients.toString().padStart(2,"0"),b=o.videoFullRangeFlag.toString().padStart(2,"0"),g=`vp09.${c}.${u}.${d}.${l}`;return g+=`.${f}.${p}.${h}.${b}`,g.endsWith(Ia)&&(g=g.slice(0,-Ia.length)),g}else if(t==="av1"){if(!s){let y=n.width*n.height,S=L(We).level;for(let w of We)if(y<=w.maxPictureSize){S=w.level;break}return`av01.0.${S.toString().padStart(2,"0")}M.08`}let c=s.profile,u=s.level.toString().padStart(2,"0"),d=s.tier?"H":"M",l=s.bitDepth.toString().padStart(2,"0"),f=s.monochrome?"1":"0",p=100*s.chromaSubsamplingX+10*s.chromaSubsamplingY+1*(s.chromaSubsamplingX&&s.chromaSubsamplingY?s.chromaSamplePosition:0),h=r?.primaries?De[r.primaries]:1,b=r?.transfer?ze[r.transfer]:1,g=r?.matrix?Ve[r.matrix]:1,T=r?.fullRange?1:0,k=`av01.${c}.${u}${d}.${l}`;return k+=`.${f}.${p.toString().padStart(3,"0")}`,k+=`.${h.toString().padStart(2,"0")}`,k+=`.${b.toString().padStart(2,"0")}`,k+=`.${g.toString().padStart(2,"0")}`,k+=`.${T}`,k.endsWith(Aa)&&(k=k.slice(0,-Aa.length)),k}}throw new TypeError(`Unhandled codec '${t}'.`)},Oa=(n,t,e)=>{if(n==="aac")return t>=2&&e<=24e3?"mp4a.40.29":e<=24e3?"mp4a.40.5":"mp4a.40.2";if(n==="mp3")return"mp3";if(n==="opus")return"opus";if(n==="vorbis")return"vorbis";if(n==="flac")return"flac";if(K.includes(n))return n;throw new TypeError(`Unhandled codec '${n}'.`)},Ur=n=>{let{codec:t,codecDescription:e,aacCodecInfo:r}=n;if(t==="aac"){if(!r)throw new TypeError("AAC codec info must be provided.");return r.isMpeg2?"mp4a.67":`mp4a.40.${Xt(e).objectType}`}else{if(t==="mp3")return"mp3";if(t==="opus")return"opus";if(t==="vorbis")return"vorbis";if(t==="flac")return"flac";if(t&&K.includes(t))return t}throw new TypeError(`Unhandled codec '${t}'.`)},Gt=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],mi=[-1,1,2,3,4,5,6,8],Xt=n=>{if(!n||n.byteLength<2)throw new TypeError("AAC description must be at least 2 bytes long.");let t=new Q(n),e=t.readBits(5);e===31&&(e=32+t.readBits(6));let r=t.readBits(4),i=null;r===15?i=t.readBits(24):r<Gt.length&&(i=Gt[r]);let a=t.readBits(4),o=null;return a>=1&&a<=7&&(o=mi[a]),{objectType:e,frequencyIndex:r,sampleRate:i,channelConfiguration:a,numberOfChannels:o}},yt=48e3,Ra=/^pcm-([usf])(\d+)+(be)?$/,ae=n=>{if(m(K.includes(n)),n==="ulaw")return{dataType:"ulaw",sampleSize:1,littleEndian:!0,silentValue:255};if(n==="alaw")return{dataType:"alaw",sampleSize:1,littleEndian:!0,silentValue:213};let t=Ra.exec(n);m(t);let e;t[1]==="u"?e="unsigned":t[1]==="s"?e="signed":e="float";let r=Number(t[2])/8,i=t[3]!=="be",a=n==="pcm-u8"?2**7:0;return{dataType:e,sampleSize:r,littleEndian:i,silentValue:a}},fi=n=>n.startsWith("avc1")||n.startsWith("avc3")?"avc":n.startsWith("hev1")||n.startsWith("hvc1")?"hevc":n==="vp8"?"vp8":n.startsWith("vp09")?"vp9":n.startsWith("av01")?"av1":n.startsWith("mp4a.40")||n==="mp4a.67"?"aac":n==="mp3"||n==="mp4a.69"||n==="mp4a.6B"||n==="mp4a.6b"?"mp3":n==="opus"?"opus":n==="vorbis"?"vorbis":n==="flac"?"flac":n==="ulaw"?"ulaw":n==="alaw"?"alaw":Ra.test(n)?n:n==="webvtt"?"webvtt":null,Ba=n=>n==="avc"?{avc:{format:"avc"}}:n==="hevc"?{hevc:{format:"hevc"}}:{},Da=n=>n==="aac"?{aac:{format:"aac"}}:n==="opus"?{opus:{format:"opus"}}:{},Zs=["avc1","avc3","hev1","hvc1","vp8","vp09","av01"],Js=/^(avc1|avc3)\.[0-9a-fA-F]{6}$/,eo=/^(hev1|hvc1)\.(?:[ABC]?\d+)\.[0-9a-fA-F]{1,8}\.[LH]\d+(?:\.[0-9a-fA-F]{1,2}){0,6}$/,to=/^vp09(?:\.\d{2}){3}(?:(?:\.\d{2}){5})?$/,ro=/^av01\.\d\.\d{2}[MH]\.\d{2}(?:\.\d\.\d{3}\.\d{2}\.\d{2}\.\d{2}\.\d)?$/,Wr=n=>{if(!n)throw new TypeError("Video chunk metadata must be provided.");if(typeof n!="object")throw new TypeError("Video chunk metadata must be an object.");if(!n.decoderConfig)throw new TypeError("Video chunk metadata must include a decoder configuration.");if(typeof n.decoderConfig!="object")throw new TypeError("Video chunk metadata decoder configuration must be an object.");if(typeof n.decoderConfig.codec!="string")throw new TypeError("Video chunk metadata decoder configuration must specify a codec string.");if(!Zs.some(t=>n.decoderConfig.codec.startsWith(t)))throw new TypeError("Video chunk metadata decoder configuration codec string must be a valid video codec string as specified in the WebCodecs Codec Registry.");if(!Number.isInteger(n.decoderConfig.codedWidth)||n.decoderConfig.codedWidth<=0)throw new TypeError("Video chunk metadata decoder configuration must specify a valid codedWidth (positive integer).");if(!Number.isInteger(n.decoderConfig.codedHeight)||n.decoderConfig.codedHeight<=0)throw new TypeError("Video chunk metadata decoder configuration must specify a valid codedHeight (positive integer).");if(n.decoderConfig.description!==void 0&&!wt(n.decoderConfig.description))throw new TypeError("Video chunk metadata decoder configuration description, when defined, must be an ArrayBuffer or an ArrayBuffer view.");if(n.decoderConfig.colorSpace!==void 0){let{colorSpace:t}=n.decoderConfig;if(typeof t!="object")throw new TypeError("Video chunk metadata decoder configuration colorSpace, when provided, must be an object.");let e=Object.keys(De);if(t.primaries!=null&&!e.includes(t.primaries))throw new TypeError(`Video chunk metadata decoder configuration colorSpace primaries, when defined, must be one of ${e.join(", ")}.`);let r=Object.keys(ze);if(t.transfer!=null&&!r.includes(t.transfer))throw new TypeError(`Video chunk metadata decoder configuration colorSpace transfer, when defined, must be one of ${r.join(", ")}.`);let i=Object.keys(Ve);if(t.matrix!=null&&!i.includes(t.matrix))throw new TypeError(`Video chunk metadata decoder configuration colorSpace matrix, when defined, must be one of ${i.join(", ")}.`);if(t.fullRange!=null&&typeof t.fullRange!="boolean")throw new TypeError("Video chunk metadata decoder configuration colorSpace fullRange, when defined, must be a boolean.")}if(n.decoderConfig.codec.startsWith("avc1")||n.decoderConfig.codec.startsWith("avc3")){if(!Js.test(n.decoderConfig.codec))throw new TypeError("Video chunk metadata decoder configuration codec string for AVC must be a valid AVC codec string as specified in Section 3.4 of RFC 6381.")}else if(n.decoderConfig.codec.startsWith("hev1")||n.decoderConfig.codec.startsWith("hvc1")){if(!eo.test(n.decoderConfig.codec))throw new TypeError("Video chunk metadata decoder configuration codec string for HEVC must be a valid HEVC codec string as specified in Section E.3 of ISO 14496-15.")}else if(n.decoderConfig.codec.startsWith("vp8")){if(n.decoderConfig.codec!=="vp8")throw new TypeError('Video chunk metadata decoder configuration codec string for VP8 must be "vp8".')}else if(n.decoderConfig.codec.startsWith("vp09")){if(!to.test(n.decoderConfig.codec))throw new TypeError('Video chunk metadata decoder configuration codec string for VP9 must be a valid VP9 codec string as specified in Section "Codecs Parameter String" of https://www.webmproject.org/vp9/mp4/.')}else if(n.decoderConfig.codec.startsWith("av01")&&!ro.test(n.decoderConfig.codec))throw new TypeError('Video chunk metadata decoder configuration codec string for AV1 must be a valid AV1 codec string as specified in Section "Codecs Parameter String" of https://aomediacodec.github.io/av1-isobmff/.')},no=["mp4a","mp3","opus","vorbis","flac","ulaw","alaw","pcm"],Ie=n=>{if(!n)throw new TypeError("Audio chunk metadata must be provided.");if(typeof n!="object")throw new TypeError("Audio chunk metadata must be an object.");if(!n.decoderConfig)throw new TypeError("Audio chunk metadata must include a decoder configuration.");if(typeof n.decoderConfig!="object")throw new TypeError("Audio chunk metadata decoder configuration must be an object.");if(typeof n.decoderConfig.codec!="string")throw new TypeError("Audio chunk metadata decoder configuration must specify a codec string.");if(!no.some(t=>n.decoderConfig.codec.startsWith(t)))throw new TypeError("Audio chunk metadata decoder configuration codec string must be a valid audio codec string as specified in the WebCodecs Codec Registry.");if(!Number.isInteger(n.decoderConfig.sampleRate)||n.decoderConfig.sampleRate<=0)throw new TypeError("Audio chunk metadata decoder configuration must specify a valid sampleRate (positive integer).");if(!Number.isInteger(n.decoderConfig.numberOfChannels)||n.decoderConfig.numberOfChannels<=0)throw new TypeError("Audio chunk metadata decoder configuration must specify a valid numberOfChannels (positive integer).");if(n.decoderConfig.description!==void 0&&!wt(n.decoderConfig.description))throw new TypeError("Audio chunk metadata decoder configuration description, when defined, must be an ArrayBuffer or an ArrayBuffer view.");if(n.decoderConfig.codec.startsWith("mp4a")&&n.decoderConfig.codec!=="mp4a.69"&&n.decoderConfig.codec!=="mp4a.6B"&&n.decoderConfig.codec!=="mp4a.6b"){if(!["mp4a.40.2","mp4a.40.02","mp4a.40.5","mp4a.40.05","mp4a.40.29","mp4a.67"].includes(n.decoderConfig.codec))throw new TypeError("Audio chunk metadata decoder configuration codec string for AAC must be a valid AAC codec string as specified in https://www.w3.org/TR/webcodecs-aac-codec-registration/.");if(!n.decoderConfig.description)throw new TypeError("Audio chunk metadata decoder configuration for AAC must include a description, which is expected to be an AudioSpecificConfig as specified in ISO 14496-3.")}else if(n.decoderConfig.codec.startsWith("mp3")||n.decoderConfig.codec.startsWith("mp4a")){if(n.decoderConfig.codec!=="mp3"&&n.decoderConfig.codec!=="mp4a.69"&&n.decoderConfig.codec!=="mp4a.6B"&&n.decoderConfig.codec!=="mp4a.6b")throw new TypeError('Audio chunk metadata decoder configuration codec string for MP3 must be "mp3", "mp4a.69" or "mp4a.6B".')}else if(n.decoderConfig.codec.startsWith("opus")){if(n.decoderConfig.codec!=="opus")throw new TypeError('Audio chunk metadata decoder configuration codec string for Opus must be "opus".');if(n.decoderConfig.description&&n.decoderConfig.description.byteLength<18)throw new TypeError("Audio chunk metadata decoder configuration description, when specified, is expected to be an Identification Header as specified in Section 5.1 of RFC 7845.")}else if(n.decoderConfig.codec.startsWith("vorbis")){if(n.decoderConfig.codec!=="vorbis")throw new TypeError('Audio chunk metadata decoder configuration codec string for Vorbis must be "vorbis".');if(!n.decoderConfig.description)throw new TypeError("Audio chunk metadata decoder configuration for Vorbis must include a description, which is expected to adhere to the format described in https://www.w3.org/TR/webcodecs-vorbis-codec-registration/.")}else if(n.decoderConfig.codec.startsWith("flac")){if(n.decoderConfig.codec!=="flac")throw new TypeError('Audio chunk metadata decoder configuration codec string for FLAC must be "flac".');if(!n.decoderConfig.description||n.decoderConfig.description.byteLength<42)throw new TypeError("Audio chunk metadata decoder configuration for FLAC must include a description, which is expected to adhere to the format described in https://www.w3.org/TR/webcodecs-flac-codec-registration/.")}else if((n.decoderConfig.codec.startsWith("pcm")||n.decoderConfig.codec.startsWith("ulaw")||n.decoderConfig.codec.startsWith("alaw"))&&!K.includes(n.decoderConfig.codec))throw new TypeError(`Audio chunk metadata decoder configuration codec string for PCM must be one of the supported PCM codecs (${K.join(", ")}).`)},Nr=n=>{if(!n)throw new TypeError("Subtitle metadata must be provided.");if(typeof n!="object")throw new TypeError("Subtitle metadata must be an object.");if(!n.config)throw new TypeError("Subtitle metadata must include a config object.");if(typeof n.config!="object")throw new TypeError("Subtitle metadata config must be an object.");if(typeof n.config.description!="string")throw new TypeError("Subtitle metadata config description must be a string.")};var le=class{constructor(t){this.mutex=new oe;this.firstMediaStreamTimestamp=null;this.trackTimestampInfo=new WeakMap;this.output=t}onTrackClose(t){}validateAndNormalizeTimestamp(t,e,r){e+=t.source._timestampOffset;let i=this.trackTimestampInfo.get(t);if(!i){if(!r)throw new Error("First frame must be a key frame.");i={maxTimestamp:e,maxTimestampBeforeLastKeyFrame:e},this.trackTimestampInfo.set(t,i)}if(e<0)throw new Error(`Timestamps must be non-negative (got ${e}s).`);if(r&&(i.maxTimestampBeforeLastKeyFrame=i.maxTimestamp),e<i.maxTimestampBeforeLastKeyFrame)throw new Error(`Timestamps cannot be smaller than the highest timestamp of the previous run (a run begins with a key frame and ends right before the next key frame). Got ${e}s, but highest timestamp is ${i.maxTimestampBeforeLastKeyFrame}s.`);return i.maxTimestamp=Math.max(i.maxTimestamp,e),e}};var Lr=class extends le{constructor(e,r){super(e);this.header=new Uint8Array(7);this.headerBitstream=new Q(this.header);this.audioSpecificConfig=null;this.format=r,this.writer=e._writer}async start(){}async getMimeType(){return"audio/aac"}async addEncodedVideoPacket(){throw new Error("ADTS does not support video.")}async addEncodedAudioPacket(e,r,i){let a=await this.mutex.acquire();try{if(this.validateAndNormalizeTimestamp(e,r.timestamp,r.type==="key"),!this.audioSpecificConfig){Ie(i);let c=i?.decoderConfig?.description;m(c),this.audioSpecificConfig=Xt($(c));let{objectType:u,frequencyIndex:d,channelConfiguration:l}=this.audioSpecificConfig,f=u-1;this.headerBitstream.writeBits(12,4095),this.headerBitstream.writeBits(1,0),this.headerBitstream.writeBits(2,0),this.headerBitstream.writeBits(1,1),this.headerBitstream.writeBits(2,f),this.headerBitstream.writeBits(4,d),this.headerBitstream.writeBits(1,0),this.headerBitstream.writeBits(3,l),this.headerBitstream.writeBits(1,0),this.headerBitstream.writeBits(1,0),this.headerBitstream.writeBits(1,0),this.headerBitstream.writeBits(1,0),this.headerBitstream.skipBits(13),this.headerBitstream.writeBits(11,2047),this.headerBitstream.writeBits(2,0)}let o=r.data.byteLength+this.header.byteLength;this.headerBitstream.pos=30,this.headerBitstream.writeBits(13,o);let s=this.writer.getPos();if(this.writer.write(this.header),this.writer.write(r.data),this.format._options.onFrame){let c=new Uint8Array(o);c.set(this.header,0),c.set(r.data,this.header.byteLength),this.format._options.onFrame(c,s)}await this.writer.flush()}finally{a()}}async addSubtitleCue(){throw new Error("ADTS does not support subtitles.")}async finalize(){}};var Yt=/(?:(.+?)\n)?((?:\d{2}:)?\d{2}:\d{2}.\d{3})\s+-->\s+((?:\d{2}:)?\d{2}:\d{2}.\d{3})/g,io=/^WEBVTT(.|\n)*?\n{2}/,Tt=/<(?:(\d{2}):)?(\d{2}):(\d{2}).(\d{3})>/g,Hr=class{constructor(t){this.preambleText=null;this.preambleEmitted=!1;this.options=t}parse(t){t=t.replaceAll(`\r
`,`
`).replaceAll("\r",`
`),Yt.lastIndex=0;let e;if(!this.preambleText){if(!io.test(t))throw new Error("WebVTT preamble incorrect.");e=Yt.exec(t);let r=t.slice(0,e?.index??t.length).trimEnd();if(!r)throw new Error("No WebVTT preamble provided.");this.preambleText=r,e&&(t=t.slice(e.index),Yt.lastIndex=0)}for(;e=Yt.exec(t);){let r=t.slice(0,e.index),i=e[1],a=e.index+e[0].length,o=t.indexOf(`
`,a)+1,s=t.slice(a,o).trim(),c=t.indexOf(`

`,a);c===-1&&(c=t.length);let u=qr(e[2]),l=qr(e[3])-u,f=t.slice(o,c).trim();t=t.slice(c).trimStart(),Yt.lastIndex=0;let p={timestamp:u/1e3,duration:l/1e3,text:f,identifier:i,settings:s,notes:r},h={};this.preambleEmitted||(h.config={description:this.preambleText},this.preambleEmitted=!0),this.options.output(p,h)}}},ao=/(?:(\d{2}):)?(\d{2}):(\d{2}).(\d{3})/,qr=n=>{let t=ao.exec(n);if(!t)throw new Error("Expected match.");return 60*60*1e3*Number(t[1]||"0")+60*1e3*Number(t[2])+1e3*Number(t[3])+Number(t[4])},Kr=n=>{let t=Math.floor(n/36e5),e=Math.floor(n%(60*60*1e3)/(60*1e3)),r=Math.floor(n%(60*1e3)/1e3),i=n%1e3;return t.toString().padStart(2,"0")+":"+e.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")+"."+i.toString().padStart(3,"0")};var Zt=n=>{let t=[],e=0;for(;e<n.length;){let r=-1,i=0;for(let a=e;a<n.length-3;a++){if(n[a]===0&&n[a+1]===0&&n[a+2]===1){r=a,i=3;break}if(a<n.length-4&&n[a]===0&&n[a+1]===0&&n[a+2]===0&&n[a+3]===1){r=a,i=4;break}}if(r===-1)break;if(e>0&&r>e){let a=n.subarray(e,r);a.length>0&&t.push(a)}e=r+i}if(e<n.length){let r=n.subarray(e);r.length>0&&t.push(r)}return t},za=(n,t)=>{let e=[],r=0,i=new DataView(n.buffer,n.byteOffset,n.byteLength);for(;r+t<=n.length;){let a;t===1?a=i.getUint8(r):t===2?a=i.getUint16(r,!1):t===3?a=(i.getUint16(r,!1)<<8)+i.getUint8(r+2):t===4?a=i.getUint32(r,!1):(xe(t),m(!1)),r+=t;let o=n.subarray(r,r+a);e.push(o),r+=a}return e},pi=n=>{let t=[],e=n.length;for(let r=0;r<e;r++)r+2<e&&n[r]===0&&n[r+1]===0&&n[r+2]===3?(t.push(0,0),r+=2):t.push(n[r]);return new Uint8Array(t)},La=n=>{let e=Zt(n);if(e.length===0)return null;let r=0;for(let s of e)r+=4+s.byteLength;let i=new Uint8Array(r),a=new DataView(i.buffer),o=0;for(let s of e){let c=s.byteLength;a.setUint32(o,c,!1),o+=4,i.set(s,o),o+=s.byteLength}return i},jr=n=>n[0]&31,Qr=n=>{try{let t=Zt(n),e=t.filter(f=>jr(f)===7),r=t.filter(f=>jr(f)===8),i=t.filter(f=>jr(f)===13);if(e.length===0||r.length===0)return null;let a=e[0],o=new Q(pi(a));if(o.skipBits(1),o.skipBits(2),o.readBits(5)!==7)return console.error("Invalid SPS NAL unit type"),null;let c=o.readAlignedByte(),u=o.readAlignedByte(),d=o.readAlignedByte(),l={configurationVersion:1,avcProfileIndication:c,profileCompatibility:u,avcLevelIndication:d,lengthSizeMinusOne:3,sequenceParameterSets:e,pictureParameterSets:r,chromaFormat:null,bitDepthLumaMinus8:null,bitDepthChromaMinus8:null,sequenceParameterSetExt:null};if(c===100||c===110||c===122||c===144){A(o);let f=A(o);f===3&&o.skipBits(1);let p=A(o),h=A(o);l.chromaFormat=f,l.bitDepthLumaMinus8=p,l.bitDepthChromaMinus8=h,l.sequenceParameterSetExt=i}return l}catch(t){return console.error("Error building AVC Decoder Configuration Record:",t),null}},Ha=n=>{let t=[];t.push(n.configurationVersion),t.push(n.avcProfileIndication),t.push(n.profileCompatibility),t.push(n.avcLevelIndication),t.push(252|n.lengthSizeMinusOne&3),t.push(224|n.sequenceParameterSets.length&31);for(let e of n.sequenceParameterSets){let r=e.byteLength;t.push(r>>8),t.push(r&255);for(let i=0;i<r;i++)t.push(e[i])}t.push(n.pictureParameterSets.length);for(let e of n.pictureParameterSets){let r=e.byteLength;t.push(r>>8),t.push(r&255);for(let i=0;i<r;i++)t.push(e[i])}if(n.avcProfileIndication===100||n.avcProfileIndication===110||n.avcProfileIndication===122||n.avcProfileIndication===144){m(n.chromaFormat!==null),m(n.bitDepthLumaMinus8!==null),m(n.bitDepthChromaMinus8!==null),m(n.sequenceParameterSetExt!==null),t.push(252|n.chromaFormat&3),t.push(248|n.bitDepthLumaMinus8&7),t.push(248|n.bitDepthChromaMinus8&7),t.push(n.sequenceParameterSetExt.length);for(let e of n.sequenceParameterSetExt){let r=e.byteLength;t.push(r>>8),t.push(r&255);for(let i=0;i<r;i++)t.push(e[i])}}return new Uint8Array(t)},Va=32,Ua=33,Wa=34,so=39,oo=40,st=n=>n[0]>>1&63,$r=n=>{try{let t=Zt(n),e=t.filter(I=>st(I)===Va),r=t.filter(I=>st(I)===Ua),i=t.filter(I=>st(I)===Wa),a=t.filter(I=>st(I)===so||st(I)===oo);if(r.length===0||i.length===0)return null;let o=r[0],s=new Q(pi(o));s.skipBits(16),s.readBits(4);let c=s.readBits(3),u=s.readBits(1),{general_profile_space:d,general_tier_flag:l,general_profile_idc:f,general_profile_compatibility_flags:p,general_constraint_indicator_flags:h,general_level_idc:b}=co(s,c);A(s);let g=A(s);g===3&&s.skipBits(1),A(s),A(s),s.readBits(1)&&(A(s),A(s),A(s),A(s));let T=A(s),k=A(s);A(s);let S=s.readBits(1)?0:c;for(let I=S;I<=c;I++)A(s),A(s),A(s);A(s),A(s),A(s),A(s),A(s),A(s),s.readBits(1)&&s.readBits(1)&&uo(s),s.skipBits(1),s.skipBits(1),s.readBits(1)&&(s.skipBits(4),s.skipBits(4),A(s),A(s),s.skipBits(1));let w=A(s);if(lo(s,w),s.readBits(1)){let I=A(s);for(let F=0;F<I;F++)A(s),s.skipBits(1)}s.skipBits(1),s.skipBits(1);let x=0;s.readBits(1)&&(x=fo(s,c));let _=0;if(i.length>0){let I=i[0],F=new Q(pi(I));F.skipBits(16),A(F),A(F),F.skipBits(1),F.skipBits(1),F.skipBits(3),F.skipBits(1),F.skipBits(1),A(F),A(F),kt(F),F.skipBits(1),F.skipBits(1),F.readBits(1)&&A(F),kt(F),kt(F),F.skipBits(1),F.skipBits(1),F.skipBits(1),F.skipBits(1);let B=F.readBits(1),j=F.readBits(1);!B&&!j?_=0:B&&!j?_=2:!B&&j?_=3:_=0}let C=[...e.length?[{arrayCompleteness:1,nalUnitType:Va,nalUnits:e}]:[],...r.length?[{arrayCompleteness:1,nalUnitType:Ua,nalUnits:r}]:[],...i.length?[{arrayCompleteness:1,nalUnitType:Wa,nalUnits:i}]:[],...a.length?[{arrayCompleteness:1,nalUnitType:st(a[0]),nalUnits:a}]:[]];return{configurationVersion:1,generalProfileSpace:d,generalTierFlag:l,generalProfileIdc:f,generalProfileCompatibilityFlags:p,generalConstraintIndicatorFlags:h,generalLevelIdc:b,minSpatialSegmentationIdc:x,parallelismType:_,chromaFormatIdc:g,bitDepthLumaMinus8:T,bitDepthChromaMinus8:k,avgFrameRate:0,constantFrameRate:0,numTemporalLayers:c+1,temporalIdNested:u,lengthSizeMinusOne:3,arrays:C}}catch(t){return console.error("Error building HEVC Decoder Configuration Record:",t),null}},co=(n,t)=>{let e=n.readBits(2),r=n.readBits(1),i=n.readBits(5),a=0;for(let d=0;d<32;d++)a=a<<1|n.readBits(1);let o=new Uint8Array(6);for(let d=0;d<6;d++)o[d]=n.readBits(8);let s=n.readBits(8),c=[],u=[];for(let d=0;d<t;d++)c.push(n.readBits(1)),u.push(n.readBits(1));if(t>0)for(let d=t;d<8;d++)n.skipBits(2);for(let d=0;d<t;d++)c[d]&&n.skipBits(88),u[d]&&n.skipBits(8);return{general_profile_space:e,general_tier_flag:r,general_profile_idc:i,general_profile_compatibility_flags:a,general_constraint_indicator_flags:o,general_level_idc:s}},uo=n=>{for(let t=0;t<4;t++)for(let e=0;e<(t===3?2:6);e++)if(!n.readBits(1))A(n);else{let i=Math.min(64,1<<4+(t<<1));t>1&&kt(n);for(let a=0;a<i;a++)kt(n)}},lo=(n,t)=>{let e=[];for(let r=0;r<t;r++)e[r]=mo(n,r,t,e)},mo=(n,t,e,r)=>{let i=0,a=0,o=0;if(t!==0&&(a=n.readBits(1)),a){if(t===e){let c=A(n);o=t-(c+1)}else o=t-1;n.readBits(1),A(n);let s=r[o]??0;for(let c=0;c<=s;c++)n.readBits(1)||n.readBits(1);i=r[o]}else{let s=A(n),c=A(n);for(let u=0;u<s;u++)A(n),n.readBits(1);for(let u=0;u<c;u++)A(n),n.readBits(1);i=s+c}return i},fo=(n,t)=>{if(n.readBits(1)&&n.readBits(8)===255&&(n.readBits(16),n.readBits(16)),n.readBits(1)&&n.readBits(1),n.readBits(1)&&(n.readBits(3),n.readBits(1),n.readBits(1)&&(n.readBits(8),n.readBits(8),n.readBits(8))),n.readBits(1)&&(A(n),A(n)),n.readBits(1),n.readBits(1),n.readBits(1),n.readBits(1)&&(A(n),A(n),A(n),A(n)),n.readBits(1)&&(n.readBits(32),n.readBits(32),n.readBits(1)&&A(n),n.readBits(1)&&po(n,!0,t)),n.readBits(1)){n.readBits(1),n.readBits(1),n.readBits(1);let e=A(n);return A(n),A(n),A(n),A(n),e}return 0},po=(n,t,e)=>{let r=!1,i=!1,a=!1;t&&(r=n.readBits(1)===1,i=n.readBits(1)===1,(r||i)&&(a=n.readBits(1)===1,a&&(n.readBits(8),n.readBits(5),n.readBits(1),n.readBits(5)),n.readBits(4),n.readBits(4),a&&n.readBits(4),n.readBits(5),n.readBits(5),n.readBits(5)));for(let o=0;o<=e;o++){let s=n.readBits(1)===1,c=!0;s||(c=n.readBits(1)===1);let u=!1;c?A(n):u=n.readBits(1)===1;let d=1;u||(d=A(n)+1),r&&Na(n,d,a),i&&Na(n,d,a)}},Na=(n,t,e)=>{for(let r=0;r<t;r++)A(n),A(n),e&&(A(n),A(n)),n.readBits(1)},qa=n=>{let t=[];t.push(n.configurationVersion),t.push((n.generalProfileSpace&3)<<6|(n.generalTierFlag&1)<<5|n.generalProfileIdc&31),t.push(n.generalProfileCompatibilityFlags>>>24&255),t.push(n.generalProfileCompatibilityFlags>>>16&255),t.push(n.generalProfileCompatibilityFlags>>>8&255),t.push(n.generalProfileCompatibilityFlags&255),t.push(...n.generalConstraintIndicatorFlags),t.push(n.generalLevelIdc&255),t.push(240|n.minSpatialSegmentationIdc>>8&15),t.push(n.minSpatialSegmentationIdc&255),t.push(252|n.parallelismType&3),t.push(252|n.chromaFormatIdc&3),t.push(248|n.bitDepthLumaMinus8&7),t.push(248|n.bitDepthChromaMinus8&7),t.push(n.avgFrameRate>>8&255),t.push(n.avgFrameRate&255),t.push((n.constantFrameRate&3)<<6|(n.numTemporalLayers&7)<<3|(n.temporalIdNested&1)<<2|n.lengthSizeMinusOne&3),t.push(n.arrays.length&255);for(let e of n.arrays){t.push((e.arrayCompleteness&1)<<7|0|e.nalUnitType&63),t.push(e.nalUnits.length>>8&255),t.push(e.nalUnits.length&255);for(let r of e.nalUnits){t.push(r.length>>8&255),t.push(r.length&255);for(let i=0;i<r.length;i++)t.push(r[i])}}return new Uint8Array(t)},Gr=n=>{let t=new Q(n);if(t.readBits(2)!==2)return null;let r=t.readBits(1),a=(t.readBits(1)<<1)+r;if(a===3&&t.skipBits(1),t.readBits(1)===1||t.readBits(1)!==0||(t.skipBits(2),t.readBits(24)!==4817730))return null;let u=8;a>=2&&(u=t.readBits(1)?12:10);let d=t.readBits(3),l=0,f=0;if(d!==7)if(f=t.readBits(1),a===1||a===3){let _=t.readBits(1),C=t.readBits(1);l=!_&&!C?3:_&&!C?2:1,t.skipBits(1)}else l=1;else l=3,f=1;let p=t.readBits(16),h=t.readBits(16),b=p+1,g=h+1,T=b*g,k=L(We).level;for(let x of We)if(T<=x.maxPictureSize){k=x.level;break}return{profile:a,level:k,bitDepth:u,chromaSubsampling:l,videoFullRangeFlag:f,colourPrimaries:d===2?1:d===1?6:2,transferCharacteristics:d===2?1:d===1?6:2,matrixCoefficients:d===7?0:d===2?1:d===1?6:2}},Ka=function*(n){let t=new Q(n),e=()=>{let r=0;for(let i=0;i<8;i++){let a=t.readAlignedByte();if(r|=(a&127)<<i*7,!(a&128))break;if(i===7&&a&128)return null}return r>=2**32-1?null:r};for(;t.getBitsLeft()>=8;){t.skipBits(1);let r=t.readBits(4),i=t.readBits(1),a=t.readBits(1);t.skipBits(1),i&&t.skipBits(8);let o;if(a){let s=e();if(s===null)return;o=s}else o=Math.floor(t.getBitsLeft()/8);m(t.pos%8===0),yield{type:r,data:n.subarray(t.pos/8,t.pos/8+o)},t.skipBits(o*8)}},Xr=n=>{for(let{type:t,data:e}of Ka(n)){if(t!==1)continue;let r=new Q(e),i=r.readBits(3),a=r.readBits(1),o=r.readBits(1),s=0,c=0,u=0;if(o)s=r.readBits(5);else{if(r.readBits(1)&&(r.skipBits(32),r.skipBits(32),r.readBits(1)))return null;let T=r.readBits(1);T&&(u=r.readBits(5),r.skipBits(32),r.skipBits(5),r.skipBits(5));let k=r.readBits(5);for(let y=0;y<=k;y++){r.skipBits(12);let S=r.readBits(5);if(y===0&&(s=S),S>7){let x=r.readBits(1);y===0&&(c=x)}if(T&&r.readBits(1)){let _=u+1;r.skipBits(_),r.skipBits(_),r.skipBits(1)}r.readBits(1)&&r.skipBits(4)}}let d=r.readBits(1),l=8;i===2&&d?l=r.readBits(1)?12:10:i<=2&&(l=d?10:8);let f=0;i!==1&&(f=r.readBits(1));let p=1,h=1,b=0;return f||(i===0?(p=1,h=1):i===1?(p=0,h=0):l===12&&(p=r.readBits(1),p&&(h=r.readBits(1))),p&&h&&(b=r.readBits(2))),{profile:i,level:s,tier:c,bitDepth:l,monochrome:f,chromaSubsamplingX:p,chromaSubsamplingY:h,chromaSamplePosition:b}}return null},Ge=n=>{let t=H(n),e=t.getUint8(9),r=t.getUint16(10,!0),i=t.getUint32(12,!0),a=t.getInt16(16,!0),o=t.getUint8(18),s=null;return o&&(s=n.subarray(19,21+e)),{outputChannelCount:e,preSkip:r,inputSampleRate:i,outputGain:a,channelMappingFamily:o,channelMappingTable:s}},ho=[480,960,1920,2880,480,960,1920,2880,480,960,1920,2880,480,960,480,960,120,240,480,960,120,240,480,960,120,240,480,960,120,240,480,960],ja=n=>{let t=n[0]>>3;return{durationInSamples:ho[t]}},Yr=n=>{if(n.length<7)throw new Error("Setup header is too short.");if(n[0]!==5)throw new Error("Wrong packet type in Setup header.");if(String.fromCharCode(...n.slice(1,7))!=="vorbis")throw new Error("Invalid packet signature in Setup header.");let e=n.length,r=new Uint8Array(e);for(let l=0;l<e;l++)r[l]=n[e-1-l];let i=new Q(r),a=0;for(;i.getBitsLeft()>97;)if(i.readBits(1)===1){a=i.pos;break}if(a===0)throw new Error("Invalid Setup header: framing bit not found.");let o=0,s=!1,c=0;for(;i.getBitsLeft()>=97;){let l=i.pos,f=i.readBits(8),p=i.readBits(16),h=i.readBits(16);if(f>63||p!==0||h!==0){i.pos=l;break}if(i.skipBits(1),o++,o>64)break;i.clone().readBits(6)+1===o&&(s=!0,c=o)}if(!s)throw new Error("Invalid Setup header: mode header not found.");if(c>63)throw new Error(`Unsupported mode count: ${c}.`);let u=c;i.pos=0,i.skipBits(a);let d=Array(u).fill(0);for(let l=u-1;l>=0;l--)i.skipBits(40),d[l]=i.readBits(1);return{modeBlockflags:d}},Qa=async(n,t)=>{switch(m(n.codec),n.codec){case"avc":{let e=await n.getDecoderConfig();m(e);let r;if(e.description){let s=($(e.description)[4]&3)+1;r=za(t.data,s)}else r=Zt(t.data);return r.some(a=>jr(a)===5)?"key":"delta"}case"hevc":{let e=await n.getDecoderConfig();m(e);let r;if(e.description){let s=($(e.description)[21]&3)+1;r=za(t.data,s)}else r=Zt(t.data);return r.some(a=>{let o=st(a);return 16<=o&&o<=23})?"key":"delta"}case"vp8":return(t.data[0]&1)===0?"key":"delta";case"vp9":{let e=new Q(t.data);if(e.readBits(2)!==2)return null;let r=e.readBits(1);return(e.readBits(1)<<1)+r===3&&e.skipBits(1),e.readBits(1)?null:e.readBits(1)===0?"key":"delta"}case"av1":{let e=!1;for(let{type:r,data:i}of Ka(t.data))if(r===1){let a=new Q(i);a.skipBits(4),e=!!a.readBits(1)}else if(r===3||r===6||r===7){if(e)return"key";let a=new Q(i);return a.readBits(1)?null:a.readBits(2)===0?"key":"delta"}return null}default:xe(n.codec),m(!1)}};var Jt=class{constructor(t){this.writer=t;this.helper=new Uint8Array(8);this.helperView=new DataView(this.helper.buffer);this.offsets=new WeakMap}writeU32(t){this.helperView.setUint32(0,t,!1),this.writer.write(this.helper.subarray(0,4))}writeU64(t){this.helperView.setUint32(0,Math.floor(t/2**32),!1),this.helperView.setUint32(4,t,!1),this.writer.write(this.helper.subarray(0,8))}writeAscii(t){for(let e=0;e<t.length;e++)this.helperView.setUint8(e%8,t.charCodeAt(e)),e%8===7&&this.writer.write(this.helper);t.length%8!==0&&this.writer.write(this.helper.subarray(0,t.length%8))}writeBox(t){if(this.offsets.set(t,this.writer.getPos()),t.contents&&!t.children)this.writeBoxHeader(t,t.size??t.contents.byteLength+8),this.writer.write(t.contents);else{let e=this.writer.getPos();if(this.writeBoxHeader(t,0),t.contents&&this.writer.write(t.contents),t.children)for(let a of t.children)a&&this.writeBox(a);let r=this.writer.getPos(),i=t.size??r-e;this.writer.seek(e),this.writeBoxHeader(t,i),this.writer.seek(r)}}writeBoxHeader(t,e){this.writeU32(t.largeSize?1:e),this.writeAscii(t.type),t.largeSize&&this.writeU64(e)}measureBoxHeader(t){return 8+(t.largeSize?8:0)}patchBox(t){let e=this.offsets.get(t);m(e!==void 0);let r=this.writer.getPos();this.writer.seek(e),this.writeBox(t),this.writer.seek(r)}measureBox(t){if(t.contents&&!t.children)return this.measureBoxHeader(t)+t.contents.byteLength;{let e=this.measureBoxHeader(t);if(t.contents&&(e+=t.contents.byteLength),t.children)for(let r of t.children)r&&(e+=this.measureBox(r));return e}}},D=new Uint8Array(8),Fe=new DataView(D.buffer),X=n=>[(n%256+256)%256],O=n=>(Fe.setUint16(0,n,!1),[D[0],D[1]]),Ga=n=>(Fe.setInt16(0,n,!1),[D[0],D[1]]),Xa=n=>(Fe.setUint32(0,n,!1),[D[1],D[2],D[3]]),E=n=>(Fe.setUint32(0,n,!1),[D[0],D[1],D[2],D[3]]),Ye=n=>(Fe.setInt32(0,n,!1),[D[0],D[1],D[2],D[3]]),ot=n=>(Fe.setUint32(0,Math.floor(n/2**32),!1),Fe.setUint32(4,n,!1),[D[0],D[1],D[2],D[3],D[4],D[5],D[6],D[7]]),Ya=n=>(Fe.setInt16(0,2**8*n,!1),[D[0],D[1]]),Le=n=>(Fe.setInt32(0,2**16*n,!1),[D[0],D[1],D[2],D[3]]),hi=n=>(Fe.setInt32(0,2**30*n,!1),[D[0],D[1],D[2],D[3]]),gi=(n,t)=>{let e=[],r=n;do{let i=r&127;r>>=7,e.length>0&&(i|=128),e.push(i),t!==void 0&&t--}while(r>0||t);return e.reverse()},ue=(n,t=!1)=>{let e=Array(n.length).fill(null).map((r,i)=>n.charCodeAt(i));return t&&e.push(0),e},ki=n=>{let t=null;for(let e of n)(!t||e.timestamp>t.timestamp)&&(t=e);return t},Za=n=>{let t=n*(Math.PI/180),e=Math.round(Math.cos(t)),r=Math.round(Math.sin(t));return[e,r,0,-r,e,0,0,0,1]},Ja=Za(0),es=n=>[Le(n[0]),Le(n[1]),hi(n[2]),Le(n[3]),Le(n[4]),hi(n[5]),Le(n[6]),Le(n[7]),hi(n[8])],R=(n,t,e)=>({type:n,contents:t&&new Uint8Array(t.flat(10)),children:e}),U=(n,t,e,r,i)=>R(n,[X(t),Xa(e),r??[]],i),ts=n=>n.isQuickTime?R("ftyp",[ue("qt  "),E(512),ue("qt  ")]):n.fragmented?R("ftyp",[ue("iso5"),E(512),ue("iso5"),ue("iso6"),ue("mp41")]):R("ftyp",[ue("isom"),E(512),ue("isom"),n.holdsAvc?ue("avc1"):[],ue("mp41")]),Jr=n=>({type:"mdat",largeSize:n}),er=(n,t,e=!1)=>R("moov",void 0,[go(t,n),...n.map(r=>bo(r,t)),e?Jo(n):null]),go=(n,t)=>{let e=te(Math.max(0,...t.filter(o=>o.samples.length>0).map(o=>{let s=ki(o.samples);return s.timestamp+s.duration})),Zr),r=Math.max(0,...t.map(o=>o.track.id))+1,i=!it(n)||!it(e),a=i?ot:E;return U("mvhd",+i,0,[a(n),a(n),E(Zr),a(e),Le(1),Ya(1),Array(10).fill(0),es(Ja),Array(24).fill(0),E(r)])},bo=(n,t)=>{let e=cs(n);return R("trak",void 0,[ko(n,t),wo(n,t),e.name!==void 0?R("udta",void 0,[R("\xA9nam",[...de.encode(e.name)])]):null])},ko=(n,t)=>{let e=ki(n.samples),r=te(e?e.timestamp+e.duration:0,Zr),i=!it(t)||!it(r),a=i?ot:E,o;if(n.type==="video"){let s=n.track.metadata.rotation;o=Za(s??0)}else o=Ja;return U("tkhd",+i,3,[a(t),a(t),E(n.track.id),E(0),a(r),Array(8).fill(0),O(0),O(n.track.id),Ya(n.type==="audio"?1:0),O(0),es(o),Le(n.type==="video"?n.info.width:0),Le(n.type==="video"?n.info.height:0)])},wo=(n,t)=>R("mdia",void 0,[yo(n,t),xo(!0,To[n.type],So[n.type]),Co(n)]),yo=(n,t)=>{let e=ki(n.samples),r=te(e?e.timestamp+e.duration:0,n.timescale),i=!it(t)||!it(r),a=i?ot:E,o=0;for(let s of n.track.metadata.languageCode??Z)o<<=5,o+=s.charCodeAt(0)-96;return U("mdhd",+i,0,[a(t),a(t),E(n.timescale),a(r),O(o),O(0)])},To={video:"vide",audio:"soun",subtitle:"text"},So={video:"MediabunnyVideoHandler",audio:"MediabunnySoundHandler",subtitle:"MediabunnyTextHandler"},xo=(n,t,e)=>U("hdlr",0,0,[n?ue("mhlr"):E(0),ue(t),E(0),E(0),E(0),ue(e,!0)]),Co=n=>R("minf",void 0,[_o[n.type](),Io(),Mo(n)]),Po=()=>U("vmhd",0,1,[O(0),O(0),O(0),O(0)]),vo=()=>U("smhd",0,0,[O(0),O(0)]),Eo=()=>U("nmhd",0,0),_o={video:Po,audio:vo,subtitle:Eo},Io=()=>R("dinf",void 0,[Ao()]),Ao=()=>U("dref",0,0,[E(1)],[Fo()]),Fo=()=>U("url ",0,1),Mo=n=>{let t=n.compositionTimeOffsetTable.length>1||n.compositionTimeOffsetTable.some(e=>e.sampleCompositionTimeOffset!==0);return R("stbl",void 0,[Oo(n),jo(n),t?Yo(n):null,t?Zo(n):null,$o(n),Go(n),Xo(n),Qo(n)])},Oo=n=>{let t;if(n.type==="video")t=Ro(cc[n.track.source._codec],n);else if(n.type==="audio"){let e=os(n.track.source._codec,n.muxer.isQuickTime);m(e),t=Uo(e,n)}else n.type==="subtitle"&&(t=qo(lc[n.track.source._codec],n));return m(t),U("stsd",0,0,[E(1)],[t])},Ro=(n,t)=>R(n,[Array(6).fill(0),O(1),O(0),O(0),Array(12).fill(0),O(t.info.width),O(t.info.height),E(4718592),E(4718592),E(0),O(1),Array(32).fill(0),O(24),Ga(65535)],[uc[t.track.source._codec](t),Mr(t.info.decoderConfig.colorSpace)?Bo(t):null]),Bo=n=>R("colr",[ue("nclx"),O(De[n.info.decoderConfig.colorSpace.primaries]),O(ze[n.info.decoderConfig.colorSpace.transfer]),O(Ve[n.info.decoderConfig.colorSpace.matrix]),X((n.info.decoderConfig.colorSpace.fullRange?1:0)<<7)]),Do=n=>n.info.decoderConfig&&R("avcC",[...$(n.info.decoderConfig.description)]),zo=n=>n.info.decoderConfig&&R("hvcC",[...$(n.info.decoderConfig.description)]),$a=n=>{if(!n.info.decoderConfig)return null;let t=n.info.decoderConfig,e=t.codec.split("."),r=Number(e[1]),i=Number(e[2]),a=Number(e[3]),o=e[4]?Number(e[4]):1,s=e[8]?Number(e[8]):Number(t.colorSpace?.fullRange??0),c=(a<<4)+(o<<1)+s,u=e[5]?Number(e[5]):t.colorSpace?.primaries?De[t.colorSpace.primaries]:2,d=e[6]?Number(e[6]):t.colorSpace?.transfer?ze[t.colorSpace.transfer]:2,l=e[7]?Number(e[7]):t.colorSpace?.matrix?Ve[t.colorSpace.matrix]:2;return U("vpcC",1,0,[X(r),X(i),X(c),X(u),X(d),X(l),O(0)])},Vo=n=>R("av1C",zr(n.info.decoderConfig.codec)),Uo=(n,t)=>{let e=0,r,i=16;if(K.includes(t.track.source._codec)){let a=t.track.source._codec,{sampleSize:o}=ae(a);i=8*o,i>16&&(e=1)}return e===0?r=[Array(6).fill(0),O(1),O(e),O(0),E(0),O(t.info.numberOfChannels),O(i),O(0),O(0),O(t.info.sampleRate<2**16?t.info.sampleRate:0),O(0)]:r=[Array(6).fill(0),O(1),O(e),O(0),E(0),O(t.info.numberOfChannels),O(Math.min(i,16)),O(0),O(0),O(t.info.sampleRate<2**16?t.info.sampleRate:0),O(0),E(1),E(i/8),E(t.info.numberOfChannels*i/8),E(2)],R(n,r,[dc(t.track.source._codec,t.muxer.isQuickTime)?.(t)??null])},bi=n=>{let t;switch(n.track.source._codec){case"aac":t=64;break;case"mp3":t=107;break;case"vorbis":t=221;break;default:throw new Error(`Unhandled audio codec: ${n.track.source._codec}`)}let e=[...X(t),...X(21),...Xa(0),...E(0),...E(0)];if(n.info.decoderConfig.description){let r=$(n.info.decoderConfig.description);e=[...e,...X(5),...gi(r.byteLength),...r]}return e=[...O(1),...X(0),...X(4),...gi(e.length),...e,...X(6),...X(1),...X(2)],e=[...X(3),...gi(e.length),...e],U("esds",0,0,e)},Xe=n=>R("wave",void 0,[Wo(n),No(n),R("\0\0\0\0")]),Wo=n=>R("frma",[ue(os(n.track.source._codec,n.muxer.isQuickTime))]),No=n=>{let{littleEndian:t}=ae(n.track.source._codec);return R("enda",[O(+t)])},Lo=n=>{let t=n.info.numberOfChannels,e=3840,r=n.info.sampleRate,i=0,a=0,o=new Uint8Array(0),s=n.info.decoderConfig?.description;if(s){m(s.byteLength>=18);let c=$(s),u=Ge(c);t=u.outputChannelCount,e=u.preSkip,r=u.inputSampleRate,i=u.outputGain,a=u.channelMappingFamily,u.channelMappingTable&&(o=u.channelMappingTable)}return R("dOps",[X(0),X(t),O(e),E(r),Ga(i),X(a),...o])},Ho=n=>{let t=n.info.decoderConfig?.description;m(t);let e=$(t);return U("dfLa",0,0,[...e.subarray(4)])},Ae=n=>{let{littleEndian:t,sampleSize:e}=ae(n.track.source._codec),r=+t;return U("pcmC",0,0,[X(r),X(8*e)])},qo=(n,t)=>R(n,[Array(6).fill(0),O(1)],[mc[t.track.source._codec](t)]),Ko=n=>R("vttC",[...de.encode(n.info.config.description)]);var jo=n=>U("stts",0,0,[E(n.timeToSampleTable.length),n.timeToSampleTable.map(t=>[E(t.sampleCount),E(t.sampleDelta)])]),Qo=n=>{if(n.samples.every(e=>e.type==="key"))return null;let t=[...n.samples.entries()].filter(([,e])=>e.type==="key");return U("stss",0,0,[E(t.length),t.map(([e])=>E(e+1))])},$o=n=>U("stsc",0,0,[E(n.compactlyCodedChunkTable.length),n.compactlyCodedChunkTable.map(t=>[E(t.firstChunk),E(t.samplesPerChunk),E(1)])]),Go=n=>{if(n.type==="audio"&&n.info.requiresPcmTransformation){let{sampleSize:t}=ae(n.track.source._codec);return U("stsz",0,0,[E(t*n.info.numberOfChannels),E(n.samples.reduce((e,r)=>e+te(r.duration,n.timescale),0))])}return U("stsz",0,0,[E(0),E(n.samples.length),n.samples.map(t=>E(t.size))])},Xo=n=>n.finalizedChunks.length>0&&L(n.finalizedChunks).offset>=2**32?U("co64",0,0,[E(n.finalizedChunks.length),n.finalizedChunks.map(t=>ot(t.offset))]):U("stco",0,0,[E(n.finalizedChunks.length),n.finalizedChunks.map(t=>E(t.offset))]),Yo=n=>U("ctts",1,0,[E(n.compositionTimeOffsetTable.length),n.compositionTimeOffsetTable.map(t=>[E(t.sampleCount),Ye(t.sampleCompositionTimeOffset)])]),Zo=n=>{let t=1/0,e=-1/0,r=1/0,i=-1/0;m(n.compositionTimeOffsetTable.length>0),m(n.samples.length>0);for(let o=0;o<n.compositionTimeOffsetTable.length;o++){let s=n.compositionTimeOffsetTable[o];t=Math.min(t,s.sampleCompositionTimeOffset),e=Math.max(e,s.sampleCompositionTimeOffset)}for(let o=0;o<n.samples.length;o++){let s=n.samples[o];r=Math.min(r,te(s.timestamp,n.timescale)),i=Math.max(i,te(s.timestamp+s.duration,n.timescale))}let a=Math.max(-t,0);return i>=2**31?null:U("cslg",0,0,[Ye(a),Ye(t),Ye(e),Ye(r),Ye(i)])},Jo=n=>R("mvex",void 0,n.map(ec)),ec=n=>U("trex",0,0,[E(n.track.id),E(1),E(0),E(0),E(0)]),wi=(n,t)=>R("moof",void 0,[tc(n),...t.map(rc)]),tc=n=>U("mfhd",0,0,[E(n)]),rs=n=>{let t=0,e=0,r=0,i=0,a=n.type==="delta";return e|=+a,a?t|=1:t|=2,t<<24|e<<16|r<<8|i},rc=n=>R("traf",void 0,[nc(n),ic(n),ac(n)]),nc=n=>{m(n.currentChunk);let t=0;t|=8,t|=16,t|=32,t|=131072;let e=n.currentChunk.samples[1]??n.currentChunk.samples[0],r={duration:e.timescaleUnitsToNextSample,size:e.size,flags:rs(e)};return U("tfhd",0,t,[E(n.track.id),E(r.duration),E(r.size),E(r.flags)])},ic=n=>(m(n.currentChunk),U("tfdt",1,0,[ot(te(n.currentChunk.startTimestamp,n.timescale))])),ac=n=>{m(n.currentChunk);let t=n.currentChunk.samples.map(b=>b.timescaleUnitsToNextSample),e=n.currentChunk.samples.map(b=>b.size),r=n.currentChunk.samples.map(rs),i=n.currentChunk.samples.map(b=>te(b.timestamp-b.decodeTimestamp,n.timescale)),a=new Set(t),o=new Set(e),s=new Set(r),c=new Set(i),u=s.size===2&&r[0]!==r[1],d=a.size>1,l=o.size>1,f=!u&&s.size>1,p=c.size>1||[...c].some(b=>b!==0),h=0;return h|=1,h|=4*+u,h|=256*+d,h|=512*+l,h|=1024*+f,h|=2048*+p,U("trun",1,h,[E(n.currentChunk.samples.length),E(n.currentChunk.offset-n.currentChunk.moofOffset||0),u?E(r[0]):[],n.currentChunk.samples.map((b,g)=>[d?E(t[g]):[],l?E(e[g]):[],f?E(r[g]):[],p?Ye(i[g]):[]])])},ns=n=>R("mfra",void 0,[...n.map(sc),oc()]),sc=(n,t)=>U("tfra",1,0,[E(n.track.id),E(63),E(n.finalizedChunks.length),n.finalizedChunks.map(r=>[ot(te(r.samples[0].timestamp,n.timescale)),ot(r.moofOffset),E(t+1),E(1),E(1)])]),oc=()=>U("mfro",0,0,[E(0)]),is=()=>R("vtte"),as=(n,t,e,r,i)=>R("vttc",void 0,[i!==null?R("vsid",[Ye(i)]):null,e!==null?R("iden",[...de.encode(e)]):null,t!==null?R("ctim",[...de.encode(Kr(t))]):null,r!==null?R("sttg",[...de.encode(r)]):null,R("payl",[...de.encode(n)])]),ss=n=>R("vtta",[...de.encode(n)]),cc={avc:"avc1",hevc:"hvc1",vp8:"vp08",vp9:"vp09",av1:"av01"},uc={avc:Do,hevc:zo,vp8:$a,vp9:$a,av1:Vo},os=(n,t)=>{switch(n){case"aac":return"mp4a";case"mp3":return"mp4a";case"opus":return"Opus";case"vorbis":return"mp4a";case"flac":return"fLaC";case"ulaw":return"ulaw";case"alaw":return"alaw";case"pcm-u8":return"raw ";case"pcm-s8":return"sowt"}if(t)switch(n){case"pcm-s16":return"sowt";case"pcm-s16be":return"twos";case"pcm-s24":return"in24";case"pcm-s24be":return"in24";case"pcm-s32":return"in32";case"pcm-s32be":return"in32";case"pcm-f32":return"fl32";case"pcm-f32be":return"fl32";case"pcm-f64":return"fl64";case"pcm-f64be":return"fl64"}else switch(n){case"pcm-s16":return"ipcm";case"pcm-s16be":return"ipcm";case"pcm-s24":return"ipcm";case"pcm-s24be":return"ipcm";case"pcm-s32":return"ipcm";case"pcm-s32be":return"ipcm";case"pcm-f32":return"fpcm";case"pcm-f32be":return"fpcm";case"pcm-f64":return"fpcm";case"pcm-f64be":return"fpcm"}},dc=(n,t)=>{switch(n){case"aac":return bi;case"mp3":return bi;case"opus":return Lo;case"vorbis":return bi;case"flac":return Ho}if(t)switch(n){case"pcm-s24":return Xe;case"pcm-s24be":return Xe;case"pcm-s32":return Xe;case"pcm-s32be":return Xe;case"pcm-f32":return Xe;case"pcm-f32be":return Xe;case"pcm-f64":return Xe;case"pcm-f64be":return Xe}else switch(n){case"pcm-s16":return Ae;case"pcm-s16be":return Ae;case"pcm-s24":return Ae;case"pcm-s24be":return Ae;case"pcm-s32":return Ae;case"pcm-s32be":return Ae;case"pcm-f32":return Ae;case"pcm-f32be":return Ae;case"pcm-f64":return Ae;case"pcm-f64be":return Ae}return null},lc={webvtt:"wvtt"},mc={webvtt:Ko};var tr=class{constructor(){this.ensureMonotonicity=!1;this.trackedWrites=null;this.trackedStart=-1;this.trackedEnd=-1}start(){}maybeTrackWrites(t){if(!this.trackedWrites)return;let e=this.getPos();if(e<this.trackedStart){if(e+t.byteLength<=this.trackedStart)return;t=t.subarray(this.trackedStart-e),e=0}let r=e+t.byteLength-this.trackedStart,i=this.trackedWrites.byteLength;for(;i<r;)i*=2;if(i!==this.trackedWrites.byteLength){let a=new Uint8Array(i);a.set(this.trackedWrites,0),this.trackedWrites=a}this.trackedWrites.set(t,e-this.trackedStart),this.trackedEnd=Math.max(this.trackedEnd,e+t.byteLength)}startTrackingWrites(){this.trackedWrites=new Uint8Array(2**10),this.trackedStart=this.getPos(),this.trackedEnd=this.trackedStart}stopTrackingWrites(){if(!this.trackedWrites)throw new Error("Internal error: Can't get tracked writes since nothing was tracked.");let e={data:this.trackedWrites.subarray(0,this.trackedEnd-this.trackedStart),start:this.trackedStart,end:this.trackedEnd};return this.trackedWrites=null,e}},yi=2**16,Ti=2**32,St=class extends tr{constructor(e){super();this.pos=0;this.maxPos=0;if(this.target=e,this.supportsResize="resize"in new ArrayBuffer(0),this.supportsResize)try{this.buffer=new ArrayBuffer(yi,{maxByteLength:Ti})}catch{this.buffer=new ArrayBuffer(yi),this.supportsResize=!1}else this.buffer=new ArrayBuffer(yi);this.bytes=new Uint8Array(this.buffer)}ensureSize(e){let r=this.buffer.byteLength;for(;r<e;)r*=2;if(r!==this.buffer.byteLength){if(r>Ti)throw new Error(`ArrayBuffer exceeded maximum size of ${Ti} bytes. Please consider using another target.`);if(this.supportsResize)this.buffer.resize(r);else{let i=new ArrayBuffer(r),a=new Uint8Array(i);a.set(this.bytes,0),this.buffer=i,this.bytes=a}}}write(e){this.maybeTrackWrites(e),this.ensureSize(this.pos+e.byteLength),this.bytes.set(e,this.pos),this.target.onwrite?.(this.pos,this.pos+e.byteLength),this.pos+=e.byteLength,this.maxPos=Math.max(this.maxPos,this.pos)}seek(e){this.pos=e}getPos(){return this.pos}async flush(){}async finalize(){this.ensureSize(this.pos),this.target.buffer=this.buffer.slice(0,Math.max(this.maxPos,this.pos))}async close(){}getSlice(e,r){return this.bytes.slice(e,r)}},fc=2**24,pc=2,en=class extends tr{constructor(e){super();this.pos=0;this.sections=[];this.lastWriteEnd=0;this.lastFlushEnd=0;this.writer=null;this.chunks=[];this.target=e,this.chunked=e._options.chunked??!1,this.chunkSize=e._options.chunkSize??fc}start(){this.writer=this.target._writable.getWriter()}write(e){if(this.pos>this.lastWriteEnd){let r=this.pos-this.lastWriteEnd;this.pos=this.lastWriteEnd,this.write(new Uint8Array(r))}this.maybeTrackWrites(e),this.sections.push({data:e.slice(),start:this.pos}),this.target.onwrite?.(this.pos,this.pos+e.byteLength),this.pos+=e.byteLength,this.lastWriteEnd=Math.max(this.lastWriteEnd,this.pos)}seek(e){this.pos=e}getPos(){return this.pos}async flush(){if(this.pos>this.lastWriteEnd){let i=this.pos-this.lastWriteEnd;this.pos=this.lastWriteEnd,this.write(new Uint8Array(i))}if(m(this.writer),this.sections.length===0)return;let e=[],r=[...this.sections].sort((i,a)=>i.start-a.start);e.push({start:r[0].start,size:r[0].data.byteLength});for(let i=1;i<r.length;i++){let a=e[e.length-1],o=r[i];o.start<=a.start+a.size?a.size=Math.max(a.size,o.start+o.data.byteLength-a.start):e.push({start:o.start,size:o.data.byteLength})}for(let i of e){i.data=new Uint8Array(i.size);for(let a of this.sections)i.start<=a.start&&a.start<i.start+i.size&&i.data.set(a.data,a.start-i.start);if(this.writer.desiredSize!==null&&this.writer.desiredSize<=0&&await this.writer.ready,this.chunked)this.writeDataIntoChunks(i.data,i.start),this.tryToFlushChunks();else{if(this.ensureMonotonicity&&i.start!==this.lastFlushEnd)throw new Error("Internal error: Monotonicity violation.");this.writer.write({type:"write",data:i.data,position:i.start}),this.lastFlushEnd=i.start+i.data.byteLength}}this.sections.length=0}writeDataIntoChunks(e,r){let i=this.chunks.findIndex(u=>u.start<=r&&r<u.start+this.chunkSize);i===-1&&(i=this.createChunk(r));let a=this.chunks[i],o=r-a.start,s=e.subarray(0,Math.min(this.chunkSize-o,e.byteLength));a.data.set(s,o);let c={start:o,end:o+s.byteLength};if(this.insertSectionIntoChunk(a,c),a.written[0].start===0&&a.written[0].end===this.chunkSize&&(a.shouldFlush=!0),this.chunks.length>pc){for(let u=0;u<this.chunks.length-1;u++)this.chunks[u].shouldFlush=!0;this.tryToFlushChunks()}s.byteLength<e.byteLength&&this.writeDataIntoChunks(e.subarray(s.byteLength),r+s.byteLength)}insertSectionIntoChunk(e,r){let i=0,a=e.written.length-1,o=-1;for(;i<=a;){let s=Math.floor(i+(a-i+1)/2);e.written[s].start<=r.start?(i=s+1,o=s):a=s-1}for(e.written.splice(o+1,0,r),(o===-1||e.written[o].end<r.start)&&o++;o<e.written.length-1&&e.written[o].end>=e.written[o+1].start;)e.written[o].end=Math.max(e.written[o].end,e.written[o+1].end),e.written.splice(o+1,1)}createChunk(e){let i={start:Math.floor(e/this.chunkSize)*this.chunkSize,data:new Uint8Array(this.chunkSize),written:[],shouldFlush:!1};return this.chunks.push(i),this.chunks.sort((a,o)=>a.start-o.start),this.chunks.indexOf(i)}tryToFlushChunks(e=!1){m(this.writer);for(let r=0;r<this.chunks.length;r++){let i=this.chunks[r];if(!(!i.shouldFlush&&!e)){for(let a of i.written){let o=i.start+a.start;if(this.ensureMonotonicity&&o!==this.lastFlushEnd)throw new Error("Internal error: Monotonicity violation.");this.writer.write({type:"write",data:i.data.subarray(a.start,a.end),position:o}),this.lastFlushEnd=i.start+a.end}this.chunks.splice(r--,1)}}}finalize(){return this.chunked&&this.tryToFlushChunks(!0),m(this.writer),this.writer.close()}async close(){return this.writer?.close()}},tn=class extends tr{constructor(e){super();this.target=e;this.pos=0}write(e){this.maybeTrackWrites(e),this.target.onwrite?.(this.pos,this.pos+e.byteLength),this.pos+=e.byteLength}getPos(){return this.pos}seek(e){this.pos=e}async flush(){}async finalize(){}async close(){}};var Ze=class{constructor(){this._output=null;this.onwrite=null}},rr=class extends Ze{constructor(){super(...arguments);this.buffer=null}_createWriter(){return new St(this)}},Si=class extends Ze{constructor(t,e={}){if(super(),!(t instanceof WritableStream))throw new TypeError("StreamTarget requires a WritableStream instance.");if(e!=null&&typeof e!="object")throw new TypeError("StreamTarget options, when provided, must be an object.");if(e.chunked!==void 0&&typeof e.chunked!="boolean")throw new TypeError("options.chunked, when provided, must be a boolean.");if(e.chunkSize!==void 0&&(!Number.isInteger(e.chunkSize)||e.chunkSize<1024))throw new TypeError("options.chunkSize, when provided, must be an integer and not smaller than 1024.");this._writable=t,this._options=e}_createWriter(){return new en(this)}},nr=class extends Ze{_createWriter(){return new tn(this)}};var rn=n=>{let e=(n.hasVideo?"video/":n.hasAudio?"audio/":"application/")+(n.isQuickTime?"quicktime":"mp4");if(n.codecStrings.length>0){let r=[...new Set(n.codecStrings)];e+=`; codecs="${r.join(", ")}"`}return e};var nn=class{constructor(t){this.source=t}requestSlice(t,e){if(this.fileSize!==null&&t+e>this.fileSize)return null;let r=t+e,i=this.source._read(t,r);return i instanceof Promise?i.then(a=>a?new xt(a.bytes,a.view,a.offset,t,r):null):i?new xt(i.bytes,i.view,i.offset,t,r):null}requestSliceRange(t,e,r){if(this.fileSize!==null)return this.requestSlice(t,Y(this.fileSize-t,e,r));{let i=this.requestSlice(t,r),a=o=>{if(o)return o;let s=u=>(m(u!==null),this.requestSlice(t,Y(u-t,e,r))),c=this.source._retrieveSize();return c instanceof Promise?c.then(s):s(c)};return i instanceof Promise?i.then(a):a(i)}}},xt=class n{constructor(t,e,r,i,a){this.bytes=t;this.view=e;this.offset=r;this.start=i;this.end=a;this.bufferPos=i-r}static tempFromBytes(t){return new n(t,H(t),0,0,t.length)}get length(){return this.end-this.start}get filePos(){return this.offset+this.bufferPos}set filePos(t){this.bufferPos=t-this.offset}skip(t){this.bufferPos+=t}slice(t,e=this.end-t){if(t<this.start||t+e>this.end)throw new RangeError("Slicing outside of original slice.");return new n(this.bytes,this.view,this.offset,t,t+e)}},W=(n,t)=>{let e=n.bytes.subarray(n.bufferPos,n.bufferPos+t);return n.bufferPos+=t,e},M=n=>n.view.getUint8(n.bufferPos++),Ct=(n,t)=>{let e=n.view.getUint16(n.bufferPos,t);return n.bufferPos+=2,e},me=n=>{let t=n.view.getUint16(n.bufferPos,!1);return n.bufferPos+=2,t},Pt=n=>{let t=me(n),e=M(n);return t*256+e},ir=n=>{let t=n.view.getInt16(n.bufferPos,!1);return n.bufferPos+=2,t},Je=(n,t)=>{let e=n.view.getUint32(n.bufferPos,t);return n.bufferPos+=4,e},v=n=>{let t=n.view.getUint32(n.bufferPos,!1);return n.bufferPos+=4,t},ct=n=>{let t=n.view.getUint32(n.bufferPos,!0);return n.bufferPos+=4,t},He=n=>{let t=n.view.getInt32(n.bufferPos,!1);return n.bufferPos+=4,t},hc=n=>{let t=n.view.getInt32(n.bufferPos,!0);return n.bufferPos+=4,t},xi=(n,t)=>{let e,r;return t?(e=Je(n,!0),r=Je(n,!0)):(r=Je(n,!1),e=Je(n,!1)),r*4294967296+e},be=n=>{let t=v(n),e=v(n);return t*4294967296+e},us=n=>{let t=He(n),e=v(n);return t*4294967296+e},ds=n=>{let t=ct(n);return hc(n)*4294967296+t},ls=n=>{let t=n.view.getFloat32(n.bufferPos,!1);return n.bufferPos+=4,t},an=n=>{let t=n.view.getFloat64(n.bufferPos,!1);return n.bufferPos+=8,t},ie=(n,t)=>{if(n.bufferPos+t>n.bytes.length)throw new RangeError("Reading past end of slice.");let e="";for(let r=0;r<t;r++)e+=String.fromCharCode(n.bytes[n.bufferPos++]);return e};var ye=8,Me=16,et=n=>{let t=v(n),e=ie(n,4),r=8;t===1&&(t=be(n),r=16);let a=t-r;return a<0?null:{name:e,totalSize:t,headerSize:r,contentSize:a}},tt=n=>He(n)/65536,sn=n=>He(n)/1073741824,on=n=>{let t=0;for(let e=0;e<4;e++){t<<=7;let r=M(n);if(t|=r&127,(r&128)===0)break}return t};var Zr=1e3,gc=2082844800,cs=n=>{let t={},e=n.track;return e.metadata.name!==void 0&&(t.name=e.metadata.name),t},te=(n,t,e=!0)=>{let r=n*t;return e?Math.round(r):r},cn=class extends le{constructor(e,r){super(e);this.auxTarget=new rr;this.auxWriter=this.auxTarget._createWriter();this.auxBoxWriter=new Jt(this.auxWriter);this.mdat=null;this.trackDatas=[];this.allTracksKnown=q();this.creationTime=Math.floor(Date.now()/1e3)+gc;this.finalizedChunks=[];this.nextFragmentNumber=1;this.maxWrittenTimestamp=-1/0;this.format=r,this.writer=e._writer,this.boxWriter=new Jt(this.writer),this.isQuickTime=r instanceof vt;let i=this.writer instanceof St?"in-memory":!1;this.fastStart=r._options.fastStart??i,this.isFragmented=this.fastStart==="fragmented",(this.fastStart==="in-memory"||this.isFragmented)&&(this.writer.ensureMonotonicity=!0),this.minimumFragmentDuration=r._options.minimumFragmentDuration??1}async start(){let e=await this.mutex.acquire(),r=this.output._tracks.some(i=>i.type==="video"&&i.source._codec==="avc");if(this.format._options.onFtyp&&this.writer.startTrackingWrites(),this.boxWriter.writeBox(ts({isQuickTime:this.isQuickTime,holdsAvc:r,fragmented:this.isFragmented})),this.format._options.onFtyp){let{data:i,start:a}=this.writer.stopTrackingWrites();this.format._options.onFtyp(i,a)}this.fastStart==="in-memory"?this.mdat=Jr(!1):this.isFragmented||(this.format._options.onMdat&&this.writer.startTrackingWrites(),this.mdat=Jr(!0),this.boxWriter.writeBox(this.mdat)),await this.writer.flush(),e()}allTracksAreKnown(){for(let e of this.output._tracks)if(!e.source._closed&&!this.trackDatas.some(r=>r.track===e))return!1;return!0}async getMimeType(){await this.allTracksKnown.promise;let e=this.trackDatas.map(r=>r.type==="video"||r.type==="audio"?r.info.decoderConfig.codec:{webvtt:"wvtt"}[r.track.source._codec]);return rn({isQuickTime:this.isQuickTime,hasVideo:this.trackDatas.some(r=>r.type==="video"),hasAudio:this.trackDatas.some(r=>r.type==="audio"),codecStrings:e})}getVideoTrackData(e,r,i){let a=this.trackDatas.find(d=>d.track===e);if(a)return a;Wr(i),m(i),m(i.decoderConfig);let o={...i.decoderConfig};m(o.codedWidth!==void 0),m(o.codedHeight!==void 0);let s=!1;if(e.source._codec==="avc"&&!o.description){let d=Qr(r.data);if(!d)throw new Error("Couldn't extract an AVCDecoderConfigurationRecord from the AVC packet. Make sure the packets are in Annex B format (as specified in ITU-T-REC-H.264) when not providing a description, or provide a description (must be an AVCDecoderConfigurationRecord as specified in ISO 14496-15) and ensure the packets are in AVCC format.");o.description=Ha(d),s=!0}else if(e.source._codec==="hevc"&&!o.description){let d=$r(r.data);if(!d)throw new Error("Couldn't extract an HEVCDecoderConfigurationRecord from the HEVC packet. Make sure the packets are in Annex B format (as specified in ITU-T-REC-H.265) when not providing a description, or provide a description (must be an HEVCDecoderConfigurationRecord as specified in ISO 14496-15) and ensure the packets are in HEVC format.");o.description=qa(d),s=!0}let c=Pa(1/(e.metadata.frameRate??57600),1e6).denominator,u={muxer:this,track:e,type:"video",info:{width:o.codedWidth,height:o.codedHeight,decoderConfig:o,requiresAnnexBTransformation:s},timescale:c,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[]};return this.trackDatas.push(u),this.trackDatas.sort((d,l)=>d.track.id-l.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),u}getAudioTrackData(e,r){let i=this.trackDatas.find(o=>o.track===e);if(i)return i;Ie(r),m(r),m(r.decoderConfig);let a={muxer:this,track:e,type:"audio",info:{numberOfChannels:r.decoderConfig.numberOfChannels,sampleRate:r.decoderConfig.sampleRate,decoderConfig:r.decoderConfig,requiresPcmTransformation:!this.isFragmented&&K.includes(e.source._codec)},timescale:r.decoderConfig.sampleRate,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[]};return this.trackDatas.push(a),this.trackDatas.sort((o,s)=>o.track.id-s.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),a}getSubtitleTrackData(e,r){let i=this.trackDatas.find(o=>o.track===e);if(i)return i;Nr(r),m(r),m(r.config);let a={muxer:this,track:e,type:"subtitle",info:{config:r.config},timescale:1e3,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[],lastCueEndTimestamp:0,cueQueue:[],nextSourceId:0,cueToSourceId:new WeakMap};return this.trackDatas.push(a),this.trackDatas.sort((o,s)=>o.track.id-s.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),a}async addEncodedVideoPacket(e,r,i){let a=await this.mutex.acquire();try{let o=this.getVideoTrackData(e,r,i),s=r.data;if(o.info.requiresAnnexBTransformation){let d=La(s);if(!d)throw new Error("Failed to transform packet data. Make sure all packets are provided in Annex B format, as specified in ITU-T-REC-H.264 and ITU-T-REC-H.265.");s=d}let c=this.validateAndNormalizeTimestamp(o.track,r.timestamp,r.type==="key"),u=this.createSampleForTrack(o,s,c,r.duration,r.type);await this.registerSample(o,u)}finally{a()}}async addEncodedAudioPacket(e,r,i){let a=await this.mutex.acquire();try{let o=this.getAudioTrackData(e,i),s=this.validateAndNormalizeTimestamp(o.track,r.timestamp,r.type==="key"),c=this.createSampleForTrack(o,r.data,s,r.duration,r.type);o.info.requiresPcmTransformation&&await this.maybePadWithSilence(o,s),await this.registerSample(o,c)}finally{a()}}async maybePadWithSilence(e,r){let i=L(e.samples),a=i?i.timestamp+i.duration:0,o=r-a,s=te(o,e.timescale);if(s>0){let{sampleSize:c,silentValue:u}=ae(e.info.decoderConfig.codec),d=s*e.info.numberOfChannels,l=new Uint8Array(c*d).fill(u),f=this.createSampleForTrack(e,new Uint8Array(l.buffer),a,o,"key");await this.registerSample(e,f)}}async addSubtitleCue(e,r,i){let a=await this.mutex.acquire();try{let o=this.getSubtitleTrackData(e,i);this.validateAndNormalizeTimestamp(o.track,r.timestamp,!0),e.source._codec==="webvtt"&&(o.cueQueue.push(r),await this.processWebVTTCues(o,r.timestamp))}finally{a()}}async processWebVTTCues(e,r){for(;e.cueQueue.length>0;){let i=new Set([]);for(let d of e.cueQueue)m(d.timestamp<=r),m(e.lastCueEndTimestamp<=d.timestamp+d.duration),i.add(Math.max(d.timestamp,e.lastCueEndTimestamp)),i.add(d.timestamp+d.duration);let a=[...i].sort((d,l)=>d-l),o=a[0],s=a[1]??o;if(r<s)break;if(e.lastCueEndTimestamp<o){this.auxWriter.seek(0);let d=is();this.auxBoxWriter.writeBox(d);let l=this.auxWriter.getSlice(0,this.auxWriter.getPos()),f=this.createSampleForTrack(e,l,e.lastCueEndTimestamp,o-e.lastCueEndTimestamp,"key");await this.registerSample(e,f),e.lastCueEndTimestamp=o}this.auxWriter.seek(0);for(let d=0;d<e.cueQueue.length;d++){let l=e.cueQueue[d];if(l.timestamp>=s)break;Tt.lastIndex=0;let f=Tt.test(l.text),p=l.timestamp+l.duration,h=e.cueToSourceId.get(l);if(h===void 0&&s<p&&(h=e.nextSourceId++,e.cueToSourceId.set(l,h)),l.notes){let g=ss(l.notes);this.auxBoxWriter.writeBox(g)}let b=as(l.text,f?o:null,l.identifier??null,l.settings??null,h??null);this.auxBoxWriter.writeBox(b),p===s&&e.cueQueue.splice(d--,1)}let c=this.auxWriter.getSlice(0,this.auxWriter.getPos()),u=this.createSampleForTrack(e,c,o,s-o,"key");await this.registerSample(e,u),e.lastCueEndTimestamp=s}}createSampleForTrack(e,r,i,a,o){return{timestamp:i,decodeTimestamp:i,duration:a,data:r,size:r.byteLength,type:o,timescaleUnitsToNextSample:te(a,e.timescale)}}processTimestamps(e,r){if(e.timestampProcessingQueue.length===0)return;if(e.type==="audio"&&e.info.requiresPcmTransformation){let a=0;for(let o=0;o<e.timestampProcessingQueue.length;o++){let s=e.timestampProcessingQueue[o],c=te(s.duration,e.timescale);a+=c}if(e.timeToSampleTable.length===0)e.timeToSampleTable.push({sampleCount:a,sampleDelta:1});else{let o=L(e.timeToSampleTable);o.sampleCount+=a}e.timestampProcessingQueue.length=0;return}let i=e.timestampProcessingQueue.map(a=>a.timestamp).sort((a,o)=>a-o);for(let a=0;a<e.timestampProcessingQueue.length;a++){let o=e.timestampProcessingQueue[a];o.decodeTimestamp=i[a],!this.isFragmented&&e.lastTimescaleUnits===null&&(o.decodeTimestamp=0);let s=te(o.timestamp-o.decodeTimestamp,e.timescale),c=te(o.duration,e.timescale);if(e.lastTimescaleUnits!==null){m(e.lastSample);let u=te(o.decodeTimestamp,e.timescale,!1),d=Math.round(u-e.lastTimescaleUnits);if(m(d>=0),e.lastTimescaleUnits+=d,e.lastSample.timescaleUnitsToNextSample=d,!this.isFragmented){let l=L(e.timeToSampleTable);if(m(l),l.sampleCount===1){l.sampleDelta=d;let p=e.timeToSampleTable[e.timeToSampleTable.length-2];p&&p.sampleDelta===d&&(p.sampleCount++,e.timeToSampleTable.pop(),l=p)}else l.sampleDelta!==d&&(l.sampleCount--,e.timeToSampleTable.push(l={sampleCount:1,sampleDelta:d}));l.sampleDelta===c?l.sampleCount++:e.timeToSampleTable.push({sampleCount:1,sampleDelta:c});let f=L(e.compositionTimeOffsetTable);m(f),f.sampleCompositionTimeOffset===s?f.sampleCount++:e.compositionTimeOffsetTable.push({sampleCount:1,sampleCompositionTimeOffset:s})}}else e.lastTimescaleUnits=te(o.decodeTimestamp,e.timescale,!1),this.isFragmented||(e.timeToSampleTable.push({sampleCount:1,sampleDelta:c}),e.compositionTimeOffsetTable.push({sampleCount:1,sampleCompositionTimeOffset:s}));e.lastSample=o}if(e.timestampProcessingQueue.length=0,m(e.lastSample),m(e.lastTimescaleUnits!==null),r!==void 0&&e.lastSample.timescaleUnitsToNextSample===0){m(r.type==="key");let a=te(r.timestamp,e.timescale,!1),o=Math.round(a-e.lastTimescaleUnits);e.lastSample.timescaleUnitsToNextSample=o}}async registerSample(e,r){r.type==="key"&&this.processTimestamps(e,r),e.timestampProcessingQueue.push(r),this.isFragmented?(e.sampleQueue.push(r),await this.interleaveSamples()):await this.addSampleToTrack(e,r)}async addSampleToTrack(e,r){this.isFragmented||e.samples.push(r);let i=!1;if(!e.currentChunk)i=!0;else{e.currentChunk.startTimestamp=Math.min(e.currentChunk.startTimestamp,r.timestamp);let a=r.timestamp-e.currentChunk.startTimestamp;if(this.isFragmented){let o=this.trackDatas.every(s=>{if(e===s)return r.type==="key";let c=s.sampleQueue[0];return c?c.type==="key":s.track.source._closed});a>=this.minimumFragmentDuration&&o&&r.timestamp>this.maxWrittenTimestamp&&(i=!0,await this.finalizeFragment())}else i=a>=.5}i&&(e.currentChunk&&await this.finalizeCurrentChunk(e),e.currentChunk={startTimestamp:r.timestamp,samples:[],offset:null,moofOffset:null}),m(e.currentChunk),e.currentChunk.samples.push(r),this.isFragmented&&(this.maxWrittenTimestamp=Math.max(this.maxWrittenTimestamp,r.timestamp))}async finalizeCurrentChunk(e){if(m(!this.isFragmented),!e.currentChunk)return;e.finalizedChunks.push(e.currentChunk),this.finalizedChunks.push(e.currentChunk);let r=e.currentChunk.samples.length;if(e.type==="audio"&&e.info.requiresPcmTransformation&&(r=e.currentChunk.samples.reduce((i,a)=>i+te(a.duration,e.timescale),0)),(e.compactlyCodedChunkTable.length===0||L(e.compactlyCodedChunkTable).samplesPerChunk!==r)&&e.compactlyCodedChunkTable.push({firstChunk:e.finalizedChunks.length,samplesPerChunk:r}),this.fastStart==="in-memory"){e.currentChunk.offset=0;return}e.currentChunk.offset=this.writer.getPos();for(let i of e.currentChunk.samples)m(i.data),this.writer.write(i.data),i.data=null;await this.writer.flush()}async interleaveSamples(e=!1){if(m(this.isFragmented),!(!e&&!this.allTracksAreKnown()))e:for(;;){let r=null,i=1/0;for(let o of this.trackDatas){if(!e&&o.sampleQueue.length===0&&!o.track.source._closed)break e;o.sampleQueue.length>0&&o.sampleQueue[0].timestamp<i&&(r=o,i=o.sampleQueue[0].timestamp)}if(!r)break;let a=r.sampleQueue.shift();await this.addSampleToTrack(r,a)}}async finalizeFragment(e=!0){m(this.isFragmented);let r=this.nextFragmentNumber++;if(r===1){this.format._options.onMoov&&this.writer.startTrackingWrites();let h=er(this.trackDatas,this.creationTime,!0);if(this.boxWriter.writeBox(h),this.format._options.onMoov){let{data:b,start:g}=this.writer.stopTrackingWrites();this.format._options.onMoov(b,g)}}let i=this.trackDatas.filter(h=>h.currentChunk),a=wi(r,i),o=this.writer.getPos(),s=o+this.boxWriter.measureBox(a),c=s+ye,u=1/0;for(let h of i){h.currentChunk.offset=c,h.currentChunk.moofOffset=o;for(let b of h.currentChunk.samples)c+=b.size;u=Math.min(u,h.currentChunk.startTimestamp)}let d=c-s,l=d>=2**32;if(l)for(let h of i)h.currentChunk.offset+=Me-ye;this.format._options.onMoof&&this.writer.startTrackingWrites();let f=wi(r,i);if(this.boxWriter.writeBox(f),this.format._options.onMoof){let{data:h,start:b}=this.writer.stopTrackingWrites();this.format._options.onMoof(h,b,u)}m(this.writer.getPos()===s),this.format._options.onMdat&&this.writer.startTrackingWrites();let p=Jr(l);p.size=d,this.boxWriter.writeBox(p),this.writer.seek(s+(l?Me:ye));for(let h of i)for(let b of h.currentChunk.samples)this.writer.write(b.data),b.data=null;if(this.format._options.onMdat){let{data:h,start:b}=this.writer.stopTrackingWrites();this.format._options.onMdat(h,b)}for(let h of i)h.finalizedChunks.push(h.currentChunk),this.finalizedChunks.push(h.currentChunk),h.currentChunk=null;e&&await this.writer.flush()}async onTrackClose(e){let r=await this.mutex.acquire();if(e.type==="subtitle"&&e.source._codec==="webvtt"){let i=this.trackDatas.find(a=>a.track===e);i&&await this.processWebVTTCues(i,1/0)}this.allTracksAreKnown()&&this.allTracksKnown.resolve(),this.isFragmented&&await this.interleaveSamples(),r()}async finalize(){let e=await this.mutex.acquire();this.allTracksKnown.resolve();for(let r of this.trackDatas)r.type==="subtitle"&&r.track.source._codec==="webvtt"&&await this.processWebVTTCues(r,1/0);if(this.isFragmented){await this.interleaveSamples(!0);for(let r of this.trackDatas)this.processTimestamps(r);await this.finalizeFragment(!1)}else for(let r of this.trackDatas)this.processTimestamps(r),await this.finalizeCurrentChunk(r);if(this.fastStart==="in-memory"){m(this.mdat);let r;for(let a=0;a<2;a++){let o=er(this.trackDatas,this.creationTime),s=this.boxWriter.measureBox(o);r=this.boxWriter.measureBox(this.mdat);let c=this.writer.getPos()+s+r;for(let u of this.finalizedChunks){u.offset=c;for(let{data:d}of u.samples)m(d),c+=d.byteLength,r+=d.byteLength}if(c<2**32)break;r>=2**32&&(this.mdat.largeSize=!0)}this.format._options.onMoov&&this.writer.startTrackingWrites();let i=er(this.trackDatas,this.creationTime);if(this.boxWriter.writeBox(i),this.format._options.onMoov){let{data:a,start:o}=this.writer.stopTrackingWrites();this.format._options.onMoov(a,o)}this.format._options.onMdat&&this.writer.startTrackingWrites(),this.mdat.size=r,this.boxWriter.writeBox(this.mdat);for(let a of this.finalizedChunks)for(let o of a.samples)m(o.data),this.writer.write(o.data),o.data=null;if(this.format._options.onMdat){let{data:a,start:o}=this.writer.stopTrackingWrites();this.format._options.onMdat(a,o)}}else if(this.isFragmented){let r=this.writer.getPos(),i=ns(this.trackDatas);this.boxWriter.writeBox(i);let a=this.writer.getPos()-r;this.writer.seek(this.writer.getPos()-4),this.boxWriter.writeU32(a)}else{m(this.mdat);let r=this.boxWriter.offsets.get(this.mdat);m(r!==void 0);let i=this.writer.getPos()-r;if(this.mdat.size=i,this.mdat.largeSize=i>=2**32,this.boxWriter.patchBox(this.mdat),this.format._options.onMdat){let{data:o,start:s}=this.writer.stopTrackingWrites();this.format._options.onMdat(o,s)}this.format._options.onMoov&&this.writer.startTrackingWrites();let a=er(this.trackDatas,this.creationTime);if(this.boxWriter.writeBox(a),this.format._options.onMoov){let{data:o,start:s}=this.writer.stopTrackingWrites();this.format._options.onMoov(o,s)}}e()}};var Et=class{constructor(t){this.value=t}},_t=class{constructor(t){this.value=t}},ar=class{constructor(t){this.value=t}},sr=class{constructor(t){this.value=t}};var bc=[440786851,408125543],It=[290298740,357149030,524531317,374648427,475249515,423732329,272869232,307544935],dn=[...bc,...It],ms=n=>n<256?1:n<65536?2:n<1<<24?3:n<2**32?4:n<2**40?5:6,fs=n=>n>=-64&&n<64?1:n>=-8192&&n<8192?2:n>=-(1<<20)&&n<1<<20?3:n>=-(1<<27)&&n<1<<27?4:n>=-(2**34)&&n<2**34?5:6,kc=n=>{if(n<127)return 1;if(n<16383)return 2;if(n<(1<<21)-1)return 3;if(n<(1<<28)-1)return 4;if(n<2**35-1)return 5;if(n<2**42-1)return 6;throw new Error("EBML varint size not supported "+n)},un=class{constructor(t){this.writer=t;this.helper=new Uint8Array(8);this.helperView=new DataView(this.helper.buffer);this.offsets=new WeakMap;this.dataOffsets=new WeakMap}writeByte(t){this.helperView.setUint8(0,t),this.writer.write(this.helper.subarray(0,1))}writeFloat32(t){this.helperView.setFloat32(0,t,!1),this.writer.write(this.helper.subarray(0,4))}writeFloat64(t){this.helperView.setFloat64(0,t,!1),this.writer.write(this.helper)}writeUnsignedInt(t,e=ms(t)){let r=0;switch(e){case 6:this.helperView.setUint8(r++,t/2**40|0);case 5:this.helperView.setUint8(r++,t/2**32|0);case 4:this.helperView.setUint8(r++,t>>24);case 3:this.helperView.setUint8(r++,t>>16);case 2:this.helperView.setUint8(r++,t>>8);case 1:this.helperView.setUint8(r++,t);break;default:throw new Error("Bad unsigned int size "+e)}this.writer.write(this.helper.subarray(0,r))}writeSignedInt(t,e=fs(t)){t<0&&(t+=2**(e*8)),this.writeUnsignedInt(t,e)}writeVarInt(t,e=kc(t)){let r=0;switch(e){case 1:this.helperView.setUint8(r++,128|t);break;case 2:this.helperView.setUint8(r++,64|t>>8),this.helperView.setUint8(r++,t);break;case 3:this.helperView.setUint8(r++,32|t>>16),this.helperView.setUint8(r++,t>>8),this.helperView.setUint8(r++,t);break;case 4:this.helperView.setUint8(r++,16|t>>24),this.helperView.setUint8(r++,t>>16),this.helperView.setUint8(r++,t>>8),this.helperView.setUint8(r++,t);break;case 5:this.helperView.setUint8(r++,8|t/2**32&7),this.helperView.setUint8(r++,t>>24),this.helperView.setUint8(r++,t>>16),this.helperView.setUint8(r++,t>>8),this.helperView.setUint8(r++,t);break;case 6:this.helperView.setUint8(r++,4|t/2**40&3),this.helperView.setUint8(r++,t/2**32|0),this.helperView.setUint8(r++,t>>24),this.helperView.setUint8(r++,t>>16),this.helperView.setUint8(r++,t>>8),this.helperView.setUint8(r++,t);break;default:throw new Error("Bad EBML varint size "+e)}this.writer.write(this.helper.subarray(0,r))}writeAsciiString(t){this.writer.write(new Uint8Array(t.split("").map(e=>e.charCodeAt(0))))}writeEBML(t){if(t!==null)if(t instanceof Uint8Array)this.writer.write(t);else if(Array.isArray(t))for(let e of t)this.writeEBML(e);else if(this.offsets.set(t,this.writer.getPos()),this.writeUnsignedInt(t.id),Array.isArray(t.data)){let e=this.writer.getPos(),r=t.size===-1?1:t.size??4;t.size===-1?this.writeByte(255):this.writer.seek(this.writer.getPos()+r);let i=this.writer.getPos();if(this.dataOffsets.set(t,i),this.writeEBML(t.data),t.size!==-1){let a=this.writer.getPos()-i,o=this.writer.getPos();this.writer.seek(e),this.writeVarInt(a,r),this.writer.seek(o)}}else if(typeof t.data=="number"){let e=t.size??ms(t.data);this.writeVarInt(e),this.writeUnsignedInt(t.data,e)}else if(typeof t.data=="string")this.writeVarInt(t.data.length),this.writeAsciiString(t.data);else if(t.data instanceof Uint8Array)this.writeVarInt(t.data.byteLength,t.size),this.writer.write(t.data);else if(t.data instanceof Et)this.writeVarInt(4),this.writeFloat32(t.data.value);else if(t.data instanceof _t)this.writeVarInt(8),this.writeFloat64(t.data.value);else if(t.data instanceof ar){let e=t.size??fs(t.data.value);this.writeVarInt(e),this.writeSignedInt(t.data.value,e)}else if(t.data instanceof sr){let e=de.encode(t.data.value);this.writeVarInt(e.length),this.writer.write(e)}else xe(t.data)}},Ci=8,ke=2,Oe=2*Ci,Pi=n=>{let t=M(n);if(n.skip(-1),t===0)return null;let e=1,r=128;for(;(t&r)===0;)e++,r>>=1;return e},At=n=>{let t=M(n);if(t===0)return null;let e=1,r=128;for(;(t&r)===0;)e++,r>>=1;let i=t&r-1;for(let a=1;a<e;a++)i*=256,i+=M(n);return i},N=(n,t)=>{if(t<1||t>8)throw new Error("Bad unsigned int size "+t);let e=0;for(let r=0;r<t;r++)e*=256,e+=M(n);return e},ps=(n,t)=>{let e=N(n,t);return e&1<<t*8-1&&(e-=2**(t*8)),e},ln=n=>{let t=Pi(n);return t===null?null:N(n,t)},vi=n=>{let t=M(n);return t===255?t=null:(n.skip(-1),t=At(n),t===72057594037927940&&(t=null)),t},Re=n=>{let t=ln(n);if(t===null)return null;let e=vi(n);return{id:t,size:e}},ut=(n,t)=>{let e=W(n,t),r=0;for(;r<t&&e[r]!==0;)r+=1;return String.fromCharCode(...e.subarray(0,r))},hs=(n,t)=>{let e=W(n,t),r=0;for(;r<t&&e[r]!==0;)r+=1;return _r.decode(e.subarray(0,r))},mn=(n,t)=>{if(t===0)return 0;if(t!==4&&t!==8)throw new Error("Bad float size "+t);return t===4?ls(n):an(n)},fn=async(n,t,e,r)=>{let i=new Set(e),a=t;for(;r===null||a<r;){let o=n.requestSliceRange(a,ke,Oe);if(o instanceof Promise&&(o=await o),!o)break;let s=Re(o);if(!s)break;if(i.has(s.id))return{pos:a,found:!0};dt(s.size),a=o.filePos+s.size}return{pos:r!==null&&r>a?r:a,found:!1}},Ei=async(n,t,e,r)=>{let a=new Set(e),o=t;for(;o<r;){let s=n.requestSliceRange(o,0,Math.min(65536,r-o));if(s instanceof Promise&&(s=await s),!s||s.length<Ci)break;for(let c=0;c<s.length-Ci;c++){s.filePos=o;let u=ln(s);if(u!==null&&a.has(u))return o;o++}}return null},we={avc:"V_MPEG4/ISO/AVC",hevc:"V_MPEGH/ISO/HEVC",vp8:"V_VP8",vp9:"V_VP9",av1:"V_AV1",aac:"A_AAC",mp3:"A_MPEG/L3",opus:"A_OPUS",vorbis:"A_VORBIS",flac:"A_FLAC","pcm-u8":"A_PCM/INT/LIT","pcm-s16":"A_PCM/INT/LIT","pcm-s16be":"A_PCM/INT/BIG","pcm-s24":"A_PCM/INT/LIT","pcm-s24be":"A_PCM/INT/BIG","pcm-s32":"A_PCM/INT/LIT","pcm-s32be":"A_PCM/INT/BIG","pcm-f32":"A_PCM/FLOAT/IEEE","pcm-f64":"A_PCM/FLOAT/IEEE",webvtt:"S_TEXT/WEBVTT"};function dt(n){if(n===null)throw new Error("Undefined element size is used in a place where it is not supported.")}var pn=n=>{let e=(n.hasVideo?"video/":n.hasAudio?"audio/":"application/")+(n.isWebM?"webm":"x-matroska");if(n.codecStrings.length>0){let r=[...new Set(n.codecStrings.filter(Boolean))];e+=`; codecs="${r.join(", ")}"`}return e};var wc=-(2**15),yc=2**15-1,gs="https://github.com/Vanilagy/mediabunny",bs=6,ks=5,Tc={video:1,audio:2,subtitle:17},hn=class extends le{constructor(e,r){super(e);this.trackDatas=[];this.allTracksKnown=q();this.segment=null;this.segmentInfo=null;this.seekHead=null;this.tracksElement=null;this.segmentDuration=null;this.cues=null;this.currentCluster=null;this.currentClusterStartMsTimestamp=null;this.currentClusterMaxMsTimestamp=null;this.trackDatasInCurrentCluster=new Map;this.duration=0;this.writer=e._writer,this.format=r,this.ebmlWriter=new un(this.writer),this.format._options.appendOnly&&(this.writer.ensureMonotonicity=!0)}async start(){let e=await this.mutex.acquire();this.writeEBMLHeader(),this.format._options.appendOnly||this.createSeekHead(),this.createSegmentInfo(),this.createCues(),await this.writer.flush(),e()}writeEBMLHeader(){this.format._options.onEbmlHeader&&this.writer.startTrackingWrites();let e={id:440786851,data:[{id:17030,data:1},{id:17143,data:1},{id:17138,data:4},{id:17139,data:8},{id:17026,data:this.format instanceof Ft?"webm":"matroska"},{id:17031,data:2},{id:17029,data:2}]};if(this.ebmlWriter.writeEBML(e),this.format._options.onEbmlHeader){let{data:r,start:i}=this.writer.stopTrackingWrites();this.format._options.onEbmlHeader(r,i)}}createSeekHead(){let e=new Uint8Array([28,83,187,107]),r=new Uint8Array([21,73,169,102]),i=new Uint8Array([22,84,174,107]),a={id:290298740,data:[{id:19899,data:[{id:21419,data:e},{id:21420,size:5,data:0}]},{id:19899,data:[{id:21419,data:r},{id:21420,size:5,data:0}]},{id:19899,data:[{id:21419,data:i},{id:21420,size:5,data:0}]}]};this.seekHead=a}createSegmentInfo(){let e={id:17545,data:new _t(0)};this.segmentDuration=e;let r={id:357149030,data:[{id:2807729,data:1e6},{id:19840,data:gs},{id:22337,data:gs},this.format._options.appendOnly?null:e]};this.segmentInfo=r}createTracks(){let e={id:374648427,data:[]};this.tracksElement=e;for(let r of this.trackDatas){let i=we[r.track.source._codec];m(i);let a=0;if(r.type==="audio"&&r.track.source._codec==="opus"){a=1e6*80;let o=r.info.decoderConfig.description;if(o){let s=$(o),c=Ge(s);a=Math.round(1e9*(c.preSkip/yt))}}e.data.push({id:174,data:[{id:215,data:r.track.id},{id:29637,data:r.track.id},{id:131,data:Tc[r.type]},{id:156,data:0},{id:2274716,data:r.track.metadata.languageCode??Z},{id:134,data:i},{id:22186,data:0},{id:22203,data:a},r.track.metadata.name!==void 0?{id:21358,data:new sr(r.track.metadata.name)}:null,r.type==="video"?this.videoSpecificTrackInfo(r):null,r.type==="audio"?this.audioSpecificTrackInfo(r):null,r.type==="subtitle"?this.subtitleSpecificTrackInfo(r):null]})}}videoSpecificTrackInfo(e){let{frameRate:r,rotation:i}=e.track.metadata,a=[e.info.decoderConfig.description?{id:25506,data:$(e.info.decoderConfig.description)}:null,r?{id:2352003,data:1e9/r}:null],o=i?$e(-i):0,s=e.info.decoderConfig.colorSpace,c={id:224,data:[{id:176,data:e.info.width},{id:186,data:e.info.height},Mr(s)?{id:21936,data:[{id:21937,data:Ve[s.matrix]},{id:21946,data:ze[s.transfer]},{id:21947,data:De[s.primaries]},{id:21945,data:s.fullRange?2:1}]}:null,o?{id:30320,data:[{id:30321,data:0},{id:30325,data:new Et((o+180)%360-180)}]}:null]};return a.push(c),a}audioSpecificTrackInfo(e){let r=K.includes(e.track.source._codec)?ae(e.track.source._codec):null;return[e.info.decoderConfig.description?{id:25506,data:$(e.info.decoderConfig.description)}:null,{id:225,data:[{id:181,data:new Et(e.info.sampleRate)},{id:159,data:e.info.numberOfChannels},r?{id:25188,data:8*r.sampleSize}:null]}]}subtitleSpecificTrackInfo(e){return[{id:25506,data:de.encode(e.info.config.description)}]}createSegment(){let e={id:408125543,size:this.format._options.appendOnly?-1:bs,data:[this.format._options.appendOnly?null:this.seekHead,this.segmentInfo,this.tracksElement]};if(this.segment=e,this.format._options.onSegmentHeader&&this.writer.startTrackingWrites(),this.ebmlWriter.writeEBML(e),this.format._options.onSegmentHeader){let{data:r,start:i}=this.writer.stopTrackingWrites();this.format._options.onSegmentHeader(r,i)}}createCues(){this.cues={id:475249515,data:[]}}get segmentDataOffset(){return m(this.segment),this.ebmlWriter.dataOffsets.get(this.segment)}allTracksAreKnown(){for(let e of this.output._tracks)if(!e.source._closed&&!this.trackDatas.some(r=>r.track===e))return!1;return!0}async getMimeType(){await this.allTracksKnown.promise;let e=this.trackDatas.map(r=>r.type==="video"||r.type==="audio"?r.info.decoderConfig.codec:{webvtt:"wvtt"}[r.track.source._codec]);return pn({isWebM:this.format instanceof Ft,hasVideo:this.trackDatas.some(r=>r.type==="video"),hasAudio:this.trackDatas.some(r=>r.type==="audio"),codecStrings:e})}getVideoTrackData(e,r){let i=this.trackDatas.find(o=>o.track===e);if(i)return i;Wr(r),m(r),m(r.decoderConfig),m(r.decoderConfig.codedWidth!==void 0),m(r.decoderConfig.codedHeight!==void 0);let a={track:e,type:"video",info:{width:r.decoderConfig.codedWidth,height:r.decoderConfig.codedHeight,decoderConfig:r.decoderConfig},chunkQueue:[],lastWrittenMsTimestamp:null};return e.source._codec==="vp9"?a.info.decoderConfig={...a.info.decoderConfig,description:new Uint8Array(Ma(a.info.decoderConfig.codec))}:e.source._codec==="av1"&&(a.info.decoderConfig={...a.info.decoderConfig,description:new Uint8Array(zr(a.info.decoderConfig.codec))}),this.trackDatas.push(a),this.trackDatas.sort((o,s)=>o.track.id-s.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),a}getAudioTrackData(e,r){let i=this.trackDatas.find(o=>o.track===e);if(i)return i;Ie(r),m(r),m(r.decoderConfig);let a={track:e,type:"audio",info:{numberOfChannels:r.decoderConfig.numberOfChannels,sampleRate:r.decoderConfig.sampleRate,decoderConfig:r.decoderConfig},chunkQueue:[],lastWrittenMsTimestamp:null};return this.trackDatas.push(a),this.trackDatas.sort((o,s)=>o.track.id-s.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),a}getSubtitleTrackData(e,r){let i=this.trackDatas.find(o=>o.track===e);if(i)return i;Nr(r),m(r),m(r.config);let a={track:e,type:"subtitle",info:{config:r.config},chunkQueue:[],lastWrittenMsTimestamp:null};return this.trackDatas.push(a),this.trackDatas.sort((o,s)=>o.track.id-s.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),a}async addEncodedVideoPacket(e,r,i){let a=await this.mutex.acquire();try{let o=this.getVideoTrackData(e,i),s=r.type==="key",c=this.validateAndNormalizeTimestamp(o.track,r.timestamp,s),u=r.duration;e.metadata.frameRate!==void 0&&(c=$t(c,1/e.metadata.frameRate),u=$t(u,1/e.metadata.frameRate));let d=this.createInternalChunk(r.data,c,u,r.type);e.source._codec==="vp9"&&this.fixVP9ColorSpace(o,d),o.chunkQueue.push(d),await this.interleaveChunks()}finally{a()}}async addEncodedAudioPacket(e,r,i){let a=await this.mutex.acquire();try{let o=this.getAudioTrackData(e,i),s=r.type==="key",c=this.validateAndNormalizeTimestamp(o.track,r.timestamp,s),u=this.createInternalChunk(r.data,c,r.duration,r.type);o.chunkQueue.push(u),await this.interleaveChunks()}finally{a()}}async addSubtitleCue(e,r,i){let a=await this.mutex.acquire();try{let o=this.getSubtitleTrackData(e,i),s=this.validateAndNormalizeTimestamp(o.track,r.timestamp,!0),c=r.text,u=Math.round(s*1e3);Tt.lastIndex=0,c=c.replace(Tt,p=>{let b=qr(p.slice(1,-1))-u;return`<${Kr(b)}>`});let d=de.encode(c),l=`${r.settings??""}
${r.identifier??""}
${r.notes??""}`,f=this.createInternalChunk(d,s,r.duration,"key",l.trim()?de.encode(l):null);o.chunkQueue.push(f),await this.interleaveChunks()}finally{a()}}async interleaveChunks(e=!1){if(!(!e&&!this.allTracksAreKnown())){e:for(;;){let r=null,i=1/0;for(let o of this.trackDatas){if(!e&&o.chunkQueue.length===0&&!o.track.source._closed)break e;o.chunkQueue.length>0&&o.chunkQueue[0].timestamp<i&&(r=o,i=o.chunkQueue[0].timestamp)}if(!r)break;let a=r.chunkQueue.shift();this.writeBlock(r,a)}e||await this.writer.flush()}}fixVP9ColorSpace(e,r){if(r.type!=="key"||!e.info.decoderConfig.colorSpace||!e.info.decoderConfig.colorSpace.matrix)return;let i=new Q(r.data);i.skipBits(2);let a=i.readBits(1),s=(i.readBits(1)<<1)+a;if(s===3&&i.skipBits(1),i.readBits(1)||i.readBits(1)!==0||(i.skipBits(2),i.readBits(24)!==4817730))return;s>=2&&i.skipBits(1);let l={rgb:7,bt709:2,bt470bg:1,smpte170m:3}[e.info.decoderConfig.colorSpace.matrix];ka(r.data,i.pos,i.pos+3,l)}createInternalChunk(e,r,i,a,o=null){return{data:e,type:a,timestamp:r,duration:i,additions:o}}writeBlock(e,r){this.segment||(this.createTracks(),this.createSegment());let i=Math.round(1e3*r.timestamp),a=this.trackDatas.every(l=>{if(e===l)return r.type==="key";let f=l.chunkQueue[0];return f?f.type==="key":l.track.source._closed}),o=!1;if(!this.currentCluster)o=!0;else{m(this.currentClusterStartMsTimestamp!==null),m(this.currentClusterMaxMsTimestamp!==null);let l=i-this.currentClusterStartMsTimestamp;o=a&&i>this.currentClusterMaxMsTimestamp&&l>=1e3*(this.format._options.minimumClusterDuration??1)||l>yc}o&&this.createNewCluster(i);let s=i-this.currentClusterStartMsTimestamp;if(s<wc)return;let c=new Uint8Array(4),u=new DataView(c.buffer);u.setUint8(0,128|e.track.id),u.setInt16(1,s,!1);let d=Math.round(1e3*r.duration);if(r.additions){let l={id:160,data:[{id:161,data:[c,r.data]},r.type==="delta"?{id:251,data:new ar(e.lastWrittenMsTimestamp-i)}:null,r.additions?{id:30113,data:[{id:166,data:[{id:165,data:r.additions},{id:238,data:1}]}]}:null,d>0?{id:155,data:d}:null]};this.ebmlWriter.writeEBML(l)}else{u.setUint8(3,+(r.type==="key")<<7);let l={id:163,data:[c,r.data]};this.ebmlWriter.writeEBML(l)}this.duration=Math.max(this.duration,i+d),e.lastWrittenMsTimestamp=i,this.trackDatasInCurrentCluster.has(e)||this.trackDatasInCurrentCluster.set(e,{firstMsTimestamp:i}),this.currentClusterMaxMsTimestamp=Math.max(this.currentClusterMaxMsTimestamp,i)}createNewCluster(e){this.currentCluster&&this.finalizeCurrentCluster(),this.format._options.onCluster&&this.writer.startTrackingWrites(),this.currentCluster={id:524531317,size:this.format._options.appendOnly?-1:ks,data:[{id:231,data:e}]},this.ebmlWriter.writeEBML(this.currentCluster),this.currentClusterStartMsTimestamp=e,this.currentClusterMaxMsTimestamp=e,this.trackDatasInCurrentCluster.clear()}finalizeCurrentCluster(){if(m(this.currentCluster),!this.format._options.appendOnly){let a=this.writer.getPos()-this.ebmlWriter.dataOffsets.get(this.currentCluster),o=this.writer.getPos();this.writer.seek(this.ebmlWriter.offsets.get(this.currentCluster)+4),this.ebmlWriter.writeVarInt(a,ks),this.writer.seek(o)}if(this.format._options.onCluster){m(this.currentClusterStartMsTimestamp!==null);let{data:a,start:o}=this.writer.stopTrackingWrites();this.format._options.onCluster(a,o,this.currentClusterStartMsTimestamp/1e3)}let e=this.ebmlWriter.offsets.get(this.currentCluster)-this.segmentDataOffset,r=new Map;for(let[a,{firstMsTimestamp:o}]of this.trackDatasInCurrentCluster)r.has(o)||r.set(o,[]),r.get(o).push(a);let i=[...r.entries()].sort((a,o)=>a[0]-o[0]);for(let[a,o]of i)m(this.cues),this.cues.data.push({id:187,data:[{id:179,data:a},...o.map(s=>({id:183,data:[{id:247,data:s.track.id},{id:241,data:e}]}))]})}async onTrackClose(){let e=await this.mutex.acquire();this.allTracksAreKnown()&&this.allTracksKnown.resolve(),await this.interleaveChunks(),e()}async finalize(){let e=await this.mutex.acquire();if(this.allTracksKnown.resolve(),this.segment||(this.createTracks(),this.createSegment()),await this.interleaveChunks(!0),this.currentCluster&&this.finalizeCurrentCluster(),m(this.cues),this.ebmlWriter.writeEBML(this.cues),!this.format._options.appendOnly){let r=this.writer.getPos(),i=this.writer.getPos()-this.segmentDataOffset;this.writer.seek(this.ebmlWriter.offsets.get(this.segment)+4),this.ebmlWriter.writeVarInt(i,bs),this.segmentDuration.data=new _t(this.duration),this.writer.seek(this.ebmlWriter.offsets.get(this.segmentDuration)),this.ebmlWriter.writeEBML(this.segmentDuration),this.seekHead.data[0].data[1].data=this.ebmlWriter.offsets.get(this.cues)-this.segmentDataOffset,this.seekHead.data[1].data[1].data=this.ebmlWriter.offsets.get(this.segmentInfo)-this.segmentDataOffset,this.seekHead.data[2].data[1].data=this.ebmlWriter.offsets.get(this.tracksElement)-this.segmentDataOffset,this.writer.seek(this.ebmlWriter.offsets.get(this.seekHead)),this.ebmlWriter.writeEBML(this.seekHead),this.writer.seek(r)}e()}};var _i={1:[-1,32,40,48,56,64,80,96,112,128,160,192,224,256,320,-1],2:[-1,32,48,56,64,80,96,112,128,160,192,224,256,320,384,-1],3:[-1,32,64,96,128,160,192,224,256,288,320,352,384,416,448,-1]},Ii={1:[-1,32,48,56,64,80,96,112,128,144,160,176,192,224,256,-1],2:[-1,8,16,24,32,40,48,56,64,80,96,112,128,144,160,-1],3:[-1,8,16,24,32,40,48,56,64,80,96,112,128,144,160,-1]},Ai={0:[11025,12e3,8e3,-1],2:[22050,24e3,16e3,-1],3:[44100,48e3,32e3,-1]},Mt=1483304551,gn=1231971951,bn=(n,t,e,r)=>Math.floor(n===3?(12*t/e+r)*4:144*t/e+r),Ot=(n,t)=>n===3?t===3?21:36:t===3?13:21,kn=(n,t)=>{let e=n>>>24,r=n>>>16&255,i=n>>>8&255,a=n&255;if(e!==255&&r!==255&&i!==255&&a!==255)return{header:null,bytesAdvanced:4};if(e!==255)return{header:null,bytesAdvanced:1};if((r&224)!==224)return{header:null,bytesAdvanced:1};let o=r>>3&3,s=r>>1&3,c=i>>4&15,u=i>>2&3,d=i>>1&1,l=a>>6&3,f=a>>4&3,p=a>>3&1,h=a>>2&1,b=a&3,g=o===3?_i[s]?.[c]:Ii[s]?.[c];if(!g||g===-1)return{header:null,bytesAdvanced:1};let T=g*1e3,k=Ai[o]?.[u];if(!k||k===-1)return{header:null,bytesAdvanced:1};let y=bn(s,T,k,d);if(t!==null&&t<y)return{header:null,bytesAdvanced:1};let S;return o===3?S=s===3?384:1152:s===3?S=384:s===2?S=1152:S=576,{header:{totalSize:y,mpegVersionId:o,layer:s,bitrate:T,frequencyIndex:u,sampleRate:k,channel:l,modeExtension:f,copyright:p,original:h,emphasis:b,audioSamplesInFrame:S},bytesAdvanced:1}};var wn=class{constructor(t){this.writer=t;this.helper=new Uint8Array(8);this.helperView=new DataView(this.helper.buffer)}writeU32(t){this.helperView.setUint32(0,t,!1),this.writer.write(this.helper.subarray(0,4))}writeXingFrame(t){let e=this.writer.getPos(),r=255,i=224|t.mpegVersionId<<3|t.layer<<1,o=(t.mpegVersionId===3?_i:Ii)?.[t.layer];if(!o)throw new Error("Invalid MPEG version and layer combination.");let s=Ai[t.mpegVersionId]?.[t.frequencyIndex];if(!s||s===-1)throw new Error("Invalid MPEG version and frequency index combination.");let c=0,u=155,d=o.findIndex(g=>bn(t.layer,1e3*g,s,c)>=u);if(d===-1)throw new Error("No suitable bitrate found.");let l=d<<4|t.frequencyIndex<<2|c<<1,f=t.channel<<6|t.modeExtension<<4|t.copyright<<3|t.original<<2|t.emphasis;this.helper[0]=r,this.helper[1]=i,this.helper[2]=l,this.helper[3]=f,this.writer.write(this.helper.subarray(0,4));let p=Ot(t.mpegVersionId,t.channel);this.writer.seek(e+p),this.writeU32(Mt);let h=0;t.frameCount!==null&&(h|=1),t.fileSize!==null&&(h|=2),t.toc!==null&&(h|=4),this.writeU32(h),this.writeU32(t.frameCount??0),this.writeU32(t.fileSize??0),this.writer.write(t.toc??new Uint8Array(100));let b=bn(t.layer,1e3*o[d],s,c);this.writer.seek(e+b)}};var yn=class extends le{constructor(e,r){super(e);this.xingFrameData=null;this.frameCount=0;this.framePositions=[];this.format=r,this.writer=e._writer,this.mp3Writer=new wn(e._writer)}async start(){}async getMimeType(){return"audio/mpeg"}async addEncodedVideoPacket(){throw new Error("MP3 does not support video.")}async addEncodedAudioPacket(e,r){let i=await this.mutex.acquire();try{let a=this.format._options.xingHeader!==!1;if(!this.xingFrameData&&a){let o=H(r.data);if(o.byteLength<4)throw new Error("Invalid MP3 header in sample.");let s=o.getUint32(0,!1),c=kn(s,null).header;if(!c)throw new Error("Invalid MP3 header in sample.");let u=Ot(c.mpegVersionId,c.channel);if(o.byteLength>=u+4){let d=o.getUint32(u,!1);if(d===Mt||d===gn)return}this.xingFrameData={mpegVersionId:c.mpegVersionId,layer:c.layer,frequencyIndex:c.frequencyIndex,channel:c.channel,modeExtension:c.modeExtension,copyright:c.copyright,original:c.original,emphasis:c.emphasis,frameCount:null,fileSize:null,toc:null},this.mp3Writer.writeXingFrame(this.xingFrameData),this.frameCount++}this.validateAndNormalizeTimestamp(e,r.timestamp,r.type==="key"),this.writer.write(r.data),this.frameCount++,await this.writer.flush(),a&&this.framePositions.push(this.writer.getPos())}finally{i()}}async addSubtitleCue(){throw new Error("MP3 does not support subtitles.")}async finalize(){if(!this.xingFrameData)return;let e=await this.mutex.acquire(),r=this.writer.getPos();this.writer.seek(0);let i=new Uint8Array(100);for(let a=0;a<100;a++){let o=Math.floor(this.framePositions.length*(a/100));m(o!==-1&&o<this.framePositions.length);let s=this.framePositions[o];i[a]=256*(s/r)}if(this.xingFrameData.frameCount=this.frameCount,this.xingFrameData.fileSize=r,this.xingFrameData.toc=i,this.format._options.onXingFrame&&this.writer.startTrackingWrites(),this.mp3Writer.writeXingFrame(this.xingFrameData),this.format._options.onXingFrame){let{data:a,start:o}=this.writer.stopTrackingWrites();this.format._options.onXingFrame(a,o)}this.writer.seek(r),e()}};var or=1399285583,Sc=79764919,ys=new Uint32Array(256);for(let n=0;n<256;n++){let t=n<<24;for(let e=0;e<8;e++)t=t&2147483648?t<<1^Sc:t<<1;ys[n]=t>>>0&4294967295}var Tn=n=>{let t=H(n),e=t.getUint32(22,!0);t.setUint32(22,0,!0);let r=0;for(let i=0;i<n.length;i++){let a=n[i];r=(r<<8^ys[r>>>24^a])>>>0}return t.setUint32(22,e,!0),r},Sn=(n,t,e)=>{let r=0,i=null;if(n.length>0)if(t.codec==="vorbis"){m(t.vorbisInfo);let a=t.vorbisInfo.modeBlockflags.length,s=(1<<Ca(a-1))-1<<1,c=(n[0]&s)>>1;if(c>=t.vorbisInfo.modeBlockflags.length)throw new Error("Invalid mode number.");let u=e,d=t.vorbisInfo.modeBlockflags[c];if(i=t.vorbisInfo.blocksizes[d],d===1){let l=(s|1)+1,f=n[0]&l?1:0;u=t.vorbisInfo.blocksizes[f]}r=u!==null?u+i>>2:0}else t.codec==="opus"&&(r=ja(n).durationInSamples);return{durationInSamples:r,vorbisBlockSize:i}},xn=n=>{let t="audio/ogg";if(n.codecStrings){let e=[...new Set(n.codecStrings)];t+=`; codecs="${e.join(", ")}"`}return t};var rt=27,lt=282,Cn=lt+255*255,Rt=n=>{let t=n.filePos;if(ct(n)!==or)return null;n.skip(1);let r=M(n),i=ds(n),a=ct(n),o=ct(n),s=ct(n),c=M(n),u=new Uint8Array(c);for(let p=0;p<c;p++)u[p]=M(n);let d=27+c,l=u.reduce((p,h)=>p+h,0),f=d+l;return{headerStartPos:t,totalSize:f,dataStartPos:t+d,dataSize:l,headerType:r,granulePosition:i,serialNumber:a,sequenceNumber:o,checksum:s,lacingValues:u}},Ts=(n,t)=>{for(;n.filePos<t-3;){let e=ct(n),r=e&255,i=e>>>8&255,a=e>>>16&255,o=e>>>24&255,s=79;if(!(r!==s&&i!==s&&a!==s&&o!==s)){if(n.skip(-4),e===or)return!0;n.skip(1)}}return!1};var xc=8192,Pn=class extends le{constructor(e,r){super(e);this.trackDatas=[];this.bosPagesWritten=!1;this.allTracksKnown=q();this.pageBytes=new Uint8Array(Cn);this.pageView=new DataView(this.pageBytes.buffer);this.format=r,this.writer=e._writer,this.writer.ensureMonotonicity=!0}async start(){}async getMimeType(){return await this.allTracksKnown.promise,xn({codecStrings:this.trackDatas.map(e=>e.codecInfo.codec)})}addEncodedVideoPacket(){throw new Error("Video tracks are not supported.")}getTrackData(e,r){let i=this.trackDatas.find(s=>s.track===e);if(i)return i;let a;do a=Math.floor(2**32*Math.random());while(this.trackDatas.some(s=>s.serialNumber===a));m(e.source._codec==="vorbis"||e.source._codec==="opus"),Ie(r),m(r),m(r.decoderConfig);let o={track:e,serialNumber:a,internalSampleRate:e.source._codec==="opus"?yt:r.decoderConfig.sampleRate,codecInfo:{codec:e.source._codec,vorbisInfo:null,opusInfo:null},vorbisLastBlocksize:null,packetQueue:[],currentTimestampInSamples:0,pagesWritten:0,currentGranulePosition:0,currentLacingValues:[],currentPageData:[],currentPageSize:27,currentPageStartsWithFreshPacket:!0};return this.queueHeaderPackets(o,r),this.trackDatas.push(o),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),o}queueHeaderPackets(e,r){if(m(r.decoderConfig),e.track.source._codec==="vorbis"){m(r.decoderConfig.description);let i=$(r.decoderConfig.description);if(i[0]!==2)throw new TypeError("First byte of Vorbis decoder description must be 2.");let a=1,o=()=>{let b=0;for(;;){let g=i[a++];if(g===void 0)throw new TypeError("Vorbis decoder description is too short.");if(b+=g,g<255)return b}},s=o(),c=o();if(i.length-a<=0)throw new TypeError("Vorbis decoder description is too short.");let d=i.subarray(a,a+=s),l=i.subarray(a,a+=c),f=i.subarray(a);e.packetQueue.push({data:d,endGranulePosition:0,timestamp:0,forcePageFlush:!0},{data:l,endGranulePosition:0,timestamp:0,forcePageFlush:!1},{data:f,endGranulePosition:0,timestamp:0,forcePageFlush:!0});let h=H(d).getUint8(28);e.codecInfo.vorbisInfo={blocksizes:[1<<(h&15),1<<(h>>4)],modeBlockflags:Yr(f).modeBlockflags}}else if(e.track.source._codec==="opus"){if(!r.decoderConfig.description)throw new TypeError("For Ogg, Opus decoder description is required.");let i=$(r.decoderConfig.description),a=new Uint8Array(16),o=new DataView(a.buffer);o.setUint32(0,1332770163,!1),o.setUint32(4,1415669619,!1),o.setUint32(8,0,!0),o.setUint32(12,0,!0),e.packetQueue.push({data:i,endGranulePosition:0,timestamp:0,forcePageFlush:!0},{data:a,endGranulePosition:0,timestamp:0,forcePageFlush:!0}),e.codecInfo.opusInfo={preSkip:Ge(i).preSkip}}}async addEncodedAudioPacket(e,r,i){let a=await this.mutex.acquire();try{let o=this.getTrackData(e,i);this.validateAndNormalizeTimestamp(o.track,r.timestamp,r.type==="key");let s=o.currentTimestampInSamples,{durationInSamples:c,vorbisBlockSize:u}=Sn(r.data,o.codecInfo,o.vorbisLastBlocksize);o.currentTimestampInSamples+=c,o.vorbisLastBlocksize=u,o.packetQueue.push({data:r.data,endGranulePosition:o.currentTimestampInSamples,timestamp:s/o.internalSampleRate,forcePageFlush:!1}),await this.interleavePages()}finally{a()}}addSubtitleCue(){throw new Error("Subtitle tracks are not supported.")}allTracksAreKnown(){for(let e of this.output._tracks)if(!e.source._closed&&!this.trackDatas.some(r=>r.track===e))return!1;return!0}async interleavePages(e=!1){if(!this.bosPagesWritten){if(!this.allTracksAreKnown())return;for(let r of this.trackDatas)for(;r.packetQueue.length>0;){let i=r.packetQueue.shift();if(this.writePacket(r,i,!1),i.forcePageFlush)break}this.bosPagesWritten=!0}e:for(;;){let r=null,i=1/0;for(let s of this.trackDatas){if(!e&&s.packetQueue.length<=1&&!s.track.source._closed)break e;s.packetQueue.length>0&&s.packetQueue[0].timestamp<i&&(r=s,i=s.packetQueue[0].timestamp)}if(!r)break;let a=r.packetQueue.shift(),o=r.packetQueue.length===0;this.writePacket(r,a,o)}e||await this.writer.flush()}writePacket(e,r,i){let a=r.data.length,o=0,s=0;for(;;){e.currentLacingValues.length===0&&o>0&&(e.currentPageStartsWithFreshPacket=!1);let u=Math.min(255,a);e.currentLacingValues.push(u),e.currentPageSize++,s+=u;let d=a<255;if(e.currentLacingValues.length===255){let l=r.data.subarray(o,s);if(o=s,e.currentPageData.push(l),e.currentPageSize+=l.length,this.writePage(e,i&&d),d)return}if(d)break;a-=255}let c=r.data.subarray(o);e.currentPageData.push(c),e.currentPageSize+=c.length,e.currentGranulePosition=r.endGranulePosition,(e.currentPageSize>=xc||r.forcePageFlush)&&this.writePage(e,i)}writePage(e,r){this.pageView.setUint32(0,or,!0),this.pageView.setUint8(4,0);let i=0;e.currentPageStartsWithFreshPacket||(i|=1),e.pagesWritten===0&&(i|=2),r&&(i|=4),this.pageView.setUint8(5,i);let a=e.currentLacingValues.every(u=>u===255)?-1:e.currentGranulePosition;xa(this.pageView,6,a,!0),this.pageView.setUint32(14,e.serialNumber,!0),this.pageView.setUint32(18,e.pagesWritten,!0),this.pageView.setUint32(22,0,!0),this.pageView.setUint8(26,e.currentLacingValues.length),this.pageBytes.set(e.currentLacingValues,27);let o=27+e.currentLacingValues.length;for(let u of e.currentPageData)this.pageBytes.set(u,o),o+=u.length;let s=this.pageBytes.subarray(0,o),c=Tn(s);if(this.pageView.setUint32(22,c,!0),e.pagesWritten++,e.currentLacingValues.length=0,e.currentPageData.length=0,e.currentPageSize=27,e.currentPageStartsWithFreshPacket=!0,this.format._options.onPage&&this.writer.startTrackingWrites(),this.writer.write(s),this.format._options.onPage){let{data:u,start:d}=this.writer.stopTrackingWrites();this.format._options.onPage(u,d,e.track.source)}}async onTrackClose(){let e=await this.mutex.acquire();this.allTracksAreKnown()&&this.allTracksKnown.resolve(),await this.interleavePages(),e()}async finalize(){let e=await this.mutex.acquire();this.allTracksKnown.resolve(),await this.interleavePages(!0);for(let r of this.trackDatas)r.currentLacingValues.length>0&&this.writePage(r,!0);e()}};var fe=class{constructor(t){this.input=t}};var vn=class{static supports(t,e){return!1}},En=class{static supports(t,e){return!1}},_n=class{static supports(t,e){return!1}},In=class{static supports(t,e){return!1}},Bt=[],Dt=[],mt=[],ft=[],Cc=n=>{if(n.prototype instanceof vn){let t=n;if(Bt.includes(t)){console.warn("Video decoder already registered.");return}Bt.push(t)}else if(n.prototype instanceof En){let t=n;if(Dt.includes(t)){console.warn("Audio decoder already registered.");return}Dt.push(t)}else throw new TypeError("Decoder must be a CustomVideoDecoder or CustomAudioDecoder.")},Pc=n=>{if(n.prototype instanceof _n){let t=n;if(mt.includes(t)){console.warn("Video encoder already registered.");return}mt.push(t)}else if(n.prototype instanceof In){let t=n;if(ft.includes(t)){console.warn("Audio encoder already registered.");return}ft.push(t)}else throw new TypeError("Encoder must be a CustomVideoEncoder or CustomAudioEncoder.")};var ce=new Uint8Array(0),V=class n{constructor(t,e,r,i,a=-1,o){this.data=t;this.type=e;this.timestamp=r;this.duration=i;this.sequenceNumber=a;if(t===ce&&o===void 0)throw new Error("Internal error: byteLength must be explicitly provided when constructing metadata-only packets.");if(o===void 0&&(o=t.byteLength),!(t instanceof Uint8Array))throw new TypeError("data must be a Uint8Array.");if(e!=="key"&&e!=="delta")throw new TypeError('type must be either "key" or "delta".');if(!Number.isFinite(r))throw new TypeError("timestamp must be a number.");if(!Number.isFinite(i)||i<0)throw new TypeError("duration must be a non-negative number.");if(!Number.isFinite(a))throw new TypeError("sequenceNumber must be a number.");if(!Number.isInteger(o)||o<0)throw new TypeError("byteLength must be a non-negative integer.");this.byteLength=o}get isMetadataOnly(){return this.data===ce}get microsecondTimestamp(){return Math.trunc(_e*this.timestamp)}get microsecondDuration(){return Math.trunc(_e*this.duration)}toEncodedVideoChunk(){if(this.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be converted to a video chunk.");if(typeof EncodedVideoChunk>"u")throw new Error("Your browser does not support EncodedVideoChunk.");return new EncodedVideoChunk({data:this.data,type:this.type,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}toEncodedAudioChunk(){if(this.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be converted to an audio chunk.");if(typeof EncodedAudioChunk>"u")throw new Error("Your browser does not support EncodedAudioChunk.");return new EncodedAudioChunk({data:this.data,type:this.type,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}static fromEncodedChunk(t){if(!(t instanceof EncodedVideoChunk||t instanceof EncodedAudioChunk))throw new TypeError("chunk must be an EncodedVideoChunk or EncodedAudioChunk.");let e=new Uint8Array(t.byteLength);return t.copyTo(e),new n(e,t.type,t.timestamp/1e6,(t.duration??0)/1e6)}clone(t){if(t!==void 0&&(typeof t!="object"||t===null))throw new TypeError("options, when provided, must be an object.");if(t?.timestamp!==void 0&&!Number.isFinite(t.timestamp))throw new TypeError("options.timestamp, when provided, must be a number.");if(t?.duration!==void 0&&!Number.isFinite(t.duration))throw new TypeError("options.duration, when provided, must be a number.");return new n(this.data,this.type,t?.timestamp??this.timestamp,t?.duration??this.duration,this.sequenceNumber,this.byteLength)}};var Ss=n=>{let r=n,i=4096,a=0,o=12,s=0;for(r<0&&(r=-r,a=128),r+=33,r>8191&&(r=8191);(r&i)!==i&&o>=5;)i>>=1,o--;return s=r>>o-4&15,~(a|o-5<<4|s)&255},xs=n=>{let e=0,r=0,i=~n;i&128&&(i&=-129,e=-1),r=((i&240)>>4)+5;let a=(1<<r|(i&15)<<r-4|1<<r-5)-33;return e===0?a:-a},Cs=n=>{let e=2048,r=0,i=11,a=0,o=n;for(o<0&&(o=-o,r=128),o>4095&&(o=4095);(o&e)!==e&&i>=5;)e>>=1,i--;return a=o>>(i===4?1:i-4)&15,(r|i-4<<4|a)^85},Ps=n=>{let t=0,e=0,r=n^85;r&128&&(r&=-129,t=-1),e=((r&240)>>4)+4;let i=0;return e!==4?i=1<<e|(r&15)<<e-4|1<<e-5:i=r<<1|1,t===0?i:-i};var pe=class n{constructor(t,e){this._closed=!1;if(t instanceof ArrayBuffer||ArrayBuffer.isView(t)){if(!e||typeof e!="object")throw new TypeError("init must be an object.");if(!("format"in e)||typeof e.format!="string")throw new TypeError("init.format must be a string.");if(!Number.isInteger(e.codedWidth)||e.codedWidth<=0)throw new TypeError("init.codedWidth must be a positive integer.");if(!Number.isInteger(e.codedHeight)||e.codedHeight<=0)throw new TypeError("init.codedHeight must be a positive integer.");if(e.rotation!==void 0&&![0,90,180,270].includes(e.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(!Number.isFinite(e.timestamp))throw new TypeError("init.timestamp must be a number.");if(e.duration!==void 0&&(!Number.isFinite(e.duration)||e.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");this._data=$(t).slice(),this.format=e.format,this.codedWidth=e.codedWidth,this.codedHeight=e.codedHeight,this.rotation=e.rotation??0,this.timestamp=e.timestamp,this.duration=e.duration??0,this.colorSpace=new VideoColorSpace(e.colorSpace)}else if(typeof VideoFrame<"u"&&t instanceof VideoFrame){if(e?.rotation!==void 0&&![0,90,180,270].includes(e.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(e?.timestamp!==void 0&&!Number.isFinite(e?.timestamp))throw new TypeError("init.timestamp, when provided, must be a number.");if(e?.duration!==void 0&&(!Number.isFinite(e.duration)||e.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");this._data=t,this.format=t.format,this.codedWidth=t.displayWidth,this.codedHeight=t.displayHeight,this.rotation=e?.rotation??0,this.timestamp=e?.timestamp??t.timestamp/1e6,this.duration=e?.duration??(t.duration??0)/1e6,this.colorSpace=t.colorSpace}else if(typeof HTMLImageElement<"u"&&t instanceof HTMLImageElement||typeof SVGImageElement<"u"&&t instanceof SVGImageElement||typeof ImageBitmap<"u"&&t instanceof ImageBitmap||typeof HTMLVideoElement<"u"&&t instanceof HTMLVideoElement||typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&t instanceof OffscreenCanvas){if(!e||typeof e!="object")throw new TypeError("init must be an object.");if(e.rotation!==void 0&&![0,90,180,270].includes(e.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(!Number.isFinite(e.timestamp))throw new TypeError("init.timestamp must be a number.");if(e.duration!==void 0&&(!Number.isFinite(e.duration)||e.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");if(typeof VideoFrame<"u")return new n(new VideoFrame(t,{timestamp:Math.trunc(e.timestamp*_e),duration:Math.trunc((e.duration??0)*_e)}),e);let r=0,i=0;if("naturalWidth"in t?(r=t.naturalWidth,i=t.naturalHeight):"videoWidth"in t?(r=t.videoWidth,i=t.videoHeight):"width"in t&&(r=Number(t.width),i=Number(t.height)),!r||!i)throw new TypeError("Could not determine dimensions.");let a=new OffscreenCanvas(r,i),o=a.getContext("2d",{alpha:!1,willReadFrequently:!0});m(o),o.drawImage(t,0,0),this._data=a,this.format="RGBX",this.codedWidth=r,this.codedHeight=i,this.rotation=e.rotation??0,this.timestamp=e.timestamp,this.duration=e.duration??0,this.colorSpace=new VideoColorSpace({matrix:"rgb",primaries:"bt709",transfer:"iec61966-2-1",fullRange:!0})}else throw new TypeError("Invalid data type: Must be a BufferSource or CanvasImageSource.")}get displayWidth(){return this.rotation%180===0?this.codedWidth:this.codedHeight}get displayHeight(){return this.rotation%180===0?this.codedHeight:this.codedWidth}get microsecondTimestamp(){return Math.trunc(_e*this.timestamp)}get microsecondDuration(){return Math.trunc(_e*this.duration)}clone(){if(this._closed)throw new Error("VideoSample is closed.");return m(this._data!==null),cr(this._data)?new n(this._data.clone(),{timestamp:this.timestamp,duration:this.duration,rotation:this.rotation}):this._data instanceof Uint8Array?new n(this._data.slice(),{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.timestamp,duration:this.duration,colorSpace:this.colorSpace,rotation:this.rotation}):new n(this._data,{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.timestamp,duration:this.duration,colorSpace:this.colorSpace,rotation:this.rotation})}close(){this._closed||(cr(this._data)?this._data.close():this._data=null,this._closed=!0)}allocationSize(){if(this._closed)throw new Error("VideoSample is closed.");return m(this._data!==null),cr(this._data)?this._data.allocationSize():this._data instanceof Uint8Array?this._data.byteLength:this.codedWidth*this.codedHeight*4}async copyTo(t){if(!wt(t))throw new TypeError("destination must be an ArrayBuffer or an ArrayBuffer view.");if(this._closed)throw new Error("VideoSample is closed.");if(m(this._data!==null),cr(this._data))await this._data.copyTo(t);else if(this._data instanceof Uint8Array)$(t).set(this._data);else{let r=this._data.getContext("2d",{alpha:!1});m(r);let i=r.getImageData(0,0,this.codedWidth,this.codedHeight);$(t).set(i.data)}}toVideoFrame(){if(this._closed)throw new Error("VideoSample is closed.");return m(this._data!==null),cr(this._data)?new VideoFrame(this._data,{timestamp:this.microsecondTimestamp,duration:this.microsecondDuration||void 0}):this._data instanceof Uint8Array?new VideoFrame(this._data,{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration,colorSpace:this.colorSpace}):new VideoFrame(this._data,{timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}draw(t,e,r,i,a,o,s,c,u){let d=0,l=0,f=this.displayWidth,p=this.displayHeight,h=0,b=0,g=this.displayWidth,T=this.displayHeight;if(o!==void 0?(d=e,l=r,f=i,p=a,h=o,b=s,c!==void 0?(g=c,T=u):(g=f,T=p)):(h=e,b=r,i!==void 0&&(g=i,T=a)),!(typeof CanvasRenderingContext2D<"u"&&t instanceof CanvasRenderingContext2D||typeof OffscreenCanvasRenderingContext2D<"u"&&t instanceof OffscreenCanvasRenderingContext2D))throw new TypeError("context must be a CanvasRenderingContext2D or OffscreenCanvasRenderingContext2D.");if(!Number.isFinite(d))throw new TypeError("sx must be a number.");if(!Number.isFinite(l))throw new TypeError("sy must be a number.");if(!Number.isFinite(f)||f<0)throw new TypeError("sWidth must be a non-negative number.");if(!Number.isFinite(p)||p<0)throw new TypeError("sHeight must be a non-negative number.");if(!Number.isFinite(h))throw new TypeError("dx must be a number.");if(!Number.isFinite(b))throw new TypeError("dy must be a number.");if(!Number.isFinite(g)||g<0)throw new TypeError("dWidth must be a non-negative number.");if(!Number.isFinite(T)||T<0)throw new TypeError("dHeight must be a non-negative number.");if(this._closed)throw new Error("VideoSample is closed.");this.rotation===90?[d,l,f,p]=[l,this.codedHeight-d-f,p,f]:this.rotation===180?[d,l]=[this.codedWidth-d-f,this.codedHeight-l-p]:this.rotation===270&&([d,l,f,p]=[this.codedWidth-l-p,d,p,f]);let k=this.toCanvasImageSource();t.save();let y=h+g/2,S=b+T/2;t.translate(y,S),t.rotate(this.rotation*Math.PI/180);let w=this.rotation%180===0?1:g/T;t.scale(1/w,w),t.drawImage(k,d,l,f,p,-g/2,-T/2,g,T),t.restore()}drawWithFit(t,e){let r=t.canvas.width,i=t.canvas.height,a=e.rotation??this.rotation,o,s,c,u;if(e.fit==="fill")o=0,s=0,c=r,u=i;else{let[l,f]=a%180===0?[this.codedWidth,this.codedHeight]:[this.codedHeight,this.codedWidth],p=e.fit==="contain"?Math.min(r/l,i/f):Math.max(r/l,i/f);c=l*p,u=f*p,o=(r-c)/2,s=(i-u)/2}let d=a%180===0?1:c/u;t.translate(r/2,i/2),t.rotate(a*Math.PI/180),t.scale(1/d,d),t.translate(-r/2,-i/2),t.drawImage(this.toCanvasImageSource(),o,s,c,u)}toCanvasImageSource(){if(this._closed)throw new Error("VideoSample is closed.");if(m(this._data!==null),this._data instanceof Uint8Array){let t=this.toVideoFrame();return queueMicrotask(()=>t.close()),t}else return this._data}setRotation(t){if(![0,90,180,270].includes(t))throw new TypeError("newRotation must be 0, 90, 180, or 270.");this.rotation=t}setTimestamp(t){if(!Number.isFinite(t))throw new TypeError("newTimestamp must be a number.");this.timestamp=t}setDuration(t){if(!Number.isFinite(t)||t<0)throw new TypeError("newDuration must be a non-negative number.");this.duration=t}},cr=n=>typeof VideoFrame<"u"&&n instanceof VideoFrame,Fi=new Set(["f32","f32-planar","s16","s16-planar","s32","s32-planar","u8","u8-planar"]),he=class n{constructor(t){this._closed=!1;if(dr(t)){if(t.format===null)throw new TypeError("AudioData with null format is not supported.");this._data=t,this.format=t.format,this.sampleRate=t.sampleRate,this.numberOfFrames=t.numberOfFrames,this.numberOfChannels=t.numberOfChannels,this.timestamp=t.timestamp/1e6,this.duration=t.numberOfFrames/t.sampleRate}else{if(!t||typeof t!="object")throw new TypeError("Invalid AudioDataInit: must be an object.");if(!Fi.has(t.format))throw new TypeError("Invalid AudioDataInit: invalid format.");if(!Number.isFinite(t.sampleRate)||t.sampleRate<=0)throw new TypeError("Invalid AudioDataInit: sampleRate must be > 0.");if(!Number.isInteger(t.numberOfChannels)||t.numberOfChannels===0)throw new TypeError("Invalid AudioDataInit: numberOfChannels must be an integer > 0.");if(!Number.isFinite(t?.timestamp))throw new TypeError("init.timestamp must be a number.");let e=t.data.byteLength/(ur(t.format)*t.numberOfChannels);if(!Number.isInteger(e))throw new TypeError("Invalid AudioDataInit: data size is not a multiple of frame size.");this.format=t.format,this.sampleRate=t.sampleRate,this.numberOfFrames=e,this.numberOfChannels=t.numberOfChannels,this.timestamp=t.timestamp,this.duration=e/t.sampleRate;let r;if(t.data instanceof ArrayBuffer)r=new Uint8Array(t.data);else if(ArrayBuffer.isView(t.data))r=new Uint8Array(t.data.buffer,t.data.byteOffset,t.data.byteLength);else throw new TypeError("Invalid AudioDataInit: data is not a BufferSource.");let i=this.numberOfFrames*this.numberOfChannels*ur(this.format);if(r.byteLength<i)throw new TypeError("Invalid AudioDataInit: insufficient data size.");this._data=r}}get microsecondTimestamp(){return Math.trunc(_e*this.timestamp)}get microsecondDuration(){return Math.trunc(_e*this.duration)}allocationSize(t){if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(!Number.isInteger(t.planeIndex)||t.planeIndex<0)throw new TypeError("planeIndex must be a non-negative integer.");if(t.format!==void 0&&!Fi.has(t.format))throw new TypeError("Invalid format.");if(t.frameOffset!==void 0&&(!Number.isInteger(t.frameOffset)||t.frameOffset<0))throw new TypeError("frameOffset must be a non-negative integer.");if(t.frameCount!==void 0&&(!Number.isInteger(t.frameCount)||t.frameCount<0))throw new TypeError("frameCount must be a non-negative integer.");if(this._closed)throw new Error("AudioSample is closed.");let e=t.format??this.format,r=t.frameOffset??0;if(r>=this.numberOfFrames)throw new RangeError("frameOffset out of range");let i=t.frameCount!==void 0?t.frameCount:this.numberOfFrames-r;if(i>this.numberOfFrames-r)throw new RangeError("frameCount out of range");let a=ur(e),o=An(e);if(o&&t.planeIndex>=this.numberOfChannels)throw new RangeError("planeIndex out of range");if(!o&&t.planeIndex!==0)throw new RangeError("planeIndex out of range");return(o?i:i*this.numberOfChannels)*a}copyTo(t,e){if(!wt(t))throw new TypeError("destination must be an ArrayBuffer or an ArrayBuffer view.");if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(!Number.isInteger(e.planeIndex)||e.planeIndex<0)throw new TypeError("planeIndex must be a non-negative integer.");if(e.format!==void 0&&!Fi.has(e.format))throw new TypeError("Invalid format.");if(e.frameOffset!==void 0&&(!Number.isInteger(e.frameOffset)||e.frameOffset<0))throw new TypeError("frameOffset must be a non-negative integer.");if(e.frameCount!==void 0&&(!Number.isInteger(e.frameCount)||e.frameCount<0))throw new TypeError("frameCount must be a non-negative integer.");if(this._closed)throw new Error("AudioSample is closed.");let{planeIndex:r,format:i,frameCount:a,frameOffset:o}=e,s=i??this.format;if(!s)throw new Error("Destination format not determined");let c=this.numberOfFrames,u=this.numberOfChannels,d=o??0;if(d>=c)throw new RangeError("frameOffset out of range");let l=a!==void 0?a:c-d;if(l>c-d)throw new RangeError("frameCount out of range");let f=ur(s),p=An(s);if(p&&r>=u)throw new RangeError("planeIndex out of range");if(!p&&r!==0)throw new RangeError("planeIndex out of range");let b=(p?l:l*u)*f;if(t.byteLength<b)throw new RangeError("Destination buffer is too small");let g=H(t),T=Ec(s);if(dr(this._data))if(p)if(s==="f32-planar")this._data.copyTo(t,{planeIndex:r,frameOffset:d,frameCount:l,format:"f32-planar"});else{let k=new ArrayBuffer(l*4),y=new Float32Array(k);this._data.copyTo(y,{planeIndex:r,frameOffset:d,frameCount:l,format:"f32-planar"});let S=new DataView(k);for(let w=0;w<l;w++){let x=w*f,_=S.getFloat32(w*4,!0);T(g,x,_)}}else{let k=u,y=new Float32Array(l);for(let S=0;S<k;S++){this._data.copyTo(y,{planeIndex:S,frameOffset:d,frameCount:l,format:"f32-planar"});for(let w=0;w<l;w++){let _=(w*k+S)*f;T(g,_,y[w])}}}else{let k=this._data,y=new DataView(k.buffer,k.byteOffset,k.byteLength),S=this.format,w=vc(S),x=ur(S),_=An(S);for(let C=0;C<l;C++)if(p){let P=C*f,I;_?I=(r*c+(C+d))*x:I=((C+d)*u+r)*x;let F=w(y,I);T(g,P,F)}else for(let P=0;P<u;P++){let F=(C*u+P)*f,B;_?B=(P*c+(C+d))*x:B=((C+d)*u+P)*x;let j=w(y,B);T(g,F,j)}}}clone(){if(this._closed)throw new Error("AudioSample is closed.");if(dr(this._data)){let t=new n(this._data.clone());return t.setTimestamp(this.timestamp),t}else return new n({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.timestamp,data:this._data})}close(){this._closed||(dr(this._data)?this._data.close():this._data=new Uint8Array(0),this._closed=!0)}toAudioData(){if(this._closed)throw new Error("AudioSample is closed.");if(dr(this._data)){if(this._data.timestamp===this.microsecondTimestamp)return this._data.clone();if(An(this.format)){let t=this.allocationSize({planeIndex:0,format:this.format}),e=new ArrayBuffer(t*this.numberOfChannels);for(let r=0;r<this.numberOfChannels;r++)this.copyTo(new Uint8Array(e,r*t,t),{planeIndex:r,format:this.format});return new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:e})}else{let t=new ArrayBuffer(this.allocationSize({planeIndex:0,format:this.format}));return this.copyTo(t,{planeIndex:0,format:this.format}),new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:t})}}else return new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:this._data})}toAudioBuffer(){if(this._closed)throw new Error("AudioSample is closed.");let t=new AudioBuffer({numberOfChannels:this.numberOfChannels,length:this.numberOfFrames,sampleRate:this.sampleRate}),e=new Float32Array(this.allocationSize({planeIndex:0,format:"f32-planar"})/4);for(let r=0;r<this.numberOfChannels;r++)this.copyTo(e,{planeIndex:r,format:"f32-planar"}),t.copyToChannel(e,r);return t}setTimestamp(t){if(!Number.isFinite(t))throw new TypeError("newTimestamp must be a number.");this.timestamp=t}static*_fromAudioBuffer(t,e){if(!(t instanceof AudioBuffer))throw new TypeError("audioBuffer must be an AudioBuffer.");let r=48e3*5,i=t.numberOfChannels,a=t.sampleRate,o=t.length,s=Math.floor(r/i),c=0,u=o;for(;u>0;){let d=Math.min(s,u),l=new Float32Array(i*d);for(let f=0;f<i;f++)t.copyFromChannel(l.subarray(f*d,(f+1)*d),f,c);yield new n({format:"f32-planar",sampleRate:a,numberOfFrames:d,numberOfChannels:i,timestamp:e+c/a,data:l}),c+=d,u-=d}}static fromAudioBuffer(t,e){if(!(t instanceof AudioBuffer))throw new TypeError("audioBuffer must be an AudioBuffer.");let r=48e3*5,i=t.numberOfChannels,a=t.sampleRate,o=t.length,s=Math.floor(r/i),c=0,u=o,d=[];for(;u>0;){let l=Math.min(s,u),f=new Float32Array(i*l);for(let h=0;h<i;h++)t.copyFromChannel(f.subarray(h*l,(h+1)*l),h,c);let p=new n({format:"f32-planar",sampleRate:a,numberOfFrames:l,numberOfChannels:i,timestamp:e+c/a,data:f});d.push(p),c+=l,u-=l}return d}},ur=n=>{switch(n){case"u8":case"u8-planar":return 1;case"s16":case"s16-planar":return 2;case"s32":case"s32-planar":return 4;case"f32":case"f32-planar":return 4;default:throw new Error("Unknown AudioSampleFormat")}},An=n=>{switch(n){case"u8-planar":case"s16-planar":case"s32-planar":case"f32-planar":return!0;default:return!1}},vc=n=>{switch(n){case"u8":case"u8-planar":return(t,e)=>(t.getUint8(e)-128)/128;case"s16":case"s16-planar":return(t,e)=>t.getInt16(e,!0)/32768;case"s32":case"s32-planar":return(t,e)=>t.getInt32(e,!0)/2147483648;case"f32":case"f32-planar":return(t,e)=>t.getFloat32(e,!0)}},Ec=n=>{switch(n){case"u8":case"u8-planar":return(t,e,r)=>t.setUint8(e,Y((r+1)*127.5,0,255));case"s16":case"s16-planar":return(t,e,r)=>t.setInt16(e,Y(Math.round(r*32767),-32768,32767),!0);case"s32":case"s32-planar":return(t,e,r)=>t.setInt32(e,Y(Math.round(r*2147483647),-2147483648,2147483647),!0);case"f32":case"f32-planar":return(t,e,r)=>t.setFloat32(e,r,!0)}},dr=n=>typeof AudioData<"u"&&n instanceof AudioData;var zt=n=>{if(!n||typeof n!="object")throw new TypeError("options must be an object.");if(n.metadataOnly!==void 0&&typeof n.metadataOnly!="boolean")throw new TypeError("options.metadataOnly, when defined, must be a boolean.");if(n.verifyKeyPackets!==void 0&&typeof n.verifyKeyPackets!="boolean")throw new TypeError("options.verifyKeyPackets, when defined, must be a boolean.");if(n.verifyKeyPackets&&n.metadataOnly)throw new TypeError("options.verifyKeyPackets and options.metadataOnly cannot be enabled together.")},qe=n=>{if(typeof n!="number"||Number.isNaN(n))throw new TypeError("timestamp must be a number.")},Mi=(n,t,e)=>e.verifyKeyPackets?t.then(async r=>{if(!r||r.type==="delta")return r;let i=await n.determinePacketType(r);return i&&(r.type=i),r}):t,Be=class{constructor(t){if(!(t instanceof gt))throw new TypeError("track must be an InputTrack.");this._track=t}getFirstPacket(t={}){return zt(t),Mi(this._track,this._track._backing.getFirstPacket(t),t)}getPacket(t,e={}){return qe(t),zt(e),Mi(this._track,this._track._backing.getPacket(t,e),e)}getNextPacket(t,e={}){if(!(t instanceof V))throw new TypeError("packet must be an EncodedPacket.");return zt(e),Mi(this._track,this._track._backing.getNextPacket(t,e),e)}async getKeyPacket(t,e={}){if(qe(t),zt(e),!e.verifyKeyPackets)return this._track._backing.getKeyPacket(t,e);let r=await this._track._backing.getKeyPacket(t,e);return!r||r.type==="delta"?r:await this._track.determinePacketType(r)==="delta"?this.getKeyPacket(r.timestamp-1/this._track.timeResolution,e):r}async getNextKeyPacket(t,e={}){if(!(t instanceof V))throw new TypeError("packet must be an EncodedPacket.");if(zt(e),!e.verifyKeyPackets)return this._track._backing.getNextKeyPacket(t,e);let r=await this._track._backing.getNextKeyPacket(t,e);return!r||r.type==="delta"?r:await this._track.determinePacketType(r)==="delta"?this.getNextKeyPacket(r,e):r}packets(t,e,r={}){if(t!==void 0&&!(t instanceof V))throw new TypeError("startPacket must be an EncodedPacket.");if(t!==void 0&&t.isMetadataOnly&&!r?.metadataOnly)throw new TypeError("startPacket can only be metadata-only if options.metadataOnly is enabled.");if(e!==void 0&&!(e instanceof V))throw new TypeError("endPacket must be an EncodedPacket.");zt(r);let i=[],{promise:a,resolve:o}=q(),{promise:s,resolve:c}=q(),u=!1,d=!1,l=null,f=[],p=()=>Math.max(2,f.length);return(async()=>{let h=t??await this.getFirstPacket(r);for(;h&&!d&&!(e&&h.sequenceNumber>=e?.sequenceNumber);){if(i.length>p()){({promise:s,resolve:c}=q()),await s;continue}i.push(h),o(),{promise:a,resolve:o}=q(),h=await this.getNextPacket(h,r)}u=!0,o()})().catch(h=>{l||(l=h,o())}),{async next(){for(;;){if(d)return{value:void 0,done:!0};if(l)throw l;if(i.length>0){let h=i.shift(),b=performance.now();for(f.push(b);f.length>0&&b-f[0]>=1e3;)f.shift();return c(),{value:h,done:!1}}else{if(u)return{value:void 0,done:!0};await a}}},async return(){return d=!0,c(),o(),{value:void 0,done:!0}},async throw(h){throw h},[Symbol.asyncIterator](){return this}}}},lr=class{constructor(t,e){this.onSample=t;this.onError=e}},mr=class{mediaSamplesInRange(t=0,e=1/0){qe(t),qe(e);let r=[],i=!1,a=null,{promise:o,resolve:s}=q(),{promise:c,resolve:u}=q(),d=!1,l=!1,f=!1,p=null;return(async()=>{let h=new Error,b=await this._createDecoder(w=>{if(u(),w.timestamp>=e&&(l=!0),l){w.close();return}a&&(w.timestamp>t?(r.push(a),i=!0):a.close()),w.timestamp>=t&&(r.push(w),i=!0),a=i?null:w,r.length>0&&(s(),{promise:o,resolve:s}=q())},w=>{p||(w.stack=h.stack,p=w,s())}),g=this._createPacketSink(),T=await g.getKeyPacket(t,{verifyKeyPackets:!0})??await g.getFirstPacket();if(!T)return;let k=T,y;if(e<1/0){let w=await g.getPacket(e),x=w?w.type==="key"&&w.timestamp===e?w:await g.getNextKeyPacket(w,{verifyKeyPackets:!0}):null;x&&(y=x)}let S=g.packets(T,y);for(await S.next();k&&!l;){let w=vs(r.length);if(r.length+b.getDecodeQueueSize()>w){({promise:c,resolve:u}=q()),await c;continue}b.decode(k);let x=await S.next();if(x.done)break;k=x.value}await S.return(),f||await b.flush(),b.close(),!i&&a&&r.push(a),d=!0,s()})().catch(h=>{p||(p=h,s())}),{async next(){for(;;){if(f)return{value:void 0,done:!0};if(p)throw p;if(r.length>0){let h=r.shift();return u(),{value:h,done:!1}}else if(!d)await o;else return{value:void 0,done:!0}}},async return(){f=!0,l=!0,u(),s(),a?.close();for(let h of r)h.close();return{value:void 0,done:!0}},async throw(h){throw h},[Symbol.asyncIterator](){return this}}}mediaSamplesAtTimestamps(t){ya(t);let e=wa(t),r=[],i=[],{promise:a,resolve:o}=q(),{promise:s,resolve:c}=q(),u=!1,d=!1,l=null,f=p=>{i.push(p),o(),{promise:a,resolve:o}=q()};return(async()=>{let p=new Error,h=await this._createDecoder(w=>{if(c(),d){w.close();return}let x=0;for(;r.length>0&&w.timestamp-r[0]>-1e-10;)x++,r.shift();if(x>0)for(let _=0;_<x;_++)f(_<x-1?w.clone():w);else w.close()},w=>{l||(w.stack=p.stack,l=w,o())}),b=this._createPacketSink(),g=null,T=null,k=-1,y=async()=>{m(T);let w=T;for(h.decode(w);w.sequenceNumber<k;){let x=vs(i.length);for(;i.length+h.getDecodeQueueSize()>x&&!d;)({promise:s,resolve:c}=q()),await s;if(d)break;let _=await b.getNextPacket(w);m(_),w=_,h.decode(_)}k=-1},S=async()=>{await h.flush();for(let w=0;w<r.length;w++)f(null);r.length=0};for await(let w of e){if(qe(w),d)break;let x=await b.getPacket(w),_=x&&await b.getKeyPacket(w,{verifyKeyPackets:!0});if(!_){k!==-1&&(await y(),await S()),f(null),g=null;continue}g&&(_.sequenceNumber!==T.sequenceNumber||x.timestamp<g.timestamp)&&(await y(),await S()),r.push(x.timestamp),k=Math.max(x.sequenceNumber,k),g=x,T=_}d||(k!==-1&&await y(),await S()),h.close(),u=!0,o()})().catch(p=>{l||(l=p,o())}),{async next(){for(;;){if(d)return{value:void 0,done:!0};if(l)throw l;if(i.length>0){let p=i.shift();return m(p!==void 0),c(),{value:p,done:!1}}else if(!u)await a;else return{value:void 0,done:!0}}},async return(){d=!0,c(),o();for(let p of i)p?.close();return{value:void 0,done:!0}},async throw(p){throw p},[Symbol.asyncIterator](){return this}}}},vs=n=>n===0?40:8,Oi=class extends lr{constructor(e,r,i,a,o,s){super(e,r);this.rotation=o;this.timeResolution=s;this.decoder=null;this.customDecoder=null;this.customDecoderCallSerializer=new Qe;this.customDecoderQueueSize=0;this.inputTimestamps=[];this.sampleQueue=[];let c=Bt.find(u=>u.supports(i,a));if(c)this.customDecoder=new c,this.customDecoder.codec=i,this.customDecoder.config=a,this.customDecoder.onSample=u=>{if(!(u instanceof pe))throw new TypeError("The argument passed to onSample must be a VideoSample.");this.finalizeAndEmitSample(u)},this.customDecoderCallSerializer.call(()=>this.customDecoder.init());else{let u=d=>{if(Br()){if(this.sampleQueue.length>0&&d.timestamp>=L(this.sampleQueue).timestamp){for(let l of this.sampleQueue)this.finalizeAndEmitSample(l);this.sampleQueue.length=0}Se(this.sampleQueue,d,l=>l.timestamp)}else{let l=this.inputTimestamps.shift();m(l!==void 0),d.setTimestamp(l),this.finalizeAndEmitSample(d)}};this.decoder=new VideoDecoder({output:d=>u(new pe(d)),error:r}),this.decoder.configure(a)}}finalizeAndEmitSample(e){e.setTimestamp(Math.round(e.timestamp*this.timeResolution)/this.timeResolution),e.setDuration(Math.round(e.duration*this.timeResolution)/this.timeResolution),e.setRotation(this.rotation),this.onSample(e)}getDecodeQueueSize(){return this.customDecoder?this.customDecoderQueueSize:(m(this.decoder),this.decoder.decodeQueueSize)}decode(e){this.customDecoder?(this.customDecoderQueueSize++,this.customDecoderCallSerializer.call(()=>this.customDecoder.decode(e)).then(()=>this.customDecoderQueueSize--)):(m(this.decoder),Br()||Se(this.inputTimestamps,e.timestamp,r=>r),this.decoder.decode(e.toEncodedVideoChunk()))}async flush(){if(this.customDecoder?await this.customDecoderCallSerializer.call(()=>this.customDecoder.flush()):(m(this.decoder),await this.decoder.flush()),Br()){for(let e of this.sampleQueue)this.finalizeAndEmitSample(e);this.sampleQueue.length=0}}close(){this.customDecoder?this.customDecoderCallSerializer.call(()=>this.customDecoder.close()):(m(this.decoder),this.decoder.close());for(let e of this.sampleQueue)e.close();this.sampleQueue.length=0}},pt=class extends mr{constructor(t){if(!(t instanceof Ce))throw new TypeError("videoTrack must be an InputVideoTrack.");super(),this._videoTrack=t}async _createDecoder(t,e){if(!await this._videoTrack.canDecode())throw new Error("This video track cannot be decoded by this browser. Make sure to check decodability before using a track.");let r=this._videoTrack.codec,i=this._videoTrack.rotation,a=await this._videoTrack.getDecoderConfig(),o=this._videoTrack.timeResolution;return m(r&&a),new Oi(t,e,r,a,i,o)}_createPacketSink(){return new Be(this._videoTrack)}async getSample(t){qe(t);for await(let e of this.mediaSamplesAtTimestamps([t]))return e;throw new Error("Internal error: Iterator returned nothing.")}samples(t=0,e=1/0){return this.mediaSamplesInRange(t,e)}samplesAtTimestamps(t){return this.mediaSamplesAtTimestamps(t)}},fr=class{constructor(t,e={}){this._nextCanvasIndex=0;if(!(t instanceof Ce))throw new TypeError("videoTrack must be an InputVideoTrack.");if(e&&typeof e!="object")throw new TypeError("options must be an object.");if(e.width!==void 0&&(!Number.isInteger(e.width)||e.width<=0))throw new TypeError("options.width, when defined, must be a positive integer.");if(e.height!==void 0&&(!Number.isInteger(e.height)||e.height<=0))throw new TypeError("options.height, when defined, must be a positive integer.");if(e.fit!==void 0&&!["fill","contain","cover"].includes(e.fit))throw new TypeError('options.fit, when provided, must be one of "fill", "contain", or "cover".');if(e.width!==void 0&&e.height!==void 0&&e.fit===void 0)throw new TypeError("When both options.width and options.height are provided, options.fit must also be provided.");if(e.rotation!==void 0&&![0,90,180,270].includes(e.rotation))throw new TypeError("options.rotation, when provided, must be 0, 90, 180 or 270.");if(e.poolSize!==void 0&&(typeof e.poolSize!="number"||!Number.isInteger(e.poolSize)||e.poolSize<0))throw new TypeError("poolSize must be a non-negative integer.");let r=e.rotation??t.rotation,[i,a]=r%180===0?[t.codedWidth,t.codedHeight]:[t.codedHeight,t.codedWidth],o=i/a;e.width!==void 0&&e.height===void 0?(i=e.width,a=Math.round(i/o)):e.width===void 0&&e.height!==void 0?(a=e.height,i=Math.round(a*o)):e.width!==void 0&&e.height!==void 0&&(i=e.width,a=e.height),this._videoTrack=t,this._width=i,this._height=a,this._rotation=r,this._fit=e.fit??"fill",this._videoSampleSink=new pt(t),this._canvasPool=Array.from({length:e.poolSize??0},()=>null)}_videoSampleToWrappedCanvas(t){let e=this._canvasPool[this._nextCanvasIndex],r=!1;e||(typeof document<"u"?(e=document.createElement("canvas"),e.width=this._width,e.height=this._height):e=new OffscreenCanvas(this._width,this._height),this._canvasPool.length>0&&(this._canvasPool[this._nextCanvasIndex]=e),r=!0),this._canvasPool.length>0&&(this._nextCanvasIndex=(this._nextCanvasIndex+1)%this._canvasPool.length);let i=e.getContext("2d",{alpha:!1});m(i),i.resetTransform(),r||i.clearRect(0,0,this._width,this._height),t.drawWithFit(i,{fit:this._fit,rotation:this._rotation});let a={canvas:e,timestamp:t.timestamp,duration:t.duration};return t.close(),a}async getCanvas(t){qe(t);let e=await this._videoSampleSink.getSample(t);return e&&this._videoSampleToWrappedCanvas(e)}canvases(t=0,e=1/0){return Qt(this._videoSampleSink.samples(t,e),r=>this._videoSampleToWrappedCanvas(r))}canvasesAtTimestamps(t){return Qt(this._videoSampleSink.samplesAtTimestamps(t),e=>e&&this._videoSampleToWrappedCanvas(e))}},Ri=class extends lr{constructor(e,r,i,a){super(e,r);this.decoder=null;this.customDecoder=null;this.customDecoderCallSerializer=new Qe;this.customDecoderQueueSize=0;this.currentTimestamp=null;let o=c=>{(this.currentTimestamp===null||Math.abs(c.timestamp-this.currentTimestamp)>=c.duration)&&(this.currentTimestamp=c.timestamp);let u=this.currentTimestamp;if(this.currentTimestamp+=c.duration,c.numberOfFrames===0){c.close();return}let d=a.sampleRate;c.setTimestamp(Math.round(u*d)/d),e(c)},s=Dt.find(c=>c.supports(i,a));s?(this.customDecoder=new s,this.customDecoder.codec=i,this.customDecoder.config=a,this.customDecoder.onSample=c=>{if(!(c instanceof he))throw new TypeError("The argument passed to onSample must be an AudioSample.");o(c)},this.customDecoderCallSerializer.call(()=>this.customDecoder.init())):(this.decoder=new AudioDecoder({output:c=>o(new he(c)),error:r}),this.decoder.configure(a))}getDecodeQueueSize(){return this.customDecoder?this.customDecoderQueueSize:(m(this.decoder),this.decoder.decodeQueueSize)}decode(e){this.customDecoder?(this.customDecoderQueueSize++,this.customDecoderCallSerializer.call(()=>this.customDecoder.decode(e)).then(()=>this.customDecoderQueueSize--)):(m(this.decoder),this.decoder.decode(e.toEncodedAudioChunk()))}flush(){return this.customDecoder?this.customDecoderCallSerializer.call(()=>this.customDecoder.flush()):(m(this.decoder),this.decoder.flush())}close(){this.customDecoder?this.customDecoderCallSerializer.call(()=>this.customDecoder.close()):(m(this.decoder),this.decoder.close())}},Bi=class extends lr{constructor(e,r,i){super(e,r);this.decoderConfig=i;this.currentTimestamp=null;m(K.includes(i.codec)),this.codec=i.codec;let{dataType:a,sampleSize:o,littleEndian:s}=ae(this.codec);switch(this.inputSampleSize=o,o){case 1:a==="unsigned"?this.readInputValue=(c,u)=>c.getUint8(u)-2**7:a==="signed"?this.readInputValue=(c,u)=>c.getInt8(u):a==="ulaw"?this.readInputValue=(c,u)=>xs(c.getUint8(u)):a==="alaw"?this.readInputValue=(c,u)=>Ps(c.getUint8(u)):m(!1);break;case 2:a==="unsigned"?this.readInputValue=(c,u)=>c.getUint16(u,s)-2**15:a==="signed"?this.readInputValue=(c,u)=>c.getInt16(u,s):m(!1);break;case 3:a==="unsigned"?this.readInputValue=(c,u)=>ui(c,u,s)-2**23:a==="signed"?this.readInputValue=(c,u)=>Ta(c,u,s):m(!1);break;case 4:a==="unsigned"?this.readInputValue=(c,u)=>c.getUint32(u,s)-2**31:a==="signed"?this.readInputValue=(c,u)=>c.getInt32(u,s):a==="float"?this.readInputValue=(c,u)=>c.getFloat32(u,s):m(!1);break;case 8:a==="float"?this.readInputValue=(c,u)=>c.getFloat64(u,s):m(!1);break;default:xe(o),m(!1)}switch(o){case 1:a==="ulaw"||a==="alaw"?(this.outputSampleSize=2,this.outputFormat="s16",this.writeOutputValue=(c,u,d)=>c.setInt16(u,d,!0)):(this.outputSampleSize=1,this.outputFormat="u8",this.writeOutputValue=(c,u,d)=>c.setUint8(u,d+2**7));break;case 2:this.outputSampleSize=2,this.outputFormat="s16",this.writeOutputValue=(c,u,d)=>c.setInt16(u,d,!0);break;case 3:this.outputSampleSize=4,this.outputFormat="s32",this.writeOutputValue=(c,u,d)=>c.setInt32(u,d<<8,!0);break;case 4:this.outputSampleSize=4,a==="float"?(this.outputFormat="f32",this.writeOutputValue=(c,u,d)=>c.setFloat32(u,d,!0)):(this.outputFormat="s32",this.writeOutputValue=(c,u,d)=>c.setInt32(u,d,!0));break;case 8:this.outputSampleSize=4,this.outputFormat="f32",this.writeOutputValue=(c,u,d)=>c.setFloat32(u,d,!0);break;default:xe(o),m(!1)}}getDecodeQueueSize(){return 0}decode(e){let r=H(e.data),i=e.byteLength/this.decoderConfig.numberOfChannels/this.inputSampleSize,a=i*this.decoderConfig.numberOfChannels*this.outputSampleSize,o=new ArrayBuffer(a),s=new DataView(o);for(let l=0;l<i*this.decoderConfig.numberOfChannels;l++){let f=l*this.inputSampleSize,p=l*this.outputSampleSize,h=this.readInputValue(r,f);this.writeOutputValue(s,p,h)}let c=i/this.decoderConfig.sampleRate;(this.currentTimestamp===null||Math.abs(e.timestamp-this.currentTimestamp)>=c)&&(this.currentTimestamp=e.timestamp);let u=this.currentTimestamp;this.currentTimestamp+=c;let d=new he({format:this.outputFormat,data:o,numberOfChannels:this.decoderConfig.numberOfChannels,sampleRate:this.decoderConfig.sampleRate,numberOfFrames:i,timestamp:u});this.onSample(d)}async flush(){}close(){}},ht=class extends mr{constructor(t){if(!(t instanceof re))throw new TypeError("audioTrack must be an InputAudioTrack.");super(),this._audioTrack=t}async _createDecoder(t,e){if(!await this._audioTrack.canDecode())throw new Error("This audio track cannot be decoded by this browser. Make sure to check decodability before using a track.");let r=this._audioTrack.codec,i=await this._audioTrack.getDecoderConfig();return m(r&&i),K.includes(i.codec)?new Bi(t,e,i):new Ri(t,e,r,i)}_createPacketSink(){return new Be(this._audioTrack)}async getSample(t){qe(t);for await(let e of this.mediaSamplesAtTimestamps([t]))return e;throw new Error("Internal error: Iterator returned nothing.")}samples(t=0,e=1/0){return this.mediaSamplesInRange(t,e)}samplesAtTimestamps(t){return this.mediaSamplesAtTimestamps(t)}},Di=class{constructor(t){if(!(t instanceof re))throw new TypeError("audioTrack must be an InputAudioTrack.");this._audioSampleSink=new ht(t)}_audioSampleToWrappedArrayBuffer(t){return{buffer:t.toAudioBuffer(),timestamp:t.timestamp,duration:t.duration}}async getBuffer(t){qe(t);let e=await this._audioSampleSink.getSample(t);return e&&this._audioSampleToWrappedArrayBuffer(e)}buffers(t=0,e=1/0){return Qt(this._audioSampleSink.samples(t,e),r=>this._audioSampleToWrappedArrayBuffer(r))}buffersAtTimestamps(t){return Qt(this._audioSampleSink.samplesAtTimestamps(t),e=>e&&this._audioSampleToWrappedArrayBuffer(e))}};var gt=class{constructor(t){this._backing=t}isVideoTrack(){return this instanceof Ce}isAudioTrack(){return this instanceof re}get id(){return this._backing.getId()}get internalCodecId(){return this._backing.getInternalCodecId()}get languageCode(){return this._backing.getLanguageCode()}get name(){return this._backing.getName()}get timeResolution(){return this._backing.getTimeResolution()}getFirstTimestamp(){return this._backing.getFirstTimestamp()}computeDuration(){return this._backing.computeDuration()}async computePacketStats(t=1/0){let e=new Be(this),r=1/0,i=-1/0,a=0,o=0;for await(let s of e.packets(void 0,void 0,{metadataOnly:!0})){if(a>=t&&s.timestamp>=i)break;r=Math.min(r,s.timestamp),i=Math.max(i,s.timestamp+s.duration),a++,o+=s.byteLength}return{packetCount:a,averagePacketRate:a?Number((a/(i-r)).toPrecision(16)):0,averageBitrate:a?Number((8*o/(i-r)).toPrecision(16)):0}}},Ce=class extends gt{constructor(t){super(t),this._backing=t}get type(){return"video"}get codec(){return this._backing.getCodec()}get codedWidth(){return this._backing.getCodedWidth()}get codedHeight(){return this._backing.getCodedHeight()}get rotation(){return this._backing.getRotation()}get displayWidth(){return this._backing.getRotation()%180===0?this._backing.getCodedWidth():this._backing.getCodedHeight()}get displayHeight(){return this._backing.getRotation()%180===0?this._backing.getCodedHeight():this._backing.getCodedWidth()}getColorSpace(){return this._backing.getColorSpace()}async hasHighDynamicRange(){let t=await this._backing.getColorSpace();return t.primaries==="bt2020"||t.primaries==="smpte432"||t.transfer==="pg"||t.transfer==="hlg"||t.matrix==="bt2020-ncl"}getDecoderConfig(){return this._backing.getDecoderConfig()}async getCodecParameterString(){return(await this._backing.getDecoderConfig())?.codec??null}async canDecode(){try{let t=await this._backing.getDecoderConfig();if(!t)return!1;let e=this._backing.getCodec();return m(e!==null),Bt.some(i=>i.supports(e,t))?!0:typeof VideoDecoder>"u"?!1:(await VideoDecoder.isConfigSupported(t)).supported===!0}catch(t){return console.error("Error during decodability check:",t),!1}}async determinePacketType(t){if(!(t instanceof V))throw new TypeError("packet must be an EncodedPacket.");if(t.isMetadataOnly)throw new TypeError("packet must not be metadata-only to determine its type.");return this.codec===null?null:Qa(this,t)}},re=class extends gt{constructor(t){super(t),this._backing=t}get type(){return"audio"}get codec(){return this._backing.getCodec()}get numberOfChannels(){return this._backing.getNumberOfChannels()}get sampleRate(){return this._backing.getSampleRate()}getDecoderConfig(){return this._backing.getDecoderConfig()}async getCodecParameterString(){return(await this._backing.getDecoderConfig())?.codec??null}async canDecode(){try{let t=await this._backing.getDecoderConfig();if(!t)return!1;let e=this._backing.getCodec();return m(e!==null),Dt.some(r=>r.supports(e,t))||t.codec.startsWith("pcm-")?!0:typeof AudioDecoder>"u"?!1:(await AudioDecoder.isConfigSupported(t)).supported===!0}catch(t){return console.error("Error during decodability check:",t),!1}}async determinePacketType(t){if(!(t instanceof V))throw new TypeError("packet must be an EncodedPacket.");return this.codec===null?null:"key"}};var Fn=class extends fe{constructor(e){super(e);this.metadataPromise=null;this.dataStart=-1;this.dataSize=-1;this.audioInfo=null;this.tracks=[];this.lastKnownPacketIndex=0;this.reader=e._reader}async readMetadata(){return this.metadataPromise??=(async()=>{let e=this.reader.requestSlice(0,12);e instanceof Promise&&(e=await e),m(e);let r=ie(e,4),i=r!=="RIFX",a=r==="RF64",o=Je(e,i),s=a?this.reader.fileSize:Math.min(o+8,this.reader.fileSize??1/0);if(ie(e,4)!=="WAVE")throw new Error("Invalid WAVE file - wrong format");let u=0,d=null,l=e.filePos;for(;s===null||l<s;){let p=this.reader.requestSlice(l,8);if(p instanceof Promise&&(p=await p),!p)break;let h=ie(p,4),b=Je(p,i),g=p.filePos;if(a&&u===0&&h!=="ds64")throw new Error('Invalid RF64 file: First chunk must be "ds64".');if(h==="fmt ")await this.parseFmtChunk(g,b,i);else if(h==="data")d??=b,this.dataStart=p.filePos,this.dataSize=Math.min(d,(s??1/0)-this.dataStart);else if(h==="ds64"){let T=xi(p,i);d=xi(p,i),s=Math.min(T+8,this.reader.fileSize??1/0)}l=g+b+(b&1),u++}if(!this.audioInfo)throw new Error('Invalid WAVE file - missing "fmt " chunk');if(this.dataStart===-1)throw new Error('Invalid WAVE file - missing "data" chunk');let f=this.audioInfo.blockSizeInBytes;this.dataSize=Math.floor(this.dataSize/f)*f,this.tracks.push(new re(new zi(this)))})()}async parseFmtChunk(e,r,i){let a=this.reader.requestSlice(e,r);if(a instanceof Promise&&(a=await a),!a)return;let o=Ct(a,i),s=Ct(a,i),c=Je(a,i);a.skip(4);let u=Ct(a,i),d;if(r===14?d=8:d=Ct(a,i),r>=18&&o!==357){let l=Ct(a,i),f=r-18;if(Math.min(f,l)>=22&&o===65534){a.skip(6);let h=W(a,16);o=h[0]|h[1]<<8}}(o===7||o===6)&&(d=8),this.audioInfo={format:o,numberOfChannels:s,sampleRate:c,sampleSizeInBytes:Math.ceil(d/8),blockSizeInBytes:u}}getCodec(){if(m(this.audioInfo),this.audioInfo.format===7)return"ulaw";if(this.audioInfo.format===6)return"alaw";if(this.audioInfo.format===1){if(this.audioInfo.sampleSizeInBytes===1)return"pcm-u8";if(this.audioInfo.sampleSizeInBytes===2)return"pcm-s16";if(this.audioInfo.sampleSizeInBytes===3)return"pcm-s24";if(this.audioInfo.sampleSizeInBytes===4)return"pcm-s32"}return this.audioInfo.format===3&&this.audioInfo.sampleSizeInBytes===4?"pcm-f32":null}async getMimeType(){return"audio/wav"}async computeDuration(){await this.readMetadata();let e=this.tracks[0];return m(e),e.computeDuration()}async getTracks(){return await this.readMetadata(),this.tracks}},Vt=2048,zi=class{constructor(t){this.demuxer=t}getId(){return 1}getCodec(){return this.demuxer.getCodec()}getInternalCodecId(){return m(this.demuxer.audioInfo),this.demuxer.audioInfo.format}async getDecoderConfig(){let t=this.demuxer.getCodec();return t?(m(this.demuxer.audioInfo),{codec:t,numberOfChannels:this.demuxer.audioInfo.numberOfChannels,sampleRate:this.demuxer.audioInfo.sampleRate}):null}async computeDuration(){let t=await this.getPacket(1/0,{metadataOnly:!0});return(t?.timestamp??0)+(t?.duration??0)}getNumberOfChannels(){return m(this.demuxer.audioInfo),this.demuxer.audioInfo.numberOfChannels}getSampleRate(){return m(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getTimeResolution(){return m(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getName(){return null}getLanguageCode(){return Z}async getFirstTimestamp(){return 0}async getPacketAtIndex(t,e){m(this.demuxer.audioInfo);let r=t*Vt*this.demuxer.audioInfo.blockSizeInBytes;if(r>=this.demuxer.dataSize)return null;let i=Math.min(Vt*this.demuxer.audioInfo.blockSizeInBytes,this.demuxer.dataSize-r);if(this.demuxer.reader.fileSize===null){let c=this.demuxer.reader.requestSlice(this.demuxer.dataStart+r,i);if(c instanceof Promise&&(c=await c),!c)return null}let a;if(e.metadataOnly)a=ce;else{let c=this.demuxer.reader.requestSlice(this.demuxer.dataStart+r,i);c instanceof Promise&&(c=await c),m(c),a=W(c,i)}let o=t*Vt/this.demuxer.audioInfo.sampleRate,s=i/this.demuxer.audioInfo.blockSizeInBytes/this.demuxer.audioInfo.sampleRate;return this.demuxer.lastKnownPacketIndex=Math.max(t,o),new V(a,"key",o,s,t,i)}getFirstPacket(t){return this.getPacketAtIndex(0,t)}async getPacket(t,e){m(this.demuxer.audioInfo);let r=Math.floor(Math.min(t*this.demuxer.audioInfo.sampleRate/Vt,(this.demuxer.dataSize-1)/(Vt*this.demuxer.audioInfo.blockSizeInBytes))),i=await this.getPacketAtIndex(r,e);if(i)return i;if(r===0)return null;m(this.demuxer.reader.fileSize===null);let a=await this.getPacketAtIndex(this.demuxer.lastKnownPacketIndex,e);for(;a;){let o=await this.getNextPacket(a,e);if(!o)break;a=o}return a}getNextPacket(t,e){m(this.demuxer.audioInfo);let r=Math.round(t.timestamp*this.demuxer.audioInfo.sampleRate/Vt);return this.getPacketAtIndex(r+1,e)}getKeyPacket(t,e){return this.getPacket(t,e)}getNextKeyPacket(t,e){return this.getNextPacket(t,e)}};var Mn=class{constructor(t){this.writer=t;this.helper=new Uint8Array(8);this.helperView=new DataView(this.helper.buffer)}writeU16(t){this.helperView.setUint16(0,t,!0),this.writer.write(this.helper.subarray(0,2))}writeU32(t){this.helperView.setUint32(0,t,!0),this.writer.write(this.helper.subarray(0,4))}writeU64(t){this.helperView.setUint32(0,t,!0),this.helperView.setUint32(4,Math.floor(t/2**32),!0),this.writer.write(this.helper)}writeAscii(t){this.writer.write(new TextEncoder().encode(t))}};var On=class extends le{constructor(e,r){super(e);this.headerWritten=!1;this.dataSize=0;this.sampleRate=null;this.sampleCount=0;this.format=r,this.writer=e._writer,this.riffWriter=new Mn(e._writer),this.isRf64=!!r._options.large}async start(){}async getMimeType(){return"audio/wav"}async addEncodedVideoPacket(){throw new Error("WAVE does not support video.")}async addEncodedAudioPacket(e,r,i){let a=await this.mutex.acquire();try{if(this.headerWritten||(Ie(i),m(i),m(i.decoderConfig),this.writeHeader(e,i.decoderConfig),this.sampleRate=i.decoderConfig.sampleRate,this.headerWritten=!0),this.validateAndNormalizeTimestamp(e,r.timestamp,r.type==="key"),!this.isRf64&&this.writer.getPos()+r.data.byteLength>=2**32)throw new Error("Adding more audio data would exceed the maximum RIFF size of 4 GiB. To write larger files, use RF64 by setting `large: true` in the WavOutputFormatOptions.");this.writer.write(r.data),this.dataSize+=r.data.byteLength,this.sampleCount+=Math.round(r.duration*this.sampleRate),await this.writer.flush()}finally{a()}}async addSubtitleCue(){throw new Error("WAVE does not support subtitles.")}writeHeader(e,r){this.format._options.onHeader&&this.writer.startTrackingWrites();let i,a=e.source._codec,o=ae(a);o.dataType==="ulaw"?i=7:o.dataType==="alaw"?i=6:o.dataType==="float"?i=3:i=1;let s=r.numberOfChannels,c=r.sampleRate,u=o.sampleSize*s;if(this.riffWriter.writeAscii(this.isRf64?"RF64":"RIFF"),this.isRf64?this.riffWriter.writeU32(4294967295):this.riffWriter.writeU32(0),this.riffWriter.writeAscii("WAVE"),this.isRf64&&(this.riffWriter.writeAscii("ds64"),this.riffWriter.writeU32(28),this.riffWriter.writeU64(0),this.riffWriter.writeU64(0),this.riffWriter.writeU64(0),this.riffWriter.writeU32(0)),this.riffWriter.writeAscii("fmt "),this.riffWriter.writeU32(16),this.riffWriter.writeU16(i),this.riffWriter.writeU16(s),this.riffWriter.writeU32(c),this.riffWriter.writeU32(c*u),this.riffWriter.writeU16(u),this.riffWriter.writeU16(8*o.sampleSize),this.riffWriter.writeAscii("data"),this.isRf64?this.riffWriter.writeU32(4294967295):this.riffWriter.writeU32(0),this.format._options.onHeader){let{data:d,start:l}=this.writer.stopTrackingWrites();this.format._options.onHeader(d,l)}}async finalize(){let e=await this.mutex.acquire(),r=this.writer.getPos();this.isRf64?(this.writer.seek(20),this.riffWriter.writeU64(r-8),this.writer.seek(28),this.riffWriter.writeU64(this.dataSize),this.writer.seek(36),this.riffWriter.writeU64(this.sampleCount)):(this.writer.seek(4),this.riffWriter.writeU32(r-8),this.writer.seek(40),this.riffWriter.writeU32(this.dataSize)),this.writer.seek(r),e()}};var Pe=class{getSupportedVideoCodecs(){return this.getSupportedCodecs().filter(t=>ee.includes(t))}getSupportedAudioCodecs(){return this.getSupportedCodecs().filter(t=>ne.includes(t))}getSupportedSubtitleCodecs(){return this.getSupportedCodecs().filter(t=>ge.includes(t))}_codecUnsupportedHint(t){return""}},pr=class extends Pe{constructor(t={}){if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.fastStart!==void 0&&![!1,"in-memory","fragmented"].includes(t.fastStart))throw new TypeError('options.fastStart, when provided, must be false, "in-memory", or "fragmented".');if(t.minimumFragmentDuration!==void 0&&(!Number.isFinite(t.minimumFragmentDuration)||t.minimumFragmentDuration<0))throw new TypeError("options.minimumFragmentDuration, when provided, must be a non-negative number.");if(t.onFtyp!==void 0&&typeof t.onFtyp!="function")throw new TypeError("options.onFtyp, when provided, must be a function.");if(t.onMoov!==void 0&&typeof t.onMoov!="function")throw new TypeError("options.onMoov, when provided, must be a function.");if(t.onMdat!==void 0&&typeof t.onMdat!="function")throw new TypeError("options.onMdat, when provided, must be a function.");if(t.onMoof!==void 0&&typeof t.onMoof!="function")throw new TypeError("options.onMoof, when provided, must be a function.");super(),this._options=t}getSupportedTrackCounts(){return{video:{min:0,max:1/0},audio:{min:0,max:1/0},subtitle:{min:0,max:1/0},total:{min:1,max:2**32-1}}}get supportsVideoRotationMetadata(){return!0}_createMuxer(t){return new cn(t,this)}},Ut=class extends pr{constructor(t){super(t)}get _name(){return"MP4"}get fileExtension(){return".mp4"}get mimeType(){return"video/mp4"}getSupportedCodecs(){return[...ee,...Ne,"pcm-s16","pcm-s16be","pcm-s24","pcm-s24be","pcm-s32","pcm-s32be","pcm-f32","pcm-f32be","pcm-f64","pcm-f64be",...ge]}_codecUnsupportedHint(t){return new vt().getSupportedCodecs().includes(t)?" Switching to MOV will grant support for this codec.":""}},vt=class extends pr{constructor(t){super(t)}get _name(){return"MOV"}get fileExtension(){return".mov"}get mimeType(){return"video/quicktime"}getSupportedCodecs(){return[...ee,...ne]}_codecUnsupportedHint(t){return new Ut().getSupportedCodecs().includes(t)?" Switching to MP4 will grant support for this codec.":""}},hr=class extends Pe{constructor(t={}){if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.appendOnly!==void 0&&typeof t.appendOnly!="boolean")throw new TypeError("options.appendOnly, when provided, must be a boolean.");if(t.minimumClusterDuration!==void 0&&(!Number.isFinite(t.minimumClusterDuration)||t.minimumClusterDuration<0))throw new TypeError("options.minimumClusterDuration, when provided, must be a non-negative number.");if(t.onEbmlHeader!==void 0&&typeof t.onEbmlHeader!="function")throw new TypeError("options.onEbmlHeader, when provided, must be a function.");if(t.onSegmentHeader!==void 0&&typeof t.onSegmentHeader!="function")throw new TypeError("options.onHeader, when provided, must be a function.");if(t.onCluster!==void 0&&typeof t.onCluster!="function")throw new TypeError("options.onCluster, when provided, must be a function.");super(),this._options=t}_createMuxer(t){return new hn(t,this)}get _name(){return"Matroska"}getSupportedTrackCounts(){return{video:{min:0,max:1/0},audio:{min:0,max:1/0},subtitle:{min:0,max:1/0},total:{min:1,max:127}}}get fileExtension(){return".mkv"}get mimeType(){return"video/x-matroska"}getSupportedCodecs(){return[...ee,...Ne,...K.filter(t=>!["pcm-s8","pcm-f32be","pcm-f64be","ulaw","alaw"].includes(t)),...ge]}get supportsVideoRotationMetadata(){return!1}},Ft=class extends hr{constructor(t){super(t)}getSupportedCodecs(){return[...ee.filter(t=>["vp8","vp9","av1"].includes(t)),...ne.filter(t=>["opus","vorbis"].includes(t)),...ge]}get _name(){return"WebM"}get fileExtension(){return".webm"}get mimeType(){return"video/webm"}_codecUnsupportedHint(t){return new hr().getSupportedCodecs().includes(t)?" Switching to MKV will grant support for this codec.":""}},Vi=class extends Pe{constructor(t={}){if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.xingHeader!==void 0&&typeof t.xingHeader!="boolean")throw new TypeError("options.xingHeader, when provided, must be a boolean.");if(t.onXingFrame!==void 0&&typeof t.onXingFrame!="function")throw new TypeError("options.onXingFrame, when provided, must be a function.");super(),this._options=t}_createMuxer(t){return new yn(t,this)}get _name(){return"MP3"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:1,max:1},subtitle:{min:0,max:0},total:{min:1,max:1}}}get fileExtension(){return".mp3"}get mimeType(){return"audio/mpeg"}getSupportedCodecs(){return["mp3"]}get supportsVideoRotationMetadata(){return!1}},Ui=class extends Pe{constructor(t={}){if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.large!==void 0&&typeof t.large!="boolean")throw new TypeError("options.large, when provided, must be a boolean.");if(t.onHeader!==void 0&&typeof t.onHeader!="function")throw new TypeError("options.onHeader, when provided, must be a function.");super(),this._options=t}_createMuxer(t){return new On(t,this)}get _name(){return"WAVE"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:1,max:1},subtitle:{min:0,max:0},total:{min:1,max:1}}}get fileExtension(){return".wav"}get mimeType(){return"audio/wav"}getSupportedCodecs(){return[...K.filter(t=>["pcm-s16","pcm-s24","pcm-s32","pcm-f32","pcm-u8","ulaw","alaw"].includes(t))]}get supportsVideoRotationMetadata(){return!1}},Wi=class extends Pe{constructor(t={}){if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.onPage!==void 0&&typeof t.onPage!="function")throw new TypeError("options.onPage, when provided, must be a function.");super(),this._options=t}_createMuxer(t){return new Pn(t,this)}get _name(){return"Ogg"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:0,max:1/0},subtitle:{min:0,max:0},total:{min:1,max:2**32}}}get fileExtension(){return".ogg"}get mimeType(){return"application/ogg"}getSupportedCodecs(){return[...ne.filter(t=>["vorbis","opus"].includes(t))]}get supportsVideoRotationMetadata(){return!1}},Ni=class extends Pe{constructor(t={}){if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.onFrame!==void 0&&typeof t.onFrame!="function")throw new TypeError("options.onFrame, when provided, must be a function.");super(),this._options=t}_createMuxer(t){return new Lr(t,this)}get _name(){return"ADTS"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:1,max:1},subtitle:{min:0,max:0},total:{min:1,max:1}}}get fileExtension(){return".aac"}get mimeType(){return"audio/aac"}getSupportedCodecs(){return["aac"]}get supportsVideoRotationMetadata(){return!1}};var Dn=n=>{if(!n||typeof n!="object")throw new TypeError("Encoding config must be an object.");if(!ee.includes(n.codec))throw new TypeError(`Invalid video codec '${n.codec}'. Must be one of: ${ee.join(", ")}.`);if(!(n.bitrate instanceof se)&&(!Number.isInteger(n.bitrate)||n.bitrate<=0))throw new TypeError("config.bitrate must be a positive integer or a quality.");if(n.keyFrameInterval!==void 0&&(!Number.isFinite(n.keyFrameInterval)||n.keyFrameInterval<0))throw new TypeError("config.keyFrameInterval, when provided, must be a non-negative number.");if(n.sizeChangeBehavior!==void 0&&!["deny","passThrough","fill","contain","cover"].includes(n.sizeChangeBehavior))throw new TypeError("config.sizeChangeBehavior, when provided, must be 'deny', 'passThrough', 'fill', 'contain' or 'cover'.");if(n.onEncodedPacket!==void 0&&typeof n.onEncodedPacket!="function")throw new TypeError("config.onEncodedChunk, when provided, must be a function.");if(n.onEncoderConfig!==void 0&&typeof n.onEncoderConfig!="function")throw new TypeError("config.onEncoderConfig, when provided, must be a function.");Es(n.codec,n)},Es=(n,t)=>{if(!t||typeof t!="object")throw new TypeError("Encoding options must be an object.");if(t.bitrateMode!==void 0&&!["constant","variable"].includes(t.bitrateMode))throw new TypeError("bitrateMode, when provided, must be 'constant' or 'variable'.");if(t.latencyMode!==void 0&&!["quality","realtime"].includes(t.latencyMode))throw new TypeError("latencyMode, when provided, must be 'quality' or 'realtime'.");if(t.fullCodecString!==void 0&&typeof t.fullCodecString!="string")throw new TypeError("fullCodecString, when provided, must be a string.");if(t.fullCodecString!==void 0&&fi(t.fullCodecString)!==n)throw new TypeError(`fullCodecString, when provided, must be a string that matches the specified codec (${n}).`);if(t.hardwareAcceleration!==void 0&&!["no-preference","prefer-hardware","prefer-software"].includes(t.hardwareAcceleration))throw new TypeError("hardwareAcceleration, when provided, must be 'no-preference', 'prefer-hardware' or 'prefer-software'.");if(t.scalabilityMode!==void 0&&typeof t.scalabilityMode!="string")throw new TypeError("scalabilityMode, when provided, must be a string.");if(t.contentHint!==void 0&&typeof t.contentHint!="string")throw new TypeError("contentHint, when provided, must be a string.")},Rn=n=>{let t=n.bitrate instanceof se?n.bitrate._toVideoBitrate(n.codec,n.width,n.height):n.bitrate;return{codec:n.fullCodecString??Fa(n.codec,n.width,n.height,t),width:n.width,height:n.height,bitrate:t,bitrateMode:n.bitrateMode,framerate:n.framerate,latencyMode:n.latencyMode,hardwareAcceleration:n.hardwareAcceleration,scalabilityMode:n.scalabilityMode,contentHint:n.contentHint,...Ba(n.codec)}},zn=n=>{if(!n||typeof n!="object")throw new TypeError("Encoding config must be an object.");if(!ne.includes(n.codec))throw new TypeError(`Invalid audio codec '${n.codec}'. Must be one of: ${ne.join(", ")}.`);if(n.bitrate===void 0&&(!K.includes(n.codec)||n.codec==="flac"))throw new TypeError("config.bitrate must be provided for compressed audio codecs.");if(n.bitrate!==void 0&&!(n.bitrate instanceof se)&&(!Number.isInteger(n.bitrate)||n.bitrate<=0))throw new TypeError("config.bitrate, when provided, must be a positive integer or a quality.");if(n.onEncodedPacket!==void 0&&typeof n.onEncodedPacket!="function")throw new TypeError("config.onEncodedChunk, when provided, must be a function.");if(n.onEncoderConfig!==void 0&&typeof n.onEncoderConfig!="function")throw new TypeError("config.onEncoderConfig, when provided, must be a function.");_s(n.codec,n)},_s=(n,t)=>{if(!t||typeof t!="object")throw new TypeError("Encoding options must be an object.");if(t.bitrateMode!==void 0&&!["constant","variable"].includes(t.bitrateMode))throw new TypeError("bitrateMode, when provided, must be 'constant' or 'variable'.");if(t.fullCodecString!==void 0&&typeof t.fullCodecString!="string")throw new TypeError("fullCodecString, when provided, must be a string.");if(t.fullCodecString!==void 0&&fi(t.fullCodecString)!==n)throw new TypeError(`fullCodecString, when provided, must be a string that matches the specified codec (${n}).`)},Bn=n=>{let t=n.bitrate instanceof se?n.bitrate._toAudioBitrate(n.codec):n.bitrate;return{codec:n.fullCodecString??Oa(n.codec,n.numberOfChannels,n.sampleRate),numberOfChannels:n.numberOfChannels,sampleRate:n.sampleRate,bitrate:t,bitrateMode:n.bitrateMode,...Da(n.codec)}},se=class{constructor(t){this._factor=t}_toVideoBitrate(t,e,r){let i=e*r,a={avc:1,hevc:.6,vp9:.6,av1:.4,vp8:1.2},o=1920*1080,s=3e6,c=Math.pow(i/o,.95),l=s*c*a[t]*this._factor;return Math.ceil(l/1e3)*1e3}_toAudioBitrate(t){if(K.includes(t)||t==="flac")return;let r={aac:128e3,opus:64e3,mp3:16e4,vorbis:64e3}[t];if(!r)throw new Error(`Unhandled codec: ${t}`);let i=r*this._factor;return t==="aac"?i=[96e3,128e3,16e4,192e3].reduce((o,s)=>Math.abs(s-i)<Math.abs(o-i)?s:o):t==="opus"||t==="vorbis"?i=Math.max(6e3,i):t==="mp3"&&(i=[8e3,16e3,24e3,32e3,4e4,48e3,64e3,8e4,96e3,112e3,128e3,16e4,192e3,224e3,256e3,32e4].reduce((o,s)=>Math.abs(s-i)<Math.abs(o-i)?s:o)),Math.round(i/1e3)*1e3}},_c=new se(.3),Ic=new se(.6),Ac=new se(1),Vn=new se(2),Fc=new se(4),Mc=n=>{if(ee.includes(n))return Un(n);if(ne.includes(n))return Wn(n);if(ge.includes(n))return Nn(n);throw new TypeError(`Unknown codec '${n}'.`)},Un=async(n,t={})=>{let{width:e=1280,height:r=720,bitrate:i=1e6,...a}=t;if(!ee.includes(n))return!1;if(!Number.isInteger(e)||e<=0)throw new TypeError("width must be a positive integer.");if(!Number.isInteger(r)||r<=0)throw new TypeError("height must be a positive integer.");if(!(i instanceof se)&&(!Number.isInteger(i)||i<=0))throw new TypeError("bitrate must be a positive integer or a quality.");Es(n,a);let o=null;return mt.length>0&&(o??=Rn({codec:n,width:e,height:r,bitrate:i,framerate:void 0,...a}),mt.some(c=>c.supports(n,o)))?!0:typeof VideoEncoder>"u"?!1:(o??=Rn({codec:n,width:e,height:r,bitrate:i,framerate:void 0,...a}),(await VideoEncoder.isConfigSupported(o)).supported===!0)},Wn=async(n,t={})=>{let{numberOfChannels:e=2,sampleRate:r=48e3,bitrate:i=128e3,...a}=t;if(!ne.includes(n))return!1;if(!Number.isInteger(e)||e<=0)throw new TypeError("numberOfChannels must be a positive integer.");if(!Number.isInteger(r)||r<=0)throw new TypeError("sampleRate must be a positive integer.");if(!(i instanceof se)&&(!Number.isInteger(i)||i<=0))throw new TypeError("bitrate must be a positive integer.");_s(n,a);let o=null;return ft.length>0&&(o??=Bn({codec:n,numberOfChannels:e,sampleRate:r,bitrate:i,...a}),ft.some(c=>c.supports(n,o)))||K.includes(n)?!0:typeof AudioEncoder>"u"?!1:(o??=Bn({codec:n,numberOfChannels:e,sampleRate:r,bitrate:i,...a}),(await AudioEncoder.isConfigSupported(o)).supported===!0)},Nn=async n=>!!ge.includes(n),Oc=async()=>{let[n,t,e]=await Promise.all([Is(),gr(),As()]);return[...n,...t,...e]},Is=async(n=ee,t)=>{let e=await Promise.all(n.map(r=>Un(r,t)));return n.filter((r,i)=>e[i])},gr=async(n=ne,t)=>{let e=await Promise.all(n.map(r=>Wn(r,t)));return n.filter((r,i)=>e[i])},As=async(n=ge)=>{let t=await Promise.all(n.map(Nn));return n.filter((e,r)=>t[r])},Li=async(n,t)=>{for(let e of n)if(await Un(e,t))return e;return null},Rc=async(n,t)=>{for(let e of n)if(await Wn(e,t))return e;return null},Bc=async n=>{for(let t of n)if(await Nn(t))return t;return null};var Wt=class{constructor(){this._connectedTrack=null;this._closingPromise=null;this._closed=!1;this._timestampOffset=0}_ensureValidAdd(){if(!this._connectedTrack)throw new Error("Source is not connected to an output track.");if(this._connectedTrack.output.state==="canceled")throw new Error("Output has been canceled.");if(this._connectedTrack.output.state==="finalizing"||this._connectedTrack.output.state==="finalized")throw new Error("Output has been finalized.");if(this._connectedTrack.output.state==="pending")throw new Error("Output has not started.");if(this._closed)throw new Error("Source is closed.")}async _start(){}async _flushAndClose(t){}close(){if(this._closingPromise)return;let t=this._connectedTrack;if(!t)throw new Error("Cannot call close without connecting the source to an output track.");if(t.output.state==="pending")throw new Error("Cannot call close before output has been started.");this._closingPromise=(async()=>{await this._flushAndClose(!1),this._closed=!0,!(t.output.state==="finalizing"||t.output.state==="finalized")&&t.output._muxer.onTrackClose(t)})()}async _flushOrWaitForOngoingClose(t){return this._closingPromise?this._closingPromise:this._flushAndClose(t)}},Ke=class extends Wt{constructor(e){super();this._connectedTrack=null;if(!ee.includes(e))throw new TypeError(`Invalid video codec '${e}'. Must be one of: ${ee.join(", ")}.`);this._codec=e}},br=class extends Ke{constructor(t){super(t)}add(t,e){if(!(t instanceof V))throw new TypeError("packet must be an EncodedPacket.");if(t.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be added.");if(e!==void 0&&(!e||typeof e!="object"))throw new TypeError("meta, when provided, must be an object.");return this._ensureValidAdd(),this._connectedTrack.output._muxer.addEncodedVideoPacket(this._connectedTrack,t,e)}},kr=class{constructor(t,e){this.source=t;this.encodingConfig=e;this.ensureEncoderPromise=null;this.encoderInitialized=!1;this.encoder=null;this.muxer=null;this.lastMultipleOfKeyFrameInterval=-1;this.codedWidth=null;this.codedHeight=null;this.resizeCanvas=null;this.customEncoder=null;this.customEncoderCallSerializer=new Qe;this.customEncoderQueueSize=0;this.encoderError=null}async add(t,e,r){try{if(this.checkForEncoderError(),this.source._ensureValidAdd(),this.codedWidth!==null&&this.codedHeight!==null){if(t.codedWidth!==this.codedWidth||t.codedHeight!==this.codedHeight){let s=this.encodingConfig.sizeChangeBehavior??"deny";if(s!=="passThrough"){if(s==="deny")throw new Error(`Video sample size must remain constant. Expected ${this.codedWidth}x${this.codedHeight}, got ${t.codedWidth}x${t.codedHeight}. To allow the sample size to change over time, set \`sizeChangeBehavior\` to a value other than 'strict' in the encoding options.`);{let c=!1;this.resizeCanvas||(typeof document<"u"?(this.resizeCanvas=document.createElement("canvas"),this.resizeCanvas.width=this.codedWidth,this.resizeCanvas.height=this.codedHeight):this.resizeCanvas=new OffscreenCanvas(this.codedWidth,this.codedHeight),c=!0);let u=this.resizeCanvas.getContext("2d",{alpha:!1});m(u),c||u.clearRect(0,0,this.codedWidth,this.codedHeight),t.drawWithFit(u,{fit:s}),e&&t.close(),t=new pe(this.resizeCanvas,{timestamp:t.timestamp,duration:t.duration,rotation:t.rotation}),e=!0}}}}else this.codedWidth=t.codedWidth,this.codedHeight=t.codedHeight;this.encoderInitialized||(this.ensureEncoderPromise||this.ensureEncoder(t),this.encoderInitialized||await this.ensureEncoderPromise),m(this.encoderInitialized);let i=this.encodingConfig.keyFrameInterval??5,a=Math.floor(t.timestamp/i),o={...r,keyFrame:r?.keyFrame||i===0||a!==this.lastMultipleOfKeyFrameInterval};if(this.lastMultipleOfKeyFrameInterval=a,this.customEncoder){this.customEncoderQueueSize++;let s=t.clone(),c=this.customEncoderCallSerializer.call(()=>this.customEncoder.encode(s,o)).then(()=>this.customEncoderQueueSize--).catch(u=>this.encoderError??=u).finally(()=>{s.close()});this.customEncoderQueueSize>=4&&await c}else{m(this.encoder);let s=t.toVideoFrame();this.encoder.encode(s,o),s.close(),e&&t.close(),this.encoder.encodeQueueSize>=4&&await new Promise(c=>this.encoder.addEventListener("dequeue",c,{once:!0}))}await this.muxer.mutex.currentPromise}finally{e&&t.close()}}async ensureEncoder(t){if(this.encoder)return;let e=new Error;return this.ensureEncoderPromise=(async()=>{let r=Rn({width:t.codedWidth,height:t.codedHeight,...this.encodingConfig,framerate:this.source._connectedTrack?.metadata.frameRate});this.encodingConfig.onEncoderConfig?.(r);let i=mt.find(a=>a.supports(this.encodingConfig.codec,r));if(i)this.customEncoder=new i,this.customEncoder.codec=this.encodingConfig.codec,this.customEncoder.config=r,this.customEncoder.onPacket=(a,o)=>{if(!(a instanceof V))throw new TypeError("The first argument passed to onPacket must be an EncodedPacket.");if(o!==void 0&&(!o||typeof o!="object"))throw new TypeError("The second argument passed to onPacket must be an object or undefined.");this.encodingConfig.onEncodedPacket?.(a,o),this.muxer.addEncodedVideoPacket(this.source._connectedTrack,a,o)},await this.customEncoder.init();else{if(typeof VideoEncoder>"u")throw new Error("VideoEncoder is not supported by this browser.");if(!(await VideoEncoder.isConfigSupported(r)).supported)throw new Error(`This specific encoder configuration (${r.codec}, ${r.bitrate} bps, ${r.width}x${r.height}, hardware acceleration: ${r.hardwareAcceleration??"no-preference"}) is not supported by this browser. Consider using another codec or changing your video parameters.`);this.encoder=new VideoEncoder({output:(o,s)=>{let c=V.fromEncodedChunk(o);this.encodingConfig.onEncodedPacket?.(c,s),this.muxer.addEncodedVideoPacket(this.source._connectedTrack,c,s)},error:o=>{o.stack=e.stack,this.encoderError??=o}}),this.encoder.configure(r)}m(this.source._connectedTrack),this.muxer=this.source._connectedTrack.output._muxer,this.encoderInitialized=!0})()}async flushAndClose(t){t||this.checkForEncoderError(),this.customEncoder?(t||this.customEncoderCallSerializer.call(()=>this.customEncoder.flush()),await this.customEncoderCallSerializer.call(()=>this.customEncoder.close())):this.encoder&&(t||await this.encoder.flush(),this.encoder.state!=="closed"&&this.encoder.close()),t||this.checkForEncoderError()}getQueueSize(){return this.customEncoder?this.customEncoderQueueSize:this.encoder?.encodeQueueSize??0}checkForEncoderError(){if(this.encoderError)throw this.encoderError.stack=new Error().stack,this.encoderError}},Nt=class extends Ke{constructor(t){Dn(t),super(t.codec),this._encoder=new kr(this,t)}add(t,e){if(!(t instanceof pe))throw new TypeError("videoSample must be a VideoSample.");return this._encoder.add(t,!1,e)}_flushAndClose(t){return this._encoder.flushAndClose(t)}},Ki=class extends Ke{constructor(t,e){if(!(typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement)&&!(typeof OffscreenCanvas<"u"&&t instanceof OffscreenCanvas))throw new TypeError("canvas must be an HTMLCanvasElement or OffscreenCanvas.");Dn(e),super(e.codec),this._encoder=new kr(this,e),this._canvas=t}add(t,e=0,r){if(!Number.isFinite(t)||t<0)throw new TypeError("timestamp must be a non-negative number.");if(!Number.isFinite(e)||e<0)throw new TypeError("duration must be a non-negative number.");let i=new pe(this._canvas,{timestamp:t,duration:e});return this._encoder.add(i,!0,r)}_flushAndClose(t){return this._encoder.flushAndClose(t)}},ji=class extends Ke{constructor(e,r){if(!(e instanceof MediaStreamTrack)||e.kind!=="video")throw new TypeError("track must be a video MediaStreamTrack.");Dn(r),r={...r,latencyMode:"realtime"};super(r.codec);this._abortController=null;this._workerTrackId=null;this._workerListener=null;this._promiseWithResolvers=q();this._errorPromiseAccessed=!1;this._encoder=new kr(this,r),this._track=e}get errorPromise(){return this._errorPromiseAccessed=!0,this._promiseWithResolvers.promise}async _start(){this._errorPromiseAccessed||console.warn("Make sure not to ignore the `errorPromise` field on MediaStreamVideoTrackSource, so that any internal errors get bubbled up properly."),this._abortController=new AbortController;let e=null,r=!1,i=a=>{if(r){a.close();return}if(e===null){e=a.timestamp/1e6;let o=this._connectedTrack.output._muxer;o.firstMediaStreamTimestamp===null?(o.firstMediaStreamTimestamp=performance.now()/1e3,this._timestampOffset=-e):this._timestampOffset=performance.now()/1e3-o.firstMediaStreamTimestamp-e}if(this._encoder.getQueueSize()>=4){a.close();return}this._encoder.add(new pe(a),!0).catch(o=>{r=!0,this._abortController?.abort(),this._promiseWithResolvers.reject(o),this._workerTrackId!==null&&qi({type:"stopTrack",trackId:this._workerTrackId})})};if(typeof MediaStreamTrackProcessor<"u"){let a=new MediaStreamTrackProcessor({track:this._track}),o=new WritableStream({write:i});a.readable.pipeTo(o,{signal:this._abortController.signal}).catch(s=>{s instanceof DOMException&&s.name==="AbortError"||this._promiseWithResolvers.reject(s)})}else if(await Uc())this._workerTrackId=zc++,qi({type:"videoTrack",trackId:this._workerTrackId,track:this._track},[this._track]),this._workerListener=o=>{let s=o.data;s.type==="videoFrame"&&s.trackId===this._workerTrackId?i(s.videoFrame):s.type==="error"&&s.trackId===this._workerTrackId&&this._promiseWithResolvers.reject(s.error)},Te.addEventListener("message",this._workerListener);else throw new Error("MediaStreamTrackProcessor is required but not supported by this browser.")}async _flushAndClose(e){this._abortController&&(this._abortController.abort(),this._abortController=null),this._workerTrackId!==null&&(m(this._workerListener),qi({type:"stopTrack",trackId:this._workerTrackId}),await new Promise(r=>{let i=a=>{let o=a.data;o.type==="trackStopped"&&o.trackId===this._workerTrackId&&(m(this._workerListener),Te.removeEventListener("message",this._workerListener),Te.removeEventListener("message",i),r())};Te.addEventListener("message",i)})),await this._encoder.flushAndClose(e)}},je=class extends Wt{constructor(e){super();this._connectedTrack=null;if(!ne.includes(e))throw new TypeError(`Invalid audio codec '${e}'. Must be one of: ${ne.join(", ")}.`);this._codec=e}},wr=class extends je{constructor(t){super(t)}add(t,e){if(!(t instanceof V))throw new TypeError("packet must be an EncodedPacket.");if(t.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be added.");if(e!==void 0&&(!e||typeof e!="object"))throw new TypeError("meta, when provided, must be an object.");return this._ensureValidAdd(),this._connectedTrack.output._muxer.addEncodedAudioPacket(this._connectedTrack,t,e)}},yr=class{constructor(t,e){this.source=t;this.encodingConfig=e;this.ensureEncoderPromise=null;this.encoderInitialized=!1;this.encoder=null;this.muxer=null;this.lastNumberOfChannels=null;this.lastSampleRate=null;this.isPcmEncoder=!1;this.outputSampleSize=null;this.writeOutputValue=null;this.customEncoder=null;this.customEncoderCallSerializer=new Qe;this.customEncoderQueueSize=0;this.encoderError=null}async add(t,e){try{if(this.checkForEncoderError(),this.source._ensureValidAdd(),this.lastNumberOfChannels!==null&&this.lastSampleRate!==null){if(t.numberOfChannels!==this.lastNumberOfChannels||t.sampleRate!==this.lastSampleRate)throw new Error(`Audio parameters must remain constant. Expected ${this.lastNumberOfChannels} channels at ${this.lastSampleRate} Hz, got ${t.numberOfChannels} channels at ${t.sampleRate} Hz.`)}else this.lastNumberOfChannels=t.numberOfChannels,this.lastSampleRate=t.sampleRate;if(this.encoderInitialized||(this.ensureEncoderPromise||this.ensureEncoder(t),this.encoderInitialized||await this.ensureEncoderPromise),m(this.encoderInitialized),this.customEncoder){this.customEncoderQueueSize++;let r=t.clone(),i=this.customEncoderCallSerializer.call(()=>this.customEncoder.encode(r)).then(()=>this.customEncoderQueueSize--).catch(a=>this.encoderError??=a).finally(()=>{r.close()});this.customEncoderQueueSize>=4&&await i,await this.muxer.mutex.currentPromise}else if(this.isPcmEncoder)await this.doPcmEncoding(t,e);else{m(this.encoder);let r=t.toAudioData();this.encoder.encode(r),r.close(),e&&t.close(),this.encoder.encodeQueueSize>=4&&await new Promise(i=>this.encoder.addEventListener("dequeue",i,{once:!0})),await this.muxer.mutex.currentPromise}}finally{e&&t.close()}}async doPcmEncoding(t,e){m(this.outputSampleSize),m(this.writeOutputValue);let{numberOfChannels:r,numberOfFrames:i,sampleRate:a,timestamp:o}=t,s=2048,c=[];for(let f=0;f<i;f+=s){let p=Math.min(s,t.numberOfFrames-f),h=p*r*this.outputSampleSize,b=new ArrayBuffer(h),g=new DataView(b);c.push({frameCount:p,view:g})}let u=t.allocationSize({planeIndex:0,format:"f32-planar"}),d=new Float32Array(u/Float32Array.BYTES_PER_ELEMENT);for(let f=0;f<r;f++){t.copyTo(d,{planeIndex:f,format:"f32-planar"});for(let p=0;p<c.length;p++){let{frameCount:h,view:b}=c[p];for(let g=0;g<h;g++)this.writeOutputValue(b,(g*r+f)*this.outputSampleSize,d[p*s+g])}}e&&t.close();let l={decoderConfig:{codec:this.encodingConfig.codec,numberOfChannels:r,sampleRate:a}};for(let f=0;f<c.length;f++){let{frameCount:p,view:h}=c[f],b=h.buffer,g=f*s,T=new V(new Uint8Array(b),"key",o+g/a,p/a);this.encodingConfig.onEncodedPacket?.(T,l),await this.muxer.addEncodedAudioPacket(this.source._connectedTrack,T,l)}}ensureEncoder(t){if(this.encoderInitialized)return;let e=new Error;return this.ensureEncoderPromise=(async()=>{let{numberOfChannels:r,sampleRate:i}=t,a=Bn({numberOfChannels:r,sampleRate:i,...this.encodingConfig});this.encodingConfig.onEncoderConfig?.(a);let o=ft.find(s=>s.supports(this.encodingConfig.codec,a));if(o)this.customEncoder=new o,this.customEncoder.codec=this.encodingConfig.codec,this.customEncoder.config=a,this.customEncoder.onPacket=(s,c)=>{if(!(s instanceof V))throw new TypeError("The first argument passed to onPacket must be an EncodedPacket.");if(c!==void 0&&(!c||typeof c!="object"))throw new TypeError("The second argument passed to onPacket must be an object or undefined.");this.encodingConfig.onEncodedPacket?.(s,c),this.muxer.addEncodedAudioPacket(this.source._connectedTrack,s,c)},await this.customEncoder.init();else if(K.includes(this.encodingConfig.codec))this.initPcmEncoder();else{if(typeof AudioEncoder>"u")throw new Error("AudioEncoder is not supported by this browser.");if(!(await AudioEncoder.isConfigSupported(a)).supported)throw new Error(`This specific encoder configuration (${a.codec}, ${a.bitrate} bps, ${a.numberOfChannels} channels, ${a.sampleRate} Hz) is not supported by this browser. Consider using another codec or changing your audio parameters.`);this.encoder=new AudioEncoder({output:(c,u)=>{let d=V.fromEncodedChunk(c);this.encodingConfig.onEncodedPacket?.(d,u),this.muxer.addEncodedAudioPacket(this.source._connectedTrack,d,u)},error:c=>{c.stack=e.stack,this.encoderError??=c}}),this.encoder.configure(a)}m(this.source._connectedTrack),this.muxer=this.source._connectedTrack.output._muxer,this.encoderInitialized=!0})()}initPcmEncoder(){this.isPcmEncoder=!0;let t=this.encodingConfig.codec,{dataType:e,sampleSize:r,littleEndian:i}=ae(t);switch(this.outputSampleSize=r,r){case 1:e==="unsigned"?this.writeOutputValue=(a,o,s)=>a.setUint8(o,Y((s+1)*127.5,0,255)):e==="signed"?this.writeOutputValue=(a,o,s)=>{a.setInt8(o,Y(Math.round(s*128),-128,127))}:e==="ulaw"?this.writeOutputValue=(a,o,s)=>{let c=Y(Math.floor(s*32767),-32768,32767);a.setUint8(o,Ss(c))}:e==="alaw"?this.writeOutputValue=(a,o,s)=>{let c=Y(Math.floor(s*32767),-32768,32767);a.setUint8(o,Cs(c))}:m(!1);break;case 2:e==="unsigned"?this.writeOutputValue=(a,o,s)=>a.setUint16(o,Y((s+1)*32767.5,0,65535),i):e==="signed"?this.writeOutputValue=(a,o,s)=>a.setInt16(o,Y(Math.round(s*32767),-32768,32767),i):m(!1);break;case 3:e==="unsigned"?this.writeOutputValue=(a,o,s)=>di(a,o,Y((s+1)*83886075e-1,0,16777215),i):e==="signed"?this.writeOutputValue=(a,o,s)=>Sa(a,o,Y(Math.round(s*8388607),-8388608,8388607),i):m(!1);break;case 4:e==="unsigned"?this.writeOutputValue=(a,o,s)=>a.setUint32(o,Y((s+1)*21474836475e-1,0,4294967295),i):e==="signed"?this.writeOutputValue=(a,o,s)=>a.setInt32(o,Y(Math.round(s*2147483647),-2147483648,2147483647),i):e==="float"?this.writeOutputValue=(a,o,s)=>a.setFloat32(o,s,i):m(!1);break;case 8:e==="float"?this.writeOutputValue=(a,o,s)=>a.setFloat64(o,s,i):m(!1);break;default:xe(r),m(!1)}}async flushAndClose(t){t||this.checkForEncoderError(),this.customEncoder?(t||this.customEncoderCallSerializer.call(()=>this.customEncoder.flush()),await this.customEncoderCallSerializer.call(()=>this.customEncoder.close())):this.encoder&&(t||await this.encoder.flush(),this.encoder.state!=="closed"&&this.encoder.close()),t||this.checkForEncoderError()}getQueueSize(){return this.customEncoder?this.customEncoderQueueSize:this.isPcmEncoder?0:this.encoder?.encodeQueueSize??0}checkForEncoderError(){if(this.encoderError)throw this.encoderError.stack=new Error().stack,this.encoderError}},Lt=class extends je{constructor(t){zn(t),super(t.codec),this._encoder=new yr(this,t)}add(t){if(!(t instanceof he))throw new TypeError("audioSample must be an AudioSample.");return this._encoder.add(t,!1)}_flushAndClose(t){return this._encoder.flushAndClose(t)}},Qi=class extends je{constructor(e){zn(e);super(e.codec);this._accumulatedTime=0;this._encoder=new yr(this,e)}async add(e){if(!(e instanceof AudioBuffer))throw new TypeError("audioBuffer must be an AudioBuffer.");let r=he._fromAudioBuffer(e,this._accumulatedTime);this._accumulatedTime+=e.duration;for(let i of r)await this._encoder.add(i,!0)}_flushAndClose(e){return this._encoder.flushAndClose(e)}},$i=class extends je{constructor(e,r){if(!(e instanceof MediaStreamTrack)||e.kind!=="audio")throw new TypeError("track must be an audio MediaStreamTrack.");zn(r);super(r.codec);this._abortController=null;this._audioContext=null;this._scriptProcessorNode=null;this._promiseWithResolvers=q();this._errorPromiseAccessed=!1;this._encoder=new yr(this,r),this._track=e}get errorPromise(){return this._errorPromiseAccessed=!0,this._promiseWithResolvers.promise}async _start(){if(this._errorPromiseAccessed||console.warn("Make sure not to ignore the `errorPromise` field on MediaStreamVideoTrackSource, so that any internal errors get bubbled up properly."),this._abortController=new AbortController,typeof MediaStreamTrackProcessor<"u"){let e=null,r=new MediaStreamTrackProcessor({track:this._track}),i=new WritableStream({write:a=>{if(e===null){e=a.timestamp/1e6;let o=this._connectedTrack.output._muxer;o.firstMediaStreamTimestamp===null?(o.firstMediaStreamTimestamp=performance.now()/1e3,this._timestampOffset=-e):this._timestampOffset=performance.now()/1e3-o.firstMediaStreamTimestamp-e}if(this._encoder.getQueueSize()>=4){a.close();return}this._encoder.add(new he(a),!0).catch(o=>{this._abortController?.abort(),this._promiseWithResolvers.reject(o)})}});r.readable.pipeTo(i,{signal:this._abortController.signal}).catch(a=>{a instanceof DOMException&&a.name==="AbortError"||this._promiseWithResolvers.reject(a)})}else{let e=window.AudioContext||window.webkitAudioContext;this._audioContext=new e({sampleRate:this._track.getSettings().sampleRate});let r=this._audioContext.createMediaStreamSource(new MediaStream([this._track]));this._scriptProcessorNode=this._audioContext.createScriptProcessor(4096),this._audioContext.state==="suspended"&&await this._audioContext.resume(),r.connect(this._scriptProcessorNode),this._scriptProcessorNode.connect(this._audioContext.destination);let i=!1,a=0;this._scriptProcessorNode.onaudioprocess=o=>{let s=he._fromAudioBuffer(o.inputBuffer,a);a+=o.inputBuffer.duration;for(let c of s){if(!i){i=!0;let u=this._connectedTrack.output._muxer;u.firstMediaStreamTimestamp===null?u.firstMediaStreamTimestamp=performance.now()/1e3:this._timestampOffset=performance.now()/1e3-u.firstMediaStreamTimestamp}if(this._encoder.getQueueSize()>=4){c.close();continue}this._encoder.add(c,!0).catch(u=>{this._audioContext.suspend(),this._promiseWithResolvers.reject(u)})}}}}async _flushAndClose(e){this._abortController&&(this._abortController.abort(),this._abortController=null),this._audioContext&&(m(this._scriptProcessorNode),this._scriptProcessorNode.disconnect(),await this._audioContext.suspend()),await this._encoder.flushAndClose(e)}},Dc=()=>{let n=(r,i)=>{i?self.postMessage(r,{transfer:i}):self.postMessage(r)};n({type:"support",supported:typeof MediaStreamTrackProcessor<"u"});let t=new Map,e=new Set;self.addEventListener("message",r=>{let i=r.data;switch(i.type){case"videoTrack":{let a=new MediaStreamTrackProcessor({track:i.track}),o=new WritableStream({write:c=>{if(e.has(i.trackId)){c.close();return}n({type:"videoFrame",trackId:i.trackId,videoFrame:c},[c])}}),s=new AbortController;t.set(i.trackId,s),a.readable.pipeTo(o,{signal:s.signal}).catch(c=>{c instanceof DOMException&&c.name==="AbortError"||n({type:"error",trackId:i.trackId,error:c})})}break;case"stopTrack":{let a=t.get(i.trackId);a&&(a.abort(),t.delete(i.trackId)),e.add(i.trackId),n({type:"trackStopped",trackId:i.trackId})}break;default:xe(i)}})},zc=0,Te=null,Vc=()=>{let n=new Blob([`(${Dc.toString()})()`],{type:"application/javascript"}),t=URL.createObjectURL(n);Te=new Worker(t)},Hi=null,Uc=async()=>Hi!==null?Hi:(Te||Vc(),new Promise(n=>{m(Te);let t=e=>{let r=e.data;r.type==="support"&&(Hi=r.supported,Te.removeEventListener("message",t),n(r.supported))};Te.addEventListener("message",t)})),qi=(n,t)=>{m(Te),t?Te.postMessage(n,t):Te.postMessage(n)},Ht=class extends Wt{constructor(e){super();this._connectedTrack=null;if(!ge.includes(e))throw new TypeError(`Invalid subtitle codec '${e}'. Must be one of: ${ge.join(", ")}.`);this._codec=e}},Gi=class extends Ht{constructor(t){super(t),this._parser=new Hr({codec:t,output:(e,r)=>this._connectedTrack?.output._muxer.addSubtitleCue(this._connectedTrack,e,r)})}add(t){if(typeof t!="string")throw new TypeError("text must be a string.");return this._ensureValidAdd(),this._parser.parse(t),this._connectedTrack.output._muxer.mutex.currentPromise}};var Fs=["video","audio","subtitle"],Xi=n=>{if(!n||typeof n!="object")throw new TypeError("metadata must be an object.");if(n.languageCode!==void 0&&!Ue(n.languageCode))throw new TypeError("metadata.languageCode, when provided, must be a three-letter, ISO 639-2/T language code.");if(n.name!==void 0&&typeof n.name!="string")throw new TypeError("metadata.name, when provided, must be a string.")},qt=class{constructor(t){this.state="pending";this._tracks=[];this._startPromise=null;this._cancelPromise=null;this._finalizePromise=null;this._mutex=new oe;if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(!(t.format instanceof Pe))throw new TypeError("options.format must be an OutputFormat.");if(!(t.target instanceof Ze))throw new TypeError("options.target must be a Target.");if(t.target._output)throw new Error("Target is already used for another output.");t.target._output=this,this.format=t.format,this.target=t.target,this._writer=t.target._createWriter(),this._muxer=t.format._createMuxer(this)}addVideoTrack(t,e={}){if(!(t instanceof Ke))throw new TypeError("source must be a VideoSource.");if(Xi(e),e.rotation!==void 0&&![0,90,180,270].includes(e.rotation))throw new TypeError(`Invalid video rotation: ${e.rotation}. Has to be 0, 90, 180 or 270.`);if(!this.format.supportsVideoRotationMetadata&&e.rotation)throw new Error(`${this.format._name} does not support video rotation metadata.`);if(e.frameRate!==void 0&&(!Number.isFinite(e.frameRate)||e.frameRate<=0))throw new TypeError(`Invalid video frame rate: ${e.frameRate}. Must be a positive number.`);this._addTrack("video",t,e)}addAudioTrack(t,e={}){if(!(t instanceof je))throw new TypeError("source must be an AudioSource.");Xi(e),this._addTrack("audio",t,e)}addSubtitleTrack(t,e={}){if(!(t instanceof Ht))throw new TypeError("source must be a SubtitleSource.");Xi(e),this._addTrack("subtitle",t,e)}_addTrack(t,e,r){if(this.state!=="pending")throw new Error("Cannot add track after output has been started or canceled.");if(e._connectedTrack)throw new Error("Source is already used for a track.");let i=this.format.getSupportedTrackCounts(),a=this._tracks.reduce((u,d)=>u+(d.type===t?1:0),0),o=i[t].max;if(a===o)throw new Error(o===0?`${this.format._name} does not support ${t} tracks.`:`${this.format._name} does not support more than ${o} ${t} track${o===1?"":"s"}.`);let s=i.total.max;if(this._tracks.length===s)throw new Error(`${this.format._name} does not support more than ${s} tracks${s===1?"":"s"} in total.`);let c={id:this._tracks.length+1,output:this,type:t,source:e,metadata:r};if(c.type==="video"){let u=this.format.getSupportedVideoCodecs();if(u.length===0)throw new Error(`${this.format._name} does not support video tracks.`+this.format._codecUnsupportedHint(c.source._codec));if(!u.includes(c.source._codec))throw new Error(`Codec '${c.source._codec}' cannot be contained within ${this.format._name}. Supported video codecs are: ${u.map(d=>`'${d}'`).join(", ")}.`+this.format._codecUnsupportedHint(c.source._codec))}else if(c.type==="audio"){let u=this.format.getSupportedAudioCodecs();if(u.length===0)throw new Error(`${this.format._name} does not support audio tracks.`+this.format._codecUnsupportedHint(c.source._codec));if(!u.includes(c.source._codec))throw new Error(`Codec '${c.source._codec}' cannot be contained within ${this.format._name}. Supported audio codecs are: ${u.map(d=>`'${d}'`).join(", ")}.`+this.format._codecUnsupportedHint(c.source._codec))}else if(c.type==="subtitle"){let u=this.format.getSupportedSubtitleCodecs();if(u.length===0)throw new Error(`${this.format._name} does not support subtitle tracks.`+this.format._codecUnsupportedHint(c.source._codec));if(!u.includes(c.source._codec))throw new Error(`Codec '${c.source._codec}' cannot be contained within ${this.format._name}. Supported subtitle codecs are: ${u.map(d=>`'${d}'`).join(", ")}.`+this.format._codecUnsupportedHint(c.source._codec))}this._tracks.push(c),e._connectedTrack=c}async start(){let t=this.format.getSupportedTrackCounts();for(let r of Fs){let i=this._tracks.reduce((o,s)=>o+(s.type===r?1:0),0),a=t[r].min;if(i<a)throw new Error(a===t[r].max?`${this.format._name} requires exactly ${a} ${r} track${a===1?"":"s"}.`:`${this.format._name} requires at least ${a} ${r} track${a===1?"":"s"}.`)}let e=t.total.min;if(this._tracks.length<e)throw new Error(e===t.total.max?`${this.format._name} requires exactly ${e} track${e===1?"":"s"}.`:`${this.format._name} requires at least ${e} track${e===1?"":"s"}.`);if(this.state==="canceled")throw new Error("Output has been canceled.");return this._startPromise?(console.warn("Output has already been started."),this._startPromise):this._startPromise=(async()=>{this.state="started",this._writer.start();let r=await this._mutex.acquire();await this._muxer.start();let i=this._tracks.map(a=>a.source._start());await Promise.all(i),r()})()}getMimeType(){return this._muxer.getMimeType()}async cancel(){if(this._cancelPromise)return console.warn("Output has already been canceled."),this._cancelPromise;if(this.state==="finalizing"||this.state==="finalized"){console.warn("Output has already been finalized.");return}return this._cancelPromise=(async()=>{this.state="canceled";let t=await this._mutex.acquire(),e=this._tracks.map(r=>r.source._flushOrWaitForOngoingClose(!0));await Promise.all(e),await this._writer.close(),t()})()}async finalize(){if(this.state==="pending")throw new Error("Cannot finalize before starting.");if(this.state==="canceled")throw new Error("Cannot finalize after canceling.");return this._finalizePromise?(console.warn("Output has already been finalized."),this._finalizePromise):this._finalizePromise=(async()=>{this.state="finalizing";let t=await this._mutex.acquire(),e=this._tracks.map(r=>r.source._flushOrWaitForOngoingClose(!1));await Promise.all(e),await this._muxer.finalize(),await this._writer.flush(),await this._writer.finalize(),this.state="finalized",t()})()}};var ve=class{constructor(){this._sizePromise=null;this.onread=null}async getSizeOrNull(){return this._sizePromise??=Promise.resolve(this._retrieveSize())}async getSize(){let t=await this.getSizeOrNull();if(t===null)throw new Error("Cannot determine the size of an unsized source.");return t}},Yi=class extends ve{constructor(e){if(!(e instanceof ArrayBuffer)&&!ArrayBuffer.isView(e))throw new TypeError("buffer must be an ArrayBuffer or ArrayBufferView.");super();this._onreadCalled=!1;this._bytes=$(e),this._view=H(e)}_retrieveSize(){return this._bytes.byteLength}_read(){return this._onreadCalled||(this.onread?.(0,this._bytes.byteLength),this._onreadCalled=!0),{bytes:this._bytes,view:this._view,offset:0}}},Zi=class extends ve{constructor(e,r={}){if(!(e instanceof Blob))throw new TypeError("blob must be a Blob.");if(!r||typeof r!="object")throw new TypeError("options must be an object.");if(r.maxCacheSize!==void 0&&(!Number.isInteger(r.maxCacheSize)||r.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative integer.");super();this._readers=new WeakMap;this._blob=e,this._orchestrator=new Tr({maxCacheSize:r.maxCacheSize??8*2**20,maxWorkerCount:4,runWorker:this._runWorker.bind(this),prefetchProfile:ra.fileSystem})}_retrieveSize(){let e=this._blob.size;return this._orchestrator.fileSize=e,e}_read(e,r){return this._orchestrator.read(e,r)}async _runWorker(e){let r=this._readers.get(e);for(r||(r=this._blob.slice(e.currentPos).stream().getReader(),this._readers.set(e,r));e.currentPos<e.targetPos&&!e.aborted;){let{done:i,value:a}=await r.read();if(i){if(this._orchestrator.forgetWorker(e),e.currentPos<e.targetPos)throw new Error("Blob reader stopped unexpectedly before all requested data was read.");break}this.onread?.(e.currentPos,e.currentPos+a.length),this._orchestrator.supplyWorkerData(e,a)}e.running=!1}},Ms=.5*2**20,Ji=class extends ve{constructor(e,r={}){if(typeof e!="string"&&!(e instanceof URL))throw new TypeError("url must be a string or URL.");if(!r||typeof r!="object")throw new TypeError("options must be an object.");if(r.requestInit!==void 0&&(!r.requestInit||typeof r.requestInit!="object"))throw new TypeError("options.requestInit, when provided, must be an object.");if(r.getRetryDelay!==void 0&&typeof r.getRetryDelay!="function")throw new TypeError("options.getRetryDelay, when provided, must be a function.");if(r.maxCacheSize!==void 0&&(!Number.isInteger(r.maxCacheSize)||r.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative integer.");super();this._existingResponses=new WeakMap;this._url=e instanceof URL?e:new URL(e,typeof location<"u"?location.href:void 0),this._options=r,this._getRetryDelay=r.getRetryDelay??(i=>Math.min(2**(i-2),8)),this._orchestrator=new Tr({maxCacheSize:r.maxCacheSize??64*2**20,maxWorkerCount:2,runWorker:this._runWorker.bind(this),prefetchProfile:ra.network})}async _retrieveSize(){let e=new AbortController,r=await li(this._url,Rr(this._options.requestInit??{},{headers:{Range:"bytes=0-"},signal:e.signal}),this._getRetryDelay);if(!r.ok)throw new Error(`Error fetching ${this._url}: ${r.status} ${r.statusText}`);let i,a;if(r.status===206)a=this._getPartialLengthFromRangeResponse(r),i=this._orchestrator.createWorker(0,Math.min(a,Ms));else{let o=r.headers.get("Content-Length");if(o)a=Number(o),i=this._orchestrator.createWorker(0,a),this._orchestrator.options.maxCacheSize=1/0,console.warn("HTTP server did not respond with 206 Partial Content, meaning the entire remote resource now has to be downloaded. For efficient media file streaming across a network, please make sure your server supports range requests.");else throw new Error(`HTTP response (status ${r.status}) must surface Content-Length header.`)}return this._orchestrator.fileSize=a,this._existingResponses.set(i,{response:r,abortController:e}),this._orchestrator.runWorker(i),a}_read(e,r){return this._orchestrator.read(e,r)}async _runWorker(e){for(;!e.aborted;){let r=this._existingResponses.get(e);this._existingResponses.delete(e);let i=r?.abortController,a=r?.response;if(i||(i=new AbortController,a=await li(this._url,Rr(this._options.requestInit??{},{headers:{Range:`bytes=${e.currentPos}-`},signal:i.signal}),this._getRetryDelay)),m(a),!a.ok)throw new Error(`Error fetching ${this._url}: ${a.status} ${a.statusText}`);if(e.currentPos>0&&a.status!==206)throw new Error("HTTP server did not respond with 206 Partial Content to a range request. To enable efficient media file streaming across a network, please make sure your server supports range requests.");let o=this._getPartialLengthFromRangeResponse(a),s=e.targetPos-e.currentPos;if(o<s)throw new Error(`HTTP response unexpectedly too short: Needed at least ${s} bytes, got only ${o}.`);if(!a.body)throw new Error("Missing HTTP response body.");let c=a.body.getReader();for(;;){let u;try{u=await c.read()}catch(f){let p=this._getRetryDelay(1);if(p!==null){console.error("Error while reading response stream. Attempting to resume.",f),await new Promise(h=>setTimeout(h,1e3*p));break}else throw f}let{done:d,value:l}=u;if(d){if(this._orchestrator.forgetWorker(e),e.currentPos<e.targetPos)throw new Error("Response stream reader stopped unexpectedly before all requested data was read.");e.running=!1;return}if(this.onread?.(e.currentPos,e.currentPos+l.length),this._orchestrator.supplyWorkerData(e,l),e.currentPos>=e.targetPos||e.aborted){i.abort(),e.running=!1;return}}}e.running=!1}_getPartialLengthFromRangeResponse(e){let r=e.headers.get("Content-Range");if(r){let i=/\/(\d+)/.exec(r);if(i)return Number(i[1]);throw new Error(`Invalid Content-Range header: ${r}`)}else{let i=e.headers.get("Content-Length");if(i)return Number(i);throw new Error("Partial HTTP response (status 206) must surface either Content-Range or Content-Length header.")}}},ea=class extends ve{constructor(t,e={}){if(typeof t!="string")throw new TypeError("filePath must be a string.");if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.maxCacheSize!==void 0&&(!Number.isInteger(e.maxCacheSize)||e.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative integer.");super();let r=null;this._streamSource=new Ln({getSize:async()=>(r=await(await import("node:fs/promises")).open(t,"r"),(await r.stat()).size),read:async(i,a)=>{m(r);let o=Buffer.alloc(a-i);return await r.read(o,0,a-i,i),o},maxCacheSize:e.maxCacheSize,prefetchProfile:"fileSystem"})}_read(t,e){return this._streamSource._read(t,e)}_retrieveSize(){return this._streamSource._retrieveSize()}},Ln=class extends ve{constructor(t){if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(typeof t.read!="function")throw new TypeError("options.read must be a function.");if(typeof t.getSize!="function")throw new TypeError("options.getSize must be a function.");if(t.maxCacheSize!==void 0&&(!Number.isInteger(t.maxCacheSize)||t.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative integer.");if(t.prefetchProfile&&!["none","fileSystem","network"].includes(t.prefetchProfile))throw new TypeError("options.prefetchProfile, when provided, must be one of 'none', 'fileSystem' or 'network'.");super(),this._options=t,this._orchestrator=new Tr({maxCacheSize:t.maxCacheSize??8*2**20,maxWorkerCount:2,prefetchProfile:ra[t.prefetchProfile??"none"],runWorker:this._runWorker.bind(this)})}_retrieveSize(){let t=this._options.getSize();if(t instanceof Promise)return t.then(e=>{if(!Number.isInteger(e)||e<0)throw new TypeError("options.getSize must return or resolve to a non-negative integer.");return this._orchestrator.fileSize=e,e});if(!Number.isInteger(t)||t<0)throw new TypeError("options.getSize must return or resolve to a non-negative integer.");return this._orchestrator.fileSize=t,t}_read(t,e){return this._orchestrator.read(t,e)}async _runWorker(t){for(;t.currentPos<t.targetPos&&!t.aborted;){let e=t.currentPos,r=t.targetPos,i=this._options.read(t.currentPos,r);if(i instanceof Promise&&(i=await i),i instanceof Uint8Array){if(i.length!==r-t.currentPos)throw new Error(`options.read returned a Uint8Array with unexpected length: Requested ${r-t.currentPos} bytes, but got ${i.length}.`);this.onread?.(t.currentPos,t.currentPos+i.length),this._orchestrator.supplyWorkerData(t,i)}else if(i instanceof ReadableStream){let a=i.getReader();for(;;){let{done:o,value:s}=await a.read();if(o){if(t.currentPos<r)throw new Error(`ReadableStream returned by options.read ended before supplying enough data. Requested ${r-e} bytes, but got ${t.currentPos-e}`);break}if(!(s instanceof Uint8Array))throw new TypeError("ReadableStream returned by options.read must yield Uint8Array chunks.");if(this.onread?.(t.currentPos,t.currentPos+s.length),this._orchestrator.supplyWorkerData(t,s),t.currentPos>=r||t.aborted)break}}else throw new TypeError("options.read must return or resolve to a Uint8Array or a ReadableStream.")}t.running=!1}},ta=class extends ve{constructor(e,r={}){if(!(e instanceof ReadableStream))throw new TypeError("stream must be a ReadableStream.");if(!r||typeof r!="object")throw new TypeError("options must be an object.");if(r.maxCacheSize!==void 0&&(!Number.isInteger(r.maxCacheSize)||r.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative integer.");super();this._reader=null;this._cache=[];this._pendingSlices=[];this._currentIndex=0;this._targetIndex=0;this._maxRequestedIndex=0;this._endIndex=null;this._pulling=!1;this._stream=e,this._maxCacheSize=r.maxCacheSize??16*2**20}_retrieveSize(){return this._endIndex}_read(e,r){if(this._endIndex!==null&&r>this._endIndex)return null;this._maxRequestedIndex=Math.max(this._maxRequestedIndex,r);let i=z(this._cache,e,l=>l.start),a=i!==-1?this._cache[i]:null;if(a&&a.start<=e&&r<=a.end)return{bytes:a.bytes,view:a.view,offset:a.start};let o=e,s=new Uint8Array(r-e);if(i!==-1)for(let l=i;l<this._cache.length;l++){let f=this._cache[l];if(f.start>=r)break;let p=Math.max(e,f.start);p>o&&this._throwDueToCacheMiss();let h=Math.min(r,f.end);p<h&&(s.set(f.bytes.subarray(p-f.start,h-f.start),p-e),o=h)}if(o===r)return{bytes:s,view:H(s),offset:e};this._currentIndex>o&&this._throwDueToCacheMiss();let{promise:c,resolve:u,reject:d}=q();return this._pendingSlices.push({start:e,end:r,bytes:s,resolve:u,reject:d}),this._targetIndex=Math.max(this._targetIndex,r),this._pulling||(this._pulling=!0,this._pull().catch(l=>{if(this._pulling=!1,this._pendingSlices.length>0)this._pendingSlices.forEach(f=>f.reject(l)),this._pendingSlices.length=0;else throw l})),c}_throwDueToCacheMiss(){throw new Error("Read is before the cached region. With ReadableStreamSource, you must access the data more sequentially or increase the size of its cache.")}async _pull(){for(this._reader??=this._stream.getReader();this._currentIndex<this._targetIndex;){let{done:e,value:r}=await this._reader.read();if(e){for(let o of this._pendingSlices)o.resolve(null);this._pendingSlices.length=0,this._endIndex=this._currentIndex;break}let i=this._currentIndex,a=this._currentIndex+r.byteLength;for(let o=0;o<this._pendingSlices.length;o++){let s=this._pendingSlices[o],c=Math.max(i,s.start),u=Math.min(a,s.end);c<u&&(s.bytes.set(r.subarray(c-i,u-i),c-s.start),u===s.end&&(s.resolve({bytes:s.bytes,view:H(s.bytes),offset:s.start}),this._pendingSlices.splice(o,1),o--))}for(this._cache.push({start:i,end:a,bytes:r,view:H(r),age:0});this._cache.length>0;){let o=this._cache[0];if(this._maxRequestedIndex-o.end<=this._maxCacheSize)break;this._cache.shift()}this._currentIndex+=r.byteLength}this._pulling=!1}},ra={none:(n,t)=>({start:n,end:t}),fileSystem:(n,t)=>(n=Math.floor((n-65536)/65536)*65536,t=Math.ceil((t+65536)/65536)*65536,{start:n,end:t}),network:(n,t,e)=>{n=Math.max(0,Math.floor((n-65536)/65536)*65536);for(let i of e){let o=Math.max((i.startPos+i.targetPos)/2,i.targetPos-8388608);if(Dr(n,t,o,i.targetPos)){let s=i.targetPos-i.startPos,c=Math.ceil((s+1)/8388608)*8388608,u=2**Math.ceil(Math.log2(s+1)),d=Math.min(u,c);t=Math.max(t,i.startPos+d)}}return t=Math.max(t,n+Ms),{start:n,end:t}}},Tr=class{constructor(t){this.options=t;this.fileSize=null;this.nextAge=0;this.workers=[];this.cache=[];this.currentCacheSize=0}read(t,e){m(this.fileSize!==null);let r=this.options.prefetchProfile(t,e,this.workers),i=Math.max(r.start,0),a=Math.min(r.end,this.fileSize);m(i<=t&&e<=a);let o=null,s=z(this.cache,t,k=>k.start),c=s!==-1?this.cache[s]:null;c&&c.start<=t&&e<=c.end&&(c.age=this.nextAge++,o={bytes:c.bytes,view:c.view,offset:c.start});let u=z(this.cache,i,k=>k.start),d=o?null:new Uint8Array(e-t),l=0,f=i,p=[];if(u!==-1){for(let k=u;k<this.cache.length;k++){let y=this.cache[k];if(y.start>=a)break;if(y.end<=i)continue;let S=Math.max(i,y.start),w=Math.min(a,y.end);if(m(S<=w),f<S&&p.push({start:f,end:S}),f=w,d){let x=Math.max(t,y.start),_=Math.min(e,y.end);if(x<_){let C=x-t;d.set(y.bytes.subarray(x-y.start,_-y.start),C),C===l&&(l=_-t)}}y.age=this.nextAge++}f<a&&p.push({start:f,end:a})}else p.push({start:i,end:a});if(d&&l>=d.length&&(o={bytes:d,view:H(d),offset:t}),p.length===0)return m(o),o;let{promise:h,resolve:b,reject:g}=q(),T=[];for(let k of p){let y=Math.max(t,k.start),S=Math.min(e,k.end);y===k.start&&S===k.end?T.push(k):y<S&&T.push({start:y,end:S})}for(let k of p){let y=d&&{start:t,bytes:d,holes:T,resolve:b,reject:g},S=!1;for(let w of this.workers)if(Dr(k.start-131072,k.start,w.currentPos,w.targetPos)){w.targetPos=Math.max(w.targetPos,k.end),S=!0,y&&!w.pendingSlices.includes(y)&&w.pendingSlices.push(y),w.running||this.runWorker(w);break}if(!S){let w=this.createWorker(k.start,k.end);y&&(w.pendingSlices=[y]),this.runWorker(w)}}return o||(m(d),o=h.then(k=>({bytes:k,view:H(k),offset:t}))),o}createWorker(t,e){let r={startPos:t,currentPos:t,targetPos:e,running:!1,aborted:!1,pendingSlices:[],age:this.nextAge++};for(this.workers.push(r);this.workers.length>this.options.maxWorkerCount;){let i=0,a=this.workers[0];for(let o=1;o<this.workers.length;o++){let s=this.workers[o];s.age<a.age&&(i=o,a=s)}if(a.running&&a.pendingSlices.length>0)break;a.aborted=!0,this.workers.splice(i,1)}return r}runWorker(t){m(!t.running),m(t.currentPos<t.targetPos),t.running=!0,t.age=this.nextAge++,this.options.runWorker(t).catch(e=>{if(t.running=!1,t.pendingSlices.length>0)t.pendingSlices.forEach(r=>r.reject(e)),t.pendingSlices.length=0;else throw e})}supplyWorkerData(t,e){let r=t.currentPos,i=r+e.length;this.insertIntoCache({start:r,end:i,bytes:e,view:H(e),age:this.nextAge++}),t.currentPos+=e.length,t.targetPos=Math.max(t.targetPos,t.currentPos);for(let a=0;a<t.pendingSlices.length;a++){let o=t.pendingSlices[a],s=Math.max(r,o.start),c=Math.min(i,o.start+o.bytes.length);s<c&&o.bytes.set(e.subarray(s-r,c-r),s-o.start);for(let u=0;u<o.holes.length;u++){let d=o.holes[u];r<=d.start&&i>d.start&&(d.start=i),d.end<=d.start&&(o.holes.splice(u,1),u--)}o.holes.length===0&&(o.resolve(o.bytes),t.pendingSlices.splice(a,1),a--)}for(let a=0;a<this.workers.length;a++){let o=this.workers[a];t===o||o.running||Dr(r,i,o.currentPos,o.targetPos)&&(this.workers.splice(a,1),a--)}}forgetWorker(t){let e=this.workers.indexOf(t);m(e!==-1),this.workers.splice(e,1)}insertIntoCache(t){if(this.options.maxCacheSize===0)return;let e=z(this.cache,t.start,r=>r.start)+1;if(e>0){let r=this.cache[e-1];if(r.end>=t.end)return;if(r.end>t.start){let i=new Uint8Array(t.end-r.start);i.set(r.bytes,0),i.set(t.bytes,t.start-r.start),this.currentCacheSize+=t.end-r.end,r.bytes=i,r.view=H(i),r.end=t.end,e--,t=r}else this.cache.splice(e,0,t),this.currentCacheSize+=t.bytes.length}else this.cache.splice(e,0,t),this.currentCacheSize+=t.bytes.length;for(let r=e+1;r<this.cache.length;r++){let i=this.cache[r];if(t.end<=i.start)break;if(t.end>=i.end){this.cache.splice(r,1),this.currentCacheSize-=i.bytes.length,r--;continue}let a=new Uint8Array(i.end-t.start);a.set(t.bytes,0),a.set(i.bytes,i.start-t.start),this.currentCacheSize-=t.end-i.start,t.bytes=a,t.view=H(a),t.end=i.end,this.cache.splice(r,1);break}for(;this.currentCacheSize>this.options.maxCacheSize;){let r=0,i=this.cache[0];for(let a=1;a<this.cache.length;a++){let o=this.cache[a];o.age<i.age&&(r=a,i=o)}if(this.currentCacheSize-i.bytes.length<=this.options.maxCacheSize)break;this.cache.splice(r,1),this.currentCacheSize-=i.bytes.length}}};var Hn=class extends fe{constructor(e){super(e);this.moovSlice=null;this.currentTrack=null;this.tracks=[];this.metadataPromise=null;this.movieTimescale=-1;this.movieDurationInTimescale=-1;this.isQuickTime=!1;this.isFragmented=!1;this.fragmentTrackDefaults=[];this.fragments=[];this.currentFragment=null;this.fragmentLookupMutex=new oe;this.reader=e._reader}async computeDuration(){let e=await this.getTracks(),r=await Promise.all(e.map(i=>i.computeDuration()));return Math.max(0,...r)}async getTracks(){return await this.readMetadata(),this.tracks.map(e=>e.inputTrack)}async getMimeType(){await this.readMetadata();let e=await Promise.all(this.tracks.map(r=>r.inputTrack.getCodecParameterString()));return rn({isQuickTime:this.isQuickTime,hasVideo:this.tracks.some(r=>r.info?.type==="video"),hasAudio:this.tracks.some(r=>r.info?.type==="audio"),codecStrings:e.filter(Boolean)})}readMetadata(){return this.metadataPromise??=(async()=>{let e=0;for(;;){let r=this.reader.requestSliceRange(e,ye,Me);if(r instanceof Promise&&(r=await r),!r)break;let i=e,a=et(r);if(!a)break;if(a.name==="ftyp"){let o=ie(r,4);this.isQuickTime=o==="qt  "}else if(a.name==="moov"){let o=this.reader.requestSlice(r.filePos,a.contentSize);if(o instanceof Promise&&(o=await o),!o)break;this.moovSlice=o,this.readContiguousBoxes(this.moovSlice);for(let s of this.tracks){let c=s.editListPreviousSegmentDurations/this.movieTimescale;s.editListOffset-=Math.round(c*s.timescale)}break}e=i+a.totalSize}if(this.isFragmented&&this.reader.fileSize!==null){let r=this.reader.requestSlice(this.reader.fileSize-4,4);r instanceof Promise&&(r=await r),m(r);let i=v(r),a=this.reader.fileSize-i;if(a>=0&&a<=this.reader.fileSize-Me){let o=this.reader.requestSliceRange(a,ye,Me);if(o instanceof Promise&&(o=await o),o){let s=et(o);if(s&&s.name==="mfra"){let c=this.reader.requestSlice(o.filePos,s.contentSize);c instanceof Promise&&(c=await c),c&&this.readContiguousBoxes(c)}}}}})()}getSampleTableForTrack(e){if(e.sampleTable)return e.sampleTable;let r={sampleTimingEntries:[],sampleCompositionTimeOffsets:[],sampleSizes:[],keySampleIndices:null,chunkOffsets:[],sampleToChunk:[],presentationTimestamps:null,presentationTimestampIndexMap:null};e.sampleTable=r,m(this.moovSlice);let i=this.moovSlice.slice(e.sampleTableByteOffset);if(this.currentTrack=e,this.traverseBox(i),this.currentTrack=null,e.info?.type==="audio"&&e.info.codec&&K.includes(e.info.codec)&&r.sampleCompositionTimeOffsets.length===0){m(e.info?.type==="audio");let o=ae(e.info.codec),s=[],c=[];for(let u=0;u<r.sampleToChunk.length;u++){let d=r.sampleToChunk[u],l=r.sampleToChunk[u+1],f=(l?l.startChunkIndex:r.chunkOffsets.length)-d.startChunkIndex;for(let p=0;p<f;p++){let h=d.startSampleIndex+p*d.samplesPerChunk,b=h+d.samplesPerChunk,g=z(r.sampleTimingEntries,h,P=>P.startIndex),T=r.sampleTimingEntries[g],k=z(r.sampleTimingEntries,b,P=>P.startIndex),y=r.sampleTimingEntries[k],S=T.startDecodeTimestamp+(h-T.startIndex)*T.delta,x=y.startDecodeTimestamp+(b-y.startIndex)*y.delta-S,_=L(s);_&&_.delta===x?_.count++:s.push({startIndex:d.startChunkIndex+p,startDecodeTimestamp:S,count:1,delta:x});let C=d.samplesPerChunk*o.sampleSize*e.info.numberOfChannels;c.push(C)}d.startSampleIndex=d.startChunkIndex,d.samplesPerChunk=1}r.sampleTimingEntries=s,r.sampleSizes=c}if(r.sampleCompositionTimeOffsets.length>0){r.presentationTimestamps=[];for(let o of r.sampleTimingEntries)for(let s=0;s<o.count;s++)r.presentationTimestamps.push({presentationTimestamp:o.startDecodeTimestamp+s*o.delta,sampleIndex:o.startIndex+s});for(let o of r.sampleCompositionTimeOffsets)for(let s=0;s<o.count;s++){let c=o.startIndex+s,u=r.presentationTimestamps[c];u&&(u.presentationTimestamp+=o.offset)}r.presentationTimestamps.sort((o,s)=>o.presentationTimestamp-s.presentationTimestamp),r.presentationTimestampIndexMap=Array(r.presentationTimestamps.length).fill(-1);for(let o=0;o<r.presentationTimestamps.length;o++)r.presentationTimestampIndexMap[r.presentationTimestamps[o].sampleIndex]=o}return r}async readFragment(e){let r=this.reader.requestSliceRange(e,ye,Me);r instanceof Promise&&(r=await r),m(r);let i=et(r);m(i?.name==="moof");let a=this.reader.requestSlice(e,i.totalSize);a instanceof Promise&&(a=await a),m(a),this.traverseBox(a);let o=G(this.fragments,e,c=>c.moofOffset);m(o!==-1);let s=this.fragments[o];m(s.moofOffset===e);for(let[c,u]of s.trackData){if(u.startTimestampIsFinal)continue;let d=this.tracks.find(g=>g.id===c),l=0,f=null,p=null,h=z(d.fragments,e-1,g=>g.moofOffset);h!==-1&&(f=d.fragments[h],p=f,l=f.moofOffset+f.moofSize);let b=l===0;for(;l<=e-ye;){if(f?.nextFragment)f=f.nextFragment,l=f.moofOffset+f.moofSize;else{let g=this.reader.requestSliceRange(l,ye,Me);if(g instanceof Promise&&(g=await g),!g)break;let T=l,k=et(g);if(!k)break;if(k.name==="moof"){let y=G(this.fragments,T,w=>w.moofOffset),S;y===-1?S=await this.readFragment(T):S=this.fragments[y],f&&(f.nextFragment=S),f=S,b&&(S.isKnownToBeFirstFragment=!0,b=!1)}l=T+k.totalSize}f&&f.trackData.has(c)&&(p=f)}if(p){let g=p.trackData.get(c);m(g.startTimestampIsFinal),Rs(u,g.endTimestamp)}u.startTimestampIsFinal=!0}return s}readContiguousBoxes(e){let r=e.filePos;for(;e.filePos-r<=e.length-ye&&this.traverseBox(e););}traverseBox(e){let r=e.filePos,i=et(e);if(!i)return!1;let a=e.filePos,o=r+i.totalSize;switch(i.name){case"mdia":case"minf":case"dinf":case"mfra":case"edts":case"udta":this.readContiguousBoxes(e.slice(a,i.contentSize));break;case"mvhd":{let s=M(e);e.skip(3),s===1?(e.skip(16),this.movieTimescale=v(e),this.movieDurationInTimescale=be(e)):(e.skip(8),this.movieTimescale=v(e),this.movieDurationInTimescale=v(e))}break;case"trak":{let s={id:-1,demuxer:this,inputTrack:null,info:null,timescale:-1,durationInMovieTimescale:-1,durationInMediaTimescale:-1,rotation:0,internalCodecId:null,name:null,languageCode:Z,sampleTableByteOffset:-1,sampleTable:null,fragmentLookupTable:null,currentFragmentState:null,fragments:[],fragmentsWithKeyFrame:[],editListPreviousSegmentDurations:0,editListOffset:0};if(this.currentTrack=s,this.readContiguousBoxes(e.slice(a,i.contentSize)),s.id!==-1&&s.timescale!==-1&&s.info!==null){if(s.info.type==="video"&&s.info.width!==-1){let c=s;s.inputTrack=new Ce(new na(c)),this.tracks.push(s)}else if(s.info.type==="audio"&&s.info.numberOfChannels!==-1){let c=s;s.inputTrack=new re(new ia(c)),this.tracks.push(s)}}this.currentTrack=null}break;case"tkhd":{let s=this.currentTrack;m(s);let c=M(e);if(!((Pt(e)&1)!==0))break;if(c===0)e.skip(8),s.id=v(e),e.skip(4),s.durationInMovieTimescale=v(e);else if(c===1)e.skip(16),s.id=v(e),e.skip(4),s.durationInMovieTimescale=be(e);else throw new Error(`Incorrect track header version ${c}.`);e.skip(2*4+2+2+2+2);let l=[tt(e),tt(e),sn(e),tt(e),tt(e),sn(e),tt(e),tt(e),sn(e)],f=$e($t(Hc(l),90));m(f===0||f===90||f===180||f===270),s.rotation=f}break;case"elst":{let s=this.currentTrack;m(s);let c=M(e);e.skip(3);let u=!1,d=0,l=v(e);for(let f=0;f<l;f++){let p=c===1?be(e):v(e),h=c===1?us(e):He(e),b=tt(e);if(p!==0){if(u){console.warn("Unsupported edit list: multiple edits are not currently supported. Only using first edit.");break}if(h===-1){d+=p;continue}if(b!==1){console.warn("Unsupported edit list entry: media rate must be 1.");break}s.editListPreviousSegmentDurations=d,s.editListOffset=h,u=!0}}}break;case"mdhd":{let s=this.currentTrack;m(s);let c=M(e);e.skip(3),c===0?(e.skip(8),s.timescale=v(e),s.durationInMediaTimescale=v(e)):c===1&&(e.skip(16),s.timescale=v(e),s.durationInMediaTimescale=be(e));let u=me(e);if(u>0){s.languageCode="";for(let d=0;d<3;d++)s.languageCode=String.fromCharCode(96+(u&31))+s.languageCode,u>>=5;Ue(s.languageCode)||(s.languageCode=Z)}}break;case"hdlr":{let s=this.currentTrack;m(s),e.skip(8);let c=ie(e,4);c==="vide"?s.info={type:"video",width:-1,height:-1,codec:null,codecDescription:null,colorSpace:null,avcCodecInfo:null,hevcCodecInfo:null,vp9CodecInfo:null,av1CodecInfo:null}:c==="soun"&&(s.info={type:"audio",numberOfChannels:-1,sampleRate:-1,codec:null,codecDescription:null,aacCodecInfo:null})}break;case"stbl":{let s=this.currentTrack;m(s),s.sampleTableByteOffset=r,this.readContiguousBoxes(e.slice(a,i.contentSize))}break;case"stsd":{let s=this.currentTrack;if(m(s),s.info===null||s.sampleTable)break;let c=M(e);e.skip(3);let u=v(e);for(let d=0;d<u;d++){let l=e.filePos,f=et(e);if(!f)break;s.internalCodecId=f.name;let p=f.name.toLowerCase();if(s.info.type==="video")p==="avc1"?s.info.codec="avc":p==="hvc1"||p==="hev1"?s.info.codec="hevc":p==="vp08"?s.info.codec="vp8":p==="vp09"?s.info.codec="vp9":p==="av01"?s.info.codec="av1":console.warn(`Unsupported video codec (sample entry type '${f.name}').`),e.skip(6*1+2+2+2+3*4),s.info.width=me(e),s.info.height=me(e),e.skip(50),this.readContiguousBoxes(e.slice(e.filePos,l+f.totalSize-e.filePos));else{p==="mp4a"||(p==="opus"?s.info.codec="opus":p==="flac"?s.info.codec="flac":p==="twos"||p==="sowt"||p==="raw "||p==="in24"||p==="in32"||p==="fl32"||p==="fl64"||p==="lpcm"||p==="ipcm"||p==="fpcm"||(p==="ulaw"?s.info.codec="ulaw":p==="alaw"?s.info.codec="alaw":console.warn(`Unsupported audio codec (sample entry type '${f.name}').`))),e.skip(6*1+2);let h=me(e);e.skip(3*2);let b=me(e),g=me(e);e.skip(2*2);let T=v(e)/65536;if(c===0&&h>0){if(h===1)e.skip(4),g=8*v(e),e.skip(2*4);else if(h===2){e.skip(4),T=an(e),b=v(e),e.skip(4),g=v(e);let k=v(e);if(e.skip(2*4),p==="lpcm"){let y=g+7>>3,S=!!(k&1),w=!!(k&2),x=k&4?-1:0;g>0&&g<=64&&(S?g===32&&(s.info.codec=w?"pcm-f32be":"pcm-f32"):x&1<<y-1?y===1?s.info.codec="pcm-s8":y===2?s.info.codec=w?"pcm-s16be":"pcm-s16":y===3?s.info.codec=w?"pcm-s24be":"pcm-s24":y===4&&(s.info.codec=w?"pcm-s32be":"pcm-s32"):y===1&&(s.info.codec="pcm-u8")),s.info.codec===null&&console.warn("Unsupported PCM format.")}}}s.info.numberOfChannels=b,s.info.sampleRate=T,p==="twos"?g===8?s.info.codec="pcm-s8":g===16?s.info.codec="pcm-s16be":(console.warn(`Unsupported sample size ${g} for codec 'twos'.`),s.info.codec=null):p==="sowt"?g===8?s.info.codec="pcm-s8":g===16?s.info.codec="pcm-s16":(console.warn(`Unsupported sample size ${g} for codec 'sowt'.`),s.info.codec=null):p==="raw "?s.info.codec="pcm-u8":p==="in24"?s.info.codec="pcm-s24be":p==="in32"?s.info.codec="pcm-s32be":p==="fl32"?s.info.codec="pcm-f32be":p==="fl64"?s.info.codec="pcm-f64be":p==="ipcm"?s.info.codec="pcm-s16be":p==="fpcm"&&(s.info.codec="pcm-f32be"),this.readContiguousBoxes(e.slice(e.filePos,l+f.totalSize-e.filePos))}}}break;case"avcC":{let s=this.currentTrack;m(s&&s.info),s.info.codecDescription=W(e,i.contentSize)}break;case"hvcC":{let s=this.currentTrack;m(s&&s.info),s.info.codecDescription=W(e,i.contentSize)}break;case"vpcC":{let s=this.currentTrack;m(s&&s.info?.type==="video"),e.skip(4);let c=M(e),u=M(e),d=M(e),l=d>>4,f=d>>1&7,p=d&1,h=M(e),b=M(e),g=M(e);s.info.vp9CodecInfo={profile:c,level:u,bitDepth:l,chromaSubsampling:f,videoFullRangeFlag:p,colourPrimaries:h,transferCharacteristics:b,matrixCoefficients:g}}break;case"av1C":{let s=this.currentTrack;m(s&&s.info?.type==="video"),e.skip(1);let c=M(e),u=c>>5,d=c&31,l=M(e),f=l>>7,p=l>>6&1,h=l>>5&1,b=l>>4&1,g=l>>3&1,T=l>>2&1,k=l&3,y=u===2&&p?h?12:10:p?10:8;s.info.av1CodecInfo={profile:u,level:d,tier:f,bitDepth:y,monochrome:b,chromaSubsamplingX:g,chromaSubsamplingY:T,chromaSamplePosition:k}}break;case"colr":{let s=this.currentTrack;if(m(s&&s.info?.type==="video"),ie(e,4)!=="nclx")break;let u=me(e),d=me(e),l=me(e),f=!!(M(e)&128);s.info.colorSpace={primaries:Ir[u],transfer:Ar[d],matrix:Fr[l],fullRange:f}}break;case"wave":this.readContiguousBoxes(e.slice(a,i.contentSize));break;case"esds":{let s=this.currentTrack;m(s&&s.info?.type==="audio"),e.skip(4);let c=M(e);m(c===3),on(e),e.skip(2);let u=M(e),d=(u&128)!==0,l=(u&64)!==0,f=(u&32)!==0;if(d&&e.skip(2),l){let T=M(e);e.skip(T)}f&&e.skip(2);let p=M(e);m(p===4);let h=on(e),b=e.filePos,g=M(e);if(g===64||g===103?(s.info.codec="aac",s.info.aacCodecInfo={isMpeg2:g===103}):g===105||g===107?s.info.codec="mp3":g===221?s.info.codec="vorbis":console.warn(`Unsupported audio codec (objectTypeIndication ${g}) - discarding track.`),e.skip(12),h>e.filePos-b){let T=M(e);m(T===5);let k=on(e);if(s.info.codecDescription=W(e,k),s.info.codec==="aac"){let y=Xt(s.info.codecDescription);y.numberOfChannels!==null&&(s.info.numberOfChannels=y.numberOfChannels),y.sampleRate!==null&&(s.info.sampleRate=y.sampleRate)}}}break;case"enda":{let s=this.currentTrack;m(s&&s.info?.type==="audio"),me(e)&255&&(s.info.codec==="pcm-s16be"?s.info.codec="pcm-s16":s.info.codec==="pcm-s24be"?s.info.codec="pcm-s24":s.info.codec==="pcm-s32be"?s.info.codec="pcm-s32":s.info.codec==="pcm-f32be"?s.info.codec="pcm-f32":s.info.codec==="pcm-f64be"&&(s.info.codec="pcm-f64"))}break;case"pcmC":{let s=this.currentTrack;m(s&&s.info?.type==="audio"),e.skip(4);let u=!!(M(e)&1),d=M(e);s.info.codec==="pcm-s16be"?u?d===16?s.info.codec="pcm-s16":d===24?s.info.codec="pcm-s24":d===32?s.info.codec="pcm-s32":(console.warn(`Invalid ipcm sample size ${d}.`),s.info.codec=null):d===16?s.info.codec="pcm-s16be":d===24?s.info.codec="pcm-s24be":d===32?s.info.codec="pcm-s32be":(console.warn(`Invalid ipcm sample size ${d}.`),s.info.codec=null):s.info.codec==="pcm-f32be"&&(u?d===32?s.info.codec="pcm-f32":d===64?s.info.codec="pcm-f64":(console.warn(`Invalid fpcm sample size ${d}.`),s.info.codec=null):d===32?s.info.codec="pcm-f32be":d===64?s.info.codec="pcm-f64be":(console.warn(`Invalid fpcm sample size ${d}.`),s.info.codec=null));break}case"dOps":{let s=this.currentTrack;m(s&&s.info?.type==="audio"),e.skip(1);let c=M(e),u=me(e),d=v(e),l=ir(e),f=M(e),p;f!==0?p=W(e,2+c):p=new Uint8Array(0);let h=new Uint8Array(19+p.byteLength),b=new DataView(h.buffer);b.setUint32(0,1332770163,!1),b.setUint32(4,1214603620,!1),b.setUint8(8,1),b.setUint8(9,c),b.setUint16(10,u,!0),b.setUint32(12,d,!0),b.setInt16(16,l,!0),b.setUint8(18,f),h.set(p,19),s.info.codecDescription=h,s.info.numberOfChannels=c,s.info.sampleRate=d}break;case"dfLa":{let s=this.currentTrack;m(s&&s.info?.type==="audio"),e.skip(4);let c=127,u=128,d=e.filePos;for(;e.filePos<o;){let b=M(e),g=Pt(e);if((b&c)===0){e.skip(10);let k=v(e),y=k>>>12,S=(k>>9&7)+1;s.info.sampleRate=y,s.info.numberOfChannels=S,e.skip(20)}else e.skip(g);if(b&u)break}let l=e.filePos;e.filePos=d;let f=W(e,l-d),p=new Uint8Array(4+f.byteLength);new DataView(p.buffer).setUint32(0,1716281667,!1),p.set(f,4),s.info.codecDescription=p}break;case"stts":{let s=this.currentTrack;if(m(s),!s.sampleTable)break;e.skip(4);let c=v(e),u=0,d=0;for(let l=0;l<c;l++){let f=v(e),p=v(e);s.sampleTable.sampleTimingEntries.push({startIndex:u,startDecodeTimestamp:d,count:f,delta:p}),u+=f,d+=f*p}}break;case"ctts":{let s=this.currentTrack;if(m(s),!s.sampleTable)break;e.skip(4);let c=v(e),u=0;for(let d=0;d<c;d++){let l=v(e),f=He(e);s.sampleTable.sampleCompositionTimeOffsets.push({startIndex:u,count:l,offset:f}),u+=l}}break;case"stsz":{let s=this.currentTrack;if(m(s),!s.sampleTable)break;e.skip(4);let c=v(e),u=v(e);if(c===0)for(let d=0;d<u;d++){let l=v(e);s.sampleTable.sampleSizes.push(l)}else s.sampleTable.sampleSizes.push(c)}break;case"stz2":{let s=this.currentTrack;if(m(s),!s.sampleTable)break;e.skip(4),e.skip(3);let c=M(e),u=v(e),d=W(e,Math.ceil(u*c/8)),l=new Q(d);for(let f=0;f<u;f++){let p=l.readBits(c);s.sampleTable.sampleSizes.push(p)}}break;case"stss":{let s=this.currentTrack;if(m(s),!s.sampleTable)break;e.skip(4),s.sampleTable.keySampleIndices=[];let c=v(e);for(let u=0;u<c;u++){let d=v(e)-1;s.sampleTable.keySampleIndices.push(d)}s.sampleTable.keySampleIndices[0]!==0&&s.sampleTable.keySampleIndices.unshift(0)}break;case"stsc":{let s=this.currentTrack;if(m(s),!s.sampleTable)break;e.skip(4);let c=v(e);for(let d=0;d<c;d++){let l=v(e)-1,f=v(e),p=v(e);s.sampleTable.sampleToChunk.push({startSampleIndex:-1,startChunkIndex:l,samplesPerChunk:f,sampleDescriptionIndex:p})}let u=0;for(let d=0;d<s.sampleTable.sampleToChunk.length;d++)if(s.sampleTable.sampleToChunk[d].startSampleIndex=u,d<s.sampleTable.sampleToChunk.length-1){let f=s.sampleTable.sampleToChunk[d+1].startChunkIndex-s.sampleTable.sampleToChunk[d].startChunkIndex;u+=f*s.sampleTable.sampleToChunk[d].samplesPerChunk}}break;case"stco":{let s=this.currentTrack;if(m(s),!s.sampleTable)break;e.skip(4);let c=v(e);for(let u=0;u<c;u++){let d=v(e);s.sampleTable.chunkOffsets.push(d)}}break;case"co64":{let s=this.currentTrack;if(m(s),!s.sampleTable)break;e.skip(4);let c=v(e);for(let u=0;u<c;u++){let d=be(e);s.sampleTable.chunkOffsets.push(d)}}break;case"mvex":this.isFragmented=!0,this.readContiguousBoxes(e.slice(a,i.contentSize));break;case"mehd":{let s=M(e);e.skip(3);let c=s===1?be(e):v(e);this.movieDurationInTimescale=c}break;case"trex":{e.skip(4);let s=v(e),c=v(e),u=v(e),d=v(e),l=v(e);this.fragmentTrackDefaults.push({trackId:s,defaultSampleDescriptionIndex:c,defaultSampleDuration:u,defaultSampleSize:d,defaultSampleFlags:l})}break;case"tfra":{let s=M(e);e.skip(3);let c=v(e),u=this.tracks.find(y=>y.id===c);if(!u)break;u.fragmentLookupTable=[];let d=v(e),l=(d&48)>>4,f=(d&12)>>2,p=d&3,h=[M,me,Pt,v],b=h[l],g=h[f],T=h[p],k=v(e);for(let y=0;y<k;y++){let S=s===1?be(e):v(e),w=s===1?be(e):v(e);b(e),g(e),T(e),u.fragmentLookupTable.push({timestamp:S,moofOffset:w})}}break;case"moof":{this.currentFragment={moofOffset:r,moofSize:i.totalSize,implicitBaseDataOffset:r,trackData:new Map,dataStart:1/0,dataEnd:0,nextFragment:null,isKnownToBeFirstFragment:!1},this.readContiguousBoxes(e.slice(a,i.contentSize)),Se(this.fragments,this.currentFragment,s=>s.moofOffset);for(let[,s]of this.currentFragment.trackData){let c=s.samples[0],u=L(s.samples);this.currentFragment.dataStart=Math.min(this.currentFragment.dataStart,c.byteOffset),this.currentFragment.dataEnd=Math.max(this.currentFragment.dataEnd,u.byteOffset+u.byteSize)}this.currentFragment=null}break;case"traf":if(m(this.currentFragment),this.readContiguousBoxes(e.slice(a,i.contentSize)),this.currentTrack){let s=this.currentFragment.trackData.get(this.currentTrack.id);if(s){Se(this.currentTrack.fragments,this.currentFragment,d=>d.moofOffset),s.firstKeyFrameTimestamp!==null&&Se(this.currentTrack.fragmentsWithKeyFrame,this.currentFragment,d=>d.moofOffset);let{currentFragmentState:u}=this.currentTrack;m(u),u.startTimestamp!==null&&(Rs(s,u.startTimestamp),s.startTimestampIsFinal=!0)}this.currentTrack.currentFragmentState=null,this.currentTrack=null}break;case"tfhd":{m(this.currentFragment),e.skip(1);let s=Pt(e),c=!!(s&1),u=!!(s&2),d=!!(s&8),l=!!(s&16),f=!!(s&32),p=!!(s&65536),h=!!(s&131072),b=v(e),g=this.tracks.find(k=>k.id===b);if(!g)break;let T=this.fragmentTrackDefaults.find(k=>k.trackId===b);this.currentTrack=g,g.currentFragmentState={baseDataOffset:this.currentFragment.implicitBaseDataOffset,sampleDescriptionIndex:T?.defaultSampleDescriptionIndex??null,defaultSampleDuration:T?.defaultSampleDuration??null,defaultSampleSize:T?.defaultSampleSize??null,defaultSampleFlags:T?.defaultSampleFlags??null,startTimestamp:null},c?g.currentFragmentState.baseDataOffset=be(e):h&&(g.currentFragmentState.baseDataOffset=this.currentFragment.moofOffset),u&&(g.currentFragmentState.sampleDescriptionIndex=v(e)),d&&(g.currentFragmentState.defaultSampleDuration=v(e)),l&&(g.currentFragmentState.defaultSampleSize=v(e)),f&&(g.currentFragmentState.defaultSampleFlags=v(e)),p&&(g.currentFragmentState.defaultSampleDuration=0)}break;case"tfdt":{let s=this.currentTrack;if(!s)break;m(s.currentFragmentState);let c=M(e);e.skip(3);let u=c===0?v(e):be(e);s.currentFragmentState.startTimestamp=u}break;case"trun":{let s=this.currentTrack;if(!s)break;if(m(this.currentFragment),m(s.currentFragmentState),this.currentFragment.trackData.has(s.id)){console.warn("Can't have two trun boxes for the same track in one fragment. Ignoring...");break}let c=M(e),u=Pt(e),d=!!(u&1),l=!!(u&4),f=!!(u&256),p=!!(u&512),h=!!(u&1024),b=!!(u&2048),g=v(e),T=s.currentFragmentState.baseDataOffset;d&&(T+=He(e));let k=null;l&&(k=v(e));let y=T;if(g===0){this.currentFragment.implicitBaseDataOffset=y;break}let S=0,w={startTimestamp:0,endTimestamp:0,firstKeyFrameTimestamp:null,samples:[],presentationTimestamps:[],startTimestampIsFinal:!1};this.currentFragment.trackData.set(s.id,w);for(let C=0;C<g;C++){let P;f?P=v(e):(m(s.currentFragmentState.defaultSampleDuration!==null),P=s.currentFragmentState.defaultSampleDuration);let I;p?I=v(e):(m(s.currentFragmentState.defaultSampleSize!==null),I=s.currentFragmentState.defaultSampleSize);let F;h?F=v(e):(m(s.currentFragmentState.defaultSampleFlags!==null),F=s.currentFragmentState.defaultSampleFlags),C===0&&k!==null&&(F=k);let B=0;b&&(c===0?B=v(e):B=He(e));let j=!(F&65536);w.samples.push({presentationTimestamp:S+B,duration:P,byteOffset:y,byteSize:I,isKeyFrame:j}),y+=I,S+=P}w.presentationTimestamps=w.samples.map((C,P)=>({presentationTimestamp:C.presentationTimestamp,sampleIndex:P})).sort((C,P)=>C.presentationTimestamp-P.presentationTimestamp);for(let C=0;C<w.presentationTimestamps.length;C++){let P=w.presentationTimestamps[C],I=w.samples[P.sampleIndex];if(w.firstKeyFrameTimestamp===null&&I.isKeyFrame&&(w.firstKeyFrameTimestamp=I.presentationTimestamp),C<w.presentationTimestamps.length-1){let F=w.presentationTimestamps[C+1];I.duration=F.presentationTimestamp-P.presentationTimestamp}}let x=w.samples[w.presentationTimestamps[0].sampleIndex],_=w.samples[L(w.presentationTimestamps).sampleIndex];w.startTimestamp=x.presentationTimestamp,w.endTimestamp=_.presentationTimestamp+_.duration,this.currentFragment.implicitBaseDataOffset=y}break;case"\xA9nam":case"name":{if(!this.currentTrack)break;this.currentTrack.name=_r.decode(W(e,i.contentSize))}break}return e.filePos=o,!0}},qn=class{constructor(t){this.internalTrack=t;this.packetToSampleIndex=new WeakMap;this.packetToFragmentLocation=new WeakMap}getId(){return this.internalTrack.id}getCodec(){throw new Error("Not implemented on base class.")}getInternalCodecId(){return this.internalTrack.internalCodecId}getName(){return this.internalTrack.name}getLanguageCode(){return this.internalTrack.languageCode}getTimeResolution(){return this.internalTrack.timescale}async computeDuration(){let t=await this.getPacket(1/0,{metadataOnly:!0});return(t?.timestamp??0)+(t?.duration??0)}async getFirstTimestamp(){return(await this.getFirstPacket({metadataOnly:!0}))?.timestamp??0}async getFirstPacket(t){let e=await this.fetchPacketForSampleIndex(0,t);return e||!this.internalTrack.demuxer.isFragmented?e:this.performFragmentedLookup(()=>{let r=this.internalTrack.demuxer.fragments[0]??null;if(r?.isKnownToBeFirstFragment){let i=r;for(;i;){if(i.trackData.get(this.internalTrack.id))return{fragmentIndex:G(this.internalTrack.fragments,i.moofOffset,o=>o.moofOffset),sampleIndex:0,correctSampleFound:!0};i=i.nextFragment}}return{fragmentIndex:-1,sampleIndex:-1,correctSampleFound:!1}},-1/0,1/0,t)}mapTimestampIntoTimescale(t){return at(t*this.internalTrack.timescale,14)+this.internalTrack.editListOffset}async getPacket(t,e){let r=this.mapTimestampIntoTimescale(t),i=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),a=Os(i,r),o=await this.fetchPacketForSampleIndex(a,e);return!Bs(i)||!this.internalTrack.demuxer.isFragmented?o:this.performFragmentedLookup(()=>this.findSampleInFragmentsForTimestamp(r),r,r,e)}async getNextPacket(t,e){let r=this.packetToSampleIndex.get(t);if(r!==void 0)return this.fetchPacketForSampleIndex(r+1,e);let i=this.packetToFragmentLocation.get(t);if(i===void 0)throw new Error("Packet was not created from this track.");let a=i.fragment.trackData.get(this.internalTrack.id),o=G(this.internalTrack.fragments,i.fragment.moofOffset,s=>s.moofOffset);return m(o!==-1),this.performFragmentedLookup(()=>{if(i.sampleIndex+1<a.samples.length)return{fragmentIndex:o,sampleIndex:i.sampleIndex+1,correctSampleFound:!0};{let s=i.fragment;for(;s.nextFragment;)if(s=s.nextFragment,s.trackData.get(this.internalTrack.id)){let u=G(this.internalTrack.fragments,s.moofOffset,d=>d.moofOffset);return m(u!==-1),{fragmentIndex:u,sampleIndex:0,correctSampleFound:!0}}return{fragmentIndex:o,sampleIndex:-1,correctSampleFound:!1}}},-1/0,1/0,e)}async getKeyPacket(t,e){let r=this.mapTimestampIntoTimescale(t),i=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),a=Os(i,r),o=a===-1?-1:Nc(i,a),s=await this.fetchPacketForSampleIndex(o,e);return!Bs(i)||!this.internalTrack.demuxer.isFragmented?s:this.performFragmentedLookup(()=>this.findKeySampleInFragmentsForTimestamp(r),r,r,e)}async getNextKeyPacket(t,e){let r=this.packetToSampleIndex.get(t);if(r!==void 0){let s=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),c=Lc(s,r);return this.fetchPacketForSampleIndex(c,e)}let i=this.packetToFragmentLocation.get(t);if(i===void 0)throw new Error("Packet was not created from this track.");let a=i.fragment.trackData.get(this.internalTrack.id),o=G(this.internalTrack.fragments,i.fragment.moofOffset,s=>s.moofOffset);return m(o!==-1),this.performFragmentedLookup(()=>{let s=a.samples.findIndex((c,u)=>c.isKeyFrame&&u>i.sampleIndex);if(s!==-1)return{fragmentIndex:o,sampleIndex:s,correctSampleFound:!0};{let c=i.fragment;for(;c.nextFragment;){c=c.nextFragment;let u=c.trackData.get(this.internalTrack.id);if(u&&u.firstKeyFrameTimestamp!==null){let d=G(this.internalTrack.fragments,c.moofOffset,f=>f.moofOffset);m(d!==-1);let l=u.samples.findIndex(f=>f.isKeyFrame);return m(l!==-1),{fragmentIndex:d,sampleIndex:l,correctSampleFound:!0}}}return{fragmentIndex:o,sampleIndex:-1,correctSampleFound:!1}}},-1/0,1/0,e)}async fetchPacketForSampleIndex(t,e){if(t===-1)return null;let r=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),i=Wc(r,t);if(!i)return null;let a;if(e.metadataOnly)a=ce;else{let u=this.internalTrack.demuxer.reader.requestSlice(i.sampleOffset,i.sampleSize);u instanceof Promise&&(u=await u),m(u),a=W(u,i.sampleSize)}let o=(i.presentationTimestamp-this.internalTrack.editListOffset)/this.internalTrack.timescale,s=i.duration/this.internalTrack.timescale,c=new V(a,i.isKeyFrame?"key":"delta",o,s,t,i.sampleSize);return this.packetToSampleIndex.set(c,t),c}async fetchPacketInFragment(t,e,r){if(e===-1)return null;let a=t.trackData.get(this.internalTrack.id).samples[e];m(a);let o;if(r.metadataOnly)o=ce;else{let d=this.internalTrack.demuxer.reader.requestSlice(a.byteOffset,a.byteSize);d instanceof Promise&&(d=await d),m(d),o=W(d,a.byteSize)}let s=(a.presentationTimestamp-this.internalTrack.editListOffset)/this.internalTrack.timescale,c=a.duration/this.internalTrack.timescale,u=new V(o,a.isKeyFrame?"key":"delta",s,c,t.moofOffset+e,a.byteSize);return this.packetToFragmentLocation.set(u,{fragment:t,sampleIndex:e}),u}findSampleInFragmentsForTimestamp(t){let e=z(this.internalTrack.fragments,t,a=>a.trackData.get(this.internalTrack.id).startTimestamp),r=-1,i=!1;if(e!==-1){let o=this.internalTrack.fragments[e].trackData.get(this.internalTrack.id),s=z(o.presentationTimestamps,t,c=>c.presentationTimestamp);m(s!==-1),r=o.presentationTimestamps[s].sampleIndex,i=t<o.endTimestamp}return{fragmentIndex:e,sampleIndex:r,correctSampleFound:i}}findKeySampleInFragmentsForTimestamp(t){let e=z(this.internalTrack.fragmentsWithKeyFrame,t,o=>o.trackData.get(this.internalTrack.id).startTimestamp),r=-1,i=-1,a=!1;if(e!==-1){let o=this.internalTrack.fragmentsWithKeyFrame[e];r=G(this.internalTrack.fragments,o.moofOffset,d=>d.moofOffset),m(r!==-1);let s=o.trackData.get(this.internalTrack.id),c=Or(s.presentationTimestamps,d=>s.samples[d.sampleIndex].isKeyFrame&&d.presentationTimestamp<=t);m(c!==-1),i=s.presentationTimestamps[c].sampleIndex,a=t<s.endTimestamp}return{fragmentIndex:r,sampleIndex:i,correctSampleFound:a}}async performFragmentedLookup(t,e,r,i){let a=this.internalTrack.demuxer,o=await a.fragmentLookupMutex.acquire();try{let{fragmentIndex:s,sampleIndex:c,correctSampleFound:u}=t();if(u){let k=this.internalTrack.fragments[s];return this.fetchPacketInFragment(k,c,i)}let d=null,l=s,f=c,p=this.internalTrack.fragmentLookupTable?z(this.internalTrack.fragmentLookupTable,e,k=>k.timestamp):-1,h=p!==-1?this.internalTrack.fragmentLookupTable[p]:null,b,g=!1;if(s===-1)b=h?.moofOffset??0,g=b===0;else{let k=this.internalTrack.fragments[s];!h||k.moofOffset>=h.moofOffset?(b=k.moofOffset+k.moofSize,d=k):b=h.moofOffset}for(;;){if(d){let w=d.trackData.get(this.internalTrack.id);if(w&&w.startTimestamp>r)break;if(d.nextFragment){b=d.nextFragment.moofOffset+d.nextFragment.moofSize,d=d.nextFragment;continue}}let k=a.reader.requestSliceRange(b,ye,Me);if(k instanceof Promise&&(k=await k),!k)break;let y=b,S=et(k);if(!S)break;if(S.name==="moof"){let w=G(a.fragments,y,I=>I.moofOffset),x;w===-1?x=await a.readFragment(y):x=a.fragments[w],d&&(d.nextFragment=x),d=x,g&&(x.isKnownToBeFirstFragment=!0,g=!1);let{fragmentIndex:_,sampleIndex:C,correctSampleFound:P}=t();if(P){let I=this.internalTrack.fragments[_];return this.fetchPacketInFragment(I,C,i)}_!==-1&&(l=_,f=C)}b=y+S.totalSize}let T=l!==-1?this.internalTrack.fragments[l]:null;if(h&&(!T||T.moofOffset<h.moofOffset)){let y=this.internalTrack.fragmentLookupTable[p-1]?.timestamp??-1/0;return this.performFragmentedLookup(t,y,r,i)}return T?this.fetchPacketInFragment(T,f,i):null}finally{o()}}},na=class extends qn{constructor(e){super(e);this.decoderConfigPromise=null;this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getCodedWidth(){return this.internalTrack.info.width}getCodedHeight(){return this.internalTrack.info.height}getRotation(){return this.internalTrack.rotation}async getColorSpace(){return{primaries:this.internalTrack.info.colorSpace?.primaries,transfer:this.internalTrack.info.colorSpace?.transfer,matrix:this.internalTrack.info.colorSpace?.matrix,fullRange:this.internalTrack.info.colorSpace?.fullRange}}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfigPromise??=(async()=>{if(this.internalTrack.info.codec==="vp9"&&!this.internalTrack.info.vp9CodecInfo){let e=await this.getFirstPacket({});this.internalTrack.info.vp9CodecInfo=e&&Gr(e.data)}else if(this.internalTrack.info.codec==="av1"&&!this.internalTrack.info.av1CodecInfo){let e=await this.getFirstPacket({});this.internalTrack.info.av1CodecInfo=e&&Xr(e.data)}return{codec:Vr(this.internalTrack.info),codedWidth:this.internalTrack.info.width,codedHeight:this.internalTrack.info.height,description:this.internalTrack.info.codecDescription??void 0,colorSpace:this.internalTrack.info.colorSpace??void 0}})():null}},ia=class extends qn{constructor(e){super(e);this.decoderConfig=null;this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getNumberOfChannels(){return this.internalTrack.info.numberOfChannels}getSampleRate(){return this.internalTrack.info.sampleRate}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfig??={codec:Ur(this.internalTrack.info),numberOfChannels:this.internalTrack.info.numberOfChannels,sampleRate:this.internalTrack.info.sampleRate,description:this.internalTrack.info.codecDescription??void 0}:null}},Os=(n,t)=>{if(n.presentationTimestamps){let e=z(n.presentationTimestamps,t,r=>r.presentationTimestamp);return e===-1?-1:n.presentationTimestamps[e].sampleIndex}else{let e=z(n.sampleTimingEntries,t,i=>i.startDecodeTimestamp);if(e===-1)return-1;let r=n.sampleTimingEntries[e];return r.startIndex+Math.min(Math.floor((t-r.startDecodeTimestamp)/r.delta),r.count-1)}},Wc=(n,t)=>{let e=z(n.sampleTimingEntries,t,T=>T.startIndex),r=n.sampleTimingEntries[e];if(!r||r.startIndex+r.count<=t)return null;let a=r.startDecodeTimestamp+(t-r.startIndex)*r.delta,o=z(n.sampleCompositionTimeOffsets,t,T=>T.startIndex),s=n.sampleCompositionTimeOffsets[o];s&&t-s.startIndex<s.count&&(a+=s.offset);let c=n.sampleSizes[Math.min(t,n.sampleSizes.length-1)],u=z(n.sampleToChunk,t,T=>T.startSampleIndex),d=n.sampleToChunk[u];m(d);let l=d.startChunkIndex+Math.floor((t-d.startSampleIndex)/d.samplesPerChunk),f=n.chunkOffsets[l],p=d.startSampleIndex+(l-d.startChunkIndex)*d.samplesPerChunk,h=0,b=f;if(n.sampleSizes.length===1)b+=c*(t-p),h+=c*d.samplesPerChunk;else for(let T=p;T<p+d.samplesPerChunk;T++){let k=n.sampleSizes[T];T<t&&(b+=k),h+=k}let g=r.delta;if(n.presentationTimestamps){let T=n.presentationTimestampIndexMap[t];m(T!==void 0),T<n.presentationTimestamps.length-1&&(g=n.presentationTimestamps[T+1].presentationTimestamp-a)}return{presentationTimestamp:a,duration:g,sampleOffset:b,sampleSize:c,chunkOffset:f,chunkSize:h,isKeyFrame:n.keySampleIndices?G(n.keySampleIndices,t,T=>T)!==-1:!0}},Nc=(n,t)=>{if(!n.keySampleIndices)return t;let e=z(n.keySampleIndices,t,r=>r);return n.keySampleIndices[e]??-1},Lc=(n,t)=>{if(!n.keySampleIndices)return t+1;let e=z(n.keySampleIndices,t,r=>r);return n.keySampleIndices[e+1]??-1},Rs=(n,t)=>{n.startTimestamp+=t,n.endTimestamp+=t;for(let e of n.samples)e.presentationTimestamp+=t;for(let e of n.presentationTimestamps)e.presentationTimestamp+=t},Hc=n=>{let[t,,,e]=n,r=Math.hypot(t,e),i=t/r,a=e/r,o=-Math.atan2(a,i)*(180/Math.PI);return Number.isFinite(o)?o:0},Bs=n=>n.sampleSizes.length===0;var aa=[{id:290298740,flag:"seekHeadSeen"},{id:357149030,flag:"infoSeen"},{id:374648427,flag:"tracksSeen"},{id:475249515,flag:"cuesSeen"}],Ds=10*2**20,Kn=class extends fe{constructor(e){super(e);this.readMetadataPromise=null;this.segments=[];this.currentSegment=null;this.currentTrack=null;this.currentCluster=null;this.currentBlock=null;this.currentCueTime=null;this.isWebM=!1;this.reader=e._reader}async computeDuration(){let e=await this.getTracks(),r=await Promise.all(e.map(i=>i.computeDuration()));return Math.max(0,...r)}async getTracks(){return await this.readMetadata(),this.segments.flatMap(e=>e.tracks.map(r=>r.inputTrack))}async getMimeType(){await this.readMetadata();let e=await this.getTracks(),r=await Promise.all(e.map(i=>i.getCodecParameterString()));return pn({isWebM:this.isWebM,hasVideo:this.segments.some(i=>i.tracks.some(a=>a.info?.type==="video")),hasAudio:this.segments.some(i=>i.tracks.some(a=>a.info?.type==="audio")),codecStrings:r.filter(Boolean)})}readMetadata(){return this.readMetadataPromise??=(async()=>{let e=0;for(;;){let r=this.reader.requestSliceRange(e,ke,Oe);if(r instanceof Promise&&(r=await r),!r)break;let i=Re(r);if(!i)break;let a=i.id,o=i.size,s=r.filePos;if(a===440786851){dt(o);let c=this.reader.requestSlice(s,o);if(c instanceof Promise&&(c=await c),!c)break;this.readContiguousElements(c)}else if(a===408125543){if(await this.readSegment(s,o),o===null||this.reader.fileSize===null)break}else if(a===524531317){if(this.reader.fileSize===null)break;o===null&&(o=(await fn(this.reader,s,dn,this.reader.fileSize)).pos-s);let c=L(this.segments);c&&(c.elementEndPos=s+o)}dt(o),e=s+o}})()}async readSegment(e,r){this.currentSegment={seekHeadSeen:!1,infoSeen:!1,tracksSeen:!1,cuesSeen:!1,timestampScale:-1,timestampFactor:-1,duration:-1,seekEntries:[],tracks:[],cuePoints:[],dataStartPos:e,elementEndPos:r===null?null:e+r,clusterSeekStartPos:e,clusters:[],clusterLookupMutex:new oe},this.segments.push(this.currentSegment);let i=e;for(;this.currentSegment.elementEndPos===null||i<this.currentSegment.elementEndPos;){let u=this.reader.requestSliceRange(i,ke,Oe);if(u instanceof Promise&&(u=await u),!u)break;let d=i,l=Re(u);if(!l||!It.includes(l.id)&&l.id!==236){let g=await Ei(this.reader,d,It,Math.min(this.currentSegment.elementEndPos??1/0,d+Ds));if(g){i=g;continue}else break}let{id:f,size:p}=l,h=u.filePos,b=aa.findIndex(g=>g.id===f);if(b!==-1){let g=aa[b].flag;this.currentSegment[g]=!0,dt(p);let T=this.reader.requestSlice(h,p);T instanceof Promise&&(T=await T),T&&this.readContiguousElements(T)}else if(f===524531317){this.currentSegment.clusterSeekStartPos=d;break}if(p===null)break;i=h+p}if(this.reader.fileSize!==null){this.currentSegment.seekEntries.sort((u,d)=>u.segmentPosition-d.segmentPosition);for(let u of this.currentSegment.seekEntries){let d=aa.find(g=>g.id===u.id);if(!d||this.currentSegment[d.flag])continue;let l=this.reader.requestSliceRange(e+u.segmentPosition,ke,Oe);if(l instanceof Promise&&(l=await l),!l)continue;let f=Re(l);if(!f)continue;let{id:p,size:h}=f;if(p!==d.id)continue;dt(h),this.currentSegment[d.flag]=!0;let b=this.reader.requestSlice(l.filePos,h);b instanceof Promise&&(b=await b),b&&this.readContiguousElements(b)}}this.currentSegment.timestampScale===-1&&(this.currentSegment.timestampScale=1e6,this.currentSegment.timestampFactor=1e9/1e6),this.currentSegment.tracks.sort((u,d)=>Number(d.isDefault)-Number(u.isDefault)),this.currentSegment.cuePoints.sort((u,d)=>u.clusterPosition-d.clusterPosition);let a=this.currentSegment.tracks.map(u=>u.id),o=new Set,s=null,c=null;for(let u of this.currentSegment.cuePoints){if(u.clusterPosition!==s){for(let l of o)m(c),this.currentSegment.tracks.find(p=>p.id===l).cuePoints.push(c);for(let l of a)o.add(l)}if(c=u,!o.has(u.trackId))continue;this.currentSegment.tracks.find(l=>l.id===u.trackId).cuePoints.push(u),o.delete(u.trackId),s=u.clusterPosition}for(let u of o)m(c),this.currentSegment.tracks.find(l=>l.id===u).cuePoints.push(c);for(let u of this.currentSegment.tracks)u.cuePoints.sort((d,l)=>d.time-l.time);this.currentSegment=null}async readCluster(e,r){let i=this.reader.requestSliceRange(e,ke,Oe);i instanceof Promise&&(i=await i),m(i);let a=e,o=Re(i);m(o);let s=o.id,c=o.size,u=i.filePos;c===null&&(c=(await fn(this.reader,u,dn,r.elementEndPos)).pos-u),m(s===524531317);let d=this.reader.requestSlice(u,c);d instanceof Promise&&(d=await d);let l={elementStartPos:a,elementEndPos:u+c,dataStartPos:u,timestamp:-1,trackData:new Map,nextCluster:null,isKnownToBeFirstCluster:!1};this.currentCluster=l,d&&this.readContiguousElements(d);for(let[f,p]of l.trackData){let h=r.tracks.find(y=>y.id===f)??null;m(p.blocks.length>0);let b=!1,g=!1;for(let y=0;y<p.blocks.length;y++){let S=p.blocks[y];S.timestamp+=l.timestamp,b||=S.referencedTimestamps.length>0,g||=S.lacing!==0}b&&(p.blocks=qc(p.blocks)),p.presentationTimestamps=p.blocks.map((y,S)=>({timestamp:y.timestamp,blockIndex:S})).sort((y,S)=>y.timestamp-S.timestamp);for(let y=0;y<p.presentationTimestamps.length;y++){let S=p.presentationTimestamps[y],w=p.blocks[S.blockIndex];if(p.firstKeyFrameTimestamp===null&&w.isKeyFrame&&(p.firstKeyFrameTimestamp=w.timestamp),y<p.presentationTimestamps.length-1){let x=p.presentationTimestamps[y+1];w.duration=x.timestamp-w.timestamp}else w.duration===0&&h?.defaultDuration!=null&&w.lacing===0&&(w.duration=h.defaultDuration)}g&&(this.expandLacedBlocks(p.blocks,h),p.presentationTimestamps=p.blocks.map((y,S)=>({timestamp:y.timestamp,blockIndex:S})).sort((y,S)=>y.timestamp-S.timestamp));let T=p.blocks[p.presentationTimestamps[0].blockIndex],k=p.blocks[L(p.presentationTimestamps).blockIndex];p.startTimestamp=T.timestamp,p.endTimestamp=k.timestamp+k.duration,h&&(Se(h.clusters,l,S=>S.elementStartPos),p.firstKeyFrameTimestamp!==null&&Se(h.clustersWithKeyFrame,l,S=>S.elementStartPos))}return Se(r.clusters,l,f=>f.elementStartPos),this.currentCluster=null,l}getTrackDataInCluster(e,r){let i=e.trackData.get(r);return i||(i={startTimestamp:0,endTimestamp:0,firstKeyFrameTimestamp:null,blocks:[],presentationTimestamps:[]},e.trackData.set(r,i)),i}expandLacedBlocks(e,r){for(let i=0;i<e.length;i++){let a=e[i];if(a.lacing===0)continue;let o=xt.tempFromBytes(a.data),s=[],c=M(o)+1;switch(a.lacing){case 1:{let u=0;for(let d=0;d<c-1;d++){let l=0;for(;o.bufferPos<o.length;){let f=M(o);if(l+=f,f<255){s.push(l),u+=l;break}}}s.push(o.length-(o.bufferPos+u))}break;case 2:{let u=o.length-1,d=Math.floor(u/c);for(let l=0;l<c;l++)s.push(d)}break;case 3:{let u=At(o);m(u!==null);let d=u;s.push(d);let l=d;for(let f=1;f<c-1;f++){let p=o.bufferPos,h=At(o);m(h!==null);let b=h,T=(1<<(o.bufferPos-p)*7-1)-1,k=b-T;d+=k,s.push(d),l+=d}s.push(o.length-(o.bufferPos+l))}break;default:m(!1)}m(s.length===c),e.splice(i,1);for(let u=0;u<c;u++){let d=s[u],l=W(o,d),f=a.duration||c*(r?.defaultDuration??0),p=a.timestamp+f*u/c,h=f/c;e.splice(i+u,0,{timestamp:p,duration:h,isKeyFrame:a.isKeyFrame,referencedTimestamps:a.referencedTimestamps,data:l,lacing:0})}i+=c,i--}}readContiguousElements(e){let r=e.filePos;for(;e.filePos-r<=e.length-ke&&this.traverseElement(e););}traverseElement(e){let r=Re(e);if(!r)return!1;let{id:i,size:a}=r,o=e.filePos;switch(dt(a),i){case 17026:this.isWebM=ut(e,a)==="webm";break;case 19899:{if(!this.currentSegment)break;let s={id:-1,segmentPosition:-1};this.currentSegment.seekEntries.push(s),this.readContiguousElements(e.slice(o,a)),(s.id===-1||s.segmentPosition===-1)&&this.currentSegment.seekEntries.pop()}break;case 21419:{let s=this.currentSegment?.seekEntries[this.currentSegment.seekEntries.length-1];if(!s)break;s.id=N(e,a)}break;case 21420:{let s=this.currentSegment?.seekEntries[this.currentSegment.seekEntries.length-1];if(!s)break;s.segmentPosition=N(e,a)}break;case 2807729:{if(!this.currentSegment)break;this.currentSegment.timestampScale=N(e,a),this.currentSegment.timestampFactor=1e9/this.currentSegment.timestampScale}break;case 17545:{if(!this.currentSegment)break;this.currentSegment.duration=mn(e,a)}break;case 174:{if(!this.currentSegment)break;if(this.currentTrack={id:-1,segment:this.currentSegment,demuxer:this,clusters:[],clustersWithKeyFrame:[],cuePoints:[],isDefault:!1,inputTrack:null,codecId:null,codecPrivate:null,defaultDuration:null,name:null,languageCode:Z,info:null},this.readContiguousElements(e.slice(o,a)),this.currentTrack&&this.currentTrack.id!==-1&&this.currentTrack.codecId&&this.currentTrack.info){let s=this.currentTrack.codecId.indexOf("/"),c=s===-1?this.currentTrack.codecId:this.currentTrack.codecId.slice(0,s);if(this.currentTrack.info.type==="video"&&this.currentTrack.info.width!==-1&&this.currentTrack.info.height!==-1){this.currentTrack.codecId===we.avc?(this.currentTrack.info.codec="avc",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):this.currentTrack.codecId===we.hevc?(this.currentTrack.info.codec="hevc",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):c===we.vp8?this.currentTrack.info.codec="vp8":c===we.vp9?this.currentTrack.info.codec="vp9":c===we.av1&&(this.currentTrack.info.codec="av1");let u=this.currentTrack,d=new Ce(new sa(u));this.currentTrack.inputTrack=d,this.currentSegment.tracks.push(this.currentTrack)}else if(this.currentTrack.info.type==="audio"&&this.currentTrack.info.numberOfChannels!==-1&&this.currentTrack.info.sampleRate!==-1){c===we.aac?(this.currentTrack.info.codec="aac",this.currentTrack.info.aacCodecInfo={isMpeg2:this.currentTrack.codecId.includes("MPEG2")},this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):this.currentTrack.codecId===we.mp3?this.currentTrack.info.codec="mp3":c===we.opus?(this.currentTrack.info.codec="opus",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):c===we.vorbis?(this.currentTrack.info.codec="vorbis",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):c===we.flac?(this.currentTrack.info.codec="flac",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):this.currentTrack.codecId==="A_PCM/INT/LIT"?this.currentTrack.info.bitDepth===8?this.currentTrack.info.codec="pcm-u8":this.currentTrack.info.bitDepth===16?this.currentTrack.info.codec="pcm-s16":this.currentTrack.info.bitDepth===24?this.currentTrack.info.codec="pcm-s24":this.currentTrack.info.bitDepth===32&&(this.currentTrack.info.codec="pcm-s32"):this.currentTrack.codecId==="A_PCM/INT/BIG"?this.currentTrack.info.bitDepth===8?this.currentTrack.info.codec="pcm-u8":this.currentTrack.info.bitDepth===16?this.currentTrack.info.codec="pcm-s16be":this.currentTrack.info.bitDepth===24?this.currentTrack.info.codec="pcm-s24be":this.currentTrack.info.bitDepth===32&&(this.currentTrack.info.codec="pcm-s32be"):this.currentTrack.codecId==="A_PCM/FLOAT/IEEE"&&(this.currentTrack.info.bitDepth===32?this.currentTrack.info.codec="pcm-f32":this.currentTrack.info.bitDepth===64&&(this.currentTrack.info.codec="pcm-f64"));let u=this.currentTrack,d=new re(new oa(u));this.currentTrack.inputTrack=d,this.currentSegment.tracks.push(this.currentTrack)}}this.currentTrack=null}break;case 215:{if(!this.currentTrack)break;this.currentTrack.id=N(e,a)}break;case 131:{if(!this.currentTrack)break;let s=N(e,a);s===1?this.currentTrack.info={type:"video",width:-1,height:-1,rotation:0,codec:null,codecDescription:null,colorSpace:null}:s===2&&(this.currentTrack.info={type:"audio",numberOfChannels:-1,sampleRate:-1,bitDepth:-1,codec:null,codecDescription:null,aacCodecInfo:null})}break;case 185:{if(!this.currentTrack)break;N(e,a)||(this.currentSegment.tracks.pop(),this.currentTrack=null)}break;case 136:{if(!this.currentTrack)break;this.currentTrack.isDefault=!!N(e,a)}break;case 134:{if(!this.currentTrack)break;this.currentTrack.codecId=ut(e,a)}break;case 25506:{if(!this.currentTrack)break;this.currentTrack.codecPrivate=W(e,a)}break;case 2352003:{if(!this.currentTrack)break;this.currentTrack.defaultDuration=this.currentTrack.segment.timestampFactor*N(e,a)/1e9}break;case 21358:{if(!this.currentTrack)break;this.currentTrack.name=hs(e,a)}break;case 2274716:{if(!this.currentTrack||this.currentTrack.languageCode!==Z)break;this.currentTrack.languageCode=ut(e,a),Ue(this.currentTrack.languageCode)||(this.currentTrack.languageCode=Z)}break;case 2274717:{if(!this.currentTrack)break;let c=ut(e,a).split("-")[0];c?this.currentTrack.languageCode=c:this.currentTrack.languageCode=Z}break;case 224:{if(this.currentTrack?.info?.type!=="video")break;this.readContiguousElements(e.slice(o,a))}break;case 176:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.width=N(e,a)}break;case 186:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.height=N(e,a)}break;case 21936:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.colorSpace={},this.readContiguousElements(e.slice(o,a))}break;case 21937:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;let s=N(e,a),c=Fr[s]??null;this.currentTrack.info.colorSpace.matrix=c}break;case 21945:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;this.currentTrack.info.colorSpace.fullRange=N(e,a)===2}break;case 21946:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;let s=N(e,a),c=Ar[s]??null;this.currentTrack.info.colorSpace.transfer=c}break;case 21947:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;let s=N(e,a),c=Ir[s]??null;this.currentTrack.info.colorSpace.primaries=c}break;case 30320:{if(this.currentTrack?.info?.type!=="video")break;this.readContiguousElements(e.slice(o,a))}break;case 30325:{if(this.currentTrack?.info?.type!=="video")break;let c=-mn(e,a);try{this.currentTrack.info.rotation=$e(c)}catch{}}break;case 225:{if(this.currentTrack?.info?.type!=="audio")break;this.readContiguousElements(e.slice(o,a))}break;case 181:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.sampleRate=mn(e,a)}break;case 159:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.numberOfChannels=N(e,a)}break;case 25188:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.bitDepth=N(e,a)}break;case 187:{if(!this.currentSegment)break;this.readContiguousElements(e.slice(o,a)),this.currentCueTime=null}break;case 179:this.currentCueTime=N(e,a);break;case 183:{if(this.currentCueTime===null)break;m(this.currentSegment);let s={time:this.currentCueTime,trackId:-1,clusterPosition:-1};this.currentSegment.cuePoints.push(s),this.readContiguousElements(e.slice(o,a)),(s.trackId===-1||s.clusterPosition===-1)&&this.currentSegment.cuePoints.pop()}break;case 247:{let s=this.currentSegment?.cuePoints[this.currentSegment.cuePoints.length-1];if(!s)break;s.trackId=N(e,a)}break;case 241:{let s=this.currentSegment?.cuePoints[this.currentSegment.cuePoints.length-1];if(!s)break;m(this.currentSegment),s.clusterPosition=this.currentSegment.dataStartPos+N(e,a)}break;case 231:{if(!this.currentCluster)break;this.currentCluster.timestamp=N(e,a)}break;case 163:{if(!this.currentCluster)break;let s=At(e);if(s===null)break;let c=ir(e),u=M(e),d=!!(u&128),l=u>>1&3;this.getTrackDataInCluster(this.currentCluster,s).blocks.push({timestamp:c,duration:0,isKeyFrame:d,referencedTimestamps:[],data:W(e,a-(e.filePos-o)),lacing:l})}break;case 160:{if(!this.currentCluster)break;if(this.readContiguousElements(e.slice(o,a)),this.currentBlock){for(let s=0;s<this.currentBlock.referencedTimestamps.length;s++)this.currentBlock.referencedTimestamps[s]+=this.currentBlock.timestamp;this.currentBlock=null}}break;case 161:{if(!this.currentCluster)break;let s=At(e);if(s===null)break;let c=ir(e),d=M(e)>>1&3,l=this.getTrackDataInCluster(this.currentCluster,s);this.currentBlock={timestamp:c,duration:0,isKeyFrame:!0,referencedTimestamps:[],data:W(e,a-(e.filePos-o)),lacing:d},l.blocks.push(this.currentBlock)}break;case 155:{if(!this.currentBlock)break;this.currentBlock.duration=N(e,a)}break;case 251:{if(!this.currentBlock)break;this.currentBlock.isKeyFrame=!1;let s=ps(e,a);this.currentBlock.referencedTimestamps.push(s)}break}return e.filePos=o+a,!0}},jn=class{constructor(t){this.internalTrack=t;this.packetToClusterLocation=new WeakMap}getId(){return this.internalTrack.id}getCodec(){throw new Error("Not implemented on base class.")}getInternalCodecId(){return this.internalTrack.codecId}async computeDuration(){let t=await this.getPacket(1/0,{metadataOnly:!0});return(t?.timestamp??0)+(t?.duration??0)}getName(){return this.internalTrack.name}getLanguageCode(){return this.internalTrack.languageCode}async getFirstTimestamp(){return(await this.getFirstPacket({metadataOnly:!0}))?.timestamp??0}getTimeResolution(){return this.internalTrack.segment.timestampFactor}async getFirstPacket(t){return this.performClusterLookup(()=>{let e=this.internalTrack.segment.clusters[0]??null;if(e?.isKnownToBeFirstCluster){let r=e;for(;r;){if(r.trackData.get(this.internalTrack.id))return{clusterIndex:G(this.internalTrack.clusters,r.elementStartPos,a=>a.elementStartPos),blockIndex:0,correctBlockFound:!0};r=r.nextCluster}}return{clusterIndex:-1,blockIndex:-1,correctBlockFound:!1}},-1/0,1/0,t)}intoTimescale(t){return at(t*this.internalTrack.segment.timestampFactor,14)}async getPacket(t,e){let r=this.intoTimescale(t);return this.performClusterLookup(()=>this.findBlockInClustersForTimestamp(r),r,r,e)}async getNextPacket(t,e){let r=this.packetToClusterLocation.get(t);if(r===void 0)throw new Error("Packet was not created from this track.");let i=r.cluster.trackData.get(this.internalTrack.id),a=G(this.internalTrack.clusters,r.cluster.elementStartPos,o=>o.elementStartPos);return m(a!==-1),this.performClusterLookup(()=>{if(r.blockIndex+1<i.blocks.length)return{clusterIndex:a,blockIndex:r.blockIndex+1,correctBlockFound:!0};{let o=r.cluster;for(;o.nextCluster;)if(o=o.nextCluster,o.trackData.get(this.internalTrack.id)){let c=G(this.internalTrack.clusters,o.elementStartPos,u=>u.elementStartPos);return m(c!==-1),{clusterIndex:c,blockIndex:0,correctBlockFound:!0}}return{clusterIndex:a,blockIndex:-1,correctBlockFound:!1}}},-1/0,1/0,e)}async getKeyPacket(t,e){let r=this.intoTimescale(t);return this.performClusterLookup(()=>this.findKeyBlockInClustersForTimestamp(r),r,r,e)}async getNextKeyPacket(t,e){let r=this.packetToClusterLocation.get(t);if(r===void 0)throw new Error("Packet was not created from this track.");let i=r.cluster.trackData.get(this.internalTrack.id),a=G(this.internalTrack.clusters,r.cluster.elementStartPos,o=>o.elementStartPos);return m(a!==-1),this.performClusterLookup(()=>{let o=i.blocks.findIndex((s,c)=>s.isKeyFrame&&c>r.blockIndex);if(o!==-1)return{clusterIndex:a,blockIndex:o,correctBlockFound:!0};{let s=r.cluster;for(;s.nextCluster;){s=s.nextCluster;let c=s.trackData.get(this.internalTrack.id);if(c&&c.firstKeyFrameTimestamp!==null){let u=G(this.internalTrack.clusters,s.elementStartPos,l=>l.elementStartPos);m(u!==-1);let d=c.blocks.findIndex(l=>l.isKeyFrame);return m(d!==-1),{clusterIndex:u,blockIndex:d,correctBlockFound:!0}}}return{clusterIndex:a,blockIndex:-1,correctBlockFound:!1}}},-1/0,1/0,e)}async fetchPacketInCluster(t,e,r){if(e===-1)return null;let a=t.trackData.get(this.internalTrack.id).blocks[e];m(a);let o=r.metadataOnly?ce:a.data,s=a.timestamp/this.internalTrack.segment.timestampFactor,c=a.duration/this.internalTrack.segment.timestampFactor,u=new V(o,a.isKeyFrame?"key":"delta",s,c,t.dataStartPos+e,a.data.byteLength);return this.packetToClusterLocation.set(u,{cluster:t,blockIndex:e}),u}findBlockInClustersForTimestamp(t){let e=z(this.internalTrack.clusters,t,a=>a.trackData.get(this.internalTrack.id).startTimestamp),r=-1,i=!1;if(e!==-1){let o=this.internalTrack.clusters[e].trackData.get(this.internalTrack.id),s=z(o.presentationTimestamps,t,c=>c.timestamp);m(s!==-1),r=o.presentationTimestamps[s].blockIndex,i=t<o.endTimestamp}return{clusterIndex:e,blockIndex:r,correctBlockFound:i}}findKeyBlockInClustersForTimestamp(t){let e=z(this.internalTrack.clustersWithKeyFrame,t,o=>o.trackData.get(this.internalTrack.id).firstKeyFrameTimestamp),r=-1,i=-1,a=!1;if(e!==-1){let o=this.internalTrack.clustersWithKeyFrame[e];r=G(this.internalTrack.clusters,o.elementStartPos,d=>d.elementStartPos),m(r!==-1);let s=o.trackData.get(this.internalTrack.id),c=Or(s.presentationTimestamps,d=>s.blocks[d.blockIndex].isKeyFrame&&d.timestamp<=t);m(c!==-1),i=s.presentationTimestamps[c].blockIndex,a=t<s.endTimestamp}return{clusterIndex:r,blockIndex:i,correctBlockFound:a}}async performClusterLookup(t,e,r,i){let{demuxer:a,segment:o}=this.internalTrack,s=await o.clusterLookupMutex.acquire();try{let{clusterIndex:c,blockIndex:u,correctBlockFound:d}=t();if(d){let y=this.internalTrack.clusters[c];return this.fetchPacketInCluster(y,u,i)}let l=null,f=c,p=u,h=z(this.internalTrack.cuePoints,e,y=>y.time),b=h!==-1?this.internalTrack.cuePoints[h]:null,g,T=!1;if(c===-1)g=b?.clusterPosition??o.clusterSeekStartPos,T=g===o.clusterSeekStartPos;else{let y=this.internalTrack.clusters[c];!b||y.elementStartPos>=b.clusterPosition?(g=y.elementEndPos,l=y):g=b.clusterPosition}for(;o.elementEndPos===null||g<=o.elementEndPos-ke;){if(l){let P=l.trackData.get(this.internalTrack.id);if(P&&P.startTimestamp>r)break;if(l.nextCluster){g=l.nextCluster.elementEndPos,l=l.nextCluster;continue}}let y=a.reader.requestSliceRange(g,ke,Oe);if(y instanceof Promise&&(y=await y),!y)break;let S=g,w=Re(y);if(!w||!It.includes(w.id)&&w.id!==236){let P=await Ei(a.reader,S,It,Math.min(o.elementEndPos??1/0,S+Ds));if(P){g=P;continue}else break}let x=w.id,_=w.size,C=y.filePos;if(x===524531317){let P=G(o.clusters,S,J=>J.elementStartPos),I;P===-1?I=await a.readCluster(S,o):I=o.clusters[P],l&&(l.nextCluster=I),l=I,T&&(I.isKnownToBeFirstCluster=!0,T=!1);let{clusterIndex:F,blockIndex:B,correctBlockFound:j}=t();if(j){let J=this.internalTrack.clusters[F];return this.fetchPacketInCluster(J,B,i)}F!==-1&&(f=F,p=B)}if(_===null){x===524531317?(m(l),_=l.elementEndPos-C):_=(await fn(a.reader,C,dn,o.elementEndPos)).pos-C;let P=C+_;if(o.elementEndPos!==null&&P>o.elementEndPos-ke)break;{let I=a.reader.requestSliceRange(P,ke,Oe);if(I instanceof Promise&&(I=await I),!I)break;if(ln(I)===408125543){o.elementEndPos=P;break}}}g=C+_}let k=f!==-1?this.internalTrack.clusters[f]:null;if(b&&(!k||k.elementStartPos<b.clusterPosition)){let S=this.internalTrack.cuePoints[h-1]?.time??-1/0;return this.performClusterLookup(t,S,r,i)}return k?this.fetchPacketInCluster(k,p,i):null}finally{s()}}},sa=class extends jn{constructor(e){super(e);this.decoderConfigPromise=null;this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getCodedWidth(){return this.internalTrack.info.width}getCodedHeight(){return this.internalTrack.info.height}getRotation(){return this.internalTrack.info.rotation}async getColorSpace(){return{primaries:this.internalTrack.info.colorSpace?.primaries,transfer:this.internalTrack.info.colorSpace?.transfer,matrix:this.internalTrack.info.colorSpace?.matrix,fullRange:this.internalTrack.info.colorSpace?.fullRange}}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfigPromise??=(async()=>{let e=null;return(this.internalTrack.info.codec==="vp9"||this.internalTrack.info.codec==="av1"||this.internalTrack.info.codec==="avc"&&!this.internalTrack.info.codecDescription||this.internalTrack.info.codec==="hevc"&&!this.internalTrack.info.codecDescription)&&(e=await this.getFirstPacket({})),{codec:Vr({width:this.internalTrack.info.width,height:this.internalTrack.info.height,codec:this.internalTrack.info.codec,codecDescription:this.internalTrack.info.codecDescription,colorSpace:this.internalTrack.info.colorSpace,avcCodecInfo:this.internalTrack.info.codec==="avc"&&e?Qr(e.data):null,hevcCodecInfo:this.internalTrack.info.codec==="hevc"&&e?$r(e.data):null,vp9CodecInfo:this.internalTrack.info.codec==="vp9"&&e?Gr(e.data):null,av1CodecInfo:this.internalTrack.info.codec==="av1"&&e?Xr(e.data):null}),codedWidth:this.internalTrack.info.width,codedHeight:this.internalTrack.info.height,description:this.internalTrack.info.codecDescription??void 0,colorSpace:this.internalTrack.info.colorSpace??void 0}})():null}},oa=class extends jn{constructor(e){super(e);this.decoderConfig=null;this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getNumberOfChannels(){return this.internalTrack.info.numberOfChannels}getSampleRate(){return this.internalTrack.info.sampleRate}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfig??={codec:Ur({codec:this.internalTrack.info.codec,codecDescription:this.internalTrack.info.codecDescription,aacCodecInfo:this.internalTrack.info.aacCodecInfo}),numberOfChannels:this.internalTrack.info.numberOfChannels,sampleRate:this.internalTrack.info.sampleRate,description:this.internalTrack.info.codecDescription??void 0}:null}},qc=n=>{let t=new Map;for(let a=0;a<n.length;a++){let o=n[a];t.set(o.timestamp,o)}let e=new Set,r=[],i=a=>{if(!e.has(a)){e.add(a);for(let o=0;o<a.referencedTimestamps.length;o++){let s=a.referencedTimestamps[o],c=t.get(s);c&&i(c)}r.push(a)}};for(let a=0;a<n.length;a++)i(n[a]);return r};var Qn=n=>ie(n,3)!=="ID3"?(n.skip(-3),null):(n.skip(3),{size:Kc(v(n))}),Sr=async(n,t,e)=>{let r=t;for(;e===null||r<e;){let i=n.requestSlice(r,4);if(i instanceof Promise&&(i=await i),!i)break;let a=v(i),o=kn(a,n.fileSize!==null?n.fileSize-r:null);if(o.header)return{header:o.header,startPos:r};r+=o.bytesAdvanced}return null},Kc=n=>{let t=2130706432,e=0;for(;t!==0;)e>>=1,e|=n&t,t>>=8;return e};var $n=class extends fe{constructor(e){super(e);this.metadataPromise=null;this.firstFrameHeader=null;this.loadedSamples=[];this.tracks=[];this.readingMutex=new oe;this.lastSampleLoaded=!1;this.lastLoadedPos=0;this.nextTimestampInSamples=0;this.reader=e._reader}async readMetadata(){return this.metadataPromise??=(async()=>{for(;!this.firstFrameHeader&&!this.lastSampleLoaded;)await this.advanceReader();m(this.firstFrameHeader),this.tracks=[new re(new ca(this))]})()}async advanceReader(){if(this.lastLoadedPos===0){let c=this.reader.requestSlice(0,10);if(c instanceof Promise&&(c=await c),!c){this.lastSampleLoaded=!0;return}let u=Qn(c);u&&(this.lastLoadedPos+=10+u.size)}let e=await Sr(this.reader,this.lastLoadedPos,this.reader.fileSize);if(!e){this.lastSampleLoaded=!0;return}let r=e.header;this.lastLoadedPos=e.startPos+r.totalSize-1;let i=Ot(r.mpegVersionId,r.channel),a=this.reader.requestSlice(e.startPos+i,4);if(a instanceof Promise&&(a=await a),a){let c=v(a);if(c===Mt||c===gn)return}this.firstFrameHeader||(this.firstFrameHeader=r);let o=r.audioSamplesInFrame/r.sampleRate,s={timestamp:this.nextTimestampInSamples/r.sampleRate,duration:o,dataStart:e.startPos,dataSize:r.totalSize};this.loadedSamples.push(s),this.nextTimestampInSamples+=r.audioSamplesInFrame}async getMimeType(){return"audio/mpeg"}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){await this.readMetadata();let e=this.tracks[0];return m(e),e.computeDuration()}},ca=class{constructor(t){this.demuxer=t}getId(){return 1}async getFirstTimestamp(){return 0}getTimeResolution(){return m(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.sampleRate/this.demuxer.firstFrameHeader.audioSamplesInFrame}async computeDuration(){let t=await this.getPacket(1/0,{metadataOnly:!0});return(t?.timestamp??0)+(t?.duration??0)}getName(){return null}getLanguageCode(){return Z}getCodec(){return"mp3"}getInternalCodecId(){return null}getNumberOfChannels(){return m(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.channel===3?1:2}getSampleRate(){return m(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.sampleRate}async getDecoderConfig(){return m(this.demuxer.firstFrameHeader),{codec:"mp3",numberOfChannels:this.demuxer.firstFrameHeader.channel===3?1:2,sampleRate:this.demuxer.firstFrameHeader.sampleRate}}async getPacketAtIndex(t,e){if(t===-1)return null;let r=this.demuxer.loadedSamples[t];if(!r)return null;let i;if(e.metadataOnly)i=ce;else{let a=this.demuxer.reader.requestSlice(r.dataStart,r.dataSize);if(a instanceof Promise&&(a=await a),!a)return null;i=W(a,r.dataSize)}return new V(i,"key",r.timestamp,r.duration,t,r.dataSize)}getFirstPacket(t){return this.getPacketAtIndex(0,t)}async getNextPacket(t,e){let r=await this.demuxer.readingMutex.acquire();try{let i=G(this.demuxer.loadedSamples,t.timestamp,o=>o.timestamp);if(i===-1)throw new Error("Packet was not created from this track.");let a=i+1;for(;a>=this.demuxer.loadedSamples.length&&!this.demuxer.lastSampleLoaded;)await this.demuxer.advanceReader();return this.getPacketAtIndex(a,e)}finally{r()}}async getPacket(t,e){let r=await this.demuxer.readingMutex.acquire();try{for(;;){let i=z(this.demuxer.loadedSamples,t,a=>a.timestamp);if(i===-1&&this.demuxer.loadedSamples.length>0)return null;if(this.demuxer.lastSampleLoaded)return this.getPacketAtIndex(i,e);if(i>=0&&i+1<this.demuxer.loadedSamples.length)return this.getPacketAtIndex(i,e);await this.demuxer.advanceReader()}}finally{r()}}getKeyPacket(t,e){return this.getPacket(t,e)}getNextKeyPacket(t,e){return this.getNextPacket(t,e)}};var Gn=class extends fe{constructor(e){super(e);this.metadataPromise=null;this.bitstreams=[];this.tracks=[];this.reader=e._reader}async readMetadata(){return this.metadataPromise??=(async()=>{let e=0;for(;;){let r=this.reader.requestSliceRange(e,rt,lt);if(r instanceof Promise&&(r=await r),!r)break;let i=Rt(r);if(!i||!!!(i.headerType&2))break;this.bitstreams.push({serialNumber:i.serialNumber,bosPage:i,description:null,numberOfChannels:-1,sampleRate:-1,codecInfo:{codec:null,vorbisInfo:null,opusInfo:null},lastMetadataPacket:null}),e=i.headerStartPos+i.totalSize}for(let r of this.bitstreams){let i=await this.readPacket(r.bosPage,0);i&&(i.data.byteLength>=7&&i.data[0]===1&&i.data[1]===118&&i.data[2]===111&&i.data[3]===114&&i.data[4]===98&&i.data[5]===105&&i.data[6]===115?await this.readVorbisMetadata(i,r):i.data.byteLength>=8&&i.data[0]===79&&i.data[1]===112&&i.data[2]===117&&i.data[3]===115&&i.data[4]===72&&i.data[5]===101&&i.data[6]===97&&i.data[7]===100&&await this.readOpusMetadata(i,r),r.codecInfo.codec!==null&&this.tracks.push(new re(new ua(r,this))))}})()}async readVorbisMetadata(e,r){let i=await this.findNextPacketStart(e);if(!i)return;let a=await this.readPacket(i.startPage,i.startSegmentIndex);if(!a||(i=await this.findNextPacketStart(a),!i))return;let o=await this.readPacket(i.startPage,i.startSegmentIndex);if(!o||a.data[0]!==3||o.data[0]!==5)return;let s=[],c=f=>{for(;s.push(Math.min(255,f)),!(f<255);)f-=255};c(e.data.length),c(a.data.length);let u=new Uint8Array(1+s.length+e.data.length+a.data.length+o.data.length);u[0]=s.length,u.set(s,1),u.set(e.data,1+s.length),u.set(a.data,1+s.length+e.data.length),u.set(o.data,1+s.length+e.data.length+a.data.length),r.codecInfo.codec="vorbis",r.description=u,r.lastMetadataPacket=o;let d=H(e.data);r.numberOfChannels=d.getUint8(11),r.sampleRate=d.getUint32(12,!0);let l=d.getUint8(28);r.codecInfo.vorbisInfo={blocksizes:[1<<(l&15),1<<(l>>4)],modeBlockflags:Yr(o.data).modeBlockflags}}async readOpusMetadata(e,r){let i=await this.findNextPacketStart(e);if(!i)return;let a=await this.readPacket(i.startPage,i.startSegmentIndex);if(!a)return;r.codecInfo.codec="opus",r.description=e.data,r.lastMetadataPacket=a;let o=Ge(e.data);r.numberOfChannels=o.outputChannelCount,r.sampleRate=o.inputSampleRate,r.codecInfo.opusInfo={preSkip:o.preSkip}}async readPacket(e,r){m(r<e.lacingValues.length);let i=0;for(let f=0;f<r;f++)i+=e.lacingValues[f];let a=e,o=i,s=r,c=[];e:for(;;){let f=this.reader.requestSlice(a.dataStartPos,a.dataSize);f instanceof Promise&&(f=await f),m(f);let p=W(f,a.dataSize);for(;;){if(s===a.lacingValues.length){c.push(p.subarray(i,o));break}let b=a.lacingValues[s];if(o+=b,b<255){c.push(p.subarray(i,o));break e}s++}let h=a.headerStartPos+a.totalSize;for(;;){let b=this.reader.requestSliceRange(h,rt,lt);if(b instanceof Promise&&(b=await b),!b)return null;let g=Rt(b);if(!g)return null;if(a=g,a.serialNumber===e.serialNumber)break;h=a.headerStartPos+a.totalSize}i=0,o=0,s=0}let u=c.reduce((f,p)=>f+p.length,0),d=new Uint8Array(u),l=0;for(let f=0;f<c.length;f++){let p=c[f];d.set(p,l),l+=p.length}return{data:d,endPage:a,endSegmentIndex:s}}async findNextPacketStart(e){if(e.endSegmentIndex<e.endPage.lacingValues.length-1)return{startPage:e.endPage,startSegmentIndex:e.endSegmentIndex+1};if(!!(e.endPage.headerType&4))return null;let i=e.endPage.headerStartPos+e.endPage.totalSize;for(;;){let a=this.reader.requestSliceRange(i,rt,lt);if(a instanceof Promise&&(a=await a),!a)return null;let o=Rt(a);if(!o)return null;if(o.serialNumber===e.endPage.serialNumber)return{startPage:o,startSegmentIndex:0};i=o.headerStartPos+o.totalSize}}async getMimeType(){await this.readMetadata();let e=await Promise.all(this.tracks.map(r=>r.getCodecParameterString()));return xn({codecStrings:e.filter(Boolean)})}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){let e=await this.getTracks(),r=await Promise.all(e.map(i=>i.computeDuration()));return Math.max(0,...r)}},ua=class{constructor(t,e){this.bitstream=t;this.demuxer=e;this.encodedPacketToMetadata=new WeakMap;this.sequentialScanCache=[];this.sequentialScanMutex=new oe;this.internalSampleRate=t.codecInfo.codec==="opus"?yt:t.sampleRate}getId(){return this.bitstream.serialNumber}getNumberOfChannels(){return this.bitstream.numberOfChannels}getSampleRate(){return this.bitstream.sampleRate}getTimeResolution(){return this.bitstream.sampleRate}getCodec(){return this.bitstream.codecInfo.codec}getInternalCodecId(){return null}async getDecoderConfig(){return m(this.bitstream.codecInfo.codec),{codec:this.bitstream.codecInfo.codec,numberOfChannels:this.bitstream.numberOfChannels,sampleRate:this.bitstream.sampleRate,description:this.bitstream.description??void 0}}getName(){return null}getLanguageCode(){return Z}async getFirstTimestamp(){return 0}async computeDuration(){let t=await this.getPacket(1/0,{metadataOnly:!0});return(t?.timestamp??0)+(t?.duration??0)}granulePositionToTimestampInSamples(t){return this.bitstream.codecInfo.codec==="opus"?(m(this.bitstream.codecInfo.opusInfo),t-this.bitstream.codecInfo.opusInfo.preSkip):t}createEncodedPacketFromOggPacket(t,e,r){if(!t)return null;let{durationInSamples:i,vorbisBlockSize:a}=Sn(t.data,this.bitstream.codecInfo,e.vorbisLastBlocksize),o=new V(r.metadataOnly?ce:t.data,"key",Math.max(0,e.timestampInSamples)/this.internalSampleRate,i/this.internalSampleRate,t.endPage.headerStartPos+t.endSegmentIndex,t.data.byteLength);return this.encodedPacketToMetadata.set(o,{packet:t,timestampInSamples:e.timestampInSamples,durationInSamples:i,vorbisLastBlockSize:e.vorbisLastBlocksize,vorbisBlockSize:a}),o}async getFirstPacket(t){m(this.bitstream.lastMetadataPacket);let e=await this.demuxer.findNextPacketStart(this.bitstream.lastMetadataPacket);if(!e)return null;let r=0;this.bitstream.codecInfo.codec==="opus"&&(m(this.bitstream.codecInfo.opusInfo),r-=this.bitstream.codecInfo.opusInfo.preSkip);let i=await this.demuxer.readPacket(e.startPage,e.startSegmentIndex);return this.createEncodedPacketFromOggPacket(i,{timestampInSamples:r,vorbisLastBlocksize:null},t)}async getNextPacket(t,e){let r=this.encodedPacketToMetadata.get(t);if(!r)throw new Error("Packet was not created from this track.");let i=await this.demuxer.findNextPacketStart(r.packet);if(!i)return null;let a=r.timestampInSamples+r.durationInSamples,o=await this.demuxer.readPacket(i.startPage,i.startSegmentIndex);return this.createEncodedPacketFromOggPacket(o,{timestampInSamples:a,vorbisLastBlocksize:r.vorbisBlockSize},e)}async getPacket(t,e){if(this.demuxer.reader.fileSize===null)return this.getPacketSequential(t,e);let r=at(t*this.internalSampleRate,14);if(r===0)return this.getFirstPacket(e);if(r<0)return null;m(this.bitstream.lastMetadataPacket);let i=await this.demuxer.findNextPacketStart(this.bitstream.lastMetadataPacket);if(!i)return null;let a=i.startPage,o=this.demuxer.reader.fileSize,s=[a];e:for(;a.headerStartPos+a.totalSize<o;){let k=a.headerStartPos,y=Math.floor((k+o)/2),S=y;for(;;){let w=Math.min(S+Cn,o-rt),x=this.demuxer.reader.requestSlice(S,w-S);if(x instanceof Promise&&(x=await x),m(x),!Ts(x,w)){o=y+rt;continue e}let C=this.demuxer.reader.requestSliceRange(x.filePos,rt,lt);C instanceof Promise&&(C=await C),m(C);let P=Rt(C);m(P);let I=!1;if(P.serialNumber===this.bitstream.serialNumber)I=!0;else{let B=this.demuxer.reader.requestSlice(P.headerStartPos,P.totalSize);B instanceof Promise&&(B=await B),m(B);let j=W(B,P.totalSize);I=Tn(j)===P.checksum}if(!I){S=P.headerStartPos+4;continue}if(I&&P.serialNumber!==this.bitstream.serialNumber){S=P.headerStartPos+P.totalSize;continue}if(P.granulePosition===-1){S=P.headerStartPos+P.totalSize;continue}this.granulePositionToTimestampInSamples(P.granulePosition)>r?o=P.headerStartPos:(a=P,s.push(P));continue e}}let c=i.startPage;for(let k of s){if(k.granulePosition===a.granulePosition)break;(!c||k.headerStartPos>c.headerStartPos)&&(c=k)}let u=c,d=[u];for(;!(u.serialNumber===this.bitstream.serialNumber&&u.granulePosition===a.granulePosition);){let k=u.headerStartPos+u.totalSize,y=this.demuxer.reader.requestSliceRange(k,rt,lt);y instanceof Promise&&(y=await y),m(y);let S=Rt(y);m(S),u=S,u.serialNumber===this.bitstream.serialNumber&&d.push(u)}m(u.granulePosition!==-1);let l=null,f,p,h=u,b=0;if(u.headerStartPos===i.startPage.headerStartPos)f=this.granulePositionToTimestampInSamples(0),p=!0,l=0;else{f=0,p=!1;for(let S=u.lacingValues.length-1;S>=0;S--)if(u.lacingValues[S]<255){l=S+1;break}if(l===null)throw new Error("Invalid page with granule position: no packets end on this page.");b=l-1;let k={data:ce,endPage:h,endSegmentIndex:b};if(await this.demuxer.findNextPacketStart(k)){let S=Us(d,u,l);m(S);let w=Vs(d,S.page,S.segmentIndex);w&&(u=w.page,l=w.segmentIndex)}else for(;;){let S=Us(d,u,l);if(!S)break;let w=Vs(d,S.page,S.segmentIndex);if(!w)break;if(u=w.page,l=w.segmentIndex,S.page.headerStartPos!==h.headerStartPos){h=S.page,b=S.segmentIndex;break}}}let g=null,T=null;for(;u!==null;){m(l!==null);let k=await this.demuxer.readPacket(u,l);if(!k)break;if(!(u.headerStartPos===i.startPage.headerStartPos&&l<i.startSegmentIndex)){let w=this.createEncodedPacketFromOggPacket(k,{timestampInSamples:f,vorbisLastBlocksize:T?.vorbisBlockSize??null},e);m(w);let x=this.encodedPacketToMetadata.get(w);if(m(x),!p&&k.endPage.headerStartPos===h.headerStartPos&&k.endSegmentIndex===b?(f=this.granulePositionToTimestampInSamples(u.granulePosition),p=!0,w=this.createEncodedPacketFromOggPacket(k,{timestampInSamples:f-x.durationInSamples,vorbisLastBlocksize:T?.vorbisBlockSize??null},e),m(w),x=this.encodedPacketToMetadata.get(w),m(x)):f+=x.durationInSamples,g=w,T=x,p&&(Math.max(f,0)>r||Math.max(x.timestampInSamples,0)===r))break}let S=await this.demuxer.findNextPacketStart(k);if(!S)break;u=S.startPage,l=S.startSegmentIndex}return g}async getPacketSequential(t,e){let r=await this.sequentialScanMutex.acquire();try{let i=at(t*this.internalSampleRate,14);t=i/this.internalSampleRate;let a=z(this.sequentialScanCache,i,c=>c.timestampInSamples),o;if(a!==-1){let c=this.sequentialScanCache[a];o=this.createEncodedPacketFromOggPacket(c.packet,{timestampInSamples:c.timestampInSamples,vorbisLastBlocksize:c.vorbisLastBlockSize},e)}else o=await this.getFirstPacket(e);let s=0;for(;o&&o.timestamp<t;){let c=await this.getNextPacket(o,e);if(!c||c.timestamp>t)break;if(o=c,s++,s===100){s=0;let u=this.encodedPacketToMetadata.get(o);m(u),this.sequentialScanCache.length>0&&m(L(this.sequentialScanCache).timestampInSamples<=u.timestampInSamples),this.sequentialScanCache.push(u)}}return o}finally{r()}}getKeyPacket(t,e){return this.getPacket(t,e)}getNextKeyPacket(t,e){return this.getNextPacket(t,e)}},Vs=(n,t,e)=>{let r=t,i=e;e:for(;;){for(i--,i;i>=0;i--)if(r.lacingValues[i]<255){i++;break e}if(m(i===-1),!(r.headerType&1)){i=0;break}let o=ci(n,s=>s.headerStartPos<r.headerStartPos);if(!o)return null;r=o,i=r.lacingValues.length}if(m(i!==-1),i===r.lacingValues.length){let a=n[n.indexOf(r)+1];m(a),r=a,i=0}return{page:r,segmentIndex:i}},Us=(n,t,e)=>{if(e>0)return{page:t,segmentIndex:e-1};let r=ci(n,i=>i.headerStartPos<t.headerStartPos);return r?{page:r,segmentIndex:r.lacingValues.length-1}:null};var Kt=7,jt=9,xr=n=>{let t=n.filePos,e=W(n,9),r=new Q(e);if(r.readBits(12)!==4095||(r.skipBits(1),r.readBits(2)!==0))return null;let o=r.readBits(1),s=r.readBits(2)+1,c=r.readBits(4);if(c===15)return null;r.skipBits(1);let u=r.readBits(3);if(u===0)throw new Error("ADTS frames with channel configuration 0 are not supported.");r.skipBits(1),r.skipBits(1),r.skipBits(1),r.skipBits(1);let d=r.readBits(13);r.skipBits(11);let l=r.readBits(2)+1;if(l!==1)throw new Error("ADTS frames with more than one AAC frame are not supported.");let f=null;return o===1?n.filePos-=2:f=r.readBits(16),{objectType:s,samplingFrequencyIndex:c,channelConfiguration:u,frameLength:d,numberOfAacFrames:l,crcCheck:f,startPos:t}};var da=1024,Xn=class extends fe{constructor(e){super(e);this.metadataPromise=null;this.firstFrameHeader=null;this.loadedSamples=[];this.tracks=[];this.readingMutex=new oe;this.lastSampleLoaded=!1;this.lastLoadedPos=0;this.nextTimestampInSamples=0;this.reader=e._reader}async readMetadata(){return this.metadataPromise??=(async()=>{for(;!this.firstFrameHeader&&!this.lastSampleLoaded;)await this.advanceReader();m(this.firstFrameHeader),this.tracks=[new re(new la(this))]})()}async advanceReader(){let e=this.reader.requestSliceRange(this.lastLoadedPos,Kt,jt);if(e instanceof Promise&&(e=await e),!e){this.lastSampleLoaded=!0;return}let r=xr(e);if(!r){this.lastSampleLoaded=!0;return}if(this.reader.fileSize!==null&&r.startPos+r.frameLength>this.reader.fileSize){this.lastSampleLoaded=!0;return}this.firstFrameHeader||(this.firstFrameHeader=r);let i=Gt[r.samplingFrequencyIndex];m(i!==void 0);let a=da/i,o=r.crcCheck?jt:Kt,s={timestamp:this.nextTimestampInSamples/i,duration:a,dataStart:r.startPos+o,dataSize:r.frameLength-o};this.loadedSamples.push(s),this.nextTimestampInSamples+=da,this.lastLoadedPos=r.startPos+r.frameLength}async getMimeType(){return"audio/aac"}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){await this.readMetadata();let e=this.tracks[0];return m(e),e.computeDuration()}},la=class{constructor(t){this.demuxer=t}getId(){return 1}async getFirstTimestamp(){return 0}getTimeResolution(){return this.getSampleRate()/da}async computeDuration(){let t=await this.getPacket(1/0,{metadataOnly:!0});return(t?.timestamp??0)+(t?.duration??0)}getName(){return null}getLanguageCode(){return Z}getCodec(){return"aac"}getInternalCodecId(){return m(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.objectType}getNumberOfChannels(){m(this.demuxer.firstFrameHeader);let t=mi[this.demuxer.firstFrameHeader.channelConfiguration];return m(t!==void 0),t}getSampleRate(){m(this.demuxer.firstFrameHeader);let t=Gt[this.demuxer.firstFrameHeader.samplingFrequencyIndex];return m(t!==void 0),t}async getDecoderConfig(){m(this.demuxer.firstFrameHeader);let t=new Uint8Array(3),e=new Q(t),{objectType:r,samplingFrequencyIndex:i,channelConfiguration:a}=this.demuxer.firstFrameHeader;return r>31?(e.writeBits(5,31),e.writeBits(6,r-32)):e.writeBits(5,r),e.writeBits(4,i),e.writeBits(4,a),{codec:`mp4a.40.${this.demuxer.firstFrameHeader.objectType}`,numberOfChannels:this.getNumberOfChannels(),sampleRate:this.getSampleRate(),description:t.subarray(0,Math.ceil((e.pos-1)/8))}}async getPacketAtIndex(t,e){if(t===-1)return null;let r=this.demuxer.loadedSamples[t];if(!r)return null;let i;if(e.metadataOnly)i=ce;else{let a=this.demuxer.reader.requestSlice(r.dataStart,r.dataSize);if(a instanceof Promise&&(a=await a),!a)return null;i=W(a,r.dataSize)}return new V(i,"key",r.timestamp,r.duration,t,r.dataSize)}getFirstPacket(t){return this.getPacketAtIndex(0,t)}async getNextPacket(t,e){let r=await this.demuxer.readingMutex.acquire();try{let i=G(this.demuxer.loadedSamples,t.timestamp,o=>o.timestamp);if(i===-1)throw new Error("Packet was not created from this track.");let a=i+1;for(;a>=this.demuxer.loadedSamples.length&&!this.demuxer.lastSampleLoaded;)await this.demuxer.advanceReader();return this.getPacketAtIndex(a,e)}finally{r()}}async getPacket(t,e){let r=await this.demuxer.readingMutex.acquire();try{for(;;){let i=z(this.demuxer.loadedSamples,t,a=>a.timestamp);if(i===-1&&this.demuxer.loadedSamples.length>0)return null;if(this.demuxer.lastSampleLoaded)return this.getPacketAtIndex(i,e);if(i>=0&&i+1<this.demuxer.loadedSamples.length)return this.getPacketAtIndex(i,e);await this.demuxer.advanceReader()}}finally{r()}}getKeyPacket(t,e){return this.getPacket(t,e)}getNextKeyPacket(t,e){return this.getNextPacket(t,e)}};var Ee=class{},Cr=class extends Ee{async _getMajorBrand(t){let e=t._reader.requestSlice(0,12);return e instanceof Promise&&(e=await e),!e||(e.skip(4),ie(e,4)!=="ftyp")?null:ie(e,4)}_createDemuxer(t){return new Hn(t)}},Yn=class extends Cr{async _canReadInput(t){let e=await this._getMajorBrand(t);return!!e&&e!=="qt  "}get name(){return"MP4"}get mimeType(){return"video/mp4"}},Zn=class extends Cr{async _canReadInput(t){return await this._getMajorBrand(t)==="qt  "}get name(){return"QuickTime File Format"}get mimeType(){return"video/quicktime"}},Pr=class extends Ee{async isSupportedEBMLOfDocType(t,e){let r=t._reader.requestSlice(0,Oe);if(r instanceof Promise&&(r=await r),!r)return!1;let i=Pi(r);if(i===null||i<1||i>8||N(r,i)!==440786851)return!1;let o=vi(r);if(o===null)return!1;let s=t._reader.requestSlice(r.filePos,o);if(s instanceof Promise&&(s=await s),!s)return!1;let c=r.filePos;for(;s.filePos<=c+o-ke;){let u=Re(s);if(!u)break;let{id:d,size:l}=u,f=s.filePos;if(l===null)return!1;switch(d){case 17030:if(N(s,l)!==1)return!1;break;case 17143:if(N(s,l)!==1)return!1;break;case 17026:if(ut(s,l)!==e)return!1;break;case 17031:if(N(s,l)>4)return!1;break}s.filePos=f+l}return!0}_canReadInput(t){return this.isSupportedEBMLOfDocType(t,"matroska")}_createDemuxer(t){return new Kn(t)}get name(){return"Matroska"}get mimeType(){return"video/x-matroska"}},Jn=class extends Pr{_canReadInput(t){return this.isSupportedEBMLOfDocType(t,"webm")}get name(){return"WebM"}get mimeType(){return"video/webm"}},ei=class extends Ee{async _canReadInput(t){let e=t._reader.requestSlice(0,10);if(e instanceof Promise&&(e=await e),!e)return!1;let r=0,i=Qn(e);i&&(r=e.filePos+i.size);let a=await Sr(t._reader,r,r+4096);if(!a)return!1;if(i)return!0;r=a.startPos+=a.header.totalSize;let o=await Sr(t._reader,r,r+4);if(!o)return!1;let s=a.header,c=o.header;return!(s.channel!==c.channel||s.sampleRate!==c.sampleRate)}_createDemuxer(t){return new $n(t)}get name(){return"MP3"}get mimeType(){return"audio/mpeg"}},ti=class extends Ee{async _canReadInput(t){let e=t._reader.requestSlice(0,12);if(e instanceof Promise&&(e=await e),!e)return!1;let r=ie(e,4);return r!=="RIFF"&&r!=="RIFX"&&r!=="RF64"?!1:(e.skip(4),ie(e,4)==="WAVE")}_createDemuxer(t){return new Fn(t)}get name(){return"WAVE"}get mimeType(){return"audio/wav"}},ri=class extends Ee{async _canReadInput(t){let e=t._reader.requestSlice(0,4);return e instanceof Promise&&(e=await e),e?ie(e,4)==="OggS":!1}_createDemuxer(t){return new Gn(t)}get name(){return"Ogg"}get mimeType(){return"application/ogg"}},ni=class extends Ee{async _canReadInput(t){let e=t._reader.requestSliceRange(0,Kt,jt);if(e instanceof Promise&&(e=await e),!e)return!1;let r=xr(e);if(!r||(e=t._reader.requestSliceRange(r.frameLength,Kt,jt),e instanceof Promise&&(e=await e),!e))return!1;let i=xr(e);return i?r.objectType===i.objectType&&r.samplingFrequencyIndex===i.samplingFrequencyIndex&&r.channelConfiguration===i.channelConfiguration:!1}_createDemuxer(t){return new Xn(t)}get name(){return"ADTS"}get mimeType(){return"audio/aac"}},Ws=new Yn,Ns=new Zn,Ls=new Pr,Hs=new Jn,qs=new ei,Ks=new ti,js=new ri,Qs=new ni,jc=[Ws,Ns,Ls,Hs,Ks,js,qs,Qs];var vr=class{constructor(t){this._demuxerPromise=null;this._format=null;if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(!Array.isArray(t.formats)||t.formats.some(e=>!(e instanceof Ee)))throw new TypeError("options.formats must be an array of InputFormat.");if(!(t.source instanceof ve))throw new TypeError("options.source must be a Source.");this._formats=t.formats,this._source=t.source,this._reader=new nn(t.source)}_getDemuxer(){return this._demuxerPromise??=(async()=>{this._reader.fileSize=await this._source.getSizeOrNull();for(let t of this._formats)if(await t._canReadInput(this))return this._format=t,t._createDemuxer(this);throw new Error("Input has an unsupported or unrecognizable format.")})()}get source(){return this._source}async getFormat(){return await this._getDemuxer(),m(this._format),this._format}async computeDuration(){return(await this._getDemuxer()).computeDuration()}async getTracks(){return(await this._getDemuxer()).getTracks()}async getVideoTracks(){return(await this.getTracks()).filter(e=>e.isVideoTrack())}async getAudioTracks(){return(await this.getTracks()).filter(e=>e.isAudioTrack())}async getPrimaryVideoTrack(){return(await this.getTracks()).find(e=>e.isVideoTrack())??null}async getPrimaryAudioTrack(){return(await this.getTracks()).find(e=>e.isAudioTrack())??null}async getMimeType(){return(await this._getDemuxer()).getMimeType()}};var $s=n=>{if(n!==void 0&&(!n||typeof n!="object"))throw new TypeError("options.video, when provided, must be an object.");if(n?.discard!==void 0&&typeof n.discard!="boolean")throw new TypeError("options.video.discard, when provided, must be a boolean.");if(n?.forceTranscode!==void 0&&typeof n.forceTranscode!="boolean")throw new TypeError("options.video.forceTranscode, when provided, must be a boolean.");if(n?.codec!==void 0&&!ee.includes(n.codec))throw new TypeError(`options.video.codec, when provided, must be one of: ${ee.join(", ")}.`);if(n?.bitrate!==void 0&&!(n.bitrate instanceof se)&&(!Number.isInteger(n.bitrate)||n.bitrate<=0))throw new TypeError("options.video.bitrate, when provided, must be a positive integer or a quality.");if(n?.width!==void 0&&(!Number.isInteger(n.width)||n.width<=0))throw new TypeError("options.video.width, when provided, must be a positive integer.");if(n?.height!==void 0&&(!Number.isInteger(n.height)||n.height<=0))throw new TypeError("options.video.height, when provided, must be a positive integer.");if(n?.fit!==void 0&&!["fill","contain","cover"].includes(n.fit))throw new TypeError('options.video.fit, when provided, must be one of "fill", "contain", or "cover".');if(n?.width!==void 0&&n.height!==void 0&&n.fit===void 0)throw new TypeError("When both options.video.width and options.video.height are provided, options.video.fit must also be provided.");if(n?.rotate!==void 0&&![0,90,180,270].includes(n.rotate))throw new TypeError("options.video.rotate, when provided, must be 0, 90, 180 or 270.");if(n?.frameRate!==void 0&&(!Number.isFinite(n.frameRate)||n.frameRate<=0))throw new TypeError("options.video.frameRate, when provided, must be a finite positive number.")},Gs=n=>{if(n!==void 0&&(!n||typeof n!="object"))throw new TypeError("options.audio, when provided, must be an object.");if(n?.discard!==void 0&&typeof n.discard!="boolean")throw new TypeError("options.audio.discard, when provided, must be a boolean.");if(n?.forceTranscode!==void 0&&typeof n.forceTranscode!="boolean")throw new TypeError("options.audio.forceTranscode, when provided, must be a boolean.");if(n?.codec!==void 0&&!ne.includes(n.codec))throw new TypeError(`options.audio.codec, when provided, must be one of: ${ne.join(", ")}.`);if(n?.bitrate!==void 0&&!(n.bitrate instanceof se)&&(!Number.isInteger(n.bitrate)||n.bitrate<=0))throw new TypeError("options.audio.bitrate, when provided, must be a positive integer or a quality.");if(n?.numberOfChannels!==void 0&&(!Number.isInteger(n.numberOfChannels)||n.numberOfChannels<=0))throw new TypeError("options.audio.numberOfChannels, when provided, must be a positive integer.");if(n?.sampleRate!==void 0&&(!Number.isInteger(n.sampleRate)||n.sampleRate<=0))throw new TypeError("options.audio.sampleRate, when provided, must be a positive integer.")},ma=2,fa=48e3,pa=class n{constructor(t){this._addedCounts={video:0,audio:0,subtitle:0};this._totalTrackCount=0;this._trackPromises=[];this._executed=!1;this._synchronizer=new ha;this._totalDuration=null;this._maxTimestamps=new Map;this._canceled=!1;this.onProgress=void 0;this._computeProgress=!1;this._lastProgress=0;this.utilizedTracks=[];this.discardedTracks=[];if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(!(t.input instanceof vr))throw new TypeError("options.input must be an Input.");if(!(t.output instanceof qt))throw new TypeError("options.output must be an Output.");if(t.output._tracks.length>0||t.output.state!=="pending")throw new TypeError("options.output must be fresh: no tracks added and not started.");if(typeof t.video!="function"&&$s(t.video),typeof t.audio!="function"&&Gs(t.audio),t.trim!==void 0&&(!t.trim||typeof t.trim!="object"))throw new TypeError("options.trim, when provided, must be an object.");if(t.trim?.start!==void 0&&(!Number.isFinite(t.trim.start)||t.trim.start<0))throw new TypeError("options.trim.start, when provided, must be a non-negative number.");if(t.trim?.end!==void 0&&(!Number.isFinite(t.trim.end)||t.trim.end<0))throw new TypeError("options.trim.end, when provided, must be a non-negative number.");if(t.trim?.start!==void 0&&t.trim.end!==void 0&&t.trim.start>=t.trim.end)throw new TypeError("options.trim.start must be less than options.trim.end.");this._options=t,this.input=t.input,this.output=t.output,this._startTimestamp=t.trim?.start??0,this._endTimestamp=t.trim?.end??1/0;let{promise:e,resolve:r}=q();this._started=e,this._start=r}static async init(t){let e=new n(t);return await e._init(),e}async _init(){let t=await this.input.getTracks(),e=this.output.format.getSupportedTrackCounts(),r=1,i=1;for(let o of t){let s;if(o.isVideoTrack()?this._options.video&&(typeof this._options.video=="function"?(s=await this._options.video(o,r),$s(s),r++):s=this._options.video):o.isAudioTrack()?this._options.audio&&(typeof this._options.audio=="function"?(s=await this._options.audio(o,i),Gs(s),i++):s=this._options.audio):m(!1),s?.discard){this.discardedTracks.push({track:o,reason:"discarded_by_user"});continue}if(this._totalTrackCount===e.total.max){this.discardedTracks.push({track:o,reason:"max_track_count_reached"});continue}if(this._addedCounts[o.type]===e[o.type].max){this.discardedTracks.push({track:o,reason:"max_track_count_of_type_reached"});continue}o.isVideoTrack()?await this._processVideoTrack(o,s??{}):o.isAudioTrack()&&await this._processAudioTrack(o,s??{})}let a=this.discardedTracks.filter(o=>o.reason!=="discarded_by_user");a.length>0&&console.warn("Some tracks had to be discarded from the conversion:",a)}async execute(){if(this._executed)throw new Error("Conversion cannot be executed twice.");this._executed=!0,this.onProgress&&(this._computeProgress=!0,this._totalDuration=Math.min(await this.input.computeDuration()-this._startTimestamp,this._endTimestamp-this._startTimestamp),this.onProgress?.(0)),await this.output.start(),this._start();try{await Promise.all(this._trackPromises)}catch(t){throw this._canceled||this.cancel(),t}this._canceled&&await new Promise(()=>{}),await this.output.finalize(),this._computeProgress&&this.onProgress?.(1)}async cancel(){if(!(this.output.state==="finalizing"||this.output.state==="finalized")){if(this._canceled){console.warn("Conversion already canceled.");return}this._canceled=!0,await this.output.cancel()}}async _processVideoTrack(t,e){let r=t.codec;if(!r){this.discardedTracks.push({track:t,reason:"unknown_source_codec"});return}let i,a=$e(t.rotation+(e.rotate??0)),o=this.output.format.supportsVideoRotationMetadata,[s,c]=a%180===0?[t.codedWidth,t.codedHeight]:[t.codedHeight,t.codedWidth],u=s,d=c,l=u/d,f=T=>Math.ceil(T/2)*2;e.width!==void 0&&e.height===void 0?(u=f(e.width),d=f(Math.round(u/l))):e.width===void 0&&e.height!==void 0?(d=f(e.height),u=f(Math.round(d*l))):e.width!==void 0&&e.height!==void 0&&(u=f(e.width),d=f(e.height));let p=await t.getFirstTimestamp(),h=!!e.forceTranscode||this._startTimestamp>0||p<0||!!e.frameRate,b=u!==s||d!==c||a!==0&&!o,g=this.output.format.getSupportedVideoCodecs();if(!h&&!e.bitrate&&!b&&g.includes(r)&&(!e.codec||e.codec===r)){let T=new br(r);i=T,this._trackPromises.push((async()=>{await this._started;let k=new Be(t),S={decoderConfig:await t.getDecoderConfig()??void 0},w=Number.isFinite(this._endTimestamp)?await k.getPacket(this._endTimestamp,{metadataOnly:!0})??void 0:void 0;for await(let x of k.packets(void 0,w,{verifyKeyPackets:!0})){if(this._synchronizer.shouldWait(t.id,x.timestamp)&&await this._synchronizer.wait(x.timestamp),this._canceled)return;await T.add(x,S),this._reportProgress(t.id,x.timestamp+x.duration)}T.close(),this._synchronizer.closeTrack(t.id)})())}else{if(!await t.canDecode()){this.discardedTracks.push({track:t,reason:"undecodable_source_codec"});return}e.codec&&(g=g.filter(x=>x===e.codec));let k=e.bitrate??Vn,y=await Li(g,{width:u,height:d,bitrate:k});if(!y){this.discardedTracks.push({track:t,reason:"no_encodable_target_codec"});return}let S={codec:y,bitrate:k,sizeChangeBehavior:e.fit??"passThrough",onEncodedPacket:x=>this._reportProgress(t.id,x.timestamp+x.duration)},w=new Nt(S);if(i=w,!b){let x=new qt({format:new Ut,target:new nr}),_=new Nt(S);x.addVideoTrack(_),await x.start();let P=await new pt(t).getSample(this._startTimestamp);if(P)try{await _.add(P),P.close(),await x.finalize()}catch(I){console.info("Error when probing encoder support. Falling back to rerender path.",I),b=!0,x.cancel()}else await x.cancel()}b?this._trackPromises.push((async()=>{await this._started;let _=new fr(t,{width:u,height:d,fit:e.fit??"fill",rotation:a,poolSize:1}).canvases(this._startTimestamp,this._endTimestamp),C=e.frameRate,P=null,I=null,F=null,B=async j=>{m(P),m(C!==void 0);let J=Math.round((j-I)*C);for(let bt=1;bt<J;bt++){let nt=new pe(P,{timestamp:I+bt/C,duration:1/C});await w.add(nt)}};for await(let{canvas:j,timestamp:J,duration:bt}of _){if(this._synchronizer.shouldWait(t.id,J)&&await this._synchronizer.wait(J),this._canceled)return;let nt=Math.max(J-this._startTimestamp,0);if(F=nt+bt,C!==void 0){let Er=Math.floor(nt*C)/C;if(P!==null)if(Er<=I){P=j,I=Er;continue}else await B(Er);nt=Er}let ba=new pe(j,{timestamp:nt,duration:C!==void 0?1/C:bt});await w.add(ba),C!==void 0?(P=j,I=nt):ba.close()}P&&(m(F!==null),m(C!==void 0),await B(Math.floor(F*C)/C)),w.close(),this._synchronizer.closeTrack(t.id)})()):this._trackPromises.push((async()=>{await this._started;let x=new pt(t),_=e.frameRate,C=null,P=null,I=null,F=async B=>{m(C),m(_!==void 0);let j=Math.round((B-P)*_);for(let J=1;J<j;J++)C.setTimestamp(P+J/_),C.setDuration(1/_),await w.add(C);C.close()};for await(let B of x.samples(this._startTimestamp,this._endTimestamp)){if(this._synchronizer.shouldWait(t.id,B.timestamp)&&await this._synchronizer.wait(B.timestamp),this._canceled){C?.close();return}let j=Math.max(B.timestamp-this._startTimestamp,0);if(I=j+B.duration,_!==void 0){let J=Math.floor(j*_)/_;if(C!==null)if(J<=P){C.close(),C=B,P=J;continue}else await F(J);j=J,B.setDuration(1/_)}B.setTimestamp(j),await w.add(B),_!==void 0?(C=B,P=j):B.close()}C&&(m(I!==null),m(_!==void 0),await F(Math.floor(I*_)/_)),w.close(),this._synchronizer.closeTrack(t.id)})())}this.output.addVideoTrack(i,{frameRate:e.frameRate,languageCode:Ue(t.languageCode)?t.languageCode:void 0,name:t.name??void 0,rotation:b?0:a}),this._addedCounts.video++,this._totalTrackCount++,this.utilizedTracks.push(t)}async _processAudioTrack(t,e){let r=t.codec;if(!r){this.discardedTracks.push({track:t,reason:"unknown_source_codec"});return}let i,a=t.numberOfChannels,o=t.sampleRate,s=await t.getFirstTimestamp(),c=e.numberOfChannels??a,u=e.sampleRate??o,d=c!==a||u!==o||this._startTimestamp>0||s<0,l=this.output.format.getSupportedAudioCodecs();if(!e.forceTranscode&&!e.bitrate&&!d&&l.includes(r)&&(!e.codec||e.codec===r)){let f=new wr(r);i=f,this._trackPromises.push((async()=>{await this._started;let p=new Be(t),b={decoderConfig:await t.getDecoderConfig()??void 0},g=Number.isFinite(this._endTimestamp)?await p.getPacket(this._endTimestamp,{metadataOnly:!0})??void 0:void 0;for await(let T of p.packets(void 0,g)){if(this._synchronizer.shouldWait(t.id,T.timestamp)&&await this._synchronizer.wait(T.timestamp),this._canceled)return;await f.add(T,b),this._reportProgress(t.id,T.timestamp+T.duration)}f.close(),this._synchronizer.closeTrack(t.id)})())}else{if(!await t.canDecode()){this.discardedTracks.push({track:t,reason:"undecodable_source_codec"});return}let p=null;e.codec&&(l=l.filter(g=>g===e.codec));let h=e.bitrate??Vn,b=await gr(l,{numberOfChannels:c,sampleRate:u,bitrate:h});if(!b.some(g=>Ne.includes(g))&&l.some(g=>Ne.includes(g))&&(c!==ma||u!==fa)){let T=(await gr(l,{numberOfChannels:ma,sampleRate:fa,bitrate:h})).find(k=>Ne.includes(k));T&&(d=!0,p=T,c=ma,u=fa)}else p=b[0]??null;if(p===null){this.discardedTracks.push({track:t,reason:"no_encodable_target_codec"});return}if(d)i=this._resampleAudio(t,p,c,u,h);else{let g=new Lt({codec:p,bitrate:h,onEncodedPacket:T=>this._reportProgress(t.id,T.timestamp+T.duration)});i=g,this._trackPromises.push((async()=>{await this._started;let T=new ht(t);for await(let k of T.samples(void 0,this._endTimestamp)){if(this._synchronizer.shouldWait(t.id,k.timestamp)&&await this._synchronizer.wait(k.timestamp),this._canceled)return;await g.add(k),k.close()}g.close(),this._synchronizer.closeTrack(t.id)})())}}this.output.addAudioTrack(i,{languageCode:Ue(t.languageCode)?t.languageCode:void 0,name:t.name??void 0}),this._addedCounts.audio++,this._totalTrackCount++,this.utilizedTracks.push(t)}_resampleAudio(t,e,r,i,a){let o=new Lt({codec:e,bitrate:a,onEncodedPacket:s=>this._reportProgress(t.id,s.timestamp+s.duration)});return this._trackPromises.push((async()=>{await this._started;let s=new ga({sourceNumberOfChannels:t.numberOfChannels,sourceSampleRate:t.sampleRate,targetNumberOfChannels:r,targetSampleRate:i,startTime:this._startTimestamp,endTime:this._endTimestamp,onSample:d=>o.add(d)}),u=new ht(t).samples(this._startTimestamp,this._endTimestamp);for await(let d of u){if(this._synchronizer.shouldWait(t.id,d.timestamp)&&await this._synchronizer.wait(d.timestamp),this._canceled)return;await s.add(d)}await s.finalize(),o.close(),this._synchronizer.closeTrack(t.id)})()),o}_reportProgress(t,e){if(!this._computeProgress)return;m(this._totalDuration!==null),this._maxTimestamps.set(t,Math.max(e,this._maxTimestamps.get(t)??-1/0));let r=Math.min(...this._maxTimestamps.values()),i=Y(r/this._totalDuration,0,1);i!==this._lastProgress&&(this._lastProgress=i,this.onProgress?.(i))}},Xs=5,ha=class{constructor(){this.maxTimestamps=new Map;this.resolvers=[]}computeMinAndMaybeResolve(){let t=1/0;for(let[,e]of this.maxTimestamps)t=Math.min(t,e);for(let e=0;e<this.resolvers.length;e++){let r=this.resolvers[e];r.timestamp-t<Xs&&(r.resolve(),this.resolvers.splice(e,1),e--)}return t}shouldWait(t,e){this.maxTimestamps.set(t,Math.max(e,this.maxTimestamps.get(t)??-1/0));let r=this.computeMinAndMaybeResolve();return e-r>=Xs}wait(t){let{promise:e,resolve:r}=q();return this.resolvers.push({timestamp:t,resolve:r}),e}closeTrack(t){this.maxTimestamps.delete(t),this.computeMinAndMaybeResolve()}},ga=class{constructor(t){this.sourceSampleRate=t.sourceSampleRate,this.targetSampleRate=t.targetSampleRate,this.sourceNumberOfChannels=t.sourceNumberOfChannels,this.targetNumberOfChannels=t.targetNumberOfChannels,this.startTime=t.startTime,this.endTime=t.endTime,this.onSample=t.onSample,this.bufferSizeInFrames=Math.floor(this.targetSampleRate*5),this.bufferSizeInSamples=this.bufferSizeInFrames*this.targetNumberOfChannels,this.outputBuffer=new Float32Array(this.bufferSizeInSamples),this.bufferStartFrame=0,this.maxWrittenFrame=-1,this.setupChannelMixer(),this.tempSourceBuffer=new Float32Array(this.sourceSampleRate*this.sourceNumberOfChannels)}setupChannelMixer(){let t=this.sourceNumberOfChannels,e=this.targetNumberOfChannels;t===1&&e===2?this.channelMixer=(r,i)=>r[i*t]:t===1&&e===4?this.channelMixer=(r,i,a)=>r[i*t]*+(a<2):t===1&&e===6?this.channelMixer=(r,i,a)=>r[i*t]*+(a===2):t===2&&e===1?this.channelMixer=(r,i)=>{let a=i*t;return .5*(r[a]+r[a+1])}:t===2&&e===4?this.channelMixer=(r,i,a)=>r[i*t+a]*+(a<2):t===2&&e===6?this.channelMixer=(r,i,a)=>r[i*t+a]*+(a<2):t===4&&e===1?this.channelMixer=(r,i)=>{let a=i*t;return .25*(r[a]+r[a+1]+r[a+2]+r[a+3])}:t===4&&e===2?this.channelMixer=(r,i,a)=>{let o=i*t;return .5*(r[o+a]+r[o+a+2])}:t===4&&e===6?this.channelMixer=(r,i,a)=>{let o=i*t;return a<2?r[o+a]:a===2||a===3?0:r[o+a-2]}:t===6&&e===1?this.channelMixer=(r,i)=>{let a=i*t;return Math.SQRT1_2*(r[a]+r[a+1])+r[a+2]+.5*(r[a+4]+r[a+5])}:t===6&&e===2?this.channelMixer=(r,i,a)=>{let o=i*t;return r[o+a]+Math.SQRT1_2*(r[o+2]+r[o+a+4])}:t===6&&e===4?this.channelMixer=(r,i,a)=>{let o=i*t;return a<2?r[o+a]+Math.SQRT1_2*r[o+2]:r[o+a+2]}:this.channelMixer=(r,i,a)=>a<t?r[i*t+a]:0}ensureTempBufferSize(t){let e=this.tempSourceBuffer.length;for(;e<t;)e*=2;if(e!==this.tempSourceBuffer.length){let r=new Float32Array(e);r.set(this.tempSourceBuffer),this.tempSourceBuffer=r}}async add(t){if(!t||t._closed)return;let e=t.numberOfFrames*t.numberOfChannels;this.ensureTempBufferSize(e);let r=t.allocationSize({planeIndex:0,format:"f32"}),i=new Float32Array(this.tempSourceBuffer.buffer,0,r/4);t.copyTo(i,{planeIndex:0,format:"f32"});let a=t.timestamp-this.startTime,o=t.numberOfFrames/this.sourceSampleRate,s=Math.min(a+o,this.endTime-this.startTime),c=Math.floor(a*this.targetSampleRate),u=Math.ceil(s*this.targetSampleRate);for(let d=c;d<u;d++){if(d<this.bufferStartFrame)continue;for(;d>=this.bufferStartFrame+this.bufferSizeInFrames;)await this.finalizeCurrentBuffer(),this.bufferStartFrame+=this.bufferSizeInFrames;let l=d-this.bufferStartFrame;m(l<this.bufferSizeInFrames);let h=(d/this.targetSampleRate-a)*this.sourceSampleRate,b=Math.floor(h),g=Math.ceil(h),T=h-b;for(let k=0;k<this.targetNumberOfChannels;k++){let y=0,S=0;b>=0&&b<t.numberOfFrames&&(y=this.channelMixer(i,b,k)),g>=0&&g<t.numberOfFrames&&(S=this.channelMixer(i,g,k));let w=y+T*(S-y),x=l*this.targetNumberOfChannels+k;this.outputBuffer[x]+=w}this.maxWrittenFrame=Math.max(this.maxWrittenFrame,l)}}async finalizeCurrentBuffer(){if(this.maxWrittenFrame<0)return;let t=(this.maxWrittenFrame+1)*this.targetNumberOfChannels,e=new Float32Array(t);e.set(this.outputBuffer.subarray(0,t));let r=this.bufferStartFrame/this.targetSampleRate,i=new he({format:"f32",sampleRate:this.targetSampleRate,numberOfChannels:this.targetNumberOfChannels,timestamp:r,data:e});await this.onSample(i),this.outputBuffer.fill(0),this.maxWrittenFrame=-1}finalize(){return this.finalizeCurrentBuffer()}};export{Qs as ADTS,jc as ALL_FORMATS,Fs as ALL_TRACK_TYPES,ne as AUDIO_CODECS,ni as AdtsInputFormat,Ni as AdtsOutputFormat,Di as AudioBufferSink,Qi as AudioBufferSource,he as AudioSample,ht as AudioSampleSink,Lt as AudioSampleSource,je as AudioSource,mr as BaseMediaSampleSink,Zi as BlobSource,Yi as BufferSource,rr as BufferTarget,fr as CanvasSink,Ki as CanvasSource,pa as Conversion,En as CustomAudioDecoder,In as CustomAudioEncoder,vn as CustomVideoDecoder,_n as CustomVideoEncoder,wr as EncodedAudioPacketSource,V as EncodedPacket,Be as EncodedPacketSink,br as EncodedVideoPacketSource,ea as FilePathSource,vr as Input,re as InputAudioTrack,Ee as InputFormat,gt as InputTrack,Ce as InputVideoTrack,Cr as IsobmffInputFormat,pr as IsobmffOutputFormat,Ls as MATROSKA,qs as MP3,Ws as MP4,Pr as MatroskaInputFormat,Wt as MediaSource,$i as MediaStreamAudioTrackSource,ji as MediaStreamVideoTrackSource,hr as MkvOutputFormat,vt as MovOutputFormat,ei as Mp3InputFormat,Vi as Mp3OutputFormat,Yn as Mp4InputFormat,Ut as Mp4OutputFormat,Ne as NON_PCM_AUDIO_CODECS,nr as NullTarget,js as OGG,ri as OggInputFormat,Wi as OggOutputFormat,qt as Output,Pe as OutputFormat,K as PCM_AUDIO_CODECS,Ns as QTFF,Vn as QUALITY_HIGH,Ic as QUALITY_LOW,Ac as QUALITY_MEDIUM,Fc as QUALITY_VERY_HIGH,_c as QUALITY_VERY_LOW,se as Quality,Zn as QuickTimeInputFormat,ta as ReadableStreamSource,ge as SUBTITLE_CODECS,ve as Source,Ln as StreamSource,Si as StreamTarget,Ht as SubtitleSource,Ze as Target,Gi as TextSubtitleSource,Ji as UrlSource,ee as VIDEO_CODECS,pe as VideoSample,pt as VideoSampleSink,Nt as VideoSampleSource,Ke as VideoSource,Ks as WAVE,Hs as WEBM,Ui as WavOutputFormat,ti as WaveInputFormat,Jn as WebMInputFormat,Ft as WebMOutputFormat,Mc as canEncode,Wn as canEncodeAudio,Nn as canEncodeSubtitles,Un as canEncodeVideo,gr as getEncodableAudioCodecs,Oc as getEncodableCodecs,As as getEncodableSubtitleCodecs,Is as getEncodableVideoCodecs,Rc as getFirstEncodableAudioCodec,Bc as getFirstEncodableSubtitleCodec,Li as getFirstEncodableVideoCodec,Cc as registerDecoder,Pc as registerEncoder};
