<link rel="stylesheet" type="text/css" media="screen" href="style.css?v1" />
<h1>Flow: getting started (on Mac OS X)</h1>

<p>For more details on all of the ways Flow code can be compiled and run,
including options not mentioned below, see <code>flow/doc/runtimes.html</code>.</p>

<p>If these instructions prove incorrect or incomplete, please fix it
and commit your changes to the repository.</p>

<h2>The basics</h2>

<p>The basic prerequisites for compiling and running Flow programs are
Haxe and Neko.</p>

<p>You need Haxe because the Flow compiler and some of the Flow standard
library is written in the Haxe language, so you need Haxe installed
to build the Flow platform itself.</p>

<p>You need Neko because the usual way of running the Flow compiler is to
compile it to Neko bytecode and run it with the C++ bytecode runner.
(Also some of Haxe may depend on Neko, e.g. the <code>haxelib</code> command.)</p>

<p>The simplest thing is to install Haxe and Neko in your home directory,
rather than systemwide.</p>

<p>Those prerequisites are sufficient to compile Flow code to SWF
and JavaScript; you can then run your compiled code in a web browser.</p>

<h2>Install Xcode</h2>

<p>Install Xcode through the App Store.</p>

<h2>Install command-line tools</h2>

<p>To install the command line developer tools, issue this command in
Terminal:</p>

<pre><code>xcode-select --install
</code></pre>

<p>and click on the "Install" button. (The "Get XCode" button is not
applicable since from the previous step, XCode is already
installed.) Proceed with further installation of command line tools.</p>

<h3>Troubleshooting</h3>

<p>If after agreeing to the license terms, you happen to encounter the
message "Can't install the software because it is not currently
available from the Software Update server", here is an alternate route
to install the developer tools:</p>

<ol>
<li>Make sure you have an Apple ID to download from the app store. (If you're an iPhone user, you probably already have one.)</li>
<li>Have your Mac OS version and Xcode version handy. In order to get Xcode version, run <code>xcodebuild -version</code></li>
<li>Navigate to <a href="https://developer.apple.com/downloads/index.action?name=for%20Xcode%20-">this URL</a></li>
<li>Based on your Mac OS and Xcode versions, select command line tools. Download and install.</li>
</ol>

<h2>Install Homebrew</h2>

<p>Follow the installation instructions at the <a href="http://brew.sh">Homebrew site</a>.</p>

<p>(It's possible that a different package manager such as
<a href="http://www.macports.org/">MacPorts</a> or
<a href="http://www.finkproject.org">Fink</a> would be an acceptable substitute
for Homebrew. So for example, if you want to try MacPorts, substitute
<code>port</code> for <code>brew</code> in the remaining instructions)</p>

<h2>Add bash completion to terminal</h2>

<p>By default, Mac OS terminal is lacking bash completion (start a command line and use tab to complete it or to list possible arguments). Here are the steps to add bash completion to the Mac terminal. This allows for quick command line completion:</p>

<p>First, install the appropriate brew package:</p>

<pre><code>brew install bash-completion
</code></pre>

<p>homebrew tells you exactly what you have to do. Just add this to .bash_profile:</p>

<pre><code>[ -f /usr/local/etc/bash_completion ] &amp;&amp; . /usr/local/etc/bash_completion
</code></pre>

<p>Finally, add the following lines to ~/.inputrc (create the file if necessary). The first setting will allow for completion even if you got the casing wrong. Should there be ambiguities, the second setting will show all possible options right away, instead of typing tab twice:</p>

<pre><code>set completion-ignore-case on
set show-all-if-ambiguous on
</code></pre>

<p>You will need to restart your terminal to benefit from those changes and enable bash completion.</p>

<h2>Install <code>greadlink</code></h2>

<p>This command will install the GNU version of <code>readlink</code>, and a bunch
of other GNU utilities.</p>

<pre><code>brew install coreutils
</code></pre>

<p>The GNU versions names' have a <code>g</code> prepended, e.g. <code>greadlink</code>, so
having them around won't conflict with your Mac's built-in versions.</p>

<p><code>greadlink</code> is needed because the scripts for running Flow assume the
GNU semantics, so they won't work with the standard Mac <code>readlink</code>.
(Note that fixing that wouldn't actually be very hard.)</p>

<h2>Install Haxe 3</h2>

<p>Our build servers use haxe 3.2.1 and neko 2.0.0. Haxe 3.4.* should work, but you'll have to manually roll back neko version to 2.0.0. The simplest way is to get haxe 3.2.1.</p>

<p>An OS X installer is available here:</p>

<pre><code>http://haxe.org/download/
</code></pre>

<p>After running the installer, add this to your shell init file (e.g. <code>~/.bash_profile</code> or <code>~/.zshrc</code>):</p>

<pre><code>export HAXE_STD_PATH=/usr/local/lib/haxe/std
</code></pre>

<p>and start a new shell. It is not necessary at least for newest Haxe 3.4.4.</p>

<p>Set up your Haxe library directory:</p>

<pre><code>cd ~
mkdir -p haxelib/lib
haxelib setup
</code></pre>

<p>You will be prompted to enter the desired haxelib path. Please sepcify the haxelib location you just created, e.g. <code>/Users/mathieu_perceau/haxelib/lib</code>.</p>

<p>Then install the required libraries:</p>

<pre><code>haxelib install format
haxelib install pixijs 4.5.4
(or a newer 4.5.x edition)
</code></pre>

<h2>Install Neko 2.0.0</h2>

<p>If the haxe installer above did not install Neko or installed a wrong version, you can do it manually like this:</p>

<pre><code>brew install neko
</code></pre>

<p>And add this to your shell init file (e.g. <code>~/.bash_profile</code> or <code>~/.zshrc</code>):</p>

<pre><code>export NEKOPATH=/usr/local/lib/neko
export PATH=$NEKOPATH:$PATH
</code></pre>

<p><strong>NOTE:</strong> if you have error “Uncaught exception - load.c(237) : Failed to load library : std.ndll (dlopen(std.ndll, 1): image not found)”
check your real neko path and put it in NEKOPATH, it can be /usr/local/lib/neko or another</p>

<p>As always when editing shell init files, you'll need to start a new shell
to pick up the changes.</p>

<h3>Troubleshooting</h3>

<p>No issues to report at the moment.</p>

<h2>Check out Flow repository</h2>

<p>Do the checkout:</p>

<pre><code>cd ~
git clone https://github.com/area9innovation/flow
</code></pre>

<p>And add this to your shell init file (e.g. <code>~/.bash_profile</code> or <code>~/.zshrc</code>):</p>

<pre><code>export FLOW=$HOME/flow
export PATH=$FLOW/bin:$PATH
</code></pre>

<p>and start a new shell.</p>

<h2>Compile Flow itself</h2>

<pre><code>cd ~/flow9/src
haxe Build.hxml
cd ..
neko src/build.n
</code></pre>

<p>If compilation succeeds, some tests will also run, and the output will
conclude with a line like:</p>

<pre><code>Flowunit tests: 963 checks passed.
</code></pre>

<p>The following files will be created or overwritten:</p>

<pre><code>bin/flow.n
bin/flowrunner.n
src/build.n
www/FlowRunner.swf
www/FlowFlash.swf
www/js/flow.js
www/js/flow.js.map
www/js/flowrunner.js
*.bytecode
</code></pre>

<h2>Try it (C++ runner)</h2>

<p>You'll probably need to do this first:</p>

<pre><code>brew install qt5
</code></pre>

<p>Because of a runtime dependency on libjpeg and libpng, you should also run</p>

<pre><code>brew install libjpeg
brew install libpng
</code></pre>

<p>There are also runtime dependencies on the XQuartz libraries libpng and libGLU.  To ensure you have a recent enough version of libpng, you should download the latest XQuartz (http://xquartz.macosforge.org/landing/).  By default it will install to /opt/X11, where it needs to be to be found at runtime, rather than to /usr/X11 where you may find an XQuartz preinstalled.</p>

<p>The repository contains a prebuilt Mac OS X binary for <code>flowcpp</code>.</p>

<p>You can also run command-line-only stuff with it, and avoid
initializing the GUI subsystem, using <code>--batch</code>:</p>

<pre><code>cd ~/flow
flowcpp --batch sandbox/helloworld.flow
</code></pre>

<p>You should see:</p>

<pre><code>"neko flow.n  --compile helloworld.bytecode --debuginfo helloworld.debug sandbox/helloworld.flow
Compiling sandbox/helloworld.flow ...
"
Hello world
</code></pre>

<p>After that, the runner will hang, because the program doesn't end with
a call to <code>quit(0)</code>, and the different runners aren't consistent with
each other about what happens when <code>main()</code> ends without an explicit
quit call.  You can ctrl-C out of it.</p>

<p>If you get a message that a library version on your system is not new
enough, <code>brew update &amp;&amp; brew upgrade</code> might fix it.</p>

<p>Unless you're hacking on the C++ source code for the bytecode
runner, you shouldn't need to rebuild it. You can just use
the binary that's already in the repository.</p>

<p>But if you need to build a new binary, see <code>QtByteRunner/readme.txt</code>.</p>

<p>More info on compiling flow in js or running it on apache can be found in linux doc.</p>

<h2>fdb, the Flow debugger</h2>

<p>The C++ runner can also be used in debug mode, which activates a
debugger with a GDB-like command line.</p>

<p>Wrapping the debugger in GNU Readline gives an improved experience
with line editing and command history.  If you haven't already, do:</p>

<pre><code>brew install rlwrap
</code></pre>

<p>Then an example invocation to run the debugger is:</p>

<pre><code>rlwrap flowcpp --batch --debug sandbox/helloworld.flow
</code></pre>

<p>At the <code>(fdb)</code> prompt, you can enter commands such as <code>step</code>,
<code>next</code>, and <code>continue</code>.  The <code>help</code> command will show a list of
all supported commands.</p>

<p>The debugger can also be used within an editor.  Because it mimics
GDB, it works with editors with gdb integration, for example Sublime
Text's SublimeGDB package.  See <code>resources/sublimetext2/readme.txt</code>
for more details.</p>

<h2>Try it (JavaScript in browser)</h2>

<p>To compile Flow code to JavaScript, try e.g.</p>

<pre><code>flow --js helloworld.js sandbox/helloworld.flow
</code></pre>

<p>You should see:</p>

<pre><code>neko flow.n  --js helloworld.js sandbox/helloworld.flow
Compiling sandbox/helloworld.flow ...
</code></pre>

<p>and <code>helloworld.js</code> should be created.</p>

<p>You might think to try the resulting JavaScript code with a command
line tool like Node or SpiderMonkey, but that will break. So you'll
need to run it a browser.</p>

<p>A quick way to try that is:</p>

<pre><code>mv helloworld.js www
(cd www; python -m SimpleHTTPServer) &amp;
open http://localhost:8000/flowjs.html?name=helloworld
</code></pre>

<p>Your browser should open and display a "Loading" screen indefinitely.
But you'll know the code ran if you look in the error console of your
browser and see:</p>

<pre><code>Errors.hx:40 : "Hello world"
</code></pre>

<p>You can leave the web server running for now, or kill it with:</p>

<pre><code> kill %
</code></pre>

<p>Notice that while this works for quick checks, you should work to 
setup a local web browser to serve the flow/www folder as "flow",
so the link</p>

<pre><code>http://localhost/flow/flowjs.html?name=helloworld
</code></pre>

<p>works right.</p>

<h2>Apache + PHP + MySQL</h2>

<p>Apache should be already available: sudo httpd</p>

<p>It has PHP module, but for some flow apps PHP needs mcrypt extention.
Install PHP 7.1 Homebrew package:</p>

<pre><code>brew install php@7.1
</code></pre>

<p>With Pecl from that package you need to install mcrypt:</p>

<pre><code>/usr/local/Cellar/php@7.1/7.1.18/bin/pecl install mcrypt-1.0.0
</code></pre>

<p>Add the following to /etc/php.ini (path of .so may be not the same):</p>

<pre><code>extension="/usr/local/Cellar/php@7.1/7.1.18/pecl/20160303/mcrypt.so"
</code></pre>

<p>If /etc/php.ini does not exist create that from /private/etc/php.ini</p>

<p>More details on mysql setup can be found in <code>flow/doc/linux.markdown</code> and <code>flow/doc/mysql.markdown</code></p>

<h2>Tools</h2>

<p>The auxiliary tools for Flow include a linter, a code formatter,
and a refactoring tool.</p>

<p>They can be run directly using <code>flow/bin/lint.sh</code>.</p>

<p>These tools are also used by the Sublime Text and Emacs integrations.
(The editors also use <code>flow/bin/autocomplete.sh</code> for autocompletion.)</p>

<h3>Building the tools (optional)</h3>

<p>You'll probably want to just use the binary that's already in the
repository.</p>

<p>But if you want or need to rebuild it, read on.</p>

<p>The tools are written in OCaml, so you may first need:</p>

<pre><code>brew install ocaml
</code></pre>

<p>Then to do the build:</p>

<pre><code>cd ~/flow9/flowtools/src
make deploy
</code></pre>

<p>The new binaries will be in the <code>flowtools/bin/mac</code> directory.
Consider committing them to version control.</p>

<h2>Profiling</h2>

<p>The instructions in <a href="development.html">development.html</a> for
using the Flow profiler should work fine on Mac as long as
you have Java 8 installed.</p>
