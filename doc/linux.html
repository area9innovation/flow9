<link rel="stylesheet" type="text/css" media="screen" href="style.css?v1" />
<h1>Flow: getting started (on Linux)</h1>

<p>Much of the information in this getting-started is created for Ubuntu 18.04,
so some of the operations may be different for your Operating System of
choice.</p>

<h1>Installation steps</h1>

<ol>
<li><a href="#environment-configuration">Environment configuration</a></li>
<li><a href="#backend">Backend</a>
<ul>
<li><a href="#mysql">MySQL</a></li>
<li><a href="#php5.6">PHP5.6</a></li>
<li><a href="#apache2">Apache2</a></li>
</ul></li>
<li><a href="#clone-the-repositories">Clone the repositories</a></li>
<li><a href="#install-haxe">Install <code>Haxe</code></a></li>
<li><a href="#install-neko">Install <code>Neko</code></a></li>
<li><a href="#compile-flow-itself">Compile Flow itself</a></li>
<li><a href="#c-runner-flowcpp">Check it using flowcpp (C++ runner)</a></li>
<li><a href="#fdb-the-flow-debugger">Install fdb, the Flow debugger</a></li>
<li><a href="#try-it-javascript-in-browser">Check it using flowjs (Javascript in browser)</a></li>
<li><a href="#try-it-executed-via-apache-in-browser">Try it (Executed via apache, in browser)</a></li>
<li><a href="#tools">Tools</a></li>
<li><a href="#profiling">Profiling</a>
<h2>Sample install script</h2></li>
</ol>

<p>The <code>.travis.yml</code> file at the root level of the Flow repository isused
on Travis-CI integration to install and configure Flow’s dependencies,
build the Flow compiler, and run the flowunit tests suite, all on Ubuntu
Linux. The commands in this file may be a useful guide for making the
same happen on your own Linux system.</p>

<h1>Environment configuration</h1>

<p>All environment variables should be defined in <code>~/.profile</code>. This is
necessary since applications that are started from an application menu
(i.e., not started from the command line; e.g., emacs) will not see
environment variables defined in other files, such as <code>~/.bashrc</code>. In
some terminals, though, <code>~/.profile</code> is not considered during startup,
so as a compromise you can store variables in some file, which is
<code>source</code>'d in both <code>~/.profile</code> and <code>~/.bashrc</code>
<code>bash
touch ~/.env
echo "source ~/.env" | tee -a ~/.bashrc ~/.profile
</code>
Also it can be useful to define environment variables in .xsessionrc. This way they will be 
<a href="https://askubuntu.com/questions/82120/how-do-i-set-an-environment-variable-in-a-unity-session">enabled for any X session</a></p>

<h1>Backend</h1>

<h2>MySQL</h2>

<p>Set up MySQL and MySQL Workbench:
<code>bash
sudo apt install -y mysql-server mysql-client
</code>
Make root@localhost user with empty password:
<code>bash
sudo mysql --user="root" --execute="ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY ''; FLUSH PRIVILEGES;"
</code>
Configure MySQL-server mode:
<code>bash
printf '[mysqld]
sql-mode=STRICT_ALL_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER\n' | sudo tee -a /etc/mysql/my.cnf
</code>
More details on mysql setup can be found in <code>flow9/doc/mysql.markdown</code></p>

<h2>PHP5.6</h2>

<p>Set up PHP:
<code>bash
sudo add-apt-repository ppa:ondrej/php
sudo apt update
sudo apt install -y php5.6 php5.6-mysql php-gettext php5.6-mbstring php-xdebug libapache2-mod-php5.6 php5.6-xml php5.6-zip php5.6-mcrypt
sudo update-alternatives --config php
</code></p>

<h2>Apache2</h2>

<p>Install and configure apache2:
<code>bash
sudo apt install apache2
printf 'Alias "/todoapp" "/home/'$USER'/area9/todoapp/www2/"
&lt;Directory /home/'$USER'/area9/todoapp/www2/&gt;
     Options Indexes
     AllowOverride All
     Require local
&lt;/Directory&gt;\n' | sudo tee /etc/apache2/conf-available/area9.conf
sudo a2enconf area9
sudo service apache2 restart
</code>
Note that todoapp is name for application in exercise 9, you can rename it as you wish.</p>

<h1>Clone the repositories</h1>

<p>If you haven't installed git yet, enter next commands:
<code>bash
sudo apt install -y git
git config --global user.email "&lt;email for github account&gt;"
git config --global user.name "&lt;your full name&gt;"
git config --global alias.hist "log --pretty=format:'%h %ad | %s%d [%an]' --graph --date=format:'%Y-%m-%d %H:%M:%S'"
git config --global push.default simple
git config --global pull.rebase true
</code>
In order not to enter authentication data each time, follow the instructions described in <a href="https://help.github.com/articles/connecting-to-github-with-ssh/">Connecting to GitHub with SSH</a>.</p>

<p>Make area9 dir:
<code>bash
mkdir -p ~/area9 &amp;&amp; cd ~/area9
</code>
Clone flow9 repos:
<code>bash
git clone ssh://git@github.com/area9innovation/flow9.git
</code></p>

<p>Notice, that flow9 repo requires installed <a href="https://git-lfs.github.com">Git LFS</a>.
You have to reclone the flow9 repository after installing Git LFS, or use 
<code>bash
git lfs pull
</code></p>

<h1>Install <code>Haxe</code></h1>

<p>Our build servers use haxe 3.2.1 and neko 2.0.0. Haxe 3.4.* should work.</p>

<p>A Linux installer is available here: <a href="https://haxe.org/download/">Haxe download
site</a></p>

<p><strong>Note</strong> If you choose to use Linux package installer for Ubuntu, you
may encounter following problem:
<code>add-apt-repository: command not found</code>.\
In such case, run following command:
<code>sudo apt-get update &amp;&amp; sudo apt-get install software-properties-common</code></p>

<p>After running the installer, run this:
<code>bash
printf 'export HAXE_STD_PATH=/usr/share/haxe/std
export FLOW=$HOME/area9/flow9
export PATH=$FLOW/bin:$PATH\n' &gt;&gt; ~/.env
</code>
and run <code>source ~/.env</code>.</p>

<p>If you have followed the installation instructions for Linux Package
installer, you have already set up Haxe library directory, so you don’t
have to do the next step.</p>

<p>Set up your Haxe library directory:
<code>bash
cd ~
mkdir -p ~/haxelib/lib
haxelib setup ~/haxelib/lib
</code>
Then install the required libraries:
<code>bash
haxelib install format
haxelib install pixijs 4.5.4 #(or a newer 4.5.x edition)
</code></p>

<h1>Install <code>Neko</code></h1>

<p>Our build servers use haxe 3.2.1 and neko 2.0.0. Newer versions might
work as well, but it is not guaranteed.</p>

<p><strong>If the haxe installer above did not install Neko</strong> or installed a wrong
version, you can do it manually either by downloading it from the
official site</p>

<pre><code>The [Neko download site](http://nekovm.org/download) offers both
32-bit and 64-bit binaries.  Make sure your haxe and neko match. Most
use the 32-bit version.
</code></pre>

<p>or via package manager like this:
<code>bash
sudo apt-get install neko
</code>
<strong>Run this:</strong>
<code>bash
printf 'export NEKOPATH=/usr/lib/x86_64-linux-gnu/neko
export PATH=$NEKOPATH:$PATH\n' &gt;&gt; ~/.env
</code>
and run <code>source ~/.env</code>.</p>

<p><strong>NOTE:</strong> if you have error “Uncaught exception - load.c(237) : Failed
to load library : std.ndll (dlopen(std.ndll, 1): image not found)” check
your real neko path and put it in NEKOPATH, it can be
/usr/local/lib/neko or another path.</p>

<p>Alexander Gavrilov offers:</p>

<blockquote>
  <p>there are two possible problems I remember with neko:</p>
  
  <ol>
  <li>neko executables work by including a small executable with the
  bytecode, and its 32-bitness must agree with
  <a href="http://libneko.so">libneko.so</a></li>
  <li>some distributions include weird ‘optimization’ things that strip
  all executables they see that they aren’t told to ignore, and that
  kills the bytecode specifically, point 2 is true for Fedora, and
  the weird thing is called prelink. the nekovm rpm included with
  the system installs a config into /etc/prelink.conf.d to stop that</li>
  </ol>
</blockquote>

<h2>LD_LIBRARY_PATH (Ubuntu)</h2>

<p>The <code>LD_LIBRARY_PATH</code> environment variable must include the path to
Neko. This is not done by explicitly setting this variable but by adding
an application-specific file to the <code>/etc/ld.so.conf.d</code> directory like
so:</p>

<p>Create the file <code>/etc/ld.so.conf.d/flow.conf</code> and add to it the path
    to Neko (/usr/bin/neko in Ubuntu). You can do this with:
<code>bash
echo '/usr/bin/neko' | sudo tee -a /etc/ld.so.conf.d/flow.conf
</code>
Run
<code>bash
sudo ldconfig
</code>
If you get the following messages
<code>
 /sbin/ldconfig.real: /usr/lib/nvidia-375/libEGL.so.1 is not a symbolic link
 /sbin/ldconfig.real: /usr/lib32/nvidia-375/libEGL.so.1 is not a symbolic link
</code>
then the following solution works
<code>bash
sudo mv /usr/lib/nvidia-375/libEGL.so.1 /usr/lib/nvidia-375/libEGL.so.1.org
sudo mv /usr/lib32/nvidia-375/libEGL.so.1 /usr/lib32/nvidia-375/libEGL.so.1.org
sudo ln -s /usr/lib/nvidia-375/libEGL.so.1 /usr/lib/nvidia-375/libEGL.so.375.39
sudo ln -s /usr/lib32/nvidia-375/libEGL.so.1 /usr/lib32/nvidia-375/libEGL.so.375.39
</code>
Note that <code>LD_LIBRARY_PATH</code> will not actually contain the path to Neko,
but the system can now find libraries on that path nonetheless.</p>

<h1>Compile Flow itself</h1>

<p>Neko version of flow from the repo should be fine but if you wish to compile your own, do:
<code>bash
cd ~/flow9/src
haxe FlowNeko.hxml
</code>
This should take a few seconds. If it takes more than a minute, very likely something is going wrong.
The following file will be created or overwritten:
<code>
flow9/bin/flow.n
</code></p>

<h1>C++ runner (flowcpp)</h1>

<p>Under linux it’s easier to compile yourself a binary instead of using
the precompiled one. To do so, you should have Qt 5.12.0 set up by default
Install required libraries:
<code>bash
sudo apt-get install zlib1g-dev libjpeg-dev libpng-dev -y
wget -q -O /tmp/libpng12.deb http://mirrors.kernel.org/ubuntu/pool/main/libp/libpng/libpng12-0_1.2.54-1ubuntu1_amd64.deb \
  &amp;&amp; sudo dpkg -i /tmp/libpng12.deb \
  &amp;&amp; rm /tmp/libpng12.deb
</code>
Download and setup QT 5.12.0 (or later):
<code>bash
wget https://download.qt.io/archive/qt/5.12/5.12.0/qt-opensource-linux-x64-5.12.0.run
chmod +x qt-opensource-linux-x64-5.12.0.run
</code>
<strong>Install into <code>&lt;path to your home directory&gt;/Qt/5.12.0</code> and be sure to select all items to install!</strong>
<code>bash
./qt-opensource-linux-x64-5.12.0.run
rm qt-opensource-linux-x64-5.12.0.run
</code></p>

<p><code>bash
sudo apt install libpulse-dev libglu1-mesa-dev qtchooser -y
qtchooser -install qt512 ~/Qt/5.12.0/5.12.0/gcc_64/bin/qmake
echo "export QT_SELECT=qt512" &gt;&gt; ~/.env &amp;&amp; source ~/.env
</code>
Clone asmjit repo:
<code>bash
cd $FLOW/QtByteRunner
git clone ssh://git@github.com/angavrilov/asmjit.git
cd asmjit
git checkout next
</code>
Build QtByteRunner:
<code>bash
cd $FLOW/QtByteRunner
./build.sh # it can return with error 127, but that's expected
</code>
New QtByteRunner binary will appear in $FLOW/QtByteRunner/bin/linux folder</p>

<p>Now you can run hello.flow using flowcpp:
<code>
cd ~/area9/flow9/
flowcpp sandbox/hello.flow
</code>
You should see:
```
Flow compiler (3rd generation)</p>

<p>Processing 'sandbox/hello' on server.
0.63s</p>

<p>Hello console
```</p>

<p>After that, the runner will hang, because the program doesn’t end with a
call to <code>quit(0)</code>, and the different runners aren’t consistent with each
other about what happens when <code>main()</code> ends without an explicit quit
call. You can ctrl-C out of it.</p>

<h1>fdb, the Flow debugger</h1>

<p>The C++ runner can also be used in debug mode, which activates a
debugger with a GDB-like command line.</p>

<p>Wrapping the debugger in GNU Readline gives an improved experience with
line editing and command history. If you haven’t already, do:
<code>bash
sudo apt-get install rlwrap
</code>
Then an example invocation to run the debugger is:
<code>bash
rlwrap flowcpp --debug sandbox/hello.flow
</code>
At the <code>(fdb)</code> prompt, you can enter commands such as <code>step</code>, <code>next</code>,
and <code>continue</code>. The <code>help</code> command will show a list of all supported
commands.</p>

<p>The debugger can also be used within an editor. Because it mimics GDB,
it works with editors with gdb integration, for example Sublime Text
package. See <a href="../resources/sublimetext/readme.md">resources/sublimetext/readme.md</a>
for more details.</p>

<h1>Try it (JavaScript in browser)</h1>

<p>To compile Flow code to JavaScript, try e.g.
<code>bash
flowc1 sandbox/hello.flow js=www/hello.js
</code>
You should see:
```bash
Flow compiler (3rd generation)</p>

<p>Processing 'sandbox/hello' on server.
<code>``
and</code>flow9/www/hello.js` should be created.</p>

<p>You might think to try the resulting JavaScript code with a command line
tool like Node or SpiderMonkey, but that will break. So you’ll need to
run it a browser.</p>

<p>A quick way to try that is:
<code>bash
xdg-open http://localhost/flow/flowjs.html?name=hello
</code>
Your browser should open and display a “Hello window” screen indefinitely and you look in the error console of your
browser and see:
<code>
"Hello console"
</code></p>

<h1>Try it (Executed via apache, in browser)</h1>

<p>Information on this topic can be found in QtByteRunner/readme.md
in section "Enabling fast-cgi in apache"</p>

<h1>Tools</h1>

<p>The auxiliary tools for Flow include a linter, a code formatter, and a
refactoring tool.</p>

<p>They can be run directly using <code>flow9/bin/lint.sh</code>.</p>

<p>These tools are also used by the Sublime Text and Emacs integrations.
(The editors also use <code>flow9/bin/autocomplete.sh</code> for autocompletion.)</p>

<h1>Profiling</h1>

<p>The instructions in <a href="development.html">development.html</a> for using the
Flow profiler should work fine on Mac as long as you have Java 8
installed.</p>
